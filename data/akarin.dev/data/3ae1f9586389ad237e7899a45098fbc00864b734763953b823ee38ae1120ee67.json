{
  "Source": "akarin.dev",
  "Title": "西方 Project 幡紫龙 C74 版汉化（魔改）记录",
  "Link": "https://akarin.dev/2024/01/19/banshiryuu-modification/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cp\u003e西方 Project 是一个弹幕射击类游戏系列，前两作由东京电机大学的学生社团 Amusement Makers 制作，第三作由前 AM 成员组成的“被瞬杀之道？（瞬殺サレ道？）”制作。此系列的三个游戏为秋霜玉、稀翁玉、幡紫龙，是基于在概念上对应 AM 的先辈 ZUN（后来成立了个人社团上海爱丽丝幻乐团）的东方 Project 而制作的作品，而前两作也有 ZUN 的参与制作及东方 Project 的客串出场。\u003c/p\u003e\u003cp\u003e……嘛，以上的介绍是从 \u003ca href=\"https://thwiki.cc/%E8%A5%BF%E6%96%B9Project\" target=\"_blank\" rel=\"noopener\"\u003eTHBWiki\u003c/a\u003e 复制粘贴过来的。总之在最近通关了东方 Project 所有 Windows 整数作的 Normal 难度之后打算试点新东西，再加上之前也有通关秋霜玉 Normal 的经历，于是就找到了幡紫龙。（也许以后还会试试稀翁玉？）\u003c/p\u003e\u003cp\u003e不过这一作似乎没有汉化？\u003c/p\u003e\u003cp\u003e在查找角色设定和剧情的相关资料的时候，偶然看到了在国外的车万论坛 Maidens of the Kaleidoscope 上关于西方各作的英文补丁的\u003ca href=\"https://www.shrinemaiden.org/forum/index.php?topic=19231.0\" target=\"_blank\" rel=\"noopener\"\u003e讨论帖\u003c/a\u003e，其中有人提到制作英文版的最大阻碍是对游戏数据包的封包，大概也是这么久以来幡紫龙一直没有汉化版的原因之一，另一个原因也许是太冷门了。\u003c/p\u003e\u003cp\u003e解包工具早就已经有人写出来了，也就是 NamelessLegacy 的 \u003ca href=\"https://github.com/nmlgc/pbg6ext\" target=\"_blank\" rel=\"noopener\"\u003epbg6ext\u003c/a\u003e。然后 Clb184 制作了 \u003ca href=\"https://github.com/Clb184/BSRtk\" target=\"_blank\" rel=\"noopener\"\u003eBSRtk\u003c/a\u003e，可以反编译和编译游戏中的二进制脚本，不过仍然没有实现封包功能。\u003c/p\u003e\u003cp\u003e于是，从“随便试试看”这样的想法开始，我对幡紫龙的主程序动手了…_φ(･ω･` )\u003c/p\u003e\u003cp\u003e然后顺便就把汉化做出来了，想要下载的话可以去\u003ca href=\"https://file.akarin.dev/s/n3tN\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1280*960),960px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg\" data-src-webp=\"https://p.sda1.dev/15/7b94453677c912bb809f832d6ee7f569/QwcHiDgy.webp\" data-src-avif=\"https://p.sda1.dev/15/dc97281928aee94018e330e7d3383837/j_4UmP2a.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAcCBgEDBf/EACcQAAICAgEDAgcBAAAAAAAAAAECAxEABBIFMVEHYQYTFCEzQaLh/8QAFgEBAQEAAAAAAAAAAAAAAAAABAMF/8QAIBEAAQQCAgMBAAAAAAAAAAAAAQACERIDITFBExQiUf/aAAwDAQACEQMRAD8AucnWNsbejsmaWOCbYREQ0UKEUa492Jy5hj88U0osC2WSgK9sSCepabEvN+hqxqPgpkACFe5us6S+o22Y5poug80hW3I2e38ZZzAwjeyN7B5SH5BlgEAVkAAdJYwlX1itrYk5Vx+/bz4zRMDw4A1Tcrv2yELuVjCp+T9k1WQ2pGjBQxcqN2G/zLfHhDdXqs4My+xYzW36j6fWjcBZTItA9uJvGV0LQ1k+E+tz8CS0JZSR4sGhhhhol7dnlLY+Q4wAaylvFEihCWRlIug6gjMbDw3S+PY4YYoY2l3aOchX/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/8f7a383abf59d0faab4f28c610eade2d/dwmUIHBN.jpg\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e不过，由于我的日语水平大概只有 N95 级别（笑），所以这个汉化版大部分是复制粘贴了 THBWiki 上现有的翻译，\u003cstrong\u003e剩余的文本则通过 DeepL 和 ChatGPT \u003cdel\u003e和脑补\u003c/del\u003e完成翻译\u003c/strong\u003e（可能有人会在意这个），略有改动。可能会有不准确的地方……在这里留言指出的话，我会尝试修正的！\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e汉化是基于 C74 v3.001 版的主程序进行的（SHA-256：\u003ccode\u003e07f2033073f1c890dcd25324dcf81778e88e8e0039a1a1d52e4889c17b9b8091\u003c/code\u003e）。幡紫龙还有一个更早的 C67 版，不过关卡设计、游戏系统、界面等都有很大的差别，基本上可以当成两个不同的游戏了。我暂时没有汉化 C67 版的打算。\u003c/p\u003e\u003cp\u003e顺便一提，使用更新补丁时可能会由于编码问题导致无法找到游戏主程序而出错，这种情况下需要把游戏主程序的文件名改为 \u003ccode\u003e敠巼棾.exe\u003c/code\u003e（用 Shift-JIS 编码的“幡紫竜.exe”按照 GBK 解码的效果）。\u003c/p\u003e\u003c/blockquote\u003e\u003ch1 id=\"PBG6-数据包格式介绍\"\u003e\u003ca href=\"#PBG6-数据包格式介绍\" class=\"headerlink\" title=\"PBG6 数据包格式介绍\"\u003e\u003c/a\u003ePBG6 数据包格式介绍\u003c/h1\u003e\u003cp\u003e幡紫龙使用的数据包，也就是那些扩展名 \u003ccode\u003e.ac6\u003c/code\u003e 的文件，暂且根据文件头的 magic number 记作 PBG6。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/743*236),236px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png\" data-src-webp=\"https://p.sda1.dev/15/433a2b4615058b3e3763702709d90f42/SdvSuz1X.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAwIEB//EACMQAAIBAwQBBQAAAAAAAAAAAAECAAMREiEiMUEEMjNDcXP/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAYEQEBAQEBAAAAAAAAAAAAAAABAAIRMf/aAAwDAQACEQMRAD8A11GQE6NsbHQRQ/YepYwU+f8AUxR6RHsM6QLPaSNfblUueyYyVs2QK3NwBtPA75ldfdH1B8F3avTyYnYeTD2uF//Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/bf830dc60041d37c3745f5f7445141d6/WKn961TX.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e通过阅读 \u003ca href=\"https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp\" target=\"_blank\" rel=\"noopener\"\u003epbg6ext 的代码\u003c/a\u003e（当然自己从头分析也不难）可知，整个 PBG6 文件一共由三个部分组成：\u003c/p\u003e\u003cul\u003e\u003cli\u003e文件头（固定 16 bytes）\u003cul\u003e\u003cli\u003e\u003ccode\u003euint8_t[4]\u003c/code\u003e 数据包格式的 magic number \u003ccode\u003ePBG6\u003c/code\u003e\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 目录数据在数据包文件中的位置\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 目录解密后的大小\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 目录解密后的 CRC32\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e加密的各个文件数据\u003c/li\u003e\u003cli\u003e加密的目录数据\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e目录数据的开头是一个 \u003ccode\u003euint32_t\u003c/code\u003e，用于记录数据包中包含的文件数量，之后是若干段各个文件的信息，每一段由以下数据组成：\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003euint8_t[]\u003c/code\u003e Shift-JIS 编码的以 \u003ccode\u003e0x00\u003c/code\u003e 结束的文件名，以根目录的斜杠开始，例如：\u003ccode\u003e/foo.bar\u003c/code\u003e\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 文件解密前的大小\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 文件解密后的大小\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 文件数据在数据包文件中的位置\u003c/li\u003e\u003cli\u003e\u003ccode\u003euint32_t\u003c/code\u003e 文件解密后的 CRC32\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e知道了 PBG6 的格式，就可以自己写一个简单的封包工具了：\u003c/p\u003e\u003cpre class=\"language-python line-numbers\" data-language=\"python\"\u003e\u003ccode class=\"language-python\"\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e os\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e sys\n\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e zlib\n\nsrcPath \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sys\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eargv\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token builtin\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esys\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eargv\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token builtin\"\u003einput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Input ac6 path: \u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estrip\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\nac6Path \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e srcPath \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;.ac6\u0026#39;\u003c/span\u003e\n\ntocContent \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003eb\u0026#39;\u0026#39;\u003c/span\u003e\ntocCount \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eac6Path\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;wb\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e f\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003eb\u0026#39;PBG6\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003eb\u0026#39;XXXX\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# toc pos\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003eb\u0026#39;XXXX\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# toc size\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003eb\u0026#39;XXXX\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# toc crc32\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e root\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e dirs\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e files \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e os\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewalk\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esrcPath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token builtin\"\u003efile\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e files\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n            srcFile \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e os\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003epath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejoin\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eroot\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token builtin\"\u003efile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            ac6File \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e srcFile\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eremoveprefix\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esrcPath\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereplace\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;\\\\\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;/\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eprint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eac6File\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ewith\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esrcFile\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;rb\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e g\u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e\n                d \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e g\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eread\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            tocContent \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e ac6File\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eencode\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;shift_jis\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003eb\u0026#39;\\x00\u0026#39;\u003c/span\u003e\n            tocContent \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token builtin\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            tocContent \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token builtin\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            tocContent \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etell\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            tocContent \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e zlib\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecrc32\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ed\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            tocCount \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\n    tocContent \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e tocCount\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e tocContent\n    tocPos \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etell\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etocContent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eseek\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etocPos\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token builtin\"\u003elen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etocContent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    f\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewrite\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ezlib\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecrc32\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003etocContent\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eto_bytes\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;little\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e……如果不考虑加密的话。\u003c/p\u003e\u003cp\u003e之前提过，PBG6 是使用了某种加密（或者说是压缩，这里就不区分了）算法来存储目录和文件数据的，而且该算法似乎不是 Deflate 或 LZ 系列之类的任何一种标准算法。\u003c/p\u003e\u003cp\u003epbg6ext 之所以能实现解包，那是因为原作者直接\u003ca href=\"https://github.com/nmlgc/pbg6ext/blob/master/pbg6ext/pbg6ext.cpp#L128\" target=\"_blank\" rel=\"noopener\"\u003e照抄\u003c/a\u003e了从幡紫龙主程序反编译出来的解包部分的汇编代码，所以这工具的变量名也都是各种寄存器名称……\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/839*949),949px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png\" data-src-webp=\"https://p.sda1.dev/15/8e24066b20674d69c48add43108a0cbd/1iYDaRWm.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgABwDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIBAwf/xAAjEAACAgEDAwUAAAAAAAAAAAAAAQIRQQMSgRMxQgQiUqGx/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD3SWlGLWVbq0sHTpzfk1wXNKk2r9z/AEuLV0oNcFGr0zzqfQ6D+QBBkktl32k6xkKV+dPgnUlUMVukVpTl22gaAAP/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/e1d8f3bf3acb02ae55be358e3f1f53d8/n0u22tFo.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cblockquote\u003e\u003cp\u003eActually, I didn’t write it. I just copied the code from Banshiryuu’s assembly, which is made obvious by the variable names in the decrypt function. I have no clue what this is actually doing or if this is some known algorithm.\u003c/p\u003e\u003cp\u003eWriting a repacker would be the actually interesting part, but this game is bland anyway.\u003c/p\u003e\u003cp\u003e——pbg6ext 的 \u003ca href=\"https://github.com/nmlgc/pbg6ext/blob/master/Readme.txt\" target=\"_blank\" rel=\"noopener\"\u003eREADME\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e如果手上只有这堆汇编代码的话，写出对应的压缩代码当然就是十分困难的事情了。显而易见，无法实现压缩的话也就无法实现封包，把汉化过的脚本和图片资源导入游戏什么的完全没办法啊……\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e… so we still need a hardcore hacker to have the tools which will allow us to extract and repack the game data. :V\u003c/p\u003e\u003cp\u003e——Maidens of the Kaleidoscope 上的讨论帖\u003ca href=\"https://www.shrinemaiden.org/forum/index.php?topic=19231.msg1236359#msg1236359\" target=\"_blank\" rel=\"noopener\"\u003e“SEIHOU Project English Patch Question”\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003ch1 id=\"对读取数据包的分析和魔改\"\u003e\u003ca href=\"#对读取数据包的分析和魔改\" class=\"headerlink\" title=\"对读取数据包的分析和魔改\"\u003e\u003c/a\u003e对读取数据包的分析和魔改\u003c/h1\u003e\u003cp\u003e翻出 IDA 把主程序拖进去分析。根据 pbg6ext 的那段从汇编转写过来的 C++ 代码，试着搜索对应的汇编代码，在尝试了很多次之后找到了位于 \u003ccode\u003esub_42D8D0\u003c/code\u003e 的解密算法：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1255*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png\" data-src-webp=\"https://p.sda1.dev/15/974ef00780ce0e69e6d8c516edb07925/FmGj9hnJ.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAEDBAIFB//EACgQAAIBBAECBAcAAAAAAAAAAAECAAMEESEScZEUYaHRFSIjMTJRVP/EABYBAQEBAAAAAAAAAAAAAAAAAAIBAP/EABsRAAMAAgMAAAAAAAAAAAAAAAABESGRAjFx/9oADAMBAAIRAxEAPwDs9GwerSar4hwN61r0jo2VbYW6bJ/ePaWrWpRW1wzfNvW5LTBDAfbKjyi7qwBcUmnnbF8PuSMG4Pp7RNZXCqWNxoeQ9pZ49e8G/FukE92M1qVXLBipyRjORM1yzDlzXHQwhLSRE/I/0P2gznifrt2hCYp//9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/129c5a07a755ed574e44f05e41129216/iy-7k3_E.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e和 pbg6ext 的代码对比一下还是能辨认出来是同一个东西的，当然因为这是反编译的产物所以看上去糟了很多。\u003c/p\u003e\u003cp\u003e然后，可以通过动态调试下断点看调用栈，或者用 Sysinternals 的 procmon 检查使用 \u003ccode\u003eReadFile\u003c/code\u003e 读取 PBG6 的前 16 bytes（也就是文件头）的地方，从而找到 \u003ccode\u003esub_42D2C0\u003c/code\u003e 这个读取 PBG6 的函数：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1255*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png\" data-src-webp=\"https://p.sda1.dev/15/9c403551b04393ffd6c6d5e3f860a94a/pcQmvfKQ.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAUH/8QAJRAAAgICAQMDBQAAAAAAAAAAAQIAAxEhBBIUcRNBkSIxVGHR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgEA/8QAGxEBAAICAwAAAAAAAAAAAAAAAAERAjEhUZH/2gAMAwEAAhEDEQA/AOzU8B7aTb3DgYOta8ak1cK8Ehb3Od51/Jb4llK8XDH6t4jKqVsfbYGjo7i3YxjG+fSuz5GMG5vhYNxOSASbGx4WXhSo+7MfJg6KEbHspgqO5Jlpa5IYqckYzkRiMevOXT96hCVKP6z+Q/xIZyVYeux17iEJlf/Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/98c3620e7fa4bcea0e2e1b24d3c09089/ZVP-ELB1.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003ev9 != 910639696\u003c/code\u003e 这个常数就是用小端序表示的 magic number \u003ccode\u003ePBG6\u003c/code\u003e，即 \u003ccode\u003e0x36474250\u003c/code\u003e。\u003c/li\u003e\u003cli\u003e\u003ccode\u003ev7 = sub_42DC90((int)v6, v5, dwBytes), (v2 = (void *)v7) != 0\u003c/code\u003e 调用了解密算法。\u003c/li\u003e\u003cli\u003e\u003ccode\u003ev8 = sub_42DB50(v7, dwBytes, 0), v12 == v8\u003c/code\u003e 计算解密后数据的 CRC32，并检查和文件中记录的值是否一致。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e其实一开始只知道 PBG6 使用了校验和，但是不知道具体算法，点进 \u003ccode\u003esub_42DB50\u003c/code\u003e 也没能认出来，只是用解包后的文件随便试了一下才发现是 CRC32。不过就算不知道，把校验过程直接去掉也是可以的。\u003c/p\u003e\u003cp\u003e继续查看 \u003ccode\u003esub_42DC90\u003c/code\u003e，可以看到这里分配了一块内存区域用于保存解密后的数据（调用的就是 \u003ccode\u003esub_42D8D0\u003c/code\u003e，不过不知道怎么被反编译成了函数指针的样子），解密成功则返回这个区域的地址。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1255*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png\" data-src-webp=\"https://p.sda1.dev/15/057c9b1676cbb7688988d425cfd69292/c7uzRR1J.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQBAwIFB//EACQQAAEEAQIGAwAAAAAAAAAAAAEAAgMRBBIhFDGBkaHRI1TB/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/8QAGhEBAQACAwAAAAAAAAAAAAAAAAECIRGR4f/aAAwDAQACEQMRAD8A7LDhGSIycS4XdN228KY8SRuoDJf1r0n8SeJuGWE042mWMeRTiKHKk3fiZjJvfdIcLLW+UPA/FkcaWjeSOzfSeUHkVPCmsZK8kOLTZFXYVzZXl273tHRCEiRbrP2H9lDnnSfnd2QhYv/Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/843a73b55f4f3f17fc61de238bbb3a09/DG7NrtGl.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e暂时先分析到这里。那我是怎么使封包变得可行，从而实现汉化的呢？在给出答案之前，可以试着自己大胆猜想一下。\u003c/p\u003e\u003cp\u003e可以稍微提示一下……这个汉化是魔改了主程序的，而使封包变得可行的方法在前面的某个地方已经给出线索了。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e\u003cstrong\u003e“……如果不考虑加密的话。”\u003c/strong\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e原来的主程序是从数据包读取加密的数据，解密后再使用。既然我们无法自行实现封包的加密，那把这一层直接去掉不就可以了吗？\u003c/p\u003e\u003cp\u003e一边是对数据包进行重新封包，保持 PBG6 的格式不变，但是不进行加密的步骤。另一边是修改 \u003ccode\u003esub_42DC90\u003c/code\u003e 的代码，把解密操作去掉，改成直接使用数据包中的数据，也就是把这部分改成一个 \u003ccode\u003ememcpy\u003c/code\u003e。这样就没有什么加密解密的事情了。\u003c/p\u003e\u003cp\u003e\u003ccode\u003esub_42DC90\u003c/code\u003e 对应的汇编如下：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1482*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png\" data-src-webp=\"https://p.sda1.dev/15/1434dc2f2ed48b31adb5407faa28e618/_FDeJNoy.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAATACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAIDBAEFB//EACMQAAICAQMEAwEAAAAAAAAAAAECAAMhBBGREyIxQRIUYVH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAgD/xAAaEQACAgMAAAAAAAAAAAAAAAAAARIhAjFh/9oADAMBAAIRAxEAPwDsq6RDUj9R+/8AfGfUWum0al6VtIVcjJJltCpopAOQc8zFTKuusdz2bDMXdMiKA6e5bihvHJk/0tQE+TWbfhMayypriQ267yw19RQ948SXgq2Mes1aKuwx6k6kr4hCJQ3Uf+jgQNjbHI4EITGP/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/c96122327f46a851d8960ab8cd1d0826/ScqVecER.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e而我的操作就是从 \u003ccode\u003e.text:0042DCA8\u003c/code\u003e 开始（这部分以上是 \u003ccode\u003eif (!v5) return 0;\u003c/code\u003e），用汇编的串传送指令（还好当时学的汇编语言没完全还给老师……）实现这个简单的 \u003ccode\u003ememcpy\u003c/code\u003e，再处理好返回值和栈平衡，剩下的部分用 \u003ccode\u003enop\u003c/code\u003e 填充：\u003c/p\u003e\u003cpre class=\"language-nasm line-numbers\" data-language=\"nasm\"\u003e\u003ccode class=\"language-nasm\"\u003earg_0 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dword ptr \u003cspan class=\"token number\"\u003e4\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 解密前数据的地址\u003c/span\u003e\narg_4 \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dword ptr \u003cspan class=\"token number\"\u003e8\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 解密前数据的大小\u003c/span\u003e\ndwBytes \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e dword ptr \u003cspan class=\"token number\"\u003e0Ch\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 解密后数据的大小\u003c/span\u003e\n\npush \u003cspan class=\"token register variable\"\u003eebx\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eebx\u003c/span\u003e, \u003cspan class=\"token operator\"\u003e[\u003c/span\u003e\u003cspan class=\"token register variable\"\u003eesp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003edwBytes\u003cspan class=\"token operator\"\u003e]\u003c/span\u003e\npush \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e\npush \u003cspan class=\"token register variable\"\u003eedi\u003c/span\u003e\npush \u003cspan class=\"token register variable\"\u003eebx\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; dwBytes\u003c/span\u003e\npush \u003cspan class=\"token number\"\u003e0\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; uFlags\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eedi\u003c/span\u003e, \u003cspan class=\"token register variable\"\u003eecx\u003c/span\u003e\ncall \u003cspan class=\"token register variable\"\u003eds\u003c/span\u003e:\u003cspan class=\"token keyword\"\u003eGlobalAlloc\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e, \u003cspan class=\"token register variable\"\u003eeax\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 此时esi存储的就是v5\u003c/span\u003e\ntest \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e, \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e\njz   short loc_42DCC6 \u003cspan class=\"token comment\"\u003e; if (!v5) return 0;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e; 从这里开始覆盖\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e; 从esi向edi复制ecx字节，通过rep movsb调用\u003c/span\u003e\npush \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; 56\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eedi\u003c/span\u003e, \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e              \u003cspan class=\"token comment\"\u003e; 89 F7\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e, \u003cspan class=\"token operator\"\u003e[\u003c/span\u003e\u003cspan class=\"token register variable\"\u003eesp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e010h\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003earg_0\u003cspan class=\"token operator\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 8B 74 24 14\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eecx\u003c/span\u003e, \u003cspan class=\"token operator\"\u003e[\u003c/span\u003e\u003cspan class=\"token register variable\"\u003eesp\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003e\u003cspan class=\"token number\"\u003e010h\u003c/span\u003e\u003cspan class=\"token operator\"\u003e+\u003c/span\u003earg_4\u003cspan class=\"token operator\"\u003e]\u003c/span\u003e \u003cspan class=\"token comment\"\u003e; 8B 4C 24 18\u003c/span\u003e\nrep  movsb                 \u003cspan class=\"token comment\"\u003e; F3 A4\u003c/span\u003e\npop  \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; 5E\u003c/span\u003e\nmov  \u003cspan class=\"token register variable\"\u003eeax\u003c/span\u003e, \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e              \u003cspan class=\"token comment\"\u003e; 89 F0\u003c/span\u003e\npop  \u003cspan class=\"token register variable\"\u003eedi\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; 5F\u003c/span\u003e\npop  \u003cspan class=\"token register variable\"\u003eesi\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; 5E\u003c/span\u003e\npop  \u003cspan class=\"token register variable\"\u003eebx\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; 5B\u003c/span\u003e\nretn \u003cspan class=\"token number\"\u003e0Ch\u003c/span\u003e                   \u003cspan class=\"token comment\"\u003e; C2 0C 00\u003c/span\u003e\nnop                        \u003cspan class=\"token comment\"\u003e; 90\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e如此修改之后，IDA 也能认出它是 \u003ccode\u003ememcpy\u003c/code\u003e 了：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1285*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png\" data-src-webp=\"https://p.sda1.dev/15/856f5cb1eff39b46dc67a3503794702f/3jvhOwjP.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAQDBQECB//EACcQAAEDAwEHBQAAAAAAAAAAAAEAAiEDBBESFBUiIzFxkjJBUmGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAIB/8QAGxEAAgIDAQAAAAAAAAAAAAAAAAERIQIxkXH/2gAMAwEAAhEDEQA/AOyMtHOph+0PwcxgROIhSUrWpIbcvMz6VPbu5VNhE56Y+wVYLW9qCVild9Ft33JAzcH8AQ6xrtBJuI7BMoUx70oq2aoOsgn3TLHOEGo89ihC0G+sfOp5LBfB46nkhCA//9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/a527e93d278d5cbf1a45eabf745ca9e1/CZaZrB9E.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e实际运行测试一下，主程序也能正常读取重新封过的去掉了加密的数据包。这样对于汉化来说最大的阻碍就解决了。\u003c/p\u003e\u003ch1 id=\"修改编码和字体\"\u003e\u003ca href=\"#修改编码和字体\" class=\"headerlink\" title=\"修改编码和字体\"\u003e\u003c/a\u003e修改编码和字体\u003c/h1\u003e\u003cp\u003e前面也提过，主程序使用的是 Shift-JIS 编码，汉化的话就需要改成 GBK 编码。创建字体使用的是 \u003ca href=\"https://learn.microsoft.com/zh-cn/windows/win32/api/wingdi/nf-wingdi-createfonta\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eCreateFontA\u003c/code\u003e\u003c/a\u003e，其中参数 \u003ccode\u003eDWORD iCharSet\u003c/code\u003e 就是用来设定编码的。\u003ccode\u003esub_4257B0\u003c/code\u003e 调用了这个函数：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1208*897),897px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png\" data-src-webp=\"https://p.sda1.dev/15/9773ddbb20ca142eccefe7c5fb992f35/Kx1PkFg2.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGgABAQACAwAAAAAAAAAAAAAAAAQBAgMFB//EACYQAAIBAwIGAgMAAAAAAAAAAAECAAMEEUFxEhMhNFGRFFSxwdL/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/xAAdEQACAQQDAAAAAAAAAAAAAAAAARECEiGRMWGx/9oADAMBAAIRAxEAPwD2KnaM6B/kNg56dOk3p2tdWIFycnyR+hLbbt03aVVKSCgjasVibnHiAqFznZOLC7K9wMeRj84g2N0q5NcYG38ytMDI4h7iC3t7FB1VKoVRUycbGcquzHHHrqp03iJppVza/wBhPUwatbhI5yeoiRH/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/22682b27f86ac6314ff36dc194ad81f0/p3rO35pa.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e中间的 \u003ccode\u003e0x80 (SHIFTJIS_CHARSET)\u003c/code\u003e 需要改成 \u003ccode\u003e0x86 (GB2312_CHARSET)\u003c/code\u003e。由于还没有修改游戏脚本，所以这个时候进入游戏会看到把 Shift-JIS 编码的文本当成 GBK 编码而出现的乱码。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/640*480),480px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg\" data-src-webp=\"https://p.sda1.dev/15/fa3d3827d331b42389c039f95f72dcdd/6p5Tgmx0.webp\" data-src-avif=\"https://p.sda1.dev/15/ef74850433873e0573027bee07b1c579/5fLB8hWl.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMCBAUH/8QAIxAAAgICAgIBBQAAAAAAAAAAAQIDBAARBRIhIiMTMUFRgf/EABgBAAIDAAAAAAAAAAAAAAAAAAACAQME/8QAIBEAAgIBBAMBAAAAAAAAAAAAAQIAAxEEITFhEjNyUv/aAAwDAQACEQMRAD8A51XMH167zAtF29wG2dfzRxcqV3mndYfjMhMfdjvr+BlcsygnQxnyE78DNmnrDISc8yi52UgDxxznG8DDG3TSBCD4IO9axUrusrEOTknWRkKeuMVFWM7Oz9sL0C1jH6i1MS+5HEWrAEbzb4O/xtPlKk9+sLNVGJkj8HeGGPpRmpvqFoBsU9SXM2qF3lLdrj6pgqs+0i/QzFKPJt1U6wwyNT6x9QpUB2PU/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/15/271e65fa45ab45ae818676501a1096fe/7vvYUZD_.jpg\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e有些游戏不仅需要改编码，还会进行\u003ca href=\"https://github.com/Inori/FuckGalEngine/blob/master/_general_tools/%E8%BE%B9%E7%95%8C%E6%A3%80%E6%B5%8B.txt\" target=\"_blank\" rel=\"noopener\"\u003e字符边界检查\u003c/a\u003e，保证文本数据的每个字节都在 Shift-JIS 的范围内。不过幡紫龙没有添加边界检查。\u003c/p\u003e\u003cp\u003e另外，原来的无衬线体在这里变成了宋体，这也是因为修改了编码后就无法找到字体了。在这里下断点可以找到使用的字体名称：\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003e.rdata:0046EF88\u003c/code\u003e \u003ccode\u003e82 6C 82 72 20 82 6F 96 BE 92 A9\u003c/code\u003e（Shift-JIS 编码的“ＭＳ Ｐ明朝”）\u003c/li\u003e\u003cli\u003e\u003ccode\u003e.rdata:0046EF94\u003c/code\u003e \u003ccode\u003e82 6C 82 72 20 82 6F 83 53 83 56 83 62 83 4E\u003c/code\u003e（Shift-JIS 编码的“ＭＳ Ｐゴシック”）\u003c/li\u003e\u003cli\u003e\u003ccode\u003e.rdata:0046EFA4\u003c/code\u003e \u003ccode\u003e82 6C 82 72 20 96 BE 92 A9\u003c/code\u003e（Shift-JIS 编码的“ＭＳ 明朝”）\u003c/li\u003e\u003cli\u003e\u003ccode\u003e.rdata:0046EFB0\u003c/code\u003e \u003ccode\u003e82 6C 82 72 20 83 53 83 56 83 62 83 4E\u003c/code\u003e（Shift-JIS 编码的“ＭＳ ゴシック”）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e分别改成 GBK 编码的“宋体” \u003ccode\u003eCB CE CC E5\u003c/code\u003e 和“黑体” \u003ccode\u003eBA DA CC E5\u003c/code\u003e。\u003c/p\u003e\u003cp\u003e类似地，可以通过搜索调用 \u003ccode\u003eCreateWindowExA\u003c/code\u003e 的地方和断点调试找到窗口标题的位置：\u003ccode\u003e.rdata:0046D464\u003c/code\u003e \u003ccode\u003e94 A6 8E 87 97 B3 20 81 60 82 CE 82 F1 82 B5 82 E8 82 E3 82 A4 81 60\u003c/code\u003e （Shift-JIS 编码的“幡紫竜 〜ばんしりゅう〜”），改成 GBK 编码的“幡紫龙” \u003ccode\u003eE1 A6 D7 CF C1 FA\u003c/code\u003e。\u003c/p\u003e\u003cp\u003e之后就是修改脚本、改图嵌字之类的和主程序修改无关的琐碎工作了。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e封面图：\u003ca href=\"https://www.pixiv.net/artworks/110299012\" target=\"_blank\" rel=\"noopener\"\u003ePixiv ID: 110299012 「:p」 by 白河\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2024/01/19/banshiryuu-modification/\"\u003ehttps://akarin.dev/2024/01/19/banshiryuu-modification/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2024-01-19T15:37:09Z",
  "Author": "✨小透明・宸✨"
}