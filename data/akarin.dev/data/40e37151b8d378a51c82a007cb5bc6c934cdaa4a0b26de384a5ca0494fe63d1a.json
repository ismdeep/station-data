{
  "Source": "akarin.dev",
  "Title": "使用长短轮询和 SSE 实现服务端主动向客户端发送数据（以及踩到的坑……）",
  "Link": "https://akarin.dev/2019/09/03/use-polling-and-sse/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cblockquote\u003e\u003cp\u003e封面图：\u003ca href=\"https://www.pixiv.net/member_illust.php?mode=medium\u0026amp;illust_id=23245036\" target=\"_blank\" rel=\"noopener\"\u003ePixiv ID: 23245036 「ねむねむ」 by なもり\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e最近突然想试着做一个可以实现实时聊天的网页，也想了解一下网页版 QQ、网页版\u003cdel\u003e某个需要拿出手机扫码才能在电脑上登录的辣鸡社交软件\u003c/del\u003e等等是如何实现和服务器实时同步数据的(｡･ω･)ﾉﾞ\u003c/p\u003e\u003cp\u003e现在常见的实现方式有下面四种：\u003c/p\u003e\u003cul\u003e\u003cli\u003e轮询（或者称作短轮询，Short-Polling）\u003c/li\u003e\u003cli\u003e长轮询（Long-Polling，也有人称作 Comet、反向 AJAX）\u003c/li\u003e\u003cli\u003e服务器发送事件（Server-Sent Events，简称 SSE）\u003c/li\u003e\u003cli\u003eWebSocket\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e（其实还有 \u003ccode\u003e\u0026lt;iframe\u0026gt;\u003c/code\u003e 或 Flash 的实现，不过已经很少见了……）\u003c/p\u003e\u003cp\u003e其中 WebSocket 似乎是最高效的方法，但是实现难度较大。在网页上使用 WebSocket 涉及到了 \u003ccode\u003ews\u003c/code\u003e 和 \u003ccode\u003ewss\u003c/code\u003e 两种新协议（加了字母 s 的是加密协议，类似于 \u003ccode\u003ehttps\u003c/code\u003e 与 \u003ccode\u003ehttp\u003c/code\u003e 的差别），而小透明自己的网站必须使用 \u003ccode\u003ehttps\u003c/code\u003e，因此要使用 WebSocket 的话也必须使用 \u003ccode\u003ewss\u003c/code\u003e，所以还有配置端口、证书等一堆杂事……所以这里就先忽略了。\u003c/p\u003e\u003cp\u003e相对来说，实现前三个的难度要低上不少，而且大部分代码可以复用，正好把三个都实现一遍，也可以对比一下它们的优缺点～至于后端部分，小透明是用\u003cdel\u003e世界上最好的语言\u003c/del\u003e PHP 实现的(:з っ )っ\u003c/p\u003e\u003cp\u003e\u003cdel\u003e其实是因为实现的时候踩了很多坑，结果不得不把三个都试了一遍⊂彡☆))д`)\u003c/del\u003e\u003c/p\u003e\u003cp\u003e下面的这张图（\u003ca href=\"https://codeburst.io/polling-vs-sse-vs-websocket-how-to-choose-the-right-one-1859e4e13bd9\" target=\"_blank\" rel=\"noopener\"\u003e出处\u003c/a\u003e）形象地展示了短轮询、长轮询、SSE 三种实现方式的原理：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1059*769),769px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/f28411f2239b337a6dcc76242450552b/OiLa-xif.png\" data-src-webp=\"https://p.sda1.dev/12/7c8239081b0afb795e2b9f6a7494aa91/rg1WIDSY.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAXACADASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIEAwf/xAAmEAACAgIBAgUFAAAAAAAAAAABAgMRABIhBBMxMkFRYRQicYGC/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAAERMSH/2gAMAwEAAhEDEQA/AO99XK7CVbZUCtY4G1C8zjeXWCMhxG6H1B4rCXcyHZk21bWvevnG6aNDGT1BG9mqauP5wavmcTcrCzhXtJCBlyF/qqJeu3fJFePxklS9p6K77nTy+XK1EYP21eI2spodWYjuMGBUEtdWPS82j6gJGidtzqoF8c1+8MMlbb0iTBREO251Nnw9vzjK1jykYYZB/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/f28411f2239b337a6dcc76242450552b/OiLa-xif.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003ch1 id=\"准备工作\"\u003e\u003ca href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"\u003e\u003c/a\u003e准备工作\u003c/h1\u003e\u003cp\u003e在实现之前，先要建立一个简单的“在线聊天室”的模型。\u003c/p\u003e\u003cul\u003e\u003cli\u003e发送消息：在文本框 \u003ccode\u003emessage\u003c/code\u003e 中输入内容，点击按钮 \u003ccode\u003esend\u003c/code\u003e 将文本发送到 \u003ccode\u003epost.php\u003c/code\u003e 进行数据处理，服务端将文本和发送时的时间戳一起保存到文件 \u003ccode\u003emessage.json\u003c/code\u003e。\u003c/li\u003e\u003cli\u003e接收消息：服务端使用 JSON 格式发送新消息的数据（包含正文和时间戳）。客户端从服务端同步数据后，将最新的消息显示在 \u003ccode\u003etimeline\u003c/code\u003e 中。\u003c/li\u003e\u003c/ul\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/808*545),545px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/07984e76f46303f2d32d7eac6bdb97fa/-fsHp1Nz.png\" data-src-webp=\"https://p.sda1.dev/12/a7bc32170c078a5621a748e8e2e0cd26/fG9BV0JH.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAEEBQMH/8QAJhAAAQQABAUFAAAAAAAAAAAAAQACAxEEEyExIjNBYZEFEhRT0f/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwD3ERenuLQOYdNW/oXb4kAPQrNjliM5D323XZzb3WzhIIrfcMnTmhvfakFeSDDMHvdVDegjcLgpIsyMucCNL0VnKj+tvhDHGAeBvhBDXsocKnMHdEQMwd0dIKOhREH/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/07984e76f46303f2d32d7eac6bdb97fa/-fsHp1Nz.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e非常简单的一个页面，没有样式|･ω･｀)\u003c/p\u003e\u003cp\u003e网页代码如下：\u003c/p\u003e\u003cpre class=\"line-numbers language-markup\" data-language=\"markup\"\u003e\u003ccode class=\"language-markup\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003eDOCTYPE\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003echarset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eUTF-8\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ename\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eviewport\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003econtent\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003ewidth=device-width, initial-scale=1.0\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ehttp-equiv\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eX-UA-Compatible\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003econtent\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eie=edge\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003etextarea\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003emessage\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003etextarea\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ebutton\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003esend\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003eSend\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ebutton\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehr\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e/\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ediv\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003etimeline\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ediv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n        \u003cspan class=\"token comment\"\u003e// 接收消息\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e xhrPost \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eXMLHttpRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;send\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonclick\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edocument\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            xhrPost\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;POST\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;post.php\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            xhrPost\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esetRequestHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Content-type\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;application/x-www-form-urlencoded\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            xhrPost\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message=\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n            document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 同步消息\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 代码略\u003c/span\u003e\n    \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003epost.php\u003c/code\u003e 代码如下：\u003c/p\u003e\u003cpre class=\"line-numbers language-php\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eempty\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token function\"\u003etime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token function\"\u003ehtmlspecialchars\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003efile_put_contents\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message.json\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token function\"\u003ejson_encode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON_UNESCAPED_UNICODE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最后要实现这样的效果：多个不同的客户端同时打开这个页面，其中一方发了消息，在所有的页面上都可以显示。\u003c/p\u003e\u003cvideo controls=\"\" poster=\"https://p.sda1.dev/12/7f5713580a4a430e10c050f32c7a9bc5/TseAi1QY.jpg\" preload=\"metadata\"\u003e\u003csource type=\"video/mp4; codecs=av01.0.09M.10\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/K30XeBDu.mp4\"/\u003e\u003csource type=\"video/mp4; codecs=avc1.640033\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/Ny8eW6j0.mp4\"/\u003e\u003c/video\u003e\u003ch1 id=\"短轮询\"\u003e\u003ca href=\"#短轮询\" class=\"headerlink\" title=\"短轮询\"\u003e\u003c/a\u003e短轮询\u003c/h1\u003e\u003cp\u003e短轮询是最简单的和服务器同步数据的方法，原理是使用 \u003ccode\u003eXMLHttpRequest\u003c/code\u003e 不停地每隔一段时间向服务器发送获取新数据的请求，然后处理返回的数据（如果有新数据的话）。\u003c/p\u003e\u003cp\u003e前端代码，请求时带上时间戳，表示客户端接收到的最新数据的时间：\u003c/p\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e xhrGet \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eXMLHttpRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e time \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 获取到的最新消息的时间戳，初始值为0\u003c/span\u003e\n\nxhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonreadystatechange\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003exhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereadyState \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e XMLHttpRequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eDONE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estatus \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e response \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eparse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003exhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eresponseText\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 有新消息则输出\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        time \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;timeline\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerHTML \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoLocaleString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;zh-CN\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token literal-property property\"\u003ehour12\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessage\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// JS的时间戳单位为毫秒，所以这里要*1000\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;GET\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;get.php?time=\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 每隔一秒，从服务器获取一次最新消息\u003c/span\u003e\n\u003cspan class=\"token function\"\u003esetInterval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003egetMessage\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e后端代码，根据请求的时间戳判断是否要发送新数据：\u003c/p\u003e\u003cpre class=\"line-numbers language-php\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e// 读取客户端的时间戳\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eisset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token function\"\u003eis_numeric\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token function\"\u003eintval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 获取数据，这里是直接读取文件内容\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ejson_decode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003efile_get_contents\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message.json\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 根据客户端请求的时间戳判断是否有新消息，如果有则返回，否则返回空数据\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ejson_encode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON_UNESCAPED_UNICODE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;{}\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e短轮询的实现很简单，但是缺点也很明显：客户端需要频繁发起大量请求，而每次建立连接都需要时间；返回的数据大多数情况下是空的，这时请求头和响应头就占据了请求的所有数据量，即使有返回数据它们的数据量也占了大部分，效率比较低；频繁的请求也可能对服务器造成压力，因此它更适合对数据实时性要求不高的情景。\u003c/p\u003e\u003cp\u003e在理想的网络状况下，如果客户端发出的请求可以被瞬间响应（耗时小于轮询频率），此时有下面的情形（客户端发出请求的时间间隔为 2 秒）：\u003c/p\u003e\u003cul\u003e\u003cli\u003e客户端在第 1 秒发出请求 #1\u003c/li\u003e\u003cli\u003e请求 #1 瞬间得到响应，没有新消息（收到的最新消息的时间为第 0 秒）\u003c/li\u003e\u003cli\u003e服务端在第 2 秒收到消息 A\u003c/li\u003e\u003cli\u003e客户端在第 3 秒发出请求 #3\u003c/li\u003e\u003cli\u003e请求 #3 瞬间得到响应，获取了消息 A（收到的最新消息的时间为第 2 秒）\u003c/li\u003e\u003cli\u003e服务端在第 4 秒收到消息 B\u003c/li\u003e\u003cli\u003e客户端在第 5 秒发出请求 #5\u003c/li\u003e\u003cli\u003e请求 #5 瞬间得到响应，获取了消息 B（收到的最新消息的时间为第 4 秒）\u003c/li\u003e\u003cli\u003e……\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e但是，在网络状况不好的情况下，使用短轮询得到的数据就可能会出现混乱：\u003c/p\u003e\u003cul\u003e\u003cli\u003e客户端在第 1 秒发出请求 #1\u003c/li\u003e\u003cli\u003e请求 #1 瞬间得到响应，没有新消息（收到的最新消息的时间为第 0 秒）\u003c/li\u003e\u003cli\u003e服务端在第 2 秒收到消息 A\u003c/li\u003e\u003cli\u003e客户端在第 3 秒发出请求 #3\u003c/li\u003e\u003cli\u003e请求 #3 \u003cstrong\u003e暂未得到响应\u003c/strong\u003e（收到的最新消息的时间\u003cstrong\u003e仍然为第 0 秒\u003c/strong\u003e）\u003c/li\u003e\u003cli\u003e服务端在第 4 秒收到消息 B\u003c/li\u003e\u003cli\u003e客户端在第 5 秒发出请求 #5\u003c/li\u003e\u003cli\u003e请求 #5 瞬间得到响应，获取了消息 A 和 B（收到的最新消息的时间为第 4 秒）\u003c/li\u003e\u003cli\u003e请求 #3 得到响应，\u003cstrong\u003e又一次获取了消息 A\u003c/strong\u003e（收到的最新消息的时间为第 4 秒）\u003c/li\u003e\u003cli\u003e……\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e为了解决这个问题，可以使用 \u003ccode\u003esetTimeout\u003c/code\u003e 修改上面的前端代码，接收到上一次请求的响应后先等待一段时间，然后再发出下一次请求。\u003c/p\u003e\u003ch1 id=\"长轮询\"\u003e\u003ca href=\"#长轮询\" class=\"headerlink\" title=\"长轮询\"\u003e\u003c/a\u003e长轮询\u003c/h1\u003e\u003cp\u003e短轮询的缺点就在于它发出的请求太多，长轮询就是在发出请求方面对短轮询进行了改进。长轮询仍然使用 \u003ccode\u003eXMLHttpRequest\u003c/code\u003e 向服务端发出请求，但是服务端会将客户端发出的请求挂起，直到有新数据时才立即返回数据（也可以设定连接已挂起较长时间则中断，返回空数据）。客户端发出的请求响应后就立即再发出下一个请求，这样就可以保证与服务端之间一直有一个连接，而且数据的实时性还可以完全由服务端控制，而不是取决于客户端使用 \u003ccode\u003esetInterval\u003c/code\u003e 或 \u003ccode\u003esetTimeout\u003c/code\u003e 发出请求的频率。\u003c/p\u003e\u003cp\u003e前端代码，请求时带上时间戳，表示客户端接收到的最新数据的时间：\u003c/p\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e xhrGet \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eXMLHttpRequest\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e time \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// 获取到的最新消息的时间戳，初始值为0\u003c/span\u003e\n\nxhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonreadystatechange\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003exhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ereadyState \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e XMLHttpRequest\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token constant\"\u003eDONE\u003c/span\u003e \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003estatus \u003cspan class=\"token operator\"\u003e!=\u003c/span\u003e \u003cspan class=\"token number\"\u003e200\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e response \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eparse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003exhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eresponseText\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 有新消息则输出\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e||\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        time \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;timeline\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerHTML \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoLocaleString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;zh-CN\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token literal-property property\"\u003ehour12\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessage\n            \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 上一个请求完成了就立即发出下一个请求\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eopen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;GET\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;get.php?time=\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e time\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    xhrGet\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 手动发起第一次请求\u003c/span\u003e\n\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e后端代码，使用了循环来挂起连接：\u003c/p\u003e\u003cpre class=\"line-numbers language-php\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e// 禁用PHP的执行时间限制\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eset_time_limit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eisset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token function\"\u003eis_numeric\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token function\"\u003eintval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_GET\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 每次循环耗时1秒，最大连接时间10秒\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 获取数据，这里是直接读取文件内容\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ejson_decode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003efile_get_contents\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message.json\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 根据客户端请求的时间戳判断是否有新消息，如果有则返回，并跳出循环\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ejson_encode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON_UNESCAPED_UNICODE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 设定服务端检测新数据的间隔为1秒\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003esleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 一直没有新数据则返回空数据\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;{}\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e分析所有获取数据的网络请求的瀑布流，可以发现除了第一个初始化用的请求是瞬间完成的，其它的请求都被挂起了较长一段时间（上面的示例中的设定为 10 秒）才完成。\u003c/p\u003e\u003cp\u003e有一个请求的耗时不足 10 秒，是因为这个请求被挂起期间服务端返回了一次数据，于是连接立即完成。另外，观察时间轴还可以发现，所有的请求都是连续的，保证了与服务端之间一直有一个连接。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1196*385),385px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/1c05606556c3612da870a862decb62eb/308OINqj.png\" data-src-webp=\"https://p.sda1.dev/12/b812294770232e4574d52230701e90d9/SrOc5oj8.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDBAf/xAAiEAAABgEEAwEAAAAAAAAAAAAAAQIDESFREyIxQQQSFFL/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFREBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhEDEQA/AO5NsrJJS2U6d12KobktzJEMyXXK3q4yG1XP2rjIQW+VNwjHYD8d0kSaKqpDeysmA1Kg7MB//9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/1c05606556c3612da870a862decb62eb/308OINqj.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e长轮询减少了发送请求的频率，但是长时间挂起的连接会\u003cstrong\u003e持续占用着服务端的资源\u003c/strong\u003e。如果服务端不能同时处理大量连接的话，就会\u003cstrong\u003e造成严重的延迟\u003c/strong\u003e。这也是小透明踩中的坑，到后面再详细地解说吧(｡í _ ì｡)\u003c/p\u003e\u003ch1 id=\"服务器发送事件（SSE）\"\u003e\u003ca href=\"#服务器发送事件（SSE）\" class=\"headerlink\" title=\"服务器发送事件（SSE）\"\u003e\u003c/a\u003e服务器发送事件（SSE）\u003c/h1\u003e\u003cp\u003eSSE 是 HTML5 标准中新增的一部分，可以实现服务端向客户端（浏览器）主动发送数据。\u003c/p\u003e\u003cp\u003eSSE 某种意义上有点像长轮询的封装，因为它也需要与服务端保持一个长连接以等待服务端的数据，但是当连接中断时客户端（浏览器）可以\u003cstrong\u003e自动进行重连\u003c/strong\u003e，因此客户端只需要专注于处理收到的数据就可以了。\u003c/p\u003e\u003cp\u003eSSE 的使用依赖于 HTML5 新增的 \u003ccode\u003eEventSource\u003c/code\u003e 对象，然而 \u003ca href=\"https://caniuse.com/#search=eventsource\" target=\"_blank\" rel=\"noopener\"\u003eIE 和 Edge 并不支持\u003c/a\u003e，因此也无法使用。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1272*388),388px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/a277715a84272fcab10747ed4447e92a/95fG5Fpd.png\" data-src-webp=\"https://p.sda1.dev/12/d999d3ee7432d3519ebe079fd54f4c77/X1iPvXG5.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAKACADASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAwUAB//EACYQAAEDAwIFBQAAAAAAAAAAAAECAwQABRESMRMVIVFhIjJUcZP/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQIF/8QAHREAAgICAwEAAAAAAAAAAAAAAREAAgMTBCFRMf/aAAwDAQACEQMRAD8A6gu4wWz65Kdz7QFbfQNI1dIbjiUJfUoqOEjTvv4qPPgwkSnNMVkZAPRAFMxAgqRE1RGDqdUDltPUVm7LNdRZM4rytIp0wG/ZZbuMR0kIcyckY2OR4NKZbCVKRqwoDKh2FFyy2/AjfkmsLZbQciBGB78JNULnyFcz2OvwMT//2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/a277715a84272fcab10747ed4447e92a/95fG5Fpd.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e在使用前，可以检测一下浏览器对 \u003ccode\u003eEventSource\u003c/code\u003e 的支持：\u003c/p\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etypeof\u003c/span\u003e EventSource \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;undefined\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003ealert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;您的浏览器不支持EventSource\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e服务端每次发送的数据由若干行组成，每次发送的数据之间会有一个空行（使用 \u003ccode\u003e\\n\u003c/code\u003e 作为换行符）间隔。事件流用文本组成，有注释、\u003ccode\u003edata\u003c/code\u003e、\u003ccode\u003eid\u003c/code\u003e、\u003ccode\u003eevent\u003c/code\u003e、\u003ccode\u003eretry\u003c/code\u003e 五种类型：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003e: 以单个冒号开头表示注释，可以通过输出注释来防止超时重连\n\n: data表示数据内容，可以直接使用JSON\ndata: some text\n\n: 也可以分成多行\ndata: another message\ndata: with two lines\n\n: 使用id来对数据进行标记\nid: 1\ndata: 1st message\n\n: retry设定客户端在一定时间之后未收到数据（包括注释）则重连，单位为毫秒\nretry: 15000\n\n: event可以自定义事件名，客户端可以使用addEventListener(\u0026#39;事件名\u0026#39;, function (event) { event.data ...})对自定义事件进行操作\n: 不写事件名，则可以使用addEventListener(\u0026#39;message\u0026#39;, function () {...})或onmessage = function (event) { event.data ...}进行操作\nevent: userconnect\ndata: {\u0026#34;username\u0026#34;: \u0026#34;bobby\u0026#34;, \u0026#34;time\u0026#34;: \u0026#34;02:33:48\u0026#34;}\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e其中 \u003ccode\u003eid\u003c/code\u003e 可以实现两次重连之间的消息同步。\u003ccode\u003eEventSource\u003c/code\u003e 每次收到带有 \u003ccode\u003eid\u003c/code\u003e 的数据都会保存下来，下次重连时会将 \u003ccode\u003eid\u003c/code\u003e 的数据写入请求头的 \u003ccode\u003eLast-Event-ID\u003c/code\u003e 这一项，服务器可以根据这个来重建连接继续同步数据。\u003c/p\u003e\u003cp\u003e前端代码，只需要处理收到的数据，不用考虑重连，比长短轮询更简单了：\u003c/p\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e es \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eEventSource\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;get_es.php\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nes\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonmessage\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eevent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e response \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eparse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eevent\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;timeline\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerHTML \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eDate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresponse\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003etime \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etoLocaleString\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;zh-CN\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token literal-property property\"\u003ehour12\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\n        \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emessage\n        \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br /\u0026gt;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e后端代码，稍微复杂了一些，不过和长轮询相比改变不大：\u003c/p\u003e\u003cpre class=\"line-numbers language-php\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token function\"\u003eset_time_limit\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 在Nginx上禁用输出缓存\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eheader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;X-Accel-Buffering: no\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 设定请求头为SSE的事件流类型，禁止缓存\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eheader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;Content-Type: text/event-stream\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eheader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;Cache-Control: no-cache\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 通过Last-Event-ID请求头读取客户端的时间戳\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eisset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_SERVER\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;HTTP_LAST_EVENT_ID\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token function\"\u003eis_numeric\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_SERVER\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;HTTP_LAST_EVENT_ID\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e?\u003c/span\u003e \u003cspan class=\"token function\"\u003eintval\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_SERVER\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;HTTP_LAST_EVENT_ID\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 使用循环挂起连接\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ejson_decode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003efile_get_contents\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;message.json\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 根据客户端请求的时间戳判断是否有新消息，如果有则返回，不用跳出循环\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 由于连接要持续一段时间，因此要在服务端记录时间\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$time\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 输出数据时注意格式和换行\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 使用新消息的时间作为ID\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;id: \u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;data: \u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token function\"\u003ejson_encode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$data\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON_UNESCAPED_UNICODE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;\\n\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"token comment\"\u003e// 输出后，需要刷新PHP的输出缓冲\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eob_end_flush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eflush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// 服务端检测新数据的间隔为1秒\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003esleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSSE 在客户端的实现比较简单，不过它也要长时间挂起连接，占用服务端资源。\u003c/p\u003e\u003ch1 id=\"所以，踩的坑到底是……？\"\u003e\u003ca href=\"#所以，踩的坑到底是……？\" class=\"headerlink\" title=\"所以，踩的坑到底是……？\"\u003e\u003c/a\u003e所以，踩的坑到底是……？\u003c/h1\u003e\u003cp\u003e长短轮询和 SSE 这三种由服务端主动向客户端发送数据的方式，都能满足客户端与服务端实时交互的需求。但是长轮询和 SSE 是通过与服务端维持长连接实现的，如果并发量比较大的话，大量的连接就会\u003cstrong\u003e严重影响服务端的性能\u003c/strong\u003e。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1920*1080),1080px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/ce6da6e621c8e3ef09a272c6296cb657/gGXIFJ8d.png\" data-src-webp=\"https://p.sda1.dev/12/de52597a81c33515f3955ba44fd36a37/R4xKCft5.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGwAAAgEFAAAAAAAAAAAAAAAAAAgCAQMEBQf/xAArEAABAwIEBAUFAAAAAAAAAAABAAIDBBEFBjFBEyEikRQWIzRhMlFTVLH/xAAYAQEAAwEAAAAAAAAAAAAAAAABAAIDBP/EAB4RAAIABgMAAAAAAAAAAAAAAAABAhESITGBA0Gh/9oADAMBAAIRAxEAPwDlEjpbEhx1KZHLuTcKmy9hdUYKYyT0cMjy+ASG5Z8pbHA7E6nZNZletPlzBYncSwoYByY7ZgQ4KrX02Da7ZIZOwa3taHT9NikzJmDyAltLQ/b2bVt/FEdMfFvoPTcB/FnmOoLXNJNjrbke91V8Us1biYKTw/RMp2MDnWaPqOygJJAAA9wA+UIXSbleLL+R3dXxJJy63d0IUYH/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/ce6da6e621c8e3ef09a272c6296cb657/gGXIFJ8d.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e小透明之前在自己的服务器上进行过一次测试，使用了 SSE 与服务端同步数据。在\u003cstrong\u003e同时打开 20 个页面\u003c/strong\u003e的情况下，服务端的性能出现了明显的“下降”，仅仅是发送少量文字就出现了长达 \u003cstrong\u003e70 秒\u003c/strong\u003e 的延迟（获取消息的延迟也少不了），服务器上的 \u003ca href=\"http://www.yahei.net/\" target=\"_blank\" rel=\"noopener\"\u003ePHP 探针\u003c/a\u003e（使用频率为 1 秒的短轮询获取服务器状态信息）也在测试期间出现异常，无法正常获取服务器状态信息。\u003c/p\u003e\u003cp\u003e但是，PHP 代码的执行时间却只有 \u003cstrong\u003e3 毫秒\u003c/strong\u003e 左右；根据服务器后台的监控图表，测试期间服务器的 CPU、硬盘、网络占用均**不到 5%**。所以出现延迟的原因并不是代码写得差(˘_˘٥) 实际上是和 Nginx 处理 PHP 请求的机制有关。\u003c/p\u003e\u003cp\u003eNginx 本身不能执行 PHP 代码。代码先交给另一个进程 FastCGI 执行，然后 Nginx 通过配置中的 \u003ccode\u003efastcgi_pass\u003c/code\u003e 获取执行的结果，返回到客户端。PHP 可以使用 PHP-FPM（FastCGI Process Manager）来管理同时开着的多个 FastCGI 子进程，将执行 PHP 代码的任务交给它们去运行，并根据负载情况自动创建和销毁进程。\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003elocation ~ [^/]\\.php(/|$)\n{\n    try_files $uri =404;\n    fastcgi_pass  unix:/tmp/php-cgi.sock;\n    fastcgi_index index.php;\n    include fastcgi.conf;\n}\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003ePHP-FPM 同时开启的进程数在配置文件 \u003ccode\u003e/usr/local/php/etc/php-fpm.conf\u003c/code\u003e 中可以设定，这些设定项决定了进程数的上限和下限：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003e# 进程数上限\npm.max_children = 32\n# 启动时创建的进程数\npm.start_servers = 8\n# 服务器闲置时保持的进程数范围\npm.min_spare_servers = 2\npm.max_spare_servers = 16\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e测试时 \u003ccode\u003epm.max_children\u003c/code\u003e 的值为 \u003ccode\u003e10\u003c/code\u003e，实际上打开第 10 个页面的时候也已经开始有了延迟。所以出现严重延迟的原因实际上是\u003cstrong\u003e长时间挂起的连接把 PHP-FPM 的进程占满了\u003c/strong\u003e。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003ePHP is not built to be a long-running server, each request is a new process, it’s really not the right choice for a KeepAlive thing.\u003cbr/\u003e——Stack Overflow 上的问题 \u003ca href=\"https://stackoverflow.com/questions/8093467/is-php-scalable-with-reverse-ajax-long-polling\" target=\"_blank\" rel=\"noopener\"\u003eIs php scalable with reverse ajax long polling?\u003c/a\u003e 的回答\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e用 PHP 做长连接是踩坑，是作死行为。既然一个长连接就要占用一个进程（以及大概十几 MB 的内存），那么增加进程数上限也是效率较低的方法。简单粗暴的短轮询反而能有不错的效果……至少小透明换用了短轮询以后，\u003cstrong\u003e同时开了 50 个页面\u003c/strong\u003e也没有严重的延迟。\u003c/p\u003e\u003cp\u003e对了，短轮询还有一个问题就是大量的请求会在服务器上留下大量的日志，占用不少存储空间。如果是 Nginx 的话，倒是可以通过“按条件记录日志”来把指向特定 URL 请求的日志屏蔽掉：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003eset $write_log 1;\n\n# $uri不包括?后面的部分，也就是GET参数\nif ($uri = /get.php) {\n    set $write_log 0;\n}\naccess_log  /home/wwwlogs/access.log combined if=$write_log;\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2019/09/03/use-polling-and-sse/\"\u003ehttps://akarin.dev/2019/09/03/use-polling-and-sse/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2019-09-03T14:55:46Z",
  "Author": "✨小透明・宸✨"
}