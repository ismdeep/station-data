{
  "Source": "akarin.dev",
  "Title": "“存在感消失的地方|ω•`)”已经开始使用 WebP 图片啦！",
  "Link": "https://akarin.dev/2019/10/22/upgrade-to-webp/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cp\u003e先检查一下你的浏览器是否支持 WebP 格式，如果支持的话，下面加载的图片上就会有小灯里（当然，这张图已经被转成 WebP 格式了），不支持的话图片上的小灯里就是透明人（显示另一张 JPEG 格式的图片）了～\u003c/p\u003e\u003cp\u003e（原图来自 \u003ca href=\"https://www.pixiv.net/member_illust.php?mode=medium\u0026amp;illust_id=70919335\" target=\"_blank\" rel=\"noopener\"\u003ePixiv ID: 70919335\u003c/a\u003e）\u003cdel\u003e“你们都欺负灯里，好过分啊”\u003c/del\u003e\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1068*500),500px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/8a84bedba4ee74125f7c51f9fcf8b541/kl8CakPN.jpg\" data-src-webp=\"https://p.sda1.dev/12/491cffad419104d3625772fa1df0e528/xKMk4cug.webp\"/\u003e \u003cimg src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAABAUGB//EACEQAAICAQQDAQEAAAAAAAAAAAECAwQRAAUSMSFBQnEU/8QAFQEBAQAAAAAAAAAAAAAAAAAAAwX/xAAbEQEBAQEAAwEAAAAAAAAAAAABAhEAAxNBMf/aAAwDAQACEQMRAD8A3Jbf9dKy0bmLCuoYj2OjqHiuiM2lN0pGGIbk5zkEKSB++9Opp3ggmgVU8l3dAmSMAkjJb1jsaVPttc7Y8kQwJIg6OQGYpjkNFSmdS9Z46QQm3ZP1zgnFmG7VsSW5ksJKnJe14MMgd+AcEartqnmNx1e7JIjI4MTqnhg2cggDrrUINzgRKxlg5PCgR3+ggPzp8iSVkMlq6WtogZOK8f0HGjtvShcPnHUYJQa/e//Z\" class=\"mdui-hoverable mdui-img-rounded akarin-blurred\"/\u003e\u003cnoscript\u003e\u003cimg src=\"https://p.sda1.dev/12/8a84bedba4ee74125f7c51f9fcf8b541/kl8CakPN.jpg\" class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003ch1 id=\"为什么要使用-WebP\"\u003e\u003ca href=\"#为什么要使用-WebP\" class=\"headerlink\" title=\"为什么要使用 WebP\"\u003e\u003c/a\u003e为什么要使用 WebP\u003c/h1\u003e\u003cblockquote\u003e\u003cp\u003eWebP 是由 Google 收购 On2 Technologies 后发展出来的图片格式，以 BSD 授权条款发布。目前已经在不同厂商之间进行了尝试，如 Google、Facebook、ebay、百度、腾讯、淘宝等。\u003c/p\u003e\u003cp\u003eWebP 在支持有损、无损、透明图片压缩的同时，大大减少了图片的体积。据统计，WebP 无损压缩后比 PNG 图片体积减少了 26%，有损图片比同类 JPEG 图像体积减少了 25% ~ 34%。\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e↑懒得自己写介绍了，就直接\u003ca href=\"https://www.cnblogs.com/mipengine/p/webp-in-mip.html\" target=\"_blank\" rel=\"noopener\"\u003e复制粘贴\u003c/a\u003e好了～总之 WebP 是一种比 JPEG、PNG、GIF 都不知道高到哪里去了的新型图片格式。\u003c/p\u003e\u003cp\u003e以下面两张文件大小相似的，\u003cstrong\u003e被压缩得\u003cdel\u003e惨不忍睹\u003c/del\u003e的高压图\u003c/strong\u003e为例进行比较，一张是 19.2 KB 的 JPEG 图片（使用 \u003ca href=\"https://github.com/mozilla/mozjpeg\" target=\"_blank\" rel=\"noopener\"\u003emozjpeg\u003c/a\u003e 压缩），另一张是 19.0 KB 的 WebP 图片。\u003c/p\u003e\u003cp\u003e（原图来自 \u003ca href=\"https://pixabay.com/photos/venice-veneto-italy-water-canal-4517780/\" target=\"_blank\" rel=\"noopener\"\u003ePixabay\u003c/a\u003e）\u003c/p\u003e\u003cimg src=\"https://p.sda1.dev/12/90c29d2d213f3f6b2ed26300450089da/0Ol7cele.jpg\" id=\"compare-jpeg\" style=\"display:block!important\"/\u003e \u003cimg src=\"https://p.sda1.dev/12/a1ed6fa2d1e2076ea53aad68a048d8ed/UxKlRHz-.webp\" id=\"compare-webp\" style=\"display:none!important\"/\u003e\u003cp\u003e\u003cbutton id=\"compare-select\"\u003e当前显示 JPEG 图片，点击切换为 WebP\u003c/button\u003e\u003c/p\u003e\u003cp\u003e（如果看不到图片的话，说明你的浏览器\u003cstrong\u003e不支持 WebP\u003c/strong\u003e，可以点\u003ca href=\"https://p.sda1.dev/12/22822788f057c38c5659f3854d7d60db/t8HgE4f-.png\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e查看那张 WebP 图片转换为 PNG 格式后的图）\u003c/p\u003e\u003cul\u003e\u003cli\u003e图片上方的天空，JPEG 图片中出现了很明显的色带，但是 WebP 图片中的色带相对来说不怎么明显。\u003c/li\u003e\u003cli\u003e图片下方的水波纹和左下角的码头是细节丰富的高频区域，JPEG 图片出现了明显的“小碎块”，但是 WebP 图片上这种现象就并不是十分明显。\u003c/li\u003e\u003cli\u003eWebP 图片中的小船、码头、建筑物外墙等部分，比 JPEG 图片有更清晰的轮廓。\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e上面的对比中，WebP 的表现显然要优于 JPEG。适当调节压缩参数的话，将 JPEG 二压成 WebP 还能在一定程度上消除 JPEG 压缩时产生的块状噪点。\u003c/p\u003e\u003cp\u003e即使是使用 \u003ca href=\"https://tinypng.com/\" target=\"_blank\" rel=\"noopener\"\u003eTinyPNG\u003c/a\u003e 有损压缩（256 色）过的 PNG 图片，再使用 WebP \u003cstrong\u003e无损压缩\u003c/strong\u003e还能将文件大小继续降低至少 10%。至于 GIF 这种压缩率已经无法\u003cdel\u003e满足人民日益增长的精神文化需要\u003c/del\u003e（各种沙雕图）的动图格式，转换成 Animated WebP 也能进一步降低文件大小。\u003c/p\u003e\u003cp\u003e可以使用更小的文件大小，以更高的质量展示图片，那当然是要资瓷 WebP 格式的啦～\u003c/p\u003e\u003ch1 id=\"将网页的图片升级成-WebP\"\u003e\u003ca href=\"#将网页的图片升级成-WebP\" class=\"headerlink\" title=\"将网页的图片升级成 WebP\"\u003e\u003c/a\u003e将网页的图片升级成 WebP\u003c/h1\u003e\u003cp\u003e小透明一直在使用 \u003ccode\u003eae01.alicdn.com\u003c/code\u003e 的接口作为图床（上传接口参见 GitHub 上的项目 \u003ca href=\"https://github.com/upimg-backup/upimg-mirror/blob/master/modules/alibaba.js\" target=\"_blank\" rel=\"noopener\"\u003eupimg\u003c/a\u003e），之前尝试过直接上传 \u003ccode\u003e.webp\u003c/code\u003e 文件，但是会报错。最近才发现，只要\u003cstrong\u003e将文件扩展名修改为 \u003ccode\u003e.jpg\u003c/code\u003e、\u003ccode\u003e.png\u003c/code\u003e、\u003ccode\u003e.gif\u003c/code\u003e\u003c/strong\u003e 这些传统格式的扩展名，其实是可以上传任意类型的文件的……所以，把 WebP 图片\u003cstrong\u003e修改扩展名为 \u003ccode\u003e.jpg\u003c/code\u003e\u003c/strong\u003e 也是可以上传的，当然也可以在网页上正常使用，于是就有了在这里使用 WebP 图片的打算。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1271*426),426px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/88f2fe17dec2030c34a7311db981fb14/fsrE_nWY.png\" data-src-webp=\"https://p.sda1.dev/12/2d952ae1db6eb39c5531f01a84ab26f4/b5_n25q3.webp\"/\u003e \u003cimg src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAALACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAgQDBQYH/8QAJRAAAgECBQQDAQAAAAAAAAAAAQIDAAQFERIxURMhgaEyQVPR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwEF/8QAHhEAAwACAQUAAAAAAAAAAAAAAQIRAAMSIUFSkuH/2gAMAwEAAhEDEQA/AOrzTpbqXl7cAaczlwKkjutUrx6HJVQ31sazt5hdjFcuEiIByPzbc+acw3B8PaBJTE2sO2TCRwfRrOB2F4JBio6u20BeiECnvcukuVlUsikgEjjuKPqt+beCKTTCLBCSiSKTuRK4z90YwuzD6wsurnqyf2kHKCgXJdngvt8z/9k\" class=\"mdui-hoverable mdui-img-rounded akarin-blurred\"/\u003e\u003cnoscript\u003e\u003cimg src=\"https://p.sda1.dev/12/88f2fe17dec2030c34a7311db981fb14/fsrE_nWY.png\" class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e9102 年了，隔壁 Firefox 早就加入 WebP 格式的支持了，但是 iOS 上的唯一指定浏览器 Safari（虽然 iOS 上也有 Firefox 和 Chrome，但是 Apple 规定\u003cstrong\u003e第三方浏览器必须使用 Safari 内核\u003c/strong\u003e）仍然\u003cstrong\u003e不支持 WebP\u003c/strong\u003e（出来挨打！⊂彡☆))д`) ），另外 IE11 也是不支持的。所以使用 WebP 要考虑向前兼容，在不支持的浏览器上应该自动回退到使用 JPEG 等传统图片格式。\u003c/p\u003e\u003cp\u003e后端可以通过请求头中的 \u003ccode\u003eAccept\u003c/code\u003e 字段判断是否支持 WebP，如果支持的话对应的请求头一般是 \u003ccode\u003eAccept: image/webp, */*\u003c/code\u003e，有些 CDN 服务根据这个实现了“自适应 WebP”的功能。不过因为小透明还是在使用公共图床，所以还是得手动生成传统格式和 WebP 两份图片，然后上传两次，在前端使用两个图片链接……\u003c/p\u003e\u003cp\u003e以下两种在前端自动切换 WebP 的方法，均参考自\u003ca href=\"https://segmentfault.com/a/1190000007482148\" target=\"_blank\" rel=\"noopener\"\u003e“把网站的图片升级到WebP格式吧”\u003c/a\u003e这篇文章。\u003c/p\u003e\u003ch2 id=\"使用-HTML5-中的-标签\"\u003e\u003ca href=\"#使用-HTML5-中的-标签\" class=\"headerlink\" title=\"使用 HTML5 中的 \u0026lt;picture\u0026gt; 标签\"\u003e\u003c/a\u003e使用 HTML5 中的 \u003ccode\u003e\u0026lt;picture\u0026gt;\u003c/code\u003e 标签\u003c/h2\u003e\u003cpre class=\"language-markup line-numbers\" data-language=\"markup\"\u003e\u003ccode class=\"language-markup\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003epicture\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003esource\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrcset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003elarge.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003emedia\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e(min-width: 800px)\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003esource\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrcset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003emedium.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003emedia\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e(min-width: 600px)\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrcset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003esmall.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003epicture\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003e\u0026lt;picture\u0026gt;\u003c/code\u003e 主要用于网页的响应式设计，标签里面可以指定多个 \u003ccode\u003e\u0026lt;source\u0026gt;\u003c/code\u003e，根据显示的页面宽度（在手机和电脑上是不同的）等参数，加载不同的图片（一般是清晰度、图片质量不同）。即使是老旧浏览器不支持 \u003ccode\u003e\u0026lt;picture\u0026gt;\u003c/code\u003e，也可以直接显示里面的 \u003ccode\u003e\u0026lt;img\u0026gt;\u003c/code\u003e，实现了向前兼容。\u003c/p\u003e\u003cp\u003e如果在 \u003ccode\u003e\u0026lt;picture\u0026gt;\u003c/code\u003e 里面加一个使用 WebP 图片的 \u003ccode\u003e\u0026lt;source\u0026gt;\u003c/code\u003e，在最后的 \u003ccode\u003e\u0026lt;img\u0026gt;\u003c/code\u003e 中使用传统格式，这样就可以实现在支持的设备上优先使用 WebP。\u003c/p\u003e\u003cpre class=\"language-markup line-numbers\" data-language=\"markup\"\u003e\u003ccode class=\"language-markup\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003epicture\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003esource\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003etype\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage/webp\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrcset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage.webp\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003epicture\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e不过小透明没有采用这种方式……因为在外面套一个 \u003ccode\u003e\u0026lt;picture\u0026gt;\u003c/code\u003e 标签会影响到 CSS 对标签的选择。小透明根据 \u003ccode\u003edocument.querySelectorAll(\u0026#34;#post-content p \u0026gt; img\u0026#34;)\u003c/code\u003e 为正文部分的所有图片批量添加了“点击查看大图”的功能，如果使用这种方式的话，就需要修改 JS 和 CSS 中使用的选择器代码，需要对 \u003ccode\u003e\u0026lt;source\u0026gt;\u003c/code\u003e 和 \u003ccode\u003e\u0026lt;img\u0026gt;\u003c/code\u003e 两种元素各进行一次操作，比较麻烦。\u003c/p\u003e\u003ch2 id=\"使用-JS-检测-WebP-支持并替换\"\u003e\u003ca href=\"#使用-JS-检测-WebP-支持并替换\" class=\"headerlink\" title=\"使用 JS 检测 WebP 支持并替换\"\u003e\u003c/a\u003e使用 JS 检测 WebP 支持并替换\u003c/h2\u003e\u003cp\u003e可以使用 JS 加载一张 1x1 的 WebP 图片，如果浏览器支持 WebP 的话就可以读取到图片的长和宽。\u003c/p\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003echeckWebp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ecallback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e img \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eImage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    img\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonload\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token function\"\u003ecallback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eimg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewidth \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eimg\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eheight \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    img\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonerror\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token function\"\u003ecallback\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    img\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esrc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e将 \u003ccode\u003e\u0026lt;img\u0026gt;\u003c/code\u003e 标签进行修改，同时写上 WebP 图片和传统格式图片的地址，然后根据检测结果决定使用哪个地址作为 \u003ccode\u003esrc\u003c/code\u003e 属性的值。由于在 JS 中加载图片是异步操作（虽然从 Data URL 中加载几乎是“瞬间”完成，但加载过程本身一定是异步的），因此这个操作需要使用回调函数实现。\u003c/p\u003e\u003cp\u003eMarkdown 的插入图片语法 \u003ccode\u003e![](image.jpg)\u003c/code\u003e 转换出来的是一般的 \u003ccode\u003e\u0026lt;img src=\u0026#34;image.jpg\u0026#34;\u0026gt;\u003c/code\u003e，因此在写博客的时候使用这种方法的话，每次插入图片时需要\u003cstrong\u003e直接手写修改过的 HTML 代码\u003c/strong\u003e。\u003c/p\u003e\u003cp\u003e这种方式的好处是除了修改 \u003ccode\u003e\u0026lt;img\u0026gt;\u003c/code\u003e 标签内的属性和添加一段 JS 代码，不需要再修改别的东西了，也是小透明目前选择的方式～用类似的方法，还可以处理 CSS 的 \u003ccode\u003ebackground-image\u003c/code\u003e 使用的背景图。\u003c/p\u003e\u003cpre class=\"language-markup line-numbers\" data-language=\"markup\"\u003e\u003ccode class=\"language-markup\"\u003e\u003cspan class=\"token comment\"\u003e\u0026lt;!-- 一般的img标签 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eclass\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e...\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003esrc\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ealt\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e...\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e\u0026lt;!-- 为了使用JS替换WebP图片而使用的标签 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e\u0026lt;!-- 如果直接将传统格式图片写进src的话一打开网页就会开始加载，切换src后又会加载WebP图片，等于重新加载了两张图片 --\u0026gt;\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003eimg\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eclass\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e...\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003edata-src\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage.jpg\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003edata-src-webp\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eimage.webp\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ealt\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e...\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre class=\"line-numbers language-javascript\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// 如果img标签存在WebP图片的地址，就使用它进行替换，否则使用传统格式的图片的地址\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 不影响一般的img标签\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eshowImage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003euseWebp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e imgs \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eslice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecall\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edocument\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003equerySelectorAll\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;img\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    imgs\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eforEach\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003euseWebp \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;data-src-webp\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esrc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;data-src-webp\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;data-src\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003esrc \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetAttribute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;data-src\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token function\"\u003echeckWebp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eshowImage\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003cdel\u003e接下来会把之前的文章的图片逐渐添加 WebP 图片的适配\u003c/del\u003e（已完成！），不过封面图因为是用 CSS 的 \u003ccode\u003ebackground-image\u003c/code\u003e 属性设定的，所以并不能做到自动切换(;-_-)\u003c/p\u003e\u003cp\u003e之后的文章里所有的图片也会同时准备 JPEG/PNG/GIF 和 WebP 两种格式。虽然需要多保存一张图，工作量增加了一倍（？），不过能用上新技术想想就很开心(ﾉ)`ω´(ヾ)\u003c/p\u003e\u003cscript\u003edocument.getElementById(\"compare-select\").onclick=function(){\"block\"===document.getElementById(\"compare-jpeg\").style.display?(document.getElementById(\"compare-jpeg\").style.cssText=\"display:none!important\",document.getElementById(\"compare-webp\").style.cssText=\"display:block!important\",document.getElementById(\"compare-select\").innerText=\"当前显示 WebP 图片，点击切换为 JPEG\"):\"block\"===document.getElementById(\"compare-webp\").style.display\u0026\u0026(document.getElementById(\"compare-jpeg\").style.cssText=\"display:block!important\",document.getElementById(\"compare-webp\").style.cssText=\"display:none!important\",document.getElementById(\"compare-select\").innerText=\"当前显示 JPEG 图片，点击切换为 WebP\")}\u003c/script\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2019/10/22/upgrade-to-webp/\"\u003ehttps://akarin.dev/2019/10/22/upgrade-to-webp/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2019-10-22T03:04:30Z",
  "Author": "✨小透明・宸✨"
}