{
  "Source": "akarin.dev",
  "Title": "造轮子：使用 PowerShell 实现多线程下载",
  "Link": "https://akarin.dev/2019/06/05/powershell-multithread-download/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cblockquote\u003e\u003cp\u003e封面图：\u003ca href=\"https://pixabay.com/illustrations/cyber-network-technology-futuristic-3400789/\" target=\"_blank\" rel=\"noopener\"\u003eImage by Pete Linforth from Pixabay\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e在 Windows 系统中 PowerShell 是个好东西，它的地位相当于传统的命令提示符 cmd 的威力加强版。和 cmd 差不多的是，使用 \u003ckbd\u003eWindows+R\u003c/kbd\u003e 打开“运行”，输入 \u003ccode\u003epowershell\u003c/code\u003e 然后回车，就可以打开 PowerShell 的命令行窗口开始搞事c(`･ω´･ c)っ\u003c/p\u003e\u003cp\u003e有过面向对象（然鹅小透明自己都没有对象……）编程经验的人熟悉了语法之后应该很快就可以上手 PowerShell，毕竟 PowerShell 本身就是面向对象的脚本语言，用的是 .NET Framework 的那一套东西，但是在此基础之上还内置了很多把对象预先封装好的操作，称为 cmdlet。\u003c/p\u003e\u003cp\u003e比如 \u003ccode\u003eGet-ChildItem\u003c/code\u003e 就是获取某个目录下的所有文件夹和文件。cmdlet 用起来方便，记起来也方便（一般都是“动词-名词”的命名方式）～\u003c/p\u003e\u003cp\u003e由于这篇废文不应该是 PowerShell 广告文，所以小透明就不在这里继续列举 PowerShell 的优点了……总之是个好东西，小透明自己也经常用，比如用 \u003ccode\u003eGet-ChildItem\u003c/code\u003e 和 \u003ccode\u003eRename-Item\u003c/code\u003e 给文件批量更名什么的(´っω･｡｀)\u003c/p\u003e\u003cp\u003e想要入门 PowerShell 的话，\u003ca href=\"https://www.pstips.net/\" target=\"_blank\" rel=\"noopener\"\u003ePowerShell 中文博客\u003c/a\u003e是个好地方，这个网站上有一套完整的\u003ca href=\"https://www.pstips.net/powershell-online-tutorials\" target=\"_blank\" rel=\"noopener\"\u003e入门教程\u003c/a\u003e～\u003c/p\u003e\u003cp\u003e因为最近使用 PowerShell 的时候实在忍受不了在某些情况下使用 \u003ccode\u003eInvoke-WebRequest\u003c/code\u003e 下载文件的速度，以及最近\u003cdel\u003e又是没有什么事干\u003c/del\u003e（“明明忙爆了好吗\u003cstrong\u003e你还在摸鱼\u003c/strong\u003e！”），所以就打算自己造一个轮子，尝试在 PowerShell 中实现多线程下载的功能～(๑‾ ꇴ ‾๑)\u003c/p\u003e\u003cp\u003e（末尾处有完整代码的下载）\u003c/p\u003e\u003cp\u003e（已经在 Google 上搜索过 “PowerShell Multithread Download” 了，但是结果都是和多线程有关的，和下载没什么关系）\u003c/p\u003e\u003cp\u003e\u003cstrong\u003e（轮子是造着玩的，并没有什么错误处理机制，所以有一个线程下载失败的话整个下载就失败了……）\u003c/strong\u003e\u003c/p\u003e\u003ch1 id=\"多线程下载原理\"\u003e\u003ca href=\"#多线程下载原理\" class=\"headerlink\" title=\"多线程下载原理\"\u003e\u003c/a\u003e多线程下载原理\u003c/h1\u003e\u003cp\u003e一般的单线程下载文件是客户端和服务端建立\u003cstrong\u003e一个\u003c/strong\u003e连接，然后一点点地从服务端获取文件数据。\u003c/p\u003e\u003cp\u003e这样的下载理论上来说不应该存在速度限制（当然速度也不可能超过客户端的网速），但是实际情况下由于一些不可抗力，例如网络波动或者是服务端出于节约资源等目的进行限速，下载文件时\u003cstrong\u003e单个连接\u003c/strong\u003e常常不能跑满带宽，这时就需要使用多线程建立\u003cstrong\u003e多个连接\u003c/strong\u003e进行下载了。\u003c/p\u003e\u003cp\u003e如果将“下载文件”的过程类比成从水缸中抽水的话，单线程和多线程下载的区别，就是使用一台和同时使用多台抽水机的区别ヾ(•ω•`。)\u003c/p\u003e\u003cp\u003e多线程下载的每个线程/连接，下载的是文件的一部分。例如使用八个线程进行下载，每个线程各自下载的就是文件的八分之一。\u003c/p\u003e\u003cp\u003e指定每个线程/连接下载一部分文件，需要设定 HTTP 请求头中的 \u003ccode\u003eRange\u003c/code\u003e 参数，例如 \u003ccode\u003eRange: bytes=0-1023\u003c/code\u003e 就是仅下载文件中第 0 到 1023 字节的内容。\u003c/p\u003e\u003cp\u003e另外，下载前还需要获取文件的大小。向服务端发送一个 \u003ccode\u003eHEAD\u003c/code\u003e 类型的请求（和一般使用的 \u003ccode\u003eGET\u003c/code\u003e 不同的是，\u003ccode\u003eHEAD\u003c/code\u003e 只返回响应头，不返回响应的内容本体），然后根据响应头中的 \u003ccode\u003eContent-Length\u003c/code\u003e 参数就可以获取文件大小（以字节为单位）。\u003c/p\u003e\u003cp\u003e使用 \u003ccode\u003eRange\u003c/code\u003e 的分片下载在浏览器中也有应用。比如网页上有个用 \u003ccode\u003e\u0026lt;video\u0026gt;\u003c/code\u003e 标签显示的视频，浏览器一般会先加载视频文件的\u003cstrong\u003e开头一部分\u003c/strong\u003e，获取视频的元数据。元数据中有视频的总时长，读取后可以显示在进度条上（即使没有播放视频），便于用户直接点击进度条“空降”。\u003c/p\u003e\u003cp\u003e\u003cem\u003e实际上“提前获取元数据”是 \u003ccode\u003e\u0026lt;video\u0026gt;\u003c/code\u003e 标签的 \u003ccode\u003epreload\u003c/code\u003e 属性设为 \u003ccode\u003emetadata\u003c/code\u003e 的效果，这是大多数浏览器设定的默认值。\u003c/em\u003e\u003c/p\u003e\u003cp\u003e如图所示：如果用户点击进度条跳转到某一时刻，浏览器也会根据元数据，\u003cstrong\u003e从某个位置\u003c/strong\u003e开始加载视频文件，包括了该时刻之后的视频数据。这里的 \u003ccode\u003eRange\u003c/code\u003e 写的是 \u003ccode\u003ebytes=14254080-\u003c/code\u003e，没有设定结束的位置，表示加载从第 14254080 字节开始到文件末尾的内容。“断点续传”也使用了类似的原理，根据已下载部分的大小设定继续下载时的起点。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/550*640),640px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/216e9319e95469fa5eca816716d69091/LjHSchVT.png\" data-src-webp=\"https://p.sda1.dev/12/2af92c040181745fbb5e35f4041b0413/tD76iaCU.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgABwDASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAQBAgMFB//EACYQAQABAwMDAwUAAAAAAAAAAAECAAMREnGBISJBBCMxM2GRocH/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/EABsRAAICAwEAAAAAAAAAAAAAAAABAhEhQVFx/9oADAMBAAIRAxEAPwD2P0lu4RkTjlEcuqn4WrXT2+uzis3sksaaiXJdezkSqafRSxYAAAYCqF2L4lzFKZIPmMfy1JYtBgj+2gDnOpm6gD7OaatrEMWZb6awykkxF3x/adjdg/KHJVS0UrUSC7cX6cjhqw38GYwzu0E4LgkPNFQD8P/Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/216e9319e95469fa5eca816716d69091/LjHSchVT.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e简单来说，多线程下载的一般过程是：\u003c/p\u003e\u003col\u003e\u003cli\u003e向服务端发送 \u003ccode\u003eHEAD\u003c/code\u003e 请求，通过 \u003ccode\u003eContent-Length\u003c/code\u003e 获取文件大小，这里以 \u003ccode\u003e100000\u003c/code\u003e 为例。\u003c/li\u003e\u003cli\u003e计算每个线程下载文件的范围。例如使用四个线程，则每个线程下载的 \u003ccode\u003eRange\u003c/code\u003e 分别是 \u003ccode\u003e0-25000\u003c/code\u003e、\u003ccode\u003e25001-50000\u003c/code\u003e、\u003ccode\u003e50001-75000\u003c/code\u003e 和 \u003ccode\u003e75001-\u003c/code\u003e。\u003c/li\u003e\u003cli\u003e建立线程和连接，开始下载。\u003c/li\u003e\u003cli\u003e所有线程下载完毕后，将每个线程下载的部分文件按顺序合并到一起。\u003c/li\u003e\u003c/ol\u003e\u003ch1 id=\"分片下载\"\u003e\u003ca href=\"#分片下载\" class=\"headerlink\" title=\"分片下载\"\u003e\u003c/a\u003e分片下载\u003c/h1\u003e\u003cp\u003ePowerShell 中直接下载文件使用的是内置的 cmdlet \u003ccode\u003eInvoke-WebRequest\u003c/code\u003e，还可以用 \u003ccode\u003eHeader\u003c/code\u003e 参数自定义请求头：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token function\"\u003eInvoke-WebRequest\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eUri \u003cspan class=\"token string\"\u003e\u0026#39;https://files.catbox.moe/sp3axt.mp4\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eOutFile \u003cspan class=\"token string\"\u003e\u0026#39;Eromanga Sensei ED.mp4\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eHeader @\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;key1\u0026#39;\u003c/span\u003e = \u003cspan class=\"token string\"\u003e\u0026#39;value1\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;key2\u0026#39;\u003c/span\u003e = \u003cspan class=\"token string\"\u003e\u0026#39;value2\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e但是 \u003ccode\u003eHeader\u003c/code\u003e 不是可以随便改的……(,,•́.•̀,,)如果修改了某些特定的请求头就会报错，比如修改 \u003ccode\u003eUser-Agent\u003c/code\u003e 是可以的，直接修改 \u003ccode\u003eRange\u003c/code\u003e 就不行。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/87375faccea47fe2e98a9c12a55004e6/mf_TUtds.png\" data-src-webp=\"https://p.sda1.dev/12/e3621e7ca038d798e9001187d1cb273b/R4ZHiNID.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAUBAgMEBv/EACoQAAECBAQDCQAAAAAAAAAAAAEAAgMEBREGITHRE1GTFUJFVWFxgYOh/8QAFwEAAwEAAAAAAAAAAAAAAAAAAQIFAP/EABoRAAIDAQEAAAAAAAAAAAAAAAABERJSAlP/2gAMAwEAAhEDEQA/AOEfiGrnxed+Ijt1rvxDW7ANrE91nhKXRQdSb+wVOJ6fqt1WETpXoxr2/XfO5/rxN0Nr9dbpWp4ffE3Sclp7qjK4RrzlCy9mcgXOQUWHJCERQAHJWDRcZBCETH//2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/87375faccea47fe2e98a9c12a55004e6/mf_TUtds.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e“适当的属性和方法”？难道小透明这么修改不适当吗？(╯‵□′)╯︵┻━┻\u003c/p\u003e\u003cp\u003e\u003ccode\u003eInvoke-WebRequest\u003c/code\u003e 是对 .NET Framework 中 \u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.net.webrequest\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eSystem.Net.WebRequest\u003c/code\u003e\u003c/a\u003e 类的一个封装，参数 \u003ccode\u003eHeader\u003c/code\u003e 对应着这个类的属性 \u003ccode\u003eHeaders\u003c/code\u003e，它包括了发出的 HTTP 请求的所有请求头……但是\u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httpwebrequest.headers#remarks\" target=\"_blank\" rel=\"noopener\"\u003e微软的技术文档\u003c/a\u003e也写着：\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003eThe Headers collection contains the protocol headers associated with the request. The following table lists the HTTP headers that are not stored in the Headers collection but are either set by the system or set by properties or methods.\u003c/p\u003e\u003cp\u003e…\u003c/p\u003e\u003cp\u003eRange: Set by the \u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.net.httpwebrequest.addrange\" target=\"_blank\" rel=\"noopener\"\u003eAddRange\u003c/a\u003e method.\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e总之 \u003ccode\u003eRange\u003c/code\u003e 是不存储在 \u003ccode\u003eHeaders\u003c/code\u003e 中的，必须特别使用 \u003ccode\u003eAddRange(Int64, Int64)\u003c/code\u003e这个方法去修改（˘̩̩ε˘̩ƪ）但是 \u003ccode\u003eInvoke-WebRequest\u003c/code\u003e 是个\u003cstrong\u003e预先封装好的\u003c/strong\u003e cmdlet，并没有准备某个参数可以调用这个方法，这就很尴尬了（摊手\u003c/p\u003e\u003cp\u003e所以 cmdlet 虽然用起来方便，但是扩展性是不够的，这时就只能自己操作 .NET 对象来实现功能了꜀(｡௰｡ ꜆)꜄\u003c/p\u003e\u003cp\u003e自己操作对象实现文件下载的话，除了指定下载范围，当然还要实现将获取的数据写入文件，不过后者就是很简单的文件读写操作了：从网络获取的文件数据可以视为一个文件流，在本地保存的文件也可以视为一个文件流，使用 \u003ccode\u003eCopyTo(Stream)\u003c/code\u003e 就可以将获取的数据保存到本地。\u003c/p\u003e\u003cp\u003e“文件流”就是 \u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.io.stream\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eSystem.IO.Stream\u003c/code\u003e\u003c/a\u003e，有点类似于 C 语言中的 \u003ccode\u003eFILE *fp = fopen(...);\u003c/code\u003e。\u003c/p\u003e\u003cp\u003e以下是完整的函数代码～\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 下载文件的一部分\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$Uri: 下载文件的地址\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$OutFile: 保存文件的路径\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [Int64]$Start [Int64]$End: 下载的范围\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$UserAgent: 下载文件时使用的UA\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e PartiallyDownload-File\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$OutFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[Int64]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[Int64]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$UserAgent\u003c/span\u003e = \u003cspan class=\"token string\"\u003e\u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e = \u003cspan class=\"token namespace\"\u003e[Net.WebRequest]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# $End的默认值为0，此时表示下载结束位置为文件末尾\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddRange\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddRange\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eUserAgent = \u003cspan class=\"token variable\"\u003e$UserAgent\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 获取响应和文件流，同时在本地新建一个用于保存的文件，进行复制\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Response\u003c/span\u003e = \u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGetResponse\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Stream\u003c/span\u003e = \u003cspan class=\"token variable\"\u003e$Response\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGetResponseStream\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$File\u003c/span\u003e = \u003cspan class=\"token namespace\"\u003e[IO.File]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$OutFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Stream\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eCopyTo\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$File\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 下载完成后关闭文件和连接\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$File\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Stream\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Response\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e计算好每个线程下载文件的范围后，就可以使用这个函数让线程开始下载文件了|ω•`)\u003c/p\u003e\u003ch1 id=\"合并文件\"\u003e\u003ca href=\"#合并文件\" class=\"headerlink\" title=\"合并文件\"\u003e\u003c/a\u003e合并文件\u003c/h1\u003e\u003cp\u003e使用 PowerShell 的 cmdlet 和管道操作就可以实现二进制文件的合并：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 将part1.bin、part2.bin和part3.bin合并到merge.bin\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eGet-Content\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePath \u003cspan class=\"token string\"\u003e\u0026#39;part1.bin\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;part2.bin\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;part3.bin\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eEncoding Byte \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eSet-Content\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePath \u003cspan class=\"token string\"\u003e\u0026#39;merge.bin\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eEncoding Byte\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e但是经过小透明的测试，这样太慢了，对于稍微大一点的文件就完全读取不能(｡í _ ì｡)\u003c/p\u003e\u003cp\u003e有一种改进的方法是设定 \u003ccode\u003eGet-Content\u003c/code\u003e 的 \u003ccode\u003eReadCount\u003c/code\u003e 参数（这参数的默认值居然是 \u003cstrong\u003e1\u003c/strong\u003e ？！）来提升读取文件的速度，每次\u003cstrong\u003e读取一定大小的数据到内存\u003c/strong\u003e后，再通过管道让 \u003ccode\u003eSet-Content\u003c/code\u003e 将读取的数据写入文件～\u003c/p\u003e\u003cp\u003e对了，\u003ccode\u003eReadCount\u003c/code\u003e 设为 0 的话就是将\u003cstrong\u003e整个文件读取到内存\u003c/strong\u003e。如果要\u003cstrong\u003e读取大文件\u003c/strong\u003e的话，只要电脑的\u003cstrong\u003e内存够大\u003c/strong\u003e，这么做也不是不可以（逃\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token function\"\u003eGet-Content\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePath \u003cspan class=\"token string\"\u003e\u0026#39;part1.bin\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;part2.bin\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;part3.bin\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eReadCount 256KB \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eEncoding Byte \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eSet-Content\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePath \u003cspan class=\"token string\"\u003e\u0026#39;merge.bin\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eEncoding Byte\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e从桌面上随便找了一个大约 30MB 的文件，测试一下设定了 \u003ccode\u003eReadCount\u003c/code\u003e 后的效果：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/1414884cbb0381b4904fe7ed79c45d63/ooutBICz.png\" data-src-webp=\"https://p.sda1.dev/12/df4c05ac07dad158865c117b349f6e52/zni7y-ku.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBQb/xAAoEAABAwIEBAcAAAAAAAAAAAABAAIRBSEDBAbRE1GBkxYiQVJTVcH/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQUC/8QAGREAAgMBAAAAAAAAAAAAAAAAAAECElFS/9oADAMBAAIRAxEAPwDgcTUVYm9XzvTFduqX6irUQ2sZ/vP3Wc4n0xWDqSqXF1xxGn9VqscRMs9NPxBXfuc/337o3UFdbYVnPiT8791k396AmR5lqsOUK0tZaQJNgogcgiJgIHIKQBIsERAj/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/1414884cbb0381b4904fe7ed79c45d63/ooutBICz.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e速度有所提升，但是折算下来的读取速度在 10MB/s 左右，这不是一块固态硬盘应有的读取速度。如果要进一步改进的话，难道又要手动折腾 .NET 对象了吗？！（°ー°〃）\u003c/p\u003e\u003cp\u003e设定 \u003ccode\u003eReadCount\u003c/code\u003e 的方法是小透明\u003ca href=\"https://stackoverflow.com/questions/1783554/fast-and-simple-binary-concatenate-files-in-powershell\" target=\"_blank\" rel=\"noopener\"\u003e在 Stack Overflow 上找到的\u003c/a\u003e，不过下面就有人给出了更简单直接的方法，也是几乎没有性能损耗的方法：使用 cmd 的 \u003ccode\u003ecopy\u003c/code\u003e 命令∑(ﾟωﾟ∪)\u003c/p\u003e\u003cpre class=\"line-numbers language-cmd\" data-language=\"cmd\"\u003e\u003ccode class=\"language-cmd\"\u003ecopy /b part1.bin+part2.bin+part3.bin merge.bin\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e不过既然是用上了 cmd，就有必要考虑一下文件路径的问题……比如文件路径如果带有空格，就应该用引号包住，否则会被当成\u003cstrong\u003e两个不同的参数\u003c/strong\u003e。另外，使用相对路径容易产生错误，因此需要根据相对路径获取绝对路径。\u003c/p\u003e\u003cp\u003ePowerShell 的 cmdlet \u003ccode\u003eResolve-Path\u003c/code\u003e 可以用来获取绝对路径，但是只能用于硬盘上\u003cstrong\u003e已经存在的文件\u003c/strong\u003e。获取\u003cstrong\u003e不存在的文件\u003c/strong\u003e的绝对路径就要使用 \u003ccode\u003e$ExecutionContext.SessionState.Path.GetUnresolvedProviderPathFromPSPath(String)\u003c/code\u003e 这一长串东西了。\u003c/p\u003e\u003cp\u003e把以上的操作组合起来，就是下面的函数：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 合并文件\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String[]]$Source: 所有要进行合并的源文件的路径\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$Destination: 合并后的文件的保存路径\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eMerge-File\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[String[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Destination\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# PowerShell中让某个变量等于一个数组，赋值的实际上是数组的引用，而不是复制了一份的数组，因此这里需要手动复制\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e = \u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClone\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 将源文件的路径转换为绝对路径，用引号包住\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e = \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#34;\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ExecutionContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSessionState\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGetUnresolvedProviderPathFromPSPath\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#34;\u0026#39;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 将源文件路径的数组转换为cmd的copy命令接受的格式（各个文件路径之间使用+连接），合并文件\u003c/span\u003e\n    cmd \u003cspan class=\"token operator\"\u003e/\u003c/span\u003ec \u003cspan class=\"token function\"\u003ecopy\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003eb \u003cspan class=\"token operator\"\u003e/\u003c/span\u003ey \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Source\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-join\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;+\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ExecutionContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSessionState\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGetUnresolvedProviderPathFromPSPath\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Destination\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eOut-Null\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e如果线程开得太多（比如一口气开了 128 个），那就不能使用 \u003ccode\u003ecopy\u003c/code\u003e 一次性合并所有文件了，原因是临时文件太多，组合起来的路径太长。根据\u003ca href=\"https://support.microsoft.com/zh-cn/help/830473/command-prompt-cmd-exe-command-line-string-limitation\" target=\"_blank\" rel=\"noopener\"\u003e微软官方的说明\u003c/a\u003e，cmd 中单条命令的长度\u003cstrong\u003e不能超过 8191 个字符\u003c/strong\u003e┓( ´∀` )┏\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003eOn computers \u003cstrong\u003erunning Microsoft Windows XP or later\u003c/strong\u003e, the maximum length of the string that you can use at the command prompt is \u003cstrong\u003e8191 characters\u003c/strong\u003e. On computers running Microsoft Windows 2000 or Windows NT 4.0, the maximum length of the string that you can use at the command prompt is 2047 characters.\u003cbr/\u003eIn a batch file, the total length of the following command line after you expand the environment variables in the command line \u003cstrong\u003ecannot contain more than either 2047 or 8191 characters\u003c/strong\u003e (as appropriate to your operating system).\u003cbr/\u003eExecutableFile.exe parameter1 parameter2 …\u003c/p\u003e\u003c/blockquote\u003e\u003ch1 id=\"“多线程下载”的实现\"\u003e\u003ca href=\"#“多线程下载”的实现\" class=\"headerlink\" title=\"“多线程下载”的实现\"\u003e\u003c/a\u003e“多线程下载”的实现\u003c/h1\u003e\u003cp\u003e和一开始说的一样，多线程下载的过程可以分为四个部分：获取大小，计算范围，建立线程，合并文件。除了“建立线程”之外的三个部分都非常简单，没有什么技术含量，很容易就可以实现～☆ﾐ(o*･ω･)ﾉ*\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 使用多线程下载文件\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$Uri: 下载文件的地址\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$OutFile: 保存文件的路径\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [Int32]$ThreadCount: 使用的线程数量\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$UserAgent: 下载文件时使用的UA\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e MultiThreadDownload-File\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$OutFile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e = 4\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[String]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$UserAgent\u003c/span\u003e = \u003cspan class=\"token string\"\u003e\u0026#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 获取文件大小\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Int64]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Length\u003c/span\u003e = \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eInvoke-WebRequest\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMethod Head \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eUseBasicParsing\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eHeaders\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Content-Length\u0026#39;\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 表示每个线程使用的临时文件路径和下载范围的三个数组，数组的下标就是对应的线程的编号\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Int64[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Int64[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[String[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 计算下载范围，使用生成的GUID作为临时文件的名称\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[Int64]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[Math]\u003c/span\u003e::Round\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Length\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ExecutionContext\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eSessionState\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ePath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGetUnresolvedProviderPathFromPSPath\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[GUID]\u003c/span\u003e::NewGuid\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eToString\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;N\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;.bin\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 建立线程开始下载\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 等待所有线程下载完成\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 合并临时文件，然后删除\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eMerge-File\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eSource \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eDestination \u003cspan class=\"token variable\"\u003e$OutFile\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eforeach\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$p\u003c/span\u003e in \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003eRemove-Item\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$p\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e真正复杂的是“建立线程”这一部分(;-_-)关于在 PowerShell 中使用多线程的基本理论可以参考\u003ca href=\"https://www.pstips.net/speeding-up-powershell-multithreading.html\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\u003ch2 id=\"使用-cmdlet-实现多线程\"\u003e\u003ca href=\"#使用-cmdlet-实现多线程\" class=\"headerlink\" title=\"使用 cmdlet 实现多线程\"\u003e\u003c/a\u003e使用 cmdlet 实现多线程\u003c/h2\u003e\u003cp\u003e使用多线程的简单方法是使用几个名称形如 \u003ccode\u003e*-Job\u003c/code\u003e 的 cmdlet，例如：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token function\"\u003eMeasure-Command\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 建立线程\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# ScriptBlock指定了线程执行的PowerShell代码\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# Start-Sleep可以让线程停止执行一段时间\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eScriptBlock \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eSeconds 3\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eOut-Null\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eScriptBlock \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eSeconds 4\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eOut-Null\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eScriptBlock \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eSeconds 5\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eOut-Null\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 用while循环将主线程“卡住”，只有在所有线程结束之后才继续执行\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 使用Measure-Command计算主线程被“卡住”的时间，也就是所有线程执行的时间\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eState Running\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds 20\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eSelect-Object\u003c/span\u003e TotalSeconds\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/d229b9b230e4da55cb823b14a1e9fdff/kQ9ue5GS.png\" data-src-webp=\"https://p.sda1.dev/12/17a1a569cbf9b85403b892d506b0a9eb/4HmmVd13.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAEDBQb/xAAjEAABAgYCAgMAAAAAAAAAAAABAAIDBAURITEGURXREjKB/8QAFwEBAQEBAAAAAAAAAAAAAAAAAAUBAv/EABsRAQACAgMAAAAAAAAAAAAAAAACEgFRUmGR/9oADAMBAAIRAxEAPwDhH8grLs+XnN6EV6rfXK9hrazN27Ed6xnRPj9Rvdz6VLnvdslWadR8S7S21nV+vtJHmZ78mIihnIK83VYnhc3xMP8AayLntBsLuseOC0tryBc4Ciw6CItCw6CkAXGAiIP/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/d229b9b230e4da55cb823b14a1e9fdff/kQ9ue5GS.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e多线程确实起到了效果～这里的三个线程，如果顺序执行的话需要 12 秒，但是使用多线程的话就可以同时进行，耗时是所有线程执行时间的最大值，不过还要加上建立线程的时间。\u003c/p\u003e\u003cp\u003e但是小透明在实际使用的时候遇到了一个坑：上面的例子中 \u003ccode\u003eScriptBlock\u003c/code\u003e 中的代码调用的是内置的 cmdlet，而实现分片下载调用的是在脚本中自定义的一个函数，然而直接在 \u003ccode\u003eScript\u003c/code\u003e 里调用自定义的函数的话就会……\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/082770dbc933c2dcf05318d323b96f6d/Zwtjxon3.png\" data-src-webp=\"https://p.sda1.dev/12/b6d7152a5e1e33026e8d21f20fb36d6d/9JdGphcD.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGgABAAIDAQAAAAAAAAAAAAAAAAMFAQIEBv/EACYQAAEDAwMCBwAAAAAAAAAAAAEAAhEFIVEDBDFT0QYVFlVxgZT/xAAXAQEBAQEAAAAAAAAAAAAAAAAABQEC/8QAGxEAAgIDAQAAAAAAAAAAAAAAAAECEhExUVL/2gAMAwEAAhEDEQA/APCvr9ZdB823ov1HDj7UWpXa9BAq2/AGNZ/dVDntbYkGb5hQu1XEmIA+FZo86RLtPpZ+oK97zv8A9D+6M8QV5vFY3wk9d6qCZwg5C7rHyhaXWdDr2K1gYCItAgYCyAJFgiID/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/082770dbc933c2dcf05318d323b96f6d/Zwtjxon3.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e把 \u003ccode\u003eStart-Sleep\u003c/code\u003e 换成了相同效果的自定义函数 \u003ccode\u003eSleep\u003c/code\u003e，结果\u003cstrong\u003e完全没有执行\u003c/strong\u003e啊喂！(ಡ_ಡﾞ)\u003c/p\u003e\u003cp\u003e\u003ccode\u003eSleep\u003c/code\u003e 这个自定义的函数只是在主线程（也就是当前打开的这个 PowerShell）中有定义，但在新建立的线程中是不存在的，直接将调用函数写进 \u003ccode\u003eScriptBlock\u003c/code\u003e 的话，每个新线程就只能输出一次黑底红字\u003cspan style=\"color:red;background-color:#000\"\u003e无法将“Sleep”项识别为 cmdlet、函数、脚本文件或可运行程序的名称\u003c/span\u003e，然而主线程是看不到报错提示的ﾍ(´ー｀ﾍ)\u003c/p\u003e\u003cp\u003e正确的做法是把函数本体通过函数变量 \u003ccode\u003e${Function:\u0026lt;函数名称\u0026gt;}\u003c/code\u003e 传给线程，然后\u003cstrong\u003e按照顺序\u003c/strong\u003e在 \u003ccode\u003eArgumentList\u003c/code\u003e 中指定参数，这样线程才能正常地调用函数( ･ㅂ･)و ̑̑\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/33971a77bd2371360754144e1ec727e6/3hGIwRxM.png\" data-src-webp=\"https://p.sda1.dev/12/6200c5e16802f0bf3d4f292517a4d7c0/h8vOMbBa.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAAAAEDBQIEBv/EACIQAAEDAwQDAQAAAAAAAAAAAAEAAhEDBSEEMVGBBhXRcf/EABcBAAMBAAAAAAAAAAAAAAAAAAABBQL/xAAbEQACAgMBAAAAAAAAAAAAAAAAAgESETJRQf/aAAwDAQACEQMRAD8A4R9/vTs+21vVV31Qvv8AfYgXfX9Vn/VUue1uJBnKhdUJOAAPxWaTnVcEuz9LV1/8gbE3jX913/UmeQX5u141wkziu9VJcXbpDcLcKvqwFm7JsOySDysYHAQhMBwOAgASMBCECP/Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/33971a77bd2371360754144e1ec727e6/3hGIwRxM.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e熟悉了建立线程的操作后，就可以开始编写相关的代码了(・∀・)つ另外，等待下载完成的时候主线程什么都不做也不好，可以使用 \u003ccode\u003eWrite-Progress\u003c/code\u003e 为每个线程的下载进度显示一个进度条～\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 为每个线程计算完下载范围之后\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 建立下载线程\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eScriptBlock $\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eFunction\u003c/span\u003e:PartiallyDownload-File\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eArgumentList \u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$UserAgent\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eOut-Null\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token namespace\"\u003e[Double]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e = 0 \u003cspan class=\"token comment\"\u003e# 暂时保存某个线程的下载进度百分比\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Interval\u003c/span\u003e = 200 \u003cspan class=\"token comment\"\u003e# 进度条的刷新间隔\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eState Running\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds \u003cspan class=\"token variable\"\u003e$Interval\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e# 如果线程还没有开始下载，即写入的临时文件还没有建立，则跳过显示进度条的操作\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eTest-Path\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e# 计算下载进度：获取临时文件的大小，除以下载范围的长度\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e = \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Item\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e 100\n        \u003cspan class=\"token comment\"\u003e# 在进度条中显示线程编号、下载范围和下载进度\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eWrite-Progress\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eId \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eActivity \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Thread #{0} {1} - {2}\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eStatus \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;{0} / {1} {2:f2}%\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Item\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePercentComplete \u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 下载结束后使用Completed参数隐藏进度条\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eWrite-Progress\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eId \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eActivity \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Thread {0} - {1}\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eCompleted\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 销毁所有建立的线程\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eRemove-Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 接下来执行“合并文件”的操作\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"不使用-cmdlet-实现多线程\"\u003e\u003ca href=\"#不使用-cmdlet-实现多线程\" class=\"headerlink\" title=\"不使用 cmdlet 实现多线程\"\u003e\u003c/a\u003e不使用 cmdlet 实现多线程\u003c/h2\u003e\u003cp\u003e把上面的代码组合起来，已经足够可以实现多线程下载了d(ﾟ∀ﾟd)\u003c/p\u003e\u003cp\u003e但是这个实现方案有一个缺点……\u003ccode\u003eStart-Job\u003c/code\u003e 并不是真正的\u003cstrong\u003e多线程\u003c/strong\u003e，只是另外开了一个 \u003ccode\u003epowershell.exe\u003c/code\u003e 的\u003cstrong\u003e进程\u003c/strong\u003e，结果就是下载时在任务管理器里可以看到一大堆 \u003ccode\u003epowershell.exe\u003c/code\u003e，就像 Chrome 和 Firefox 那样╮( •́ω•̀ )╭\u003c/p\u003e\u003cp\u003e使用\u003cstrong\u003e多进程\u003c/strong\u003e不仅不优雅，还会造成严重的性能损耗，每开一个 \u003ccode\u003epowershell.exe\u003c/code\u003e 就需要\u003cstrong\u003e占用将近 30MB 的内存\u003c/strong\u003e。虽然内存确实是拿来用的，\u003cstrong\u003e不是给那些“○○管家”“○○卫士”的加速球清着玩的\u003c/strong\u003e，但也不是这么随便浪费的(｀ﾍ´)ノ☆(#\u0026gt;_\u0026lt;)\u003c/p\u003e\u003cp\u003e真正的\u003cstrong\u003e多线程\u003c/strong\u003e需要使用 \u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.management.automation.powershell\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eSystem.Management.Automation.PowerShell\u003c/code\u003e\u003c/a\u003e 这个类（文档甚至连机翻都没有了……），可以单独新建一个线程执行 PowerShell 脚本。这个类中可以用到的方法有这些：\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eCreate()\u003c/code\u003e 用于新建线程。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eAddCommand(String)\u003c/code\u003e 用于为线程添加 PowerShell 代码。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eAddParameter(String, Object)\u003c/code\u003e用于添加参数。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eIsCompleted()\u003c/code\u003e 用于检测线程是否执行完毕。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eInvoke()\u003c/code\u003e 用于\u003cstrong\u003e同步\u003c/strong\u003e执行线程。（但是就没有多线程操作的意义了）\u003c/li\u003e\u003cli\u003e\u003ccode\u003eBeginInvoke()\u003c/code\u003e 用于\u003cstrong\u003e异步\u003c/strong\u003e执行线程，返回的 \u003ca href=\"https://docs.microsoft.com/zh-cn/dotnet/api/system.iasyncresult\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eSystem.IAsyncResult\u003c/code\u003e\u003c/a\u003e 包含了这个线程的状态信息。\u003c/li\u003e\u003cli\u003e\u003ccode\u003eEndInvoke(IAsyncResult)\u003c/code\u003e 用于结束线程的执行，返回线程执行的结果。（然而这里每个线程的任务只是下载文件而已，没有输出，所以不需要接收结果）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e添加代码和参数的两个方法返回的是 PowerShell 线程本体，有点链式调用的风格～把上面的例子用这里的方法改写一下：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Time\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eSeconds \u003cspan class=\"token variable\"\u003e$Time\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eMeasure-Command\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 建立线程\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Management.Automation.PowerShell[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Object[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e 3\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[PowerShell]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddScript\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eFunction\u003c/span\u003e:\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 3\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eBeginInvoke\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 在循环中检查所有线程是否已执行完成\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Boolean]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds 20\n\n        \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$true\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e 3\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eIsCompleted\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e\n                \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eSelect-Object\u003c/span\u003e TotalSeconds\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1221*697),697px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/9fb7e5943b7ef8f4e521be1137aa998e/sAwZrpwO.png\" data-src-webp=\"https://p.sda1.dev/12/3f2849c84571e1e9d14ca6cf12866def/LfrA_iHk.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAASACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAUBAgQG/8QAIxAAAQQABgIDAAAAAAAAAAAAAQACBREDBBIhMVEGcxVB0f/EABcBAAMBAAAAAAAAAAAAAAAAAAABBQL/xAAcEQACAgIDAAAAAAAAAAAAAAAAAQISEVEiUpH/2gAMAwEAAhEDEQA/AOHdOzL6Il85zwMV36s+JPTlUJfP17XhKidAp2nckgrO5wcd3FWVFZfFYJdpbY2+e8gqxLyFe/EVWz8+00JjPCzZrHelJ0/RKgchbrHqvAtLbGOOxgYCGDnpZKHQQhMAodBSALGwQhAj/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/9fb7e5943b7ef8f4e521be1137aa998e/sAwZrpwO.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e从执行时间可以看出，这种方法在建立线程消耗的时间上比使用 cmdlet 更少：后者需要 0.8~0.9 秒来建立线程，但是使用这种方法建立线程的耗时不到 0.1 秒，而且也不会给每个线程开一个 \u003ccode\u003epowershell.exe\u003c/code\u003e 占用大量内存（一上来就占用 30MB），线程的内存按需取用，而且是算在主进程名下的(´ﾟωﾟ｀)\u003c/p\u003e\u003cp\u003e线程开多了 CPU 占用率会大幅增加，不过这个是可以接受的。如果有特别需求的话，也可以考虑使用线程池，限定同时只能执行若干个进程。\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Time\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds \u003cspan class=\"token variable\"\u003e$Time\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eWrite-Host\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Sleep Time: \u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Time\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003eMeasure-Command\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 建立同时最多执行1~4个线程的线程池\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$ThreadPool\u003c/span\u003e = \u003cspan class=\"token namespace\"\u003e[RunspaceFactory]\u003c/span\u003e::CreateRunspacePool\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e1\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e 4\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Host\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$ThreadPool\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eOpen\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 建立线程\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Management.Automation.PowerShell[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Object[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e 16\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[PowerShell]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddScript\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eFunction\u003c/span\u003e:\u003cspan class=\"token function\"\u003eSleep\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Time\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Random\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMinimum 1500 \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMaximum 2500\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRunspacePool = \u003cspan class=\"token variable\"\u003e$ThreadPool\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eBeginInvoke\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 在循环中检查所有线程是否已执行完成\u003c/span\u003e\n    \u003cspan class=\"token namespace\"\u003e[Boolean]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds 20\n\n        \u003cspan class=\"token comment\"\u003e# 每次检查时，仅当所有线程已完成，$Complete才可能为true\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e# 检查到任何一个未完成的线程都会使这个变量为false\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$true\u003c/span\u003e\n\n        \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e 16\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e# 跳过对已完成线程的检查\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-eq\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$null\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e# 如果线程已完成，则返回输出，销毁线程，从线程池中移出\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eIsCompleted\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eEndInvoke\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDispose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e = \u003cspan class=\"token variable\"\u003e$null\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e|\u003c/span\u003e \u003cspan class=\"token function\"\u003eSelect-Object\u003c/span\u003e TotalSeconds\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e改进后的操作线程的代码：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 为每个线程计算完下载范围之后\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 保存线程信息的数组\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Management.Automation.PowerShell[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Object[]]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e = @\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 建立下载线程\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token namespace\"\u003e[PowerShell]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddScript\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e$\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eFunction\u003c/span\u003e:PartiallyDownload-File\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Uri\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;OutFile\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Start\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;End\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eAddParameter\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;UserAgent\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$UserAgent\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eBeginInvoke\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token namespace\"\u003e[Double]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e = 0 \u003cspan class=\"token comment\"\u003e# 暂时保存某个线程的下载进度百分比\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Interval\u003c/span\u003e = 200 \u003cspan class=\"token comment\"\u003e# 进度条的刷新间隔\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Boolean]\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e \u003cspan class=\"token comment\"\u003e# 表示所有线程的完成情况\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eStart-Sleep\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMilliseconds \u003cspan class=\"token variable\"\u003e$Interval\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e# 在循环中检查所有线程是否已执行完成\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$true\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eIsCompleted\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token variable\"\u003e$Complete\u003c/span\u003e = \u003cspan class=\"token boolean\"\u003e$false\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003ebreak\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e# 如果线程还没有开始下载，即写入的临时文件还没有建立，则跳过显示进度条的操作\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eTest-Path\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econtinue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e# 计算下载进度：获取临时文件的大小，除以下载范围的长度\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e = \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Item\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e 100\n        \u003cspan class=\"token comment\"\u003e# 在进度条中显示线程编号、下载范围和下载进度\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003eWrite-Progress\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eId \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eActivity \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Thread #{0} {1} - {2}\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eStatus \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;{0} / {1} {2:f2}%\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003eGet-Item\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Part\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eLength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e 1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ePercentComplete \u003cspan class=\"token variable\"\u003e$Progress\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e = 0\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-lt\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$ThreadCount\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e# 下载结束后使用Completed参数隐藏进度条\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eWrite-Progress\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eId \u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eActivity \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Thread {0} - {1}\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003ef \u003cspan class=\"token variable\"\u003e$Start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$End\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eCompleted\n\n    \u003cspan class=\"token comment\"\u003e# 结束和销毁线程\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eEndInvoke\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Handle\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eRunspace\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eClose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$Job\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eDispose\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 接下来执行“合并文件”的操作\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e其实还可以继续改进的～比如每个线程可以在下载完成后立即销毁并隐藏对应的进度条，不用等到下载结束后统一销毁。\u003c/p\u003e\u003ch2 id=\"其他的一些优化（？）\"\u003e\u003ca href=\"#其他的一些优化（？）\" class=\"headerlink\" title=\"其他的一些优化（？）\"\u003e\u003c/a\u003e其他的一些优化（？）\u003c/h2\u003e\u003cp\u003e根据 \u003ca href=\"https://stackoverflow.com/questions/2519655/httpwebrequest-is-extremely-slow\" target=\"_blank\" rel=\"noopener\"\u003eStack Overflow 上的某个问题\u003c/a\u003e，直接使用 \u003ccode\u003eWebRequest\u003c/code\u003e 还是太慢。下面的回答中给出了两个优化的方法，不过小透明并没有测试过实际效果……也许真的有用？\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 将同时使用的网络连接数量设为最大值，默认为2\u003c/span\u003e\n\u003cspan class=\"token namespace\"\u003e[Net.ServicePointManager]\u003c/span\u003e::DefaultConnectionLimit = \u003cspan class=\"token namespace\"\u003e[Int32]\u003c/span\u003e::MaxValue\n\n\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e# 禁用对网络代理的搜索\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e = \u003cspan class=\"token namespace\"\u003e[Net.WebRequest]\u003c/span\u003e::Create\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$Uri\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$Request\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eProxy = \u003cspan class=\"token variable\"\u003e$null\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003chr/\u003e\u003cp\u003e完整的代码可以在\u003ca href=\"https://gist.github.com/TransparentLC/7a37a7867b0f65c0068035d00f49e09b\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e下载～( ◞´•௰•`)◞\u003c/p\u003e\u003cp\u003e多线程下载函数的使用方法：\u003c/p\u003e\u003cpre class=\"language-powershell line-numbers\" data-language=\"powershell\"\u003e\u003ccode class=\"language-powershell\"\u003e\u003cspan class=\"token comment\"\u003e# 使用多线程下载文件\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$Uri: 下载文件的地址\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$OutFile: 保存文件的路径\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [Int32]$ThreadCount: 使用的线程数量（可选，默认为4）\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [Int32]$MinSliceSize: 分配给每个线程下载的数据量的下限，若线程过多则根据此参数强制减少线程数（可选，默认为256KB）\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# [String]$UserAgent: 下载文件时使用的UA（可选，有默认值）\u003c/span\u003e\nMultiThreadDownload-File \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eUri \u003cspan class=\"token string\"\u003e\u0026#39;...\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eOutFile \u003cspan class=\"token string\"\u003e\u0026#39;...\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eMinSliceSize 256KB \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eThreadCount 4 \u003cspan class=\"token operator\"\u003e-\u003c/span\u003eUserAgent \u003cspan class=\"token string\"\u003e\u0026#39;...\u0026#39;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2019/06/05/powershell-multithread-download/\"\u003ehttps://akarin.dev/2019/06/05/powershell-multithread-download/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2019-06-05T06:09:41Z",
  "Author": "✨小透明・宸✨"
}