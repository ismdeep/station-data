{
  "Source": "akarin.dev",
  "Title": "使用 PHP 的 Ratchet 框架搭建 WebSocket 服务端",
  "Link": "https://akarin.dev/2020/01/10/php-websocket-server/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cblockquote\u003e\u003cp\u003e封面图：\u003ca href=\"https://www.pixiv.net/artworks/78461776\" target=\"_blank\" rel=\"noopener\"\u003ePixiv ID: 78461776 「お団子」 by tama2396\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e几个月前，小透明尝试过\u003ca href=\"/2019/09/03/use-polling-and-sse/\"\u003e使用短轮询、长轮询、Server-Sent Events 三种不同的方式\u003c/a\u003e实现了一个简单的留言板。\u003c/p\u003e\u003cp\u003e在查找相关资料时，小透明也已经知道了 HTML5 新增的 WebSocket 协议是在客户端、服务端之间实时发送数据的\u003cstrong\u003e最高效的方式\u003c/strong\u003e。遗憾的是由于当时姿势水平还不够，小透明当时并没有对 WebSocket 进行哪怕是再深入一点点的研究，最后还是在某个小项目中选用了短轮询 (っ ̯ -｡)\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1358*403),403px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/3fb846514cf090b9900386120447c4cc/47ck6hqg.png\" data-src-webp=\"https://p.sda1.dev/12/b6e1362daafdc4c97122f128e37bceed/WPfnRWNs.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAJACADASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAIDB//EACQQAAEDAgQHAAAAAAAAAAAAAAEAAgMiMRFxkdEEExQhIzJD/8QAFAEBAAAAAAAAAAAAAAAAAAAAAv/EABsRAAICAwEAAAAAAAAAAAAAAAABAiEREpEx/9oADAMBAAIRAxEAPwDsUfFx8ptMmOA+Ltlv1UFNEt+/hfsjs9BkEpt25prTHkugSnVrgiJrJao2ECxDmuYdCEgwYAkjUqWWOao2RGf/2Q\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/3fb846514cf090b9900386120447c4cc/47ck6hqg.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e虽然没有人在意屏幕上的消息为什么每隔一秒才会刷新一次，每秒数百个的 AJAX 请求也没有对服务器造成严重的压力，但是总觉得还是有点不对劲……\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e大量的网络流量被用于请求头和响应头，而真正有价值的消息主体只占了极小一部分，这简直是对网络资源的极大浪费！(╯‵□′)╯︵┻━┻\u003cbr/\u003e\u003cspan style=\"display:block;text-align:right\"\u003e——沃兹基・硕德\u003c/span\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003eWebSocket 是建立在 TCP 连接上进行全双工通讯的协议，然鹅小透明当时才刚开始学计算机网络，不知道数据帧一般是什么结构、不知道 TCP 协议是什么、不知道什么是套接字、不知道什么是 bind/listen/accept/……然后查资料的时候又看到这种东西，就直接被劝退了：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1305*890),890px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/e3fe6bd957739ff1a6d3b23e7c4dd2b5/z6h1CbTu.png\" data-src-webp=\"https://p.sda1.dev/12/0cb28549679e32aef39cb120b4a43a85/3oK3JFC7.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAWACADASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAMEAQf/xAAlEAABAwIFBAMAAAAAAAAAAAABAAIRAxIEISIx0TJhcoETQUP/xAAUAQEAAAAAAAAAAAAAAAAAAAAA/8QAFBEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEQMRAD8A7cKTBN2Zn6gcp4FADok+SSWtud0nUd0Eahoz9IH20T+Pu4qgMwrTLQQexKQNgtQRurtzBYVhrhhcAySO44QhBVh/lrzaxoA3lx4VBoVRvZHkeEIQf//Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/e3fe6bd957739ff1a6d3b23e7c4dd2b5/z6h1CbTu.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e自己查找资料造一个 WebSocket 服务端的轮子需要涉及到套接字编程、数据帧解析之类的知识。即使是现在学完了计算机网络，完全实现仍然是\u003cstrong\u003e非常困难的\u003c/strong\u003e。\u003c/p\u003e\u003cp\u003e后来在期末复习周摸鱼的时候，小透明找到了 \u003ca href=\"http://socketo.me/\" target=\"_blank\" rel=\"noopener\"\u003eRatchet\u003c/a\u003e 这个可以在 PHP 中搭建 WebSocket 服务端的框架，于是开始尝试了解它的使用方法～\u003c/p\u003e\u003cp\u003e这篇的重点是如何用 PHP 搭建 WebSocket 的服务端，至于客户端就是浏览器运行 JS 代码创建的 \u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eWebSocket\u003c/code\u003e\u003c/a\u003e 对象。所有的主流浏览器（甚至还包括 IE 10！）都支持使用 WebSocket 协议。\u003c/p\u003e\u003ch1 id=\"准备工作\"\u003e\u003ca href=\"#准备工作\" class=\"headerlink\" title=\"准备工作\"\u003e\u003c/a\u003e准备工作\u003c/h1\u003e\u003cp\u003e这次仍然是使用一个十分简单、没有样式的留言板页面进行演示～\u003c/p\u003e\u003cul\u003e\u003cli\u003e发送消息：在文本框 \u003ccode\u003emessage\u003c/code\u003e 中输入内容，点击按钮 \u003ccode\u003esend\u003c/code\u003e 发送。\u003c/li\u003e\u003cli\u003e接收消息：服务端将收到的消息纯文本发送给所有客户端，显示在 \u003ccode\u003etimeline\u003c/code\u003e 中。\u003c/li\u003e\u003c/ul\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/1358*861),861px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/dac35fff960be33bf1941e4e75428861/s_A6kmKE.png\" data-src-webp=\"https://p.sda1.dev/12/05532bf7cf16b7cc61b4097d5b1e347a/z3SQ2K-P.jpg\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAUACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAIBAwQH/8QAKBAAAQQBAQYHAQAAAAAAAAAAAQACAxEEEhMhMkGBkiIxQ1Fh0dJx/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/8QAGREBAQADAQAAAAAAAAAAAAAAAAESUZEh/9oADAMBAAIRAxEAPwDte2xt40M8yOIchaugaMl4MRh0jiZzPypZPnlgvCn6GP8ASnb54usKfoY/0rwu52JymrytZxmn0I+4/SV2KwAkwx9x+lU2fL1aZGlh9nab/vhJTbSSy2wN1qb4Q3LlDQAGpxmSk1TUIQSOyHtfYa26QJnOBJDUIWZ//9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/dac35fff960be33bf1941e4e75428861/s_A6kmKE.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cpre class=\"line-numbers language-markup\" data-language=\"markup\"\u003e\u003ccode class=\"language-markup\"\u003e\u003cspan class=\"token doctype\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;!\u003c/span\u003e\u003cspan class=\"token doctype-tag\"\u003eDOCTYPE\u003c/span\u003e \u003cspan class=\"token name\"\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003echarset\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eUTF-8\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ename\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eviewport\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003econtent\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003ewidth=device-width, initial-scale=1.0\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003emeta\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003ehttp-equiv\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eX-UA-Compatible\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003econtent\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003eie=edge\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ehead\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003einput\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003emessage\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003etype\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003etext\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ebutton\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003esend\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003eSend\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ebutton\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ehr\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003ediv\u003c/span\u003e \u003cspan class=\"token attr-name\"\u003eid\u003c/span\u003e\u003cspan class=\"token attr-value\"\u003e\u003cspan class=\"token punctuation attr-equals\"\u003e=\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003etimeline\u003cspan class=\"token punctuation\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ediv\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\n    \u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token script\"\u003e\u003cspan class=\"token language-javascript\"\u003e\n        \u003cspan class=\"token comment\"\u003e// 设定URL建立WebSocket连接\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e conn \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebSocket\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;ws://localhost:25252/chat\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 成功建立连接\u003c/span\u003e\n        conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonopen\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;Hello!\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 收到消息\u003c/span\u003e\n        conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonmessage\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;timeline\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerText \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003edata\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;timeline\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003einnerHTML \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026lt;br\u0026gt;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 连接出错\u003c/span\u003e\n        conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonerror\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003ealert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;WebSocket connection error.\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 断开连接\u003c/span\u003e\n        conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonclose\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token function\"\u003ealert\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;WebSocket connection closed.\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 发送消息\u003c/span\u003e\n        document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;send\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function function-variable\"\u003eonclick\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003edocument\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            conn\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003edocument\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            document\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetElementById\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;message\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003evalue \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003escript\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ebody\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token tag\"\u003e\u003cspan class=\"token punctuation\"\u003e\u0026lt;/\u003c/span\u003ehtml\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch1 id=\"编写服务端代码\"\u003e\u003ca href=\"#编写服务端代码\" class=\"headerlink\" title=\"编写服务端代码\"\u003e\u003c/a\u003e编写服务端代码\u003c/h1\u003e\u003cp\u003e开始编写服务端之前，需要使用 Composer 安装 Ratchet 框架：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003ecomposer require cboden/ratchet\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e官方网站上提供了一个简单的\u003ca href=\"http://socketo.me/docs/hello-world#logic\" target=\"_blank\" rel=\"noopener\"\u003e例子\u003c/a\u003e可以作为参考。首先对框架进行导入：\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eMessageComponentInterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003euse\u003c/span\u003e \u003cspan class=\"token package\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eConnectionInterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003erequire_once\u003c/span\u003e \u003cspan class=\"token constant\"\u003e__DIR__\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;/vendor/autoload.php\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e整个服务端“应用”可以当成是一个基于 \u003ccode\u003eRatchet\\MessageComponentInterface\u003c/code\u003e 的类，和前端代码类似，只要对建立连接 \u003ccode\u003eonOpen\u003c/code\u003e、收到消息 \u003ccode\u003eonMessage\u003c/code\u003e、连接出错 \u003ccode\u003eonError\u003c/code\u003e、断开连接 \u003ccode\u003eonClose\u003c/code\u003e 这四个事件编写函数即可。\u003c/p\u003e\u003cp\u003e与服务端建立连接的每个客户端都被视为一个对象，这些客户端将保存在 \u003ccode\u003e$clients\u003c/code\u003e 中。通过每个客户端对象的 \u003ccode\u003esend($msg)\u003c/code\u003e 方法可以实现服务端向某一个客户端发送消息，还可以遍历 \u003ccode\u003e$clients\u003c/code\u003e 实现消息广播。\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"token class-name class-name-definition\"\u003eMyChat\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eimplements\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMessageComponentInterface\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 用于保存客户端信息\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eprotected\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$clients\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003e__construct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 新建SplObjectStorage用于保存对象\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eclients\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified\"\u003e\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eSplObjectStorage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// $conn是要与服务端建立连接的客户端对象\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003eonOpen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eConnectionInterface\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 向$clients添加建立连接的客户端\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eclients\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eattach\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 输出提示，resourceId可以用于标识客户端\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;New connection! Id: \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eresourceId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003eonClose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eConnectionInterface\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 将关闭连接的客户端从$clients中删除\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eclients\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003edetach\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;Connection \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eresourceId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e has disconnected\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003eonError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eConnectionInterface\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified type-declaration\"\u003e\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eException\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eclose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token comment\"\u003e// $msg是客户端发送的数据\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003eonMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eConnectionInterface\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$from\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$msg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// 遍历所有客户端，转发消息\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eforeach\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eclients\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$client\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token variable\"\u003e$client\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;Client \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$from\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eresourceId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e: \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$msg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 也可以选择不转发给发送者自己\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// if ($from !== $client) {\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e//     $client-\u0026gt;send(\u0026#34;Client {$from-\u0026gt;resourceId}: {$msg}\u0026#34;);\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// }\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;Client \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$from\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eresourceId\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e: \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$msg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最后新建一个类 \u003ccode\u003eRatchet\\App\u003c/code\u003e，设定端口，将上面的应用实例化并指定地址：\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;Server is running...\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 在本机的25252端口启动Ratchet应用\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$app\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eApp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;localhost\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e25252\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// Ratchet自带的测试应用，原样返回客户端发送的消息\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// ws://localhost:25252/echo\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$app\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eroute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;/echo\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eServer\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eEchoServer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003earray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;*\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 上面的留言板应用\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// ws://localhost:25252/chat\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$app\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eroute\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;/chat\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMyChat\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003earray\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;*\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$app\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003erun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e将以上代码保存为 \u003ccode\u003echat.php\u003c/code\u003e，然后使用命令行 \u003ccode\u003ephp chat.php\u003c/code\u003e 启动服务端程序。打开网页，浏览器就可以和服务端建立 WebSocket 连接，允许在留言板上发送消息，与此同时命令行也会输出建立/中断连接的提示。按下 \u003ckbd\u003eCtrl+C\u003c/kbd\u003e 就可以终止服务端程序的运行。\u003c/p\u003e\u003cvideo controls=\"\" poster=\"https://p.sda1.dev/12/090758dd8fd73fd86ced41f0c774217f/ojQdVtOk.jpg\" preload=\"metadata\"\u003e\u003csource type=\"video/mp4; codecs=av01.0.09M.10\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/3YMPbLxL.mp4\"/\u003e\u003csource type=\"video/mp4; codecs=avc1.640033\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/vhcMLHkL.mp4\"/\u003e\u003c/video\u003e\u003cp\u003e客户端和服务端通过 WebSocket 协议互相发送消息，可以看出所有客户端几乎同时收到了来自服务端的消息，客户端无须像传统的轮询一样频繁发送 AJAX 请求，效率较高。\u003c/p\u003e\u003ch1 id=\"使用-WSS-协议建立加密连接\"\u003e\u003ca href=\"#使用-WSS-协议建立加密连接\" class=\"headerlink\" title=\"使用 WSS 协议建立加密连接\"\u003e\u003c/a\u003e使用 WSS 协议建立加密连接\u003c/h1\u003e\u003cp\u003e就像 HTTP 协议和 HTTPS 协议一样，WebSocket 的 WS 协议也有对应的安全加密传输协议 WSS，而且在使用了 HTTPS 的页面上是无法使用未加密的 WebSocket 连接的。一个简单的解决方法是使用 Nginx 的\u003cstrong\u003e反向代理\u003c/strong\u003e，客户端在公网上发送建立 WebSocket 加密连接的请求，Nginx 在内网将请求转发给相应的 WebSocket 应用。\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003eserver {\n    listen 443 ssl http2;\n    server_name ...;\n    ssl_certificate ...;\n    ssl_certificate_key ...;\n\n    ...\n\n    location = /chat {\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade $http_upgrade;\n        proxy_set_header Connection \u0026#34;upgrade\u0026#34;;\n        proxy_pass http://localhost:25252/chat;\n\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n    }\n}\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e使用了反向代理以后，客户端就可以使用类似于 \u003ccode\u003ewss://***.com/chat\u003c/code\u003e 的 URL 建立加密连接了，不需要添加端口号。\u003c/p\u003e\u003cp\u003e由于使用了反向代理，如果需要获取客户端的 IP 地址，就得将 IP 地址写在自定义请求头（上面的例子使用的是 \u003ccode\u003eX-Real-IP\u003c/code\u003e 和 \u003ccode\u003eX-Forwarded-For\u003c/code\u003e）上。在 Ratchet 应用中也可以获取客户端建立连接时的请求头消息，例如获取 IP 就可以使用 \u003ccode\u003e$conn-\u0026gt;httpRequest-\u0026gt;getHeader(\u0026#39;X-Real-IP\u0026#39;)[0]\u003c/code\u003e。\u003c/p\u003e\u003cp\u003e另外，Ratchet 应用默认只允许来自本机的客户端（localhost）连接，\u003ca href=\"http://socketo.me/docs/troubleshooting\" target=\"_blank\" rel=\"noopener\"\u003e官方网站上的解释\u003c/a\u003e是为了安全性，使用反向代理后也可以跳过这个限制了。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003eQ: I can connect locally but not remotely or when I run on my server.\u003cbr/\u003eA: This is also another security feature! By default Ratchet binds to 127.0.0.1 which only allows connections from itself. The recommended approach is to put Ratchet behind a proxy and only that proxy (locally) will connect.\u003cbr/\u003eIf you want to open Ratchet up (not behind a proxy) set the third parameter of App to ‘0.0.0.0’.\u003c/p\u003e\u003c/blockquote\u003e\u003ch1 id=\"定时执行垃圾回收\"\u003e\u003ca href=\"#定时执行垃圾回收\" class=\"headerlink\" title=\"定时执行垃圾回收\"\u003e\u003c/a\u003e定时执行垃圾回收\u003c/h1\u003e\u003cp\u003eRatchet 使用 \u003ca href=\"https://www.php.net/manual/zh/class.splobjectstorage.php\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eSplObjectStorage\u003c/code\u003e\u003c/a\u003e 保存与服务端建立连接的客户端对象，通过 \u003ccode\u003eattach()\u003c/code\u003e 和 \u003ccode\u003edetach()\u003c/code\u003e 方法添加和删除，但这种方法存在\u003cstrong\u003e内存泄漏\u003c/strong\u003e问题，需要定期执行 \u003ccode\u003egc_collect_cycles()\u003c/code\u003e 进行垃圾回收。\u003c/p\u003e\u003cp\u003eRatchet 允许在创建应用时使用自定义的事件循环，在循环中自行加入定期执行的函数。\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token comment\"\u003e// 新建事件循环\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$loop\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified static-context\"\u003eReact\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eEventLoop\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eFactory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e::\u003c/span\u003e\u003cspan class=\"token function\"\u003ecreate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 每分钟进行一次垃圾回收，并在控制台输出内存占用\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$loop\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eaddPeriodicTimer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e60\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$memory_before\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ememory_get_usage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003egc_collect_cycles\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token variable\"\u003e$memory_now\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ememory_get_usage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$memory_before\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!==\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$memory_now\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;GC Collected: \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$memory_before\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e bytes -\u0026gt; \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$memory_now\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e bytes\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 使用自定义的事件循环创建应用\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$app\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name class-name-fully-qualified\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eApp\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;localhost\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e25252\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;127.0.0.1\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$loop\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch1 id=\"用-AJAX-发送请求，用-WebSocket-推送消息\"\u003e\u003ca href=\"#用-AJAX-发送请求，用-WebSocket-推送消息\" class=\"headerlink\" title=\"用 AJAX 发送请求，用 WebSocket 推送消息\"\u003e\u003c/a\u003e用 AJAX 发送请求，用 WebSocket 推送消息\u003c/h1\u003e\u003cp\u003eWebSocket 本身支持发送/接收纯文本或二进制数据，因此直接发送图片之类的东西也是没关系的～\u003c/p\u003e\u003cp\u003e但是有的时候又要发送文本又要发送二进制数据（比如做留言板的时候，有同时发送文本和图片的需求），这个时候就需要多折腾一下了……\u003c/p\u003e\u003cp\u003e常规的使用 POST 上传文件使用的 \u003ccode\u003emultipart/form-data\u003c/code\u003e 格式，实际发送的数据类似于这样：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003e-----------------------------18467633426500\nContent-Disposition: form-data; name=\u0026#34;smfile\u0026#34;; filename=\u0026#34;untitled.png\u0026#34;\nContent-Type: image/png\n\n（二进制数据）\n-----------------------------18467633426500\nContent-Disposition: form-data; name=\u0026#34;file_id\u0026#34;\n\n0\n-----------------------------18467633426500--\u001a\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e发送的数据被“分割线”分割为多个部分，每个部分可以是文本或二进制数据，互不影响，服务端也很容易从中解析出不同部分的数据。如果造轮子在前端用 WebSocket 发送这种格式的数据，在服务端再自己造轮子进行解析，似乎也不是不可以……那为什么不直接使用 POST 方式发送数据呢？而且还可以继续使用 PHP 的 Session 机制保存用户状态。\u003c/p\u003e\u003cp\u003e原来的结构是客户端\u003cstrong\u003e直接使用 WebSocket 向服务端发送数据\u003c/strong\u003e，现在的结构就变成了客户端先\u003cstrong\u003e使用 POST 向服务端的 \u003ccode\u003epost.php\u003c/code\u003e 发送数据\u003c/strong\u003e，然后 \u003ccode\u003epost.php\u003c/code\u003e 在内网对消息进行处理后再向 WebSocket 应用发送用于推送的消息（这时已经可以使用纯文本了，例如包含了图片 URL 的 JSON 格式数据），客户端与服务端建立的 WebSocket 连接\u003cstrong\u003e只用于接收推送消息\u003c/strong\u003e。\u003c/p\u003e\u003cp\u003e由于客户端与服务端建立 WebSocket 连接必须经过 Nginx 的反向代理并添加上 \u003ccode\u003eX-Real-IP\u003c/code\u003e 之类的请求头，而从内网（例如 \u003ccode\u003epost.php\u003c/code\u003e）建立的连接无须经过反向代理，因此可以通过请求头判断发送给服务端的数据是否来自内网，防止客户端直接控制 WebSocket 应用推送任意消息。\u003c/p\u003e\u003cp\u003e\u003ca href=\"https://github.com/ratchetphp/Pawl\" target=\"_blank\" rel=\"noopener\"\u003ePawl\u003c/a\u003e 是 Ratchet 框架的一个子项目，可以在 PHP 代码中使用 WebSocket 客户端的功能。使用 Pawl 就可以实现“从内网向 WebSocket 应用发送数据”，例如在 \u003ccode\u003epost.php\u003c/code\u003e 中可以写入以下代码（未包括处理图片部分，仅演示处理使用 POST 发送的数据）：\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003erequire_once\u003c/span\u003e \u003cspan class=\"token constant\"\u003e__DIR__\u003c/span\u003e \u003cspan class=\"token operator\"\u003e.\u003c/span\u003e \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;/vendor/autoload.php\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token function\"\u003esession_start\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 发送的内容不能为空\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eempty\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;content\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003edie\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 根据Session为新用户指定随机的ID\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eempty\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$_SESSION\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;userid\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$_SESSION\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;userid\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ebin2hex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003erandom_bytes\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 要发送给服务端的数据\u003c/span\u003e\n\u003cspan class=\"token variable\"\u003e$send\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;userid\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$_SESSION\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;userid\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;content\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$_POST\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;content\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;timestamp\u0026#39;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token function\"\u003etime\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e// 向本机的 WebSocket 推送应用发送数据，这个写法有点类似于JS的Promise\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 两个函数分别是与服务端连接成功或失败后执行的函数\u003c/span\u003e\n\u003cspan class=\"token function\"\u003eRatchet\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003eClient\u003cspan class=\"token punctuation\"\u003e\\\u003c/span\u003econnect\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;ws://localhost:25252/push_server\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$send\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token function\"\u003ejson_encode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$send\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token constant\"\u003eJSON_UNESCAPED_UNICODE\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$conn\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003eclose\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003eecho\u003c/span\u003e \u003cspan class=\"token string double-quoted-string\"\u003e\u0026#34;Could not connect: \u003cspan class=\"token interpolation\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$e\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003egetMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\\n\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token function\"\u003ehttp_response_code\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e503\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e对应的 WebSocket 服务端代码：\u003c/p\u003e\u003cpre class=\"language-php line-numbers\" data-language=\"php\"\u003e\u003ccode class=\"language-php\"\u003e\u003cspan class=\"token keyword\"\u003epublic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token function function-definition\"\u003eonMessage\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token class-name type-declaration\"\u003eConnectionInterface\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$from\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$msg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 只接收未经过反向代理的，来自内网的客户端发送的数据\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eempty\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$from\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003ehttpRequest\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003egetHeader\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string single-quoted-string\"\u003e\u0026#39;X-Real-IP\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003eforeach\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$this\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token property\"\u003eclients\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eas\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$client\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token variable\"\u003e$client\u003c/span\u003e\u003cspan class=\"token operator\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"token function\"\u003esend\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token variable\"\u003e$msg\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e最终的效果演示：\u003c/p\u003e\u003cvideo controls=\"\" poster=\"https://p.sda1.dev/12/808154eab59c3d71be08dca8943dc126/lJvMceUJ.jpg\" preload=\"metadata\"\u003e\u003csource type=\"video/mp4; codecs=av01.0.09M.10\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/yMyk0S81.mp4\"/\u003e\u003csource type=\"video/mp4; codecs=avc1.640033\" src=\"https://cc-im-kefu-cos.7moor-fs1.com/im/4d2c3f00-7d4c-11e5-af15-41bf63ae4ea0/66wnEwoa.mp4\"/\u003e\u003c/video\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2020/01/10/php-websocket-server/\"\u003ehttps://akarin.dev/2020/01/10/php-websocket-server/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2020-01-10T14:27:32Z",
  "Author": "✨小透明・宸✨"
}