{
  "Source": "akarin.dev",
  "Title": "使用 C 语言和 Emscripten 编写自己的 WebAssembly 模块",
  "Link": "https://akarin.dev/2020/10/10/build-webassembly-module-with-c/",
  "Content": "\u003carticle class=\"mdui-p-a-3 mdui-card-content mdui-typo\"\u003e\u003cp\u003e和 JavaScript 一样，WebAssembly 也是一种可以在浏览器中运行的编程语言，不过它的性质更相当于汇编语言。wasm 文件由二进制的\u003ca href=\"https://pengowray.github.io/wasm-ops/\" target=\"_blank\" rel=\"noopener\"\u003e字节码\u003c/a\u003e组成（也可以转换为类似于汇编语言的文本格式查看），可以\u003cstrong\u003e从 C/C++、Rust 等编译执行的编程语言生成\u003c/strong\u003e。当然，WebAssembly 也是跨平台的，编译出来的 wasm 文件在不同平台的浏览器中都可以运行。\u003c/p\u003e\u003cp\u003eWebAssembly 最大的特性就是和解释执行的 JS 相比的\u003cstrong\u003e超高性能\u003c/strong\u003e，甚至还可以将用其它语言编写的项目通过编译到 wasm 的方式\u003cstrong\u003e移植到浏览器中运行\u003c/strong\u003e（例如\u003ca href=\"http://www.dnbwg.com/emularity.html?machine=touhou-fumaroku\" target=\"_blank\" rel=\"noopener\"\u003e这个\u003c/a\u003e使用 wasm 版的 DOSBox 运行的《东方封魔录》，运行起来也十分流畅）。不过我开这篇并不是为了去编译那些大型项目的……由于几乎每个接受过计算机相关教育的人都学习过 C 语言，自己用 C 写一个简单的 wasm 模块来提升前端代码的性能，是门槛并不高而且也很有意思的一件事情。\u003c/p\u003e\u003ch1 id=\"从运行一个简单的模块开始\"\u003e\u003ca href=\"#从运行一个简单的模块开始\" class=\"headerlink\" title=\"从运行一个简单的模块开始\"\u003e\u003c/a\u003e从运行一个简单的模块开始\u003c/h1\u003e\u003cp\u003e要将 C/C++ 代码编译到 wasm 模块，我们需要准备好 \u003ca href=\"https://emscripten.org/docs/getting_started/downloads.html\" target=\"_blank\" rel=\"noopener\"\u003eEmscripten\u003c/a\u003e 环境。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e即使是 Windows 用户，也可以在 WSL 里面直接安装。\u003c/p\u003e\u003c/blockquote\u003e\u003cpre class=\"line-numbers language-bash\" data-language=\"bash\"\u003e\u003ccode class=\"language-bash\"\u003e\u003cspan class=\"token function\"\u003egit\u003c/span\u003e clone https://github.com/emscripten-core/emsdk.git\n\u003cspan class=\"token class-name builtin\"\u003ecd\u003c/span\u003e emsdk\n\u003cspan class=\"token function\"\u003egit\u003c/span\u003e pull\n./emsdk \u003cspan class=\"token function\"\u003einstall\u003c/span\u003e latest\n./emsdk activate latest\n\u003cspan class=\"token comment\"\u003e# 以后每次打开shell都要执行下面这行\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e# 如果不想每次都手动操作的话可以写到.bashrc里面\u003c/span\u003e\n\u003cspan class=\"token class-name builtin\"\u003esource\u003c/span\u003e ./emsdk_env.sh\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWebAssembly 的运行环境本身只能执行计算任务，加载 wasm 模块时还需要导入一个包含 JS 函数、内存区等属性的对象，wasm 和浏览器的交互只能通过调用这些 JS 函数完成，内存区则是和运行环境外面的 JS 代码共享，可以用来交换数据。Emscripten 的功能不仅是编译 C/C++ 代码生成 wasm，它还可以生成一大堆 JS 的“胶水代码”用来连接浏览器和 WebAssembly 运行环境，实现 C/C++ 的那些标准库，对内存分配、输入输出等进行处理。\u003c/p\u003e\u003cp\u003e\u003ca href=\"https://developer.mozilla.org/zh-CN/docs/WebAssembly/C_to_wasm#%E7%94%9F%E6%88%90_HTML_%E5%92%8C_JavaScript\" target=\"_blank\" rel=\"noopener\"\u003eMDN 上的教程\u003c/a\u003e就给出了一个从 Hello world 编译出 wasm 文件和对应的胶水代码、HTML 文件的例子。不过这胶水代码比 wasm 文件本身还大了不少……如果模块比较简单的话还是不太好的。好在 Emscripten 支持通过编译选项 \u003ccode\u003e-s SIDE_MODULE=1\u003c/code\u003e 使编译出来的 wasm 文件\u003ca href=\"https://github.com/emscripten-core/emscripten/wiki/WebAssembly-Standalone#create-a-dynamic-library\" target=\"_blank\" rel=\"noopener\"\u003e作为一个单独的动态库\u003c/a\u003e，这样就不需要那一堆胶水代码了，不过与 JS 部分的交互也需要自己完成。各种用到的标准库函数，需要自己在 C/C++ 里实现（\u003ccode\u003ememset\u003c/code\u003e、\u003ccode\u003ememcpy\u003c/code\u003e 和 \u003ccode\u003estrlen\u003c/code\u003e 之类的比较简单的可以直接抄 \u003ca href=\"https://github.com/emscripten-core/emscripten/tree/main/system/lib/libc\" target=\"_blank\" rel=\"noopener\"\u003eEmscripten 的实现\u003c/a\u003e），或者在 JS 里通过操作内存区实现后导入 wasm 模块。\u003c/p\u003e\u003cp\u003e根据 \u003ca href=\"https://github.com/emscripten-core/emscripten/blob/aa66f92b790c8d319d1599d44657a6305bf74a8a/src/settings.js#L953\" target=\"_blank\" rel=\"noopener\"\u003eEmscripten 的说明\u003c/a\u003e，\u003ccode\u003eSIDE_MODULE\u003c/code\u003e 可以设为 1 和 2，区别在于前者会导出 C/C++ 代码里所有的函数，后者会把没有用到的代码删减掉，这时就需要自己 \u003ccode\u003e#include \u0026lt;emscripten/emscripten.h\u0026gt;\u003c/code\u003e 然后手动在需要导出的函数前面加上 \u003ccode\u003eEMSCRIPTEN_KEEPALIVE\u003c/code\u003e。\u003c/p\u003e\u003cp\u003e从一个简单的计算两数相乘的模块开始。因为这只是一个函数库，所以 main 函数是不需要的，而且就算写了也不会在加载的时候自动执行。\u003c/p\u003e\u003cpre class=\"line-numbers language-c\" data-language=\"c\"\u003e\u003ccode class=\"language-c\"\u003eEMSCRIPTEN_KEEPALIVE\n\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e \u003cspan class=\"token function\"\u003emultiply\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e a\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e b\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e a \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e b\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e编译，\u003ccode\u003e-O3\u003c/code\u003e 代表使用最高速度的编译优化：\u003c/p\u003e\u003cpre class=\"line-numbers language-bash\" data-language=\"bash\"\u003e\u003ccode class=\"language-bash\"\u003eemcc multiply.c \u003cspan class=\"token variable parameter\"\u003e-O3\u003c/span\u003e \u003cspan class=\"token variable parameter\"\u003e-s\u003c/span\u003e \u003cspan class=\"token variable assign-left\"\u003eSIDE_MODULE\u003c/span\u003e\u003cspan class=\"token operator\"\u003e=\u003c/span\u003e\u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token variable parameter\"\u003e-o\u003c/span\u003e multiply.wasm\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e也可以使用 \u003ccode\u003e-Oz\u003c/code\u003e 表示使编译出来的文件大小更小的编译优化，当然运行起来就会慢很多。\u003c/p\u003e\u003cp\u003e在 HTML 中使用以下的 JS 代码加载（目前 \u003ccode\u003eimportObject\u003c/code\u003e 还可以省略不写）：\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmModule \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;multiply.wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003earrayBuffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e WebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emodule\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodule\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e importObject\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e使用 \u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/instantiateStreaming\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eWebAssembly.instantiateStreaming\u003c/code\u003e\u003c/a\u003e 加载更简洁，但是需要提供正确的 MIME 类型 \u003ccode\u003eapplication/wasm\u003c/code\u003e。\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmModule \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e WebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003einstantiateStreaming\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;multiply.wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    importObject\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e另外，上面的两种写法都是异步加载模块的，这是因为如果是同步加载大型模块的话会出现较长时间的阻塞（Chrome 甚至自己规定了同步加载的模块不能超过 4 KB）。如果模块较小，加载时间可以忽略不计，而且也需要在同步执行的代码中使用模块的话，可以将模块的二进制数据以 \u003ccode\u003eUint8Array\u003c/code\u003e 的格式（不过更建议从 Base64 字符串转换过来，代码更简短）写进 JS 代码，然后用下面的写法加载：\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e// 以后创建wasmModule时可以复用m，不需要重新加载\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e m \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eModule\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmModule \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003em\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e importObject\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e加载完成后，就可以通过 \u003ccode\u003ewasmModule.exports\u003c/code\u003e 找到模块导出的函数了。WebAssembly 也是强类型的（32/64 位整数/浮点数），所以在这个例子中如果使用了小数会自动进行类型转换，并不能得到正确的结果，另外也需要注意溢出的问题。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/542*494),494px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png\" data-src-webp=\"https://p.sda1.dev/12/9b5bf6e63f452a429a4ca1d247d8d9bb/1mHZIpqJ.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAdACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACAwUH/8QAKhAAAgEDAgQEBwAAAAAAAAAAAQIRAAMhEkEEEzFhFSMkwUJRcoGSodH/xAAXAQADAQAAAAAAAAAAAAAAAAAAAQID/8QAGREBAQEAAwAAAAAAAAAAAAAAAREAAhIx/9oADAMBAAIRAxEAPwD3TixYAARQpk5INZW7TsuhQsz8jAre/eQkw6ySfiA2ih6cZ0ZwcjatDqFWOhpyGZXh/EkZNr7E0rh+Hv2CSVtGe5HtQktK+VEmZhYPvTQqdeWAevSpUvuZVsmMtx1cw5AM50E71rzXAPmn8DRLl1rVwFGYEg5GnYntXQVGZQec+RO38qVHO3US80ibrETEaIq9Tkvn1FzP04/VQCABJPejG//Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/303c73def7aac416cee55273e75b302e/cc5lAleQ.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e以下是对应的“汇编代码”，\u003ccode\u003e$multiply\u003c/code\u003e 就是上面的相乘函数了：\u003c/p\u003e\u003cpre class=\"line-numbers language-wasm\" data-language=\"wasm\"\u003e\u003ccode class=\"language-wasm\"\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emodule\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eparam\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eresult\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003enop\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$multiply\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eparam\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$p0\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eparam\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$p1\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eresult\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e.get \u003cspan class=\"token variable\"\u003e$p0\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e.get \u003cspan class=\"token variable\"\u003e$p1\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ei32\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003emul\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__dso_handle\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ei32\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econst\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__wasm_apply_relocs\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;multiply\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$multiply\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__dso_handle\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__post_instantiate\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\u003cp\u003e使用 VSCode 的扩展 \u003ca href=\"https://marketplace.visualstudio.com/items?itemName=dtsvet.vscode-wasm\" target=\"_blank\" rel=\"noopener\"\u003eWebAssembly\u003c/a\u003e 可以以文本格式显示打开的 wasm 文件，并且可以在两种格式之间相互转换。\u003c/p\u003e\u003c/blockquote\u003e\u003ch1 id=\"使用外部函数、内存和指针\"\u003e\u003ca href=\"#使用外部函数、内存和指针\" class=\"headerlink\" title=\"使用外部函数、内存和指针\"\u003e\u003c/a\u003e使用外部函数、内存和指针\u003c/h1\u003e\u003cp\u003e接下来是做一件每种编程语言的初学者都喜欢做的事：输出一个 Hello world。\u003c/p\u003e\u003cpre class=\"line-numbers language-c\" data-language=\"c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token property macro\"\u003e\u003cspan class=\"token directive-hash\"\u003e#\u003c/span\u003e\u003cspan class=\"token keyword directive\"\u003einclude\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026lt;stdio.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003ehello_world\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eputs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#34;Hello world!\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token function\"\u003eputs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#34;WebAssembly模块测试\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e编译……等下，既然是编译到 WebAssembly 了，那从哪里找到标准库 \u003ccode\u003estdio.h\u003c/code\u003e 和这个 \u003ccode\u003eputs\u003c/code\u003e 呢？看一下文本格式代码：\u003c/p\u003e\u003cpre class=\"line-numbers language-wasm\" data-language=\"wasm\"\u003e\u003ccode class=\"language-wasm\"\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003emodule\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eparam\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eresult\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;env\u0026#34;\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;puts\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$env.puts\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;env\u0026#34;\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__memory_base\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$env.__memory_base\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;env\u0026#34;\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;memory\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ememory\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$env.\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ememory\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003enop\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$hello_world\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$t0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$l0\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e.get \u003cspan class=\"token variable\"\u003e$env.__memory_base\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e.tee \u003cspan class=\"token variable\"\u003e$l0\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ecall\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$env.puts\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edrop\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elocal\u003c/span\u003e.get \u003cspan class=\"token variable\"\u003e$l0\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ei32\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econst\u003c/span\u003e \u003cspan class=\"token number\"\u003e13\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ei32\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eadd\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ecall\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$env.puts\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003edrop\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__dso_handle\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ei32\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003ei32\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003econst\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__wasm_apply_relocs\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;hello_world\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$hello_world\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__dso_handle\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eexport\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;__post_instantiate\u0026#34;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$__wasm_apply_relocs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003edata\u003c/span\u003e \u003cspan class=\"token variable\"\u003e$d0\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eglobal\u003c/span\u003e.get \u003cspan class=\"token variable\"\u003e$env.__memory_base\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#34;Hello world!\\00WebAssembly\\e6\\a8\\a1\\e5\\9d\\97\\e6\\b5\\8b\\e8\\af\\95\\00\u0026#34;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ccode\u003eputs\u003c/code\u003e 是需要自己从 JS 中导入的。在 C 的代码里实际上也可以不写 \u003ccode\u003e#include \u0026lt;stdio.h\u0026gt;\u003c/code\u003e，直接用 \u003ccode\u003eint puts(const char *str);\u003c/code\u003e 声明也是没问题的。\u003c/p\u003e\u003cp\u003e字符串被全部写进了一个数据段（汉字部分和源代码一样使用了 UTF-8 编码）。在加载 wasm 模块的时候需要提供一块内存区域用来从某个偏移位置开始保存这些数据。\u003c/p\u003e\u003cp\u003e这里就先使用 \u003ccode\u003econsole.log\u003c/code\u003e 代替 \u003ccode\u003eputs\u003c/code\u003e，并且创建一个 \u003ca href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/WebAssembly/Memory\" target=\"_blank\" rel=\"noopener\"\u003e\u003ccode\u003eWebAssembly.Memory\u003c/code\u003e\u003c/a\u003e 作为内存区域，通过一个对象（也就是上面的 \u003ccode\u003eimportObject\u003c/code\u003e）传递给要加载的 wasm 模块：\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmMemory \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMemory\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token property literal-property\"\u003einitial\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmBuffer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmModule \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;hello-world.wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003earrayBuffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e WebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emodule\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodule\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003eenv\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003eputs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elog\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003ememory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e wasmMemory\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003e__memory_base\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cblockquote\u003e\u003cp\u003e\u003ccode\u003eWebAssembly.Memory\u003c/code\u003e 是一块用于 wasm 模块的内存，以 64 KB 为一“页”作为分配的基本单位，也可以在创建后动态扩容。在 JS 中可以通过 \u003ccode\u003eTypedArray\u003c/code\u003e 对它进行读写。\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003e加载并执行一下试试看：\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/723*329),329px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png\" data-src-webp=\"https://p.sda1.dev/12/90e9e500482c6a0a2c773c749398e991/aWl1K20Z.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAPACADASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAwQAAQf/xAAgEAACAQIHAQAAAAAAAAAAAAABAgADEQQSEyExUdFS/8QAFgEBAQEAAAAAAAAAAAAAAAAAAgAB/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQAREiH/2gAMAwEAAhEDEQA/ANzrqlVwKQ62uINsPVYrdIcLTZiMxvboeQmiu3gj7QMs91ZelhipBfjoExwAAWAlaafAkCKOFEFF/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/56d66ddea394f573c6fd8e45b062059c/er1Cjn15.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e字符串被写入了内存中从 \u003ccode\u003e__memory_base\u003c/code\u003e 开始的位置，而和 C 语言一样，调用 \u003ccode\u003eputs\u003c/code\u003e（实际上是 \u003ccode\u003econsole.log\u003c/code\u003e）的参数是字符串开始的指针（数组下标）。如果自己实现一个 \u003ccode\u003eputs\u003c/code\u003e，就可以将字符串输出到控制台（或者是页面上某个 DOM 的 innerText）了。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e顺便一提，有个叫 \u003ca href=\"https://github.com/locutusjs/locutus\" target=\"_blank\" rel=\"noopener\"\u003eLocutus\u003c/a\u003e 的库尝试使用 JS 实现其他语言的标准库，虽然对于 C 的实现并不多……\u003c/p\u003e\u003cp\u003e比如要实现 \u003ccode\u003esprintf\u003c/code\u003e 或 \u003ccode\u003eprintf\u003c/code\u003e，就可以参考\u003ca href=\"https://github.com/locutusjs/locutus/blob/master/src/c/stdio/sprintf.js\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\u003c/blockquote\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmMemory \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMemory\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token property literal-property\"\u003einitial\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmBuffer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmModule \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;hello-world.wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003earrayBuffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e WebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emodule\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodule\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003eenv\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token comment\"\u003e// 将从指针开始到下一个0x00之间的数据用UTF-8解码，然后用console.log输出\u003c/span\u003e\n            \u003cspan class=\"token function function-variable\"\u003eputs\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token parameter\"\u003eptr\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e console\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eTextDecoder\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003edecode\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                    wasmBuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eslice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n                        ptr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                        wasmBuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efindIndex\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ee\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e i\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026gt;=\u003c/span\u003e ptr \u003cspan class=\"token operator\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003ememory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e wasmMemory\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003e__memory_base\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/705*749),749px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png\" data-src-webp=\"https://p.sda1.dev/12/a6c97377e4802b4665204cab5c1cf9c3/SLwsimdL.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB4DASIAAhEBAxEB/8QAGQAAAwADAAAAAAAAAAAAAAAAAAMEAgUH/8QAJRAAAgIBAgUFAQAAAAAAAAAAAQIAEQMEIRIxMlGhE0FCYXGR/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQAC/8QAGBEBAQEBAQAAAAAAAAAAAAAAAQACMVH/2gAMAwEAAhEDEQA/AO863TEANjX9HapBk6huv9m1JoExV4MuRTTBvpRXkTedJR1fSRpsJBDFQy+1HaWQCEfM+IcJvrPiYgomfL6u1tXLhBJlCjJsS5qTWQ5ARWrshJlaBqHKu3DUVmzhCEKv/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/d7b12345e092a1e4908e074d5eb065b4/7KUNX1IK.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e试着将内存中的第一个单元的数据改成 \u003ccode\u003e0x41\u003c/code\u003e（也就是字母 A），再次调用函数，可以看到输出的内容也发生了相应的变化。当然，实际使用的时候，如果需要向内存中写入数据，就要根据 \u003ccode\u003e__memory_base\u003c/code\u003e 和代码中数据段的大小自己预留好内存空间，避免覆盖了 wasm 模块内部使用的数据。\u003c/p\u003e\u003cp\u003e如果代码中需要用到局部变量，根据常识可以知道这些变量是存储在栈里的，编译出的 wasm 也会要求引入 \u003ccode\u003e__stack_pointer\u003c/code\u003e 用来设置栈指针：\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property literal-property\"\u003eenv\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003e__stack_pointer\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eGlobal\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"token property literal-property\"\u003emutable\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"token property literal-property\"\u003evalue\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;i32\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token number\"\u003e0x1000\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e和真实的 CPU 一样，栈指针也是向低地址延伸的，于是我们就得到了这样的一个简单的进程地址空间模型：\u003ccode\u003e| 只读数据 | \u0026lt;- 栈 | 堆 -\u0026gt; |\u003c/code\u003e，这已经开始有点涉及到操作系统的知识了……\u003c/p\u003e\u003cp\u003e既然提到堆了，能不能用 \u003ccode\u003emalloc\u003c/code\u003e 和 \u003ccode\u003efree\u003c/code\u003e 在堆上动态分配内存呢？然而，即使不考虑性能，一个完整的内存分配器非常复杂，在这种编译为 \u003ccode\u003eSIDE_MODULE\u003c/code\u003e 的简单模块的情况下是无法使用的，这里不再深入介绍。\u003ca href=\"https://surma.dev/things/c-to-webassembly/\" target=\"_blank\" rel=\"noopener\"\u003e这篇文章\u003c/a\u003e的“Building an allocator”部分提出了一种简单的替代方法：分配的内存地址只是从堆的起始地址开始不断累加已分配的内存大小，至于 \u003ccode\u003efree\u003c/code\u003e？直接空着。\u003c/p\u003e\u003ch1 id=\"一个使用-WebAssembly-将性能提高到-30x-的例子\"\u003e\u003ca href=\"#一个使用-WebAssembly-将性能提高到-30x-的例子\" class=\"headerlink\" title=\"一个使用 WebAssembly 将性能提高到 30x 的例子\"\u003e\u003c/a\u003e一个使用 WebAssembly 将性能提高到 30x 的例子\u003c/h1\u003e\u003cp\u003e接下来就用一个实际的例子，来展示 WebAssembly 和 JS 相比在计算密集型任务上的超高性能。我分别用 WebAssembly 和 JS 试着实现了一遍 \u003ca href=\"https://zh.wikipedia.org/wiki/RC4\" target=\"_blank\" rel=\"noopener\"\u003eRC4 加解密算法\u003c/a\u003e。为什么用了 RC4 作为例子？\u003c/p\u003e\u003cul\u003e\u003cli\u003e加密和解密涉及到大量的计算操作\u003c/li\u003e\u003cli\u003eRC4 的算法简短，且加密和解密是同一套算法，易于实现\u003c/li\u003e\u003cli\u003eRC4 是流密码，对明文和密钥的长度\u003cabbr title=\"明文长度不限，密钥长度 40-2048 位\"\u003e要求不多\u003c/abbr\u003e，也不需要像分组密码一样处理不同的工作模式，易于使用\u003c/li\u003e\u003cli\u003e有一定的实用性（虽然现在 RC4 的安全性已经比较有限了……）\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e以下是来自 Wikipedia 的伪代码：\u003c/p\u003e\u003cpre class=\"line-numbers language-none\"\u003e\u003ccode class=\"language-none\"\u003efor i from 0 to 255\n    S[i] := i\nendfor\nj := 0\nfor( i=0 ; i\u0026lt;256 ; i++)\n    j := (j + S[i] + key[i mod keylength]) % 256\n    swap values of S[i] and S[j]\nendfor\ni := 0\nj := 0\nwhile GeneratingOutput:\n    i := (i + 1) mod 256\n    j := (j + S[i]) mod 256\n    swap values of S[i] and S[j]\n    k := inputByte ^ S[(S[i] + S[j]) % 256]\n    output K\nendwhile\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e照着伪代码，用 JS 实现一遍（经检验，实现完全正确，检验过程略）：\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003e使用 JS 的实现\u003c/summary\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token comment\"\u003e/**\n * @param {Uint8Array} key\n * @param {Uint8Array} input\n * @returns {Uint8Array}\n */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function function-variable\"\u003ejsRc4\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ekey\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e input\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e keyLength \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e inputLength \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e sbox \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ej \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e%\u003c/span\u003e keyLength\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e output \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einputLength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e k \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e k \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e inputLength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ej \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        output\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e output\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/details\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e然后移植到 C 语言 \u003cdel\u003e一看就是一个模子刻出来的\u003c/del\u003e：\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003e使用 C 语言的实现，以及相关的 JS 胶水代码\u003c/summary\u003e\u003cpre class=\"line-numbers language-c\" data-language=\"c\"\u003e\u003ccode class=\"language-c\"\u003e\u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"token function\"\u003erc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003einput\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e keyLength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e inputLength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eshort\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003echar\u003c/span\u003e temp\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// j = (j + sbox[i] + key[i % keyLength]) \u0026amp; 0xFF;\u003c/span\u003e\n        j \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e%\u003c/span\u003e keyLength\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        temp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e temp\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eint\u003c/span\u003e k \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e k \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e inputLength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token operator\"\u003e++\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token comment\"\u003e// j = (j + sbox[i]) \u0026amp; 0xFF;\u003c/span\u003e\n        j \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        temp \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e temp\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        input\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ek\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e^=\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ei\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e sbox\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"token number\"\u003e0xFF\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmMemory \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eMemory\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token property literal-property\"\u003einitial\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmInstance \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eawait\u003c/span\u003e \u003cspan class=\"token function\"\u003efetch\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;rc4.wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eresponse\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e response\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003earrayBuffer\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ebuffer\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e WebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ecompile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ethen\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003emodule\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eInstance\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003emodule\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003eenv\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003ememory\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e wasmMemory\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"token property literal-property\"\u003e__memory_base\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token comment\"\u003e/**\n * @param {Uint8Array} key\n * @param {Uint8Array} input\n * @returns {Uint8Array}\n */\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e \u003cspan class=\"token function function-variable\"\u003ewasmRc4\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003ekey\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e input\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 内存的分布：前256字节保留给S盒，然后是x字节的密钥和x字节的输入\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// 如果内存不足则进行扩容\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e sboxOffset \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e memoryRequired \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e sboxOffset\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ememoryRequired \u003cspan class=\"token operator\"\u003e\u0026gt;\u003c/span\u003e wasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebyteLength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        wasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egrow\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eMath\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eceil\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ememoryRequired \u003cspan class=\"token operator\"\u003e-\u003c/span\u003e wasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebyteLength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e \u003cspan class=\"token number\"\u003e65536\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmBuffer \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewasmMemory\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ebuffer\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    wasmBuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sboxOffset\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    wasmBuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eset\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einput\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sboxOffset \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    wasmInstance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eexports\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esboxOffset\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sboxOffset \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewasmBuffer\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eslice\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003esboxOffset \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e sboxOffset \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e key\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e+\u003c/span\u003e input\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/details\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e测试则是使用 \u003cdel\u003e1KB 的随机密钥\u003c/del\u003e，分别使用两种实现来加密 4KB、8KB……128MB 的同一份随机数据，并比较执行时间。\u003c/p\u003e\u003cp\u003e\u003cem\u003e测完才意识到其实并不需要这么长的密钥……\u003cstrong\u003e超过前 256 字节的部分是没有意义的\u003c/strong\u003e，不过这也不会影响测试结果，所以就不重新测啦！\u003c/em\u003e\u003c/p\u003e\u003cp\u003e\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003e测试代码\u003c/summary\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e results \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e inputLength \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e2048\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"token number\"\u003e16\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e i\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    inputLength \u003cspan class=\"token operator\"\u003e\u0026lt;\u0026lt;=\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e rc4Key \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token number\"\u003e1024\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e Math\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e rc4Input \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003einputLength\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emap\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e Math\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003erandom\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e*\u003c/span\u003e \u003cspan class=\"token number\"\u003e256\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emark\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;wasm-start\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e wasmEncrypted \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ewasmRc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erc4Key\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rc4Input\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emark\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;wasm-end\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emark\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;js-start\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e jsEncrypted \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003ejsRc4\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003erc4Key\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e rc4Input\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emark\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;js-end\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emeasure\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;wasm-start\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;wasm-end\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003emeasure\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;js\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;js-start\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;js-end\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003elet\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e j \u003cspan class=\"token operator\"\u003e\u0026lt;\u003c/span\u003e inputLength\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e j\u003cspan class=\"token operator\"\u003e++\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ewasmEncrypted\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e!==\u003c/span\u003e jsEncrypted\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ej\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"token string\"\u003e\u0026#39;Not equal\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    results\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003elength\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e inputLength\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003ewasmTime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetEntriesByName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;wasm\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eduration\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003ejsTime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003egetEntriesByName\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e\u0026#39;js\u0026#39;\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eduration\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eclearMarks\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    performance\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eclearMeasures\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\nresults\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003epush\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresults\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ereduce\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eacc\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cur\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e key \u003cspan class=\"token keyword\"\u003ein\u003c/span\u003e acc\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e acc\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e cur\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003ekey\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e acc\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003elength\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003ewasmTime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"token property literal-property\"\u003ejsTime\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nresults\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eforEach\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003er\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewasmSpeed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewasmTime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejsSpeed \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003elength \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejsTime\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003eratio \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ewasmSpeed \u003cspan class=\"token operator\"\u003e/\u003c/span\u003e r\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ejsSpeed\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\nconsole\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003etable\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresults\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/details\u003e\u003cp\u003e\u003c/p\u003e\u003cp\u003e至于测试结果嘛……首先是在我自己日常用的 Firefox 上测试，性能直接提升了 8x！（最后一行是以上测试结果的总和）\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/533*558),558px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png\" data-src-webp=\"https://p.sda1.dev/12/e5dbc87fb856c56b1c716361c44dd66b/qVU1IkB2.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAgAB8DASIAAhEBAxEB/8QAGgAAAgIDAAAAAAAAAAAAAAAABAUAAgEDB//EACsQAAEDAgUCBAcAAAAAAAAAAAECAxEAEgQTITFBBSIUMkJhIyQzNHGSsf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwDtYCouQw4YVbPZvPuqtriXwlVzLkASR2bftWcGSA8nSM5JgJIG9G4qLMTt9IcTyaBYAlLQcOGcsOg1T+OFVZvKccsDCxzJI2ieDUdyh0tsCyQuSLP6BVsAYxRjawAwgjYaa0FMG4M51IWIK0SMyfVAo7GqhT6ZH25MXRsaVJUtLqj3nXTsToQoGmWPK88hIVqwoaAGgVg/JuGQe5Mw77HmmPTIz3NR5B67qASHPCuD4hJWmO1M80f04lLrshXlESAKD//Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/d5774021459982bf29a49a602a368de7/t23nhwV1.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e然后是 Chrome 上的测试结果。即使是面对使用了性能最强的 V8 引擎的 Chrome，WebAssembly 的性能优势仍然能达到 2x（虽然速度和 Firefox 那边差不多……）\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/727*540),540px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png\" data-src-webp=\"https://p.sda1.dev/12/34ac61597849188263eeccc1b9cfbdbf/K5mwAgo4.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAYACADASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAMBBAcG/8QAJRAAAQQBAwMFAQAAAAAAAAAAAQACAxIEByExBRRBERMjUXPR/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/xAAWEQEBAQAAAAAAAAAAAAAAAAAAEQH/2gAMAwEAAhEDEQA/AOifprhvjs7Nl5IAJaqk2lnRzEDJlz38VoVqUkg7Y7cSlVrih2SjL2aS9IkdE1mbk782qFI0j6X6gd5Pu+i1bHf8kH2ZE6BwOQAePdKt0V3FlHt8X/qUKFhQhQOgLLw/onwlvdD9ChCD/9k\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/ad17468aa7c43566663ea46ea18436c1/ZnKKKLOz.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e至于标题上的 30x……是在已经弃坑的旧版 Edge 里面测出来的，不过不论是 WebAssembly 还是 JS 这执行速度都比另外两个差了一大截。\u003c/p\u003e\u003cfigure class=\"akarin-blurred-container\"\u003e\u003cdiv style=\"padding-bottom:min(calc(100%/648*498),498px,480px)\"\u003e\u003c/div\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded\" data-src=\"https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png\" data-src-webp=\"https://p.sda1.dev/12/e5194235540816202b54cce3a19b03d2/X5Yl15XJ.webp\"/\u003e \u003cimg class=\"mdui-hoverable mdui-img-rounded akarin-blurred\" src=\"data:image/jpeg;base64,/9j/2wBDAAgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/2wBDAQgICAgJCAkKCgkNDgwODRMREBARExwUFhQWFBwrGx8bGx8bKyYuJSMlLiZENS8vNUROQj5CTl9VVV93cXecnNH/wAARCAAZACADASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAABAACBQMH/8QAJBAAAgEDBAICAwAAAAAAAAAAAQIDAAQREiExQRMyQrEFUXH/xAAWAQEBAQAAAAAAAAAAAAAAAAABAAL/xAAZEQEBAQADAAAAAAAAAAAAAAABAgASMVH/2gAMAwEAAhEDEQA/APW4Px1nYxvJDaImvYhTksVPeRSnkjeDLxtzjR1tUlV3ttK+wlbsCjNDOIVGNyx4w2eP1WqqqrlVK+rszMzPGZA8DKWO2cxhLSM6h8mYb1aG1t5JEUWcQ1E76m6qlksizQeQEYJ5pFnlbiEtxl/qhV7ckh0BhSM/ilAHDk1ySWVIQykhgzYOONhW8Kh6ozsyznmmuIWlJJ33pFiSbiLI+T/VNi91/pqRe6Va3//Z\"/\u003e\u003cnoscript\u003e\u003cimg class=\"mdui-hoverable mdui-img-rounded mdui-center mdui-img-fluid\" src=\"https://p.sda1.dev/12/b6a400aac6c1a2fa0778d8cf88a5f41e/-WLog8bd.png\" alt=\"undefined\" title=\"undefined\"\u003e\u003c/noscript\u003e\u003c/figure\u003e\u003cp\u003e（IE 不资辞 WebAssembly，直接爬吧）\u003c/p\u003e\u003cp\u003e你也可以在\u003ca href=\"https://jsbin.com/taxocoripu/edit?html,output\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e自己试试看～（wasm 文件已经以 Data URL 的形式嵌入了）\u003c/p\u003e\u003cp\u003e结论是显而易见的，WebAssembly 的性能比 JS 不知道高到哪里去了。而且如果不写清楚函数名的话，直接对着它的“汇编代码”很难看出是 RC4 算法，所以把一些关键操作放进 wasm 模块或许也是个防止前端代码被逆向的好主意？\u003c/p\u003e\u003cp\u003e即使不熟悉 C 语言和 Emscripten 的那一套工具，GitHub 上也有 \u003ca href=\"https://github.com/ballercat/walt\" target=\"_blank\" rel=\"noopener\"\u003eWalt\u003c/a\u003e 和 \u003ca href=\"https://github.com/AssemblyScript/assemblyscript\" target=\"_blank\" rel=\"noopener\"\u003eAssemblyScript\u003c/a\u003e 这样的工具可以直接使用 TypeScript 的语法编写 wasm 模块，以后再试试看吧～\u003c/p\u003e\u003ch1 id=\"Extra：WebAssembly-的-SIMD-支持\"\u003e\u003ca href=\"#Extra：WebAssembly-的-SIMD-支持\" class=\"headerlink\" title=\"Extra：WebAssembly 的 SIMD 支持\"\u003e\u003c/a\u003eExtra：WebAssembly 的 SIMD 支持\u003c/h1\u003e\u003cp\u003eWebAssembly 的标准里是有 \u003ca href=\"https://github.com/WebAssembly/simd\" target=\"_blank\" rel=\"noopener\"\u003eSIMD 指令集的提案\u003c/a\u003e的，最近各大浏览器以及 Node.js 的 JS 引擎终于\u003ca href=\"https://github.com/WebAssembly/simd/blob/main/proposals/simd/ImplementationStatus.md\" target=\"_blank\" rel=\"noopener\"\u003e实装了对 SIMD 的支持\u003c/a\u003e。理论上来说，使用 SIMD 可以进一步增加 wasm 的执行速度（虽然我做过的简单测试里似乎并不是这样……）\u003c/p\u003e\u003cp\u003e参考 \u003ca href=\"https://github.com/GoogleChromeLabs/wasm-feature-detect\" target=\"_blank\" rel=\"noopener\"\u003eGoogleChromeLabs/wasm-feature-detect\u003c/a\u003e，可以用下面的代码检测对 SIMD 的支持：\u003c/p\u003e\u003cpre class=\"language-javascript line-numbers\" data-language=\"javascript\"\u003e\u003ccode class=\"language-javascript\"\u003eWebAssembly\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003evalidate\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eUint8Array\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e97\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e115\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e109\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e5\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e96\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e123\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e10\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e1\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e8\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e65\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e0\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e253\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e15\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e253\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e98\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token number\"\u003e11\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\u003cspan class=\"line-numbers-rows\" aria-hidden=\"true\"\u003e\u003cspan\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e根据 \u003ca href=\"https://emscripten.org/docs/porting/simd.html\" target=\"_blank\" rel=\"noopener\"\u003eEmscripten 文档\u003c/a\u003e所述，编译时只要添加参数 \u003ccode\u003e-msimd128\u003c/code\u003e 就可以直接在编译的时候使用 SIMD 优化了。\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e封面图：\u003ca href=\"https://www.pixiv.net/artworks/82627900\" target=\"_blank\" rel=\"noopener\"\u003ePixiv ID: 82627900 「After school~」 by 呱子\u003c/a\u003e\u003c/p\u003e\u003c/blockquote\u003e\u003cblockquote class=\"mdui-m-b-0 mdui-m-x-0 mdui-p-y-1\" style=\"border-left:4px solid rgba(0,0,0,.36)\"\u003e\u003cstrong\u003e本作品采用\u003ca href=\"https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh\" target=\"_blank\"\u003e知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议\u003c/a\u003e进行许可。不允许内容农场类网站、CSDN 用户和微信公众号转载。\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文作者：✨小透明・宸✨\u003c/strong\u003e\u003cbr/\u003e\u003cstrong\u003e本文链接：\u003ca href=\"https://akarin.dev/2020/10/10/build-webassembly-module-with-c/\"\u003ehttps://akarin.dev/2020/10/10/build-webassembly-module-with-c/\u003c/a\u003e\u003c/strong\u003e\u003c/blockquote\u003e\u003c/article\u003e",
  "Date": "2020-10-10T03:24:34Z",
  "Author": "✨小透明・宸✨"
}