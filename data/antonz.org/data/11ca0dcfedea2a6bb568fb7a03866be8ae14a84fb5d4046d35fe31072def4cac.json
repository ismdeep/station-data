{
  "Source": "antonz.org",
  "Title": "Aggregating data with SQL window functions",
  "Link": "https://antonz.org/sql-window-functions-aggregation/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eAggregating data with SQL window functions\u003c/h1\u003e\u003c/header\u003e\u003cp\u003e\u003cem\u003eThis is an excerpt from my book \u003ca href=\"/sql-window-functions-book\"\u003eSQL Window Functions Explained\u003c/a\u003e. The book is a clear and visual introduction to the topic with lots of practical exercises.\u003c/em\u003e\u003c/p\u003e\u003cp\u003ePreviously we\u0026#39;ve covered \u003ca href=\"/sql-window-functions-ranking/\"\u003eranking\u003c/a\u003e and \u003ca href=\"/sql-window-functions-offset/\"\u003eoffset\u003c/a\u003e window functions.\u003c/p\u003e\u003cp\u003eAggregation means counting totals or averages (or other \u003cem\u003eaggregates\u003c/em\u003e). For example, the average salary per city. Or the total number of gold medals for each country in the Olympic Games standings.\u003c/p\u003e\u003cp\u003eWe will aggregate records from the \u003ccode\u003eemployees\u003c/code\u003e table:\u003c/p\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e┌────┬───────┬────────┬────────────┬────────┐\n│ id │ name  │  city  │ department │ salary │\n├────┼───────┼────────┼────────────┼────────┤\n│ 11 │ Diane │ London │ hr         │ 70     │\n│ 12 │ Bob   │ London │ hr         │ 78     │\n│ 21 │ Emma  │ London │ it         │ 84     │\n│ 22 │ Grace │ Berlin │ it         │ 90     │\n│ 23 │ Henry │ London │ it         │ 104    │\n│ 24 │ Irene │ Berlin │ it         │ 104    │\n│ 25 │ Frank │ Berlin │ it         │ 120    │\n│ 31 │ Cindy │ Berlin │ sales      │ 96     │\n│ 32 │ Dave  │ London │ sales      │ 96     │\n│ 33 │ Alice │ Berlin │ sales      │ 100    │\n└────┴───────┴────────┴────────────┴────────┘\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003e\u003ca href=\"https://sqlime.org/#employees.db\"\u003eplayground\u003c/a\u003e • \u003ca href=\"/sql-window-functions-book/employees.sql\"\u003edownload\u003c/a\u003e\u003c/p\u003e\u003cp\u003eTable of contents:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"#partitioned-aggregates\"\u003ePartitioned aggregates\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#filtering-and-execution-order\"\u003eFiltering and execution order\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#window-definition\"\u003eWindow definition\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#aggregation-functions\"\u003eAggregation functions\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#keep-it-up\"\u003eKeep it up\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch2 id=\"partitioned-aggregates\"\u003ePartitioned aggregates\u003c/h2\u003e\u003cp\u003eEach department has a salary fund — money spent monthly on paying employees\u0026#39; salaries. Let\u0026#39;s see what percentage of this fund represents each employee\u0026#39;s salary:\u003c/p\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003ebefore\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"before.png\" width=\"300\" alt=\"Before partition sum\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003eafter\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum-after.png\" width=\"300\" alt=\"After partition sum\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003efund\u003c/code\u003e column shows the department\u0026#39;s salary fund, and the \u003ccode\u003eperc\u003c/code\u003e column shows the employee\u0026#39;s salary share of that fund. As you can see, everything is more or less even in HR and Sales, but IT has a noticeable spread of salaries.\u003c/p\u003e\u003cp\u003eHow do we go from \u0026#34;before\u0026#34; to \u0026#34;after\u0026#34;?\u003c/p\u003e\u003cp\u003eFirst, let\u0026#39;s sort the table by department:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003enull\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e, \u003cspan style=\"color:#a90d91\"\u003enull\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eperc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow let\u0026#39;s traverse from the first record to the last, computing the following values along the way:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003efund\u003c/code\u003e — total departmental salary;\u003c/li\u003e\u003cli\u003e\u003ccode\u003eperc\u003c/code\u003e — employee\u0026#39;s salary as a percentage of the \u003ccode\u003efund\u003c/code\u003e.\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e➀\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum/03.png\" width=\"300\" alt=\"Partition sum step #1\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e➁\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum/04.png\" width=\"300\" alt=\"Partition sum step #2\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e➂\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum/05.png\" width=\"300\" alt=\"Partition sum step #3\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e➃\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum/06.png\" width=\"300\" alt=\"Partition sum step #4\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003c/div\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e➄\u003cbr/\u003e\u003cfigure\u003e\u003cimg src=\"sum/07.png\" width=\"300\" alt=\"Partition sum step #5\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e\u003cp\u003eand so on...\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cp\u003eIn a single gif:\u003c/p\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003e\u003cfigure\u003e\u003cimg src=\"sum.gif\" width=\"300\" alt=\"Partition sum animation\"/\u003e\u003c/figure\u003e\u003c/div\u003e\u003c/div\u003e\u003cp\u003eThe window consists of several partitions, one partition per department. The order of records in a partition is not essential: we are counting the total \u003ccode\u003esalary\u003c/code\u003e, which does not depend on the order.\u003c/p\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003ewindow w as (\n  partition by department\n)\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWe can use a regular \u003ccode\u003esum()\u003c/code\u003e over the window to calculate the \u003ccode\u003efund\u003c/code\u003e. And the \u003ccode\u003eperc\u003c/code\u003e will be calculated as \u003ccode\u003esalary / fund\u003c/code\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003eround\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e100\u003c/span\u003e.\u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eperc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003esum()\u003c/code\u003e function works without surprises — it counts the sum of values for the entire partition to which the current row belongs.\u003c/p\u003e\u003cdiv class=\"boxed\"\u003e\u003ch3\u003e✎ Exercise: City salary fund (+1 more)\u003c/h3\u003e\u003cp\u003ePractice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises — that\u0026#39;s why I recommend \u003ca href=\"https://antonz.gumroad.com/l/sql-windows\"\u003egetting it\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eIf you are okay with just theory for now, let\u0026#39;s continue.\u003c/p\u003e\u003c/div\u003e\u003ch2 id=\"filtering-and-execution-order\"\u003eFiltering and execution order\u003c/h2\u003e\u003cp\u003eLet\u0026#39;s get back to the query that calculated the salary fund by department:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eLet\u0026#39;s say we want to leave only London employees in the report. We\u0026#39;ll add a filter:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ewhere\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecity\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;London\u0026#39;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe filter works. However, the \u003ccode\u003efund\u003c/code\u003e values differ from the expected:\u003c/p\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003eexpectation\u003cbr/\u003e\u003cpre\u003e\u003ccode\u003e┌───────┬────────┬──────┐\n│ name  │ salary │ fund │\n├───────┼────────┼──────┤\n│ Diane │ 70     │ 148  │\n│ Bob   │ 78     │ 148  │\n│ Emma  │ 84     │ 502  │\n│ Henry │ 104    │ 502  │\n│ Dave  │ 96     │ 292  │\n└───────┴────────┴──────┘\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"col-xs-12 col-sm-5\"\u003ereality\u003cbr/\u003e\u003cpre\u003e\u003ccode\u003e┌───────┬────────┬──────┐\n│ name  │ salary │ fund │\n├───────┼────────┼──────┤\n│ Diane │ 70     │ 148  │\n│ Bob   │ 78     │ 148  │\n│ Emma  │ 84     │ 188  │\n│ Henry │ 104    │ 188  │\n│ Dave  │ 96     │ 96   │\n└───────┴────────┴──────┘\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\u003cp\u003eIt\u0026#39;s all about the order of operations. Here is the order in which the DB engine executes the query:\u003c/p\u003e\u003col\u003e\u003cli\u003eTake the tables (\u003ccode\u003efrom\u003c/code\u003e) and join them if necessary (\u003ccode\u003ejoin\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eFilter the rows (\u003ccode\u003ewhere\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eGroup the rows (\u003ccode\u003egroup by\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eFilter the aggregated results (\u003ccode\u003ehaving\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eTake specific columns from the result (\u003ccode\u003eselect\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eCalculate the values of window functions (\u003ccode\u003efunction() over window\u003c/code\u003e).\u003c/li\u003e\u003cli\u003eSort the results (\u003ccode\u003eorder by\u003c/code\u003e).\u003c/li\u003e\u003c/ol\u003e\u003cp\u003eWindows are processed at the next-to-last step, after filtering and grouping the results. Therefore, in our query, the \u003ccode\u003efund\u003c/code\u003e represents not the sum of all department salaries but the sum only for London employees.\u003c/p\u003e\u003cp\u003eThe solution is to use a subquery with a window and filter it in the main query:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ewith\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemp\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ecity\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemp\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ewhere\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecity\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;London\u0026#39;\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"window-definition\"\u003eWindow definition\u003c/h2\u003e\u003cp\u003eSo far, we have described the window in the \u003ccode\u003ewindow\u003c/code\u003e clause and referred to it in the \u003ccode\u003eover\u003c/code\u003e clause:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemp_count\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere is another way. SQL allows to omit the \u003ccode\u003ewindow\u003c/code\u003e clause and define the window directly inside \u003ccode\u003eover\u003c/code\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemp_count\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003epartition\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eI prefer the \u003ccode\u003ewindow\u003c/code\u003e clause — it is easier to read, and you can explicitly reuse the window. But the \u003ccode\u003eover\u003c/code\u003e option is common in the documentation and examples, so do not be surprised when you see it.\u003c/p\u003e\u003cp\u003eBy the way, the window definition can be empty:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e () \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemp_count\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a90d91\"\u003esum\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e () \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003efund\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edepartment\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAn empty window includes all rows, so:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003eemp_count\u003c/code\u003e amounts to the total number of employees,\u003c/li\u003e\u003cli\u003e\u003ccode\u003efund\u003c/code\u003e amounts to the total salary for all employees.\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"boxed\"\u003e\u003ch3\u003e✎ Exercise: Execution order (+1 more)\u003c/h3\u003e\u003cp\u003ePractice is crucial in turning abstract knowledge into skills, making theory alone insufficient. The book, unlike this article, contains a lot of exercises — that\u0026#39;s why I recommend \u003ca href=\"https://antonz.gumroad.com/l/sql-windows\"\u003egetting it\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eIf you are okay with just theory for now, let\u0026#39;s continue.\u003c/p\u003e\u003c/div\u003e\u003ch2 id=\"aggregation-functions\"\u003eAggregation functions\u003c/h2\u003e\u003cp\u003eHere are the aggregation window functions:\u003c/p\u003e\u003ctable\u003e\u003cthead\u003e\u003ctr\u003e\u003cth\u003eFunction\u003c/th\u003e\u003cth\u003eDescription\u003c/th\u003e\u003c/tr\u003e\u003c/thead\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003emin(value)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns the minimum \u003ccode\u003evalue\u003c/code\u003e across all window rows\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003emax(value)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns the maximum \u003ccode\u003evalue\u003c/code\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003ecount(value)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns the count of non-null \u003ccode\u003evalue\u003c/code\u003es\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003eavg(value)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns the average \u003ccode\u003evalue\u003c/code\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003esum(value)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns the total \u003ccode\u003evalue\u003c/code\u003e\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003egroup_concat(value, separator)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003ereturns a string combining \u003ccode\u003evalue\u003c/code\u003es using \u003ccode\u003eseparator\u003c/code\u003e (SQLite and MySQL only)\u003c/td\u003e\u003c/tr\u003e\u003ctr\u003e\u003ctd\u003e\u003ccode\u003estring_agg(value, separator)\u003c/code\u003e\u003c/td\u003e\u003ctd\u003esimilar to \u003ccode\u003egroup_concat()\u003c/code\u003e in PostgreSQL and MS SQL\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003ch2 id=\"keep-it-up\"\u003eKeep it up\u003c/h2\u003e\u003cp\u003eYou have learned how to calculate regular window aggregates. In the next chapter we will try \u003ca href=\"/sql-window-functions-rolling-aggregates/\"\u003erolling aggregates\u003c/a\u003e!\u003c/p\u003e\u003cp\u003e\u003ca class=\"button\" href=\"https://antonz.gumroad.com/l/sql-windows\"\u003eGet the book\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003csqlime-db name=\"employees\" path=\"/sql-window-functions-book/employees.sql\"\u003e\u003c/sqlime-db\u003e\n\u003csqlime-examples db=\"employees\" selector=\"div.highlight\" editable=\"\"\u003e\u003c/sqlime-examples\u003e\u003c/p\u003e\u003cscript defer=\"\" src=\"/modules/sqlean/sqlean.js\"\u003e\u003c/script\u003e\n\u003cscript defer=\"\" src=\"/modules/sqlime/sqlime-db.js\"\u003e\u003c/script\u003e\n\u003cscript defer=\"\" src=\"/modules/sqlime/sqlime-examples.js\"\u003e\u003c/script\u003e\u003cp\u003e\u003cem\u003e\u003ca href=\"/subscribe/\"\u003e\u003ci class=\"fas fa-star\"\u003e\u003c/i\u003e \u003cstrong\u003eSubscribe\u003c/strong\u003e\u003c/a\u003e\nto keep up with new posts.\u003c/em\u003e\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2023-04-30 18:30:00 +0000 UTC\"\u003e30 Apr, 2023\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/data/\"\u003edata\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2023-04-30T18:30:00Z",
  "Author": "Anton Zhiyanov"
}