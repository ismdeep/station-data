{
  "Source": "antonz.org",
  "Title": "JSON and virtual columns in SQLite",
  "Link": "https://antonz.org/json-virtual-columns/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eJSON and virtual columns in SQLite\u003c/h1\u003e\u003c/header\u003e\u003cp\u003e\u003ca href=\"/generated-columns/\"\u003eGenerated columns\u003c/a\u003e have another great use case.\u003c/p\u003e\u003cp\u003e\u003cimg src=\"json-data.png\" alt=\"JSON data\"/\u003e\u003c/p\u003e\u003cp\u003eLet\u0026#39;s say you decide to keep a log of events that occur in the system. There are different types of events, each with its own set of fields. For example, sign-in:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-json\" data-lang=\"json\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;timestamp\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;2022-05-15T09:31:00Z\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;object\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;object_id\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#1c01ce\"\u003e11\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;action\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;login\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;details\u0026#34;\u003c/span\u003e: {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003e\u0026#34;ip\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;192.168.0.1\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOr account deposit:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-json\" data-lang=\"json\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;timestamp\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;2022-05-15T09:32:00Z\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;object\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;account\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;object_id\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#1c01ce\"\u003e12\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;action\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;deposit\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003e\u0026#34;details\u0026#34;\u003c/span\u003e: {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003e\u0026#34;amount\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;1000\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003e\u0026#34;currency\u0026#34;\u003c/span\u003e: \u003cspan style=\"color:#c41a16\"\u003e\u0026#34;USD\u0026#34;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"json-functions.png\" alt=\"JSON functions\"/\u003e\u003c/p\u003e\u003cp\u003eYou decide to store the raw JSON, as normalization is non-trivial. You create an \u003ccode\u003eevents\u003c/code\u003e table with a single \u003ccode\u003evalue\u003c/code\u003e field:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e{\u0026#34;timestamp\u0026#34;:\u0026#34;2022-05-15T09:31:00Z\u0026#34;,\u0026#34;object\u0026#34;:\u0026#34;user\u0026#34;,\u0026#34;object_id\u0026#34;:11,\u0026#34;action\u0026#34;:\u0026#34;login\u0026#34;,\u0026#34;details\u0026#34;:{\u0026#34;ip\u0026#34;:\u0026#34;192.168.0.1\u0026#34;}}\n{\u0026#34;timestamp\u0026#34;:\u0026#34;2022-05-15T09:32:00Z\u0026#34;,\u0026#34;object\u0026#34;:\u0026#34;account\u0026#34;,\u0026#34;object_id\u0026#34;:12,\u0026#34;action\u0026#34;:\u0026#34;deposit\u0026#34;,\u0026#34;details\u0026#34;:{\u0026#34;amount\u0026#34;:\u0026#34;1000\u0026#34;,\u0026#34;currency\u0026#34;:\u0026#34;USD\u0026#34;}}\n{\u0026#34;timestamp\u0026#34;:\u0026#34;2022-05-15T09:33:00Z\u0026#34;,\u0026#34;object\u0026#34;:\u0026#34;company\u0026#34;,\u0026#34;object_id\u0026#34;:13,\u0026#34;action\u0026#34;:\u0026#34;edit\u0026#34;,\u0026#34;details\u0026#34;:{\u0026#34;fields\u0026#34;:[\u0026#34;address\u0026#34;,\u0026#34;phone\u0026#34;]}}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAnd select events for a specific object:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.object\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eobject\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.action\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eaction\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ewhere\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.object_id\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e11\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e┌────────┬────────┐\n│ object │ action │\n├────────┼────────┤\n│ user   │ login  │\n└────────┴────────┘\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSo far, so good. But \u003ccode\u003ejson_extract()\u003c/code\u003e parses the text on each call, so for hundreds of thousands of records the query is slow. What should you do?\u003c/p\u003e\u003cp\u003e\u003cimg src=\"json-columns.png\" alt=\"JSON columns\"/\u003e\u003c/p\u003e\u003cp\u003eDefine virtual columns:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ealter\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eadd\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecolumn\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eobject_id\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einteger\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.object_id\u0026#39;\u003c/span\u003e));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ealter\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eadd\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecolumn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eobject\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.object\u0026#39;\u003c/span\u003e));\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ealter\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eadd\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecolumn\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eaction\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etext\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003ejson_extract\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;$.action\u0026#39;\u003c/span\u003e));\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBuild an index:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ecreate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eindex\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents_object_id\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eon\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eobject_id\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow the query works instantly:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eobject\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eaction\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eevents\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ewhere\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eobject_id\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e11\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThanks to virtual columns, we almost have a NoSQL database ツ\u003c/p\u003e\u003cp\u003e\u003ca href=\"https://sqlime.org/#gist:c284f7c22684eb74b5dab92d98f7d773\"\u003ePlayground\u003c/a\u003e\u003c/p\u003e\u003cp\u003e──\u003c/p\u003e\u003cp\u003eP.S. \u003cmark\u003eInterested in mastering advanced SQL?\u003c/mark\u003e Check out my book — \u003ca href=\"/sql-window-functions-book\"\u003eSQL Window Functions Explained\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003cem\u003e\u003ca href=\"/subscribe/\"\u003e\u003ci class=\"fas fa-star\"\u003e\u003c/i\u003e \u003cstrong\u003eSubscribe\u003c/strong\u003e\u003c/a\u003e\nto keep up with new posts.\u003c/em\u003e\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2022-05-15 11:25:00 +0000 UTC\"\u003e15 May, 2022\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/sqlite/\"\u003esqlite\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2022-05-15T11:25:00Z",
  "Author": "Anton Zhiyanov"
}