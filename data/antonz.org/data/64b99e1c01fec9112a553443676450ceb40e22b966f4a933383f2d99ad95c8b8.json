{
  "Source": "antonz.org",
  "Title": "Idempotent close in Go",
  "Link": "https://antonz.org/idempotent-close/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eIdempotent close in Go\u003c/h1\u003e\u003c/header\u003e\u003cp\u003e\u003cem\u003eIdempotence\u003c/em\u003e is when a repeated call to an operation on an object does not result in changes or errors. Idempotence is a handy development tool.\u003c/p\u003e\u003cp\u003eLet\u0026#39;s see how idempotence helps to free the occupied resources safely.\u003c/p\u003e\u003ch2 id=\"idempotent-close\"\u003eIdempotent Close\u003c/h2\u003e\u003cp\u003eSuppose we have a gate:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003estruct\u003c/span\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// internal state\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003eNewGate()\u003c/code\u003e constructor opens the gate, acquires some system resources, and returns an instance of the \u003ccode\u003eGate\u003c/code\u003e.\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eNewGate\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn the end, we must release the occupied resources:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e() \u003cspan style=\"color:#a90d91\"\u003eerror\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// free acquired resources\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eNewGate\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eProblems arise when in some branch of the code, we want to close the gate explicitly:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eNewGate\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003echeckSomething\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eerr\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// do something else\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// do more stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe first \u003ccode\u003eClose()\u003c/code\u003e will work, but the second (via \u003ccode\u003edefer\u003c/code\u003e) will break because the resources have already been released.\u003c/p\u003e\u003cp\u003eThe solution is to make \u003ccode\u003eClose()\u003c/code\u003e idempotent so that repeated calls do nothing if the gate is already closed:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003estruct\u003c/span\u003e{\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ebool\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// internal state\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e() \u003cspan style=\"color:#a90d91\"\u003eerror\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// free acquired resources\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e = \u003cspan style=\"color:#a90d91\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca href=\"https://codapi.org/embed/?sandbox=go\u0026amp;code=package%2520main%250A%250Aimport%2520%28%250A%2520%2520%2520%2520%2522errors%2522%250A%2520%2520%2520%2520%2522fmt%2522%250A%29%250A%250Atype%2520Gate%2520struct%2520%257B%250A%2520%2520%2520%2520%252F%252F%2520internal%2520state%250A%2520%2520%2520%2520%252F%252F%2520...%250A%2520%2520%2520%2520closed%2520bool%250A%257D%250A%250Afunc%2520NewGate%28%29%2520*Gate%2520%257B%250A%2520%2520%2520%2520return%2520%2526Gate%257B%257D%250A%257D%250A%250Afunc%2520%28g%2520*Gate%29%2520Close%28%29%2520error%2520%257B%250A%2520%2520%2520%2520if%2520g.closed%2520%257B%2520%252F%252F%2520make%2520Gate.Close%2520idempotent%250A%2520%2520%2520%2520%2520%2520%2520%2520return%2520nil%250A%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%252F%252F%2520free%2520acquired%2520resources%250A%2520%2520%2520%2520%252F%252F%2520...%250A%250A%2520%2520%2520%2520%252F%252F%2520mark%2520the%2520gate%2520as%2520closed%250A%2520%2520%2520%2520g.closed%2520%253D%2520true%250A%2520%2520%2520%2520return%2520nil%250A%257D%250A%250Afunc%2520main%28%29%2520%257B%250A%2520%2520%2520%2520g%2520%253A%253D%2520NewGate%28%29%250A%2520%2520%2520%2520defer%2520func%28%29%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520g.Close%28%29%250A%2520%2520%2520%2520%2520%2520%2520%2520fmt.Println%28%2522gates%2520closed%2522%29%250A%2520%2520%2520%2520%257D%28%29%250A%250A%2520%2520%2520%2520err%2520%253A%253D%2520checkSomething%28%29%250A%2520%2520%2520%2520if%2520err%2520%21%253D%2520nil%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520g.Close%28%29%250A%2520%2520%2520%2520%2520%2520%2520%2520fmt.Println%28%2522gates%2520closed%2522%29%250A%2520%2520%2520%2520%2520%2520%2520%2520%252F%252F%2520do%2520something%2520else%250A%2520%2520%2520%2520%2520%2520%2520%2520%252F%252F%2520...%250A%2520%2520%2520%2520%2520%2520%2520%2520return%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520%252F%252F%2520do%2520more%2520stuff%250A%2520%2520%2520%2520%252F%252F%2520...%250A%257D%250A%250Afunc%2520checkSomething%28%29%2520error%2520%257B%250A%2520%2520%2520%2520return%2520errors.New%28%2522error%2522%29%250A%257D\"\u003eplayground\u003c/a\u003e\u003c/p\u003e\u003cp\u003eNow we can call \u003ccode\u003eClose()\u003c/code\u003e repeatedly without any problems. Until we try to close the gate from different goroutines — then everything will fall apart.\u003c/p\u003e\u003ch2 id=\"idempotency-in-a-concurrent-environment\"\u003eIdempotency in a concurrent environment\u003c/h2\u003e\u003cp\u003eWe have made the gate closing idempotent — safe for repeated calls:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e() \u003cspan style=\"color:#a90d91\"\u003eerror\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// free acquired resources\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e = \u003cspan style=\"color:#a90d91\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBut if several goroutines use the same \u003ccode\u003eGate\u003c/code\u003e instance, a simultaneous call to \u003ccode\u003eClose()\u003c/code\u003e will lead to races — a concurrent modification of the \u003ccode\u003eclosed\u003c/code\u003e field. We don\u0026#39;t want this.\u003c/p\u003e\u003cp\u003eWe have to protect the \u003ccode\u003eclosed\u003c/code\u003e field access with a mutex:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003estruct\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003emu\u003c/span\u003e     \u003cspan style=\"color:#000\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMutex\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ebool\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// internal state\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eGate\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eClose\u003c/span\u003e() \u003cspan style=\"color:#a90d91\"\u003eerror\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLock\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eUnlock\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// free acquired resources\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#177500\"\u003e// ...\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eclosed\u003c/span\u003e = \u003cspan style=\"color:#a90d91\"\u003etrue\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003emu\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eUnlock\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca href=\"https://codapi.org/embed/?sandbox=go\u0026amp;code=package%2520main%250A%250Aimport%2520%28%250A%2520%2520%2520%2520%2522errors%2522%250A%2520%2520%2520%2520%2522fmt%2522%250A%2520%2520%2520%2520%2522sync%2522%250A%29%250A%250Atype%2520Gate%2520struct%2520%257B%250A%2520%2520%2520%2520%252F%252F%2520internal%2520state%250A%2520%2520%2520%2520%252F%252F%2520...%250A%2520%2520%2520%2520mu%2520%2520%2520%2520%2520sync.Mutex%250A%2520%2520%2520%2520closed%2520bool%250A%257D%250A%250Afunc%2520NewGate%28%29%2520*Gate%2520%257B%250A%2520%2520%2520%2520return%2520%2526Gate%257B%257D%250A%257D%250A%250Afunc%2520%28g%2520*Gate%29%2520Close%28%29%2520error%2520%257B%250A%2520%2520%2520%2520%252F%252F%2520protect%2520Gate.closed%250A%2520%2520%2520%2520g.mu.Lock%28%29%250A%250A%2520%2520%2520%2520if%2520g.closed%2520%257B%2520%252F%252F%2520make%2520Gate.Close%2520idempotent%250A%2520%2520%2520%2520%2520%2520%2520%2520g.mu.Unlock%28%29%250A%2520%2520%2520%2520%2520%2520%2520%2520return%2520nil%250A%2520%2520%2520%2520%257D%250A%2520%2520%2520%2520%252F%252F%2520free%2520acquired%2520resources%250A%2520%2520%2520%2520%252F%252F%2520...%250A%250A%2520%2520%2520%2520%252F%252F%2520mark%2520the%2520gate%2520as%2520closed%250A%2520%2520%2520%2520g.closed%2520%253D%2520true%250A%2520%2520%2520%2520g.mu.Unlock%28%29%250A%2520%2520%2520%2520return%2520nil%250A%257D%250A%250Afunc%2520main%28%29%2520%257B%250A%2520%2520%2520%2520g%2520%253A%253D%2520NewGate%28%29%250A%2520%2520%2520%2520defer%2520func%28%29%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520g.Close%28%29%250A%2520%2520%2520%2520%2520%2520%2520%2520fmt.Println%28%2522gates%2520closed%2522%29%250A%2520%2520%2520%2520%257D%28%29%250A%250A%2520%2520%2520%2520err%2520%253A%253D%2520checkSomething%28%29%250A%2520%2520%2520%2520if%2520err%2520%21%253D%2520nil%2520%257B%250A%2520%2520%2520%2520%2520%2520%2520%2520g.Close%28%29%250A%2520%2520%2520%2520%2520%2520%2520%2520fmt.Println%28%2522gates%2520closed%2522%29%250A%2520%2520%2520%2520%2520%2520%2520%2520%252F%252F%2520do%2520something%2520else%250A%2520%2520%2520%2520%2520%2520%2520%2520%252F%252F%2520...%250A%2520%2520%2520%2520%2520%2520%2520%2520return%250A%2520%2520%2520%2520%257D%250A%250A%2520%2520%2520%2520%252F%252F%2520do%2520more%2520stuff%250A%2520%2520%2520%2520%252F%252F%2520...%250A%257D%250A%250Afunc%2520checkSomething%28%29%2520error%2520%257B%250A%2520%2520%2520%2520return%2520errors.New%28%2522error%2522%29%250A%257D\"\u003eplayground\u003c/a\u003e\u003c/p\u003e\u003cp\u003eThe mutex ensures that only a single goroutine executes the code between \u003ccode\u003eLock()\u003c/code\u003e and \u003ccode\u003eUnlock()\u003c/code\u003e at any given time.\u003c/p\u003e\u003cp\u003eNow multiple calls to \u003ccode\u003eClose()\u003c/code\u003e work correctly in a concurrent environment.\u003c/p\u003e\u003cp\u003eThat\u0026#39;s it!\u003c/p\u003e\u003cp\u003e──\u003c/p\u003e\u003cp\u003eP.S. \u003cmark\u003ePlaygrounds in this post\u003c/mark\u003e are powered by \u003ca href=\"https://codapi.org/\"\u003e\u003cstrong\u003ecodapi\u003c/strong\u003e\u003c/a\u003e — an open source tool I\u0026#39;m building. Use it to embed live code snippets into your product docs, online course or blog.\u003c/p\u003e\u003cp\u003e\u003cem\u003e\u003ca href=\"/subscribe/\"\u003e\u003ci class=\"fas fa-star\"\u003e\u003c/i\u003e \u003cstrong\u003eSubscribe\u003c/strong\u003e\u003c/a\u003e\nto keep up with new posts.\u003c/em\u003e\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2023-01-11 11:00:00 +0000 UTC\"\u003e11 Jan, 2023\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/thank-go/\"\u003ethank-go\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2023-01-11T11:00:00Z",
  "Author": "Anton Zhiyanov"
}