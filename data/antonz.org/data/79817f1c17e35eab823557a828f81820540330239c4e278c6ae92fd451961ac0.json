{
  "Source": "antonz.org",
  "Title": "SQL recipe: Segmenting data",
  "Link": "https://antonz.org/sql-segmenting/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eSQL recipe: Segmenting data\u003c/h1\u003e\u003c/header\u003e\u003cp\u003e\u003cem\u003eThis post is part of the \u0026#34;SQL Recipes\u0026#34; series, where I provide short patterns for solving common SQL data analysis tasks.\u003c/em\u003e\u003c/p\u003e\u003cp\u003eSuppose we want to divide our data into several segments based on the value of one or more columns (e.g., to assign customers or products to different groups for marketing purposes).\u003c/p\u003e\u003cp\u003eThe solution is to use the \u003ccode\u003entile()\u003c/code\u003e function over an SQL window ordered by target columns.\u003c/p\u003e\u003ch2 id=\"example\"\u003eExample\u003c/h2\u003e\u003cp\u003eLet\u0026#39;s divide the \u003ccode\u003eemployees\u003c/code\u003e into three groups according to their salary:\u003c/p\u003e\u003cul\u003e\u003cli\u003ehigh-paid,\u003c/li\u003e\u003cli\u003emedium-paid,\u003c/li\u003e\u003cli\u003elow-paid.\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003entile\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003entile(n)\u003c/code\u003e function splits all records into \u003ccode\u003en\u003c/code\u003e groups and returns the group number for each record. If the total number of records (10 in our case) is not divisible by the group size (3), then the former groups will be larger than the latter.\u003c/p\u003e\u003ch2 id=\"alternatives\"\u003eAlternatives\u003c/h2\u003e\u003cp\u003e\u003ccode\u003entile()\u003c/code\u003e always tries to split the data so that the groups are of the same size. So records with the same value may end up in different (adjacent) groups:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003entile\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eTo avoid this, we can use the following (much more complicated) formula instead of \u003ccode\u003entile(n)\u003c/code\u003e:\u003c/p\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e1 + ((rank() over w) - 1) * N / count(*) over () as tile\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eFor \u003ccode\u003en = 2\u003c/code\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e+\u003c/span\u003e ((\u003cspan style=\"color:#000\"\u003erank\u003c/span\u003e() \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e () \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ew\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e (\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"compatibility\"\u003eCompatibility\u003c/h2\u003e\u003cp\u003eAll major vendors support the \u003ccode\u003entile()\u003c/code\u003e window function. Some of them, such as MS SQL and Oracle, do not support the \u003ccode\u003ewindow\u003c/code\u003e clause. In these cases, we can inline the window definition:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003entile\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003eover\u003c/span\u003e (\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  ) \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can also rewrite the query without window functions:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003eceil\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    (\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ee2\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ewhere\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ee2\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ee1\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e3\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e/\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    (\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ecount\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  ) \u003cspan style=\"color:#000\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etile\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#000\"\u003ename\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eemployees\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eas\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ee1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003eorder\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eby\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esalary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003edesc\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cbr/\u003e\u003cp\u003eWant to learn more about window functions? Read my book — \u003ca href=\"/sql-window-functions-book/\"\u003e\u003cstrong\u003eSQL Window Functions Explained\u003c/strong\u003e\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003csqlime-db name=\"employees\" path=\"/sql-window-functions-book/employees.sql\"\u003e\u003c/sqlime-db\u003e\n\u003csqlime-examples db=\"employees\" selector=\"div.highlight\" editable=\"\"\u003e\u003c/sqlime-examples\u003e\u003c/p\u003e\u003cscript defer=\"\" src=\"/modules/sqlean/sqlean.js\"\u003e\u003c/script\u003e\n\u003cscript defer=\"\" src=\"/modules/sqlime/sqlime-db.js\"\u003e\u003c/script\u003e\n\u003cscript defer=\"\" src=\"/modules/sqlime/sqlime-examples.js\"\u003e\u003c/script\u003e\u003cp\u003e\u003cem\u003e\u003ca href=\"/subscribe/\"\u003e\u003ci class=\"fas fa-star\"\u003e\u003c/i\u003e \u003cstrong\u003eSubscribe\u003c/strong\u003e\u003c/a\u003e\nto keep up with new posts.\u003c/em\u003e\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2023-05-23 15:30:00 +0000 UTC\"\u003e23 May, 2023\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/data/\"\u003edata\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2023-05-23T15:30:00Z",
  "Author": "Anton Zhiyanov"
}