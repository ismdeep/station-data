{
  "Source": "antonz.org",
  "Title": "Resetting timers in Go",
  "Link": "https://antonz.org/timer-reset/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eResetting timers in Go\u003c/h1\u003e\u003c/header\u003e\u003cp\u003eIf you use \u003ccode\u003eTimer.Reset()\u003c/code\u003e in Go 1.22 or earlier, you may be doing it wrong. Even the book \u003cem\u003e100 Go Mistakes\u003c/em\u003e (which is usually right about Go nuances) got it wrong.\u003c/p\u003e\u003cp\u003eLet\u0026#39;s see what the problem might be and how to work around it.\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"#timeafter\"\u003etime.After\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#incorrect-solution\"\u003eIncorrect solution\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#reset-problem\"\u003eReset problem\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#123-fix\"\u003e1.23 fix\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#pre-123-solution\"\u003ePre-1.23 solution\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#post-123-solution\"\u003ePost-1.23 solution\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#timeafterfunc\"\u003etime.AfterFunc\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#final-thoughts\"\u003eFinal thoughts\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003ch2 id=\"timeafter\"\u003etime.After\u003c/h2\u003e\u003cp\u003eUsing \u003ccode\u003etime.After()\u003c/code\u003e in a loop in Go ≤1.22 can lead to significant memory usage. Consider this example:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003etype\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003estruct\u003c/span\u003e{}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eHour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAfter\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// log warning\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet id=\"consumer-1\" editor=\"basic\"\u003e\u003c/codapi-snippet\u003e\u003cp\u003eThe consumer reads tokens from the input channel and alerts if a value does not appear in a channel after an hour.\u003c/p\u003e\u003cp\u003eLet\u0026#39;s write a client that measures the memory usage after 100K channel sends:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ecancel\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eWithCancel\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eBackground\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003edefer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecancel\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etokens\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003emake\u003c/span\u003e(\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003ego\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etokens\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ememBefore\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003egetAlloc\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003erange\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e100000\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003etokens\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e{}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ememAfter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003egetAlloc\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ememUsed\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ememAfter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ememBefore\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintf\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;Memory used: %d KB\\n\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ememUsed\u003c/span\u003e\u003cspan style=\"color:#000\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#1c01ce\"\u003e1024\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" depends-on=\"consumer-1\" template=\"timer.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eMemory used: 20379 KB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdetails\u003e\u003csummary\u003eWhat is getAlloc\u003c/summary\u003e\u003cpre\u003e\u003ccode\u003e\u003cspan class=\"hljs-comment\"\u003e// getAlloc returns the number of bytes of allocated\u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e// heap objects (after garbage collection).\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003efunc\u003c/span\u003e getAlloc() \u003cspan class=\"hljs-type\"\u003euint64\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e m runtime.MemStats\n    runtime.GC()\n    runtime.ReadMemStats(\u0026amp;m)\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e m.Alloc\n}\u003c/code\u003e\u003cpre\u003e\u003c/pre\u003e\u003c/pre\u003e\u003c/details\u003e\n\u003cp\u003eBehind the scenes, \u003ccode\u003etime.After\u003c/code\u003e creates a timer that is not freed until it expires. And since we are using a large timeout (one hour), the for loop essentially creates a miriad of timers that are not yet freed. These timers together use ≈20 MB of memory. This is obviously not what we want.\u003c/p\u003e\n\u003ch2 id=\"incorrect-solution\"\u003eIncorrect solution\u003c/h2\u003e\n\u003cp\u003eHow about we create a single timer and reset it in each loop iteration? Seems reasonable. This is the solution suggested by \u003cem\u003e100 Go Mistakes\u003c/em\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eHour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// log warning\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer-memory.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eMemory used: 0 KB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSince we are reusing the same timer instance and not creating new ones, the memory usage problem is solved. But the thing is, this is \u003cem\u003enot the way\u003c/em\u003e to use the \u003ccode\u003eReset\u003c/code\u003e method in Go ≤1.22.\u003c/p\u003e\u003ch2 id=\"reset-problem\"\u003eReset problem\u003c/h2\u003e\u003cp\u003eConsider this example:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e20\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNow\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintf\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;Time elapsed: %dms\\n\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSince\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e).\u003cspan style=\"color:#000\"\u003eMilliseconds\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#177500\"\u003e// expected: Time elapsed: 10ms\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#177500\"\u003e// actual:   Time elapsed:  0ms\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eTime elapsed: 0ms\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe timer \u003ccode\u003et\u003c/code\u003e has a timeout of 10ms. So after we waited for 20ms, it has already expired and sent a value to the \u003ccode\u003et.C\u003c/code\u003e channel. And since \u003ccode\u003eReset\u003c/code\u003e does not drain the channel, \u003ccode\u003e\u0026lt;-t.C\u003c/code\u003e does not block and proceeds immediately. Also, since \u003ccode\u003eReset\u003c/code\u003e restarted the timer, we\u0026#39;ll see another value in \u003ccode\u003et.C\u003c/code\u003e after 10ms.\u003c/p\u003e\u003cp\u003eThis is not a minor issue. Let\u0026#39;s see what happens if the \u0026#34;do stuff\u0026#34; branch in our consumer takes longer than the timer timeout:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\t\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e20\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003epanic\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;should not happen\u0026#34;\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer-memory.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003epanic: should not happen\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003egoroutine 18 [running]:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003emain.consumer({0x4d3af0, 0xc000080050}, 0xc0000820c0)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t/sandbox/src/main.go:29 +0xf4\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003ecreated by main.main in goroutine 1\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t/sandbox/src/main.go:41 +0xb4 (exit status 2)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSince the timer channel is not drained, the timer branch is executed regardless of the \u003ccode\u003eReset\u003c/code\u003e call, causing a panic.\u003c/p\u003e\u003cp\u003eLet me quote the Go stdlib documentation here:\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003eFor a Timer created with NewTimer, Reset should be invoked only on stopped or expired timers with drained channels.\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003eIt may not be very intuitive, but it\u0026#39;s the only way to use \u003ccode\u003eReset\u003c/code\u003e properly in Go ≤1.22.\u003c/p\u003e\u003ch2 id=\"123-fix\"\u003e1.23 fix\u003c/h2\u003e\u003cp\u003eThe reset problem is fixed in Go 1.23. Quoting the docs again:\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003eThe timer channel associated with a Timer is now unbuffered, with capacity 0. The main effect of this change is that Go now guarantees that for any call to a Reset (or Stop) method, no stale values prepared before that call will be sent or received after the call.\u003c/p\u003e\u003c/blockquote\u003e\u003cp\u003eBut if you look at the code, you\u0026#39;ll see that the channel is in fact \u003cem\u003estill buffered\u003c/em\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// As of Go 1.23, the channel is synchronous (unbuffered, capacity 0),\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// eliminating the possibility of those stale values.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ed\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eDuration\u003c/span\u003e) \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eTimer\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003emake\u003c/span\u003e(\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eTime\u003c/span\u003e, \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e (\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003eTimer\u003c/span\u003e)(\u003cspan style=\"color:#000\"\u003enewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ewhen\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ed\u003c/span\u003e), \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esendTime\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003esyncTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#000\"\u003et\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca href=\"https://github.com/golang/go/blob/release-branch.go1.23/src/time/sleep.go#L142\"\u003etime/sleep.go\u003c/a\u003e\u003c/p\u003e\u003cp\u003eAccording to the commit message, the Go team left the timer channel buffered (contrary to what the code comment says). But they also hacked the \u003ccode\u003echan\u003c/code\u003e type itself to return zero length and capacity for timer channels:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// in runtime/chan.go\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003echanlen\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ehchan\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003eint\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003easync\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edebug\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003easynctimerchan\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLoad\u003c/span\u003e() \u003cspan style=\"color:#000\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan style=\"color:#000\"\u003easync\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003emaybeRunChan\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003enil\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e !\u003cspan style=\"color:#000\"\u003easync\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#177500\"\u003e// timer channels have a buffered implementation\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#177500\"\u003e// but present to users as unbuffered, so that we can\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#177500\"\u003e// undo sends without users noticing.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eint\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ec\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eqcount\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca href=\"https://github.com/golang/go/blob/release-branch.go1.23/src/runtime/chan.go#L786\"\u003eruntime/chan.go\u003c/a\u003e •\n\u003ca href=\"https://go-review.googlesource.com/c/go/+/568341\"\u003ecommit message\u003c/a\u003e\u003c/p\u003e\u003cp\u003eSeems like a dirty hack to me, but what do I know.\u003c/p\u003e\u003ch2 id=\"pre-123-solution\"\u003ePre-1.23 solution\u003c/h2\u003e\u003cp\u003eWhile a simple \u003ccode\u003eReset\u003c/code\u003e should do for 1.23+, in earlier versions we must ensure that the timer is ➊ either stopped or expired and ➋ has a drained channel. Let\u0026#39;s write a helper function and use it in the consumer:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// resetTimer stops, drains and resets the timer.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eresetTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eTimer\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ed\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDuration\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e !\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eStop\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003edefault\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ed\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet id=\"reset-timer\" editor=\"basic\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eHour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003eresetTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// log warning\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" depends-on=\"reset-timer\" template=\"timer-memory.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eMemory used: 0 KB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow the consumer is guaranteed to work properly regardless of the timeout value and \u0026#34;do stuff\u0026#34; execution time.\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.22\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e20\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNow\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003eresetTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintf\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;Time elapsed: %dms\\n\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSince\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e).\u003cspan style=\"color:#000\"\u003eMilliseconds\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" depends-on=\"reset-timer\" template=\"timer.go\" files=\"go.mod\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eTime elapsed: 10ms\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"post-123-solution\"\u003ePost-1.23 solution\u003c/h2\u003e\u003cp\u003eAs of Go 1.23, an active (but unreferenced) timer can be freed by the garbage collector. So a \u003ccode\u003etime.After\u003c/code\u003e in a loop will not pile up memory:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.23\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eHour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAfter\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e):\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// log warning\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer-memory.go\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eMemory used: 0 KB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIt will still do a lot of allocations, of course. So you might prefer the \u003ccode\u003eNewTimer\u003c/code\u003e + \u003ccode\u003eReset\u003c/code\u003e approach — it does not create new timers and therefore GC does not need to collect them.\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e// go 1.23\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econsumer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e \u003cspan style=\"color:#000\"\u003econtext\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eContext\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#a90d91\"\u003echan\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etoken\u003c/span\u003e) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003econst\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eHour\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNewTimer\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003eselect\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ein\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// do stuff\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etimer\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eC\u003c/span\u003e:\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#177500\"\u003e// log warning\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\t\u003cspan style=\"color:#a90d91\"\u003ecase\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan style=\"color:#000\"\u003ectx\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e():\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\t\u003cspan style=\"color:#a90d91\"\u003ereturn\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer-memory.go\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eMemory used: 0 KB\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHere are both options (\u003ccode\u003etime.After\u003c/code\u003e vs \u003ccode\u003etimer.Reset\u003c/code\u003e) side by side:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eBenchmarkAfter-8    24    49271620 ns/op    23201095 B/op    300012 allocs/op\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003eBenchmarkReset-8    40    29428138 ns/op         652 B/op         8 allocs/op\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe winner is clear.\u003c/p\u003e\u003ch2 id=\"timeafterfunc\"\u003etime.AfterFunc\u003c/h2\u003e\u003cp\u003eTo make matters worse, \u003ccode\u003etime.AfterFunc\u003c/code\u003e also creates a timer, but a very different one. It has a nil \u003ccode\u003eC\u003c/code\u003e channel, so the \u003ccode\u003eReset\u003c/code\u003e method works differently:\u003c/p\u003e\u003cul\u003e\u003cli\u003eIf the timer is still active (not stopped, not expired), \u003ccode\u003eReset\u003c/code\u003e clears the timeout, effectively restarting the timer.\u003c/li\u003e\u003cli\u003eIf the timer is already stopped or expired, \u003ccode\u003eReset\u003c/code\u003e schedules a new function execution.\u003c/li\u003e\u003c/ul\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emain\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eTime\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003ework\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\t\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintf\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;work done after %dms\\n\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSince\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e).\u003cspan style=\"color:#000\"\u003eMilliseconds\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#177500\"\u003e// run work after 10 milliseconds\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNow\u003c/span\u003e()  \u003cspan style=\"color:#177500\"\u003e// ignore the data race for simplicity\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAfterFunc\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003ework\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#177500\"\u003e// wait for 5 to 15 milliseconds\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#000\"\u003edelay\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDuration\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e5\u003c/span\u003e\u003cspan style=\"color:#000\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#000\"\u003erand\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eIntn\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e11\u003c/span\u003e)) \u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003edelay\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintf\u003c/span\u003e(\u003cspan style=\"color:#c41a16\"\u003e\u0026#34;%dms has passed...\\n\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003edelay\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMilliseconds\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#177500\"\u003e// Reset behavior depends on whether the timer has expired\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\t\u003cspan style=\"color:#000\"\u003et\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eReset\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003etimeout\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003estart\u003c/span\u003e = \u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eNow\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\t\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eSleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e50\u003c/span\u003e\u003cspan style=\"color:#000\"\u003e*\u003c/span\u003e\u003cspan style=\"color:#000\"\u003etime\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eMillisecond\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ccodapi-snippet sandbox=\"go\" editor=\"basic\" template=\"timer.go\" output=\"\"\u003e\u003c/codapi-snippet\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e8ms has passed...\nwork done after 10ms\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIf the timer has not expired, \u003ccode\u003eReset\u003c/code\u003e clears the timeout:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e8ms has passed...\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003ework done after 10ms\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf the timer has expired, Reset schedules a new function call:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003ework done after 10ms\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e13ms has passed...\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003ework done after 10ms\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"final-thoughts\"\u003eFinal thoughts\u003c/h2\u003e\u003cp\u003eTo reiterate:\u003c/p\u003e\u003cul\u003e\u003cli\u003eGo ≤ 1.22: For a \u003ccode\u003eTimer\u003c/code\u003e created with \u003ccode\u003eNewTimer\u003c/code\u003e, \u003ccode\u003eReset\u003c/code\u003e should only be called on stopped or expired timers with drained channels.\u003c/li\u003e\u003cli\u003eGo ≥ 1.23: For a \u003ccode\u003eTimer\u003c/code\u003e created with \u003ccode\u003eNewTimer\u003c/code\u003e, it\u0026#39;s safe to call \u003ccode\u003eReset\u003c/code\u003e on timers in any state (active, stopped or expired). No channel drain is required, since the timer channel is (sort of) no longer buffered.\u003c/li\u003e\u003cli\u003eFor a \u003ccode\u003eTimer\u003c/code\u003e created with \u003ccode\u003eAfterFunc\u003c/code\u003e, \u003ccode\u003eReset\u003c/code\u003e either reschedules the function (if the timer is still active) or schedules the function to run again (if the timer has stopped or expired).\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e\u003ca href=\"https://pkg.go.dev/time@go1.22#Timer.Reset\"\u003eDocumentation [pre-1.23]\u003c/a\u003e •\n\u003ca href=\"https://pkg.go.dev/time@master#Timer.Reset\"\u003eDocumentation [1.23+]\u003c/a\u003e •\n\u003ca href=\"https://100go.co/#timeafter-and-memory-leaks-76\"\u003e100 Go Mistakes\u003c/a\u003e\u003c/p\u003e\u003cp\u003eTimers are not the most obvious thing in Go, are they?\u003c/p\u003e\u003cp\u003e──\u003c/p\u003e\u003cp\u003eP.S. \u003cmark\u003eInteractive examples\u003c/mark\u003e in this post are powered by \u003ca href=\"https://codapi.org/\"\u003ecodapi\u003c/a\u003e — an open source tool I\u0026#39;m building. Use it to embed live code snippets into your product docs, online course or blog.\u003c/p\u003e\u003cscript defer=\"\" src=\"/modules/codapi/snippet.js\"\u003e\u003c/script\u003e\u003cp\u003e\u003ca href=\"/subscribe/\"\u003e★ Subscribe\u003c/a\u003e to keep up with new posts.\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2024-07-05 10:00:00 +0000 UTC\"\u003e05 Jul, 2024\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/thank-go/\"\u003ethank-go\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2024-07-05T10:00:00Z",
  "Author": "Anton Zhiyanov"
}