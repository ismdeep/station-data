{
  "Source": "antonz.org",
  "Title": "Atomic operations composition in Go",
  "Link": "https://antonz.org/atomics-composition/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eAtomic operations composition in Go\u003c/h1\u003e\u003c/header\u003e\u003cp\u003eAn atomic operation in a concurrent program is a great thing. Such operation transforms into a single processor instruction, so it does not require locks. You can safely call it from different goroutines and receive a predictable result.\u003c/p\u003e\u003cp\u003eBut what happens if you misuse atomics? Let\u0026#39;s figure it out.\u003c/p\u003e\u003ch2 id=\"atomicity\"\u003eAtomicity\u003c/h2\u003e\u003cp\u003eLet\u0026#39;s look at a function that increments a counter:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eint32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e+=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#177500\"\u003e// random sleep up to 10 ms\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e    \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e+=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we call it 100 times in a single goroutine:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e; \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#1c01ce\"\u003e100\u003c/span\u003e; \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#000\"\u003e++\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ethen \u003ccode\u003ecounter\u003c/code\u003e is guaranteed to equal 200.\u003c/p\u003e\u003cp\u003eIn a concurrent environment, \u003ccode\u003eincrement()\u003c/code\u003e is unsafe due to races on \u003ccode\u003ecounter += 1\u003c/code\u003e. Now I will try to fix it and propose several options.\u003c/p\u003e\u003cp\u003eIn each case, answer the question: if you call \u003ccode\u003eincrement()\u003c/code\u003e from 100 goroutines, is the final value of the \u003ccode\u003ecounter\u003c/code\u003e guaranteed?\u003c/p\u003e\u003cp\u003e\u003cstrong\u003eExample 1\u003c/strong\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIs the \u003ccode\u003ecounter\u003c/code\u003e value guaranteed?\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003eAnswer\u003c/summary\u003e\u003cp\u003eIt is guaranteed.\u003c/p\u003e\u003c/details\u003e\u003cp\u003e\u003cstrong\u003eExample 2\u003c/strong\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLoad\u003c/span\u003e()\u003cspan style=\"color:#000\"\u003e%\u003c/span\u003e\u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    } \u003cspan style=\"color:#a90d91\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIs the \u003ccode\u003ecounter\u003c/code\u003e value guaranteed?\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003eAnswer\u003c/summary\u003e\u003cp\u003eIt\u0026#39;s not guaranteed.\u003c/p\u003e\u003c/details\u003e\u003cp\u003e\u003cstrong\u003eExample 3\u003c/strong\u003e\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003edelta\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003edelta\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003edelta\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLoad\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIs the \u003ccode\u003ecounter\u003c/code\u003e value guaranteed?\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003eAnswer\u003c/summary\u003e\u003cp\u003eIt\u0026#39;s not guaranteed.\u003c/p\u003e\u003c/details\u003e\u003ch2 id=\"composition-of-atomic-operations\"\u003eComposition of Atomic Operations\u003c/h2\u003e\u003cp\u003ePeople sometimes think that the composition of atomics also magically becomes an atomic operation. But this is not the case.\u003c/p\u003e\u003cp\u003eFor example, the second of the above examples:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003eif\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLoad\u003c/span\u003e()\u003cspan style=\"color:#000\"\u003e%\u003c/span\u003e\u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    } \u003cspan style=\"color:#a90d91\"\u003eelse\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e2\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eCall \u003ccode\u003eincrement()\u003c/code\u003e 100 times from different goroutines:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ewg\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esync\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eWaitGroup\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e100\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efor\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e:=\u003c/span\u003e \u003cspan style=\"color:#1c01ce\"\u003e0\u003c/span\u003e; \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e \u0026lt; \u003cspan style=\"color:#1c01ce\"\u003e100\u003c/span\u003e; \u003cspan style=\"color:#000\"\u003ei\u003c/span\u003e\u003cspan style=\"color:#000\"\u003e++\u003c/span\u003e {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#a90d91\"\u003ego\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e        \u003cspan style=\"color:#000\"\u003ewg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eDone\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    }()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003ewg\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eWait\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003efmt\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003ePrintln\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eLoad\u003c/span\u003e())\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRun with the \u003ccode\u003e-race\u003c/code\u003e flag — there are no races. But can we guarantee what the \u003ccode\u003ecounter\u003c/code\u003e value will be in the end? Nope.\u003c/p\u003e\u003cpre tabindex=\"0\"\u003e\u003ccode\u003e% go run atomic-2.go\n192\n% go run atomic-2.go\n191\n% go run atomic-2.go\n189\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eDespite the absence of races, \u003ccode\u003eincrement()\u003c/code\u003e is not atomic.\u003c/p\u003e\u003cp\u003eCheck yourself by answering the question: in which example is \u003ccode\u003eincrement()\u003c/code\u003e an atomic operation?\u003c/p\u003e\u003cdetails\u003e\u003csummary\u003eAnswer\u003c/summary\u003e\u003cp\u003eIn none of them.\u003c/p\u003e\u003c/details\u003e\u003ch2 id=\"atomicity-and-sequence-independence\"\u003eAtomicity and Sequence-Independence\u003c/h2\u003e\u003cp\u003eIn all examples, \u003ccode\u003eincrement()\u003c/code\u003e is not an atomic operation. The composition of atomics is always non-atomic.\u003c/p\u003e\u003cp\u003eThe first example, however, guarantees the final value of the \u003ccode\u003ecounter\u003c/code\u003e in a concurrent environment:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-go\" data-lang=\"go\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003evar\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eatomic\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eInt32\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003efunc\u003c/span\u003e \u003cspan style=\"color:#000\"\u003eincrement\u003c/span\u003e() {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003esleep\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e    \u003cspan style=\"color:#000\"\u003ecounter\u003c/span\u003e.\u003cspan style=\"color:#000\"\u003eAdd\u003c/span\u003e(\u003cspan style=\"color:#1c01ce\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we run 100 goroutines, the \u003ccode\u003ecounter\u003c/code\u003e will ultimately equal 200 (if there were no errors during execution).\u003c/p\u003e\u003cp\u003eThe reason is that \u003ccode\u003eAdd()\u003c/code\u003e is a sequence-independent operation. The runtime can perform such operations in any order, and the result will not change.\u003c/p\u003e\u003cp\u003eThe second and third examples use sequence-dependent operations. When we run 100 goroutines, the order of operations is different each time. Therefore, the result is also different.\u003c/p\u003e\u003cp\u003eIn general, despite the apparent simplicity of atomics, use them cautiously. Mutex is less shiny but more error-proof.\u003c/p\u003e\u003cp\u003e\u003cem\u003e\u003ca href=\"/subscribe/\"\u003e\u003ci class=\"fas fa-star\"\u003e\u003c/i\u003e \u003cstrong\u003eSubscribe\u003c/strong\u003e\u003c/a\u003e\nto keep up with new posts.\u003c/em\u003e\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2023-01-17 09:20:00 +0000 UTC\"\u003e17 Jan, 2023\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/thank-go/\"\u003ethank-go\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2023-01-17T09:20:00Z",
  "Author": "Anton Zhiyanov"
}