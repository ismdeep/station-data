{
  "Source": "antonz.org",
  "Title": "Modern SQLite: Secure delete",
  "Link": "https://antonz.org/sqlite-secure-delete/",
  "Content": "\u003carticle class=\"post\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12 col-md-10 article\"\u003e\u003cheader\u003e\u003ch1\u003eModern SQLite: Secure delete\u003c/h1\u003e\u003c/header\u003e\u003cp\u003e\u003cem\u003eThis post is part of the \u003ca href=\"/tags/modern-sqlite/\"\u003eModern SQLite\u003c/a\u003e series, where I write about handy SQLite features you might not have heard about.\u003c/em\u003e\u003c/p\u003e\u003cp\u003eThis feature is available since 00s, but few people know of it.\u003c/p\u003e\u003cp\u003eIf you work with sensitive data, and want to be 100% sure that there is no trace of the old data after it has been updated or deleted — SQLite has you covered. The \u003ccode\u003esecure_delete\u003c/code\u003e pragma (off by default) causes SQLite to overwrite deleted content with zeros.\u003c/p\u003e\u003cp\u003eWhen \u003ccode\u003esecure_delete\u003c/code\u003e is \u003ccode\u003eoff\u003c/code\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- using the data.db file\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ecreate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einteger\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eprimary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ekey\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etext\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003einsert\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einto\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003evalues\u003c/span\u003e (\u003cspan style=\"color:#1c01ce\"\u003e42\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;helloworld\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003edelete\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- The file data.db still contains\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- the string \u0026#39;helloworld\u0026#39; after deletion.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhen \u003ccode\u003esecure_delete\u003c/code\u003e is \u003ccode\u003eon\u003c/code\u003e:\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- using the data.db file\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#000\"\u003epragma\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esecure_delete\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eon\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ecreate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einteger\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eprimary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ekey\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etext\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003einsert\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einto\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003evalues\u003c/span\u003e (\u003cspan style=\"color:#1c01ce\"\u003e42\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;helloworld\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003edelete\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- The file data.db does not contain\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- the string \u0026#39;helloworld\u0026#39; after deletion.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAs you\u0026#39;d expect, \u003ccode\u003esecure_delete=on\u003c/code\u003e results in more CPU and I/O usage. There is also \u003ccode\u003esecure_delete=fast\u003c/code\u003e (3.20+), which only increases CPU (not I/O), but does not scrub the deleted data from the freelist pages (not sure what the point of this mode is, since it\u0026#39;s not actually secure).\u003c/p\u003e\u003cp\u003eNote that when using the WAL journal mode, even the \u003ccode\u003esecure_delete=on\u003c/code\u003e does NOT zero out the old content in the database file until the WAL checkpoint occurs. And the old content may remain in the WAL file even after the checkpoint (until it\u0026#39;s truncated).\u003c/p\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- using the data.db file\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\u003cspan style=\"color:#000\"\u003epragma\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ejournal_mode\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ewal\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003epragma\u003c/span\u003e \u003cspan style=\"color:#000\"\u003esecure_delete\u003c/span\u003e \u003cspan style=\"color:#000\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eon\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003ecreate\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etable\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einteger\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003eprimary\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003ekey\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003etext\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003einsert\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003einto\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e(\u003cspan style=\"color:#000\"\u003eid\u003c/span\u003e, \u003cspan style=\"color:#000\"\u003evalue\u003c/span\u003e) \u003cspan style=\"color:#a90d91\"\u003evalues\u003c/span\u003e (\u003cspan style=\"color:#1c01ce\"\u003e42\u003c/span\u003e, \u003cspan style=\"color:#c41a16\"\u003e\u0026#39;helloworld\u0026#39;\u003c/span\u003e);\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003epragma\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ewal_checkpoint\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a90d91\"\u003edelete\u003c/span\u003e \u003cspan style=\"color:#a90d91\"\u003efrom\u003c/span\u003e \u003cspan style=\"color:#000\"\u003emessages\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- Both data.db and data.db-wal files contain\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- the string \u0026#39;helloworld\u0026#39; after deletion.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#000\"\u003epragma\u003c/span\u003e \u003cspan style=\"color:#000\"\u003ewal_checkpoint\u003c/span\u003e;\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- Now data.db does not contain \u0026#39;helloworld\u0026#39;,\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex\"\u003e\u003cspan\u003e\u003cspan style=\"color:#177500\"\u003e-- but data.db-wal still does.\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSo it\u0026#39;s safer to use \u003ccode\u003ejournal_mode=delete\u003c/code\u003e (or \u003ccode\u003ememory\u003c/code\u003e, or maybe even \u003ccode\u003eoff\u003c/code\u003e) if you want truly secure deletes.\u003c/p\u003e\u003cp\u003eAlso, \u003ccode\u003esecure_delete=on\u003c/code\u003e does not scrub deleted content from virtual tables (like the full-text search shadow tables, although you can change this with the \u003ccode\u003esecure-delete\u003c/code\u003e FTS5 option).\u003c/p\u003e\u003cp\u003eDocumentation:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"https://sqlite.org/pragma.html#pragma_secure_delete\"\u003e\u003ccode\u003esecure_delete\u003c/code\u003e\u003c/a\u003e pragma\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://sqlite.org/fts5.html#the_secure_delete_configuration_option\"\u003e\u003ccode\u003esecure-delete\u003c/code\u003e\u003c/a\u003e FTS5 option\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://sqlite.org/pragma.html#pragma_journal_mode\"\u003e\u003ccode\u003ejournal_mode\u003c/code\u003e\u003c/a\u003e pragma\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e──\u003c/p\u003e\u003cp\u003eP.S. Like SQLite? Check out \u003ca href=\"https://github.com/nalgeon/redka\"\u003eRedka\u003c/a\u003e — Redis re-implemented with SQLite.\u003c/p\u003e\u003cp\u003e\u003ca href=\"/subscribe/\"\u003e★ Subscribe\u003c/a\u003e to keep up with new posts.\u003c/p\u003e\u003c/div\u003e\u003c/div\u003e\u003cfooter class=\"post__footer\"\u003e\u003cdiv class=\"row\"\u003e\u003cdiv class=\"col-xs-12\"\u003e\u003cdiv class=\"post__date\"\u003e\u003ctime datetime=\"2024-05-29 11:30:00 +0000 UTC\"\u003e29 May, 2024\u003c/time\u003e\u003c/div\u003e\u003cdiv class=\"post__tags\"\u003e\u003ca href=\"/tags/sqlite/\"\u003esqlite\u003c/a\u003e \n\u003ca href=\"/tags/modern-sqlite/\"\u003emodern-sqlite\u003c/a\u003e \u003c/div\u003e\u003c/div\u003e\u003c/div\u003e\u003c/footer\u003e\u003c/article\u003e",
  "Date": "2024-05-29T11:30:00Z",
  "Author": "Anton Zhiyanov"
}