{
  "Source": "arthurchiao.art",
  "Title": "Traffic Mirroring With OVS",
  "Link": "https://arthurchiao.art/blog/traffic-mirror-with-ovs/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eTraffic Mirroring With OVS\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2018-11-10 | Last Update 2021-01-23\u003c/p\u003e\n  \n  \u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-preliminary-knowledge\" id=\"markdown-toc-1-preliminary-knowledge\"\u003e1 Preliminary Knowledge\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-ovs-bridge\" id=\"markdown-toc-11-ovs-bridge\"\u003e1.1 OVS Bridge\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-ovs-port\" id=\"markdown-toc-12-ovs-port\"\u003e1.2 OVS Port\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-ovs-port-mirroring\" id=\"markdown-toc-13-ovs-port-mirroring\"\u003e1.3 OVS Port Mirroring\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-container-network-basics\" id=\"markdown-toc-14-container-network-basics\"\u003e1.4 Container Network Basics\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-mirror-traffic-with-ovs\" id=\"markdown-toc-2-mirror-traffic-with-ovs\"\u003e2 Mirror Traffic With OVS\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-prepare-environment\" id=\"markdown-toc-21-prepare-environment\"\u003e2.1 Prepare Environment\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-create-mirror\" id=\"markdown-toc-22-create-mirror\"\u003e2.2 Create Mirror\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-add-traffic-source\" id=\"markdown-toc-23-add-traffic-source\"\u003e2.3 Add Traffic Source\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-test\" id=\"markdown-toc-3-test\"\u003e3 Test\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-setup-capture\" id=\"markdown-toc-31-setup-capture\"\u003e3.1 Setup Capture\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-generate-traffic\" id=\"markdown-toc-32-generate-traffic\"\u003e3.2 Generate Traffic\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-performance-test\" id=\"markdown-toc-33-performance-test\"\u003e3.3 Performance Test\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#34-add-more-traffic-source\" id=\"markdown-toc-34-add-more-traffic-source\"\u003e3.4 Add More Traffic Source\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#34-cleanup\" id=\"markdown-toc-34-cleanup\"\u003e3.4 Cleanup\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-summary\" id=\"markdown-toc-4-summary\"\u003e4 Summary\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#references\" id=\"markdown-toc-references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#appendix-a-setup-environment\" id=\"markdown-toc-appendix-a-setup-environment\"\u003eAppendix A: Setup Environment\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#appendix-b-scripts-used-in-this-article\" id=\"markdown-toc-appendix-b-scripts-used-in-this-article\"\u003eAppendix B: Scripts Used In This Article\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003eTraffic mirroring, or port mirroring, is a technique to send a copy of the\nnetwork traffic to a backend system. It is commonly used by network\nadministrators and developers who need to monitor the network traffic, or\ndiagnose network problems. Systems relying on traffic mirror include: intrusion\ndetection system (IDS), passive probe, real user monitoring (RUM), traffic\nreplay system, etc. [1]\u003c/p\u003e\n\n\u003cp\u003eTraditional traffic mirroring solutions are based on hardware switches, and are\nvendor-specific, which often found expensive, hard to use and evolve.\nWith the growing of cloud computing and network virtualization,\nsoftware-based and vendor-agnostic solutions emerge.\u003c/p\u003e\n\n\u003cp\u003eIn this article, we will investigate the feasibility of traffic mirroring based\non OVS [2].\u003c/p\u003e\n\n\u003ch1 id=\"1-preliminary-knowledge\"\u003e1 Preliminary Knowledge\u003c/h1\u003e\n\n\u003ch2 id=\"11-ovs-bridge\"\u003e1.1 OVS Bridge\u003c/h2\u003e\n\n\u003cp\u003eAn OVS bridge is a software implemented Layer 2 (L2) bridge.\u003c/p\u003e\n\n\u003ch2 id=\"12-ovs-port\"\u003e1.2 OVS Port\u003c/h2\u003e\n\n\u003cp\u003eA port is a virtual device which could be used as a NIC by applications to\nsend/receive packets.\u003c/p\u003e\n\n\u003cp\u003eAn OVS port could be many types, for example:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003ephysical NIC\u003c/li\u003e\n  \u003cli\u003etap device\u003c/li\u003e\n  \u003cli\u003ea veth pair\u003c/li\u003e\n  \u003cli\u003eOVS internal port, patch port\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"13-ovs-port-mirroring\"\u003e1.3 OVS Port Mirroring\u003c/h2\u003e\n\n\u003cp\u003eOVS provides a \u003ca href=\"http://docs.openvswitch.org/en/latest/faq/configuration/\"\u003eway\u003c/a\u003e\nto duplicate network traffic of specified ports to a dedicated output port.\nThe duplication could be in single direction (ingress/egress) or both.\u003c/p\u003e\n\n\u003ch2 id=\"14-container-network-basics\"\u003e1.4 Container Network Basics\u003c/h2\u003e\n\n\u003cp\u003eThis article needs some container basics, see our previous post\n\u003ca href=\"/blog/play-with-container-network-if/\"\u003ePlay With Container Network Interface\u003c/a\u003e\nif you are unfamilir with this topic.\u003c/p\u003e\n\n\u003ch1 id=\"2-mirror-traffic-with-ovs\"\u003e2 Mirror Traffic With OVS\u003c/h1\u003e\n\n\u003cp\u003eThis post referenced an earlier blog \u003ca href=\"https://backreference.org/2014/06/17/port-mirroring-with-linux-bridges/\"\u003ePort mirroring with Linux bridges\u003c/a\u003e. Some syntax sugar of OVS CLI got well explained there, we do not repeat them here.\u003c/p\u003e\n\n\u003cp\u003eFor simplicity, we wrapped some shell commands into (really) simple scripts. You\ncould find them in the appendix.\u003c/p\u003e\n\n\u003ch2 id=\"21-prepare-environment\"\u003e2.1 Prepare Environment\u003c/h2\u003e\n\n\u003cp\u003eRefer to appendix A or our post [4] for how to setup a test environment like this:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/traffic-mirror-with-ovs/net-topo.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\n\u003ch2 id=\"22-create-mirror\"\u003e2.2 Create Mirror\u003c/h2\u003e\n\n\u003cp\u003eFirst, add a device as the output port of mirrored traffic. We use OVS internal\nport here:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-port.sh mirror0-output\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl show | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003emirror0-output\n        Port \u003cspan class=\"s2\"\u003e\u0026#34;mirror0-output\u0026#34;\u003c/span\u003e\n            Interface \u003cspan class=\"s2\"\u003e\u0026#34;mirror0-output\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl get port mirror0-output _uuid\nd74a2e7e-5d66-4a48-9261-7d080444964f\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ethen configure our mirror:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-mirror.sh br-int mirror0 mirror0-output\n762fe791-bf4a-4180-b0f8-d22627d3970f\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl list mirror\nname                : \u003cspan class=\"s2\"\u003e\u0026#34;mirror0\u0026#34;\u003c/span\u003e\noutput_port         : d74a2e7e-5d66-4a48-9261-7d080444964f\nselect_all          : \u003cspan class=\"nb\"\u003efalse\n\u003c/span\u003eselect_dst_port     : \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\nselect_src_port     : \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\nstatistics          : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003etx_bytes\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0, \u003cspan class=\"nv\"\u003etx_packets\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"23-add-traffic-source\"\u003e2.3 Add Traffic Source\u003c/h2\u003e\n\n\u003cp\u003eMirror only the egress traffic:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-traffic-source.sh mirror0 vnic-1 egress\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./list-mirror.sh\n_uuid               : 762fe791-bf4a-4180-b0f8-d22627d3970f\nname                : \u003cspan class=\"s2\"\u003e\u0026#34;mirror0\u0026#34;\u003c/span\u003e\noutput_port         : d74a2e7e-5d66-4a48-9261-7d080444964f\nselect_all          : \u003cspan class=\"nb\"\u003efalse\n\u003c/span\u003eselect_dst_port     : \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\nselect_src_port     : \u003cspan class=\"o\"\u003e[\u003c/span\u003e29a6d786-5ad2-4e8a-afdb-2f099fbe0de1]\nstatistics          : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003etx_bytes\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e448, \u003cspan class=\"nv\"\u003etx_packets\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e7\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAll ports whose \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eegress\u003c/code\u003e traffic are being mirrored are shown in the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eselect_src_port\u003c/code\u003e list,\nand those whose \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eingress\u003c/code\u003e being mirrored shown in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eselect_dst_port\u003c/code\u003e list.\u003c/p\u003e\n\n\u003cp\u003eVerify that \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e29a6d786-5ad2-4e8a-afdb-2f099fbe0de1\u003c/code\u003e is just \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evnic-1\u003c/code\u003e’s UUID:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl get port vnic-1 _uuid\n29a6d786-5ad2-4e8a-afdb-2f099fbe0de1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eYou could also mirror both ingress or both:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-traffic-source.sh mirror0 vnic-1 ingress\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-traffic-source.sh mirror0 vnic-1 all\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow our network topology:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/traffic-mirror-with-ovs/net-topo-with-output.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\n\u003ch1 id=\"3-test\"\u003e3 Test\u003c/h1\u003e\n\n\u003ch2 id=\"31-setup-capture\"\u003e3.1 Setup Capture\u003c/h2\u003e\n\n\u003cp\u003eTo test the mirror, we will generate and capture ICMP packets.\u003c/p\u003e\n\n\u003cp\u003eUse \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etcpdump\u003c/code\u003e to capture ICMP packets on \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evnic-1\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eip netns \u003cspan class=\"nb\"\u003eexec \u003c/span\u003e21580 tcpdump \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e vnic-1 \u003cspan class=\"s1\"\u003e\u0026#39;icmp\u0026#39;\u003c/span\u003e\nlistening on vnic-1, link-type EN10MB \u003cspan class=\"o\"\u003e(\u003c/span\u003eEthernet\u003cspan class=\"o\"\u003e)\u003c/span\u003e, capture size 65535 bytes\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ethis is equivalent to log into \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-1\u003c/code\u003e with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edocker exec -it ctn-1 sh\u003c/code\u003e and run\nthe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etcpdump\u003c/code\u003e command in it.\u003c/p\u003e\n\n\u003cp\u003eCapture on \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emirror0-output\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpdump \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e mirror0-output \u003cspan class=\"s1\"\u003e\u0026#39;icmp\u0026#39;\u003c/span\u003e\ntcpdump: WARNING: mirror0-output: no IPv4 address assigned\nlistening on mirror0-output, link-type EN10MB \u003cspan class=\"o\"\u003e(\u003c/span\u003eEthernet\u003cspan class=\"o\"\u003e)\u003c/span\u003e, capture size 65535 bytes\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eNo packets on both.\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2 id=\"32-generate-traffic\"\u003e3.2 Generate Traffic\u003c/h2\u003e\n\n\u003cp\u003eNow ping \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-2\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e192.168.1.4\u003c/code\u003e) from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-1\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e192.168.1.3\u003c/code\u003e), which will send\nICMP echo request and receive ICMP echo reply packets:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e ctn-1 sh\n\n/ \u003cspan class=\"c\"\u003e# ping 192.168.1.4\u003c/span\u003e\nPING 192.168.1.4 \u003cspan class=\"o\"\u003e(\u003c/span\u003e192.168.1.4\u003cspan class=\"o\"\u003e)\u003c/span\u003e: 56 data bytes\n64 bytes from 192.168.1.4: \u003cspan class=\"nb\"\u003eseq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.460 ms\n64 bytes from 192.168.1.4: \u003cspan class=\"nb\"\u003eseq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.079 ms\n64 bytes from 192.168.1.4: \u003cspan class=\"nb\"\u003eseq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.084 ms\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eOutput of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evnic-1\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e$ ip netns exec 21580 tcpdump -n -i vnic-1 \u0026#39;icmp\u0026#39;\n14:55:01.011274 IP 192.168.1.3 \u0026gt; 192.168.1.4: ICMP echo request, id 5376, seq 0, length 64\n14:55:01.011567 IP 192.168.1.4 \u0026gt; 192.168.1.3: ICMP echo reply, id 5376, seq 0, length 64\n14:55:02.011385 IP 192.168.1.3 \u0026gt; 192.168.1.4: ICMP echo request, id 5376, seq 1, length 64\n14:55:02.011551 IP 192.168.1.4 \u0026gt; 192.168.1.3: ICMP echo reply, id 5376, seq 1, length 64\n14:55:03.011490 IP 192.168.1.3 \u0026gt; 192.168.1.4: ICMP echo request, id 5376, seq 2, length 64\n14:55:03.011537 IP 192.168.1.4 \u0026gt; 192.168.1.3: ICMP echo reply, id 5376, seq 2, length 64\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eOutput of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emirror0-output\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpdump \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e mirror0-output \u003cspan class=\"s1\"\u003e\u0026#39;icmp\u0026#39;\u003c/span\u003e\n14:55:01.011467 IP 192.168.1.3 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 192.168.1.4: ICMP \u003cspan class=\"nb\"\u003eecho \u003c/span\u003erequest, \u003cspan class=\"nb\"\u003eid \u003c/span\u003e5376, \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e0, length 64\n14:55:02.011529 IP 192.168.1.3 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 192.168.1.4: ICMP \u003cspan class=\"nb\"\u003eecho \u003c/span\u003erequest, \u003cspan class=\"nb\"\u003eid \u003c/span\u003e5376, \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e1, length 64\n14:55:03.011506 IP 192.168.1.3 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 192.168.1.4: ICMP \u003cspan class=\"nb\"\u003eecho \u003c/span\u003erequest, \u003cspan class=\"nb\"\u003eid \u003c/span\u003e5376, \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e2, length 64\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003eAs we expected, only the egress traffic ov \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-1\u003c/code\u003e get mirrored to the output port.\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eIf you chose \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eingress\u003c/code\u003e or \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eboth\u003c/code\u003e in Section 3.2, results will be diffrent accordingly.\u003c/p\u003e\n\n\u003ch2 id=\"33-performance-test\"\u003e3.3 Performance Test\u003c/h2\u003e\n\n\u003cp\u003eThe ICMP traffic we generated here is just used to verify the mirror works.\u003c/p\u003e\n\n\u003cp\u003eTo do performance benchmark, you should consider more powerful traffic\ngenerating tools, e.g. \u003ca href=\"https://iperf.fr/iperf-download.php\"\u003eiperf3\u003c/a\u003e, \u003ca href=\"https://pktgen-dpdk.readthedocs.io/en/latest/\"\u003ePktgen-DPDK\u003c/a\u003e.\nOr, if you would like to replay a captured traffic, which may come from real environments,\nconsider \u003ca href=\"https://tcpreplay.appneta.com\"\u003etcprelay\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eQuick Commands:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# send 100 packets\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpreplay \u003cspan class=\"nt\"\u003e--limit\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e100 \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth1 test.pcap\n\n\u003cspan class=\"c\"\u003e# loop 10 times, 2x faster\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpreplay \u003cspan class=\"nt\"\u003e--loop\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10 \u003cspan class=\"nt\"\u003e-x\u003c/span\u003e 2 \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth1 test.pcap\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"34-add-more-traffic-source\"\u003e3.4 Add More Traffic Source\u003c/h2\u003e\n\n\u003cp\u003eSeveral ports may be mirrored to the same output, for example, to add \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evnic-2\u003c/code\u003e’s\negress to the mirror:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-traffic-source.sh mirror0 vnic-2 egress\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./list-mirror.sh\n_uuid               : 762fe791-bf4a-4180-b0f8-d22627d3970f\nname                : \u003cspan class=\"s2\"\u003e\u0026#34;mirror0\u0026#34;\u003c/span\u003e\noutput_port         : d74a2e7e-5d66-4a48-9261-7d080444964f\nselect_all          : \u003cspan class=\"nb\"\u003efalse\n\u003c/span\u003eselect_dst_port     : \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\nselect_src_port     : \u003cspan class=\"o\"\u003e[\u003c/span\u003e29a6d786-5ad2-4e8a-afdb-2f099fbe0de1, e1ba2b63-f492-4f88-8c3e-e6fcb22c0008]\nstatistics          : \u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003etx_bytes\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e448, \u003cspan class=\"nv\"\u003etx_packets\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e7\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"34-cleanup\"\u003e3.4 Cleanup\u003c/h2\u003e\n\n\u003cp\u003eDelete all mirrors on a bridge, run:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./del-mirrors.sh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eDelete output port:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e$ ovs-vsctl del-port mirror0-output\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"4-summary\"\u003e4 Summary\u003c/h1\u003e\n\n\u003cp\u003eIn this post, we showed how to implement a simply traffic mirror environment\nwith OVS port mirroring function.\u003c/p\u003e\n\n\u003cp\u003e2021 Update: new post\n\u003ca href=\"/blog/traffic-mirror-with-tc-and-tunneling/\"\u003eTraffic Mirroring: Theory and Practice (with tc and Tunneling)\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"references\"\u003eReferences\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Port_mirroring\"\u003eWikipedia: Port Mirroring\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"\"\u003eOpenvSwitch\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://backreference.org/2014/06/17/port-mirroring-with-linux-bridges/\"\u003ePort mirroring with Linux bridges\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/play-with-container-network-if/\"\u003ePlay With Container Network Interface\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"http://docs.openvswitch.org/en/latest/faq/configuration/\"\u003eOVS FAQ: Port Mirroring\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://tcpreplay.appneta.com\"\u003eTool: tcpreplay\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://pktgen-dpdk.readthedocs.io/en/latest/\"\u003ePktgen-DPDK\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://iperf.fr/iperf-download.php\"\u003eiperf3\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"appendix-a-setup-environment\"\u003eAppendix A: Setup Environment\u003c/h1\u003e\n\n\u003cp\u003eCreate OVS Bridge:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl add-br br-int\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWith simple scripts from \u003ca href=\"/blog/play-with-container-network-if/\"\u003ePlay With Container Network Interface\u003c/a\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edocker run \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e ctn-1 library/alpine:3.5 \u003cspan class=\"nb\"\u003esleep \u003c/span\u003e3600d\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edocker run \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e ctn-2 library/alpine:3.5 \u003cspan class=\"nb\"\u003esleep \u003c/span\u003e3600d\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./expose-netns.sh ctn-1\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./expose-netns.sh ctn-2\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eip netns\n21978 \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e: 18\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n21580 \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eid\u003c/span\u003e: 17\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-nic.sh ctn-1 vnic-1 br-int\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./add-nic.sh ctn-2 vnic-2 br-int\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eip netns \u003cspan class=\"nb\"\u003eexec \u003c/span\u003e21580 ifconfig vnic-1 192.168.1.3 netmask 255.255.255.0 up\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eip netns \u003cspan class=\"nb\"\u003eexec \u003c/span\u003e21978 ifconfig vnic-2 192.168.1.4 netmask 255.255.255.0 up\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eCheck:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl show\n    Bridge \u003cspan class=\"s2\"\u003e\u0026#34;br-int\u0026#34;\u003c/span\u003e\n        ...\n        Port \u003cspan class=\"s2\"\u003e\u0026#34;vnic-1\u0026#34;\u003c/span\u003e\n            Interface \u003cspan class=\"s2\"\u003e\u0026#34;vnic-1\u0026#34;\u003c/span\u003e\n                \u003cspan class=\"nb\"\u003etype\u003c/span\u003e: internal\n        Port \u003cspan class=\"s2\"\u003e\u0026#34;vnic-2\u0026#34;\u003c/span\u003e\n            Interface \u003cspan class=\"s2\"\u003e\u0026#34;vnic-2\u0026#34;\u003c/span\u003e\n                \u003cspan class=\"nb\"\u003etype\u003c/span\u003e: internal\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"appendix-b-scripts-used-in-this-article\"\u003eAppendix B: Scripts Used In This Article\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/add-mirror.sh\"\u003eadd-mirror.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/add-port.sh\"\u003eadd-port.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/add-traffic-source.sh\"\u003eadd-traffic-source.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/del-mirrors.sh\"\u003edel-mirrors.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/del-mirror.sh\"\u003edel-mirror.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/del-port.sh\"\u003edel-port.sh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/traffic-mirror-with-ovs/list-mirror.sh\"\u003elist-mirror.sh\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/play-with-container-network-if/\"\u003e\u003cspan\u003e« Play With Container Network Interface\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/monitoring-hub/\"\u003e\u003cspan\u003eMonitoring Docker Registry »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2018-11-10T00:00:00Z",
  "Author": "Arthur Chiao"
}