{
  "Source": "arthurchiao.art",
  "Title": "Monitoring Linux Network Stack",
  "Link": "https://arthurchiao.art/blog/monitoring-network-stack/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eMonitoring Linux Network Stack\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2020-04-25 | Last Update 2022-07-02\u003c/p\u003e\n  \n  \u003cp\u003eThis post shows how to collecte metrics from your Linux network stack (with\nbash scripts), and monitoring the stack status with Prometheus and Grafana.\u003c/p\u003e\n\n\u003cp\u003eThis post assumes you have read through the following posts (kernel 3.13 + intel 1Gbps NIC driver):\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://blog.packagecloud.io/eng/2016/06/22/monitoring-tuning-linux-networking-stack-receiving-data/\"\u003eMonitoring and Tuning the Linux Networking Stack: Receiving Data\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://blog.packagecloud.io/eng/2017/02/06/monitoring-tuning-linux-networking-stack-sending-data\"\u003eMonitoring and Tuning the Linux Networking Stack: Sending Data\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eOr my updated versions (kernel 5.10 + mellanox 25Gbps NIC driver) if you can read Chinese:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/blog/linux-net-stack-zh/\"\u003eLinux 网络栈原理、监控与调优：前言\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/linux-irq-softirq-zh/\"\u003eLinux 中断（IRQ/softirq）基础：原理及内核实现\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/linux-net-stack-implementation-rx-zh/\"\u003eLinux 网络栈接收数据（RX）：原理及内核实现\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/linux-net-stack-tuning-rx-zh/\"\u003eLinux 网络栈接收数据（RX）：配置调优\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eBesides, some basic understandings of Prometheus and Grafana are needed.\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-nic\" id=\"markdown-toc-1-nic\"\u003e1. NIC\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-data-sources\" id=\"markdown-toc-11-data-sources\"\u003e1.1 Data sources\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#ethtool--s\" id=\"markdown-toc-ethtool--s\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eethtool -S\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#procnetdev\" id=\"markdown-toc-procnetdev\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/dev\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#sysclassnetnicstatistics\" id=\"markdown-toc-sysclassnetnicstatistics\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/class/net/\u0026lt;nic\u0026gt;/statistics\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-metrics\" id=\"markdown-toc-12-metrics\"\u003e1.2 Metrics\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-panels\" id=\"markdown-toc-13-panels\"\u003e1.3 Panels\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-hardware-interrupts\" id=\"markdown-toc-2-hardware-interrupts\"\u003e2. Hardware Interrupts\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-data-source-procinterrupts\" id=\"markdown-toc-21-data-source-procinterrupts\"\u003e2.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/interrupts\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-metric\" id=\"markdown-toc-22-metric\"\u003e2.2 Metric\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-panels\" id=\"markdown-toc-23-panels\"\u003e2.3 Panels\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-software-interrupts-softirq\" id=\"markdown-toc-3-software-interrupts-softirq\"\u003e3. Software Interrupts (softirq)\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-data-source-procsoftirqs\" id=\"markdown-toc-31-data-source-procsoftirqs\"\u003e3.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/softirqs\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-metric\" id=\"markdown-toc-32-metric\"\u003e3.2 Metric\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-panels\" id=\"markdown-toc-33-panels\"\u003e3.3 Panels\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-kernel-processing-drops\" id=\"markdown-toc-4-kernel-processing-drops\"\u003e4. Kernel Processing Drops\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-data-source-procnetsoftnet_stat\" id=\"markdown-toc-41-data-source-procnetsoftnet_stat\"\u003e4.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/softnet_stat\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-metric\" id=\"markdown-toc-42-metric\"\u003e4.2 Metric\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-panel\" id=\"markdown-toc-43-panel\"\u003e4.3 Panel\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-l3-statistics-ipv4\" id=\"markdown-toc-5-l3-statistics-ipv4\"\u003e5. L3 statistics (IPv4)\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-data-source-procnetsnmp\" id=\"markdown-toc-51-data-source-procnetsnmp\"\u003e5.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/snmp\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-l4-statistics-tcp\" id=\"markdown-toc-6-l4-statistics-tcp\"\u003e6. L4 statistics (TCP)\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-data-source\" id=\"markdown-toc-61-data-source\"\u003e6.1 Data source\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#62-metric\" id=\"markdown-toc-62-metric\"\u003e6.2 Metric\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#63-panel\" id=\"markdown-toc-63-panel\"\u003e6.3 Panel\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#7-l4-statistics-udp\" id=\"markdown-toc-7-l4-statistics-udp\"\u003e7. L4 statistics (UDP)\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#71-data-source\" id=\"markdown-toc-71-data-source\"\u003e7.1 Data source\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#procnetsnmp\" id=\"markdown-toc-procnetsnmp\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/snmp\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#procnetudp\" id=\"markdown-toc-procnetudp\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/udp\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#8-top-n-nodes\" id=\"markdown-toc-8-top-n-nodes\"\u003e8. Top N nodes\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#9-more-metrics\" id=\"markdown-toc-9-more-metrics\"\u003e9. More metrics\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#appendix\" id=\"markdown-toc-appendix\"\u003eAppendix\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-net-stack/rx-overview.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Steps of Linux kernel receiving data process and the corresponding chapters in this post\u003c/p\u003e\n\n\u003ch1 id=\"1-nic\"\u003e1. NIC\u003c/h1\u003e\n\n\u003ch2 id=\"11-data-sources\"\u003e1.1 Data sources\u003c/h2\u003e\n\n\u003ch3 id=\"ethtool--s\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eethtool -S\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003eethtool \u003cspan class=\"nt\"\u003e-S\u003c/span\u003e eth0\nNIC statistics:\n     rx_packets: 597028087\n     tx_packets: 5924278060\n     rx_bytes: 112643393747\n     tx_bytes: 990080156714\n     rx_broadcast: 96\n     tx_broadcast: 116\n     rx_multicast: 20294528\n     ....\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNote that depending on specific NICs/drivers, some of the metrics may be\nupdated in the kernel code (software), some may be in hardware.  Refer to the\ndatasheets of the your NICs and the corresponding drivers if needed.\u003c/p\u003e\n\n\u003ch3 id=\"procnetdev\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/dev\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/dev\u003c/code\u003e also provides some network device level statistics:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/dev\nInter-|   Receive                                                |  Transmit\n face |bytes    packets errs drop fifo frame compressed multicast|bytes  packets errs drop fifo colls carrier compressed\n  eth0: 152214  9700    0    2    0     0          0    203860 9905984   62604    0    0    0     0       0          0\n    lo: 463836  57535   0    0    0     0          0         0 4263836   18535    0    0    0     0       0          0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eActually this is only a subnet of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/class/net/\u0026lt;nic\u0026gt;/statistics\u003c/code\u003e, as introduced in the\nbelow section.\u003c/p\u003e\n\n\u003ch3 id=\"sysclassnetnicstatistics\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/class/net/\u0026lt;nic\u0026gt;/statistics\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eStatistics from sysfs provides an uppper layer view of the NIC RX/TX stats.\u003c/p\u003e\n\n\u003cp\u003eNIC stats from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/class/net/\u0026lt;nic\u0026gt;/statistics\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e /sys/class/net/eth0/statistics\ncollisions     rx_dropped        rx_missed_errors   tx_bytes           tx_fifo_errors\nmulticast      rx_errors         rx_nohandler       tx_carrier_errors  tx_heartbeat_errors\nrx_bytes       rx_fifo_errors    rx_over_errors     tx_compressed      tx_packets\nrx_compressed  rx_frame_errors   rx_packets         tx_dropped         tx_window_errors\nrx_crc_errors  rx_length_errors  tx_aborted_errors  tx_errors\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /sys/class/net/eth0/statistics/rx_crc_errors\n0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAgain, look into the spcific driver code if you’d like to ensure when and where a specific counter is updated.\u003c/p\u003e\n\n\u003ch2 id=\"12-metrics\"\u003e1.2 Metrics\u003c/h2\u003e\n\n\u003cp\u003eWe will arrange our metrics in \u003ca href=\"https://prometheus.io/docs/concepts/data_model/\"\u003ePrometheus format\u003c/a\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat \u003c/span\u003ecollect-network-stats.sh\n\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003ePREFIX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;network\u0026#34;\u003c/span\u003e\n\nnic_stats_output\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eNIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_nic_stats\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor \u003c/span\u003ef \u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e /sys/class/net/\u003cspan class=\"nv\"\u003e$NIC\u003c/span\u003e/statistics/\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\n        \u003c/span\u003e\u003cspan class=\"nv\"\u003eTAGS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;{\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003enic\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$NIC\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e,\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003etype\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$f\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nv\"\u003eVAL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /sys/class/net/\u003cspan class=\"nv\"\u003e$NIC\u003c/span\u003e/statistics/\u003cspan class=\"nv\"\u003e$f\u003c/span\u003e 2\u0026gt;/dev/null\u003cspan class=\"si\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$METRIC$TAGS\u003c/span\u003e \u003cspan class=\"nv\"\u003e$VAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nnic_stats_output eth0\nnic_stats_output eth1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eTest:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./collect-network-stats.sh\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;collisions\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;multicast\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 17775912\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;rx_bytes\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 322700688616\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;rx_compressed\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;rx_crc_errors\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;rx_dropped\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;nic\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0\u0026#34;\u003c/span\u003e,\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;rx_errors\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"13-panels\"\u003e1.3 Panels\u003c/h2\u003e\n\n\u003cp\u003ePush the metrics into your prometheus server, or, configure your prometheus to\npull this data, we could create a panel like this:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/nic-stats.png\" width=\"95%\" height=\"95%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eWhere, the Grafane query is:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_nic_stats\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"k\"\u003e*\u003c/span\u003e60\u003cspan class=\"o\"\u003e)\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003enic, \u003cspan class=\"nb\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNote that our collecting agent automatically added a new tag \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehost=\u0026lt;hostname\u0026gt;\u003c/code\u003e\nto all the metrics, so we could filter the metrics with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehost=\u0026#34;$hostname\u0026#34;\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"2-hardware-interrupts\"\u003e2. Hardware Interrupts\u003c/h1\u003e\n\n\u003ch2 id=\"21-data-source-procinterrupts\"\u003e2.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/interrupts\u003c/code\u003e)\u003c/h2\u003e\n\n\u003cp\u003eInformation included:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eIRQ-\u0026gt;CPU mapping\u003c/li\u003e\n  \u003cli\u003eTotal count of specific interrupts (e.g. RX/TX interrupts, timer interrupts), on specific CPU\u003c/li\u003e\n  \u003cli\u003eIRQ handler type and name\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eNote that these are interrupt counts, not number of packets - for example, if\nInterrupt Coalescing is enabled, a batch of packets will trigger only one IRQ.\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/interrupts\n         CPU0     CPU1       CPU2     ...    CPU30    CPU31\n ...\n\n 139:       0        0          0     ...        0        0  IR-PCI-MSI 1572864-edge      eth0-tx-0\n 140:       0        0          0     ...        0        0  IR-PCI-MSI 1572865-edge      eth0-rx-1\n 141:       0        0          0     ...        0        0  IR-PCI-MSI 1572866-edge      eth0-rx-2\n 142:       0        0     308405     ...        0        0  IR-PCI-MSI 1572867-edge      eth0-rx-3\n 143:       0        0          0     ...        0        0  IR-PCI-MSI 1572868-edge      eth0-rx-4\n 144:       0        0          4     ...        0        0  IR-PCI-MSI 1574912-edge      eth1-tx-0\n 145:       0        0          0     ...        0        0  IR-PCI-MSI 1574913-edge      eth1-rx-1\n 146:       0       38        673     ...        0        0  IR-PCI-MSI 1574914-edge      eth1-rx-2\n 147:       0    75604          0     ...        0        0  IR-PCI-MSI 1574915-edge      eth1-rx-3\n 148:       0     3086     824199     ...        0        0  IR-PCI-MSI 1574916-edge      eth1-rx-4\n ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"22-metric\"\u003e2.2 Metric\u003c/h2\u003e\n\n\u003cp\u003eAdd this code snippet to our script:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003einterrupts_output\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003ePATTERN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_interrupts_by_cpu\u0026#34;\u003c/span\u003e\n\n    egrep \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATTERN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e /proc/interrupts | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nv\"\u003emetric\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$METRIC\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"s1\"\u003e\u0026#39;{ for (i=2;i\u0026lt;=NF-3;i++) sum[i]+=$i;}\n         END {\n               for (i=2;i\u0026lt;=NF-3; i++) {\n                   tags=sprintf(\u0026#34;{\\\u0026#34;cpu\\\u0026#34;:\\\u0026#34;%d\\\u0026#34;}\u0026#34;, i-2);\n                   printf(metric tags \u0026#34; \u0026#34; sum[i] \u0026#34;\\n\u0026#34;);\n               }\n         }\u0026#39;\u003c/span\u003e\n\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_interrupts_by_queue\u0026#34;\u003c/span\u003e\n    egrep \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATTERN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e /proc/interrupts | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nv\"\u003emetric\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$METRIC\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n        \u003cspan class=\"s1\"\u003e\u0026#39;{ for (i=2;i\u0026lt;=NF-3; i++)\n               sum+=$i;\n               tags=sprintf(\u0026#34;{\\\u0026#34;queue\\\u0026#34;:\\\u0026#34;%s\\\u0026#34;}\u0026#34;, $NF);\n               printf(metric tags \u0026#34; \u0026#34; sum \u0026#34;\\n\u0026#34;);\n               sum=0;\n         }\u0026#39;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# interface patterns\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# eth: intel\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# mlx: mellanox\u003c/span\u003e\ninterrupts_output \u003cspan class=\"s2\"\u003e\u0026#34;eth|mlx\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./collect-network-stats.sh\nnetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 6078192\nnetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;2\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 85118785\n...\nnetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;queue\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0-tx-0\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 190533384\nnetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;queue\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0-rx-1\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 26873848\nnetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;queue\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0-rx-2\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 23715431\nnetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;queue\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth0-rx-3\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 87702361\n...\nnetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;queue\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;eth1-rx-4\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 3119407\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"23-panels\"\u003e2.3 Panels\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/interrupts.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e~\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}))\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003ecpu\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_interrupts_by_queue\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e~\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}))\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003equeue\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"3-software-interrupts-softirq\"\u003e3. Software Interrupts (softirq)\u003c/h1\u003e\n\n\u003ch2 id=\"31-data-source-procsoftirqs\"\u003e3.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/softirqs\u003c/code\u003e)\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/softirqs\n                    CPU0       CPU1    ...      CPU62      CPU63\n          HI:          1          0    ...         0          0\n       TIMER:   20378862    2149097    ...         0          0\n      NET_TX:          5          1    ...         0          0\n      NET_RX:       1179       1868    ...         0          0\n       BLOCK:      88034      33007    ...         0          0\n    IRQ_POLL:          0          0    ...         0          0\n     TASKLET:         22          0    ...         0          0\n       SCHED:   13906041    1474443    ...         0          0\n     HRTIMER:          0          0    ...         0          0\n         RCU:   12121418    1964562    ...         0          0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"32-metric\"\u003e3.2 Metric\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003esoftirqs_output\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_softirqs\u0026#34;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor \u003c/span\u003e\u003cspan class=\"nb\"\u003edir \u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;NET_TX\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\n        \u003c/span\u003e\u003cspan class=\"nb\"\u003egrep\u003c/span\u003e \u003cspan class=\"nv\"\u003e$dir\u003c/span\u003e /proc/softirqs | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nv\"\u003emetric\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$METRIC\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nb\"\u003edir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$dir\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n            \u003cspan class=\"s1\"\u003e\u0026#39;{ for (i=2;i\u0026lt;=NF-1;i++) {\n                   tags=sprintf(\u0026#34;{\\\u0026#34;cpu\\\u0026#34;:\\\u0026#34;%d\\\u0026#34;, \\\u0026#34;direction\\\u0026#34;: \\\u0026#34;%s\\\u0026#34;}\u0026#34;, i-2, dir); \\\n                   printf(metric tags \u0026#34; \u0026#34; $i \u0026#34;\\n\u0026#34;); \\\n               }\n             }\u0026#39;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nsoftirqs_output\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./collect-network-stats.sh\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 196082\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 119888284\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;2\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 189840914\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;3\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 114621858\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;4\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 1453599\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;5\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 192694791\nnetwork_softirqs\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;6\u0026#34;\u003c/span\u003e, \u003cspan class=\"s2\"\u003e\u0026#34;direction\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 49328487\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"33-panels\"\u003e3.3 Panels\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/softirqs.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eGrafana queries:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e,direction\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;NET_RX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}))\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003ecpu\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_interrupts_by_cpu\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e,direction\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;NET_TX\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}))\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003ecpu\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"4-kernel-processing-drops\"\u003e4. Kernel Processing Drops\u003c/h1\u003e\n\n\u003ch2 id=\"41-data-source-procnetsoftnet_stat\"\u003e4.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/softnet_stat\u003c/code\u003e)\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/softnet_stat\n00049007 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n074c3e6e 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n0c98d81b 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n07212d42 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n0018ad7c 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n00037314 00000000 00000002 00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"42-metric\"\u003e4.2 Metric\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003esoftnet_stat_output\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eTYP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eIDX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\n\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_softnet_stat\u0026#34;\u003c/span\u003e\n\n    \u003cspan class=\"nv\"\u003eVAL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/softnet_stat | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nv\"\u003eIDX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$IDX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{sum+=strtonum(\u0026#34;0x\u0026#34;$IDX);} END{print sum;}\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eTAGS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;{\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003etype\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYP\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$METRIC$TAGS\u003c/span\u003e \u003cspan class=\"nv\"\u003e$VAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# Format of /proc/net/softnet_stat:\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 1  : received frames\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 2  : dropped\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 3  : time_squeeze\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 4-8: all zeros\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 9  : cpu_collision\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 10 : received_rps\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# column 11 : flow_limit_count\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# http://arthurchiao.art/blog/tuning-stack-rx-zh/\u003c/span\u003e\nsoftnet_stat_output \u003cspan class=\"s2\"\u003e\u0026#34;dropped\u0026#34;\u003c/span\u003e 2\nsoftnet_stat_output \u003cspan class=\"s2\"\u003e\u0026#34;time_squeeze\u0026#34;\u003c/span\u003e 3\nsoftnet_stat_output \u003cspan class=\"s2\"\u003e\u0026#34;cpu_collision\u0026#34;\u003c/span\u003e 9\nsoftnet_stat_output \u003cspan class=\"s2\"\u003e\u0026#34;received_rps\u0026#34;\u003c/span\u003e 10\nsoftnet_stat_output \u003cspan class=\"s2\"\u003e\u0026#34;flow_limit_count\u0026#34;\u003c/span\u003e 11\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eRun:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./collect-network-stats.sh\nnetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;dropped\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;time_squeeze\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 4\nnetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;cpu_collision\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;received_rps\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\nnetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;flow_limit_count\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"43-panel\"\u003e4.3 Panel\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/kernel-drops.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eGrafana queries:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_softnet_stat\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}))\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"5-l3-statistics-ipv4\"\u003e5. L3 statistics (IPv4)\u003c/h1\u003e\n\n\u003ch2 id=\"51-data-source-procnetsnmp\"\u003e5.1 Data source (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/snmp\u003c/code\u003e)\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/snmp\nIp: Forwarding DefaultTTL InReceives InHdrErrors InAddrErrors ForwDatagrams InUnknownProtos InDiscards InDelivers OutRequests OutDiscards OutNoRoutes ReasmTimeout ReasmReqds ReasmOKs ReasmFails FragOKs FragFails FragCreates\nIp: 1 64 25922988125 0 0 15771700 0 0 25898327616 22789396404 12987882 51 1 10129840 2196520 1 0 0 0\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFields:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// https://github.com/torvalds/linux/blob/v5.10/include/uapi/linux/snmp.h#L21\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* ipstats mib definitions */\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eIPSTATS_MIB_NUM\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eIPSTATS_MIB_INPKTS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e       \u003cspan class=\"cm\"\u003e/* InReceives */\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eIPSTATS_MIB_INOCTETS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e     \u003cspan class=\"cm\"\u003e/* InOctets */\u003c/span\u003e\n  \u003cspan class=\"n\"\u003eIPSTATS_MIB_INDELIVERS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e   \u003cspan class=\"cm\"\u003e/* InDelivers */\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"6-l4-statistics-tcp\"\u003e6. L4 statistics (TCP)\u003c/h1\u003e\n\n\u003ch2 id=\"61-data-source\"\u003e6.1 Data source\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003enetstat \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e\nIp:\n    397147220 total packets received\n    621 with invalid headers\n    1 with invalid addresses\n    16591642 forwarded\n...\nTcp:\n    53687405 active connections openings\n    449771 passive connection openings\n    52888864 failed connection attempts\n    66565 connection resets received\n...\nTcpExt:\n    18 ICMP packets dropped because they were out-of-window\n    4 ICMP packets dropped because socket was locked\n    643745 TCP sockets finished \u003cspan class=\"nb\"\u003etime wait \u003c/span\u003e\u003cspan class=\"k\"\u003ein \u003c/span\u003efast timer\n    8 packets rejects \u003cspan class=\"k\"\u003ein \u003c/span\u003eestablished connections because of timestamp\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"62-metric\"\u003e6.2 Metric\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003enetstat_output\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003ePATTERN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eARG_IDX\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\n\n    \u003cspan class=\"nv\"\u003eMETRIC\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PREFIX\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;_tcp\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eVAL\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003enetstat \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATTERN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"nt\"\u003e-v\u003c/span\u003e \u003cspan class=\"nv\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$ARG_IDX\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;{print $i}\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e# generate \u0026#34;type\u0026#34; string with prefix and pattern\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e#\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e# 1. replace whitespaces with underlines\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e# 2. remove trailing dollar symbol (\u0026#39;$\u0026#39;) if there is\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e#\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e# e.g. \u0026#34;fast retransmits$\u0026#34; -\u0026gt; \u0026#34;fast_retransmits\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e#\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eTYP\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$PATTERN\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e | \u003cspan class=\"nb\"\u003etr\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;_\u0026#39;\u003c/span\u003e | \u003cspan class=\"nb\"\u003esed\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;s/\\$//g\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"nv\"\u003eTAGS\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;{\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003etype\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$TYP\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e}\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$METRIC$TAGS\u003c/span\u003e \u003cspan class=\"nv\"\u003e$VAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;segments retransmited\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;TCPLostRetransmit\u0026#34;\u003c/span\u003e 2\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;fast retransmits$\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;retransmits in slow start\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;classic Reno fast retransmits failed\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;TCPSynRetrans\u0026#34;\u003c/span\u003e 2\n\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;bad segments received\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;resets sent$\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;connection resets received$\u0026#34;\u003c/span\u003e 1\n\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;connections reset due to unexpected data$\u0026#34;\u003c/span\u003e 1\nnetstat_output \u003cspan class=\"s2\"\u003e\u0026#34;connections reset due to early user close$\u0026#34;\u003c/span\u003e 1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eRun:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./collect-network-stats.sh\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;segments_retransmited\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 618183\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;TCPLostRetransmit\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 133668\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;fast_retransmits\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 45745\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;retransmits_in_slow_start\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 62977\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;classic_Reno_fast_retransmits_failed\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 418\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;TCPSynRetrans\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 175919\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;bad_segments_received\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 399\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;resets_sent\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 234094\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;connection_resets_received\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 66553\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;connections_reset_due_to_unexpected_data\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 93589\nnetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"s2\"\u003e\u0026#34;connections_reset_due_to_early_user_close\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e 6522\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"63-panel\"\u003e6.3 Panel\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/tcp-stats.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eGrafana queries:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eavg\u003cspan class=\"o\"\u003e(\u003c/span\u003eirate\u003cspan class=\"o\"\u003e(\u003c/span\u003enetwork_tcp\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"nv\"\u003ehost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$hostname\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e})\u003c/span\u003e\u003cspan class=\"k\"\u003e*\u003c/span\u003e60\u003cspan class=\"o\"\u003e)\u003c/span\u003e by \u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003etype\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"7-l4-statistics-udp\"\u003e7. L4 statistics (UDP)\u003c/h1\u003e\n\n\u003ch2 id=\"71-data-source\"\u003e7.1 Data source\u003c/h2\u003e\n\n\u003ch3 id=\"procnetsnmp\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/snmp\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/snmp\n...\nUdp: InDatagrams NoPorts InErrors OutDatagrams RcvbufErrors SndbufErrors InCsumErrors IgnoredMulti\nUdp: 3251496 356 0 3251774 0 0 0 0\nUdpLite: InDatagrams NoPorts InErrors OutDatagrams RcvbufErrors SndbufErrors InCsumErrors IgnoredMulti\nUdpLite: 0 0 0 0 0 0 0 0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"procnetudp\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/net/udp\u003c/code\u003e\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/net/udp\n  sl  local_address rem_address   st tx_queue rx_queue \u003cspan class=\"nb\"\u003etr \u003c/span\u003etm-\u0026gt;when retrnsmt   uid  \u003cspan class=\"nb\"\u003etimeout \u003c/span\u003einode ref pointer drops\n52544: 3F40160A:007B 00000000:0000 07 00000000:00000000 00:00000000 00000000    38        0 190750 2 000000009f44ff46 0\n52544: 016C000A:007B 00000000:0000 07 00000000:00000000 00:00000000 00000000    38        0 85972 2 00000000ab7f749c 0\n52544: 7136060A:007B 00000000:0000 07 00000000:00000000 00:00000000 00000000    38        0 59580 2 000000004c64a4a4 0\n52544: 0100007F:007B 00000000:0000 07 00000000:00000000 00:00000000 00000000     0        0 55725 2 0000000051afcbdd 0\n52544: 00000000:007B 00000000:0000 07 00000000:00000000 00:00000000 00000000     0        0 55719 2 000000008c653c2d 0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe first line describes each of the fields in the lines following:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esl\u003c/code\u003e: Kernel hash slot for the socket\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elocal_address\u003c/code\u003e: Hexadecimal local address of the socket and port number, separated by :.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erem_address\u003c/code\u003e: Hexadecimal remote address of the socket and port number, separated by :.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003est\u003c/code\u003e: The state of the socket. Oddly enough, the UDP protocol layer seems to use some TCP socket states. In the example above, 7 is TCP_CLOSE.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etx_queue\u003c/code\u003e: The amount of memory allocated in the kernel for outgoing UDP datagrams.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erx_queue\u003c/code\u003e: The amount of memory allocated in the kernel for incoming UDP datagrams.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etr\u003c/code\u003e, tm-\u0026gt;when, retrnsmt: These fields are unused by the UDP protocol layer.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003euid\u003c/code\u003e: The effective user id of the user who created this socket.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etimeout\u003c/code\u003e: Unused by the UDP protocol layer.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003einode\u003c/code\u003e: The inode number corresponding to this socket. You can use this to help you determine which user process has this socket open. Check /proc/[pid]/fd, which will contain symlinks to socket[:inode].\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eref\u003c/code\u003e: The current reference count for the socket.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003epointer\u003c/code\u003e: The memory address in the kernel of the struct sock.\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrops\u003c/code\u003e: The number of datagram drops associated with this socket. Note that this does not include any drops related to sending datagrams (on corked UDP sockets or otherwise); this is only incremented in receive paths as of the kernel version examined by this blog post.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003ePrinting code: \u003ca href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/udp.c\"\u003enet/ipv4/udp.c\u003c/a\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"8-top-n-nodes\"\u003e8. Top N nodes\u003c/h1\u003e\n\n\u003cp\u003eTop-N nodes for some specific metrics:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/top-n-nodes.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eThis is quite helpful for detecting problematic nodes.\u003c/p\u003e\n\n\u003cp\u003eQueries for these panels are very similar, we list some here:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etopk(10, avg(irate(k8s.node.network.tcp{type=\u0026#34;segments_retransmited\u0026#34;})*60) by (host))\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etopk(10, avg(irate(k8s.node.network.tcp{type=\u0026#34;TCPSynRetrans\u0026#34;})*60) by (host))\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etopk(10, avg(irate(k8s.node.network.nic.errors{type=~\u0026#39;rx_.*\u0026#39;})*60) by (host))\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etopk(10, avg(irate(k8s.node.network.nic.errors{type=~\u0026#39;tx_.*\u0026#39;})*60) by (host))\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"9-more-metrics\"\u003e9. More metrics\u003c/h1\u003e\n\n\u003cp\u003eThis post serves as a introductory guide for how to monitoring you network\nstack with Prometheus and Grafana.\u003c/p\u003e\n\n\u003cp\u003eActually there are more metrics than we have shown in the above, such as, you\ncould monitor the NIC bandwidth with metrics from NIC statistics:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/monitoring-network-stack/nic-bw.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eBesides, you could also configure alerting rules on Grafana panels, e.g.\nalerting when NIC errors exceeds a pre defined threshold.\u003c/p\u003e\n\n\u003ch1 id=\"appendix\"\u003eAppendix\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/assets/img/monitoring-network-stack/collect-network-stats.sh\"\u003ecollect-network-stats.sh\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/k8s-l4lb/\"\u003e\u003cspan\u003e« L4LB for Kubernetes: Theory and Practice with Cilium+BGP+ECMP\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/linux-trouble-shooting-cheat-sheet/\"\u003e\u003cspan\u003eLinux Trouble Shooting Cheat Sheet »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2020-04-25T00:00:00Z",
  "Author": "Arthur Chiao"
}