{
  "Source": "arthurchiao.art",
  "Title": "JuiceFS 元数据引擎五探：元数据备份与恢复（2024）",
  "Link": "https://arthurchiao.art/blog/juicefs-metadata-deep-dive-5-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eJuiceFS 元数据引擎五探：元数据备份与恢复（2024）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2024-10-10 | Last Update 2024-10-10\u003c/p\u003e\n  \n  \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/br-and-tikv-backup.png\" width=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. TiKV backup with different CLI tools (and their problems).\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-1-zh/\"\u003eJuiceFS 元数据引擎初探：高层架构、引擎选型、读写工作流（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-2-zh/\"\u003eJuiceFS 元数据引擎再探：开箱解读 TiKV 中的 JuiceFS 元数据（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-3-zh/\"\u003eJuiceFS 元数据引擎三探：从实践中学习 TiKV 的 MVCC 和 GC（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-4-zh/\"\u003eJuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-5-zh/\"\u003eJuiceFS 元数据引擎五探：元数据备份与恢复（2024）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e水平及维护精力所限，文中不免存在错误或过时之处，请酌情参考。\n\u003cstrong\u003e\u003cmark\u003e传播知识，尊重劳动，年满十八周岁，转载请注明\u003ca href=\"https://arthurchiao.art\"\u003e出处\u003c/a\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-juicefs-元数据备份方式\" id=\"markdown-toc-1-juicefs-元数据备份方式\"\u003e1 JuiceFS 元数据备份方式\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-juicefs-自带方式volume-级别\" id=\"markdown-toc-2-juicefs-自带方式volume-级别\"\u003e2 JuiceFS 自带方式（volume 级别）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-juicefs-dump-手动备份-volume-metadata\" id=\"markdown-toc-21-juicefs-dump-手动备份-volume-metadata\"\u003e2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs dump\u003c/code\u003e 手动备份 volume metadata\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-juicefs-mount---backup-meta-duration-自动备份\" id=\"markdown-toc-22-juicefs-mount---backup-meta-duration-自动备份\"\u003e2.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount --backup-meta \u0026lt;duration\u0026gt;\u003c/code\u003e 自动备份\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-juicefs-load-从元数据备份文件恢复\" id=\"markdown-toc-23-juicefs-load-从元数据备份文件恢复\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs load\u003c/code\u003e 从元数据备份文件恢复\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-限制及问题\" id=\"markdown-toc-24-限制及问题\"\u003e2.4 限制及问题\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-从-tikv-层面对-juicefs-元数据进行备份\" id=\"markdown-toc-3-从-tikv-层面对-juicefs-元数据进行备份\"\u003e3 从 TiKV 层面对 JuiceFS 元数据进行备份\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-tikv-backuprestore-原理\" id=\"markdown-toc-31-tikv-backuprestore-原理\"\u003e3.1 TiKV backup/restore 原理\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-备份工具-tidb-br-和-tikv-tikv-br\" id=\"markdown-toc-32-备份工具-tidb-br-和-tikv-tikv-br\"\u003e3.2 备份工具 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 和 TiKV \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-br\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-基于-tidb-br-对-juicefs-tikv-集群进行备份与恢复的步骤\" id=\"markdown-toc-33-基于-tidb-br-对-juicefs-tikv-集群进行备份与恢复的步骤\"\u003e3.3 基于 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 对 JuiceFS TiKV 集群进行备份与恢复的步骤\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#34-tidb-br-备份逻辑\" id=\"markdown-toc-34-tidb-br-备份逻辑\"\u003e3.4 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 备份逻辑\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#341-runbackuptxn\" id=\"markdown-toc-341-runbackuptxn\"\u003e3.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRunBackupTxn()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#342-调用栈\" id=\"markdown-toc-342-调用栈\"\u003e3.4.2 调用栈\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#343-tikv-server-备份代码\" id=\"markdown-toc-343-tikv-server-备份代码\"\u003e3.4.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-server\u003c/code\u003e 备份代码\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-juicefs-元数据备份方式\"\u003e1 JuiceFS 元数据备份方式\u003c/h1\u003e\n\n\u003cp\u003e再复习下 JuiceFS 架构，如下图所示：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-tikv-cluster.png\" width=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS cluster initialization, and how POSIX file operations are handled by JuiceFS.\u003c/p\u003e\n\n\u003cp\u003eJuiceFS 的元数据都存储在\u003cstrong\u003e\u003cmark\u003e元数据引擎\u003c/mark\u003e\u003c/strong\u003e（例如，TiKV）里，\n因此元数据的备份有两种实现方式：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e从上层备份：JuiceFS client 扫描 volume，将 volume 内所有元数据备份；\u003c/li\u003e\n  \u003cli\u003e元数据引擎（例如 TiKV）备份。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e下面分别看看这两种方式。\u003c/p\u003e\n\n\u003ch1 id=\"2-juicefs-自带方式volume-级别\"\u003e2 JuiceFS 自带方式（volume 级别）\u003c/h1\u003e\n\n\u003ch2 id=\"21-juicefs-dump-手动备份-volume-metadata\"\u003e2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs dump\u003c/code\u003e 手动备份 volume metadata\u003c/h2\u003e\n\n\u003cp\u003e对指定 volume 进行备份，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ejuicefs dump tikv://ip:2379/foo-dev foo-dev-dump.json\n\u0026lt;INFO\u0026gt;: Meta address: tikv://\u0026lt;ip\u0026gt;:2379/foo-dev \u003cspan class=\"o\"\u003e[\u003c/span\u003einterface.go:406]\n\u0026lt;WARNING\u0026gt;: Secret key is removed \u003cspan class=\"k\"\u003efor \u003c/span\u003ethe sake of safety \u003cspan class=\"o\"\u003e[\u003c/span\u003etkv.go:2571]\n           Scan keys count: 357806 / 357806 \u003cspan class=\"o\"\u003e[===========================]\u003c/span\u003e  \u003cspan class=\"k\"\u003edone\n      \u003c/span\u003eDumped entries count: 122527 / 122527 \u003cspan class=\"o\"\u003e[===========================]\u003c/span\u003e  \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u0026lt;INFO\u0026gt;: Dump metadata into dump succeed \u003cspan class=\"o\"\u003e[\u003c/span\u003edump.go:76]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e生成的是一个 JSON 文件，包含了 volume 的所有元数据信息，\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Setting\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;foo-dev\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;UUID\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ca95c258\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Storage\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;OSS\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Bucket\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http://\u0026lt;url\u0026gt;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;AccessKey\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ak\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;BlockSize\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Capacity\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Inodes\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;MetaVersion\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;MinClientVersion\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;MaxClientVersion\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Counters\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;usedSpace\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e6164512768\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;usedInodes\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e5010\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;nextInodes\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e10402\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;nextChunk\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e25001\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;nextSession\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e118\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;FSTree\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;attr\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;inode\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;directory\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;mode\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e511\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;atime\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e1645791488\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;mtime\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e1652433235\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;ctime\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e1652433235\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;mtimensec\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e553010494\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;ctimensec\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e553010494\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;nlink\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;length\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;xattrs\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;lastBackup\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;value\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;2024-05-30T13:50:25+08:00\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e}],\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;entries\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;001eb8b\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;attr\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;chunks\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;index\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;slices\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:[{\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;chunkid\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e15931\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;size\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;len\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"mi\"\u003e32\u003c/span\u003e\u003cspan class=\"p\"\u003e}]}]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n   \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e其中，volume 中的所有文件和目录信息都描述在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFSTree\u003c/code\u003e 字段中。\u003c/p\u003e\n\n\u003ch2 id=\"22-juicefs-mount---backup-meta-duration-自动备份\"\u003e2.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount --backup-meta \u0026lt;duration\u0026gt;\u003c/code\u003e 自动备份\u003c/h2\u003e\n\n\u003cp\u003ejuicefs client 默认会自动备份 volume 的元数据，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e备份间隔通过 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e--backup-meta {duration}\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 选项控制，默认 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e1h\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e备份文件在对象存储的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003emeta\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 特殊目录中，该目录在挂载点中不可见，用对象存储的文件浏览器可以查看和管理，\u003c/li\u003e\n  \u003cli\u003e多 client 挂载同一个 volume 也不会发生备份冲突，因为 JuiceFS 维护了一个全局的时间戳，确保同一时刻只有一个客户端执行备份操作，但是，\u003c/li\u003e\n  \u003cli\u003e当文件数太多（默认达到 100w）且备份频率为默认值 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1h\u003c/code\u003e 时，为避免备份开销太大，JuiceFS 会\u003cstrong\u003e\u003cmark\u003e自动停止元数据备份\u003c/mark\u003e\u003c/strong\u003e，并打印相应的告警。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"23-juicefs-load-从元数据备份文件恢复\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs load\u003c/code\u003e 从元数据备份文件恢复\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ejuicefs load tikv://\u0026lt;ip\u0026gt;:2379/foo-dev-new foo-dev-dump.json\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"24-限制及问题\"\u003e2.4 限制及问题\u003c/h2\u003e\n\n\u003cp\u003e根据\u003ca href=\"https://juicefs.com/docs/zh/community/metadata_dump_load/\"\u003e官方文档\u003c/a\u003e，以上两种方式都有一些限制或问题：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e导出过程中如果业务仍在写入，导出的文件可能不可用。如果对一致性有更高要求，需要在导出前停写。\u003c/li\u003e\n  \u003cli\u003e对规模较大的 volume，直接在线上进行导出可能会影响业务稳定性。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e另外，以上方式都是 volume 级别的备份，如果要备份整个 JuiceFS 集群，需要逐个 volume 备份，比较麻烦。\n下面再看看直接从元数据引擎进行备份的方式。\u003c/p\u003e\n\n\u003ch1 id=\"3-从-tikv-层面对-juicefs-元数据进行备份\"\u003e3 从 TiKV 层面对 JuiceFS 元数据进行备份\u003c/h1\u003e\n\n\u003cp\u003e这里假设 JuiceFS 的元数据引擎是 TiKV。\u003c/p\u003e\n\n\u003ch2 id=\"31-tikv-backuprestore-原理\"\u003e3.1 TiKV backup/restore 原理\u003c/h2\u003e\n\n\u003cp\u003e从上层来说，很简单：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e发请求给 TiKV 集群的管理者 PD，让它对集群的所有数据进行备份；\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e接下来，PD 会发请求给集群的所有 TiKV 节点，通知它们各自进行备份\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003eTiKV 是按 region 进行多副本存储的，因此只需要一个副本进行备份就行了，\u003c/li\u003e\n      \u003cli\u003e在当前的设计里面就是让每个 region 的 leader 副本进行备份，\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eTiKV region leaders 把这个 region 内的数据写到指定位置。可以是本地磁盘或分布式存储。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"32-备份工具-tidb-br-和-tikv-tikv-br\"\u003e3.2 备份工具 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 和 TiKV \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-br\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e理论上，有两个工具可能实现以上效果，它们分别来自 TiDB 和 TiKV 社区，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/br-and-tikv-backup.png\" width=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. TiKV backup with different CLI tools (and their problems).\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e：以前是个独立项目（图中 A.1），后来合到 tidb 仓库里了（图中 B.1），\u003c/p\u003e\n\n    \u003cp\u003e这个工具\u003cstrong\u003e\u003cmark\u003e主要是给 TiDB 备份用的\u003c/mark\u003e\u003c/strong\u003e（虽然底层备份的是 TiDB 的 TiKV），\n 所以需要一些 TiDB 知识（上下文），例如 db/table 都是 TiDB 才有的概念。\n 理论上，它也能备份独立部署的 TiKV 集群（\u003cstrong\u003e\u003cmark\u003e“不依赖 TiDB 的 TiKV”\u003c/mark\u003e\u003c/strong\u003e），\n 所以加了 raw/txn 支持，但不是 TiDB 社区的重点，所以目前还是 experimental 特性，且用下来有 bug。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-br\u003c/code\u003e：是个独立项目，应该是当时 TiKV 作为独立项目推进时，想搞一个配套的独立备份工具，\n  但目前看起来跟 TiKV 社区一样已经\u003cstrong\u003e\u003cmark\u003e不活跃了\u003c/mark\u003e\u003c/strong\u003e，它也没法对 txn 进行备份（\u003cstrong\u003e\u003cmark\u003eJuiceFS 用的 txnkv 接口\u003c/mark\u003e\u003c/strong\u003e）。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e至少对于 5.x TiKV 集群，测试下来\u003cstrong\u003e\u003cmark\u003e以上哪个工具都无法完成备份\u003c/mark\u003e\u003c/strong\u003e：\n有的工具备份和恢复都提示完成，看起来是成功的，但实际上是失败的，JuiceFS 挂载时才能发现。\u003c/p\u003e\n\n\u003cp\u003e最后，我们是基于目前（2024.09）最新的 TiDB br，修改了两个地方，才成功完成 TiKV 的备份与恢复。\u003c/p\u003e\n\n\u003ch2 id=\"33-基于-tidb-br-对-juicefs-tikv-集群进行备份与恢复的步骤\"\u003e3.3 基于 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 对 JuiceFS TiKV 集群进行备份与恢复的步骤\u003c/h2\u003e\n\n\u003cp\u003e之所以要强调 “JuiceFS TiKV 集群”，是因为 JuiceFS 用的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003etxnkv\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 接口，这个比较特殊；\n如果是 rawkv 接口，那 tikv 自带的备份工具 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-br\u003c/code\u003e 也许就能用了（没测过）。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e（可选）关闭 TiKV MVCC GC；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 执行备份，\u003c/p\u003e\n\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr-dev\u003c/code\u003e 是我们基于最新 master（202409）改过的版本。\u003c/p\u003e\n\n    \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./br-dev backup txn \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--ca\u003c/span\u003e /tmp/pki/root.crt \u003cspan class=\"nt\"\u003e--cert\u003c/span\u003e /tmp/pki/pd.crt \u003cspan class=\"nt\"\u003e--key\u003c/span\u003e /tmp/pki/pd.key \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--pd\u003c/span\u003e https://\u003cspan class=\"nv\"\u003e$pd_addr\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--s3\u003c/span\u003e.endpoint \u003cspan class=\"nv\"\u003e$s3_addr\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--storage\u003c/span\u003e \u003cspan class=\"nv\"\u003e$storage_path\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--log-file\u003c/span\u003e /var/log/tikv/br.log \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--ratelimit\u003c/span\u003e \u003cspan class=\"nv\"\u003e$bw_limit_per_node\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--log-level\u003c/span\u003e debug \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--check-requirements\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e可以设置限速等参数，避免备份占用的 CPU/Memory/DiskIO/… 过大。根据 db size 等等因素，\u003cstrong\u003e\u003cmark\u003e备份的耗时是可估算的\u003c/mark\u003e\u003c/strong\u003e，下面拿一个真实集群的备份为例：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e每个 TiKV 的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eDB size\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：监控能看到，一般每个节点的 DB size 都差不太多，这里是 25GB per TiKV node；\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eMVCC\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 保留了数据的多个版本：假设平均保留两个版本，那就是 DB size * 2\u003c/li\u003e\n      \u003cli\u003e限速带宽：设置为 30MB/s，这个带宽不算大，不会是磁盘和网络瓶颈，因此可以全速运行\u003c/li\u003e\n    \u003c/ul\u003e\n\n    \u003cp\u003e根据以上参数，估算耗时：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e25GB * 2 / 30MBps = 1700s = 28min\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n    \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/tikv-backup-resource-usage.png\" width=\"100%\"/\u003e\u003c/p\u003e\n    \u003cp align=\"center\"\u003eFig. TiKV backup resource usage with \u003ccode\u003ebr --ratelimit=30MB/s\u003c/code\u003e.\u003c/p\u003e\n\n    \u003cp\u003e可以看到跟预估的差不多。资源销毁方面：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eCPU 利用率比平时翻倍\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e其中两台机器的 CPU 数量比较少，所以会比其他节点更明显。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e检查备份\u003c/p\u003e\n\n    \u003cp\u003e如果是备份到 S3，可以用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003es3cmd\u003c/code\u003e 或 web 控制台查看，\u003c/p\u003e\n\n    \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003es3cmd \u003cspan class=\"nb\"\u003edu \u003c/span\u003es3://\u003cspan class=\"o\"\u003e{\u003c/span\u003ebucket\u003cspan class=\"o\"\u003e}\u003c/span\u003e/\u0026lt;backup\u0026gt;/\n 295655971082   18513 objects s3://\u003cspan class=\"o\"\u003e{\u003c/span\u003ebucket\u003cspan class=\"o\"\u003e}\u003c/span\u003e/\u0026lt;backup\u0026gt;/\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e290GB 左右，\u003cstrong\u003e\u003cmark\u003e比监控看到的 DB size 大一倍\u003c/mark\u003e\u003c/strong\u003e，因为保留了 MVCC 多版本。\n大多少倍与 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eMVCC GC\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 间隔有密切关系，\n比如写或更新很频繁的场景，1h 和 3h 的 MVCC 数据量就差很多了。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 恢复：将备份数据恢复到一个新的 JuiceFS TiKV 集群，\u003c/p\u003e\n\n    \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./br-dev restore txn \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--ca\u003c/span\u003e /tmp/pki/root.crt \u003cspan class=\"nt\"\u003e--cert\u003c/span\u003e /tmp/pki/pd.crt \u003cspan class=\"nt\"\u003e--key\u003c/span\u003e /tmp/pki/pd.key \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--pd\u003c/span\u003e https://\u003cspan class=\"nv\"\u003e$pd_addr\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--s3\u003c/span\u003e.endpoint \u003cspan class=\"nv\"\u003e$s3_addr\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--storage\u003c/span\u003e \u003cspan class=\"nv\"\u003e$storage_path\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--log-file\u003c/span\u003e /var/log/tikv/br.log \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--ratelimit\u003c/span\u003e \u003cspan class=\"nv\"\u003e$bw_limit_per_node\u003c/span\u003e \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--log-level\u003c/span\u003e debug \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n         \u003cspan class=\"nt\"\u003e--check-requirements\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e可能的问题：ratelimit 好像不起作用，全速恢复，网络带宽打的很高。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eJuiceFS client 挂载，验证恢复成功\u003c/p\u003e\n\n    \u003cp\u003e用 juicefs 挂载目录，指定新 TiKV 集群的 PD 地址，\u003c/p\u003e\n\n    \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ejuicefs mount tikv://\u0026lt;new-pd-ip\u0026gt;:2379/\u0026lt;volume name\u0026gt; /tmp/test\n\n \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/test \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nb\"\u003els\u003c/span\u003e\n \u003cspan class=\"c\"\u003e# 原来 volume 内的文件都在\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"34-tidb-br-备份逻辑\"\u003e3.4 TiDB \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 备份逻辑\u003c/h2\u003e\n\n\u003cp\u003e感兴趣的可以看看 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebr\u003c/code\u003e 源码的备份逻辑，\u003c/p\u003e\n\n\u003ch3 id=\"341-runbackuptxn\"\u003e3.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRunBackupTxn()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// tidb br/pkg/task/backup_txn.go\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// RunBackupTxn starts a backup task inside the current goroutine.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003eRunBackupTxn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"n\"\u003econtext\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eg\u003c/span\u003e \u003cspan class=\"n\"\u003eglue\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGlue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecmdName\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eTxnKvConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emgr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eNewMgr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTLS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGetKeepalive\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConfig\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCheckRequirements\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ebackup\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewBackupClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emgr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebackupRanges\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"n\"\u003ertree\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// current just build full txn range to support full txn backup\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eminStartKey\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emaxEndKey\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebackupRanges\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebackupRanges\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ertree\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRange\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStartKey\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eminStartKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eEndKey\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e   \u003cspan class=\"n\"\u003emaxEndKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Backup\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ebackuppb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eClusterId\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e        \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetClusterID\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStartVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e     \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eEndVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e       \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetCurrentTS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"c\"\u003e// gets a new timestamp (TSO) from PD\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRateLimit\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e        \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRateLimit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eConcurrency\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e      \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eConcurrency\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eStorageBackend\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e   \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetStorageBackend\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eIsRawKv\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e          \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eranges\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eschemas\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epolicies\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBuildBackupRangeAndSchema\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emgr\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTableFilter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebackupTS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eisFullBackup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecmdName\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// StartWriteMetasAsync writes four kind of meta into backupmeta.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 1. file\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 2. schema\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 3. ddl\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 4. rawRange( raw kv )\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003emetautil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewMetaWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003emetautil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMetaFileSize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emetautil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMetaFile\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCipherInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartWriteMetasAsync\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emetautil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendDataFile\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Start TiKV backup\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupRanges\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebackupRanges\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprogressCallBack\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Backup has finished\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebackuppb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupMeta\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStartVersion\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEndVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEndVersion\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsRawKv\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIsTxnKv\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClusterId\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClusterId\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClusterVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emgr\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetClusterVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBrVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebrVersion\u003c/span\u003e\n        \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eApiVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetApiVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFinishWriteMetas\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emetautil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendDataFile\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emetaWriter\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFlushBackupMeta\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e几点说明：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eKV 的 backup range 是全量（start/end key 都是空）；\u003c/li\u003e\n  \u003cli\u003eMVCC 的 start/end version 分别是 0 和当前 PD 最新的 TSO；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"342-调用栈\"\u003e3.4.2 调用栈\u003c/h3\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eBackupRanges // make a backup of the given key ranges.\n  |-mainBackupLoop := \u0026amp;MainBackupLoop\n  |     BackupSender:       \u0026amp;MainBackupSender{},\n  |     BackupReq:          request,\n  |     Concurrency:        concurrency,\n  |     GlobalProgressTree: \u0026amp;globalProgressTree,\n  |     ReplicaReadLabel:   replicaReadLabel,\n  |     GetBackupClientCallBack: func(ctx , storeID uint64, reset bool) (backuppb.BackupClient, error) {\n  |         return bc.mgr.GetBackupClient(ctx, storeID)\n  |     },\n  | }\n  |-bc.RunLoop(ctx, mainBackupLoop) // infinite loop to backup ranges on all tikv stores\n      |-for {\n          inCompleteRanges = iter.GetIncompleteRanges() // 还未完成备份的 key 范围\n          loop.BackupReq.SubRanges = getBackupRanges(inCompleteRanges)\n          allStores := bc.getBackupStores(mainCtx, loop.ReplicaReadLabel)\n          for _, store := range allStores {\n            cli := loop.GetBackupClientCallBack(mainCtx, storeID, reset)\n            loop.SendAsync(round, storeID, loop.BackupReq, loop.Concurrency, cli, ch, loop.StateNotifier)\n                  |-go startBackup(storeID, request, cli, concurrency, respCh)\n                        |-for i, req := range reqs {\n                            doSendBackup(ectx, backupCli, bkReq, ...)\n                              |-ctx, timerecv := StartTimeoutRecv(pctx, TimeoutOneResponse)\n                              |-bCli := client.Backup(ctx, \u0026amp;req) // protobuf grpc method\n                              |-for {\n                              |-    resp := bCli.Recv()\n                              |-    timerecv.Refresh()\n                              |-    respFn(resp)\n                              |-}\n          }\n        }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"343-tikv-server-备份代码\"\u003e3.4.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-server\u003c/code\u003e 备份代码\u003c/h3\u003e\n\n\u003cdiv class=\"language-rust highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// components/backup/src/service.rs\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eimpl\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eH\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBackup\u003c/span\u003e \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003eService\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eH\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003ebackup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eBackupRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"k\"\u003emut\u003c/span\u003e \u003cspan class=\"n\"\u003esink\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eServerStreamingSink\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"nf\"\u003eErr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatus\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003ematch\u003c/span\u003e \u003cspan class=\"nn\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"nf\"\u003eOk\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"k\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eself\u003c/span\u003e\u003cspan class=\"py\"\u003e.scheduler\u003c/span\u003e\u003cspan class=\"nf\"\u003e.schedule\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etask\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003esend_task\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003easync\u003c/span\u003e \u003cspan class=\"k\"\u003emove\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"k\"\u003emut\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003erx\u003c/span\u003e\u003cspan class=\"nf\"\u003e.map\u003c/span\u003e\u003cspan class=\"p\"\u003e(|\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e \u003cspan class=\"nf\"\u003eOk\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nn\"\u003eWriteFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003edefault\u003c/span\u003e\u003cspan class=\"p\"\u003e())));\u003c/span\u003e\n            \u003cspan class=\"n\"\u003esink\u003c/span\u003e\u003cspan class=\"nf\"\u003e.send_all\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"k\"\u003emut\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"k\"\u003e.await\u003c/span\u003e\u003cspan class=\"o\"\u003e?\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"nf\"\u003e.spawn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esend_task\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-rust highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cd\"\u003e/// Backup Task.\u003c/span\u003e\n\u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epub\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003ecrate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eUnboundedSender\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// components/backup/src/endpoint.rs\u003c/span\u003e\n\u003cspan class=\"k\"\u003eimpl\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"cd\"\u003e/// Create a backup task based on the given backup request.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003epub\u003c/span\u003e \u003cspan class=\"k\"\u003efn\u003c/span\u003e \u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eBackupRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eUnboundedSender\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eBackupResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"nb\"\u003eResult\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eTask\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eArc\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e\u003cspan class=\"n\"\u003eAtomicBool\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003espeed_limit\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_rate_limit\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n        \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003elimiter\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nn\"\u003eLimiter\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"nf\"\u003enew\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003espeed_limit\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e  \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"nn\"\u003ef64\u003c/span\u003e\u003cspan class=\"p\"\u003e::\u003c/span\u003e\u003cspan class=\"n\"\u003eINFINITY\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n        \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003ecf\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nf\"\u003ename_to_cf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_cf\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003elet\u003c/span\u003e \u003cspan class=\"n\"\u003etask\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTask\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003erequest\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eRequest\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estart_key\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_start_key\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.to_owned\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eend_key\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_end_key\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.to_owned\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esub_ranges\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_sub_ranges\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.to_owned\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003estart_ts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_start_version\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.into\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eend_ts\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_end_version\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.into\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ebackend\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_storage_backend\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.clone\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003elimiter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eis_raw_kv\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_is_raw_kv\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003edst_api_ver\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_dst_api_version\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ereplica_read\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"nf\"\u003e.get_replica_read\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eresource_group_name\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e \u003cspan class=\"nf\"\u003e.get_resource_group_name\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"nf\"\u003e.to_owned\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}),\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// components/backup/src/endpoint.rs\u003c/span\u003e\n\u003cspan class=\"n\"\u003eBackupRanges\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eBackupWriterBuilder\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eS3Uploader\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eself\u003c/span\u003e\u003cspan class=\"py\"\u003e.writer\u003c/span\u003e\u003cspan class=\"nf\"\u003e.put\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003edata_key_write\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003e-\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003es3\u003c/span\u003e \u003cspan class=\"n\"\u003eput\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e官方文档：\u003ca href=\"https://juicefs.com/docs/zh/community/metadata_dump_load/\"\u003e元数据备份和恢复\u003c/a\u003e, juicefs.com\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/juicefs-metadata-deep-dive-4-zh/\"\u003e\u003cspan\u003e« JuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/juicefs-data-metadata-design-illustrative-guide-1-zh/\"\u003e\u003cspan\u003e直观解读 JuiceFS 的数据和元数据设计（一）：看山是山（2024） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2024-10-10T00:00:00Z",
  "Author": "Arthur Chiao"
}