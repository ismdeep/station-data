{
  "Source": "arthurchiao.art",
  "Title": "Cilium ClusterMesh: A Hands-on Guide",
  "Link": "https://arthurchiao.art/blog/cilium-clustermesh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eCilium ClusterMesh: A Hands-on Guide\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2020-08-13 | Last Update 2020-10-29\u003c/p\u003e\n  \n  \u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#tldr\" id=\"markdown-toc-tldr\"\u003eTL;DR\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-introduction\" id=\"markdown-toc-1-introduction\"\u003e1 Introduction\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-cilium-powered-k8s-cluster\" id=\"markdown-toc-11-cilium-powered-k8s-cluster\"\u003e1.1 Cilium-powered k8s cluster\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-multi-cluster-scenarios-why-multi-cluster\" id=\"markdown-toc-12-multi-cluster-scenarios-why-multi-cluster\"\u003e1.2 Multi-cluster scenarios (why multi-cluster?)\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-cross-cluster-accessing-models\" id=\"markdown-toc-13-cross-cluster-accessing-models\"\u003e1.3 Cross-cluster accessing models\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-where-clustermesh-is-needed\" id=\"markdown-toc-14-where-clustermesh-is-needed\"\u003e1.4 Where clustermesh is needed\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-test-environment\" id=\"markdown-toc-2-test-environment\"\u003e2 Test environment\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-clustermesh-setup\" id=\"markdown-toc-3-clustermesh-setup\"\u003e3 ClusterMesh setup\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-configuration-changes\" id=\"markdown-toc-31-configuration-changes\"\u003e3.1 Configuration changes\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#311-configure-cluster1\" id=\"markdown-toc-311-configure-cluster1\"\u003e3.1.1 Configure cluster1\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#312-configure-cluster2\" id=\"markdown-toc-312-configure-cluster2\"\u003e3.1.2 Configure cluster2\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-verify-clustermesh-syncing\" id=\"markdown-toc-32-verify-clustermesh-syncing\"\u003e3.2 Verify clustermesh syncing\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-network-policy-test\" id=\"markdown-toc-4-network-policy-test\"\u003e4 Network policy test\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-create-server-and-clients\" id=\"markdown-toc-41-create-server-and-clients\"\u003e4.1 Create server and clients\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#411-create-server-in-cluster1\" id=\"markdown-toc-411-create-server-in-cluster1\"\u003e4.1.1 Create server in cluster1\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#412-create-client-in-cluster1\" id=\"markdown-toc-412-create-client-in-cluster1\"\u003e4.1.2 Create client in cluster1\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#413-create-client-in-cluster2\" id=\"markdown-toc-413-create-client-in-cluster2\"\u003e4.1.3 Create client in cluster2\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-connectivity-test\" id=\"markdown-toc-42-connectivity-test\"\u003e4.2 Connectivity test\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-apply-global-network-policy\" id=\"markdown-toc-43-apply-global-network-policy\"\u003e4.3 Apply global network policy\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-test-and-observe\" id=\"markdown-toc-44-test-and-observe\"\u003e4.4 Test and observe\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-conclusion\" id=\"markdown-toc-5-conclusion\"\u003e5 Conclusion\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#references\" id=\"markdown-toc-references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#appendix-yaml-files\" id=\"markdown-toc-appendix-yaml-files\"\u003eAppendix: yaml files\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"tldr\"\u003eTL;DR\u003c/h2\u003e\n\n\u003cp\u003eCilium provides \u003ca href=\"https://docs.cilium.io/en/stable/gettingstarted/clustermesh/\"\u003eclustermesh\u003c/a\u003e\nfor global \u003cstrong\u003eService load balancing\u003c/strong\u003e and \u003cstrong\u003enetwork policy enforcement\u003c/strong\u003e across\ndifferent Kubernetes clusters [1].\u003c/p\u003e\n\n\u003cp\u003eWhile the \u003ca href=\"https://docs.cilium.io/en/stable/gettingstarted/clustermesh/\"\u003eofficial documentation\u003c/a\u003e\nships with a step-by-step guide, it hides too many\ndetails as it uses higher-level tools (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehelm\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclustermesh-tools\u003c/code\u003e, etc) to\ngenerate configuration files for you. \u003cstrong\u003eIf you are interested in the underlying\nhooks, this post may be for you\u003c/strong\u003e. We will \u003cstrong\u003emanually set up a clustermesh\u003c/strong\u003e and\n\u003cstrong\u003etest global network policies\u003c/strong\u003e.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eNOTE: \u003ca href=\"https://ctripcloud.github.io/cilium/network/2020/01/19/trip-first-step-towards-cloud-native-networking.html\"\u003eWe\u003c/a\u003e\ninternally use \u003ca href=\"https://github.com/ctripcloud/cilium-compose\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecilium-compose\u003c/code\u003e\u003c/a\u003e\ninstead of the community daemonset+configmap for cilium deploying.\nThe purpose of this post is NOT to promote cilium-compose, but to share some\nhands-on experience on Cilium clustermesh.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch1 id=\"1-introduction\"\u003e1 Introduction\u003c/h1\u003e\n\n\u003ch2 id=\"11-cilium-powered-k8s-cluster\"\u003e1.1 Cilium-powered k8s cluster\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/cilium-powered-k8s-cluster.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 1-1. Cilium powered Kubernetes cluster\u003c/p\u003e\n\n\u003cp\u003eFig 1-1 lists three important components in a cilium-powered Kubernetes cluster:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver\u003c/code\u003e: k8s API server on master node.\n    \u003cul\u003e\n      \u003cli\u003eK8s commands such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl create/apply/delete/get/describe xxx\u003c/code\u003e will send requests to apiserver.\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecilium-agent\u003c/code\u003e: the daemon/agent runs on each worker node.\n    \u003cul\u003e\n      \u003cli\u003elisten to resource changes in k8s \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver\u003c/code\u003e\u003c/li\u003e\n      \u003cli\u003elisten to network policy changes in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecilium-etcd\u003c/code\u003e\u003c/li\u003e\n      \u003cli\u003eIP allocation (for non-ENI-mode)\u003c/li\u003e\n      \u003cli\u003ePod network setup\u003c/li\u003e\n      \u003cli\u003enetwork policy enforcement\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecilium-etcd\u003c/code\u003e: kvstore (repository) which stores information such as:\n    \u003cul\u003e\n      \u003cli\u003enodes info\u003c/li\u003e\n      \u003cli\u003eidentity info\u003c/li\u003e\n      \u003cli\u003eL3/L4/L7 network policies\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"12-multi-cluster-scenarios-why-multi-cluster\"\u003e1.2 Multi-cluster scenarios (why multi-cluster?)\u003c/h2\u003e\n\n\u003cp\u003eTo address practical challenges, such as disaster recovery, business\nmanagement, infra easy-of-maintanance, you may have deployed your\nbusiness applications into multiple clusters.\u003c/p\u003e\n\n\u003cp\u003eIn such cases, there are different granularities when determining which specific\ninstance (pod) should be placed into which cluster:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003eby service\u003c/strong\u003e: e.g. all pods of service \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esvc1\u003c/code\u003e placed into cluster1, and all\npods of service \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esvc2\u003c/code\u003e to cluster2.\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eby pods\u003c/strong\u003e: split a serviceâ€™s pods into e.g. two groups, with\nthe first half scheduled to cluster1, and the second half to cluster2.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThis will result to different models/patterns when accessing services in\nother clusters.\u003c/p\u003e\n\n\u003ch2 id=\"13-cross-cluster-accessing-models\"\u003e1.3 Cross-cluster accessing models\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/multi-cluster-access-patterns.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 1-2. Cross-cluster service accessing models\u003c/p\u003e\n\n\u003cp\u003eAs shown in Fig 1-2, if a client in cluster1 would like to access a service\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esvc\u003c/code\u003e in other clusters, the models may be:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003ek8s Ingress\u003c/strong\u003e: via L7\n    \u003cul\u003e\n      \u003cli\u003eA model described by k8s, but need to be implemented by network plugins/vendors\u003c/li\u003e\n      \u003cli\u003eExpose service via a layer 7 proxy, such as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eistio-gateway\u003c/code\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eistio-gateway\u003c/code\u003e as an API gateway is reachable from other clusters.\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003ek8s LoadBalancer or externalIPs\u003c/strong\u003e: via L4\n    \u003cul\u003e\n      \u003cli\u003eA model described by k8s, but need to be implemented by network plugins/vendors (more on this, see [5]).\u003c/li\u003e\n      \u003cli\u003eExpose service via externalIPs.\u003c/li\u003e\n      \u003cli\u003eexternalIPs, most oftenly provided by cloud vendor, is reachable from\nother clusters, and will load balance traffic to the right backends of services.\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eother vendor specific solutions, such as Ciliumâ€™s clustermesh\u003c/strong\u003e: via L3 in some sense.\n    \u003cul\u003e\n      \u003cli\u003e\u003cstrong\u003eThis is not a k8s model\u003c/strong\u003e, but an specific implementation provided by Cilium.\u003c/li\u003e\n      \u003cli\u003eEnable cross-cluster k8s \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eService\u003c/code\u003es, the pods of a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eService\u003c/code\u003e can scatter\ninto different clusters.\u003c/li\u003e\n      \u003cli\u003eA client pod can access \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eService\u003c/code\u003es in any cluster, regardless of where\n(which cluster) the backends of the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eService\u003c/code\u003e are running on.\u003c/li\u003e\n      \u003cli\u003eAlso support \u003cstrong\u003ecross-cluster network policy\u003c/strong\u003e.\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"14-where-clustermesh-is-needed\"\u003e1.4 Where clustermesh is needed\u003c/h2\u003e\n\n\u003cp\u003eIf you have \u003cstrong\u003escattered your pods of a same service into different clusters\u003c/strong\u003e\n(the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2nd\u003c/code\u003e case in section 1.2), and you would like service\ndiscovery/load-balancing or enforce network policies on these services, you\nmay need clustermesh.\u003c/p\u003e\n\n\u003cp\u003eIn the remaining of this post, we will show how to set up a clustermesh,\n, and test network policy enforcements in the mesh.\u003c/p\u003e\n\n\u003ch1 id=\"2-test-environment\"\u003e2 Test environment\u003c/h1\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/separate-clusters.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 2-1. Two distinct k8s clusters, each with their own cilium-etcd\u003c/p\u003e\n\n\u003cp\u003eAs shown in Fig 2-1, we use two k8s clusters as our test environment in this\npost. These two clusters are equipped with following properties:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eUse \u003cstrong\u003edirect routing\u003c/strong\u003e [2,4] for cross-host networking.\u003c/li\u003e\n  \u003cli\u003eNo overlapping of \u003cstrong\u003enode IPs\u003c/strong\u003e between the two clusters.\u003c/li\u003e\n  \u003cli\u003eNo overlapping of \u003cstrong\u003ePodCIDRs\u003c/strong\u003e between the two clusters.\u003c/li\u003e\n  \u003cli\u003eNo firewall rules that blocks communication between the two clusters.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThis meets the prerequisites of clustermesh as detailed in [1].\u003c/p\u003e\n\n\u003ch1 id=\"3-clustermesh-setup\"\u003e3 ClusterMesh setup\u003c/h1\u003e\n\n\u003cp\u003eThis section details the process of turning the above two clusters into a clustermesh.\u003c/p\u003e\n\n\u003ch2 id=\"31-configuration-changes\"\u003e3.1 Configuration changes\u003c/h2\u003e\n\n\u003cp\u003eOn the basis of the above two running clusters, add additional configurations to\ncilium agents:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecluster-name\u003c/code\u003e: unique string across all clusters\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecluster-id\u003c/code\u003e: unique integer between 0~255 across all clusters\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclustermesh-config\u003c/code\u003e: directory containing all cilium-etcd configuration\nfiles of other clusters (note that the \u003cstrong\u003econfiguration file name\u003c/strong\u003e of each\ncluster must be the same as the \u003cstrong\u003ecluster name\u003c/strong\u003e)\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe \u003cstrong\u003eideas behind these configurations\u003c/strong\u003e are:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eEnsure each cluster has a \u003cstrong\u003eunique identifier\u003c/strong\u003e (cluster name and ID).\u003c/li\u003e\n  \u003cli\u003eMake cilium agents in one cluster \u003cstrong\u003elisten to network policy changes in other clusters\u003c/strong\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eWithe the above conditions met, each cluster will have a global view of the\nservices and network policies across all clusters.\u003c/p\u003e\n\n\u003cp\u003eThe resulted mesh will look like Fig 3-1 as shown below:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/clustermesh.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 3-1. ClusterMesh, cilium-agent listens to other clusters\u003c/p\u003e\n\n\u003cp\u003eRe-depict Fig 2-1 here, you can see the changes (actually are add-ons) more\nclearly with side-by-side comparison:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/separate-clusters.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eRe-depict Fig 2-1. Two distinct k8s clusters, each with their own cilium-etcd\u003c/p\u003e\n\n\u003cp\u003eNow letâ€™s see the detailed configuring steps.\u003c/p\u003e\n\n\u003ch3 id=\"311-configure-cluster1\"\u003e3.1.1 Configure cluster1\u003c/h3\u003e\n\n\u003cp\u003ePass new parameters to cilium-agent via CLI (could also via configmap):\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# previous\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium-agent \u003cspan class=\"nt\"\u003e--config-dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/tmp/cilium/config-map\n\n\u003cspan class=\"c\"\u003e# now\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium-agent \u003cspan class=\"nt\"\u003e--config-dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/tmp/cilium/config-map \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e--cluster-id\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e101 \u003cspan class=\"nt\"\u003e--cluster-name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecluster1 \u003cspan class=\"nt\"\u003e--clustermesh-config\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/cilium/clustermesh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ewhere \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/var/lib/cilium/clustermesh\u003c/code\u003e is mounted from host path \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emount/var/lib/cilium/clustermesh/\u003c/code\u003e\n(specified in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edocker-compose.yaml\u003c/code\u003e in our case):\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els \u003c/span\u003emount/var/lib/cilium/clustermesh/\ncluster2\ncluster2-etcd-client-ca.crt\ncluster2-etcd-client.crt\ncluster2-etcd-client.key\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat \u003c/span\u003emount/var/lib/cilium/clustermesh/cluster2\nendpoints:\n  - https://10.2.2.2:2379\n\nca-file:   \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster2-etcd-client-ca.crt\u0026#39;\u003c/span\u003e\nkey-file:  \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster2-etcd-client.key\u0026#39;\u003c/span\u003e\ncert-file: \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster2-etcd-client.crt\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAfter cilium-agent restarted, we could see logs like this:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e(cluster1 node1) $ docker logs -f cilium-agent\n...\nlevel=info msg=\u0026#34;Successfully verified version of etcd endpoint\u0026#34; config=/var/lib/cilium/clustermesh/cluster2 endpoints=\u0026#34;[https://10.2.2.2:2379]\u0026#34; etcdEndpoint=\u0026#34;https://10.2.2.2:2379\u0026#34;\nlevel=info msg=\u0026#34;Connection to remote cluster established\u0026#34; clusterName=cluster2 config=/var/lib/cilium/clustermesh/cluster2 kvstoreErr=\u0026#34;\u0026lt;nil\u0026gt;\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"312-configure-cluster2\"\u003e3.1.2 Configure cluster2\u003c/h3\u003e\n\n\u003cp\u003eSimilar as 3.1.1, cilium-agent CLI:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium-agent \u003cspan class=\"nt\"\u003e--config-dir\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/tmp/cilium/config-map \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n    \u003cspan class=\"nt\"\u003e--cluster-id\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e102 \u003cspan class=\"nt\"\u003e--cluster-name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ecluster2 \u003cspan class=\"nt\"\u003e--clustermesh-config\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/var/lib/cilium/clustermesh\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eand files in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/var/lib/cilium/clustermesh\u003c/code\u003e (mounted from host path \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emount/var/lib/cilium/clustermesh/\u003c/code\u003e):\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster2 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els \u003c/span\u003emount/var/lib/cilium/clustermesh/\ncluster1\ncluster1-etcd-client-ca.crt\ncluster1-etcd-client.crt\ncluster1-etcd-client.key\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster2 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat \u003c/span\u003emount/var/lib/cilium/clustermesh/cluster1\nendpoints:\n  - https://10.1.1.1:2379\n\nca-file:   \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster1-etcd-client-ca.crt\u0026#39;\u003c/span\u003e\nkey-file:  \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster1-etcd-client.key\u0026#39;\u003c/span\u003e\ncert-file: \u003cspan class=\"s1\"\u003e\u0026#39;/var/lib/cilium/clustermesh/cluster1-etcd-client.crt\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eLogs after restarting cilium-agent:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e(cluster2 node1) $ docker logs -f cilium-agent\n...\nlevel=info msg=\u0026#34;Successfully verified version of etcd endpoint\u0026#34; config=/var/lib/cilium/clustermesh/cluster1 endpoints=\u0026#34;[https://10.1.1.1:2379]\u0026#34; etcdEndpoint=\u0026#34;https://10.1.1.1:2379\u0026#34;\nlevel=info msg=\u0026#34;Connection to remote cluster established\u0026#34; clusterName=cluster1 config=/var/lib/cilium/clustermesh/cluster1 kvstoreErr=\u0026#34;\u0026lt;nil\u0026gt;\u0026#34;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"32-verify-clustermesh-syncing\"\u003e3.2 Verify clustermesh syncing\u003c/h2\u003e\n\n\u003cp\u003eCheck cluster status:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium status\nKVStore:                Ok   etcd: ...\nKubernetes:             Ok   1.17+ \u003cspan class=\"o\"\u003e(\u003c/span\u003ev1.17.6-3\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003elinux/amd64]\n...\nClusterMesh:            2/2 clusters ready, 0 global-services\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eMore verbose:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium status \u003cspan class=\"nt\"\u003e--verbose\u003c/span\u003e\nKVStore:                Ok   etcd: ...\nKubernetes:             Ok   1.17+ \u003cspan class=\"o\"\u003e(\u003c/span\u003ev1.17.6-3\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003elinux/amd64]\n...\nClusterMesh:   1/1 clusters ready, 0 global-services\n   cluster2: ready, 23 nodes, 2618 identities, 0 services, 0 failures \u003cspan class=\"o\"\u003e(\u003c/span\u003elast: never\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n   â””  etcd: 1/1 connected, ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eList all nodes of all clusters in the mesh:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium node list\nName               IPv4 Address   Endpoint CIDR    IPv6 Address   Endpoint CIDR\ncluster1/node1     10.xx.xx.xx   10.xx.xx.xx/24\ncluster1/node2     10.xx.xx.xx   10.xx.xx.xx/24\n...\ncluster2/node1     10.xx.xx.xx   10.xx.xx.xx/24\ncluster2/node2     10.xx.xx.xx   10.xx.xx.xx/24\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eCheck identities:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium identity list\n... \u003cspan class=\"c\"\u003e# all identities in both cluster1 and cluster2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecilium identity list | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;NF\u0026gt;1  {print $1}\u0026#39;\u003c/span\u003e | \u003cspan class=\"nb\"\u003esort\u003c/span\u003e | \u003cspan class=\"nb\"\u003euniq\u003c/span\u003e \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;$1\u0026gt;1 {print $0}\u0026#39;\u003c/span\u003e\n      2 10575 \u003cspan class=\"c\"\u003e# -\u0026gt; same identity ID appears more than once, indicating at least one is from remote clusters\u003c/span\u003e\n      2 10876\n      2 11091\n      ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"4-network-policy-test\"\u003e4 Network policy test\u003c/h1\u003e\n\n\u003cp\u003eWe create a simple server-client system to test the network policy enforcement\nof clustermesh:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003e: the \u003cstrong\u003eserver side\u003c/strong\u003e, listens at port \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e6379\u003c/code\u003e\n    \u003cul\u003e\n      \u003cli\u003eshould only allow access from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee\u003c/code\u003e pods, regardless of the cluster that \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee\u003c/code\u003e pod exists\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee\u003c/code\u003e: the \u003cstrong\u003eclient side\u003c/strong\u003e, should be allowed to access \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eall other pods: not allowed to access \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003e\n    \u003cul\u003e\n      \u003cli\u003ewe will create a pod named \u003ccode class=\"language-plaintext highlighter-rouge\"\u003estranger\u003c/code\u003e as such a representative\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe final effect we want to achieve is depicted in Fig 4-1:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/policy-enabled.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 4-1. Final results we want to achieve\u003c/p\u003e\n\n\u003ch2 id=\"41-create-server-and-clients\"\u003e4.1 Create server and clients\u003c/h2\u003e\n\n\u003ch3 id=\"411-create-server-in-cluster1\"\u003e4.1.1 Create server in cluster1\u003c/h3\u003e\n\n\u003cp\u003eServer yaml \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db.yaml\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eapps/v1\u003c/span\u003e\n\u003cspan class=\"na\"\u003ekind\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eStatefulSet\u003c/span\u003e\n\u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprotected-db\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eannotations\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eio.cilium/global-service\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n\u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eselector\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprotected-db\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"na\"\u003etemplate\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprotected-db\u003c/span\u003e\n    \u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e# affinity:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#   nodeAffinity:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#     requiredDuringSchedulingIgnoredDuringExecution:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#       nodeSelectorTerms:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#       - matchExpressions:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#         - key: kubernetes.io/hostname\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#           operator: In\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#           values:\u003c/span\u003e\n      \u003cspan class=\"c1\"\u003e#           - node1\u003c/span\u003e\n      \u003cspan class=\"na\"\u003econtainers\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eredis:6.0.5-alpine\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprotected-db\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eEnable the node affinity section in the above yaml if youâ€™d like to schedule\nthe pod to a specific node.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eThe \u003cstrong\u003especial part\u003c/strong\u003e compared with normal (non-clustermesh) Services is the\n\u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio.cilium/global-service: \u0026#34;true\u0026#34;\u003c/code\u003e annotation\u003c/strong\u003e in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emetadata\u003c/code\u003e section, which\ntells Cilium agent that this is a Service with backend pods across different clusters:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"na\"\u003eannotations\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eio.cilium/global-service\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow create it in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edefault\u003c/code\u003e namespace:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e protected-db.yaml\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003eprotected-db\nprotected-db-0   1/1     Running     0          11s     10.3.3.3      node1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"412-create-client-in-cluster1\"\u003e4.1.2 Create client in cluster1\u003c/h3\u003e\n\n\u003cp\u003eWe will create clients in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edefault\u003c/code\u003e namespace as well:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e employee.yaml\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e stranger.yaml\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003eemployee\nemployee-0      1/1     Running     0          12m\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003estranger\nstranger-0      1/1     Running     0          12m\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"413-create-client-in-cluster2\"\u003e4.1.3 Create client in cluster2\u003c/h3\u003e\n\n\u003cp\u003eCreate an \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee\u003c/code\u003e in cluster2, but \u003cstrong\u003ein a namespace other than \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edefault\u003c/code\u003e\u003c/strong\u003e,\nwe intentionally design it this way so that we could see the namespace selectors\nin network policy later:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster2 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e employee.yaml \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e istio-space\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"42-connectivity-test\"\u003e4.2 Connectivity test\u003c/h2\u003e\n\n\u003cp\u003eWith the above setups done, letâ€™s verify the basic connectivity between clients\nand server.\u003c/p\u003e\n\n\u003cp\u003eAs we use \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eredis\u003c/code\u003e image for both clients and server, we will test connectivity\nwith redis commands. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eredis-cli\u003c/code\u003e command line parameters:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-h \u0026lt;host\u0026gt;\u003c/code\u003e: specify host IP address\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-p \u0026lt;port\u0026gt;\u003c/code\u003e: specify port\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# access protected-db from cluster1-employee:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003eemployee-0 redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\nPONG\n\n\u003cspan class=\"c\"\u003e# access protected-db from cluster1-stranger:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003estranger-0 redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\nPONG\n\n\u003cspan class=\"c\"\u003e# access protected-db from cluster2-employee:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster2 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003eemployee-0 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e istio-space redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\nPONG\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAll accessible! Effects as shown below:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/no-policy.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 4-2. Connectivity before applying network policy\u003c/p\u003e\n\n\u003ch2 id=\"43-apply-global-network-policy\"\u003e4.3 Apply global network policy\u003c/h2\u003e\n\n\u003cp\u003eWe will apply a L4 policy at \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003eâ€™s \u003cstrong\u003eingress\u003c/strong\u003e path.\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003el4-policy.yaml\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003ecilium.io/v2\u0026#34;\u003c/span\u003e\n\u003cspan class=\"na\"\u003ekind\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eCiliumNetworkPolicy\u003c/span\u003e\n\u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003eclustermesh-ingress-l4-policy\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"na\"\u003edescription\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003edemo:\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eallow\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eonly\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eto\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eaccess\u003c/span\u003e\u003cspan class=\"nv\"\u003e \u003c/span\u003e\u003cspan class=\"s\"\u003eprotected-db\u0026#34;\u003c/span\u003e\n\u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eendpointSelector\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprotected-db\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eio.cilium.k8s.policy.cluster\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecluster1\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eingress\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003etoPorts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eports\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eport\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e6379\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eTCP\u003c/span\u003e\n    \u003cspan class=\"na\"\u003efromEndpoints\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eio.cilium.k8s.policy.cluster\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecluster2\u003c/span\u003e\n          \u003cspan class=\"s\"\u003ek8s:io.kubernetes.pod.namespace: istio-space\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n          \u003cspan class=\"c1\"\u003e# io.cilium.k8s.policy.cluster: cluster1\u003c/span\u003e\n          \u003cspan class=\"s\"\u003ek8s:io.kubernetes.pod.namespace: default\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNote that you must NOT add \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio.cilium.k8s.policy.cluster: cluster1\u003c/code\u003e for the\nclients within the same cluster (commented out in the above yaml), otherwise it\nwill behave abnormally (try it!).\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek create \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e l4-policy.yaml\nciliumnetworkpolicy.cilium.io/clustermesh-ingress-l4-policy configured\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"44-test-and-observe\"\u003e4.4 Test and observe\u003c/h2\u003e\n\n\u003cp\u003eNow test again:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# access protected-db from cluster1-employee:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003eemployee-0 redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\nPONG\n\n\u003cspan class=\"c\"\u003e# access protected-db from cluster1-stranger:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003estranger-0 redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\n^C\n\n\u003cspan class=\"c\"\u003e# access protected-db from cluster2-employee:\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster2 master\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek \u003cspan class=\"nb\"\u003eexec \u003c/span\u003eemployee-0 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e istio-space redis-cli \u003cspan class=\"nt\"\u003e--\u003c/span\u003e \u003cspan class=\"nt\"\u003e-h\u003c/span\u003e 10.3.3.3 \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e 6379 ping\nPONG\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/cilium-clustermesh/policy-enabled.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 4-2. Network policy enabled at clustermesh scope\u003c/p\u003e\n\n\u003cp\u003eCapturing on the cilium-agent of the node that \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003e is running on, we\ncould see \u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSYN\u003c/code\u003e packets coming from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003estranger\u003c/code\u003e get dropped by the agent\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e cilium-agent bash\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003ecluster1 node1 cilium-agent\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cilium monitor --type=drop\u003c/span\u003e\n..\nxx drop \u003cspan class=\"o\"\u003e(\u003c/span\u003ePolicy denied\u003cspan class=\"o\"\u003e)\u003c/span\u003e flow 0x28c644b8 to endpoint 3833, identity 38354-\u0026gt;6587186: 10.x.x.x:42728 -\u0026gt; 10.3.3.3:6379 tcp SYN\nxx drop \u003cspan class=\"o\"\u003e(\u003c/span\u003ePolicy denied\u003cspan class=\"o\"\u003e)\u003c/span\u003e flow 0x28c644b8 to endpoint 3833, identity 38354-\u0026gt;6587186: 10.x.x.x:42728 -\u0026gt; 10.3.3.3:6379 tcp SYN\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eActually all traffic not coming from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee\u003c/code\u003eâ€™s will get dropped in\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprotected-db\u003c/code\u003eâ€™s ingress path.\u003c/p\u003e\n\n\u003ch1 id=\"5-conclusion\"\u003e5 Conclusion\u003c/h1\u003e\n\n\u003cp\u003eIn this post, we showed how to set up a Cilium clustermesh by adding several (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e4\u003c/code\u003e,\nto be specific) additional parameters to cilium agent, although the steps are\nspecific to our deploying fashion, itâ€™s easy to adapt other fashions, e.g.\ndaemonset+configmap.\u003c/p\u003e\n\n\u003cp\u003eIf you want to add more clusters into the mesh, just add the cilium-etcdâ€™s\nconfig file and corresponding certificates of the new clusters to\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/var/lib/cilium/clustermesh\u003c/code\u003e directory as shown in the post, and they will form a\npoint-to-point cluster mesh.\u003c/p\u003e\n\n\u003ch1 id=\"references\"\u003eReferences\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://docs.cilium.io/en/stable/gettingstarted/clustermesh/\"\u003eCilium Doc: clustermesh\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://ctripcloud.github.io/cilium/network/2020/01/19/trip-first-step-towards-cloud-native-networking.html\"\u003eTrip.com: First step towards cloud native networking\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/ctripcloud/cilium-compose.git\"\u003eGithub: cilium-compose\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://docs.cilium.io/en/stable/gettingstarted/bird/\"\u003eCilium Doc: Using BIRD to run BGP\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/k8s-l4lb/\"\u003eL4LB for Kubernetes: Theory and Practice with Cilium+BGP+ECMP\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"appendix-yaml-files\"\u003eAppendix: yaml files\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemployee.yaml\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eapps/v1\u003c/span\u003e\n\u003cspan class=\"na\"\u003ekind\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eStatefulSet\u003c/span\u003e\n\u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eannotations\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eio.cilium/global-service\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n\u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eselector\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"na\"\u003etemplate\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n    \u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003econtainers\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eredis:6.0.5-alpine\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003esleep\u0026#34;\u003c/span\u003e\u003cspan class=\"pi\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eargs\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e100d\u0026#34;\u003c/span\u003e\u003cspan class=\"pi\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemployee\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003estranger.yaml\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eapps/v1\u003c/span\u003e\n\u003cspan class=\"na\"\u003ekind\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eStatefulSet\u003c/span\u003e\n\u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003estranger\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eannotations\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eio.cilium/global-service\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n\u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ereplicas\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eselector\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ematchLabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003estranger\u003c/span\u003e\n  \u003cspan class=\"na\"\u003eserviceName\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"na\"\u003etemplate\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elabels\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eapp\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003estranger\u003c/span\u003e\n    \u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003econtainers\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eredis:6.0.5-alpine\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003esleep\u0026#34;\u003c/span\u003e\u003cspan class=\"pi\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eargs\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e[\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e100d\u0026#34;\u003c/span\u003e\u003cspan class=\"pi\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003estranger\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/conntrack-design-and-implementation/\"\u003e\u003cspan\u003eÂ«Â Connection Tracking (conntrack): Design and Implementation Inside Linux Kernel\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/cilium-code-clustermesh/\"\u003e\u003cspan\u003eCilium: What the Agents Do When ClusterMesh EnabledÂ Â»\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2020-08-13T00:00:00Z",
  "Author": "Arthur Chiao"
}