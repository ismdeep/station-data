{
  "Source": "arthurchiao.art",
  "Title": "[译] [论文] Raft 共识算法（及 etcd/raft 源码解析）（USENIX, 2014）",
  "Link": "https://arthurchiao.art/blog/raft-paper-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003e[译] [论文] Raft 共识算法（及 etcd/raft 源码解析）（USENIX, 2014）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2022-02-06 | Last Update 2022-02-06\u003c/p\u003e\n  \n  \u003ch3 id=\"译者序\"\u003e译者序\u003c/h3\u003e\n\n\u003cp\u003e本文翻译自 USENIX 2014 论文\n\u003ca href=\"https://www.usenix.org/conference/atc14/technical-sessions/presentation/ongaro\"\u003eIn Search of an Understandable Consensus Algorithm (Extended Version)\u003c/a\u003e\n，文中提出了如今已广泛使用的 Raft 共识算法。\u003c/p\u003e\n\n\u003cp\u003e在 Raft 之前，Paxos 几乎是共识算法的代名词，但它有两个严重缺点：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e很难准确理解\u003c/mark\u003e\u003c/strong\u003e（即使对专业研究者和该领域的教授）\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e很难正确实现\u003c/mark\u003e\u003c/strong\u003e（复杂 + 某些理论描述比较模糊）\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e结果正如 Chubby（基于 Paxos 的 Google 分布式锁服务，是 Google 众多全球分布式系\n统的基础）开发者所说：\u003cstrong\u003e\u003cmark\u003e“Paxos 的算法描述和真实需求之间存在一个巨大鸿沟，......\n最终的系统其实将建立在一个没有经过证明的协议之上”\u003c/mark\u003e\u003c/strong\u003e [4]。\n对于大学教授来说，还有一个更实际的困难：Paxos 复杂难懂，但除了它之外，又没有其他\n\u003cstrong\u003e\u003cmark\u003e适合教学\u003c/mark\u003e\u003c/strong\u003e的替代算法。\u003c/p\u003e\n\n\u003cp\u003e因此，从学术界和工业界两方面需求出发，斯坦福大学博士生 Diego Ongaro 及其导师\nJohn Ousterhout 提出了 Raft 算法，它的最大设计目标就是\u003cstrong\u003e\u003cmark\u003e可理解性\u003c/mark\u003e\u003c/strong\u003e，\n这也是为什么这篇文章的标题是《寻找一种可理解的共识算法》。\u003c/p\u003e\n\n\u003cp\u003e与原文的可理解性目标类似，此译文也是出于\u003cstrong\u003e\u003cmark\u003e更好地理解 Raft 算法\u003c/mark\u003e\u003c/strong\u003e这一目的。\n因此，除了翻译时调整排版并加入若干小标题以方便网页阅读，本文还\u003cstrong\u003e\u003cmark\u003e对照了\u003c/mark\u003e\u003c/strong\u003e\n\u003ca href=\"https://github.com/etcd-io/etcd/tree/release-0.4/third_party/github.com/goraft/raft\"\u003e\u003cmark\u003eetcd/raft v0.4\u003c/mark\u003e\u003c/a\u003e\n\u003cstrong\u003e\u003cmark\u003e的实现\u003c/mark\u003e\u003c/strong\u003e，这个版本已经实现了 Raft 协议的大部分功能，但还未做工程优化，\n函数、变量等大体都能对应到论文中，对理解算法有很大帮助。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e以下是译文。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#译者序\" id=\"markdown-toc-译者序\"\u003e译者序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#摘要\" id=\"markdown-toc-摘要\"\u003e摘要\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-引言\" id=\"markdown-toc-1-引言\"\u003e1 引言\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-本文背景与目的\" id=\"markdown-toc-11-本文背景与目的\"\u003e1.1 本文背景与目的\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-研究成果简介\" id=\"markdown-toc-12-研究成果简介\"\u003e1.2 研究成果简介\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-本文组织结构\" id=\"markdown-toc-13-本文组织结构\"\u003e1.3 本文组织结构\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-复制式状态机replicated-state-machines\" id=\"markdown-toc-2-复制式状态机replicated-state-machines\"\u003e2 复制式状态机（replicated state machines）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-使用场景\" id=\"markdown-toc-21-使用场景\"\u003e2.1 使用场景\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-状态机架构\" id=\"markdown-toc-22-状态机架构\"\u003e2.2 状态机架构\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-共识算法的典型特征\" id=\"markdown-toc-23-共识算法的典型特征\"\u003e2.3 共识算法的典型特征\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-paxos-有什么问题\" id=\"markdown-toc-3-paxos-有什么问题\"\u003e3 Paxos 有什么问题？\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-paxos-简介\" id=\"markdown-toc-31-paxos-简介\"\u003e3.1 Paxos 简介\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-paxos-的缺点\" id=\"markdown-toc-32-paxos-的缺点\"\u003e3.2 Paxos 的缺点\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#321-理解异常困难\" id=\"markdown-toc-321-理解异常困难\"\u003e3.2.1 理解异常困难\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#322-没有考虑真实系统的实现\" id=\"markdown-toc-322-没有考虑真实系统的实现\"\u003e3.2.2 没有考虑真实系统的实现\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-小结\" id=\"markdown-toc-33-小结\"\u003e3.3 小结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-面向可理解性的设计\" id=\"markdown-toc-4-面向可理解性的设计\"\u003e4 面向可理解性的设计\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-设计目标\" id=\"markdown-toc-41-设计目标\"\u003e4.1 设计目标\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-可理解性的评估\" id=\"markdown-toc-42-可理解性的评估\"\u003e4.2 可理解性的评估\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-raft-共识算法\" id=\"markdown-toc-5-raft-共识算法\"\u003e5 Raft 共识算法\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#50-raft-核心知识点提前汇总\" id=\"markdown-toc-50-raft-核心知识点提前汇总\"\u003e5.0 Raft 核心知识点（提前）汇总\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#501-不同节点的状态参数\" id=\"markdown-toc-501-不同节点的状态参数\"\u003e5.0.1 不同节点的状态参数\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#502-appendentries-rpc\" id=\"markdown-toc-502-appendentries-rpc\"\u003e5.0.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e RPC\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#503-requestvote-rpc\" id=\"markdown-toc-503-requestvote-rpc\"\u003e5.0.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRequestVote\u003c/code\u003e RPC\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#504-follower-处理循环52\" id=\"markdown-toc-504-follower-处理循环52\"\u003e5.0.4 Follower 处理循环（§5.2）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#505-candidate-处理循环52\" id=\"markdown-toc-505-candidate-处理循环52\"\u003e5.0.5 Candidate 处理循环（§5.2）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#506-leader-处理循环52--54\" id=\"markdown-toc-506-leader-处理循环52--54\"\u003e5.0.6 Leader 处理循环（§5.2 ~ §5.4）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#507-raft-五大特性图-3\" id=\"markdown-toc-507-raft-五大特性图-3\"\u003e5.0.7 Raft 五大特性（图 3）\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#51-raft-基础\" id=\"markdown-toc-51-raft-基础\"\u003e5.1 Raft 基础\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#511-状态机\" id=\"markdown-toc-511-状态机\"\u003e5.1.1 状态机\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#512-任期term\" id=\"markdown-toc-512-任期term\"\u003e5.1.2 任期（term）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#513-节点之间通信rpc\" id=\"markdown-toc-513-节点之间通信rpc\"\u003e5.1.3 节点之间通信：RPC\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-leader-选举\" id=\"markdown-toc-52-leader-选举\"\u003e5.2 Leader 选举\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#521-heartbeat-和选举触发流程\" id=\"markdown-toc-521-heartbeat-和选举触发流程\"\u003e5.2.1 Heartbeat 和选举触发流程\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#522-选举过程\" id=\"markdown-toc-522-选举过程\"\u003e5.2.2 选举过程\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#523-获胜的判断条件\" id=\"markdown-toc-523-获胜的判断条件\"\u003e5.2.3 获胜的判断条件\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#524-避免无限循环的投票分裂随机选举超时\" id=\"markdown-toc-524-避免无限循环的投票分裂随机选举超时\"\u003e5.2.4 避免无限循环的投票分裂：随机选举超时\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#53-leader-向其他节点复制日志log\" id=\"markdown-toc-53-leader-向其他节点复制日志log\"\u003e5.3 Leader 向其他节点复制日志（log）\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#531-复制流程\" id=\"markdown-toc-531-复制流程\"\u003e5.3.1 复制流程\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#532-log-文件组织结构\" id=\"markdown-toc-532-log-文件组织结构\"\u003e5.3.2 Log 文件组织结构\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#533-提交commit的定义\" id=\"markdown-toc-533-提交commit的定义\"\u003e5.3.3 提交（commit）的定义\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#534-log-matching-特性保证-log-内容一致\" id=\"markdown-toc-534-log-matching-特性保证-log-内容一致\"\u003e5.3.4 Log matching 特性（保证 log 内容一致）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#535-log-不一致场景\" id=\"markdown-toc-535-log-不一致场景\"\u003e5.3.5 Log 不一致场景\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#536-避免-log-不一致appendentries-中的一致性检查\" id=\"markdown-toc-536-避免-log-不一致appendentries-中的一致性检查\"\u003e5.3.6 避免 log 不一致：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e 中的一致性检查\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#537-优化\" id=\"markdown-toc-537-优化\"\u003e5.3.7 优化\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#54-安全确保状态机以相同顺序执行相同命令流\" id=\"markdown-toc-54-安全确保状态机以相同顺序执行相同命令流\"\u003e5.4 安全：确保状态机以相同顺序执行相同命令流\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#541-限制一包含所有已提交-entry-的节点才能被选为-leader\" id=\"markdown-toc-541-限制一包含所有已提交-entry-的节点才能被选为-leader\"\u003e5.4.1 限制一：包含所有已提交 entry 的节点才能被选为 leader\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#542-限制二当前任期副本数量过半entry-才能提交\" id=\"markdown-toc-542-限制二当前任期副本数量过半entry-才能提交\"\u003e5.4.2 限制二：当前任期+副本数量过半，entry 才能提交\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#543-安全性的简要证明\" id=\"markdown-toc-543-安全性的简要证明\"\u003e5.4.3 安全性的简要证明\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#55-followercandidate-故障无限重试--请求幂等\" id=\"markdown-toc-55-followercandidate-故障无限重试--请求幂等\"\u003e5.5 Follower/candidate 故障：无限重试 + 请求幂等\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#56-时序和可用性\" id=\"markdown-toc-56-时序和可用性\"\u003e5.6 时序和可用性\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-集群节点数量变化membership-changes\" id=\"markdown-toc-6-集群节点数量变化membership-changes\"\u003e6 集群节点数量变化（membership changes）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-增删节点可能导致集群分裂\" id=\"markdown-toc-61-增删节点可能导致集群分裂\"\u003e6.1 增删节点可能导致集群分裂\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#62-解决办法两阶段方式\" id=\"markdown-toc-62-解决办法两阶段方式\"\u003e6.2 解决办法：两阶段方式\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#63-三个问题\" id=\"markdown-toc-63-三个问题\"\u003e6.3 三个问题\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#631-新节点状态为空需要一段时间同步-log引入非投票成员\" id=\"markdown-toc-631-新节点状态为空需要一段时间同步-log引入非投票成员\"\u003e6.3.1 新节点状态为空，需要一段时间同步 log：引入“非投票成员”\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#632-从集群中移除-leader-节点\" id=\"markdown-toc-632-从集群中移除-leader-节点\"\u003e6.3.2 从集群中移除 leader 节点\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#633-被移除的节点不断超时timeout并触发选举\" id=\"markdown-toc-633-被移除的节点不断超时timeout并触发选举\"\u003e6.3.3 被移除的节点不断超时（timeout）并触发选举\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#7-日志压缩log-compaction\" id=\"markdown-toc-7-日志压缩log-compaction\"\u003e7 日志压缩（log compaction）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#71-snapshot\" id=\"markdown-toc-71-snapshot\"\u003e7.1 Snapshot\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#72-增量压缩\" id=\"markdown-toc-72-增量压缩\"\u003e7.2 增量压缩\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#8-客户端交互\" id=\"markdown-toc-8-客户端交互\"\u003e8 客户端交互\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#81-寻找-leader\" id=\"markdown-toc-81-寻找-leader\"\u003e8.1 寻找 leader\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#82-可线性化语义避免重复执行同一客户端的相同命令\" id=\"markdown-toc-82-可线性化语义避免重复执行同一客户端的相同命令\"\u003e8.2 可线性化语义（避免重复执行同一客户端的相同命令）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#83-只读操作\" id=\"markdown-toc-83-只读操作\"\u003e8.3 只读操作\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#9-实现与评估\" id=\"markdown-toc-9-实现与评估\"\u003e9 实现与评估\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#91-可理解性\" id=\"markdown-toc-91-可理解性\"\u003e9.1 可理解性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#92-正确性\" id=\"markdown-toc-92-正确性\"\u003e9.2 正确性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#93-性能\" id=\"markdown-toc-93-性能\"\u003e9.3 性能\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#10-相关工作\" id=\"markdown-toc-10-相关工作\"\u003e10 相关工作\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#11-总结\" id=\"markdown-toc-11-总结\"\u003e11 总结\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#12-致谢\" id=\"markdown-toc-12-致谢\"\u003e12 致谢\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考文献\" id=\"markdown-toc-参考文献\"\u003e参考文献\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"摘要\"\u003e摘要\u003c/h1\u003e\n\n\u003cp\u003eRaft 是一个管理\u003cstrong\u003e\u003cmark\u003e复制式日志\u003c/mark\u003e\u003c/strong\u003e（replicated log）的\u003cstrong\u003e\u003cmark\u003e共识算法\n\u003c/mark\u003e\u003c/strong\u003e（consensus algorithm）。它的最终结果与 (multi-) Paxos 等价，也与 Paxos\n一样高效，但\u003cstrong\u003e\u003cmark\u003e结构\u003c/mark\u003e\u003c/strong\u003e（structure）与 Paxos 不同 ——\n这使得它\u003cstrong\u003e\u003cmark\u003e比 Paxos 更好理解，也更易于构建实际系统\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e为易于理解，Raft 在设计上将共识拆分为 leader election、log replication、safety 等几个模块；\n另外，为减少状态数量，它要求有\u003cstrong\u003e\u003cmark\u003e更强的一致性\u003c/mark\u003e\u003c/strong\u003e（a stronger degree of coherency）。\n从结果来看，学生学习 Raft 要比学习 Paxos 容易。\u003c/p\u003e\n\n\u003cp\u003eRaft 还引入了一个新的\u003cstrong\u003e\u003cmark\u003e集群变更\u003c/mark\u003e\u003c/strong\u003e（添加或删除节点）机制，利用\n\u003cstrong\u003e\u003cmark\u003e重叠大多数\u003c/mark\u003e\u003c/strong\u003e（overlapping majorities）特性来保证安全（不会发生冲突）。\u003c/p\u003e\n\n\u003ch1 id=\"1-引言\"\u003e1 引言\u003c/h1\u003e\n\n\u003cp\u003e共识算法使多个节点作为一个整体协同工作，这样部分节点出故障时，系统作为一个整体\n仍然可用。在构建可靠的大规模软件系统时，共识算法扮演着核心角色。\u003c/p\u003e\n\n\u003ch2 id=\"11-本文背景与目的\"\u003e1.1 本文背景与目的\u003c/h2\u003e\n\n\u003cp\u003e过去十几年，共识算法领域一直被 \u003cstrong\u003e\u003cmark\u003ePaxos 牢牢统治\u003c/mark\u003e\u003c/strong\u003e [15, 16]：大部分\n共识算法的实现都基于 Paxos 或者受其影响，而 Paxos 也成了\u003cstrong\u003e\u003cmark\u003e教学\u003c/mark\u003e\u003c/strong\u003e的\n首要选择。\u003c/p\u003e\n\n\u003cp\u003e不幸的是，虽然已经有很多更通俗解释 Paxos 的尝试，但 Paxos 仍然\u003cstrong\u003e\u003cmark\u003e难以理解\u003c/mark\u003e\u003c/strong\u003e。\n此外，Paxos 需要做很复杂的\u003cstrong\u003e\u003cmark\u003e架构改动\u003c/mark\u003e\u003c/strong\u003e才能应用到真实系统中。因此，\n系统开发者和学生都对 Paxos 感到困惑 —— 我们自己也是如此，在经历了一番挣扎之后，我\n们最终决定\u003cstrong\u003e\u003cmark\u003e寻找一种新的\u003c/mark\u003e\u003c/strong\u003e、能为真实系统和日常教学提供更好基础的\u003cstrong\u003e\u003cmark\u003e共识算法\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e这个新算法的\u003cstrong\u003e\u003cmark\u003e首要目标是可理解性\u003c/mark\u003e\u003c/strong\u003e（understandability）：\n能否提出一个可用于实际系统、能以恰当方式描述、比 Paxos 更容易学习的共识算法？\u003c/li\u003e\n  \u003cli\u003e此外，这个算法要能被系统架构师和开发者\u003cstrong\u003e\u003cmark\u003e更直观地理解\u003c/mark\u003e\u003c/strong\u003e。\n算法能工作固然很重要，但这还不够，还要让人能很直观地理解它为什么可以工作。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"12-研究成果简介\"\u003e1.2 研究成果简介\u003c/h2\u003e\n\n\u003cp\u003e这项工作的成果就是本文将介绍的 Raft 共识算法。\n我们特意采取了一些技术\u003cstrong\u003e\u003cmark\u003e来使它更容易理解\u003c/mark\u003e\u003c/strong\u003e，包括\n\u003cstrong\u003e\u003cmark\u003e功能模块分解\u003c/mark\u003e\u003c/strong\u003e（leader election, log replication, and safety) 和\n\u003cstrong\u003e\u003cmark\u003e状态空间简化\u003c/mark\u003e\u003c/strong\u003e（相比于 Paxos，Raft 中不确定性程度和节点不一致的场景数量都变少了）。\n一项针对两个学校共计 43 名学生的调查显示，\u003cstrong\u003e\u003cmark\u003eRaft 要比 Paxos 好理解地多\u003c/mark\u003e\u003c/strong\u003e：\n在学习了这两种算法之后，33 个同学回答 Raft 的问题要比回答 Paxos 的问题好。\u003c/p\u003e\n\n\u003cp\u003eRaft 在很多方面与现有的共识算法（例如 Viewstamped Replication [29, 22]）类似，但也有几个新特征：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eStrong leader\u003c/mark\u003e\u003c/strong\u003e（强领导者）: 使用更强的 leadership 模型。例如，\n\u003cstrong\u003e\u003cmark\u003elog entries 只会从 leader 往其他节点同步\u003c/mark\u003e\u003c/strong\u003e。这简化了 replicated log 的管理，使 Raft 理解上更简单。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLeader election\u003c/mark\u003e\u003c/strong\u003e（领导选举）: 使用\u003cstrong\u003e\u003cmark\u003e随机定时器\u003c/mark\u003e\u003c/strong\u003e来选举 leader，并复用了\n任何共识算法本来就都有 heartbeat 机制（只是在 heartbeat 里增加了一点新东西），还能简单、快速地解决冲突。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eMembership changes\u003c/mark\u003e\u003c/strong\u003e（节点变更）: 使用一种新的\u003cstrong\u003e\u003cmark\u003e联合共识\u003c/mark\u003e\u003c/strong\u003e\n  （joint consensus）方式，特点是新老配置所覆盖的两个大多数（majorities）子集\n在变更期间是有重叠的，并且集群还能正常工作。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e我们认为不管用于教学还是真实系统，Raft 都比 Paxos 和其他共识算法更好，它的优点包括，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e更简单、更易理解；\u003c/li\u003e\n  \u003cli\u003e描述足够详细，易于工业界实现（已经有几种开源实现并在一些公司落地）；\u003c/li\u003e\n  \u003cli\u003e安全性（无冲突）有规范化描述并经过了证明；\u003c/li\u003e\n  \u003cli\u003e效率与其他算法相当。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"13-本文组织结构\"\u003e1.3 本文组织结构\u003c/h2\u003e\n\n\u003cp\u003e本文接下来的内容安排如下：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eSection 2：介绍 replicated state machine；\u003c/li\u003e\n  \u003cli\u003eSection 3：讨论 Paxos 的优缺点；\u003c/li\u003e\n  \u003cli\u003eSection 4：介绍我们针对可理解性所采取的一些设计；\u003c/li\u003e\n  \u003cli\u003eSection 5-8：描述 Raft 共识算法；\u003c/li\u003e\n  \u003cli\u003eSection 9：实现与评估；\u003c/li\u003e\n  \u003cli\u003eSection 10：相关工作。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"2-复制式状态机replicated-state-machines\"\u003e2 复制式状态机（replicated state machines）\u003c/h1\u003e\n\n\u003cp\u003e讨论 replicated state machines [37] 时，通常都会涉及到共识算法。在这种模型中，\n若干节点上的状态机\u003cstrong\u003e\u003cmark\u003e计算同一状态的相同副本\u003c/mark\u003e\u003c/strong\u003e（compute identical\ncopies of the same state），即使其中一些节点挂掉了，系统整体仍然能继续工作。\u003c/p\u003e\n\n\u003ch2 id=\"21-使用场景\"\u003e2.1 使用场景\u003c/h2\u003e\n\n\u003cp\u003e复制式状态机\u003cstrong\u003e\u003cmark\u003e用于解决分布式系统中的一些容错（fault tolerance）问题\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e例如，GFS [8]、HDFS [38]、RAMCloud [33] 等单 leader 大型系统，通常用一个\n独立的复制式状态机来管理 leader election 及存储配置信息。\nChubby [2] 和 ZooKeeper [11] 也用到了复制式状态机。\u003c/p\u003e\n\n\u003ch2 id=\"22-状态机架构\"\u003e2.2 状态机架构\u003c/h2\u003e\n\n\u003cp\u003e复制式状态机\u003cstrong\u003e\u003cmark\u003e通常用 replicated log\u003c/mark\u003e\u003c/strong\u003e（复制式日志）实现，如图 1 所示，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/1.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 1. \u003cmark\u003e复制式状态机架构\u003c/mark\u003e。\n共识算法管理着\u003cmark\u003e客户端发来的状态机命令\u003c/mark\u003e的一个\u003cmark\u003e日志副本\u003c/mark\u003e\n（replicated log），状态机以完全相同的顺序执行日志中的命令，因此产生\u003cmark\u003e完全相同的输出\u003c/mark\u003e。\n\u003c/p\u003e\n\n\u003cp\u003e几点解释：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e每台 server 都保存着一个由\u003cstrong\u003e\u003cmark\u003e命令序列组成的 log 文件\u003c/mark\u003e\u003c/strong\u003e，状态机按\n顺序执行其中的命令。由于每个 log 都以完全相同的顺序保存了完全相同的命令，而\n且状态机是确定性的（deterministic），因此每个状态机计算得到的是相同的状态，\n产生的是相同的结果。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e保持 replicated log 的一致性\u003c/mark\u003e\u003c/strong\u003e是共识算法的职责。某个节点上的\n\u003cstrong\u003e\u003cmark\u003e共识模块\u003c/mark\u003e\u003c/strong\u003e从客户端接收命令，然后写入 log 中；并与其他\n节点上的共识模块通信，以保证即使某些机器挂掉，每个 replicated log 最终也以\n相同的顺序包含相同的请求。\u003c/li\u003e\n  \u003cli\u003e命令正确地复制到其他节点之后，每台机器的状态机会按顺序处理他们，然后将结果返回给客\n户端。从客户端的角度来看，这些节点形成的是高度可靠的单个状态机。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"23-共识算法的典型特征\"\u003e2.3 共识算法的典型特征\u003c/h2\u003e\n\n\u003cp\u003e对于实际系统来说，共识算法有如下典型特性：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e在任何 \u003cstrong\u003e\u003cmark\u003enon-Byzantine 条件下都能保证安全\u003c/mark\u003e\u003c/strong\u003e（从不返回错误结果），\n这里所说的 non-Byzantine 条件包括网络延迟、partitions、丢包、重复、乱序。\u003c/li\u003e\n  \u003cli\u003e只要多数节点能工作、彼此之间及与客户端之间能通信，那整体系统的功能就完全正常（完全可用）；\n因此，一个有 5 台节点的集群，能容忍任意 2 台机器的挂掉。\u003c/li\u003e\n  \u003cli\u003e机器挂掉后，能够从持久存储中恢复，然后重新加入集群；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e不依赖时序（timing）来保证日志的一致性\u003c/mark\u003e\u003c/strong\u003e：在最坏情况下，时钟不准\n和极大的消息延迟都会导致可用性问题，因此避免依赖时序来保证一致性。\u003c/li\u003e\n  \u003cli\u003e通常情况下，\u003cstrong\u003e\u003cmark\u003e一条命令收到了集群大多数节点的响应\u003c/mark\u003e\u003c/strong\u003e时，这条命令就算完成了；\n\u003cstrong\u003e\u003cmark\u003e少量响应慢的机器不影响整体的系统性能\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"3-paxos-有什么问题\"\u003e3 Paxos 有什么问题？\u003c/h1\u003e\n\n\u003cp\u003e在过去的十几年，Leslie Lamport 的 Paxos [15] 协议几乎是共识算法的代名词：\n学校里教的基本上都是它，大部分共识算法的实现也是以它为起点。\u003c/p\u003e\n\n\u003ch2 id=\"31-paxos-简介\"\u003e3.1 Paxos 简介\u003c/h2\u003e\n\n\u003cul\u003e\n  \u003cli\u003e首先\u003cstrong\u003e\u003cmark\u003e定义了一个协议\u003c/mark\u003e\u003c/strong\u003e，能让\u003cstrong\u003e\u003cmark\u003e单个决议\u003c/mark\u003e\u003c/strong\u003e（\nsingle decision）达成一致，例如\u003cstrong\u003e\u003cmark\u003e单条 log entry\u003c/mark\u003e\u003c/strong\u003e。\n这个子集称为 single-decree（单决议） Paxos。\u003c/li\u003e\n  \u003cli\u003e通过组合\u003cstrong\u003e\u003cmark\u003e协议的多个实例\u003c/mark\u003e\u003c/strong\u003e（multiple instances of this protocol）\n提供\u003cstrong\u003e\u003cmark\u003e决议序列\u003c/mark\u003e\u003c/strong\u003e的功能，例如一个 \u003cstrong\u003e\u003cmark\u003elog file\u003c/mark\u003e\u003c/strong\u003e\n（而非单个 log entry），称为 multi-decree（多决议）Paxos。\u003c/li\u003e\n  \u003cli\u003e同时保证保证 safety and liveness，支持集群扩缩容节点。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e正确性已经得到证明\u003c/mark\u003e\u003c/strong\u003e，在一般情况下也是高效的（efficient）。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"32-paxos-的缺点\"\u003e3.2 Paxos 的缺点\u003c/h2\u003e\n\n\u003cp\u003e不幸的是，Paxos 有两个致命缺点：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e出名地难理解（exceptionally difficult）；\u003c/li\u003e\n  \u003cli\u003e没有考虑真实系统的实现，很难用于实际系统。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e下面分别解释。\u003c/p\u003e\n\n\u003ch3 id=\"321-理解异常困难\"\u003e3.2.1 理解异常困难\u003c/h3\u003e\n\n\u003cp\u003ePaxos 的完整解释 [15] 众所周知地模糊，只有\u003cstrong\u003e\u003cmark\u003e少数人\u003c/mark\u003e\u003c/strong\u003e —— 并且\n是在付出了极大的努力之后 —— 才成功理解了它。因此，出现了很多用更简单的术语\n来解释 Paxos 的尝试 [16, 20, 21]，这些解释关注在单决议子集上，但仍然很有挑战性。\u003c/p\u003e\n\n\u003cp\u003e在 NSDI 2012 的一次正式调研上，我们发现很少有人对 Paxos 感到舒适（comfortable）\n，甚至包括那些资深研究者。我们自己也非常挣扎 —— 实际上直到\n\u003cstrong\u003e\u003cmark\u003e阅读了一些简化版解释性文章、并自己设计和实现了一种替代协议\u003c/mark\u003e\u003c/strong\u003e之后，\n我们才\u003cstrong\u003e\u003cmark\u003e完全理解\u003c/mark\u003e\u003c/strong\u003e了整个 Paxos 协议，整个过程用了几乎\u003cstrong\u003e\u003cmark\u003e一年\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e我们认为 \u003cstrong\u003e\u003cmark\u003ePaxos 的模糊性\u003c/mark\u003e\u003c/strong\u003e来源于它把单决议子集作为了它的基础。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e单决议 Paxos 比较 dense 和 subtle，它分为了\u003cstrong\u003e\u003cmark\u003e没有简单直观解释\u003c/mark\u003e\u003c/strong\u003e\n的两个阶段，二者无法独立理解。由于这个原因，很难直观地解释为什么 single-decree 协议是工作的。\u003c/li\u003e\n  \u003cli\u003e多决议 Paxos 的组合规则\u003cstrong\u003e\u003cmark\u003e显著增加了额外的复杂性和模糊性\u003c/mark\u003e\u003c/strong\u003e。\n我们认为\u003cstrong\u003e\u003cmark\u003e在多个决策上\u003c/mark\u003e\u003c/strong\u003e（例如一个 log 而非仅仅一个 log entry）\n\u003cstrong\u003e\u003cmark\u003e达到共识这一整体问题\u003c/mark\u003e\u003c/strong\u003e，能以其他更直接和浅白的方式进行分解。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"322-没有考虑真实系统的实现\"\u003e3.2.2 没有考虑真实系统的实现\u003c/h3\u003e\n\n\u003cp\u003ePaxos 没有为构建真实系统提供一个良好的基础，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e一个原因是\u003cstrong\u003e\u003cmark\u003e没有一个普遍接受的 multi-decree Paxos 算法\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003eLamport 的描述大部分是关于 single-decree Paxos 的，\u003c/li\u003e\n      \u003cli\u003e他简要描述了实现 multi-decree Paxos 的几种可能方式，但很多细节是缺失的，\u003c/li\u003e\n      \u003cli\u003e一些算法尝试对 Paxos 进行具体化和优化 [26] [39] [13]，但这些算法并不统一，与 Lamport 的概要描述也并不一致，\u003c/li\u003e\n      \u003cli\u003eChubby [4] 等系统已经实现了类似 Paxos 的算法，但大部分此类系统的\u003cstrong\u003e\u003cmark\u003e实现细节都没有公开\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003ePaxos 架构对于构建真实系统来说非常糟糕，其实也是 \u003cstrong\u003e\u003cmark\u003emulti-decree 靠 single-decree 来组合\u003c/mark\u003e\u003c/strong\u003e的另一个结果。\n  例如，独立选择多个 log entry 然后合并成一个顺序 log 并没有多少好处，只会增加复杂性。\n  \u003cstrong\u003e\u003cmark\u003e围绕单个 log 设计系统会更加简单和高效\u003c/mark\u003e\u003c/strong\u003e，新的 entry 以严格方式顺序追加到这个 log 文件。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003ePaxos 的核心是一个对称点对点模型\u003c/mark\u003e\u003c/strong\u003e（symmetric peer-to-peer） ——\n  虽然它最终出于性能考虑建议了一个\u003cstrong\u003e\u003cmark\u003e弱领导力模型\u003c/mark\u003e\u003c/strong\u003e。\n  在一个\u003cstrong\u003e\u003cmark\u003e简化的、只需做出单个决定的世界中，这样是有意义的\u003c/mark\u003e\u003c/strong\u003e，但实际系统并不满足这个前提。\n  如果需要做出多个决策，那还是先选举一个 leader，然后由 leader 来协调决策更加简单和快速。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e这些问题导致的最终结果就是：\u003cstrong\u003e\u003cmark\u003e实际系统与 Paxos 算法本身差异非常大\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e每种实现都是以 Paxos 为起点，但在实现过程中遇到各种困难，最后开发出的是一个与最初设想迥异的架构。\u003c/li\u003e\n  \u003cli\u003e非常花时间，而且很容易出错，加剧了 Paxos 的理解难度。\u003c/li\u003e\n  \u003cli\u003ePaxos 的公式对于定理证明来说可能不错，但实际实现与公式是如此不同，导致证明并没有多少意义。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eChubby 开发者的评论很有代表性：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e\u003cstrong\u003e\u003cmark\u003ePaxos 的算法描述和真实需求之间存在一个巨大鸿沟，......\n最终的系统其实将建立在一个没有经过证明的协议之上\u003c/mark\u003e\u003c/strong\u003e [4]。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch2 id=\"33-小结\"\u003e3.3 小结\u003c/h2\u003e\n\n\u003cp\u003e由于以上问题，我们认为 Paxos 既不能为开发真实系统提供良好基础，又不适用于教学。\n而考虑到\u003cstrong\u003e\u003cmark\u003e大型软件系统中共识的重要性\u003c/mark\u003e\u003c/strong\u003e，我们决定自己设计一种替代\nPaxos、有更好特性的共识算法。\u003c/p\u003e\n\n\u003cp\u003eRaft 就是这一实验的产物。\u003c/p\u003e\n\n\u003ch1 id=\"4-面向可理解性的设计\"\u003e4 面向可理解性的设计\u003c/h1\u003e\n\n\u003ch2 id=\"41-设计目标\"\u003e4.1 设计目标\u003c/h2\u003e\n\n\u003cp\u003e设计 Raft 时我们有几个目标：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e必须为\u003cstrong\u003e\u003cmark\u003e构建真实系统\u003c/mark\u003e\u003c/strong\u003e提供完整基础，能显著降低系统开发者所需的设计工作；\u003c/li\u003e\n  \u003cli\u003e必须在所有情况下确保安全（不会导致冲突），在典型场景下确保可用；\u003c/li\u003e\n  \u003cli\u003e对于常见操作必须很高效，\u003c/li\u003e\n  \u003cli\u003e必须确保\u003cstrong\u003e\u003cmark\u003e可理解性\u003c/mark\u003e\u003c/strong\u003e（understandability），这才是我们\u003cstrong\u003e\u003cmark\u003e最重要的目标，同时也是最大的挑战\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e对于一大部分受众来说，这个算法要很好理解。另外，它必须很直观，这样系统构建者在\n实现时能方便地进行扩展 —— 这一需求在真实世界中是必然存在的。\u003c/p\u003e\n\n\u003ch2 id=\"42-可理解性的评估\"\u003e4.2 可理解性的评估\u003c/h2\u003e\n\n\u003cp\u003e在设计 Raft 时，有好多次我们都必须在多种可选方案中做出抉择，我们的评估依据\n就是可理解性：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e每种方案\u003cstrong\u003e\u003cmark\u003e解释起来的难易程度\u003c/mark\u003e\u003c/strong\u003e（例如，该方案的状态空间有多复杂，该方案有没有模糊之处等）\u003c/li\u003e\n  \u003cli\u003e读者能\u003cstrong\u003e\u003cmark\u003e多轻松地完全理解这种方案\u003c/mark\u003e\u003c/strong\u003e？\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这其中必然有很大的主观性，但我们使用的两种方式还是比较通用的：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e问题分解\u003c/mark\u003e\u003c/strong\u003e：将问题尽可能分解为独立的可解决、可解释和可理解的模块。\u003c/p\u003e\n\n    \u003cp\u003e例如，将 leader election、log replication、safety、membership changes 拆分开来。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e简化状态空间\u003c/mark\u003e\u003c/strong\u003e：减少需要考虑的状态数量，使系统更加清晰，尽量消除非确定性（nondeterminism）。\u003c/p\u003e\n\n    \u003cp\u003e具体来说，\u003cstrong\u003e\u003cmark\u003elog 不允许有空洞\u003c/mark\u003e\u003c/strong\u003e（holes），而且 Raft 会避免各机器的 log 出现不一致。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e虽然在大部分情况下我们极力避免\u003cstrong\u003e\u003cmark\u003e非确定性\u003c/mark\u003e\u003c/strong\u003e，但在某些场景下，它却会\u003cstrong\u003e\u003cmark\u003e提高可理解性\u003c/mark\u003e\u003c/strong\u003e。\n尤其是，随机化方式（randomized approaches）会引入非确定性，但它们通过\n“以同一种方式处理所有情况”（choose any; it doesn’t matter），让状态空间变得更小。\n我们用随机化来\u003cstrong\u003e\u003cmark\u003e简化 leader 选举\u003c/mark\u003e\u003c/strong\u003e算法。\u003c/p\u003e\n\n\u003ch1 id=\"5-raft-共识算法\"\u003e5 Raft 共识算法\u003c/h1\u003e\n\n\u003cp\u003eRaft 是一个管理 replicated log 的算法。图 2 提炼了它的核心点作为索引和参考，\n图 3 总结了该算法的一些核心特性；后文将详细介绍其中的细节。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e图 2 和 3 都是用大文本框描述算法，很不直观，这里直接拆成段落作为 5.0 小节，\n并对照 etcd/raft 的实现，方便理解。译注。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eRaft 实现共识的机制\u003c/mark\u003e\u003c/strong\u003e是，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e共同选举出一个 leader，\u003c/li\u003e\n  \u003cli\u003e给予这个 leader 管理 replicated log 的完全职责，\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLeader 接受来自客户端的 log entries\u003c/mark\u003e\u003c/strong\u003e，然后复制给其他节点，\n  并在安全（不会导致冲突）时，告诉这些节点将这些 entries 应用到它们各自的状态机。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e只有一个 leader 的设计简化了 replicated log 的管理\u003c/mark\u003e\u003c/strong\u003e。例如，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eLeader 能决定将新的 entry 放到 log 中的什么位置，而不用咨询其他机器，\u003c/li\u003e\n  \u003cli\u003e数据流也是从 leader 到其他节点的简单单向方式。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eLeader 可能会挂掉（fail）或从集群中失联（disconnected），这种情况下会选举一个新 leader。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e基于以上 leader 机制\u003c/mark\u003e\u003c/strong\u003e，Raft 将共识问题分解为三个相对独立的子问题，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eLeader election (Section 5.2)\u003c/li\u003e\n  \u003cli\u003eLog replication (Section 5.3)\u003c/li\u003e\n  \u003cli\u003eSafety (Section 5.4)\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e介绍了共识算法之后，本节还会讨论可用性（availability）问题，以及时序（timing）在系统中的角色。\u003c/p\u003e\n\n\u003ch2 id=\"50-raft-核心知识点提前汇总\"\u003e5.0 Raft 核心知识点（提前）汇总\u003c/h2\u003e\n\n\u003ch3 id=\"501-不同节点的状态参数\"\u003e5.0.1 不同节点的状态参数\u003c/h3\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e所有节点上的\u003cstrong\u003e\u003cmark\u003e持久状态\u003c/mark\u003e\u003c/strong\u003e：处理客户端请求时，需要\n  \u003cstrong\u003e\u003cmark\u003e先更新这些持久状态（存储在稳定介质上），再响应请求\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\n        \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurrentTerm\u003c/code\u003e：\u003cstrong\u003e\u003cmark\u003e该节点已知的当前任期\u003c/mark\u003e\u003c/strong\u003e。节点启动时初始化为 0，然后单调递增。\u003c/p\u003e\n\n        \u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/log.go#L112\u003c/span\u003e\n\n \u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n         \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartTerm\u003c/span\u003e\n     \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \n     \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"c\"\u003e// 最后一个已提交 entry 所属的任期\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e        \u003c/div\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evotedFor\u003c/code\u003e：\u003cstrong\u003e\u003cmark\u003e投票给谁\u003c/mark\u003e\u003c/strong\u003e（candidateId）；如果没有就是 none；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elog[]\u003c/code\u003e：log entries，索引从 1 开始；每个 entry 包含了状态机命令和 leader 收到这个 entry 时的 term 信息。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e所有节点上的\u003cstrong\u003e\u003cmark\u003e易失状态\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecommitIndex\u003c/code\u003e：最后\u003cstrong\u003e\u003cmark\u003e提交的 entry 的 index\u003c/mark\u003e\u003c/strong\u003e；初始化为 0，然后单调递增；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elastAppliedIndex\u003c/code\u003e：最后 \u003cstrong\u003e\u003cmark\u003eapply 到状态机的 index\u003c/mark\u003e\u003c/strong\u003e ；初始化为 0，单调递增；\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003eLeader\u003c/mark\u003e\u003c/strong\u003e 节点上的\u003cstrong\u003e\u003cmark\u003e易失状态\u003c/mark\u003e\u003c/strong\u003e：选举之后重新初始化\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[]\u003c/code\u003e，\u003cstrong\u003e\u003cmark\u003e为每个节点分别维护的编号，下次 replicate entry 时用\u003c/mark\u003e\u003c/strong\u003e；初始化为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eleader_last_log_index + 1\u003c/code\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ematchIndex[]\u003c/code\u003e ，为每个节点分别维护的编号，表示\u003cstrong\u003e\u003cmark\u003e已知的、复制成功的最大 index\u003c/mark\u003e\u003c/strong\u003e；初始化为 0，单调递增。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"502-appendentries-rpc\"\u003e5.0.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e RPC\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003e用途：由 leader 发起，用于 replicate log entries (§5.3)，\u003cstrong\u003e\u003cmark\u003e也用作心跳\u003c/mark\u003e\u003c/strong\u003e §5.2；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e参数：\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm\u003c/code\u003e：leader 的任期编号；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eleaderId\u003c/code\u003e：\u003cstrong\u003e\u003cmark\u003efollower 重定向客户端\u003c/mark\u003e\u003c/strong\u003e时会用到；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprevLogIndex\u003c/code\u003e：上一个 log entry 的 index；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprevLogTerm\u003c/code\u003e：prevLogIndex entry 的 term；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eentries[]\u003c/code\u003e：需要追加到 log 的新 entry（如果是 heartbeat，那数组为空；否则出于效率考虑可能会有多个）；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eleaderCommit\u003c/code\u003e：leader 的 commitIndex；\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e返回结果\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm\u003c/code\u003e：currentTerm，leader 用来更新它自己；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esuccess\u003c/code\u003e：如果 follower 包含了匹配 prevLogIndex and prevLogTerm 的 entry，则返回 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etrue\u003c/code\u003e。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e看一段代码就比较清楚了：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/log.go#L467\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eappendEntries\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprotobuf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSeek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 定位到起始写入位置\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// Append each entry util hit an error.\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elogEntry\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e       \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e             \u003cspan class=\"c\"\u003e// 日志文件\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e  \u003cspan class=\"n\"\u003estartPosition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c\"\u003e// 起始写入位置\u003c/span\u003e\n            \u003cspan class=\"n\"\u003epb\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e        \u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e    \u003cspan class=\"c\"\u003e// 待写入 log entry\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewriteEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estartPosition\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ewriteEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"n\"\u003eio\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elastEntry\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c\"\u003e// 上一个已经写入日志的 entry\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003elastEntry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e           \u003cspan class=\"c\"\u003e// 待写入 entry 所带的任期号不能小于前一 entry 所带的任期号\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;raft.Log: Cannot append entry with earlier term\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003elastEntry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;=\u003c/span\u003e \u003cspan class=\"n\"\u003elastEntry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eIndex\u003c/span\u003e \u003cspan class=\"c\"\u003e// 写入位置必须在前一个 entry 之后\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;raft.Log: Cannot append entry with earlier index in the same term\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 写到持久存储，然后就可以 append 到 entries list 了\u003c/span\u003e\n    \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"503-requestvote-rpc\"\u003e5.0.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRequestVote\u003c/code\u003e RPC\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003e用途：由 candidate 发起，用于收集选票（gather votes），将在 §5.2 介绍；\u003c/li\u003e\n  \u003cli\u003e参数：\n    \u003cul\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm\u003c/code\u003e candidate’s term\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecandidateId\u003c/code\u003e candidate requesting vote\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elastLogIndex\u003c/code\u003e index of candidate’s last log entry (§5.4)\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elastLogTerm\u003c/code\u003e term of candidate’s last log entry (§5.4)\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e返回结果\n    \u003cul\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm\u003c/code\u003e currentTerm, for candidate to update itself\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evoteGranted\u003c/code\u003e true means candidate received vote\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e同样，看一段代码就很清楚了：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L1071\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eprocessRequestVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCandidateName\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"c\"\u003e// Candidate 节点不在本集群，直接 deny\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e   \u003cspan class=\"c\"\u003e// 请求来自更早的任期（old term），直接拒绝\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 看到了比本节点还要新的任期号（term number），update 到本节点\u003c/span\u003e\n        \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eupdateCurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evotedFor\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evotedFor\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCandidateName\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 当前节点已经投给了其他 candidate\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elastInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLastLogIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003elastTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLastLogTerm\u003c/span\u003e \u003cspan class=\"c\"\u003e// 如果 candidate 的 log 比我们的要老，则不投给它\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 投票给该 candidate，然后重置本节点的 election timeout\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evotedFor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCandidateName\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003enewRequestVoteResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"504-follower-处理循环52\"\u003e5.0.4 Follower 处理循环（§5.2）\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003e对来自 candidate 和 leader 的 RPC 请求做出响应；\u003c/li\u003e\n  \u003cli\u003e如果\u003cstrong\u003e\u003cmark\u003e直到 election timeout\u003c/mark\u003e\u003c/strong\u003e 都没从当前 leader 收到\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e RPC，也没有投票给某个 candidate，则\u003cstrong\u003e\u003cmark\u003e转入 candidate 状态\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e状态机：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L664\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003efollowerLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eFollower\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eJoinCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"c\"\u003e//If no log entries exist and a self-join command is issued then immediately become leader and commit entry.\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNodeName\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLeader\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"c\"\u003e// If heartbeats get too close to the election timeout then send an event.\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eelapsedTime\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eelectionTimeout\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeoutThresholdPercent\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDispatchEvent\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeoutThresholdEventType\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessRequestVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eSnapshotRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessSnapshotRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003etimeoutChan\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCandidate\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003etimeoutChan\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eafterBetween\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"505-candidate-处理循环52\"\u003e5.0.5 Candidate 处理循环（§5.2）\u003c/h3\u003e\n\n\u003cp\u003e转成 candidate 角色之后，立即\u003cstrong\u003e\u003cmark\u003e开始选举\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e增大 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurrentTerm\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e投票给自己\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e重置选举定时器\u003c/li\u003e\n  \u003cli\u003e发送 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eRequestVote\u003c/code\u003e RPCs 给其他所有节点\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e根据结果，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果收到了大多数节点的赞成票，则成为 leader；\u003c/li\u003e\n  \u003cli\u003e如果从新 leader 收到了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e RPC，则转入 follower 角色；\u003c/li\u003e\n  \u003cli\u003e如果 election timeout，再次开始选举。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e状态机：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L730\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// The event loop that is run when the server is in a Candidate state.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecandidateLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprevLeader\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eleader\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eleader\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elastLogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastLogTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elastInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edoVote\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"n\"\u003evotesGranted\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eCandidate\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003edoVote\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e      \u003cspan class=\"c\"\u003e// Increment current term, vote for self.\u003c/span\u003e\n            \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evotedFor\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\n\n            \u003cspan class=\"c\"\u003e// Send RequestVote RPCs to all other servers.\u003c/span\u003e\n            \u003cspan class=\"n\"\u003erespChan\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003echan\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epeer\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                 \u003cspan class=\"n\"\u003esendVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastLogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastLogTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003erespChan\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c\"\u003e// Wait for either:\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e//   * Votes received from majority of servers: become leader\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e//   * AppendEntries RPC received from new leader: step down.\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e//   * Election timeout elapses without election resolution: increment term, start new election\u003c/span\u003e\n            \u003cspan class=\"c\"\u003e//   * Discover higher term: step down (§5.1)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003evotesGranted\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n            \u003cspan class=\"n\"\u003etimeoutChan\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eafterBetween\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eElectionTimeout\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"m\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edoVote\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c\"\u003e// If we received enough votes then stop waiting for more votes.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003evotesGranted\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eQuorumSize\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eLeader\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"c\"\u003e// Collect votes from peers.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003erespChan\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessVoteResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003esuccess\u003c/span\u003e\n                \u003cspan class=\"n\"\u003evotesGranted\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"k\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eNotLeaderError\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessRequestVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"c\"\u003e// Callback to event.\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003etimeoutChan\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edoVote\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"506-leader-处理循环52--54\"\u003e5.0.6 Leader 处理循环（§5.2 ~ §5.4）\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003e定期发送心跳（空的 AppendEntries）给其他节点，防止它们 election timeout (§5.2)\u003c/li\u003e\n  \u003cli\u003e从客户端接受请求，将 entry 追加到 local log，\u003cstrong\u003e\u003cmark\u003e等 entry 应用到状态机之后再发送响应\u003c/mark\u003e\u003c/strong\u003e (§5.3)\u003c/li\u003e\n  \u003cli\u003e对于 follower \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ei\u003c/code\u003e，如果 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elastLogIndex ≥ nextIndex[i]\u003c/code\u003e：将从 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[i]\u003c/code\u003e 开始的所有 log entry 发送给节点 i\n    \u003cul\u003e\n      \u003cli\u003e如果成功：更新 nextIndex[i] 和 matchIndex[i] (§5.3)\u003c/li\u003e\n      \u003cli\u003e如果因为 log inconsistency 失败：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[i]--\u003c/code\u003e 然后重试以上过程 (§5.3)\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e如果存在 N 满足 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eN \u0026gt; commitIndex\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ematchIndex[i] ≥ N\u003c/code\u003e 对大部分 i 成立、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elog[N].term == currentTerm\u003c/code\u003e：设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecommitIndex = N\u003c/code\u003e (§5.3, §5.4).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e状态机：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L811\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eleaderLoop\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elastInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Update the peers prevLogIndex to leader\u0026#39;s lastLogIndex and start heartbeat.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epeer\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epeer\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetPrevLogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epeer\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartHeartbeat\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c\"\u003e// 定期发送心跳\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Commit a NOP after the server becomes leader.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// \u0026#34;Upon election: send initial empty AppendEntries RPCs (heartbeat) to each server.\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDo\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eNOPCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e{})\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Begin to collect response from followers\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eLeader\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eselect\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etarget\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eCommand\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesResponse\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessAppendEntriesResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRequestVoteRequest\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eprocessRequestVoteRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esyncedPeer\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"507-raft-五大特性图-3\"\u003e5.0.7 Raft 五大特性（图 3）\u003c/h3\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eElection Safety\u003c/mark\u003e\u003c/strong\u003e（选举安全）：在任意 term（任期）内，\u003cstrong\u003e\u003cmark\u003e最多只会有一个\u003c/mark\u003e\u003c/strong\u003e leader 被选出来。§5.2\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLeader Append-Only\u003c/mark\u003e\u003c/strong\u003e（只追加）：leader 从不覆盖或删除它的日志中的 entry；只会追加（append）。§5.3\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLog Matching\u003c/mark\u003e\u003c/strong\u003e（日志匹配）：如果两个日志包含了 \u003cstrong\u003e\u003cmark\u003eindex 和 term 完全相同的 entry\u003c/mark\u003e\u003c/strong\u003e，\n  那\u003cstrong\u003e\u003cmark\u003e从这个 index 往前的那些 entry\u003c/mark\u003e\u003c/strong\u003e 也都是完全相同的。§5.3\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLeader Completeness\u003c/mark\u003e\u003c/strong\u003e：如果一个 entry 在某个 term 被提交，那它将出现在所有 term 更大的 leaders 的 log 中。§5.4\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eState Machine Safety\u003c/mark\u003e\u003c/strong\u003e（状态机安全）：如果一个节点在特定\nindex 应用了一个 entry 到它的状态机，那其他节点不会在相同 idnex 应用另一个不同的 entry。§5.4.3\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e以上都是总结，下面看具体细节。\u003c/p\u003e\n\n\u003ch2 id=\"51-raft-基础\"\u003e5.1 Raft 基础\u003c/h2\u003e\n\n\u003cp\u003e一个 Raft cluster 包括若干台节点，例如典型的 5 台，这样一个集群能容忍 2 台节点发生故障。\u003c/p\u003e\n\n\u003ch3 id=\"511-状态机\"\u003e5.1.1 状态机\u003c/h3\u003e\n\n\u003cp\u003e在任意给定时刻，每个节点处于以下\u003cstrong\u003e\u003cmark\u003e三种状态\u003c/mark\u003e\u003c/strong\u003e之一：\nleader、follower、\u003cstrong\u003e\u003cmark\u003ecandidate\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e正常情况下，集群中有且只有一个 leader，剩下的都是 follower。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eFollower 都是被动的\u003c/mark\u003e\u003c/strong\u003e（passive）：它们\u003cstrong\u003e\u003cmark\u003e不会主动发出请求\u003c/mark\u003e\u003c/strong\u003e，只会简单响应来自 leader 和 candidate 的请求。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLeader 负责处理所有的客户端请求\u003c/mark\u003e\u003c/strong\u003e；如果一个客户端向 follower 发起请求，后者会将它重定向到 leader。\u003c/li\u003e\n  \u003cli\u003eCandidate 是一个特殊状态，选举新 leader 时会用到，将在 5.2 节介绍。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e图 4 是相应的状态机，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/4.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 4. \u003cmark\u003eRaft 状态机\u003c/mark\u003e。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eFollower 只会响应来自其他节点的请求；如果一个 follower 某段时间内收不到\nleader 的请求，它会\u003cmark\u003e变成一个 candidate 然后发起一轮选举\u003c/mark\u003e；\u003c/li\u003e\n  \u003cli\u003e获得大多数选票的 candidate 将成为新的 leader；\u003c/li\u003e\n  \u003cli\u003e通常情况下，\u003cstrong\u003e\u003cmark\u003e除非发生故障，否则在任的 leader 会持续担任\u003c/mark\u003e\u003c/strong\u003e下去。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"512-任期term\"\u003e5.1.2 任期（term）\u003c/h3\u003e\n\n\u003cp\u003eRaft 将时间划分为\u003cstrong\u003e\u003cmark\u003e长度不固定的任期\u003c/mark\u003e\u003c/strong\u003e，任期用连续的整数表示，\n如图 5 所示，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/5.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 5. 时间被划分为多个任期（term）。\n\u003c/p\u003e\n\n\u003cp\u003e几点说明：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e每个任期都是从选举开始的\u003c/mark\u003e\u003c/strong\u003e，此时多个 candidate 都试图成为 leader。\u003c/li\u003e\n  \u003cli\u003e某个 candidate 赢得选举后，就会成为该任期内的 leader。\n\u003cstrong\u003e\u003cmark\u003eRaft 保证了在任意一个任期内，最多只会有一个 leader\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e有时选举会失败（投票结果会分裂），这种情况下该任期内就没有 leader\u003c/mark\u003e\u003c/strong\u003e。\n 但问题不大，因为很快将开始新一轮选举（产生一个新任期）。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e不同节点上看到的任期转换时刻可能会不同\u003c/mark\u003e\u003c/strong\u003e。\n 在某些情况下，一个节点\u003cstrong\u003e\u003cmark\u003e可能观察不到某次选举甚至整个任期\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e另外，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eRaft 中，任期是一个\u003cstrong\u003e\u003cmark\u003e逻辑时钟\u003c/mark\u003e\u003c/strong\u003e [14]，用来让各节点\u003cstrong\u003e\u003cmark\u003e检测过期信息\u003c/mark\u003e\u003c/strong\u003e，例如过期的 leader。\u003c/li\u003e\n  \u003cli\u003e每个节点都\u003cstrong\u003e\u003cmark\u003e记录了当前任期号\u003c/mark\u003e\u003c/strong\u003e currentTerm，这个编号随着时间单调递增。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e节点之间通信时，会带上它们各自的 currentTerm 信息；\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e如果一个节点\u003cstrong\u003e\u003cmark\u003e发现自己的 currentTerm 小于其他节点的，要立即更新自己的\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e如果一个 candidate 或 leader \u003cstrong\u003e\u003cmark\u003e发现自己的任期过期了，要立即切换到 follower 状态\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n      \u003cli\u003e如果一个节点接收到携带了过期任期编号（stale term）的请求，会拒绝这个请求。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"513-节点之间通信rpc\"\u003e5.1.3 节点之间通信：RPC\u003c/h3\u003e\n\n\u003cp\u003eRaft 服务器之间通过 RPC 通信，基础的共识算法只需要两种 RPC（前面已经给出了参考实现）：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eRequestVote\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：由 candidates 在选举期间发起 (Section 5.2)；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eAppendEntries\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：由 leader 发起，用于 replicate log entries 并作为一种 heartbeat 方式 (Section 5.3).\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e另外，Section 7 还会看到一种在服务器之间传输 snapshot 用的 RPC。\u003c/p\u003e\n\n\u003cp\u003e如果在一段时间内没有收到响应，服务器会对 RPC 进行重试；另外，为了最佳性能，服务器会并发执行 RPC。\u003c/p\u003e\n\n\u003ch2 id=\"52-leader-选举\"\u003e5.2 Leader 选举\u003c/h2\u003e\n\n\u003ch3 id=\"521-heartbeat-和选举触发流程\"\u003e5.2.1 Heartbeat 和选举触发流程\u003c/h3\u003e\n\n\u003cp\u003eRaft \u003cstrong\u003e\u003cmark\u003e使用一种 heartbeat 机制来触发 leader 选举\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e节点启动时是 follower 状态\u003c/mark\u003e\u003c/strong\u003e；只要能持续从 leader 或\ncandidate 收到合法的 RPC 请求，就会一直保持在 follower 状态；\u003c/li\u003e\n  \u003cli\u003eLeaders 定期\u003cstrong\u003e\u003cmark\u003e发送心跳\u003c/mark\u003e\u003c/strong\u003e给（空的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eAppendEntries\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 消息）所有的 follower，以保持它的权威；\u003c/li\u003e\n  \u003cli\u003e如果一个 follower 在 \u003cstrong\u003e\u003cmark\u003eelection timeout\u003c/mark\u003e\u003c/strong\u003e 时间段内都没有收到来\n自 leader/candidate 的通信，就认为当前已经没有有效 leader 了，然后发起一次选举。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"522-选举过程\"\u003e5.2.2 选举过程\u003c/h3\u003e\n\n\u003cp\u003e对于一个 follower，当开始选举时，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e首先增大自己当前的 term\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e然后切换到 candidate 状态，\u003c/li\u003e\n  \u003cli\u003e然后选举自己作为 leader，同时并发地向集群其他节点发送 RequestVote RPC，\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e然后它将处于 candidate 状态，直到发生以下三种情况之一，下文会分别讨论：\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e该 follower 赢得此次选举，成为 leader；\u003c/li\u003e\n      \u003cli\u003e另一个节点赢得此次选举，成为 leader；\u003c/li\u003e\n      \u003cli\u003e选举超时，没有产生有效 leader。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"523-获胜的判断条件\"\u003e5.2.3 获胜的判断条件\u003c/h3\u003e\n\n\u003cp\u003e如果一个 candidate 获得了\u003cstrong\u003e\u003cmark\u003e集群大多数节点针对同一任期（term）的投票\u003c/mark\u003e\u003c/strong\u003e，\n那它就赢得了这个任期内的选举。\u003c/p\u003e\n\n\u003cp\u003e针对给定的任期，每个节点最多只能投一票，\u003cstrong\u003e\u003cmark\u003e投票的标准是先到先得\u003c/mark\u003e\u003c/strong\u003e（\nfirst-come-first-served，注意，5.4 小节会引入一个额外限制）。“期得获该任期的大\n多数选票”这一限制条件，决定了最多只会有一个 candidate 赢得选举 （也就是图 3 中\n的选举安全特性）。一个 candidate 赢得选举之后，就会为 leader，然后发生心跳消息\n给所有其他节点来建立它的权威，防止新的选举发生。\u003c/p\u003e\n\n\u003cp\u003e在等待投票期间，一个 candidate 可能会从其他服务器收到一个 AppendEntries RPC 声称自己是\nleader。如果这个 leader 的任期 term （包含在 RPC 消息中），\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e大于等于这个 candidate 的 currentTerm\u003c/mark\u003e\u003c/strong\u003e：那该 candidate 就承认\n这个 leader 是合法的，然后回归到 follower 状态。\u003c/li\u003e\n  \u003cli\u003e小于这个 candidate 的 currentTerm：拒绝这个 RPC ，仍然留在 candidate 状态。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e第 3 种可能的结果是：该 candidate 既没有赢得也没有输掉这次选举。\n如果多个 followers 在同一时间成为 candidates，投票就会很分散，最终没有谁能赢得大多数选票。\n当发生这种情况时，每个 candidate 都会超时，然后各自增大 term 并给其他节点发送 RequestVote 请求，开始一轮新选举，\n但\u003cstrong\u003e\u003cmark\u003e如果没有额外的预防措施，这种投票分裂的情况看可能会无限持续下去\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"524-避免无限循环的投票分裂随机选举超时\"\u003e5.2.4 避免无限循环的投票分裂：随机选举超时\u003c/h3\u003e\n\n\u003cp\u003eRaft 使用\u003cstrong\u003e\u003cmark\u003e随机选举超时\u003c/mark\u003e\u003c/strong\u003e来确保投票分裂\n\u003cstrong\u003e\u003cmark\u003e只会非常偶然地发生，并且发生之后能很快恢复正常\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e首先是从一些固定时长（例如 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e150-300ms\u003c/code\u003e）中随机选择一个选举超时时间，这使得节点的\n超时时刻比较分散，在大部分情况下\u003cstrong\u003e\u003cmark\u003e同一时刻最多只有一台会超时\u003c/mark\u003e\u003c/strong\u003e；\n这台超时的节点会\u003cstrong\u003e\u003cmark\u003e在其他节点超时之前赢得选举\u003c/mark\u003e\u003c/strong\u003e（因为它的 term 更大，其他节点都会投票给它）。\u003c/p\u003e\n\n\u003cp\u003e随机化机制也同样用于\u003cstrong\u003e\u003cmark\u003e处理投票分裂\u003c/mark\u003e\u003c/strong\u003e。每个 candidate 在一轮选举开始时，\n会随机重置它的 election timeout，等到 timeout 之后才开始发起新一轮选举；这减少\n了新一轮选举也发生投票分裂的可能性。Section 9.3 会看到，这种方式\u003cstrong\u003e\u003cmark\u003e很快就能选出 leader\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e选举是\u003cstrong\u003e\u003cmark\u003e可理解性如何指导了我们的设计\u003c/mark\u003e\u003c/strong\u003e的一个例子。\n最初我们计划使用的是一个 ranking system: each candidate was assigned a\nunique rank, which was used to select between competing candidates. If a\ncandidate discovered another candidate with higher rank, it would return to\nfollower state so that the higher ranking candidate could more easily win the\nnext election. We found that this approach created subtle issues around\navailability (a lower-ranked server might need to time out and become a\ncandidate again if a higher-ranked server fails, but if it does so too soon, it\ncan reset progress towards electing a leader). We made adjustments to the\nalgorithm several times, but after each adjustment new corner cases appeared.\nEventually we concluded that the randomized retry approach is more obvious and\nunderstandable.\u003c/p\u003e\n\n\u003ch2 id=\"53-leader-向其他节点复制日志log\"\u003e5.3 Leader 向其他节点复制日志（log）\u003c/h2\u003e\n\n\u003ch3 id=\"531-复制流程\"\u003e5.3.1 复制流程\u003c/h3\u003e\n\n\u003cp\u003e选出一个 leader 之后，它就开始服务客户端请求。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e每个客户端请求中都包含一条\u003cstrong\u003e\u003cmark\u003e命令\u003c/mark\u003e\u003c/strong\u003e，将由 \u003cstrong\u003e\u003cmark\u003ereplicated state machine 执行\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003eleader 会将这个命令追加到它自己的 log，然后并发地通过 AppendEntries RPC 复制给其他节点。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e复制成功\u003c/mark\u003e\u003c/strong\u003e（无冲突）之后，\u003cstrong\u003e\u003cmark\u003eleader 才会将这个 entry 应用到自己的状态机，然后将执行结果返回给客户端\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e如果 follower 挂掉了或很慢，或者发生了丢包，leader 会\u003cstrong\u003e\u003cmark\u003e无限重试 AppendEntries 请求（即使它已经给客户端发送了响应）\u003c/mark\u003e\u003c/strong\u003e，\n直到所有 follower 最终都存储了所有的 log entries。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"532-log-文件组织结构\"\u003e5.3.2 Log 文件组织结构\u003c/h3\u003e\n\n\u003cp\u003e如下图所示：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/6.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 6：Log 文件组织方式\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eLog 由 log entry 组成，每个 entry 都是\u003cstrong\u003e\u003cmark\u003e顺序编号\u003c/mark\u003e\u003c/strong\u003e的，这个整数索引标识了该 entry 在 log 中的位置。\u003c/li\u003e\n  \u003cli\u003e每个 entry 包含了\n    \u003col\u003e\n      \u003cli\u003eLeader \u003cstrong\u003e\u003cmark\u003e创建该 entry 时的任期\u003c/mark\u003e\u003c/strong\u003e（term，每个框中的数字），用于检测 logs 之间的不一致及确保图 3 中的某些特性；\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e需要执行的命令\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e当一条 entry 被\u003cstrong\u003e\u003cmark\u003e安全地应用到状态机\u003c/mark\u003e\u003c/strong\u003e之后，就认为这个 entry 已经\u003cstrong\u003e\u003cmark\u003e提交\u003c/mark\u003e\u003c/strong\u003e了（committed）。\u003c/p\u003e\n\n    \u003cp\u003eLeader 来判断何时将一个 log  entry 应用到状态机是安全的。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"533-提交commit的定义\"\u003e5.3.3 提交（commit）的定义\u003c/h3\u003e\n\n\u003cp\u003eRaft 保证\u003cstrong\u003e\u003cmark\u003e已提交的记录都是持久的\u003c/mark\u003e\u003c/strong\u003e，并且最终会被所有可用的状态机执行。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e只要创建这个 entry 的 leader 将它成功\u003cstrong\u003e\u003cmark\u003e复制到大多数节点\u003c/mark\u003e\u003c/strong\u003e（例如图 6 中的 entry 7），这个 entry 就算提交了。\u003c/li\u003e\n  \u003cli\u003e这\u003cstrong\u003e\u003cmark\u003e也提交了\u003c/mark\u003e\u003c/strong\u003e leader log 中的\u003cstrong\u003e\u003cmark\u003e所有前面的 entry\u003c/mark\u003e\u003c/strong\u003e，包括那些之前由其他 leader 创建的 entry。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e5.4 小节会讨论 ldeader 变更之后应用这个规则时的情况，那时将会看到这种对于 commit 的定义也是安全的。\n\u003cstrong\u003e\u003cmark\u003efollower 一旦确定某个 entry 被提交了，就将这个 entry 应用到它自己的状态机\u003c/mark\u003e\u003c/strong\u003e（in log order）。\u003c/p\u003e\n\n\u003ch3 id=\"534-log-matching-特性保证-log-内容一致\"\u003e5.3.4 Log matching 特性（保证 log 内容一致）\u003c/h3\u003e\n\n\u003cp\u003eRaft 这种 log 机制的设计是为了保持\u003cstrong\u003e\u003cmark\u003e各节点 log 的高度一致性\u003c/mark\u003e\u003c/strong\u003e（coherency）。\n它不仅简化了系统行为，使系统更加可预测，而且是保证安全（无冲突）的重要组件。\u003c/p\u003e\n\n\u003cp\u003e如果不同 log 中的两个 entry 有完全相同的 index 和 term，那么\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e这两个 entry 一定\u003cstrong\u003e\u003cmark\u003e包含了相同的命令\u003c/mark\u003e\u003c/strong\u003e；\n 这来源于如下事实：leader 在任意给定 term 和 log index 的情况下，最多只会创建\n 一个 entry，并且其在 log 中的位置永远不会发生变化。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e这两个 log 中，\u003cstrong\u003e\u003cmark\u003e从该 index 往前的所有 entry 都分别相同\u003c/mark\u003e\u003c/strong\u003e。\n这一点是通过 AppendEntries 中简单的\u003cstrong\u003e\u003cmark\u003e一致性检查\u003c/mark\u003e\u003c/strong\u003e来保证的：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e 请求中，leader 会带上 log 中\u003cstrong\u003e\u003cmark\u003e前一个紧邻 entry 的 index 和 term 信息\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n      \u003cli\u003e如果 follower log 中以相同的 index 位置没有 entry，或者有 entry 但 term 不同，follower 就会拒绝新的 entry。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e以上两个条件组合起来，用归纳法可以证明图 3 中的 Log Matching Property：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e新加一个 entry 时，简单一致性检查会确保这个 entry 之前的所有 entry 都是满足 Log Matching 特性的；因此只要初始状态也满足这个特性就行了；\u003c/li\u003e\n  \u003cli\u003e初始状态：各 log 文件都是空的，满足 Log Matching 特性；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e因此得证。\u003c/p\u003e\n\n\u003ch3 id=\"535-log-不一致场景\"\u003e5.3.5 Log 不一致场景\u003c/h3\u003e\n\n\u003cp\u003e正常情况下，leader 和 follower 的 log 能保持一致，但 leader 挂掉会导致 log 不一致\n（leader 还未将其 log 中的 entry 都复制到其他节点就挂了）。\n这些不一致会导致一系列复杂的 leader 和 follower crash。\nFigure 7 展示了 follower log 与新的 leader log 的几种可能不同：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/7.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 7. Leader 挂掉后，follower log 的一些可能场景。\u003c/p\u003e\n\n\u003cp\u003e图中每个方框表示一个 log entry，其中的数字表示它的 term。可能的情况包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e丢失记录(a–b) ；\u003c/li\u003e\n  \u003cli\u003e有额外的未提交记录 (c–d)；\u003c/li\u003e\n  \u003cli\u003e或者以上两种情况发生 (e–f)。\u003c/li\u003e\n  \u003cli\u003elog 中丢失或多出来的记录可能会跨多个 term。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e例如，scenario (f) 可能是如下情况：从 term 2 开始成为 leader，然后向自己的 log 添加了一些 entry，\n但还没来得及提交就挂了；然后重启后迅速又成为 term 3 期间的 leader，然后又加了一些 entry 到自己的 log，\n在提交 term 2\u0026amp; 3 期间的 entry 之前，又挂了；随后持续挂了几个 term。\u003c/p\u003e\n\n\u003ch3 id=\"536-避免-log-不一致appendentries-中的一致性检查\"\u003e5.3.6 避免 log 不一致：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e 中的一致性检查\u003c/h3\u003e\n\n\u003cp\u003eRaft 处理不一致的方式是\u003cstrong\u003e\u003cmark\u003e强制 follower 复制一份 leader 的 log\u003c/mark\u003e\u003c/strong\u003e，\n这意味着 follower log 中\u003cstrong\u003e\u003cmark\u003e冲突的 entry 会被 leader log 中的 entry 覆盖\u003c/mark\u003e\u003c/strong\u003e。\nSection 5.4 将会看到再加上另一个限制条件后，这个日志复制机制就是安全的。\u003c/p\u003e\n\n\u003cp\u003e解决冲突的具体流程：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e找到 leader 和 follower 的\u003cstrong\u003e\u003cmark\u003e最后一个共同认可的 entry\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e将 follower log 中从这条 entry 开始\u003cstrong\u003e\u003cmark\u003e往后的 entries 全部删掉\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e将 leader log 中从这条记录开始往后的所有 entries 同步给 follower。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e整个过程都发生在 \u003cstrong\u003e\u003cmark\u003eAppendEntries RPC 中的一致性检查\u003c/mark\u003e\u003c/strong\u003e环节。\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L939\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// Processes the \u0026#34;append entries\u0026#34; request.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eprocessAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eCandidate\u003c/span\u003e  \u003cspan class=\"c\"\u003e// step-down to follower when it is a candidate\u003c/span\u003e\n            \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetState\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eFollower\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eleader\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLeaderName\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eupdateCurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLeaderName\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Reject if log doesn\u0026#39;t contain a matching previous entry.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etruncate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrevLogIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrevLogTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003enewAppendEntriesResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommitIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e()),\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eappendEntries\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEntries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e      \u003cspan class=\"c\"\u003e// Append entries to the log.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esetCommitIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommitIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// Commit up to the commit index.\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// once the server appended and committed all the log entries from the leader\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003enewAppendEntriesResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecurrentIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommitIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e()),\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/log.go#L399\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// Truncates the log to the given index and term. This only works if the log\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// at the index has not been committed.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003etruncate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecommitIndex\u003c/span\u003e \u003cspan class=\"c\"\u003e// Do not allow committed entries to be truncated.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efmt\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;raft.Log: Index is already committed (%v): (IDX=%v, TERM=%v)\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecommitIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// Do not truncate past end of entries.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efmt\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;raft.Log: Entry index does not exist (MAX=%v): (IDX=%v, TERM=%v)\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// If we\u0026#39;re truncating everything then just clear the entries.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTruncate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSeek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSEEK_SET\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e// Do not truncate if the entry at index does not have the matching term.\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003efmt\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eErrorf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;raft.Log: Entry at index does not have matching term (%v): (IDX=%v, TERM=%v)\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n        \u003cspan class=\"c\"\u003e// Otherwise truncate up to the desired entry.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eposition\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePosition\u003c/span\u003e\n            \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTruncate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSeek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSEEK_SET\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n  \u003cli\u003eLeader 为每个 follower 维护了后者下一个要使用的 log entry index，即 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[followerID]\u003c/code\u003e 变量；\u003c/li\u003e\n  \u003cli\u003e一个节点成为 leader 时，会将整个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[]\u003c/code\u003e 都初始化为它自己的 log 文件的下一个 index （图 7 中就是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e11\u003c/code\u003e）。\u003c/li\u003e\n  \u003cli\u003e如果一个 follower log 与 leader 的不一致，AppendEntries 一致性检查会失败，从\n而拒绝这个请求；leader 收到拒绝之后，将减小 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[followerID]\u003c/code\u003e 然后重试这个\nAppendEntries RPC 请求；如此下去，直到某个 index 时成功，这说明此时 leader\nlog 和 follower logs 已经匹配了。\u003c/li\u003e\n  \u003cli\u003e然后 follower log 会删掉 index 之后的所有 entry，并将 leader 中的 entry 应用到 follower log 中（如果有）。\n此时 follower log 就与 leader 一致了，在之后的整个 term 中都会保持一致。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"537-优化\"\u003e5.3.7 优化\u003c/h3\u003e\n\n\u003cp\u003e还可以对协议进行优化，来减小被拒的 AppendEntries RPC 数量。\n例如，当拒绝一个 AppendEntries 请求时，follower 可以将冲突 entry 的 term 以及 log 中相同 term 的最小 index 信息包含到响应中。\n有了这个信息，leader 就可以直接跳过这个 term 中的所有冲突记录，将 \n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003enextIndex[followerID]\u003c/code\u003e 降低到一个合理值；这样每个 term 内所有的冲突记录只需要一次触发 AppendEntries RPC ，\n而不是每个记录一个 RPC。\u003c/p\u003e\n\n\u003cp\u003e但实际中，我们怀疑是否有必要做这种优化，因为故障很少发生，不太可能有很多的不一致记录。\n\u003cstrong\u003e\u003cmark\u003e有了这个机制，新 leader 上台之后无需执行任何特殊操作来恢复 log 一致性\u003c/mark\u003e\u003c/strong\u003e。\n它只需要执行正常操作，logs 会通过 AppendEntries 一致性检查来收敛。\n\u003cstrong\u003e\u003cmark\u003eleader 永远不会覆盖或删除自己 log 中的记录\u003c/mark\u003e\u003c/strong\u003e（Leader Append-Only Property in Figure 3）。\u003c/p\u003e\n\n\u003cp\u003e这种 log replication 机制展示了第二节中描述的理想共识特性：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e只要集群的大多数节点都是健康的，Raft 就能接受、复制和应用新的 log  entry；\u003c/li\u003e\n  \u003cli\u003e正常情况下\u003cstrong\u003e\u003cmark\u003e只需一轮 RPC\u003c/mark\u003e\u003c/strong\u003e 就能将一个新 entry 复制到集群的大多数节点；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e个别比较慢的 follower 不影响集群性能\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"54-安全确保状态机以相同顺序执行相同命令流\"\u003e5.4 安全：确保状态机以相同顺序执行相同命令流\u003c/h2\u003e\n\n\u003cp\u003e前面几节介绍了 Raft 如何选举 leader 及如何 replicate log entry 的。但是，到目前为止\n我们\u003cstrong\u003e\u003cmark\u003e已经描述的那些机制，还不足以确保每个状态机以相同的顺序执行完全相同的命令流\u003c/mark\u003e\u003c/strong\u003e。\n例如，考虑下面这个例子：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e一个 follower 挂了，\u003c/li\u003e\n  \u003cli\u003e故障期间，leader 提交了几个 log entry，\u003c/li\u003e\n  \u003cli\u003eleader 挂了，然后\u003c/li\u003e\n  \u003cli\u003e这个 follower 恢复之后被选为了新 leader，然后用新的 entries 覆盖了老 leader 提交的那些。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e导致的结果是，不同的状态机可能会执行不同的命令流。\u003c/p\u003e\n\n\u003cp\u003e为了解决这个问题，本节将给 leader election 添加一个限制条件，这也是\n\u003cstrong\u003e\u003cmark\u003eRaft 算法的最后一块拼图\u003c/mark\u003e\u003c/strong\u003e。\n具体来说，这个限制条件确保了\u003cstrong\u003e\u003cmark\u003e任何 term 内的 leader 都包含了前面所有 term 内提交的 entries\u003c/mark\u003e\u003c/strong\u003e，\n也就是图 3 中提到的 Leader Completeness 特性。本节还将给出简要的证明过程。\u003c/p\u003e\n\n\u003ch3 id=\"541-限制一包含所有已提交-entry-的节点才能被选为-leader\"\u003e5.4.1 限制一：包含所有已提交 entry 的节点才能被选为 leader\u003c/h3\u003e\n\n\u003cp\u003e在任何基于 leader 的共识算法中，leader 最终都必须存储了所有的已提交 entry。\u003c/p\u003e\n\n\u003cp\u003e在某些共识算法中，例如 Viewstamped Replication [22]，一个节点即使并未包含全部的\n已提交 entries 也仍然能被选为 leader。这些算法有特殊的机制来识别缺失 entries，\n并在选举期间或选举结束后立即发送给新 leader。不幸的是，这会导致额外的复杂性。\u003c/p\u003e\n\n\u003cp\u003eRaft 采取了一种更简单的方式：\u003cstrong\u003e\u003cmark\u003e除非前面所有 term 内的已提交 entry 都已经\n在某个节点上了，否则这个节点不能被选为 leader\u003c/mark\u003e\u003c/strong\u003e（后面将介绍如何保证这一点）。\n这意味着\u003cstrong\u003e\u003cmark\u003e无需从 non-leader 节点向 leader 节点同步数据\u003c/mark\u003e\u003c/strong\u003e，换句话说\n\u003cstrong\u003e\u003cmark\u003elog entries 只会从 leader 到 follower 单向流动\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e那这个是怎么做到的呢？通过投票过程。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e首先，刚才已经提到，除非 log 中已经包含了集群的\u003cstrong\u003e\u003cmark\u003e所有已提交 entries\u003c/mark\u003e\u003c/strong\u003e，否则一个 candidate 是不能被选为 leader 的。\u003c/li\u003e\n  \u003cli\u003e其次，\u003cstrong\u003e\u003cmark\u003e还活着的（即参与选举的）节点中，至少有一个节点保存了集群的所有已提交 entries\u003c/mark\u003e\u003c/strong\u003e\n （因为覆盖大多数节点的 entry，才算是提交成功的）。\u003c/li\u003e\n  \u003cli\u003e那么，只要一个 candidate 的 log 与大多数节点相比\u003cstrong\u003e\u003cmark\u003e至少不落后\u003c/mark\u003e\u003c/strong\u003e（at\nleast as up-to-date，这个词下文会有精确定义），\u003cstrong\u003e\u003cmark\u003e那它就持有了集群的所有已提交记录\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e因此，只要能确保这里提到的“至少不落后”语意，就能确保选出来的 leader 拥有集群的所有已提交 entries。\n\u003cstrong\u003e\u003cmark\u003eRequestVote RPC 实现了这个过程\u003c/mark\u003e\u003c/strong\u003e：请求中包含了发送方的 log 信息，如果当前\n节点自己的 log 比对方的更新，会拒绝对方成为 leader 的请求。具体到实现上，\n\u003cstrong\u003e\u003cmark\u003e判断哪个 log 更加新，依据的是最后一个 entry 的 index 和 term\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果 term 不同，那 term 新的那个 log 胜出；\u003c/li\u003e\n  \u003cli\u003e如果 term 相同，那 index 更大（即更长）的那个 log 胜出。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"542-限制二当前任期副本数量过半entry-才能提交\"\u003e5.4.2 限制二：当前任期+副本数量过半，entry 才能提交\u003c/h3\u003e\n\n\u003cp\u003e新 leader 如何提交之前任期内遗留下来的、副本数量过集群半数的 entries？\u003c/p\u003e\n\n\u003cp\u003e5.3 小节提到，如果一个 entry 已经存储到了集群中的大多数节点上，leader 就认为这个 entry（在这个 term 内）提交成功了。\n如果 leader 在提交这个 entry 之前挂了（即没有同步到大多数节点上），那下一个 leader 将承担这个 entry 的同步和提交任务。\n但这里有一些新的问题，图 8 是一个例子：\u003cstrong\u003e\u003cmark\u003e即使某个 entry 已经存储到了大多数节点，它仍然可能被新 leader 覆盖掉\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/8.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 8. 时序图：举例说明为什么一个新 leader 上任之后，无法判断是否要提交\u003cmark\u003e前任 leader 遗留下来的未提交 entries\u003c/mark\u003e\u003c/p\u003e\n\n\u003cp\u003e最上面一行数字是 log entry index，每个框中的数字是 term，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e时刻 (a)：S1 是当前 leader，并将 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2\u003c/code\u003e 的 entry 复制到了 S2；\u003c/li\u003e\n  \u003cli\u003e时刻 (b)：\u003cstrong\u003e\u003cmark\u003eS1 挂了，S5 被 S3/S4/S5 选为新 leader\u003c/mark\u003e\u003c/strong\u003e，任期 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm=3\u003c/code\u003e；然后 S5 在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2\u003c/code\u003e 的位置接受了一个\u003cstrong\u003e\u003cmark\u003e来自客户端的新 entry\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e时刻 (c)：\u003cstrong\u003e\u003cmark\u003eS5 挂了；S1 被选为了下一任 leader\u003c/mark\u003e\u003c/strong\u003e，任期 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm=4\u003c/code\u003e；\n然后 \u003cstrong\u003e\u003cmark\u003eS1 继续同步挂掉之前的那个 entry\u003c/mark\u003e\u003c/strong\u003e（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2\u003c/code\u003e），它被\u003cstrong\u003e\u003cmark\u003e成功同步到大部分节点上（S1/S2/S3），但还未提交\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e接下来分两种情况：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e时刻 (d)：\u003cstrong\u003e\u003cmark\u003eS1 又挂了，S5 被 S2/S3/S4 选为下一任 leader\u003c/mark\u003e\u003c/strong\u003e，\n  这种情况下，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2,term=2\u003c/code\u003e 的 entry 会被 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2,term=3\u003c/code\u003e 的 entry \u003cstrong\u003e\u003cmark\u003e覆盖掉\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e时刻 (e)：S1 在挂掉之前将 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=3,term=4\u003c/code\u003e 的一条新记录也成功复制到了大部分节点上，\n  这种情况下，\u003cstrong\u003e\u003cmark\u003e即使 S1 之后挂掉了，S5 还是无法赢得选举\u003c/mark\u003e\u003c/strong\u003e。\n  因此，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=3,term=4\u003c/code\u003e 的 entry 将会被（不管是 S1 还是其他新 leader）提交，log 中所有之前的记录（例如这里的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2,term=2\u003c/code\u003e 的 entry）也都会被提交。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e这里的问题在于：\u003cstrong\u003e\u003cmark\u003e判断是否要提交的唯一标准是“已同步的副本数量”\u003c/mark\u003e\u003c/strong\u003e：数量超过了集群半数，则认为\n应该提交，\u003cstrong\u003e\u003cmark\u003e没有考虑到任期信息，“任期不同但副本数量都超过集群半数”的情况是可能的\u003c/mark\u003e\u003c/strong\u003e，即上面的 (d) 情况。\n因此，为了避免这个问题，Raft 做了一个限制：\u003cstrong\u003e\u003cmark\u003e只有提交当前任期内的记录时，\n才能用这种计算副本数量（counting replicas）的方式\u003c/mark\u003e\u003c/strong\u003e。对应到图 8 中就是 (d) 时刻，\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex=2,term=2\u003c/code\u003e 的三个副本可以被合理覆盖，因为此时已经是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm=3\u003c/code\u003e 了。\n一旦当前任期内的一个 entry 已这种方式被提交了，那所有之前的 entries 都会被 Log\nMatching Property 间接提交，对应图 8 中的 (e) 场景。\u003c/p\u003e\n\n\u003cp\u003e解决这个问题还有其他方式，但 Raft 这种方式更简单保守，在提交规则中进行处理，因为\n\u003cstrong\u003e\u003cmark\u003eentries 中保留了它们原始的 term 信息\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e在其他共识算法中，如果一个新 leader 再次复制（rereplicates）之前任期的记录，它们必须用新的任期号。\u003c/li\u003e\n  \u003cli\u003eRaft 的方式使得判断 entry 更加容易，因为 \u003cstrong\u003e\u003cmark\u003eterm 号是不会随着时间或 log 文件变的\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e此外，相比于其他算法，Raft 中的新 leader 发送的 entry 数量更少。(other\nalgorithms must send redundant log entries to renumber them before they can be\ncommitted).\u003c/p\u003e\n\n\u003ch3 id=\"543-安全性的简要证明\"\u003e5.4.3 安全性的简要证明\u003c/h3\u003e\n\n\u003cp\u003e有了以上基础，现在能更准确地证明 Leader Completeness 特性（需要用到 9.2 小节的 safety proof）。\n我们用\u003cstrong\u003e\u003cmark\u003e反证法\u003c/mark\u003e\u003c/strong\u003e，先假设它不成立。\u003c/p\u003e\n\n\u003cp\u003e假设任期 T 内的 leader leaderT 在它的任期内提交了一个 entry，但这个 entry 没有被后面任期内的 leader 存储。\n考虑没有存储这个 entry 的最小的任期 U，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eU \u0026gt; T\u003c/code\u003e，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eleaderU 当选为 leader 的时刻，这个 entry 一定不在其 log 中，因为 leader 不会删除或覆盖 entries；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eleaderT 已经将这个 entry 同步到大部分节点上，而 leaderU 已经收到了大部\n分节点的投票。因此，\u003cstrong\u003e\u003cmark\u003e至少一个节点（“某个特定的投票者”）既接受了 leaderT 复制过来的记录，又投票给了 leaderU\u003c/mark\u003e\u003c/strong\u003e，\n如图 9 所示。这个特殊的投票者是导致矛盾关键。\u003c/p\u003e\n\n    \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/9.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n    \u003cp align=\"center\"\u003eFig 9. 如果 S1 (leader for term T) 在自己的任期内提交了一个记录，而 S5 被选为 term U 内的 leader，那至少有一个节点 (S3) 既接受了那个记录，又投票给了 S5。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e这个投票者一定是在投票给 leaderU 之前接受的这个 entry，否则它会拒绝那次来自 leaderT 的\n AppendEntries 请求（它当前的 term 会被 T 更大）；\u003c/li\u003e\n  \u003cli\u003e这个投票者在投票给 leaderU 之前仍然存储着这个 entry，因为每个\n后面的 leader 都会包含这个记录 (by assumption), leaders 从不删除记录，\n而 followers 只会在与 leader 冲突时才会删除记录。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e这个投票者将选票给了 leaderU，这\u003cstrong\u003e\u003cmark\u003e说明 leaderU 的 log 至少与该投票者是一样新的\u003c/mark\u003e\u003c/strong\u003e\n  （as up-to-date as the voter’s）。这会导致如下两个矛盾：\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e如果 voter 和 leaderU 的最后一个 log term 是一样的，那 leaderU 的 log 至\n少与投票者的 log 一样长，因此它包含了投票者 log 中的所有记录 —— 这与前面的\n假设矛盾：前面假设了投票者包含了这个记录，而 leader U 没有。因此，\nleaderU 的最后一个 log term 必须比该投票者的要大。不仅如此，它还要比 T\n大，因为投票者的最后一个 log term 至少是 T（它包含了 term T 内的已提交记录）。\u003c/li\u003e\n      \u003cli\u003e最早创建了 leaderU 的最后一个 entry 的 leader，一定在它的 log 中包含了这个已提交的 entry（根据假设）。 \n  那么，根据 Log Matching Property，leaderU’s log 一定也包含了这个已提交的 entry，导出矛盾。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e证明结束。\u003c/p\u003e\n\n\u003cp\u003e因此，大于 T 的所有 terms 内的 leader，一定包含 term T 内已提交的所有 entries。\nLog Matching Property 保证了未来的 leaders 也会包含间接提交的记录，例如图 8 (d) 中的 index=2 记录。\u003c/p\u003e\n\n\u003cp\u003eGiven leader Completeness Property, we can prove the State Machine Safety\nProperty from Figure 3, which states that if a server has applied a log entry\nat a given index to its state machine, no other server will ever apply a\ndifferent log entry for the same index. At the time a server applies a log\nentry to its state machine, its log must be identical to leader’s log up\nthrough that entry and the entry must be committed. Now consider the lowest\nterm in which any server applies a given log index; the Log Completeness\nProperty guarantees that leaders for all higher terms will store that same log\nentry, so servers that apply the index in later terms will apply the same\nvalue.  Thus, the State Machine Safety Property holds.\u003c/p\u003e\n\n\u003cp\u003eFinally, Raft requires servers to apply entries in log index order. Combined\nwith the State Machine Safety Property, this means that all servers will\napply exactly the same set of log entries to their state machines, in the same order.\u003c/p\u003e\n\n\u003ch2 id=\"55-followercandidate-故障无限重试--请求幂等\"\u003e5.5 Follower/candidate 故障：无限重试 + 请求幂等\u003c/h2\u003e\n\n\u003cp\u003e到目前为止讨论的都是 leader 挂掉的情况。\n这一节讨论下 follower 和 candidate 挂掉的情况，这种其实更简单，而且处理方式是一样的。\u003c/p\u003e\n\n\u003cp\u003e如果一个 follower 或 canditate 挂掉了，那后面来的 RequestVote 和 AppendEntries 请求都会失败。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eRaft 处理这种场景的方式是\u003cstrong\u003e\u003cmark\u003e无限重试\u003c/mark\u003e\u003c/strong\u003e，因此只要这个节点能起来，这个 RPC 请求就一定会成功完成。\u003c/li\u003e\n  \u003cli\u003e如果一个节点在完成了 RPC 之后、响应之前挂了，那它会在重启之后收到完全相同的 RPC 。\u003cstrong\u003e\u003cmark\u003eRaft RPC 是幂等的\u003c/mark\u003e\u003c/strong\u003e，因此这不会导致问题。\n例如，如果一个 follower 收到了一个 AppendEntries 请求，而它的 log 中已经包含了待 append 的 entry，\n那它会\u003cstrong\u003e\u003cmark\u003e直接忽略\u003c/mark\u003e\u003c/strong\u003e这个请求。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"56-时序和可用性\"\u003e5.6 时序和可用性\u003c/h2\u003e\n\n\u003cp\u003eRaft 的一个设计要求是\u003cstrong\u003e\u003cmark\u003e安全性（无冲突）绝对不能依赖时序\u003c/mark\u003e\u003c/strong\u003e（safety must not depend on timing）：\n绝对不能因为某些事件发生的快或慢了，就导致系统产生不正确的结果。\u003c/p\u003e\n\n\u003cp\u003e但另一方面，\u003cstrong\u003e\u003cmark\u003e可用性\u003c/mark\u003e\u003c/strong\u003e（系统及时对客户端作出响应）\u003cstrong\u003e\u003cmark\u003e对时序的依赖是不可避免的\u003c/mark\u003e\u003c/strong\u003e。\n例如，有节点挂掉时，消息交换过程肯定会耗时更长，任何一个 candidate 可能都无法等到一个选举结果；\n而没有一个稳定 leader 的话，Raft 就无法处理任何请求。\u003c/p\u003e\n\n\u003cp\u003eRaft 中\u003cstrong\u003e\u003cmark\u003e最依赖时序的就是 leader 选举部分\u003c/mark\u003e\u003c/strong\u003e。\n只要系统满足如下时序条件，Raft 就能选出和保持一个稳定的 leader：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cmark\u003e\u003ci\u003ebroadcastTime ≪ electionTimeout ≪ MTBF\u003c/i\u003e\u003c/mark\u003e\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ebroadcastTime：一个节点并发给其他节点发送请求并收到响应的平均时间；\u003c/li\u003e\n  \u003cli\u003eelectionTimeout： 5.2 小节定义的选举超时时间；\u003c/li\u003e\n  \u003cli\u003eMTBF：单个节点的平均故障时间（average time between failures）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这个不等式表达的意思很好理解：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e广播耗时要比选举超时低一个数量级，这样 \u003cstrong\u003e\u003cmark\u003eleader 才能可靠地发送心跳消息给 follower，避免它们发起来新的选举\u003c/mark\u003e\u003c/strong\u003e。\n考虑到选举超时是随机化的，这个不等式也使得投票分裂不太可能发生。\u003c/li\u003e\n  \u003cli\u003e选举超时要比 MTBF 低几个数量级，这样系统才能稳步前进。\n当 \u003cstrong\u003e\u003cmark\u003eleader 挂掉后，系统大致会经历一个 election timeout 时间段的不可用\u003c/mark\u003e\u003c/strong\u003e，我们希望这个时间段只占到总时间段的很小一部分。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003ebroadcastTime 和 MTBF 都是底层系统的特性，而 electionTimeout 是我们需要设置的。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eRaft 一般要求接收方将请求\u003cstrong\u003e\u003cmark\u003e持久化\u003c/mark\u003e\u003c/strong\u003e到稳定存储中，因此取决于存储技术，broadcastTime 可能需要 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e0.5ms ~ 20ms\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e因此，electionTimeout 通常选择 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e10ms ~ 500ms\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e典型的节点 \u003cstrong\u003e\u003cmark\u003eMTBF 是几个月或更长时间\u003c/mark\u003e\u003c/strong\u003e，因此很容易满足时序要求。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"6-集群节点数量变化membership-changes\"\u003e6 集群节点数量变化（membership changes）\u003c/h1\u003e\n\n\u003cp\u003e到目前为止，我们都是假设了\u003cstrong\u003e\u003cmark\u003e集群配置（节点集合）是不变的\u003c/mark\u003e\u003c/strong\u003e。\n但在实际场景中，有时需要增加或删除节点，例如节点故障时用新节点替换某个老节点，或者直接添加或删除节点。\n显然，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e关闭集群 -\u0026gt; 更新配置文件 -\u0026gt; 重庆开启集群\u003c/code\u003e 的方式可以工作，但问题是操作期间集群不可用，\n而且还可能因为其中的手动操作引发故障。为避免这些问题，我们决定\u003cstrong\u003e\u003cmark\u003e自动化配置变更，并将其包含到共识算法中\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"61-增删节点可能导致集群分裂\"\u003e6.1 增删节点可能导致集群分裂\u003c/h2\u003e\n\n\u003cp\u003e这里的本质问题就是\u003cstrong\u003e\u003cmark\u003e避免在增删节点期间同时出现两个及以上 leader\u003c/mark\u003e\u003c/strong\u003e。\n不幸的是，\u003cstrong\u003e\u003cmark\u003e不管用什么方式，这个过程都是不安全的\u003c/mark\u003e\u003c/strong\u003e（unsafe）：我们\n无法在同一时刻原子地切换所有节点，因此在变更时，集群可能会分裂为两个独立的大多数\n（two independent majorities），见图 10，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/10.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 10. 节点数量从 3 个增加到 5 个。\n这个\u003cmark\u003e过程是不安全的\u003c/mark\u003e，因为不同节点的切换发生在不同时刻：例如\n箭头指向的时刻，\u003cmark\u003e集群分裂成了两个大多数\u003c/mark\u003e，分别用的老配置\nC\u003csub\u003eold\u003c/sub\u003e（server 1/2）和新配置 C\u003csub\u003enew\u003c/sub\u003e（server 3/4/5），\n\u003cmark\u003e各自选出了一个 leader\u003c/mark\u003e。\n\u003c/p\u003e\n\n\u003ch2 id=\"62-解决办法两阶段方式\"\u003e6.2 解决办法：两阶段方式\u003c/h2\u003e\n\n\u003cp\u003e为确保安全，配置变更\u003cstrong\u003e\u003cmark\u003e必须使用一种两阶段方式\u003c/mark\u003e\u003c/strong\u003e（a two-phase approach）来完成。\n有很多种实现两阶段的方式，例如，某些系统 (e.g., [22]) 先在第一个阶段禁用老配置，这样它就不能继续处理新的客户端请求了；然后再通过\n第二个阶段来启用新配置。在 Raft 中，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e集群首先切换到一个我们称为\u003cstrong\u003e\u003cmark\u003e联合共识\u003c/mark\u003e\u003c/strong\u003e（joint consensus）的\n  \u003cstrong\u003e\u003cmark\u003e事务型配置\u003c/mark\u003e\u003c/strong\u003e（transitional configuration）；\u003c/li\u003e\n  \u003cli\u003e一旦\u003cstrong\u003e\u003cmark\u003e联合共识提交\u003c/mark\u003e\u003c/strong\u003e，系统就\u003cstrong\u003e\u003cmark\u003e切换到新配置\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e联合共识 combines both 老的和新的配置：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e不管是新配置还是老配置，log entries 都会被复制到其他所有节点；\u003c/li\u003e\n  \u003cli\u003e不管是新配置还是老配置，任何节点都可能会成为 leader；\u003c/li\u003e\n  \u003cli\u003e不管是新配置还是老配置，选举或提交都需要大多数节点同意；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e联合共识使得\u003cstrong\u003e\u003cmark\u003e每个节点可以在任意时刻切换配置，而不会牺牲安全性\u003c/mark\u003e\u003c/strong\u003e；\n而且\u003cstrong\u003e\u003cmark\u003e集群变更期间，仍然能继续服务客户端请求\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e集群配置用 replicated log 中的特殊 entry 来存储和通信，Figure 11 展示了配置变更的过程，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/11.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 11.一次配置变更的时间线。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e虚线表示配置\u003cstrong\u003e\u003cmark\u003e已创建但还未提交\u003c/mark\u003e\u003c/strong\u003e；实线表示\u003cstrong\u003e\u003cmark\u003e已提交\u003c/mark\u003e\u003c/strong\u003e。\nLeader\u003c/p\u003e\n\n  \u003col\u003e\n    \u003cli\u003e首先在自己的 log 中创建一个配置项 C\u003csub\u003eold,new\u003c/sub\u003e 并提交；这个配置会被集群大多数节点接受；\u003c/li\u003e\n    \u003cli\u003e然后创建一个 C\u003csub\u003enew\u003c/sub\u003e 并提交到大多数节点；\u003c/li\u003e\n    \u003cli\u003e在任何时刻，Cold 和 Cnew 都不可能同时独立做出决策，也就是说最多只有一个 leader。\u003c/li\u003e\n  \u003c/ol\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e下面具体解释。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e当 leader 收到一个 \u003ccode\u003eC\u003csub\u003eold\u003c/sub\u003e -\u0026gt; C\u003csub\u003enew\u003c/sub\u003e\u003c/code\u003e 配置变更请求时，\n会将这个请求作为一个 log entry 存储起来，用作联合共识（图中的  C\u003csub\u003eold,new\u003c/sub\u003e）；\n然后用前面介绍的 log replication 机制将其同步到其他节点。\u003c/li\u003e\n  \u003cli\u003e任何一个节点将这个新配置应用到自己的 log 之后，接下来它将用这个配置来做所有未来决策\n（每个节点\u003cstrong\u003e\u003cmark\u003e永远用它的 log 中的最新配置，不管这个 entry 是否已提交\u003c/mark\u003e\u003c/strong\u003e）。\n这意味着 leader 会用 C\u003csub\u003eold,new\u003c/sub\u003e 的规则来决定何时 the log entry for Cold,new is committed.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e如果 leader 挂了，使用  C\u003csub\u003eold\u003c/sub\u003e 或 C\u003csub\u003eold,new\u003c/sub\u003e 配置的节点们可能会选出一个新 leader，\n取决于获胜的那个 candidate 是否收到了 C\u003csub\u003eold,new\u003c/sub\u003e。\n但不管哪种情况下，此时（这个时间段内）C\u003csub\u003enew\u003c/sub\u003e 都无法做出单边决策。\u003c/p\u003e\n\n\u003cp\u003eC\u003csub\u003eold,new\u003c/sub\u003e 提交之后，除非有其他节点的同意，否则 Cold 或 Cnew 都无法做出决策，\n并且 Leader Completeness Property 确保了只有那些有 C\u003csub\u003eold,new\u003c/sub\u003e entry 的节点才能被选为 leader。\n现在 leader 可以安全地创建一个 log entry 来描述 Cnew 并将其同步到集群其他节点。\n同样，这份配置被每个节点看到之后就生效了（take effect）。新配置在 Cnew 的规则下被提交之后，\n老的配置就无关紧要了，那些没有在新配置中的节点就都可以关掉了。\n如图 11 所示，任何时刻都不会发生 Cold and Cnew\n都能做出单边决策（unilateral decisions）的情况；这保证了安全性。\u003c/p\u003e\n\n\u003ch2 id=\"63-三个问题\"\u003e6.3 三个问题\u003c/h2\u003e\n\n\u003cp\u003e关于节点变更，还有三个问题要解决。\u003c/p\u003e\n\n\u003ch3 id=\"631-新节点状态为空需要一段时间同步-log引入非投票成员\"\u003e6.3.1 新节点状态为空，需要一段时间同步 log：引入“非投票成员”\u003c/h3\u003e\n\n\u003cp\u003e新节点加入集群时，它的 log 是空白的，因此需要一段时间来追赶到最新状态。在这\n段时间内它是无法提交新 entry 的 —— 包括 C\u003csub\u003eold,new\u003c/sub\u003e entry —— 也就是说有一段时间不可用。\u003c/p\u003e\n\n\u003cp\u003e为避免这个问题，Raft 引入了一个特殊的、用在\u003cstrong\u003e\u003cmark\u003e配置变更前\u003c/mark\u003e\u003c/strong\u003e的新阶段。在这个阶段中，\n新节点是以\u003cstrong\u003e\u003cmark\u003e非投票成员\u003c/mark\u003e\u003c/strong\u003e（non-voting members）加入集群的：leader 会\n同步 entry 给它们，但它们并不参与投票，计算集群节点数量（大多数）时也不考虑它们。\n等到新节点赶上集群其他节点的状态之后，才开始前面介绍的配置变更过程。\u003c/p\u003e\n\n\u003ch3 id=\"632-从集群中移除-leader-节点\"\u003e6.3.2 从集群中移除 leader 节点\u003c/h3\u003e\n\n\u003cp\u003e这种情况下，leader 在提交了 C\u003csub\u003enew\u003c/sub\u003e 之后就\u003cstrong\u003e\u003cmark\u003e卸任\u003c/mark\u003e\u003c/strong\u003e（steps down），变成 follower 状态。\u003c/p\u003e\n\n\u003cp\u003e这意味着会有一个时间窗口（这个 leader 提交 C\u003csub\u003enew\u003c/sub\u003e 期间），这个 leader 在\n\u003cstrong\u003e\u003cmark\u003e管理着一个不包括自己的集群\u003c/mark\u003e\u003c/strong\u003e；它在同步 log entries 给其他节点，但自己却并不被算作大多数。\nLeader 切换发生在 C\u003csub\u003enew\u003c/sub\u003e 提交之后，因为这是新配置能独立工作的最早时刻（\n从 C\u003csub\u003enew\u003c/sub\u003e 开始，肯定能选出一个 leader）；在这个时刻之前，有可能只有\nC\u003csub\u003eold\u003c/sub\u003e 中的某个节点才能被选为 leader。\u003c/p\u003e\n\n\u003ch3 id=\"633-被移除的节点不断超时timeout并触发选举\"\u003e6.3.3 被移除的节点不断超时（timeout）并触发选举\u003c/h3\u003e\n\n\u003cp\u003e被移除的节点是指不在 C\u003csub\u003enew\u003c/sub\u003e 中的节点。\n这些节点\u003cstrong\u003e\u003cmark\u003e不会收到来自 leader 的心跳\u003c/mark\u003e\u003c/strong\u003e，因此\u003cstrong\u003e\u003cmark\u003e会 timeout 然后开始新的选举\u003c/mark\u003e\u003c/strong\u003e。\n它们会带着一个\u003cstrong\u003e\u003cmark\u003e更大的 term\u003c/mark\u003e\u003c/strong\u003e 发起 RequestVote 轻轻，这会迫使当前\n\u003cstrong\u003e\u003cmark\u003eleader 回退到 follower 状态\u003c/mark\u003e\u003c/strong\u003e。最终虽然会选出一个新 leader，但由\n于这些被移除的节点会\u003cstrong\u003e\u003cmark\u003e再次 timeout 然后再次发起新一轮选举\u003c/mark\u003e\u003c/strong\u003e，因此\n这个\u003cstrong\u003e\u003cmark\u003e新 leader 会再次被赶下台\u003c/mark\u003e\u003c/strong\u003e —— 如此循环，导致可用性很差。\u003c/p\u003e\n\n\u003cp\u003e为避免这个问题，节点相信已经有一个当前 leader 的情况下，会忽略 RequestVote RPC。\n具体来说，如果一个节点还没有到 election timeout 状态，就收到了一条 RequestVote RPC，\n它会忽略这个消息（不会更新自己的 term 或投出自己的选票）。\u003c/p\u003e\n\n\u003cp\u003e这对正常的选举是没影响的，因为每台节点在开始一轮选举之前，会等待至少一个最小 election timeout。\n但能解决这里提到的问题：\u003cstrong\u003e\u003cmark\u003e只要 leader 能向集群其他节点正常发送心跳，就不会被更大的 term 的 candidate 赶下台\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch1 id=\"7-日志压缩log-compaction\"\u003e7 日志压缩（log compaction）\u003c/h1\u003e\n\n\u003cp\u003eRaft 的 log 会随着处理客户端请求而不断增大，因此占用的存储空间越来越大，replay\n时间也越来越长。如果没有一种机制来处理这些日志，最终将引发可用性故障。\u003c/p\u003e\n\n\u003ch2 id=\"71-snapshot\"\u003e7.1 Snapshot\u003c/h2\u003e\n\n\u003cp\u003eSnapshot 是最简单的压缩方式。\u003c/p\u003e\n\n\u003cp\u003e在这种方式中，会对当前的整个日志做一次快照，将其写到持久存储上，\n然后将已经做过快照的日志全部清空。\u003cstrong\u003e\u003cmark\u003eChubby 和 ZooKeeper\u003c/mark\u003e\u003c/strong\u003e 都使用了这种方式，接下来介绍 Raft 的快照方式。\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L865\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/server.go#L1188\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eserver\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eTakeSnapshot\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecommitInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// check if there is log has been committed since the last snapshot.\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Attach snapshot to pending snapshot and save it to disk.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ependingSnapshot\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eSnapshot\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSnapshotPath\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elastTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003estate\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estateMachine\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSave\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Clone the list of peers.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ePeer\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epeer\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epeer\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epeers\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epeers\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ePeer\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eName\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eConnectionString\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econnectionString\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Attach snapshot to pending snapshot and save it to disk.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ependingSnapshot\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePeers\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epeers\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ependingSnapshot\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eState\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003estate\u003c/span\u003e\n    \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esaveSnapshot\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// We keep some log entries after the snapshot.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// We do not want to send the whole snapshot to the slightly slow machines\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003eNumberOfLogEntriesAfterSnapshot\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecompactIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003elastIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003eNumberOfLogEntriesAfterSnapshot\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecompactTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecompactIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecompact\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecompactIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecompactTerm\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/log.go#L567\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// compact the log before index (including index)\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecompact\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// the index may be greater than the current index if we just recovery from on snapshot\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einternalCurrentIndex\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"c\"\u003e// get all log entries after index\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// create a new log file and add all the entries\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enew_file_path\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;.new\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpenFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enew_file_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eO_APPEND\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eO_CREATE\u003c/span\u003e\u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0600\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eentry\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eposition\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSeek\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSEEK_CUR\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePosition\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eposition\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eentry\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEncode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSync\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eold_file\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRename\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enew_file_path\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// rename the new log file\u003c/span\u003e\n    \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eold_file\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eClose\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"c\"\u003e// close the old log file\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// compaction the in memory log\u003c/span\u003e\n    \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e\n    \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartIndex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\n    \u003cspan class=\"n\"\u003el\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estartTerm\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eterm\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/12.png\" width=\"40%\" height=\"40%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 12.\nA server replaces the committed entries in its log\n(indexes 1 through 5) with a new snapshot, which stores just\nthe current state (variables x and y in this example). The snapshot’s last included index and term serve to position the snapshot in the log preceding entry 6.\n\u003c/p\u003e\n\n\u003cp\u003eFigure 12 shows the basic idea of snapshotting in Raft.\nEach server takes snapshots independently, covering just\nthe committed entries in its log. Most of the work consists of the state machine writing its current state to the\nsnapshot. Raft also includes a small amount of metadata\nin the snapshot: the last included index is the index of the\nlast entry in the log that the snapshot replaces (the last entry the state machine had applied), and the last included\nterm is the term of this entry. These are preserved to support the AppendEntries consistency check for the first log\nentry following the snapshot, since that entry needs a previous log index and term. To enable cluster membership\nchanges (Section 6), the snapshot also includes the latest\nconfiguration in the log as of last included index. Once a\nserver completes writing a snapshot, it may delete all log\nentries up through the last included index, as well as any\nprior snapshot.\u003c/p\u003e\n\n\u003cp\u003eAlthough servers normally take snapshots independently, leader must occasionally send snapshots to\nfollowers that lag behind. This happens when leader\nhas already discarded the next log entry that it needs to\nsend to a follower. Fortunately, this situation is unlikely\nin normal operation: a follower that has kept up with the\nleader would already have this entry. However, an exceptionally slow follower or a new server joining the cluster\n(Section 6) would not. The way to bring such a follower\nup-to-date is for leader to send it a snapshot over the\nnetwork.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eInstallSnapshot RPC\u003c/p\u003e\n\n  \u003cp\u003eInvoked by leader to send chunks of a snapshot to a follower.  Leaders always send chunks in order.\u003c/p\u003e\n\n  \u003cp\u003eArguments:\u003c/p\u003e\n\n  \u003cul\u003e\n    \u003cli\u003eterm leader’s term\u003c/li\u003e\n    \u003cli\u003eleaderId so follower can redirect clients\u003c/li\u003e\n    \u003cli\u003elastIncludedIndex the snapshot replaces all entries up through and including this index\u003c/li\u003e\n    \u003cli\u003elastIncludedTerm term of lastIncludedIndex\u003c/li\u003e\n    \u003cli\u003eoffset byte offset where chunk is positioned in the snapshot file\u003c/li\u003e\n    \u003cli\u003edata[] raw bytes of the snapshot chunk, starting at offset\u003c/li\u003e\n    \u003cli\u003edone true if this is the last chunk\u003c/li\u003e\n  \u003c/ul\u003e\n\n  \u003cp\u003eResults:\u003c/p\u003e\n\n  \u003cul\u003e\n    \u003cli\u003eterm currentTerm, for leader to update itself\u003c/li\u003e\n  \u003c/ul\u003e\n\n  \u003cp\u003eReceiver implementation:\u003c/p\u003e\n\n  \u003col\u003e\n    \u003cli\u003eReply immediately if \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eterm \u0026lt; currentTerm\u003c/code\u003e\u003c/li\u003e\n    \u003cli\u003eCreate new snapshot file if first chunk (offset is 0)\u003c/li\u003e\n    \u003cli\u003eWrite data into snapshot file at given offset\u003c/li\u003e\n    \u003cli\u003eReply and wait for more data chunks if done is false\u003c/li\u003e\n    \u003cli\u003eSave snapshot file, discard any existing or partial snapshot with a smaller index\u003c/li\u003e\n    \u003cli\u003eIf existing log entry has same index and term as snapshot’s last included entry, retain log entries following it and reply\u003c/li\u003e\n    \u003cli\u003eDiscard the entire log\u003c/li\u003e\n    \u003cli\u003eReset state machine using snapshot contents (and load snapshot’s cluster configuration)\u003c/li\u003e\n  \u003c/ol\u003e\n\u003c/blockquote\u003e\n\n\u003cp align=\"center\"\u003eFig 13.\nA summary of the InstallSnapshot RPC. Snapshots are split into chunks for\ntransmission; this gives the follower a sign of life with each chunk, so it can\nreset its election timer.\n\u003c/p\u003e\n\n\u003cp\u003eThe leader uses a new RPC called InstallSnapshot to\nsend snapshots to followers that are too far behind; see\nFigure 13. When a follower receives a snapshot with this\nRPC, it must decide what to do with its existing log entries. Usually the snapshot will contain new information\nnot already in the recipient’s log. In this case, the follower\ndiscards its entire log; it is all superseded by the snapshot\nand may possibly have uncommitted entries that conflict\nwith the snapshot. If instead the follower receives a snapshot that describes a prefix of its log (due to retransmission or by mistake), then log entries covered by the snapshot are deleted but entries following the snapshot are still\nvalid and must be retained.\u003c/p\u003e\n\n\u003cp\u003eThis snapshotting approach departs from Raft’s strong\nleader principle, since followers can take snapshots without the knowledge of leader. However, we think this\ndeparture is justified. While having a leader helps avoid\nconflicting decisions in reaching consensus, consensus\nhas already been reached when snapshotting, so no decisions conflict. Data still only flows from leaders to\nfollowers, just followers can now reorganize their data.\u003c/p\u003e\n\n\u003cp\u003eWe considered an alternative leader-based approach in\nwhich only leader would create a snapshot, then it\nwould send this snapshot to each of its followers. However, this has two disadvantages. First, sending the snapshot to each follower would waste network bandwidth and\nslow the snapshotting process. Each follower already has\nthe information needed to produce its own snapshots, and\nit is typically much cheaper for a server to produce a snapshot from its local state than it is to send and receive one\nover the network. Second, leader’s implementation\nwould be more complex. For example, leader would\nneed to send snapshots to followers in parallel with replicating new log entries to them, so as not to block new\nclient requests.\u003c/p\u003e\n\n\u003cp\u003eThere are two more issues that impact snapshotting performance. First, servers must decide when to snapshot. If\na server snapshots too often, it wastes disk bandwidth and\nenergy; if it snapshots too infrequently, it risks exhausting its storage capacity, and it increases the time required\nto replay the log during restarts. One simple strategy is\nto take a snapshot when the log reaches a fixed size in\nbytes. If this size is set to be significantly larger than the\nexpected size of a snapshot, then the disk bandwidth overhead for snapshotting will be small.\u003c/p\u003e\n\n\u003cp\u003eThe second performance issue is that writing a snapshot can take a significant amount of time, and we do\nnot want this to delay normal operations. The solution is\nto use copy-on-write techniques so that new updates can\nbe accepted without impacting the snapshot being written. For example, state machines built with functional data\nstructures naturally support this. Alternatively, the operating system’s copy-on-write support (e.g., fork on Linux)\ncan be used to create an in-memory snapshot of the entire\nstate machine (our implementation uses this approach).\u003c/p\u003e\n\n\u003ch2 id=\"72-增量压缩\"\u003e7.2 增量压缩\u003c/h2\u003e\n\n\u003cp\u003e增量压缩方式，例如 log cleaning [36] and log-structured merge trees [30, 5]，也是可行的。\n这些只对一部分数据进行操作，因此压缩所占用的负载是随时间分布更加均匀。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e首先选择一块已经积累了一些已删除和已覆盖对象（deleted and overwritten objects）的数据区域，\u003c/li\u003e\n  \u003cli\u003e然后以更紧凑的方式，重写（rewrite）这些区域内还活着的对象（live objects from that region）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这比 snapshot 方式要更精细但也更复杂，前者是直接作用在整个数据集上。\n虽然 log cleaning 需要对 Raft 做出改动，但 Raft state machines 可以用与 snapshot 相同的接口来实现 LSM\ntrees。\u003c/p\u003e\n\n\u003ch1 id=\"8-客户端交互\"\u003e8 客户端交互\u003c/h1\u003e\n\n\u003cp\u003e本节介绍客户端如何寻找集群 leader、Raft 如何支持 linearizable semantics [10] 等客户端交互内容，\n这些是所有\u003cstrong\u003e\u003cmark\u003e基于共识的系统\u003c/mark\u003e\u003c/strong\u003e（consensus-based systems）共同面临的问题，\nRaft 的处理方式也\u003cstrong\u003e\u003cmark\u003e与其他系统类似\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"81-寻找-leader\"\u003e8.1 寻找 leader\u003c/h2\u003e\n\n\u003cp\u003eRaft 中，客户端会将\u003cstrong\u003e\u003cmark\u003e所有请求都发给 leader\u003c/mark\u003e\u003c/strong\u003e。但 leader 可能会发生切换，\n如何确保客户端每次都能找到 leader 呢？\u003c/p\u003e\n\n\u003cp\u003e客户端启动时，首先会\u003cstrong\u003e\u003cmark\u003e随机\u003c/mark\u003e\u003c/strong\u003e选择一个 raft 节点进行连接，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果该节点是 leader，就会直接处理请求；\u003c/li\u003e\n  \u003cli\u003e如果该节点不是 leader，就会拒绝这个请求，并\u003cstrong\u003e\u003cmark\u003e将 leader 信息告诉客户端\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAppendEntries\u003c/code\u003e 请求包含了 leader 信息，因此每个 follower 都知道哪个节点是 leader。\u003c/p\u003e\n\n  \u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/append_entries.go#L11\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// The request sent to a server to append entries to the log.\u003c/span\u003e\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eAppendEntriesRequest\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTerm\u003c/span\u003e         \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePrevLogIndex\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePrevLogTerm\u003c/span\u003e  \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCommitIndex\u003c/span\u003e  \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eLeaderName\u003c/span\u003e   \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eEntries\u003c/span\u003e      \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprotobuf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLogEntry\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e  \u003c/div\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e如果 leader 挂了，客户端请求会超时，然后重新随机选择一个节点进行连接。\u003c/p\u003e\n\n\u003ch2 id=\"82-可线性化语义避免重复执行同一客户端的相同命令\"\u003e8.2 可线性化语义（避免重复执行同一客户端的相同命令）\u003c/h2\u003e\n\n\u003cp\u003eRaft 的目标之一是实现线性语义（linearizable semantics）：每个操作看起来都是\n\u003cstrong\u003e\u003cmark\u003e立即执行\u003c/mark\u003e\u003c/strong\u003e（execute instantaneously）、\u003cstrong\u003e\u003cmark\u003e精确执行一次\u003c/mark\u003e\u003c/strong\u003e（exactly once）。\n但前面也提到，Raft 可能会\u003cstrong\u003e\u003cmark\u003e多次执行同一条命令\u003c/mark\u003e\u003c/strong\u003e：例如，leader 在提交了\n来自客户端的 log entry 但还没返回响应时就挂了，那客户端会向新 leader 重试这个命令，导致被第二次执行。\u003c/p\u003e\n\n\u003cp\u003e我们的解决方案是：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e给客户端的每个命令分配\u003cstrong\u003e\u003cmark\u003e唯一的顺序编号\u003c/mark\u003e\u003c/strong\u003e（unique serial numbers），\u003c/li\u003e\n  \u003cli\u003e状态机为每个客户端记录\u003cstrong\u003e\u003cmark\u003e最后已执行的命令序号\u003c/mark\u003e\u003c/strong\u003e，放到响应中，\u003c/li\u003e\n  \u003cli\u003e状态机如果发现某个序号的命令已经执行过，就会直接返回，不会再执行一遍。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/append_entries.go#L21\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// The response returned from a server appending entries to the log.\u003c/span\u003e\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eAppendEntriesResponse\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epb\u003c/span\u003e     \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprotobuf\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppendEntriesResponse\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epeer\u003c/span\u003e   \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// https://github.com/etcd-io/etcd/blob/release-0.4/third_party/github.com/goraft/raft/protobuf/append_entries_responses.pb.go#L35\u003c/span\u003e\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eAppendEntriesResponse\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eTerm\u003c/span\u003e             \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"s\"\u003e`protobuf:\u0026#34;varint,1,req\u0026#34; json:\u0026#34;Term,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eIndex\u003c/span\u003e            \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"s\"\u003e`protobuf:\u0026#34;varint,2,req\u0026#34; json:\u0026#34;Index,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCommitIndex\u003c/span\u003e      \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"s\"\u003e`protobuf:\u0026#34;varint,3,req\u0026#34; json:\u0026#34;CommitIndex,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSuccess\u003c/span\u003e          \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003ebool\u003c/span\u003e   \u003cspan class=\"s\"\u003e`protobuf:\u0026#34;varint,4,req\u0026#34; json:\u0026#34;Success,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eXXX_unrecognized\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e  \u003cspan class=\"s\"\u003e`json:\u0026#34;-\u0026#34;`\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"83-只读操作\"\u003e8.3 只读操作\u003c/h2\u003e\n\n\u003cp\u003e只读操作\u003cstrong\u003e\u003cmark\u003e无需向 log 文件写入任何内容\u003c/mark\u003e\u003c/strong\u003e。\n但如果没有额外措施，可能会有\u003cstrong\u003e\u003cmark\u003e返回过期数据的风险\u003c/mark\u003e\u003c/strong\u003e，因为处理这次请求的\nleader 可能已经被一个新 leader 取代了，而它自己还不知道。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e可线性化读\u003c/mark\u003e\u003c/strong\u003e（linearizable reads）能确保不会返回过期数据，\n要支持这一特性，Raft 需要针对 leader 引入两个额外措施：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003eLeader 必须有 \u003cstrong\u003e\u003cmark\u003e“哪些 entry 已经被提交”\u003c/mark\u003e\u003c/strong\u003e 的最新信息。\u003c/p\u003e\n\n    \u003cp\u003eLeader Completeness 特性保证了 leader 有所有的已提交 entry，但在它的任期刚开始时，\n it may not know which those are. To find out, it needs to commit an entry from its term.\u003c/p\u003e\n\n    \u003cp\u003eRaft 的处理方式是，让每个 \u003cstrong\u003e\u003cmark\u003eleader 在任期开始时，提交一个空的 no-op entry\u003c/mark\u003e\u003c/strong\u003e 到 log。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eleader 在处理只读请求之前，必须能\u003cstrong\u003e\u003cmark\u003e检查自己是否被剥夺了 leader 位置\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n    \u003cp\u003eRaft 的处理方式是，在处理只读请求之前，让 leader 与集群的大多数节点交换心跳消息。\n 或者，leader 可以依靠心跳机制提供一种租约形式 [9]，但这需要依赖 timing for safety (it assumes bounded clock skew).\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"9-实现与评估\"\u003e9 实现与评估\u003c/h1\u003e\n\n\u003cp\u003eWe have implemented Raft as part of a replicated state machine that stores\nconfiguration information for RAMCloud [33] and assists in failover of the\nRAMCloud coordinator. The Raft implementation contains roughly\n\u003cstrong\u003e\u003cmark\u003e2000 lines of C++ code\u003c/mark\u003e\u003c/strong\u003e, not including tests, comments, or\nblank lines. The \u003ca href=\"http://github.com/logcabin/logcabin\"\u003esource code\u003c/a\u003e is freely available [23]. There\nare also about 25 independent third-party open source implementations [34] of\nRaft in various stages of development, based on drafts of this paper. Also,\nvarious companies are deploying Raft-based systems [34].  The remainder of this\nsection \u003cstrong\u003e\u003cmark\u003eevaluates Raft using three criteria\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eunderstandability\u003c/li\u003e\n  \u003cli\u003ecorrectness\u003c/li\u003e\n  \u003cli\u003eperformance\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"91-可理解性\"\u003e9.1 可理解性\u003c/h2\u003e\n\n\u003cp\u003eTo measure Raft’s understandability relative to Paxos, we conducted an\nexperimental study using upper-level undergraduate and graduate students in an\nAdvanced Operating Systems course at Stanford University and a Distributed\nComputing course at U.C. Berkeley. We recorded a video lecture of Raft and\nanother of Paxos, and created corresponding quizzes.\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eThe Raft lecture covered the content of this paper except for log compaction;\u003c/li\u003e\n  \u003cli\u003eThe Paxos lecture covered enough material to create an equivalent replicated\nstate machine, including single-decree Paxos, multi-decree Paxos,\nreconfiguration, and a few optimizations needed in practice (such as leader\nelection).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe quizzes tested basic understanding of the algorithms and also required\nstudents to reason about corner cases. Each student watched one video, took the\ncorresponding quiz, watched the second video, and took the second quiz.  About\nhalf of the participants did the Paxos portion first and the other half did the\nRaft portion first in order to account for both individual differences in\nperformance and experience gained from the first portion of the study.\u003c/p\u003e\n\n\u003cp\u003eWe compared participants’ scores on each quiz to determine whether participants\nshowed a better understanding of Raft.  We tried to make the comparison between\nPaxos and Raft as fair as possible. The experiment favored Paxos in two ways:\n15 of the 43 participants reported having some prior experience with Paxos, and\nthe Paxos video is 14% longer than the Raft video. As summarized in Table 1, we\nhave taken steps to mitigate potential sources of bias.\u003c/p\u003e\n\n\u003ctable\u003e\n  \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth style=\"text-align: left\"\u003eConcern\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eSteps taken to mitigate bias\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eMaterials for review [28, 31]\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eEqual lecture quality\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eSame lecturer for both. Paxos lecture based on and improved from existing materials used in several universities. Paxos lecture is 14% longer.\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003evideos\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eEqual quiz difficulty\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eQuestions grouped in difficulty and paired across exams.\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003equizzes\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eFair grading Used rubric.\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eGraded in random order, alternating between quizzes.\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003erubric\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp align=\"center\"\u003eTable 1: Concerns of possible bias against Paxos in the study, steps taken to counter each, and additional materials available.\u003c/p\u003e\n\n\u003cp\u003eAll of our materials are available for review [28, 31].  On average,\nparticipants scored 4.9 points higher on the Raft quiz than on the Paxos quiz\n(out of a possible 60 points, the mean Raft score was 25.7 and the mean Paxos\nscore was 20.8); Figure 14 shows their individual scores.\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/14.png\" width=\"40%\" height=\"40%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 14.\nA scatter plot comparing 43 participants’ performance on the Raft\nand Paxos quizzes. Points above the diagonal (33) represent participants who\nscored higher for Raft.\n\u003c/p\u003e\n\n\u003cp\u003eA paired t-test states that, with 95% confidence, the true distribution of Raft\nscores has a mean at least 2.5 points larger than the true distribution of\nPaxos scores.  We also created a linear regression model that predicts a new\nstudent’s quiz scores based on three factors: which quiz they took, their\ndegree of prior Paxos experience, and the order in which they learned the\nalgorithms. The model predicts that the choice of quiz produces a 12.5-point\ndifference in favor of Raft. This is significantly higher than the observed\ndifference of 4.9 points, because many of the actual students had prior Paxos\nexperience, which helped Paxos considerably, whereas it helped Raft slightly\nless.  Curiously, the model also predicts scores 6.3 points lower on Raft for\npeople that have already taken the Paxos quiz; although we don’t know why, this\ndoes appear to be statistically significant.\u003c/p\u003e\n\n\u003cp\u003eWe also surveyed participants after their quizzes to see which algorithm they\nfelt would be easier to implement or explain; these results are shown in Figure 15.\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/15.png\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 15. Using a 5-point scale, participants were asked\n(left) which algorithm they felt would be easier to implement\nin a functioning, correct, and efficient system, and (right)\nwhich would be easier to explain to a CS graduate student.\n\u003c/p\u003e\n\n\u003cp\u003eAn overwhelming majority of participants reported Raft would be easier to\nimplement and explain (33 of 41 for each question). However, these\nself-reported feelings may be less reliable than participants’ quiz scores, and\nparticipants may have been biased by knowledge of our hypothesis that Raft is\neasier to understand.  A detailed discussion of the Raft user study is\navailable at [31].\u003c/p\u003e\n\n\u003ch2 id=\"92-正确性\"\u003e9.2 正确性\u003c/h2\u003e\n\n\u003cp\u003eWe have developed a formal specification and a proof of safety for the\nconsensus mechanism described in Section 5. The formal specification [31] makes\nthe information summarized in Figure 2 completely precise using the\n\u003cstrong\u003e\u003cmark\u003eTLA+ specification language\u003c/mark\u003e\u003c/strong\u003e [17]. It is about 400 lines\nlong and serves as the subject of the proof. It is also useful on its own for\nanyone implementing Raft. We have mechanically proven the Log Completeness\nProperty using the TLA proof system [7]. However, this proof relies on\ninvariants that have not been mechanically checked (for example, we have not\nproven the type safety of the specification). Furthermore, we have written an\ninformal proof [31] of the State Machine Safety property which is complete (it\nrelies on the specification alone) and relatively precise (it is about 3500 words long).\u003c/p\u003e\n\n\u003ch2 id=\"93-性能\"\u003e9.3 性能\u003c/h2\u003e\n\n\u003cp\u003eRaft’s performance is similar to other consensus algorithms such as Paxos. The\nmost important case for performance is when an established leader is\nreplicating new log entries. Raft achieves this using the minimal number of\nmessages (a single round-trip from leader to half the cluster). It is also\npossible to further improve Raft’s performance. For example, it easily supports\nbatching and pipelining requests for higher throughput and lower latency.\nVarious optimizations have been proposed in the literature for other\nalgorithms; many of these could be applied to Raft, but we leave this to future\nwork.  We used our Raft implementation to measure the performance of Raft’s\nleader election algorithm and answer two questions. First, does the election\nprocess converge quickly? Second, what is the minimum downtime that can be\nachieved after leader crashes?\u003c/p\u003e\n\n\u003cp\u003eTo measure leader election, we repeatedly crashed the\nleader of a cluster of five servers and timed how long it\ntook to detect the crash and elect a new leader (see Figure 16).\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/raft-paper/16.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 16. 检测与替换一个挂掉的 leader 所需的时间。\nThe top graph varies the amount of randomness in election\ntimeouts, and the bottom graph scales the minimum election\ntimeout. Each line represents 1000 trials (except for 100 trials for “150–150ms”) and corresponds to a particular choice\nof election timeouts; for example, “150–155ms” means that\nelection timeouts were chosen randomly and uniformly between 150ms and 155ms. The measurements were taken on a\ncluster of five servers with a broadcast time of roughly 15ms.\nResults for a cluster of nine servers are similar.\n\u003c/p\u003e\n\n\u003cp\u003eTo generate a worst-case scenario, the servers in each trial had different log\nlengths, so some candidates were not eligible to become leader. Furthermore, to\nencourage split votes, our test script triggered a synchronized broadcast of\nheartbeat RPCs from leader before terminating its process (this approximates\nthe behavior of leader replicating a new log entry prior to crashing). leader\nwas crashed uniformly randomly within its heartbeat interval, which was half of\nthe minimum election timeout for all tests. Thus, the smallest possible\ndowntime was about half of the minimum election timeout.\u003c/p\u003e\n\n\u003cp\u003eThe top graph in Figure 16 shows that a small amount of randomization in the\nelection timeout is enough to avoid split votes in elections. In the absence of\nrandomness, leader election consistently took longer than 10 seconds in our\ntests due to many split votes. Adding just 5ms of randomness helps\nsignificantly, resulting in a median downtime of 287ms. Using more randomness\nimproves worst-case behavior: with 50ms of randomness the worstcase completion\ntime (over 1000 trials) was 513ms.\u003c/p\u003e\n\n\u003cp\u003eThe bottom graph in Figure 16 shows that downtime can be reduced by reducing\nthe election timeout. With an election timeout of 12–24ms, it takes only 35ms\non average to elect a leader (the longest trial took 152ms).\u003c/p\u003e\n\n\u003cp\u003eHowever, lowering the timeouts beyond this point violates Raft’s timing\nrequirement: leaders have difficulty broadcasting heartbeats before other\nservers start new elections.  This can cause unnecessary leader changes and\nlower overall system availability. We recommend using a conservative election\ntimeout such as 150–300ms; such timeouts are unlikely to cause unnecessary\nleader changes and will still provide good availability.\u003c/p\u003e\n\n\u003ch1 id=\"10-相关工作\"\u003e10 相关工作\u003c/h1\u003e\n\n\u003cp\u003eThere have been numerous publications related to consensus algorithms, many of which fall into one of the following categories:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eLamport’s original description of Paxos [15], and attempts to explain it more clearly [16, 20, 21].\u003c/li\u003e\n  \u003cli\u003eElaborations of Paxos, which fill in missing details and modify the algorithm\nto provide a better foundation for implementation [26, 39, 13].\u003c/li\u003e\n  \u003cli\u003eSystems that implement consensus algorithms, such as Chubby [2, 4], ZooKeeper\n[11, 12], and Spanner [6]. The algorithms for Chubby and Spanner have not\nbeen published in detail, though both claim to be based on Paxos. ZooKeeper’s\nalgorithm has been published in more detail, but it is quite different from Paxos.\u003c/li\u003e\n  \u003cli\u003ePerformance optimizations that can be applied to Paxos [18, 19, 3, 25, 1, 27].\u003c/li\u003e\n  \u003cli\u003eOki and Liskov’s Viewstamped Replication (VR), an alternative approach to\nconsensus developed around the same time as Paxos. The original description\n[29] was intertwined with a protocol for distributed transactions, but the\ncore consensus protocol has been separated in a recent update [22]. VR uses a\nleaderbased approach with many similarities to Raft.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eThe greatest difference between Raft and Paxos is Raft’s strong leadership:\nRaft uses leader election as an essential part of the consensus protocol, and\nit concen- 15trates as much functionality as possible in leader. This approach\nresults in a simpler algorithm that is easier to understand. For example, in\nPaxos, leader election is orthogonal to the basic consensus protocol: it serves\nonly as a performance optimization and is not required for achieving consensus.\nHowever, this results in additional mechanism: Paxos includes both a two-phase\nprotocol for basic consensus and a separate mechanism for leader election.  In\ncontrast, Raft incorporates leader election directly into the consensus\nalgorithm and uses it as the first of the two phases of consensus. This results\nin less mechanism than in Paxos.\u003c/p\u003e\n\n\u003cp\u003eLike Raft, VR and ZooKeeper are leader-based and therefore share many of Raft’s\nadvantages over Paxos.  However, Raft has less mechanism that VR or ZooKeeper\nbecause it minimizes the functionality in non-leaders. For example, log entries\nin Raft flow in only one direction: outward from leader in AppendEntries RPCs.\nIn VR log entries flow in both directions (leaders can receive log entries\nduring the election process); this results in additional mechanism and\ncomplexity. The published description of ZooKeeper also transfers log entries\nboth to and from leader, but the implementation is apparently more like Raft\n[35].\u003c/p\u003e\n\n\u003cp\u003eRaft has fewer message types than any other algorithm for consensus-based log\nreplication that we are aware of. For example, we counted the message types VR\nand ZooKeeper use for basic consensus and membership changes (excluding log\ncompaction and client interaction, as these are nearly independent of the\nalgorithms). VR and ZooKeeper each define 10 different message types, while\nRaft has only 4 message types (two RPC requests and their responses). Raft’s\nmessages are a bit more dense than the other algorithms’, but they are simpler\ncollectively. In addition, VR and ZooKeeper are described in terms of\ntransmitting entire logs during leader changes; additional message types will\nbe required to optimize these mechanisms so that they are practical.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eRaft’s strong leadership approach simplifies the algorithm, but it precludes some\nperformance optimizations.  For example, Egalitarian Paxos (EPaxos) can achieve\nhigher performance under some conditions with a leaderless approach [27].\nEPaxos exploits commutativity in state machine commands. Any server can commit\na command with just one round of communication as long as other commands that\nare proposed concurrently commute with it. However, if commands that are\nproposed concurrently do not commute with each other, EPaxos requires an\nadditional round of communication. Because any server may commit commands,\nEPaxos balances load well between servers and is able to achieve lower latency\nthan Raft in WAN settings. However, it adds significant complexity to Paxos.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eSeveral different approaches for cluster membership changes have been proposed\nor implemented in other work, including Lamport’s original proposal [15], VR\n[22], and SMART [24]. We chose the joint consensus approach for Raft because it\nleverages the rest of the consensus protocol, so that very little additional\nmechanism is required for membership changes. Lamport’s α-based approach was\nnot an option for Raft because it assumes consensus can be reached without a\nleader. In comparison to VR and SMART, Raft’s reconfiguration algorithm has the\nadvantage that membership changes can occur without limiting the processing of\nnormal requests; in contrast, VR stops all normal processing during\nconfiguration changes, and SMART imposes an α-like limit on the number of\noutstanding requests. Raft’s approach also adds less mechanism than either VR\nor SMART.\u003c/p\u003e\n\n\u003ch1 id=\"11-总结\"\u003e11 总结\u003c/h1\u003e\n\n\u003cp\u003eAlgorithms are often designed with correctness, efficiency, and/or conciseness\nas the primary goals. Although these are all worthy goals, we believe that\nunderstandability is just as important. None of the other goals can be achieved\nuntil developers render the algorithm into a practical implementation, which\nwill inevitably deviate from and expand upon the published form. Unless\ndevelopers have a deep understanding of the algorithm and can create intuitions\nabout it, it will be difficult for them to retain its desirable properties in\ntheir implementation.\u003c/p\u003e\n\n\u003cp\u003eIn this paper we addressed the issue of distributed consensus, where a widely\naccepted but impenetrable algorithm, Paxos, has challenged students and\ndevelopers for many years. We developed a new algorithm, Raft, which we have\nshown to be more understandable than Paxos.\u003c/p\u003e\n\n\u003cp\u003eWe also believe that Raft provides a better foundation for system building.\nUsing understandability as the primary design goal changed the way we\napproached the design of Raft; as the design progressed we found ourselves\nreusing a few techniques repeatedly, such as decomposing the problem and\nsimplifying the state space. These techniques not only improved the\nunderstandability of Raft but also made it easier to convince ourselves of its\ncorrectness.\u003c/p\u003e\n\n\u003ch1 id=\"12-致谢\"\u003e12 致谢\u003c/h1\u003e\n\n\u003cp\u003eThe user study would not have been possible without the support of Ali Ghodsi,\nDavid Mazieres, and the students of CS 294-91 at Berkeley and CS 240 at\nStanford. Scott Klemmer helped us design the user study, and Nelson Ray advised\nus on statistical analysis. The Paxos slides for the user study borrowed\nheavily from a slide deck originally created by Lorenzo Alvisi. Special thanks\ngo to David Mazieres and Ezra Hoch for finding subtle bugs in Raft. Many people\nprovided helpful feedback on the paper and user study materials, including Ed\nBugnion, Michael Chan, Hugues Evrard, Daniel Giffin, Arjun Gopalan, Jon Howell,\nVimalkumar Jeyakumar, Ankita Kejriwal, Aleksandar Kracun, Amit Levy, Joel\nMartin, Satoshi Matsushita, Oleg Pesok, David Ramos, Robbert van Renesse,\nMendel Rosenblum, Nicolas Schiper, Deian Stefan, Andrew Stone, Ryan Stutsman,\nDavid Terei, Stephen Yang, Matei Zaharia, 24 anonymous conference reviewers\n(with duplicates), and especially our shepherd Eddie Kohler. Werner Vogels\ntweeted a link to an earlier draft, which gave Raft significant exposure. This\nwork was supported by the Gigascale Systems Research Center and the Multiscale\nSystems Center, two of six research centers funded under the Focus Center\nResearch Program, a Semiconductor Research Corporation program, by STARnet, a\nSemiconductor Research Corporation program sponsored by MARCO and DARPA, by the\nNational Science Foundation under Grant No. 0963859, and by grants from\nFacebook, Google, Mellanox, NEC, NetApp, SAP, and Samsung. Diego Ongaro is\nsupported by The Junglee Corporation Stanford Graduate Fellowship.\u003c/p\u003e\n\n\u003ch1 id=\"参考文献\"\u003e参考文献\u003c/h1\u003e\n\n\u003cul\u003e\n  \u003cli\u003e[1] BOLOSKY, W. J., BRADSHAW, D., HAAGENS, R. B., KUSTERS, N. P., AND LI, P. Paxos replicated state machines as the basis of a high-performance data store.  In Proc. NSDI’11, USENIX Conference on Networked Systems Design and Implementation (2011), USENIX, pp. 141–154.\u003c/li\u003e\n  \u003cli\u003e[2] BURROWS, M. The Chubby lock service for looselycoupled distributed systems. In Proc. OSDI’06, Symposium on Operating Systems Design and Implementation (2006), USENIX, pp. 335–350.\u003c/li\u003e\n  \u003cli\u003e[3] CAMARGOS, L. J., SCHMIDT, R. M., AND PEDONE, F.  Multicoordinated Paxos. In Proc. PODC’07, ACM Symposium on Principles of Distributed Computing (2007), ACM, pp. 316–317.\u003c/li\u003e\n  \u003cli\u003e[4] CHANDRA, T. D., GRIESEMER, R., AND REDSTONE, J.  Paxos made live: an engineering perspective. In Proc.  PODC’07, ACM Symposium on Principles of Distributed Computing (2007), ACM, pp. 398–407.\u003c/li\u003e\n  \u003cli\u003e[5] CHANG, F., DEAN, J., GHEMAWAT, S., HSIEH, W. C., WALLACH, D. A., BURROWS, M., CHANDRA, T., FIKES, A., AND GRUBER, R. E. Bigtable: a distributed storage system for structured data. In Proc. OSDI’06, USENIX Symposium on Operating Systems Design and Implementation (2006), USENIX, pp. 205–218.\u003c/li\u003e\n  \u003cli\u003e[6] CORBETT, J. C., DEAN, J., EPSTEIN, M., FIKES, A., FROST, C., FURMAN, J. J., GHEMAWAT, S., GUBAREV, A., HEISER, C., HOCHSCHILD, P., HSIEH, W., KANTHAK, S., KOGAN, E., LI, H., LLOYD, A., MELNIK, S., MWAURA, D., NAGLE, D., QUINLAN, S., RAO, R., ROLIG, L., SAITO, Y., SZYMANIAK, M., TAYLOR, C., WANG, R., AND WOODFORD, D. Spanner: Google’s globally-distributed database. In Proc. OSDI’12, USENIX Conference on Operating Systems Design and Implementation (2012), USENIX, pp. 251–264.\u003c/li\u003e\n  \u003cli\u003e[7] COUSINEAU, D., DOLIGEZ, D., LAMPORT, L., MERZ, S., RICKETTS, D., AND VANZETTO, H. TLA+ proofs.  In Proc. FM’12, Symposium on Formal Methods (2012), D. Giannakopoulou and D. M´ery, Eds., vol. 7436 of Lecture Notes in Computer Science, Springer, pp. 147–154.\u003c/li\u003e\n  \u003cli\u003e[8] GHEMAWAT, S., GOBIOFF, H., AND LEUNG, S.-T. The Google file system. In Proc. SOSP’03, ACM Symposium on Operating Systems Principles (2003), ACM, pp. 29–43.\u003c/li\u003e\n  \u003cli\u003e[9] GRAY, C., AND CHERITON, D. Leases: An efficient faulttolerant mechanism for distributed file cache consistency.  In Proceedings of the 12th ACM Ssymposium on Operating Systems Principles (1989), pp. 202–210.\u003c/li\u003e\n  \u003cli\u003e[10] HERLIHY, M. P., AND WING, J. M. Linearizability: a correctness condition for concurrent objects. ACM Transactions on Programming Languages and Systems 12 (July 1990), 463–492.\u003c/li\u003e\n  \u003cli\u003e[11] HUNT, P., KONAR, M., JUNQUEIRA, F. P., AND REED, B. ZooKeeper: wait-free coordination for internet-scale systems. In Proc ATC’10, USENIX Annual Technical Conference (2010), USENIX, pp. 145–158.\u003c/li\u003e\n  \u003cli\u003e[12] JUNQUEIRA, F. P., REED, B. C., AND SERAFINI, M.  Zab: High-performance broadcast for primary-backup systems. In Proc. DSN’11, IEEE/IFIP Int’l Conf. on Dependable Systems \u0026amp; Networks (2011), IEEE Computer Society, pp. 245–256.\u003c/li\u003e\n  \u003cli\u003e[13] KIRSCH, J., AND AMIR, Y. Paxos for system builders.  Tech. Rep. CNDS-2008-2, Johns Hopkins University, 2008.\u003c/li\u003e\n  \u003cli\u003e[14] LAMPORT, L. Time, clocks, and the ordering of events in a distributed system. Commununications of the ACM 21, 7 (July 1978), 558–565.\u003c/li\u003e\n  \u003cli\u003e[15] LAMPORT, L. The part-time parliament. ACM Transactions on Computer Systems 16, 2 (May 1998), 133–169.\u003c/li\u003e\n  \u003cli\u003e[16] LAMPORT, L. Paxos made simple. ACM SIGACT News 32, 4 (Dec. 2001), 18–25.\u003c/li\u003e\n  \u003cli\u003e[17] LAMPORT, L. Specifying Systems, The TLA+ Language and Tools for Hardware and Software Engineers. AddisonWesley, 2002.\u003c/li\u003e\n  \u003cli\u003e[18] LAMPORT, L. Generalized consensus and Paxos. Tech.  Rep. MSR-TR-2005-33, Microsoft Research, 2005.\u003c/li\u003e\n  \u003cli\u003e[19] LAMPORT, L. Fast paxos. Distributed Computing 19, 2 (2006), 79–103.\u003c/li\u003e\n  \u003cli\u003e[20] LAMPSON, B. W. How to build a highly available system using consensus. In Distributed Algorithms, O. Baboaglu and K. Marzullo, Eds. Springer-Verlag, 1996, pp. 1–17.\u003c/li\u003e\n  \u003cli\u003e[21] LAMPSON, B. W. The ABCD’s of Paxos. In Proc.  PODC’01, ACM Symposium on Principles of Distributed Computing (2001), ACM, pp. 13–13.\u003c/li\u003e\n  \u003cli\u003e[22] LISKOV, B., AND COWLING, J. Viewstamped replication revisited. Tech. Rep. MIT-CSAIL-TR-2012-021, MIT, July 2012.\u003c/li\u003e\n  \u003cli\u003e[23] LogCabin source code. http://github.com/logcabin/logcabin.  17[24] LORCH, J. R., ADYA, A., BOLOSKY, W. J., CHAIKEN, R., DOUCEUR, J. R., AND HOWELL, J. The SMART way to migrate replicated stateful services. In Proc. EuroSys’06, ACM SIGOPS/EuroSys European Conference on Computer Systems (2006), ACM, pp. 103–115.\u003c/li\u003e\n  \u003cli\u003e[25] MAO, Y., JUNQUEIRA, F. P., AND MARZULLO, K.  Mencius: building efficient replicated state machines for WANs. In Proc. OSDI’08, USENIX Conference on Operating Systems Design and Implementation (2008), USENIX, pp. 369–384.\u003c/li\u003e\n  \u003cli\u003e[26] MAZIERES, D. Paxos made practical. http: //www.scs.stanford.edu/˜dm/home/ papers/paxos.pdf, Jan. 2007.\u003c/li\u003e\n  \u003cli\u003e[27] MORARU, I., ANDERSEN, D. G., AND KAMINSKY, M.  There is more consensus in egalitarian parliaments. In Proc. SOSP’13, ACM Symposium on Operating System Principles (2013), ACM.\u003c/li\u003e\n  \u003cli\u003e[28] Raft user study. http://ramcloud.stanford.  edu/˜ongaro/userstudy/.\u003c/li\u003e\n  \u003cli\u003e[29] OKI, B. M., AND LISKOV, B. H. Viewstamped replication: A new primary copy method to support highly-available distributed systems. In Proc. PODC’88, ACM Symposium on Principles of Distributed Computing (1988), ACM, pp. 8–17.\u003c/li\u003e\n  \u003cli\u003e[30] O’NEIL, P., CHENG, E., GAWLICK, D., AND ONEIL, E.  The log-structured merge-tree (LSM-tree). Acta Informatica 33, 4 (1996), 351–385.\u003c/li\u003e\n  \u003cli\u003e[31] ONGARO, D. Consensus: Bridging Theory and Practice.  PhD thesis, Stanford University, 2014 (work in progress).  http://ramcloud.stanford.edu/˜ongaro/ thesis.pdf.\u003c/li\u003e\n  \u003cli\u003e[32] ONGARO, D., AND OUSTERHOUT, J. In search of an understandable consensus algorithm. In Proc ATC’14, USENIX Annual Technical Conference (2014), USENIX.\u003c/li\u003e\n  \u003cli\u003e[33] OUSTERHOUT, J., AGRAWAL, P., ERICKSON, D., KOZYRAKIS, C., LEVERICH, J., MAZIERES, D., MITRA, S., NARAYANAN, A., ONGARO, D., PARULKAR, G., ROSENBLUM, M., RUMBLE, S. M., STRATMANN, E., AND STUTSMAN, R. The case for RAMCloud. Communications of the ACM 54 (July 2011), 121–130.\u003c/li\u003e\n  \u003cli\u003e[34] Raft consensus algorithm website.  http://raftconsensus.github.io.\u003c/li\u003e\n  \u003cli\u003e[35] REED, B. Personal communications, May 17, 2013.\u003c/li\u003e\n  \u003cli\u003e[36] ROSENBLUM, M., AND OUSTERHOUT, J. K. The design and implementation of a log-structured file system. ACM Trans. Comput. Syst. 10 (February 1992), 26–52.\u003c/li\u003e\n  \u003cli\u003e[37] SCHNEIDER, F. B. Implementing fault-tolerant services using the state machine approach: a tutorial. ACM Computing Surveys 22, 4 (Dec. 1990), 299–319.\u003c/li\u003e\n  \u003cli\u003e[38] SHVACHKO, K., KUANG, H., RADIA, S., AND CHANSLER, R. The Hadoop distributed file system.  In Proc. MSST’10, Symposium on Mass Storage Systems and Technologies (2010), IEEE Computer Society, pp. 1–10.\u003c/li\u003e\n  \u003cli\u003e[39] VAN RENESSE, R. Paxos made moderately complex.  Tech. rep., Cornell University, 2012.\u003c/li\u003e\n\u003c/ul\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/cracking-k8s-network-policy/\"\u003e\u003cspan\u003e« Cracking Kubernetes Network Policy\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/cracking-k8s-authz-rbac/\"\u003e\u003cspan\u003eCracking Kubernetes RBAC Authorization (AuthZ) Model (2022) »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2022-02-06T00:00:00Z",
  "Author": "Arthur Chiao"
}