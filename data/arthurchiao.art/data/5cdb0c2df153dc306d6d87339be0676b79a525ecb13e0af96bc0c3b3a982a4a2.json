{
  "Source": "arthurchiao.art",
  "Title": "Firewalling with BPF/XDP: Examples and Deep Dive",
  "Link": "https://arthurchiao.art/blog/firewalling-with-bpf-xdp/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eFirewalling with BPF/XDP: Examples and Deep Dive\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2021-06-27 | Last Update 2021-06-27\u003c/p\u003e\n  \n  \u003ch3 id=\"tl-dr\"\u003eTL; DR\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003eSome \u003cstrong\u003e\u003cmark\u003ebeginner-level BPF programs\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003eA containerized playground to \u003cstrong\u003e\u003cmark\u003eexercise step by step\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003etc/kernel code analysis\u003c/mark\u003e\u003c/strong\u003e to explain how things work in the underlying\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/allow-any.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#tl-dr\" id=\"markdown-toc-tl-dr\"\u003eTL; DR\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-introduction\" id=\"markdown-toc-1-introduction\"\u003e1 Introduction\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-bpfxdp-in-a-nutshell\" id=\"markdown-toc-11-bpfxdp-in-a-nutshell\"\u003e1.1 BPF/XDP in a nutshell\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-environment-info\" id=\"markdown-toc-12-environment-info\"\u003e1.2 Environment info\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-playground-setup\" id=\"markdown-toc-13-playground-setup\"\u003e1.3 Playground setup\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-connectivity-test\" id=\"markdown-toc-14-connectivity-test\"\u003e1.4 Connectivity test\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#l2-test-with-arping-arp\" id=\"markdown-toc-l2-test-with-arping-arp\"\u003eL2 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003earping\u003c/code\u003e (ARP)\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#l3-test-with-ping-icmp\" id=\"markdown-toc-l3-test-with-ping-icmp\"\u003eL3 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eping\u003c/code\u003e (ICMP)\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#l4l7-test-with-curl-tcphttp\" id=\"markdown-toc-l4l7-test-with-curl-tcphttp\"\u003eL4/L7 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e (TCP/HTTP)\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-drop-specific-traffic-with-bpf-coding--testing\" id=\"markdown-toc-2-drop-specific-traffic-with-bpf-coding--testing\"\u003e2 Drop specific traffic with BPF: coding \u0026amp; testing\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-l2-example-drop-all-arp-packets\" id=\"markdown-toc-21-l2-example-drop-all-arp-packets\"\u003e2.1 L2 example: drop all \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eARP\u003c/code\u003e packets\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#source-code-drop-arpc\" id=\"markdown-toc-source-code-drop-arpc\"\u003eSource code: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-arp.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#compile-load-and-attach-to-kernel-hooking-point\" id=\"markdown-toc-compile-load-and-attach-to-kernel-hooking-point\"\u003eCompile, load, and attach to kernel hooking point\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#test\" id=\"markdown-toc-test\"\u003eTest\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#explanation\" id=\"markdown-toc-explanation\"\u003eExplanation\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#cleanup\" id=\"markdown-toc-cleanup\"\u003eCleanup\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-l3-example-drop-all-icmp-packets\" id=\"markdown-toc-22-l3-example-drop-all-icmp-packets\"\u003e2.2 L3 example: drop all \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eICMP\u003c/code\u003e packets\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#source-code-drop-icmpc\" id=\"markdown-toc-source-code-drop-icmpc\"\u003eSource code: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-icmp.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#compile-load-and-attach-to-kernel-hooking-point-1\" id=\"markdown-toc-compile-load-and-attach-to-kernel-hooking-point-1\"\u003eCompile, load, and attach to kernel hooking point\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#test-1\" id=\"markdown-toc-test-1\"\u003eTest\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#explanation-1\" id=\"markdown-toc-explanation-1\"\u003eExplanation\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-l4-example-drop-tcp80-packets-only\" id=\"markdown-toc-23-l4-example-drop-tcp80-packets-only\"\u003e2.3 L4 example: drop \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTCP/80\u003c/code\u003e packets only\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#code-drop-tcpc\" id=\"markdown-toc-code-drop-tcpc\"\u003eCode: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-tcp.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#test-tcp80-traffic-being-dropped\" id=\"markdown-toc-test-tcp80-traffic-being-dropped\"\u003eTest: TCP/80 traffic being dropped\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#test-tcp8080-traffic-not-dropped\" id=\"markdown-toc-test-tcp8080-traffic-not-dropped\"\u003eTest: TCP/8080 traffic not dropped\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#explanation-2\" id=\"markdown-toc-explanation-2\"\u003eExplanation\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-tear-down-playground\" id=\"markdown-toc-24-tear-down-playground\"\u003e2.4 Tear down playground\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-summary\" id=\"markdown-toc-25-summary\"\u003e2.5 Summary\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#filtering-more-fields\" id=\"markdown-toc-filtering-more-fields\"\u003eFiltering more fields\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#hooking-at-more-places\" id=\"markdown-toc-hooking-at-more-places\"\u003eHooking at more places\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#making-filtering-conditions-configurable\" id=\"markdown-toc-making-filtering-conditions-configurable\"\u003eMaking filtering conditions configurable\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-how-does-it-work-in-the-underlying-dig-inside\" id=\"markdown-toc-3-how-does-it-work-in-the-underlying-dig-inside\"\u003e3 How does it work in the underlying? Dig inside\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-loading-bpf-into-kernel-part-1-tc-front-end-processing\" id=\"markdown-toc-31-loading-bpf-into-kernel-part-1-tc-front-end-processing\"\u003e3.1 Loading BPF into kernel part 1: tc front end processing\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#source-code\" id=\"markdown-toc-source-code\"\u003eSource code\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#calling-stack\" id=\"markdown-toc-calling-stack\"\u003eCalling stack\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#explanations\" id=\"markdown-toc-explanations\"\u003eExplanations\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-loading-bpf-into-kernel-part-2-kernel-backend-processing\" id=\"markdown-toc-32-loading-bpf-into-kernel-part-2-kernel-backend-processing\"\u003e3.2 Loading BPF into kernel part 2: kernel backend processing\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#netlink-message-handlers-registration\" id=\"markdown-toc-netlink-message-handlers-registration\"\u003eNetlink message handlers registration\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#trigger-tc_ctl_tclass-on-receiving-tc-filter-add-messages\" id=\"markdown-toc-trigger-tc_ctl_tclass-on-receiving-tc-filter-add-messages\"\u003eTrigger \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc_ctl_tclass()\u003c/code\u003e on receiving “tc filter add” messages\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-kernel-datapath-inbound-handling-entrypoint-__netif_receive_skb_core\" id=\"markdown-toc-33-kernel-datapath-inbound-handling-entrypoint-__netif_receive_skb_core\"\u003e3.3 Kernel datapath: inbound handling entrypoint \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e__netif_receive_skb_core()\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#bpf-classifier-callbacks-registration\" id=\"markdown-toc-bpf-classifier-callbacks-registration\"\u003eBPF classifier callbacks registration\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#calling-into-tc-filtering-framework\" id=\"markdown-toc-calling-into-tc-filtering-framework\"\u003eCalling into tc filtering framework\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#executing-our-bpf-code\" id=\"markdown-toc-executing-our-bpf-code\"\u003eExecuting our BPF code\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-xdp-version\" id=\"markdown-toc-4-xdp-version\"\u003e4 XDP version\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-intro\" id=\"markdown-toc-41-intro\"\u003e4.1 Intro\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-code-todo\" id=\"markdown-toc-42-code-todo\"\u003e4.2 Code (TODO)\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-conclusion\" id=\"markdown-toc-5-conclusion\"\u003e5 Conclusion\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-tcpdump-hooking-point\" id=\"markdown-toc-51-tcpdump-hooking-point\"\u003e5.1 tcpdump hooking point\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-netfilter-framework\" id=\"markdown-toc-52-netfilter-framework\"\u003e5.2 Netfilter framework\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#references\" id=\"markdown-toc-references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-introduction\"\u003e1 Introduction\u003c/h1\u003e\n\n\u003cp\u003eThe superpower of \u003cstrong\u003e\u003cmark\u003ebeing able to dynamically program the datapath of Linux kernel\u003c/mark\u003e\u003c/strong\u003e\nmakes BPF/XDP an excellent tool for implementing efficient L3-L7 firewalls.\u003c/p\u003e\n\n\u003cp\u003eWhile it has already been used this way in production at large scale [2,6] -\nwhich indicates the maturity of technology - it’s still not clear to many network\nengineers and developers that \u003cstrong\u003e\u003cmark\u003ehow does this facility actually works in the underlying\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n\n\u003cp\u003eThis post hopes to fill the gap by \u003cstrong\u003e\u003cmark\u003eproviding some simple but practical examples\u003c/mark\u003e\u003c/strong\u003e,\nand \u003cstrong\u003e\u003cmark\u003ea containerized environment to carry out the experiments step by step\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"11-bpfxdp-in-a-nutshell\"\u003e1.1 BPF/XDP in a nutshell\u003c/h2\u003e\n\n\u003cp\u003eThis post aims to be a practical guide, so we try to explain how BPF/XDP works\nwith the simplest words. As shown below, \u003cstrong\u003e\u003cmark\u003ekernel embeds some hooking points in its network processing path\u003c/mark\u003e\u003c/strong\u003e.\nEach hooking point can be \u003cstrong\u003e\u003cmark\u003eviewed as a sandbox\u003c/mark\u003e\u003c/strong\u003e,\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/allow-any.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 1. Network processing path and BPF hooking points\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\n    \u003cp\u003eBy default, no code in the sandboxs, it’s empty. Kernel processing steps in this case:\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003eProcessing stage 1\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003eSandbox processing\u003c/strong\u003e: \u003cstrong\u003e\u003cmark\u003edo nothing\u003c/mark\u003e\u003c/strong\u003e (allow any, effectively)\u003c/li\u003e\n      \u003cli\u003eProcessing stage 2\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eWhen \u003cstrong\u003e\u003cmark\u003eusers inject their code into the sandboxs\u003c/mark\u003e\u003c/strong\u003e, the overall processing logic will be changed. Logic now:\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003eProcessing stage 1\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003eSandbox processing\u003c/strong\u003e: \u003cstrong\u003e\u003cmark\u003eexecuting user code\u003c/mark\u003e\u003c/strong\u003e (may\nmodify the input packets), \u003cstrong\u003e\u003cmark\u003ereturning a verdict to the kernel\u003c/mark\u003e\u003c/strong\u003e,\nindicating how to process the packet in the next (e.g. drop/continue/redirect)\u003c/li\u003e\n      \u003cli\u003eDoing something according to the verdict returned by step 2\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"12-environment-info\"\u003e1.2 Environment info\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003eBasic info:\u003c/strong\u003e\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eUbuntu: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e20.04\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eDocker: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e19.03.13\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eClang: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e10.0.0-4ubuntu1\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003etc (iproute2): \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc utility, iproute2-ss200127\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003earping\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003eapt \u003cspan class=\"nb\"\u003einstall\u003c/span\u003e \u003cspan class=\"nt\"\u003e-y\u003c/span\u003e arping\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ensenter-ctn\u003c/code\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eThis is a a wrapper around \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ensenter\u003c/code\u003e, which\n\u003cstrong\u003e\u003cmark\u003eexecutes commands in the specified container\u0026#39;s namespace\u0026lt;/code\u0026gt;\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# Example: nsenter-ctn \u0026lt;ctn-id\u0026gt; -n ip addr show eth0\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunction \u003c/span\u003ensenter-ctn \u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eCTN\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e \u003cspan class=\"c\"\u003e# Container ID or name\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003ePID\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003edocker inspect \u003cspan class=\"nt\"\u003e--format\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;{{.State.Pid}}\u0026#34;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$CTN\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eshift \u003c/span\u003e1 \u003cspan class=\"c\"\u003e# Remove the first arguement, shift remaining ones to the left\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003esudo \u003c/span\u003ensenter \u003cspan class=\"nt\"\u003e-t\u003c/span\u003e \u003cspan class=\"nv\"\u003e$PID\u003c/span\u003e \u003cspan class=\"nv\"\u003e$@\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ePut it into your \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e~/.bashrc\u003c/code\u003e then\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esource\u003c/span\u003e ~/.bashrc\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"13-playground-setup\"\u003e1.3 Playground setup\u003c/h2\u003e\n\n\u003cp\u003eFor ease of exercising, we’ll \u003cstrong\u003e\u003cmark\u003esetup a containerized environment\u003c/mark\u003e\u003c/strong\u003e.\nCreating two containers, \u003cstrong\u003e\u003cmark\u003eone used as client and the other as server\u003c/mark\u003e\u003c/strong\u003e,\ntopology shown as below:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/playground.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 2. Playground used in this post\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eWith default configurations, each container will get an IP address from docker,\nand be connected to the default Linux bridge \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edocker0\u003c/code\u003e.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eCommands:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# Create client container\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003edocker run \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e ctn1 \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e alpine:3.12.0 \u003cspan class=\"nb\"\u003esleep \u003c/span\u003e30d\n\n\u003cspan class=\"c\"\u003e# Create server container: listen at 0.0.0.0:80 inside the container, serving HTTP\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003edocker run \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e ctn2 \u003cspan class=\"nt\"\u003e-d\u003c/span\u003e alpine:3.12.0 \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  sh \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;while true; do echo -e \u0026#34;HTTP/1.0 200 OK\\r\\n\\r\\nWelcome\u0026#34; | nc -l -p 80; done\u0026#39;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eCheck the ip addresses of the containers\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# nsenter-ctn \u0026lt;container ID/Name\u0026gt; -n \u0026lt;command\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# -n: enter the network namespace of the container\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e ip a\n68: eth0@if69: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default\n    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e ip a\n70: eth0@if71: \u0026lt;BROADCAST,MULTICAST,UP,LOWER_UP\u0026gt; mtu 1500 qdisc noqueue state UP group default\n    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"14-connectivity-test\"\u003e1.4 Connectivity test\u003c/h2\u003e\n\n\u003cp\u003eNow verify that client can reach the server, with\n\u003cstrong\u003e\u003cmark\u003econnectivity test tools working at different network layers\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/connectivity-test.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 3. Connectivity test\u003c/p\u003e\n\n\u003ch3 id=\"l2-test-with-arping-arp\"\u003eL2 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003earping\u003c/code\u003e (ARP)\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003earping\u003c/code\u003e server IP from client:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e arping 172.17.0.3\nUnicast reply from 172.17.0.3 \u003cspan class=\"o\"\u003e[\u003c/span\u003e02:42:ac:11:00:03] 0.009ms\nUnicast reply from 172.17.0.3 \u003cspan class=\"o\"\u003e[\u003c/span\u003e02:42:ac:11:00:03] 0.015ms\n^CSent 2 probe\u003cspan class=\"o\"\u003e(\u003c/span\u003es\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e1 broadcast\u003cspan class=\"o\"\u003e(\u003c/span\u003es\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eL2 connectivity OK\u003c/mark\u003e\u003c/strong\u003e!\u003c/p\u003e\n\n\u003cp\u003eAnd we can also \u003cstrong\u003e\u003cmark\u003ecapture the traffic\u003c/mark\u003e\u003c/strong\u003e inside \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn2\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0 arp\n15:23:52.634753 ARP, Request who-has 172.17.0.3 \u003cspan class=\"o\"\u003e(\u003c/span\u003eBroadcast\u003cspan class=\"o\"\u003e)\u003c/span\u003e tell 172.17.0.2, length 28\n15:23:52.634768 ARP, Reply 172.17.0.3 is-at 02:42:ac:11:00:03 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e, length 28\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"l3-test-with-ping-icmp\"\u003eL3 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eping\u003c/code\u003e (ICMP)\u003c/h3\u003e\n\n\u003cp\u003eSimilar as the L2 test, but with the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eping\u003c/code\u003e command:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e ping 172.17.0.3 \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e 2\n64 bytes from 172.17.0.3: \u003cspan class=\"nv\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.064 ms\n64 bytes from 172.17.0.3: \u003cspan class=\"nv\"\u003eicmp_seq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e2 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.075 ms\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eL3 connectivity OK\u003c/mark\u003e\u003c/strong\u003e!\u003c/p\u003e\n\n\u003ch3 id=\"l4l7-test-with-curl-tcphttp\"\u003eL4/L7 test with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e (TCP/HTTP)\u003c/h3\u003e\n\n\u003cp\u003eFire a HTTP \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGET\u003c/code\u003e request with the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e command:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e curl 172.17.0.3:80\nWelcome\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eL4/L7 connectivity OK\u003c/mark\u003e\u003c/strong\u003e!\u003c/p\u003e\n\n\u003cp\u003eThe captured traffic inside \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn2\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tcpdump \u003cspan class=\"nt\"\u003e-nn\u003c/span\u003e \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0\n15:44:10.192949 IP 172.17.0.2.52748 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80:    Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eS], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e294912250\n15:44:10.192973 IP 172.17.0.3.80    \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.2.52748: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eS.], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e375518890, ack 294912251\n15:44:10.192987 IP 172.17.0.2.52748 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80:    Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003e.], ack 1, win 502\n15:44:10.193029 IP 172.17.0.2.52748 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80:    Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eP.], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e1:75, ack 1:  HTTP: GET / HTTP/1.1\n15:44:10.193032 IP 172.17.0.3.80    \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.2.52748: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003e.], ack 75, win 509\n15:44:10.193062 IP 172.17.0.3.80    \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.2.52748: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eP.], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e1:28, ack 75: HTTP: HTTP/1.0 200 OK\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"2-drop-specific-traffic-with-bpf-coding--testing\"\u003e2 Drop specific traffic with BPF: coding \u0026amp; testing\u003c/h1\u003e\n\n\u003cp\u003eNow let’s write some simple BPF programs.\u003c/p\u003e\n\n\u003ch2 id=\"21-l2-example-drop-all-arp-packets\"\u003e2.1 L2 example: drop all \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eARP\u003c/code\u003e packets\u003c/h2\u003e\n\n\u003ch3 id=\"source-code-drop-arpc\"\u003eSource code: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-arp.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eAs the following snippet shows, this example turns out to be\n\u003cstrong\u003e\u003cmark\u003eextreamly simple\u003c/mark\u003e\u003c/strong\u003e, consisting of only 10+ lines of C code:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/bpf.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/pkt_cls.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/if_ether.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;arpa/inet.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__attribute__\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;ingress\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eused\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003edrop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__sk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eETH_HLEN\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// Not our packet, return it back to kernel\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eethhdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eh_proto\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eETH_P_ARP\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n       \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_SHOT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eSome explanations:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eSpecify a section name\u003c/mark\u003e\u003c/strong\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esection(\u0026#34;ingress\u0026#34;)\u003c/code\u003e) for the\nprogram, which will be used in later’s loading process;\u003c/li\u003e\n  \u003cli\u003eFor each packet (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eskb\u003c/code\u003e), \u003cstrong\u003e\u003cmark\u003elocate the memory address\u003c/mark\u003e\u003c/strong\u003e that\nholds \u003cstrong\u003e\u003cmark\u003ethe starting address of the ethernet header\u003c/mark\u003e\u003c/strong\u003e;\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eRetrieve the next-proto-info\u003c/mark\u003e\u003c/strong\u003e in ether header,\n    \u003cul\u003e\n      \u003cli\u003eif \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eh_proto == ARP\u003c/code\u003e, return a flag (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTC_ACT_SHOT\u003c/code\u003e) dictating the kernel to drop this packet,\u003c/li\u003e\n      \u003cli\u003eotherwise, return a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTC_ACT_OK\u003c/code\u003e flag indicating the kernel to continue its subsequent processing.\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThe above code will \u003cstrong\u003e\u003cmark\u003eact as a \u0026#34;filter\u0026#34; to filter the given traffic/packets\u003c/mark\u003e\u003c/strong\u003e,\nlet’s see how to use it.\u003c/p\u003e\n\n\u003ch3 id=\"compile-load-and-attach-to-kernel-hooking-point\"\u003eCompile, load, and attach to kernel hooking point\u003c/h3\u003e\n\n\u003cp\u003eThe following commands compile the C code into BPF code, then load it into\nthe ingress hook of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn2\u003c/code\u003e’s eth0 interface:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# Compile to BPF code\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003eclang \u003cspan class=\"nt\"\u003e-O2\u003c/span\u003e \u003cspan class=\"nt\"\u003e-Wall\u003c/span\u003e \u003cspan class=\"nt\"\u003e-target\u003c/span\u003e bpf \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e drop-arp.c \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e drop-arp.o\n\n\u003cspan class=\"c\"\u003e# Add a tc classifier\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tc qdisc add dev eth0 clsact\n\n\u003cspan class=\"c\"\u003e# Load and attach program (read program from drop-arp.o\u0026#39;s \u0026#34;ingress\u0026#34; section) to eth0\u0026#39;s ingress hook\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tc filter add dev eth0 ingress bpf da obj drop-arp.o sec ingress\n\n\u003cspan class=\"c\"\u003e# Check the filter we\u0026#39;ve added just now\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tc filter show dev eth0 ingress\nfilter protocol all pref 49152 bpf chain 0\nfilter protocol all pref 49152 bpf chain 0 handle 0x1 drop-arp.o:[ingress] direct-action not_in_hw \u003cspan class=\"nb\"\u003eid \u003c/span\u003e231 tag c7401029d3d4561c jited\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eEffectively, this will filter all the inbound/ingress traffic to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn2\u003c/code\u003e.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eRefer to other posts in this site about how tc classifier (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclsact\u003c/code\u003e) works.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch3 id=\"test\"\u003eTest\u003c/h3\u003e\n\n\u003cp\u003eNow repeat our L2 connectivity test:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003ectn1\u003cspan class=\"o\"\u003e)\u003c/span\u003e / \u003cspan class=\"c\"\u003e# arping 172.17.0.3\u003c/span\u003e\nARPING 172.17.0.3 from 172.17.0.2 eth0\n^CSent 4 probe\u003cspan class=\"o\"\u003e(\u003c/span\u003es\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e4 broadcast\u003cspan class=\"o\"\u003e(\u003c/span\u003es\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eIt becomes unreachable!\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003eThe captured traffic inside \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn2\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0 arp\n16:02:03.085028 ARP, Request who-has 172.17.0.3 \u003cspan class=\"o\"\u003e(\u003c/span\u003eBroadcast\u003cspan class=\"o\"\u003e)\u003c/span\u003e tell 172.17.0.2, length 28\n16:02:04.105954 ARP, Request who-has 172.17.0.3 \u003cspan class=\"o\"\u003e(\u003c/span\u003eBroadcast\u003cspan class=\"o\"\u003e)\u003c/span\u003e tell 172.17.0.2, length 28\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eBut \u003cstrong\u003e\u003cmark\u003eping (ICMP) and curl (HTTP/TCP) still OK\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e/ \u003cspan class=\"c\"\u003e# ping 172.17.0.3\u003c/span\u003e\nPING 172.17.0.3 \u003cspan class=\"o\"\u003e(\u003c/span\u003e172.17.0.3\u003cspan class=\"o\"\u003e)\u003c/span\u003e: 56 data bytes\n64 bytes from 172.17.0.3: \u003cspan class=\"nb\"\u003eseq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.068 ms\n64 bytes from 172.17.0.3: \u003cspan class=\"nb\"\u003eseq\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e1 \u003cspan class=\"nv\"\u003ettl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e64 \u003cspan class=\"nb\"\u003etime\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e0.070 ms\n^C\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eNote: ARP entry to ctn2 should exist before this testing (not be GC-ed),\notherwise ping and curl will also fail, as L3-L7 communications also rely on\nthe MAC address in the ARP entry.\u003c/p\u003e\n\n  \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e arp \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e\nAddress                  HWtype  HWaddress           Flags Mask            Iface\n172.17.0.3               ether   02:42:ac:11:00:03   C                     eth0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e  \u003c/div\u003e\n\u003c/blockquote\u003e\n\n\u003ch3 id=\"explanation\"\u003eExplanation\u003c/h3\u003e\n\n\u003cp\u003eWith the above code and with our testing, we’ve got a simple firewall\nto drop all ARP packets for ctn2’s ingress traffic. This is realized by loading\nour BPF program to the ingress hook of the network interface:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/drop-arp.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 4. L2 example: drop all ARP traffic\u003c/p\u003e\n\n\u003ch3 id=\"cleanup\"\u003eCleanup\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tc qdisc del dev eth0 clsact 2\u0026gt;\u0026amp;1 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e/dev/null\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tc filter show dev eth0 ingress\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"22-l3-example-drop-all-icmp-packets\"\u003e2.2 L3 example: drop all \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eICMP\u003c/code\u003e packets\u003c/h2\u003e\n\n\u003ch3 id=\"source-code-drop-icmpc\"\u003eSource code: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-icmp.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eThis example is quite similar with the previous one, except that we need to\nparse to IP header:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/bpf.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/pkt_cls.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/if_ether.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/ip.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/tcp.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;arpa/inet.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n\u003cspan class=\"n\"\u003e__attribute__\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esection\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;ingress\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eused\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003edrop\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__sk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003el3_off\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eETH_HLEN\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                      \u003cspan class=\"c1\"\u003e// IP header offset\u003c/span\u003e\n    \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003el4_off\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003el3_off\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiphdr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// L4 header offset\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata_end\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003el4_off\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eethhdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eh_proto\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ehtons\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eETH_P_IP\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n       \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiphdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiphdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003el3_off\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eip\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eprotocol\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003eIPPROTO_ICMP\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_SHOT\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"compile-load-and-attach-to-kernel-hooking-point-1\"\u003eCompile, load, and attach to kernel hooking point\u003c/h3\u003e\n\n\u003cp\u003eCompile and load the program with the same commands in the previous example.\u003c/p\u003e\n\n\u003ch3 id=\"test-1\"\u003eTest\u003c/h3\u003e\n\n\u003cp\u003eTest with the same commands as in the previous section.\u003c/p\u003e\n\n\u003ch3 id=\"explanation-1\"\u003eExplanation\u003c/h3\u003e\n\n\u003cp\u003eThe effect looks like below:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/drop-icmp.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 5. L3 example: drop all ICMP traffic\u003c/p\u003e\n\n\u003ch2 id=\"23-l4-example-drop-tcp80-packets-only\"\u003e2.3 L4 example: drop \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTCP/80\u003c/code\u003e packets only\u003c/h2\u003e\n\n\u003ch3 id=\"code-drop-tcpc\"\u003eCode: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edrop-tcp.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eAgain, this example is quite similar with the previous ones, except that we\nneed to parse to TCP header to get the destination port information.\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e#include \u0026lt;linux/bpf.h\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#include \u0026lt;linux/pkt_cls.h\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#include \u0026lt;linux/if_ether.h\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#include \u0026lt;linux/ip.h\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#include \u0026lt;linux/tcp.h\u0026gt;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#include \u0026lt;arpa/inet.h\u0026gt;\u003c/span\u003e\n\n__attribute__\u003cspan class=\"o\"\u003e((\u003c/span\u003esection\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ingress\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e, used\u003cspan class=\"o\"\u003e))\u003c/span\u003e\nint drop\u003cspan class=\"o\"\u003e(\u003c/span\u003estruct __sk_buff \u003cspan class=\"k\"\u003e*\u003c/span\u003eskb\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    const int l3_off \u003cspan class=\"o\"\u003e=\u003c/span\u003e ETH_HLEN\u003cspan class=\"p\"\u003e;\u003c/span\u003e                       // IP header offset\n    const int l4_off \u003cspan class=\"o\"\u003e=\u003c/span\u003e l3_off + sizeof\u003cspan class=\"o\"\u003e(\u003c/span\u003estruct iphdr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  // TCP header offset\n    const int l7_off \u003cspan class=\"o\"\u003e=\u003c/span\u003e l4_off + sizeof\u003cspan class=\"o\"\u003e(\u003c/span\u003estruct tcphdr\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e // L7 \u003cspan class=\"o\"\u003e(\u003c/span\u003ee.g. HTTP\u003cspan class=\"o\"\u003e)\u003c/span\u003e header offset\n\n    void \u003cspan class=\"k\"\u003e*\u003c/span\u003edata \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003evoid\u003cspan class=\"k\"\u003e*\u003c/span\u003e\u003cspan class=\"o\"\u003e)(\u003c/span\u003elong\u003cspan class=\"o\"\u003e)\u003c/span\u003eskb-\u0026gt;data\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    void \u003cspan class=\"k\"\u003e*\u003c/span\u003edata_end \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003evoid\u003cspan class=\"k\"\u003e*\u003c/span\u003e\u003cspan class=\"o\"\u003e)(\u003c/span\u003elong\u003cspan class=\"o\"\u003e)\u003c/span\u003eskb-\u0026gt;data_end\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003edata_end \u0026lt; data + l7_off\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn \u003c/span\u003eTC_ACT_OK\u003cspan class=\"p\"\u003e;\u003c/span\u003e // Not our packet, handover to kernel\n\n    struct ethhdr \u003cspan class=\"k\"\u003e*\u003c/span\u003eeth \u003cspan class=\"o\"\u003e=\u003c/span\u003e data\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eeth-\u0026gt;h_proto \u003cspan class=\"o\"\u003e!=\u003c/span\u003e htons\u003cspan class=\"o\"\u003e(\u003c/span\u003eETH_P_IP\u003cspan class=\"o\"\u003e))\u003c/span\u003e\n       \u003cspan class=\"k\"\u003ereturn \u003c/span\u003eTC_ACT_OK\u003cspan class=\"p\"\u003e;\u003c/span\u003e // Not an IPv4 packet, handover to kernel\n\n    struct iphdr \u003cspan class=\"k\"\u003e*\u003c/span\u003eip \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003estruct iphdr \u003cspan class=\"k\"\u003e*\u003c/span\u003e\u003cspan class=\"o\"\u003e)(\u003c/span\u003edata + l3_off\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003eip-\u0026gt;protocol \u003cspan class=\"o\"\u003e!=\u003c/span\u003e IPPROTO_TCP\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn \u003c/span\u003eTC_ACT_OK\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    struct tcphdr \u003cspan class=\"k\"\u003e*\u003c/span\u003etcp \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003estruct tcphdr \u003cspan class=\"k\"\u003e*\u003c/span\u003e\u003cspan class=\"o\"\u003e)(\u003c/span\u003edata + l4_off\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003entohs\u003cspan class=\"o\"\u003e(\u003c/span\u003etcp-\u0026gt;dest\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e 80\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn \u003c/span\u003eTC_ACT_OK\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn \u003c/span\u003eTC_ACT_SHOT\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"test-tcp80-traffic-being-dropped\"\u003eTest: TCP/80 traffic being dropped\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e from client container, we’ll find that it hangs there:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn1 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e curl 172.17.0.3:80\n^C\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eCheck the traffic inside ctn2:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ensenter-ctn ctn2 \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e tcpdump \u003cspan class=\"nt\"\u003e-nn\u003c/span\u003e \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0\n16:23:48.077262 IP 172.17.0.2.52780 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eS], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e2820055365, win 64240, options \u003cspan class=\"o\"\u003e[\u003c/span\u003emss 1460,sackOK,TS val 3662821781 ecr 0,nop,wscale 7], length 0\n16:23:49.101081 IP 172.17.0.2.52780 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eS], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e2820055365, win 64240, options \u003cspan class=\"o\"\u003e[\u003c/span\u003emss 1460,sackOK,TS val 3662822805 ecr 0,nop,wscale 7], length 0\n16:23:51.143643 IP 172.17.0.2.52780 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e 172.17.0.3.80: Flags \u003cspan class=\"o\"\u003e[\u003c/span\u003eS], \u003cspan class=\"nb\"\u003eseq \u003c/span\u003e2820055365, win 64240, options \u003cspan class=\"o\"\u003e[\u003c/span\u003emss 1460,sackOK,TS val 3662824847 ecr 0,nop,wscale 7], length 0\n^C\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAs shown above, the TCP packets got dropped: client retransmitted many times,\nuntil timed out.\u003c/p\u003e\n\n\u003ch3 id=\"test-tcp8080-traffic-not-dropped\"\u003eTest: TCP/8080 traffic not dropped\u003c/h3\u003e\n\n\u003cp\u003eNow let’s \u003cstrong\u003e\u003cmark\u003estart another HTTP server inside ctn2\u003c/mark\u003e\u003c/strong\u003e, to verify\nthat HTTP traffic at other TCP ports is still ok.\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# Start another server, listen at :8080\u003c/span\u003e\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003edocker \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e ctn2 sh\n/ \u003cspan class=\"c\"\u003e# while true; do echo -e \u0026#34;HTTP/1.0 200 OK\\r\\n\\r\\nWelcome\u0026#34; | nc -l -p 8080; done\u003c/span\u003e\nGET / HTTP/1.1\nHost: 172.17.0.3:8080\nUser-Agent: curl/7.68.0\nAccept: \u003cspan class=\"k\"\u003e*\u003c/span\u003e/\u003cspan class=\"k\"\u003e*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow curl the new service from client:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e(node) $ nsenter-ctn ctn1 -n curl 172.17.0.3:8080\nWelcome\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eSuccessful!\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch3 id=\"explanation-2\"\u003eExplanation\u003c/h3\u003e\n\n\u003cp\u003eThe effect:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/firewalling-with-bpf-xdp/drop-tcp-80.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 6. L4/L7 example: drop all TCP/80 traffic\u003c/p\u003e\n\n\u003ch2 id=\"24-tear-down-playground\"\u003e2.4 Tear down playground\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nb\"\u003esudo \u003c/span\u003edocker \u003cspan class=\"nb\"\u003erm\u003c/span\u003e \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e ctn1 ctn2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"25-summary\"\u003e2.5 Summary\u003c/h2\u003e\n\n\u003cp\u003eIn the above, we showed three toy examples to drop specific traffic.\nThese programs are not that useful til now, but, by combining the following filtering\nand hooking stuffs, they could evolve to a real firewalling program.\u003c/p\u003e\n\n\u003ch3 id=\"filtering-more-fields\"\u003eFiltering more fields\u003c/h3\u003e\n\n\u003cp\u003eFor real firewalling purposes, we should perform the filtering with more conditions, such as:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eSource and/or destination MAC addresses\u003c/li\u003e\n  \u003cli\u003eSource and/or destination IP addresses\u003c/li\u003e\n  \u003cli\u003eSource and/or destination TCP ports\u003c/li\u003e\n  \u003cli\u003eOr even L7 conditions, such as method (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGET/POST/DELETE\u003c/code\u003e), routes (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/api/public\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/api/private\u003c/code\u003e)\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eAll these information are accessible\u003c/mark\u003e\u003c/strong\u003e (from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eskb\u003c/code\u003e) in BPF programs’s context.\u003c/p\u003e\n\n\u003ch3 id=\"hooking-at-more-places\"\u003eHooking at more places\u003c/h3\u003e\n\n\u003cp\u003eWe could attach BPF programs at other hooking points, not just the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eingress\u003c/code\u003e one.\u003c/p\u003e\n\n\u003cp\u003eBeside, we could also attach programs at other network devices, for example,\nat the corresponding \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evethxx\u003c/code\u003e devices of ctn2, which will achieve the exactly\nsame effects. Actually this is how Cilium does in it’s default datapath mode\n(veth pair mode) [1].\u003c/p\u003e\n\n\u003ch3 id=\"making-filtering-conditions-configurable\"\u003eMaking filtering conditions configurable\u003c/h3\u003e\n\n\u003cp\u003eThis can be achieved with BPF maps, but that’s out of the scope of this post.\u003c/p\u003e\n\n\u003ch1 id=\"3-how-does-it-work-in-the-underlying-dig-inside\"\u003e3 How does it work in the underlying? Dig inside\u003c/h1\u003e\n\n\u003cp\u003ePrevious sections demonstrate that our BPF code works. But \u003cstrong\u003e\u003cmark\u003ehow does that\nwork in the underlying?\u003c/mark\u003e\u003c/strong\u003e This section digs into the hidden part, specifically, we’ll see:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eHow does the BPF code get injected\u003c/mark\u003e\u003c/strong\u003e into the kernel hooking point, and\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eWhere exactly does the BPF code get triggered\u003c/mark\u003e\u003c/strong\u003e for execution.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"31-loading-bpf-into-kernel-part-1-tc-front-end-processing\"\u003e3.1 Loading BPF into kernel part 1: tc front end processing\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eLoading BPF code into kernel\u003c/mark\u003e\u003c/strong\u003e further splits into two part:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eTC frontend (userspace): convert user commands into a netlink message and send it to kernel\u003c/li\u003e\n  \u003cli\u003eBPF backend (kernel space): process the netlink request, finish the loading/attaching job\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eThis section explores the first part.\u003c/p\u003e\n\n\u003ch3 id=\"source-code\"\u003eSource code\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc\u003c/code\u003e code is included in the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eiproute2\u003c/code\u003e package:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egit clone https://git.kernel.org/pub/scm/network/iproute2/iproute2.git\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd \u003c/span\u003eiproute2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"calling-stack\"\u003eCalling stack\u003c/h3\u003e\n\n\u003cp\u003eTake \u003cstrong\u003e\u003cmark\u003ethe following command as example\u003c/mark\u003e\u003c/strong\u003e,\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etc filter add dev eth0 ingress bpf da obj drop-arp.o sec ingress\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eBelow is the calling stack:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// Calling stack of parsing and executing the following tc command:\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e// $ tc filter add dev eth0 ingress bpf da obj drop-arp.o sec ingress\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003emain\u003c/span\u003e                                                  \u003cspan class=\"c1\"\u003e// tc/tc.c\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003edo_cmd\u003c/span\u003e                                            \u003cspan class=\"c1\"\u003e// tc/tc.c\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;filter\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                     \n          \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003edo_filter\u003c/span\u003e                            \u003cspan class=\"c1\"\u003e// tc/filter.c\u003c/span\u003e\n              \u003cspan class=\"o\"\u003e/\u003c/span\u003e                                       \n          \u003cspan class=\"o\"\u003e/--/\u003c/span\u003e                                        \n         \u003cspan class=\"o\"\u003e/\u003c/span\u003e                                            \n\u003cspan class=\"n\"\u003edo_filter\u003c/span\u003e                                             \u003cspan class=\"c1\"\u003e// tc/filter.c\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ematch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;add\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                            \n      \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003etc_filter_modify\u003c/span\u003e                         \u003cspan class=\"c1\"\u003e// tc/filter.c\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e/\u003c/span\u003e                                         \n        \u003cspan class=\"o\"\u003e/--/\u003c/span\u003e                                          \n       \u003cspan class=\"o\"\u003e/\u003c/span\u003e                                              \n\u003cspan class=\"n\"\u003etc_filter_modify\u003c/span\u003e                                      \u003cspan class=\"c1\"\u003e// tc/filter.c\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e   \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enlmsghdr\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     \u003cspan class=\"c1\"\u003e// netlink message header\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e   \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcmsg\u003c/span\u003e    \u003cspan class=\"n\"\u003et\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e     \u003cspan class=\"c1\"\u003e// tc message header\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e   \u003cspan class=\"kt\"\u003echar\u003c/span\u003e            \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e[];\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e   \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003enl\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emsg_type\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;add\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003eParse\u003c/span\u003e \u003cspan class=\"n\"\u003eCLI\u003c/span\u003e \u003cspan class=\"n\"\u003eparameters\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e    \u003cspan class=\"s\"\u003e\u0026#34;dev eth0 ingress\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eparse_fopt\u003c/span\u003e            \u003cspan class=\"s\"\u003e\u0026#34;bpf da obj drop-arp.o sec ingress\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003ebpf_parse_opt\u003c/span\u003e                                  \u003cspan class=\"c1\"\u003e// tc/f_bpf.c\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e     \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003ecfg\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_PROG_TYPE_SCHED_CLS\u003c/span\u003e          \u003cspan class=\"c1\"\u003e// tc/f_bpf.c\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003ertnl_talk\u003c/span\u003e                                         \u003cspan class=\"c1\"\u003e// lib/libnetlink.c\u003c/span\u003e\n     \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003e__rtnl_talk\u003c/span\u003e                                    \u003cspan class=\"c1\"\u003e// lib/libnetlink.c\u003c/span\u003e\n       \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003e__rtnl_talk_iov\u003c/span\u003e                              \u003cspan class=\"c1\"\u003e// lib/libnetlink.c\u003c/span\u003e\n         \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003esendmsg\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"explanations\"\u003eExplanations\u003c/h3\u003e\n\n\u003cp\u003eThe above frontend processing logic explains itself clearly:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003eParse CLI parameters from user inputs (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc\u003c/code\u003e commands)\u003c/p\u003e\n\n    \u003cp\u003eSet the program type to be \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_PROG_TYPE_SCHED_CLS\u003c/code\u003e.\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eInit a netlink message\u003c/mark\u003e\u003c/strong\u003e with those parameters\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eSend the netlink message to kernel\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eOn receiving the message, kernel will do the subsequent things for use - we’ll\nsee in the next section.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eNetlink is used to \u003cstrong\u003e\u003cmark\u003etransfer information between the kernel and user-space\u003c/mark\u003e\u003c/strong\u003e\nprocesses.  It consists of a standard sockets-based interface for user space\nprocesses and an internal kernel API for kernel modules.\u003c/p\u003e\n\n  \u003cp\u003e\u003cstrong\u003e\u003cmark\u003eNetlink is not a reliable protocol\u003c/mark\u003e\u003c/strong\u003e.  It tries its best to deliver a message\nto its destination(s), but may drop messages when an out-of-memory condition\nor other error occurs [3].\u003c/p\u003e\n\n  \u003cp\u003eSee \u003ca href=\"https://github.com/cilium/cilium/issues/14710\"\u003edatapath: Set timeout for default netlink socket\u003c/a\u003e\nfor an example on how netlink message loss leads to problems.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch2 id=\"32-loading-bpf-into-kernel-part-2-kernel-backend-processing\"\u003e3.2 Loading BPF into kernel part 2: kernel backend processing\u003c/h2\u003e\n\n\u003ch3 id=\"netlink-message-handlers-registration\"\u003eNetlink message handlers registration\u003c/h3\u003e\n\n\u003cp\u003eDuring kernel initialization, the net subsystem will register many callbacks,\nwhich will be called when certain events received, such as\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003etc qdiscs\u003c/mark\u003e\u003c/strong\u003e themselves\u003c/li\u003e\n  \u003cli\u003etc qdisc \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eadd/del/get\u003c/code\u003e event callbacks\u003c/li\u003e\n  \u003cli\u003etc filter \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eadd/del/get\u003c/code\u003e event callbacks\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eas shown below:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/sch_api.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e__init\u003c/span\u003e \u003cspan class=\"nf\"\u003epktsched_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_pernet_subsys\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epsched_net_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epfifo_fast_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epfifo_qdisc_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ebfifo_qdisc_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epfifo_head_drop_qdisc_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emq_qdisc_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregister_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enoqueue_qdisc_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// tc qdisc add/del/get callbacks\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_NEWQDISC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_modify_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_DELQDISC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_get_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_GETQDISC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_get_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_dump_qdisc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// tc filter add/del/get callbacks\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_NEWTCLASS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_ctl_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_DELTCLASS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_ctl_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ertnl_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_GETTCLASS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_ctl_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etc_dump_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"trigger-tc_ctl_tclass-on-receiving-tc-filter-add-messages\"\u003eTrigger \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc_ctl_tclass()\u003c/code\u003e on receiving “tc filter add” messages\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eOn receiving the \u0026#34;add filter\u0026#34; netlink message sent by tc\u003c/mark\u003e\u003c/strong\u003e, handler\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etc_ctl_tclass()\u003c/code\u003e will be called:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/sch_api.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003etc_ctl_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enlmsghdr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enetlink_ext_ack\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enlmsg_parse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etcm\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003etca\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTCA_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ertm_tca_policy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003e__dev_get_by_index\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etcm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etcm_ifindex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 1. Determine qdisc handle X:0\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eportid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etcm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etcm_parent\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etcm\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etcm_handle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eqid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_H_MAJ\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 2. Locate qdisc\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eqdisc_lookup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eqid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 3. Insert BPF code into hook\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enew_cl\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecl\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecops\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003echange\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eportid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etca\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003enew_cl\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// -\u0026gt; cls_bpf_change()\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003etclass_notify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003en\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enew_cl\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eRTM_NEWTCLASS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* We just create a new class, need to do reverse binding. */\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecl\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003enew_cl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etc_bind_tclass\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eq\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eportid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eclid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enew_cl\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003eout:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt parses tc parameters from netlink message, then \u003cstrong\u003e\u003cmark\u003ecall cops-\u0026gt;change()\nmethod to inject the specified BPF code into the correct hooking point\u003c/mark\u003e\u003c/strong\u003e.\nHere, the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003echange()\u003c/code\u003e method points to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecls_bpf_change()\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/cls_bpf.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ecls_bpf_change\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enet\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ein_skb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n              \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_proto\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n              \u003cspan class=\"n\"\u003eu32\u003c/span\u003e \u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enlattr\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003etca\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eovr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enetlink_ext_ack\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ertnl_dereference\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_prog\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enlattr\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etb\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eTCA_BPF_MAX\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_prog\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003enla_parse_nested\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTCA_BPF_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etca\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eTCA_OPTIONS\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_policy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eprog\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekzalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eGFP_KERNEL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etcf_exts_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTCA_BPF_ACT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTCA_BPF_POLICE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ehandle\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eidr_alloc_u32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle_idr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eINT_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGFP_KERNEL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eidr_alloc_u32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle_idr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eGFP_KERNEL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecls_bpf_set_parms\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enet\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebase\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etca\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003eTCA_RATE\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eovr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecls_bpf_offload\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eextack\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003etc_in_hw\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003egen_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003egen_flags\u003c/span\u003e \u003cspan class=\"o\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003eTCA_CLS_FLAGS_NOT_IN_HW\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eidr_replace\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehandle_idr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehandle\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elist_replace_rcu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elink\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elink\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etcf_unbind_filter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etcf_exts_get_net\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003etcf_queue_work\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eoldprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003erwork\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_delete_prog_work\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elist_add_rcu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elink\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eplist\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003eerrout:\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etcf_exts_destroy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekfree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eFor our case here, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecls_bpf_change()\u003c/code\u003e’s logic:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eAllocate memory for the BPF program\u003c/mark\u003e\u003c/strong\u003e,\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eAppend the program to the handler list\u003c/mark\u003e\u003c/strong\u003e at the corresponding hook with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elist_add_rcu()\u003c/code\u003e.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"33-kernel-datapath-inbound-handling-entrypoint-__netif_receive_skb_core\"\u003e3.3 Kernel datapath: inbound handling entrypoint \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e__netif_receive_skb_core()\u003c/code\u003e\u003c/h2\u003e\n\n\u003ch3 id=\"bpf-classifier-callbacks-registration\"\u003eBPF classifier callbacks registration\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclsact\u003c/code\u003e is a TC classifier, again, it registers its handlers during module init:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/cls_bpf.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_proto_ops\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_ops\u003c/span\u003e \u003cspan class=\"n\"\u003e__read_mostly\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekind\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"s\"\u003e\u0026#34;bpf\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eowner\u003c/span\u003e       \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003eTHIS_MODULE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclassify\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003einit\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_init\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edestroy\u003c/span\u003e     \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_destroy\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eget\u003c/span\u003e         \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_get\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echange\u003c/span\u003e      \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_change\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edelete\u003c/span\u003e      \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_delete\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ewalk\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_walk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereoffload\u003c/span\u003e   \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_reoffload\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edump\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_dump\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ebind_class\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003e    \u003cspan class=\"n\"\u003ecls_bpf_bind_class\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003e__init\u003c/span\u003e \u003cspan class=\"nf\"\u003ecls_bpf_init_mod\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eregister_tcf_proto_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecls_bpf_ops\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003emodule_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecls_bpf_init_mod\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"calling-into-tc-filtering-framework\"\u003eCalling into tc filtering framework\u003c/h3\u003e\n\n\u003cp\u003eWhen kernel processing an ingress packet, it will come to the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e__netif_receive_skb_core()\u003c/code\u003e\nmethod, then \u003cstrong\u003e\u003cmark\u003ethe call stack\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e__netif_receive_skb_core\n  |-sch_handle_ingress\n     |-tcf_classify\n        |-tp-\u0026gt;classify\n               |-cls_bpf_classify\n                  |-BPF_PROG_RUN\n                     |-// our bpf code\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThe method itself:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/dev/core.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e__netif_receive_skb_core\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003epfmemalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epacket_type\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003eppt_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003etrace_netif_receive_skb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb_skip_tc_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eskip_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elist_for_each_entry_rcu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eptype_all\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edeliver_skb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorig_dev\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elist_for_each_entry_rcu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eptype_all\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003edeliver_skb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorig_dev\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#ifdef CONFIG_NET_INGRESS\n\u003c/span\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estatic_branch_unlikely\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eingress_needed_key\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eskb\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esch_handle_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorig_dev\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enf_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eorig_dev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif\n\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eskb_reset_tc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003eskip_classify:\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\n\u003cspan class=\"nl\"\u003edrop:\u003c/span\u003e\n\u003cspan class=\"nl\"\u003eout:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kr\"\u003einline\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\n\u003cspan class=\"nf\"\u003esch_handle_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epacket_type\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003ept_prev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n           \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003enet_device\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eorig_dev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#ifdef CONFIG_NET_CLS_ACT\n\u003c/span\u003e    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003emini_Qdisc\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eminiq\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ercu_dereference_bh\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edev\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eminiq_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etc_at_ingress\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etcf_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eminiq\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efilter_list\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecl_res\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_RECLASSIFY\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003edefault:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#endif \u003c/span\u003e\u003cspan class=\"cm\"\u003e/* CONFIG_NET_CLS_ACT */\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/sch_api.c\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* Main classifier routine: scans classifier chain attached\n * to this qdisc, (optionally) tests for protocol and asks specific classifiers.  */\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003etcf_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_proto\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003ecompat_mode\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(;\u003c/span\u003e \u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003etp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ercu_dereference_bh\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eclassify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"cm\"\u003e/* signal: continue lookup */\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"executing-our-bpf-code\"\u003eExecuting our BPF code\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eFinally\u003c/mark\u003e\u003c/strong\u003e, for our case, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etp-\u0026gt;classify\u003c/code\u003e is initialized as \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecls_bpf_classify\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// net/sched/cls_bpf.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ecls_bpf_classify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003esk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_proto\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_result\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_head\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ercu_dereference_bh\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etp\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eroot\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebool\u003c/span\u003e \u003cspan class=\"n\"\u003eat_ingress\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eskb_at_tc_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_prog\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003elist_for_each_entry_rcu\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehead\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eplist\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elink\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eqdisc_skb_cb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etc_classid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclassid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etc_skip_sw\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003egen_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts_integrated\u003c/span\u003e \u003cspan class=\"o\"\u003e?\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_UNSPEC\u003c/span\u003e \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eat_ingress\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e__skb_push\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emac_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebpf_compute_data_pointers\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_PROG_RUN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efilter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003e__skb_pull\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emac_len\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ebpf_compute_data_pointers\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_PROG_RUN\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efilter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts_integrated\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eclass\u003c/span\u003e   \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eclassid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_H_MAJ\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclassid\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eqdisc_skb_cb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003etc_classid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecls_bpf_exec_opcode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eclass\u003c/span\u003e   \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eclassid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003efilter_res\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003etcf_exts_exec\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eexts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003econtinue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ewhere the method calls \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_PROG_RUN()\u003c/code\u003e to execute our BPF code.\u003c/p\u003e\n\n\u003cp\u003eSo finally, this ends our journey!\u003c/p\u003e\n\n\u003ch1 id=\"4-xdp-version\"\u003e4 XDP version\u003c/h1\u003e\n\n\u003ch2 id=\"41-intro\"\u003e4.1 Intro\u003c/h2\u003e\n\n\u003cp\u003eXDP happens before BPF hooking points, so it’s more efficient - even the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eskb\u003c/code\u003e\nhasn’t been allocated when XDP programs are triggered.\u003c/p\u003e\n\n\u003cp\u003eBorrow a picture from [4,5]:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/ebpf-datapath-in-cilium/dp-highlight-gxdp.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003eXDP needs hardware (NIC) support.\u003c/p\u003e\n\n\u003ch2 id=\"42-code-todo\"\u003e4.2 Code (TODO)\u003c/h2\u003e\n\n\u003ch1 id=\"5-conclusion\"\u003e5 Conclusion\u003c/h1\u003e\n\n\u003cp\u003eTODO: more elaborations on this section.\u003c/p\u003e\n\n\u003ch2 id=\"51-tcpdump-hooking-point\"\u003e5.1 tcpdump hooking point\u003c/h2\u003e\n\n\u003cp\u003etcpdump happens before tc-bpf hooking point, but after XDP hooking point.\nThat’s why we could capture the traffic in section 2, but would not if we’re running XDP ones.\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003exdpdump\u003c/code\u003e comes as a rescue in the latter case.\u003c/p\u003e\n\n\u003ch2 id=\"52-netfilter-framework\"\u003e5.2 Netfilter framework\u003c/h2\u003e\n\n\u003cp\u003eNetfilter is another hooking and filtering framework inside Linux kernel, and is widely used (e.g. with iptables frontend).\u003c/p\u003e\n\n\u003cp\u003eBPF hooking happens before netfilter, and is more efficient than the later.\nFor example, it is possible now to entirely bypass the netfilter framework in Cilium.\u003c/p\u003e\n\n\u003ch1 id=\"references\"\u003eReferences\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/blog/cilium-life-of-a-packet-pod-to-service/\"\u003eLife of a Packet in Cilium: Discovering the Pod-to-Service Traffic Path and BPF Processing Logics\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://blog.cloudflare.com/l4drop-xdp-ebpf-based-ddos-mitigations/\"\u003eL4Drop: XDP DDoS Mitigations\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://man7.org/linux/man-pages/man7/netlink.7.html\"\u003enetlink(7) — Linux manual page\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/understanding-ebpf-datapath-in-cilium-zh/\"\u003e(译) 深入理解 Cilium 的 eBPF 收发包路径（datapath）（KubeCon, 2019）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://kccncna19.sched.com/event/Uae7/understanding-and-troubleshooting-the-ebpf-datapath-in-cilium-nathan-sweet-digitalocean\"\u003eUnderstanding (and Troubleshooting) the eBPF Datapath in Cilium\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003eFacebook, \u003ca href=\"http://vger.kernel.org/lpc_net2018_talks/ebpf-firewall-LPC.pdf\"\u003eeBPF / XDP firewall and packet filtering\u003c/a\u003e, 2018\u003c/li\u003e\n\u003c/ol\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/cilium-handle-conntrack-related-bpf-maps-on-agent-restart/\"\u003e\u003cspan\u003e« Cilium: Handle Conntrack (CT) related BPF Maps on Agent Restart\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/bpf-advanced-notes-1-zh/\"\u003e\u003cspan\u003eBPF 进阶笔记（一）：BPF 程序（BPF Prog）类型详解：使用场景、函数签名、执行位置及程序示例 »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2021-06-27T00:00:00Z",
  "Author": "Arthur Chiao"
}