{
  "Source": "arthurchiao.art",
  "Title": "[译] Verizon 和一个 BGP Optimizer 如何导致了全球大面积断网（2019）",
  "Link": "https://arthurchiao.art/blog/how-verizon-and-a-bgp-optimizer-knocked-the-internet-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003e[译] Verizon 和一个 BGP Optimizer 如何导致了全球大面积断网（2019）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2020-03-21 | Last Update 2020-03-21\u003c/p\u003e\n  \n  \u003ch3 id=\"译者序\"\u003e译者序\u003c/h3\u003e\n\n\u003cp\u003e本文翻译自 2019 年的 Cloudflare 的一篇博客\n\u003ca href=\"https://blog.cloudflare.com/how-verizon-and-a-bgp-optimizer-knocked-large-parts-of-the-internet-offline-today/\"\u003eHow Verizon and a BGP Optimizer Knocked Large Parts of the Internet Offline\nToday\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e互联网是一个真正的全球分布式网络，来自不同网络提供商（ISP）的自治域（AS）基于\nBGP 交换路由，最终整张网络收敛到一致状态。ISP 负责向用户提供稳定的网络服务，\n但这需要所有 ISP 的密切配合，仅仅做好自家的工作是不够的，因为这个世界永远有猪队友。\u003c/p\u003e\n\n\u003cp\u003e此次故障的根源是一家小公司的 BGP Optimizer 错误地对外发布了的内部子路由，\nCloudflare 等公司是受害者；按照 Cloudflare 这篇博客的说法，如果各中间节点（ISP）\n配置得当，此类故障完全能够避免。\u003c/p\u003e\n\n\u003cp\u003e但作为重要的中间节点，\u003cstrong\u003eVerizon 的不作为和装死\u003c/strong\u003e（故障后 Cloudflare 立即联系了包\n括 Verizon 在内的几家 ISP 并较快地解决了问题，但 8 小时后 Verizon 仍然没有任何回复）\n\u003cstrong\u003e激怒了 Cloudflare\u003c/strong\u003e，因此他们写了这篇博客。除了技术复盘，他们还在文中毫不客气地说（ma）\nVerizon 的网工“马虎”、“懒惰”，这还不够解气，因此他们把 Verizon 的大名写在了文章的标题开头，\n让大家看看 Verizon 是什么样的一家公司（以及有一支怎样的网络团队）。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e以下是译文。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#译者序\" id=\"markdown-toc-译者序\"\u003e译者序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-发生了什么\" id=\"markdown-toc-1-发生了什么\"\u003e1. 发生了什么？\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-直接原因\" id=\"markdown-toc-11-直接原因\"\u003e1.1 直接原因\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-进一步解释\" id=\"markdown-toc-12-进一步解释\"\u003e1.2 进一步解释\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-故障复盘\" id=\"markdown-toc-13-故障复盘\"\u003e1.3 故障复盘\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-本应如何避免\" id=\"markdown-toc-2-本应如何避免\"\u003e2. 本应如何避免？\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-配置-bgp-session-接收路由上限\" id=\"markdown-toc-21-配置-bgp-session-接收路由上限\"\u003e2.1 配置 BGP session 接收路由上限\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-配置基于-irr-的过滤\" id=\"markdown-toc-22-配置基于-irr-的过滤\"\u003e2.2 配置基于 IRR 的过滤\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-部署-rpki\" id=\"markdown-toc-23-部署-rpki\"\u003e2.3 部署 RPKI\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-故障如何解决的\" id=\"markdown-toc-3-故障如何解决的\"\u003e3. 故障如何解决的？\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e大规模路由泄露（route leak）影响了包括 Cloudflare 在内的全球主干互联网基础设施。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch1 id=\"1-发生了什么\"\u003e1. 发生了什么？\u003c/h1\u003e\n\n\u003cp\u003e今天早上 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e10:30 UTC\u003c/code\u003e，互联网出现了一次短暂的心脏颤动。\u003cstrong\u003e很多经由 Verizon（AS701）的\n互联网路由，下一跳（preferred path）变成了位于 Northern Pennsylvania 的一个小公\n司，而 Verizon 是全球互联网的主要中间节点之一\u003c/strong\u003e。可以想象，这就像一条主干高速公\n路连到了一条小巷子 —— 瞬间导致托管在 Cloudflare 及其他提供商上的大量网站无法从全\n世界的大部分地方访问。\u003c/p\u003e\n\n\u003cp\u003e显然，这种事情永远不应该发生，因为 \u003cstrong\u003eVerizon 不应该将从这家小公司收的路由转发到\n互联网的其他部分\u003c/strong\u003e（the rest of the Internet）。\u003c/p\u003e\n\n\u003cp\u003e要理解为什么，接着往下看。\u003c/p\u003e\n\n\u003ch2 id=\"11-直接原因\"\u003e1.1 直接原因\u003c/h2\u003e\n\n\u003cp\u003e我们之前已经在博客上记录了此类\u003ca href=\"https://blog.cloudflare.com/bgp-leaks-and-crypto-currencies/\"\u003e不幸事件\u003c/a\u003e,\n因为它们并非个例（not uncommon）。但此次故障尤甚，影响范围是世界性的。\u003c/p\u003e\n\n\u003cp\u003e加剧此次故障的\u003cstrong\u003e直接原因\u003c/strong\u003e，是 Noction 公司的一种称为 ”BGP Optimizer“ 的产品。这\n个产品有一个特性：能够\u003cstrong\u003e将收到的 IP 前缀（IP prefixes）分割成几个更小的前缀\u003c/strong\u003e（称为\nmore-specifics）。例如：我们的 IPv4 路由 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e104.20.0.0/20\u003c/code\u003e 会被分割成两条路由：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e104.20.0.0/21\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e104.20.0.8/21\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e举个例子，原来通向宾夕法尼亚的路牌只有一个，上面写的是 “Pennsylvania”，而现在会\n被替换成两个：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e一个写的是 “Pittsburgh, PA”，通向匹兹堡\u003c/li\u003e\n  \u003cli\u003e一个写的是 “Philadelphia, PA”，通向费城\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这种将大 IP 段分割成多个小 IP 段的方式，\u003cstrong\u003e提供了一种在网络内部对流量进行控制\u003c/strong\u003e（\nsteer traffic within a network）的方式 —— 但是，\u003cstrong\u003e这些分割后的小段（路由）\n不应该大范围地通告给外部\u003c/strong\u003e（BGP 邻居）。假如通告了，就会发生今天这样的故障。\u003c/p\u003e\n\n\u003ch2 id=\"12-进一步解释\"\u003e1.2 进一步解释\u003c/h2\u003e\n\n\u003cp\u003e为了更深入地解释这次故障的原因，我们先来科普一下互联网（the Internet）是在背后是\n如何运行的。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\n    \u003cp\u003eInternet\u003c/p\u003e\n\n    \u003cp\u003e从字面上可以看出，”Internet“（直译”互联的网络“）表示\u003cstrong\u003e由多个网络（\n  network）互相连接（inter-）而形成的网络\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eASN\u003c/p\u003e\n\n    \u003cp\u003e事实上，这些独立的网络称为\u003cstrong\u003e自治系统\u003c/strong\u003e（Autonomous Systems，AS），每个 AS\n  都有自己唯一的标识符（编号），称为 AS number（ASN）。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eBGP\u003c/p\u003e\n\n    \u003cp\u003eAS 之间通过一种称为\u003cstrong\u003e边界网关协议\u003c/strong\u003e（Border Gateway Protocol (BGP）的协议来\n  交换路由信息，进而互联到一起。\u003cstrong\u003eBGP 描绘出了互联网背后的”地图“（map），这才\n  使得网络流量知道如何从一个地方到达另一个地方\u003c/strong\u003e，例如：从你的个人电脑到达地球\n  另一端的某个著名网站。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"13-故障复盘\"\u003e1.3 故障复盘\u003c/h2\u003e\n\n\u003cp\u003e网络之间通过 BGP 交换路由信息：如何从当前位置访问任意其他位置。这些路由可以是\n\u003cstrong\u003e具体到某个网络的路由\u003c/strong\u003e（specific routes），就像通过 GPS 精确定位某个城市；也可以\n是\u003cstrong\u003e宽泛的路由\u003c/strong\u003e（generic routes），就像在 GPS 上定位一个国家或省份。\u003c/p\u003e\n\n\u003cp\u003e而这也是\u003cstrong\u003e本次出故障的地方\u003c/strong\u003e。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003ePennsylvania 的一个 ISP 在它们的网络（\n\u003ca href=\"https://bgp.he.net/AS33154\"\u003eAS33154\u003c/a\u003e - DQE Communications）中使用了一个 BGP\n优化器，这意味着它们的网络中有很多 specific routes。\u003cstrong\u003especific routes 比\ngeneral routes 的优先级高\u003c/strong\u003e（就像导航的时候，白金汉宫比伦敦更精确，因此优先级\n更高）。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eDEQ 将这些 specifc routes 通告给了它们的客户（\n\u003ca href=\"https://bgp.he.net/AS396531\"\u003eAS396531\u003c/a\u003e - Allegheny Technologies Inc），后者\n进一步将这些路由通告给了它们的网络提供商 Verizon（\u003ca href=\"https://bgp.he.net/AS701\"\u003eAS701\u003c/a\u003e - Verizon），\n\u003cstrong\u003eVerizon 进一步将这些“更好的”路由通告给整个互联网\u003c/strong\u003e。说这些路由“更好”是因为，\n它们更加细粒度，更加具体（more granular, more specific）。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e这次路由泄露本该在 Verizon 这里终止的。由于违反了下面将列出的一些最佳实践，\n\u003cstrong\u003eVerizon 未采取任何过滤\u003c/strong\u003e，导致了重大的故障，影响了包括 Amazon、Linode 和\nCloudflare 在内的许多互联网服务。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e这意味着突然之间，Verizon、Allegheny 和 DQE 的大量用户都无法正常的访问网络服\n务，因为\u003cstrong\u003e这些小公司的网络根本没有足够的容量支撑如此规模的流量经过\u003c/strong\u003e。另一方\n面，即便这些公司有足够的容量，DQE, Allegheny 和 Verizon 也不能（not allowed）\n说它们有 \u003ca href=\"https://twitter.com/atoonk/status/1143143943531454464\"\u003e到达 Cloudflare、Amazon 和 Linode 的最佳路由\n\u003c/a\u003e（最佳路由和拓扑、代\n价等有关，见链接及下图，译者注）。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/how-a-bgp-optimizer-knocked-the-internet-zh/leak2-2.png\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eBGP 优化器导致的路由泄露过程\u003c/p\u003e\n\n\u003cp\u003e故障期间我们观察到了明显的流量下降，最糟糕的时候，我们的全球流量下降了 15%：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/how-a-bgp-optimizer-knocked-the-internet-zh/traffic-level.png\" width=\"75%\" height=\"75%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e故障期间 Cloudflare 的流量下降\u003c/p\u003e\n\n\u003ch1 id=\"2-本应如何避免\"\u003e2. 本应如何避免？\u003c/h1\u003e\n\n\u003cp\u003e本应有多重方式避免这次故障。\u003c/p\u003e\n\n\u003ch2 id=\"21-配置-bgp-session-接收路由上限\"\u003e2.1 配置 BGP session 接收路由上限\u003c/h2\u003e\n\n\u003cp\u003eBGP session 可以配置\u003cstrong\u003e接收的最大前缀长度\u003c/strong\u003e（prefix limit）。如果收到的路由前缀\n\u003cstrong\u003e超过了这个上限，路由器将关闭这个 session\u003c/strong\u003e。如果 Verizon 配置了这个选项，\n就不会出现这次故障了。\u003c/p\u003e\n\n\u003cp\u003e配置这个参数属于最佳实践之一，并且不会给 Verizon 这样的网络提供商代来任何\n坏处。\u003cstrong\u003e我们找不出他们不这样做的其他理由：只有粗心或者懒惰\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"22-配置基于-irr-的过滤\"\u003e2.2 配置基于 IRR 的过滤\u003c/h2\u003e\n\n\u003cp\u003e网络运营商能阻止此类泄露的另一种方式是实现基于 IRR 的过滤（implementing\nIRR-based filtering）。\u003c/p\u003e\n\n\u003cp\u003eIRR 表示 Internet Routing Registry，网络可以向这样的分布式数据库添加路由条目。网\n络运营商可以利用这些 IRR 记录来生成具体路由列表（specific prefix lists），用于和\n他们的对端（peer）建立 BGP session。\u003c/p\u003e\n\n\u003cp\u003e如果启用了 IRR 过滤，前面提到的这些网络也不会接受（accept）这些错误的具体路由（\nfaulty more-specifics）。\u003c/p\u003e\n\n\u003cp\u003e让我们感到震惊的是，\u003cstrong\u003eIRR 已经存在（并且有良好的文档）24 年了，但 Verizon 似乎并\n未在它与 Allegheny 的 BGP session 之间实现任何此类过滤\u003c/strong\u003e。IRR 不会给 Verizon 增加\n任何成本或给他们的服务带来任何限制。\u003cstrong\u003e我们只能再重复一遍说，他们没有这样做没有其他\n理由：只有粗心或者懒惰\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"23-部署-rpki\"\u003e2.3 部署 RPKI\u003c/h2\u003e\n\n\u003cp\u003e我们在去年\u003cstrong\u003e实现并在全球部署的 RPKI 框架就是用于防止此类泄露的\u003c/strong\u003e，它在\u003cstrong\u003e源网络（\norigin network）和前缀长度（prefix size）上施加过滤\u003c/strong\u003e。我们规定，Cloudflare 通告\n的前缀不会超过 20，因此任何长度超过 20 的前缀（可能是 more-specific 路由）都我们\n都拒绝接受，不管这些路由的路径（path）是什么。这个机制需要打开 BGP Origin\nValidation 开关才能生效。许多提供商，例如\n\u003ca href=\"https://twitter.com/jobsnijders/status/1094976832267522048\"\u003eAT\u0026amp;T 已经在它们的网络中配置了这个参数\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e如果 Verizon 使用了 RPKI，他们就会发现收到的这些路由是不合法的，因而\u003cstrong\u003e路由器就会\n自动将其丢弃\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eCloudflare 建议所有的网络运营商从现在开始都\u003ca href=\"https://blog.cloudflare.com/rpki-details/\"\u003e部署上 RPKI\u003c/a\u003e！\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/how-a-bgp-optimizer-knocked-the-internet-zh/leak3-2.png\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e使用 IRR、RPKI 和路由数量来防止路由泄露\u003c/p\u003e\n\n\u003cp\u003e以上所有建议已经完美地浓缩进了 MANRS（\u003ca href=\"https://www.manrs.org/\"\u003eMutually Agreed Norms for Routing Security\u003c/a\u003e）。\u003c/p\u003e\n\n\u003ch1 id=\"3-故障如何解决的\"\u003e3. 故障如何解决的？\u003c/h1\u003e\n\n\u003cp\u003eClouflare 的网络团队发现了有问题的网络 AS33154 (DQE Communications) 和 AS701\n(Verizon)。但我们无法立即解决这个问题，这可能是因为路由泄露刚发生的时候是在美\n国东海岸的早上。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/how-a-bgp-optimizer-knocked-the-internet-zh/mail-1.png\" width=\"75%\" height=\"75%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e发给 Verizon 的邮件截图\u003c/p\u003e\n\n\u003cp\u003e我们的一个网络工程师快速联系到 DQE 公司，对方也没有耽搁，很快将他们能解决这个故\n障的人告诉我们。我们双方通过电话合作，\u003cstrong\u003e停止将这些“优化的”路由通告给 Allegheny 公\n司\u003c/strong\u003e。我们在此向 DQE 表示感谢。\u003cstrong\u003e这些工作完成后，互联网就重新稳定了，一切回到正\n轨\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/how-a-bgp-optimizer-knocked-the-internet-zh/phonelog.png\" width=\"35%\" height=\"35%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e尝试与 DQE 和 Verizon 技术支持团队通话的截图\u003c/p\u003e\n\n\u003cp\u003e令人遗憾的是，我们尝试了通过邮件和电话的方式联系 Verizon，但直到写作本文时（故障\n发生之后 8 个小时），我们仍然没有收到对方的回复，我们也不确定他们是否在采取行动\n解决这个问题。\u003c/p\u003e\n\n\u003cp\u003e在 Cloudflare，我们希望此类事故永远不要发生，但不幸的是，\u003cstrong\u003e当前的互联网为防止此\n类事情的发生只做了很少的事情\u003c/strong\u003e。网络提供商行业是时候通过\u003cstrong\u003e采取 RPKI 这样的规范来\n更好地保护路由安全\u003c/strong\u003e了。我们希望大型提供商能够跟随 Cloudflare、Amazon 和 AT\u0026amp;T 这\n些公司的脚步，开始\u003ca href=\"https://blog.cloudflare.com/cloudflares-rpki-toolkit/\"\u003e对路由的合法性做验证\n\u003c/a\u003e。\u003cstrong\u003e尤其是你 —— Verizon\n—— 我们在注视着你，并且还在等你的回复\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e虽然此次事故的根源在我们的控制之外，但我们还是要因为网络的不可用向用户道歉。\n我们团队非常地关心我们的服务，团队成员也分布在美国、英国、澳大利亚和新加坡，\n任何故障发生之后，我们都能在几分钟之内发现。\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/do-i-really-need-a-vpc-zh/\"\u003e\u003cspan\u003e« [译] 云原生时代，是否还需要 VPC 做应用安全？（2020）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/bgp-leaks-and-crypto-currencies-zh/\"\u003e\u003cspan\u003e[译] BGP 泄露和加密货币（2018） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2020-03-21T00:00:00Z",
  "Author": "Arthur Chiao"
}