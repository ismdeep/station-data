{
  "Source": "arthurchiao.art",
  "Title": "[译] RFC 1180：朴素 TCP/IP 教程（1991）",
  "Link": "https://arthurchiao.art/blog/rfc1180-a-tcp-ip-tutorial-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003e[译] RFC 1180：朴素 TCP/IP 教程（1991）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2020-06-11 | Last Update 2020-06-11\u003c/p\u003e\n  \n  \u003ch3 id=\"译者序\"\u003e译者序\u003c/h3\u003e\n\n\u003cp\u003e本文翻译自 1991 年的一份 RFC（1180）: \u003ca href=\"https://tools.ietf.org/rfc/rfc1180.txt\"\u003eA TCP/IP Tutorial\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e本文虽距今将近 20 年，但内容并未过时，这不禁让人惊叹于 TCP/IP 协议栈生命力之强大\n。要理解 1991 年在技术发展中处于什么样一个位置，下面的时间线可作参考：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e1983：以太网协议第一版（IEEE 802.3）发布，速度 10 Mbps\u003c/li\u003e\n  \u003cli\u003e1990：万维网（WWW）诞生\u003c/li\u003e\n  \u003cli\u003e1991：\u003cstrong\u003e1 月，这份 RFC 发布\u003c/strong\u003e（本文）\u003c/li\u003e\n  \u003cli\u003e1991：8 月，芬兰的一个大学生宣布自己在开发一个玩具性质的内核，后来这个内核正式命名为 Linux\u003c/li\u003e\n  \u003cli\u003e1995：快速以太网（IEEE 802.3u）标准发布，速度 100 Mbps（前几年最普通、最常见的家用网线的带宽）\u003c/li\u003e\n  \u003cli\u003e1998：澳大利亚的一个软件工程师开始开发一个叫 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eiptables\u003c/code\u003e 的网络工具\u003c/li\u003e\n  \u003cli\u003e1999：千兆以太网（IEEE 802.3ab）标准发布，速度 1 Gbps（作为对比，现代数据中心\n的以太网都是\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e10/25/40\u003c/code\u003e Gbps 接入，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e100/400\u003c/code\u003e Gbps 互联）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e从今天的角度看，本文的一大特色是简洁易懂，深入问题本质，单凭这一点就已经远胜当前\n网上的绝大部分 TCP/IP 入门教程。当然，简洁易懂的一个原因是，当时的网络就是这么简\n单，没有今天各种精巧复杂的性能优化和眼花缭乱的虚拟化。但了解了网络的发展历史、理\n解了物理网络的基本原理之后，再来看今天各种网络虚拟化的东西就会轻松很多。基于这个\n原因，也推荐做底层的同学不要过于跟风新名词，有时间多读读（技术或更广义的）历史和\n经典，技术考古很有趣。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。\u003c/strong\u003e\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#译者序\" id=\"markdown-toc-译者序\"\u003e译者序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#本备忘录状态status-of-this-memo\" id=\"markdown-toc-本备忘录状态status-of-this-memo\"\u003e本备忘录状态（Status of this Memo）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-引言\" id=\"markdown-toc-1-引言\"\u003e1. 引言\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-tcpip-概览\" id=\"markdown-toc-2-tcpip-概览\"\u003e2. TCP/IP 概览\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-基本结构\" id=\"markdown-toc-21-基本结构\"\u003e2.1 基本结构\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-术语\" id=\"markdown-toc-22-术语\"\u003e2.2 术语\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-数据流flow-of-data\" id=\"markdown-toc-23-数据流flow-of-data\"\u003e2.3 数据流（Flow of Data）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-两个网络接口\" id=\"markdown-toc-24-两个网络接口\"\u003e2.4 两个网络接口\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-多个物理网络的-ip-空间组成单个逻辑网络\" id=\"markdown-toc-25-多个物理网络的-ip-空间组成单个逻辑网络\"\u003e2.5 多个物理网络的 IP 空间组成单个逻辑网络\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#26-物理网络的独立性\" id=\"markdown-toc-26-物理网络的独立性\"\u003e2.6 物理网络的独立性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#27-互操作性\" id=\"markdown-toc-27-互操作性\"\u003e2.7 互操作性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#28-小结\" id=\"markdown-toc-28-小结\"\u003e2.8 小结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-以太网ethernet\" id=\"markdown-toc-3-以太网ethernet\"\u003e3. 以太网（Ethernet）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-类比黑暗的屋子中多人交谈\" id=\"markdown-toc-31-类比黑暗的屋子中多人交谈\"\u003e3.1 类比：黑暗的屋子中多人交谈\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-arp地址解析协议\" id=\"markdown-toc-4-arp地址解析协议\"\u003e4. ARP（地址解析协议）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41--arp-表arp-table\" id=\"markdown-toc-41--arp-表arp-table\"\u003e4.1  ARP 表（ARP Table）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-典型-arp-转换场景\" id=\"markdown-toc-42-典型-arp-转换场景\"\u003e4.2 典型 ARP 转换场景\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43--arp-请求响应\" id=\"markdown-toc-43--arp-请求响应\"\u003e4.3  ARP 请求/响应\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-arp-场景续scenario-continued\" id=\"markdown-toc-44-arp-场景续scenario-continued\"\u003e4.4 ARP 场景续（Scenario Continued）\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5--互联网协议internet-protocol\" id=\"markdown-toc-5--互联网协议internet-protocol\"\u003e5.  互联网协议（Internet Protocol）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-直接路由direct-routing\" id=\"markdown-toc-51-直接路由direct-routing\"\u003e5.1 直接路由（Direct Routing）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-间接路由indirect-routing\" id=\"markdown-toc-52-间接路由indirect-routing\"\u003e5.2 间接路由（Indirect Routing）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#53-ip-模块的路由规则\" id=\"markdown-toc-53-ip-模块的路由规则\"\u003e5.3 IP 模块的路由规则\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#54-ip-地址\" id=\"markdown-toc-54-ip-地址\"\u003e5.4 IP 地址\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#55-名字主机名和网络名\" id=\"markdown-toc-55-名字主机名和网络名\"\u003e5.5 名字（主机名和网络名）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#56--ip-路由表\" id=\"markdown-toc-56--ip-路由表\"\u003e5.6  IP 路由表\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#57-直接路由的若干细节\" id=\"markdown-toc-57-直接路由的若干细节\"\u003e5.7 直接路由的若干细节\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#58-直接路由的场景\" id=\"markdown-toc-58-直接路由的场景\"\u003e5.8 直接路由的场景\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#59-间接路由的若干细节\" id=\"markdown-toc-59-间接路由的若干细节\"\u003e5.9 间接路由的若干细节\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#510-间接路由的场景\" id=\"markdown-toc-510-间接路由的场景\"\u003e5.10 间接路由的场景\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#511-路由部分总结\" id=\"markdown-toc-511-路由部分总结\"\u003e5.11 路由部分总结\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#512-管理路由\" id=\"markdown-toc-512-管理路由\"\u003e5.12 管理路由\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-udpuser-datagram-protocol\" id=\"markdown-toc-6-udpuser-datagram-protocol\"\u003e6. UDP（User Datagram Protocol）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-端口ports\" id=\"markdown-toc-61-端口ports\"\u003e6.1 端口（Ports）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#62-校验和checksum\" id=\"markdown-toc-62-校验和checksum\"\u003e6.2 校验和（Checksum）\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#7-tcptransmission-control-protocol\" id=\"markdown-toc-7-tcptransmission-control-protocol\"\u003e7. TCP（Transmission Control Protocol）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#8-网络应用\" id=\"markdown-toc-8-网络应用\"\u003e8. 网络应用\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#81-telnet\" id=\"markdown-toc-81-telnet\"\u003e8.1 TELNET\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#82-ftp\" id=\"markdown-toc-82-ftp\"\u003e8.2 FTP\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#83-rsh\" id=\"markdown-toc-83-rsh\"\u003e8.3 rsh\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#84-nfs\" id=\"markdown-toc-84-nfs\"\u003e8.4 NFS\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#85-snmp\" id=\"markdown-toc-85-snmp\"\u003e8.5 SNMP\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#86-x-window\" id=\"markdown-toc-86-x-window\"\u003e8.6 X-Window\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#9-其他信息\" id=\"markdown-toc-9-其他信息\"\u003e9. 其他信息\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#10-参考文献\" id=\"markdown-toc-10-参考文献\"\u003e10. 参考文献\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#11-与其他-rfc-的关系\" id=\"markdown-toc-11-与其他-rfc-的关系\"\u003e11. 与其他 RFC 的关系\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#12-安全方面的考虑\" id=\"markdown-toc-12-安全方面的考虑\"\u003e12. 安全方面的考虑\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#13-作者联系方式\" id=\"markdown-toc-13-作者联系方式\"\u003e13. 作者联系方式\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e以下是译文。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eNetwork Working Group                                      T. Socolofsky\nRequest for Comments:  1180                                      C. Kale\n                                                  Spider Systems Limited\n                                                            January 1991\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"本备忘录状态status-of-this-memo\"\u003e本备忘录状态（Status of this Memo）\u003c/h2\u003e\n\n\u003cp\u003e本 RFC 是一份 TCP/IP 协议族教程，重点介绍\u003cstrong\u003e通过路由器将 IP 数据报从源主机转\n发到目的主机的过程\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e本文并不是一份互连网标准（Internet standard）。\u003c/p\u003e\n\n\u003cp\u003e本文内容可以不受限制地传播。\u003c/p\u003e\n\n\u003ch1 id=\"1-引言\"\u003e1. 引言\u003c/h1\u003e\n\n\u003cp\u003eTCP/IP 功能非常全面，但本文将只关注其核心技术（”bare bones” of TCP/IP technology\n）之一。\u003c/p\u003e\n\n\u003cp\u003e本文不涉及 TCP/IP 的开发和资助历史、商业使用场景，以及与 ISO OSI 相比的发展前途\n。此外，我们还省略了大量的技术细节。\u003cstrong\u003e除此之外的内容，则是与 TCP/IP 打交道的专业\n人士至少要理解的\u003c/strong\u003e。这里所说的专业人士包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e系统管理员（systems administrator）\u003c/li\u003e\n  \u003cli\u003e系统程序员（systems programmer）\u003c/li\u003e\n  \u003cli\u003e网络管理员（network manager）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e本文的例子都源自 UNIX TCP/IP 环境，但其核心概念适用于所有版本的 TCP/IP 实现。\u003c/p\u003e\n\n\u003cp\u003e需要注意，\u003cstrong\u003e本备忘录的目的是解释（explanation），而非定义（definition）\u003c/strong\u003e。如果\n对某个协议的规范（specification of a protocol）存疑，请参考定义相应的 RFC 标准（\nactual standards defining RFC）。\u003c/p\u003e\n\n\u003ch1 id=\"2-tcpip-概览\"\u003e2. TCP/IP 概览\u003c/h1\u003e\n\n\u003cp\u003e“TCP/IP” 是一个非常宽泛的术语，通常指与 TCP/IP 协议相关的一切东西，其中包括，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e各种协议：例如 UDP、ARP 和 ICMP。\u003c/li\u003e\n  \u003cli\u003e各种应用：例如 TELNET, FTP, and rcp。\u003c/li\u003e\n  \u003cli\u003e甚至还包括网络媒介（network medium）。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e描述这些内容的一个\u003cstrong\u003e更准确术语是 “internet technology”\u003c/strong\u003e（因特网技术）。\u003cstrong\u003e使用\ninternet technology 的网络称为 “internet”\u003c/strong\u003e（因特网）。\u003c/p\u003e\n\n\u003ch2 id=\"21-基本结构\"\u003e2.1 基本结构\u003c/h2\u003e\n\n\u003cp\u003e要理解 TCP/IP 技术，必须先理解下面的逻辑结构：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                     ----------------------------\n                     |    network applications  |\n                     |                          |\n                     |...  \\ | /  ..  \\ | /  ...|\n                     |     -----      -----     |\n                     |     |TCP|      |UDP|     |\n                     |     -----      -----     |\n                     |         \\      /         |\n                     |         --------         |\n                     |         |  IP  |         |\n                     |  -----  -*------         |\n                     |  |ARP|   |               |\n                     |  -----   |               |\n                     |      \\   |               |\n                     |      ------              |\n                     |      |ENET|              |\n                     |      ---@--              |\n                     ----------|-----------------\n                               |\n         ----------------------o---------\n             Ethernet Cable\n\n                  Figure 1.  Basic TCP/IP Network Node\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这是 internet 上一台计算机内部\u003cstrong\u003e各协议层的逻辑图\u003c/strong\u003e（logical structure of the layered\nprotocols）。每一台能够通过 internet 技术进行通信的计算机都有这样的逻辑结构。\u003cstrong\u003e该逻\n辑结构也决定了 internet 上的计算机的行为\u003c/strong\u003e。关于这张图有几点说明：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e框（boxes）：表示数据经过计算机时，在这些地方处理数据\u003c/li\u003e\n  \u003cli\u003e框之间的连线（lines）：表示数据的流经路径\u003c/li\u003e\n  \u003cli\u003e最下面的横线：表示一根以太网网线（Ethernet cable）\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eo\u003c/code\u003e 符号：收发器（transceiver）\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e*\u003c/code\u003e 符号：IP 地址\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e@\u003c/code\u003e 符号：以太网地址\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e理解这张图是理解 internet 技术的基础\u003c/strong\u003e；本文将频繁引用此图。\u003c/p\u003e\n\n\u003ch2 id=\"22-术语\"\u003e2.2 术语\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e流经 internet 的数据单元（a unit of data）该叫什么，和它处于协议栈的什么位置有直\n接关系\u003c/strong\u003e。总的来说，如果：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e位于以太网上：称为\u003cstrong\u003e以太帧\u003c/strong\u003e（Ethernet frame）\u003c/li\u003e\n  \u003cli\u003e位于以太网驱动和 IP 模块之间：称为 \u003cstrong\u003eIP 包\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e位于 IP 模块和 UDP 模块之间：称为 \u003cstrong\u003eUDP 数据报\u003c/strong\u003e（UDP datagram）\u003c/li\u003e\n  \u003cli\u003e位于 IP 模块和 TCP 模块之间：称为 \u003cstrong\u003eTCP 段\u003c/strong\u003e（TCP segment），或者更宽泛地，称为一\n个传输层消息（transport message）\u003c/li\u003e\n  \u003cli\u003e位于一个网络应用（network application）中：称为\u003cstrong\u003e应用消息\u003c/strong\u003e（application message）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这些定义并非完美。实际中不同文档的定义都有一些差异。更准确的定义参见\nRFC 1122, section 1.3.3.\u003c/p\u003e\n\n\u003cp\u003e解释一下驱动和模块：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e驱动\u003c/strong\u003e（driver）是一种直接和网络接口硬件（network interface hardware）通信的软件。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e模块\u003c/strong\u003e（module）是和驱动、网络应用以及其他模块通信的软件。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e本文接下来将用到以下术语：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e驱动\u003c/li\u003e\n  \u003cli\u003e模块\u003c/li\u003e\n  \u003cli\u003e以太帧\u003c/li\u003e\n  \u003cli\u003eIP 包\u003c/li\u003e\n  \u003cli\u003eUDP 数据报\u003c/li\u003e\n  \u003cli\u003eTCP 消息\u003c/li\u003e\n  \u003cli\u003e应用消息\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"23-数据流flow-of-data\"\u003e2.3 数据流（Flow of Data）\u003c/h2\u003e\n\n\u003cp\u003e来看图 1 中流经协议栈的数据流。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e使用 TCP 的应用，数据在应用（application）和 TCP 模块之间传递。\u003c/li\u003e\n  \u003cli\u003e使用 UDP 的应用，数据在应用（application）和 UDP 模块之间传递。\u003c/li\u003e\n  \u003cli\u003eFTP（File Transfer Protocol）是一个典型的 TCP 应用，其协议栈是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFTP/TCP/IP/ENET\u003c/code\u003e。\u003c/li\u003e\n  \u003cli\u003eSNMP（Simple Network Management Protocol）是一个使用 UDP 的应用，其协议栈是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSNMP/UDP/IP/ENET\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e如图 2 所示，TCP 模块、UDP 模块和以太网驱动都是 \u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eN:1\u003c/code\u003e 多路复用器\u003c/strong\u003e（n-to-1\nmultiplexers），即，它们将多路输入变成单路输出。另外，它们也是 \u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1:N\u003c/code\u003e 解复用器\u003c/strong\u003e\n（1-to-n de-multiplexers），即，根据协议头中的类型（type）字段，将单路输入分解\n为多路输出。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e         1   2 3 ...   n                   1   2 3 ...   n\n          \\  |      /      |               \\  | |      /       ^\n           \\ | |   /       |                \\ | |     /        |\n         -------------   flow              ----------------   flow\n         |multiplexer|    of               |de-multiplexer|    of\n         -------------   data              ----------------   data\n              |            |                     |              |\n              |            v                     |              |\n              1                                  1\n\n        Figure 2.  n-to-1 multiplexer and 1-to-n de-multiplexer\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e解复用（de-multiplexing）流程：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e以太帧\u003c/strong\u003e从\u003cstrong\u003e网络\u003c/strong\u003e到达\u003cstrong\u003e以太网驱动\u003c/strong\u003e，然后将向上传递，要么给 ARP 模块，要么\n给 IP 模块。以太帧中的类型字段决定了该传给谁。\u003c/li\u003e\n  \u003cli\u003e如果 IP 包到达 IP 模块，接下来将向上传递，要么给 TCP 模块，要么给 UDP 模块，IP\n头中的协议类型字段决定了该传给谁。\u003c/li\u003e\n  \u003cli\u003e如果 UDP 数据报到达 UDP 模块，接下来将向上传递给网络应用（network application\n），\u003cstrong\u003eUDP 头中的端口号\u003c/strong\u003e决定了该传给哪个应用。\u003c/li\u003e\n  \u003cli\u003e同理，如果是 TCP 消息，将根据 TCP 头中的端口号决定传递给哪个网络应用。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e多路复用（multiplexing）流程：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e向下的多路复用（downwards multiplexing）流程比较简单，因为在每个位置只有一条向\n下的路；每个协议模块添加自己的头信息，这样包到达对端机器时就能被正确地解复用。\u003c/li\u003e\n  \u003cli\u003e从应用发出的包，不管是 TCP 还是 UDP，在 IP 层都会统一为 IP 包，然后再传给下面\n的网络接口驱动发送出去。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e虽然 internet 技术支持多种网络媒介，但以太网（Ethernet）是最常见的，因此本文所有例子\n都将使用以太网。图 1 中的计算机只有一个以太网连接。每个以太网接口都有一个 \u003cstrong\u003e6 字\n节的以太网地址\u003c/strong\u003e，位于以太网驱动的最低 6 字节，\u003cstrong\u003e该地址在以太网中是唯一的\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e此外，计算机还有一个 4 字节的 IP 地址，位于 IP 模块的最低 4 字节，该地址在 internet \n中唯一。\u003c/p\u003e\n\n\u003cp\u003e运行中的计算机永远知道自己的 IP 地址和以太网地址。\u003c/p\u003e\n\n\u003ch2 id=\"24-两个网络接口\"\u003e2.4 两个网络接口\u003c/h2\u003e\n\n\u003cp\u003e图 3 中，一台计算机同时连接到 2 个独立的以太网。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ----------------------------\n                |    network applications  |\n                |                          |\n                |...  \\ | /  ..  \\ | /  ...|\n                |     -----      -----     |\n                |     |TCP|      |UDP|     |\n                |     -----      -----     |\n                |         \\      /         |\n                |         --------         |\n                |         |  IP  |         |\n                |  -----  -*----*-  -----  |\n                |  |ARP|   |    |   |ARP|  |\n                |  -----   |    |   -----  |\n                |      \\   |    |   /      |\n                |      ------  ------      |\n                |      |ENET|  |ENET|      |\n                |      ---@--  ---@--      |\n                ----------|-------|---------\n                          |       |\n                          |    ---o---------------------------\n                          |             Ethernet Cable 2\n           ---------------o----------\n             Ethernet Cable 1\n\n             Figure 3.  TCP/IP Network Node on 2 Ethernets\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e注意到，这台计算机有 2 个以太网地址和 2 个 IP 地址。\u003c/p\u003e\n\n\u003cp\u003e从这张图可以得出这样的结论：对于有多个物理网络接口的计算机，IP 模块是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eN:M\u003c/code\u003e 多路\n复用和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eM:N\u003c/code\u003e 解复用。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e         1   2 3 ...   n                   1   2 3 ...   n\n          \\  | |      /    |                \\  | |      /       ^\n           \\ | |     /     |                 \\ | |     /        |\n         -------------   flow              ----------------   flow\n         |multiplexer|    of               |de-multiplexer|    of\n         -------------   data              ----------------   data\n           / | |     \\     |                 / | |     \\        |\n          /  | |      \\    v                /  | |      \\       |\n         1   2 3 ...   m                   1   2 3 ...   m\n\n        Figure 4.  n-to-m multiplexer and m-to-n de-multiplexer\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对应多个网络接口（network interface）的 IP 模块，要比我们前面的例子更复杂，因\n为它\u003cstrong\u003e能将数据从一个网络转发到另一个网络\u003c/strong\u003e（forward data onto the next network）。\n从任何一个网络接口收到的数据可以在另一个接口发送出去，如图 5 所示。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                           TCP      UDP\n                             \\      /\n                              \\    /\n                          --------------\n                          |     IP     |\n                          |            |\n                          |    ---     |\n                          |   /   \\    |\n                          |  /     v   |\n                          --------------\n                           /         \\\n                          /           \\\n                       data           data\n                      comes in         goes out\n                     here               here\n\n            Figure 5.  Example of IP Forwarding a IP Packet\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003cstrong\u003e将 IP 包从一个网络发送到另一个网络的过程，称为 “转发”\u003c/strong\u003e（forwarding）。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e主要任务是转发 IP 包的计算机\u003c/strong\u003e（computer），称为 \u003cstrong\u003e“IP 路由器”\u003c/strong\u003e（IP-router）。\u003c/p\u003e\n\n\u003cp\u003e从图 5 可以看出，转发 IP 包不会涉及 TCP 和 UDP 模块。因此某些 IP 路由器（\nIP-router）的实现中都没有 TCP 和 UDP 模块。\u003c/p\u003e\n\n\u003ch2 id=\"25-多个物理网络的-ip-空间组成单个逻辑网络\"\u003e2.5 多个物理网络的 IP 空间组成单个逻辑网络\u003c/h2\u003e\n\n\u003cp\u003eIP 模块对 internet 的成功至关重要。\u003c/p\u003e\n\n\u003cp\u003e消息从协议栈经过时，每个模块或驱动都会加上相应层的头（header）。反之，当消息从低\n层协议往上层应用走时，每个模块或驱动又会剥掉相应层的头。\u003c/p\u003e\n\n\u003cp\u003eIP 头包含 IP 地址，而\u003cstrong\u003e不同物理网络的所有 IP 地址\u003c/strong\u003e（组合起来），\u003cstrong\u003e能够形成单个逻\n辑网络\u003c/strong\u003e（IP address which builds a single logical network from multiple\nphysical networks）。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e这种物理网络的互联正是 internet（互联网，音译 internet ）这个名字的由来\u003c/strong\u003e。一组互\n联的物理网络限制了 IP 包的范围，这样的网络称为 “internet”（互联网， internet ）。\u003c/p\u003e\n\n\u003ch2 id=\"26-物理网络的独立性\"\u003e2.6 物理网络的独立性\u003c/h2\u003e\n\n\u003cp\u003eIP 向网络应用隐藏了底层的物理硬件。如果你发明了一种新的物理网络，只需要开发一个\n新驱动，将其通过 IP 连接到 internet 即可。\u003c/p\u003e\n\n\u003cp\u003e因此，网络应用无需做任何改动，不受底层硬件技术变化的影响。\u003c/p\u003e\n\n\u003ch2 id=\"27-互操作性\"\u003e2.7 互操作性\u003c/h2\u003e\n\n\u003cp\u003e如果 \u003cstrong\u003einternet 上的两台计算机能通信\u003c/strong\u003e，我们就说它们能\u003cstrong\u003e互操作\u003c/strong\u003e（interoperate）\n；如果某种 internet 技术实现地很好，我们就说它有\u003cstrong\u003e“互操作性”\u003c/strong\u003e（interoperability\n）。\u003c/p\u003e\n\n\u003cp\u003e市面上的互操作性使得普通计算机用户从 internet 获益良多。一般来说，你\u003cstrong\u003e买了一台计算\n机之后，这台计算机就将用于互操作\u003c/strong\u003e。如果计算机没有互操作性，并且也没有添加互操作\n的能力，那它在市场上的竞争力就会非常小。\u003c/p\u003e\n\n\u003ch2 id=\"28-小结\"\u003e2.8 小结\u003c/h2\u003e\n\n\u003cp\u003e有了以上背景，我们将回答以下问题：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e发送 IP 包时，如何\u003cstrong\u003e确定目的端的以太网地址\u003c/strong\u003e？\u003c/li\u003e\n  \u003cli\u003e如果有多个网络接口，发送 IP 包时如何知道\u003cstrong\u003e使用哪个接口\u003c/strong\u003e？\u003c/li\u003e\n  \u003cli\u003e一台计算机上的\u003cstrong\u003e客户端\u003c/strong\u003e（client）\u003cstrong\u003e如何访问到另一台计算机上的服务端\u003c/strong\u003e（server）？\u003c/li\u003e\n  \u003cli\u003e为什么会有 TCP 和 UDP 两种协议，只有 TCP 或 UDP 不行吗？\u003c/li\u003e\n  \u003cli\u003e有哪些网络应用（network applications）？\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e我们先回顾一下以太网相关的知识，再来回答这些问题。\u003c/p\u003e\n\n\u003ch1 id=\"3-以太网ethernet\"\u003e3. 以太网（Ethernet）\u003c/h1\u003e\n\n\u003cp\u003e本节简要回顾以太网技术。\u003c/p\u003e\n\n\u003cp\u003e一个以太网帧包含：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e目的地址\u003c/li\u003e\n  \u003cli\u003e源地址\u003c/li\u003e\n  \u003cli\u003e类型\u003c/li\u003e\n  \u003cli\u003e数据\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e以太网地址为 6 个字节。每个设备\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e都有自己的以太网地址\u003c/li\u003e\n  \u003cli\u003e接收目的地址是自己的以太帧\u003c/li\u003e\n  \u003cli\u003e所有设备还接收目的地址是 “FF-FF-FF-FF-FF-FF” 的以太帧，这个地址称为广播地址。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e以太网基于 CSMA/CD\u003c/strong\u003e (Carrier Sense and Multiple Access with Collision Detection)\n技术。CSMA/CD 意味着\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e所有设备在同一介质上通信\u003c/li\u003e\n  \u003cli\u003e在\u003cstrong\u003e任意时间只允许一个设备发送数据\u003c/strong\u003e，但它们\u003cstrong\u003e能同时接收数据\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e如果有两台设备同时尝试发送，就会检测到发送冲突（transmit collision），这两个设\n备就必须等待一段随机（但很短）的时间，然后才能再次尝试发送。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"31-类比黑暗的屋子中多人交谈\"\u003e3.1 类比：黑暗的屋子中多人交谈\u003c/h2\u003e\n\n\u003cp\u003e以太网技术的一个很好的类比是：\u003cstrong\u003e一群人在一个很小的、全黑的房间里讨论问题\u003c/strong\u003e。在这\n个类比中，物理介质是房间中\u003cstrong\u003e空气中的声波\u003c/strong\u003e（sound waves on air），对应以太网中的\n同轴电缆中的\u003cstrong\u003e电信号\u003c/strong\u003e（electrical signals on a coaxial cable）。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e有人说话时，\u003cstrong\u003e其他人都能听到\u003c/strong\u003e（Carrier Sense，\u003cstrong\u003e载波侦听\u003c/strong\u003e）。\u003c/li\u003e\n  \u003cli\u003e房间中的\u003cstrong\u003e每个人都有同等说话的权利\u003c/strong\u003e（Multiple Access，\u003cstrong\u003e多路访问\u003c/strong\u003e）。\u003c/li\u003e\n  \u003cli\u003e房间中的每个人都比较礼貌，\u003cstrong\u003e不会长时间地连续讲话\u003c/strong\u003e。如果谁不礼貌，就会\n被请出房间（例如，关闭他的网络）。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e有人在说话时，其他人不能说话\u003c/strong\u003e。但如果两个人同时尝试说话，他们二人立即能分辨\n出来（Collision Detection，\u003cstrong\u003e冲突检测\u003c/strong\u003e）。\u003c/li\u003e\n  \u003cli\u003e发现冲突后，他们会\u003cstrong\u003e等待一小会\u003c/strong\u003e，然后再次尝试发声。其他人如果想发言，会先倾听\n正在说话的人，等待他说完。\u003c/li\u003e\n  \u003cli\u003e为避免混淆，\u003cstrong\u003e每个人都有唯一的名字\u003c/strong\u003e（唯一的以太网地址）。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e每次说话时，人们会先说出对方的名字，然后是自己的名字，然后才是消息内容\u003c/strong\u003e（分\n别对应以太网目的和源地址），例如“你好 Jane，我是 Jack，… 巴拉巴拉 …”。如果\n想和所有人说话，他可能会说 “所有人” （广播地址），例如 “你好所有人，我是\nJack，… 巴拉巴拉 …”。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"4-arp地址解析协议\"\u003e4. ARP（地址解析协议）\u003c/h1\u003e\n\n\u003cp\u003e发送 IP 包时，如何确定目的以太网地址呢？\u003c/p\u003e\n\n\u003cp\u003eARP (Address Resolution Protocol，地址解析协议) 用于\u003cstrong\u003e将 IP 地址转换成以太网地址\u003c/strong\u003e\n（translate IP addresses to Ethernet addresses）。\u003c/p\u003e\n\n\u003cp\u003e只会为出向（outgoing）IP 包执行这种转换，因为出向包才需要添加 IP 头和以太帧头。\u003c/p\u003e\n\n\u003ch2 id=\"41--arp-表arp-table\"\u003e4.1  ARP 表（ARP Table）\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e转换是通过查表（table look-up）完成的\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e这个表称为 ARP 表，存储在内存中，每行表示一台计算机的信息，其中包括 IP 地址和以\n太网地址。执行转换时，会去表中查询 IP 地址对应的以太网地址。下面是一张简化之后的\nARP 表：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                  ------------------------------------\n                  |IP address       Ethernet address |\n                  ------------------------------------\n                  |223.1.2.1        08-00-39-00-2F-C3|\n                  |223.1.2.3        08-00-5A-21-A7-22|\n                  |223.1.2.4        08-00-10-99-AC-54|\n                  ------------------------------------\n                      TABLE 1.  Example ARP Table\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e人类可读格式的惯例是：IP 地址用十进制，并用小数点作为分隔符；以太网地址用十六进\n制，并用短横岗或冒号作为分隔符。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eARP 表是必需的\u003c/strong\u003e，因为 \u003cstrong\u003eIP 地址和以太网地址的分配是独立的，二者之间并没有算法\n可以从一个计算出另一个\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eIP 地址是网络管理员\u003cstrong\u003e根据计算机在 internet 上的位置选择\u003c/strong\u003e的。当计算机在\ninternet 上\u003cstrong\u003e移动到另一个位置时，IP 地址必须要改\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e以太网地址是\u003cstrong\u003e制造商\u003c/strong\u003e根据其拿到的\u003cstrong\u003e以太网地址空间授权\u003c/strong\u003e，从这个空间中选择的。\n当以太网硬件接口板换掉时，以太网地址就会变化。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"42-典型-arp-转换场景\"\u003e4.2 典型 ARP 转换场景\u003c/h2\u003e\n\n\u003cp\u003e在网络应用（例如 TELNET）的正常运行过程中，应用将一段消息发给 TCP，TCP 会将其发\n送给 IP 模块。应用、TCP 模块和 IP 模块都是知道目的 IP 地址的。\u003c/p\u003e\n\n\u003cp\u003e此时，\u003cstrong\u003eIP 包已经构建好\u003c/strong\u003e，可以送到以太网驱动，但在此之前，\u003cstrong\u003e必须先确定目的端的\n以太网地址\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e因此，接下来会\u003cstrong\u003e根据目的 IP 查找 ARP 表\u003c/strong\u003e，获取目的以太网地址。\u003c/p\u003e\n\n\u003ch2 id=\"43--arp-请求响应\"\u003e4.3  ARP 请求/响应\u003c/h2\u003e\n\n\u003cp\u003e但 \u003cstrong\u003eARP 表里的初始内容\u003c/strong\u003e是如何填充的呢？答案是：它们是 \u003cstrong\u003eARP 按需自动填\u003c/strong\u003e的（\nfilled automatically by ARP on an “as-needed” basis）。\u003c/p\u003e\n\n\u003cp\u003e当 IP 不在 ARP 表中导致查询失败时，会做两件事情：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e发送一个 ARP 请求，目的以太网地址是\u003cstrong\u003e广播地址\u003c/strong\u003e，即，\u003cstrong\u003e向所有计算机发送这份请求\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e将待发送的 IP 包放入队列\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e每台计算机的以太网接口都接收广播以太帧。以太网驱动检查帧中的\u003cstrong\u003e类型（Type）字段\u003c/strong\u003e\n，发现属于 ARP 协议，因此\u003cstrong\u003e将帧交给 ARP 模块\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eARP 请求带的消息是：\u003cstrong\u003e“如果你的 IP 地址就是我所请求的 IP 地址，请告诉我你的以太\n网地址”\u003c/strong\u003e。一个 ARP 请求长这样：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ---------------------------------------\n                |Sender IP Address   223.1.2.1        |\n                |Sender Enet Address 08-00-39-00-2F-C3|\n                ---------------------------------------\n                |Target IP Address   223.1.2.2        |\n                |Target Enet Address \u0026lt;blank\u0026gt;          |\n                ---------------------------------------\n                     TABLE 2.  Example ARP Request\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eARP 模块检查其中的 IP 地址字段，如果目标 IP 地址就是自己，它就会直接\u003cstrong\u003e向\n源以太网地址发送一个 ARP 应答\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eARP 应答所携带的消息是：\u003cstrong\u003e“目的 IP 地址就是我，下面是我的以太网地址”\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eARP 应答的 sender/target 字段和 ARP 请求中的刚好相反，格式如下：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ---------------------------------------\n                |Sender IP Address   223.1.2.2        |\n                |Sender Enet Address 08-00-28-00-38-A9|\n                ---------------------------------------\n                |Target IP Address   223.1.2.1        |\n                |Target Enet Address 08-00-39-00-2F-C3|\n                ---------------------------------------\n                     TABLE 3.  Example ARP Response\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e源计算机收到这个应答之后，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e以太网驱动查看帧中的 Type 字段，判断是 ARP 协议\u003c/li\u003e\n  \u003cli\u003e将它交给 ARP 模块\u003c/li\u003e\n  \u003cli\u003eARP 模块检查包的内容，然后\u003cstrong\u003e将发送者的 IP 地址和以太网地址存到它的 ARP 表中\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e更新之后的 ARP 表如下图所示：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                   ----------------------------------\n                   |IP address     Ethernet address |\n                   ----------------------------------\n                   |223.1.2.1      08-00-39-00-2F-C3|\n                   |223.1.2.2      08-00-28-00-38-A9|\n                   |223.1.2.3      08-00-5A-21-A7-22|\n                   |223.1.2.4      08-00-10-99-AC-54|\n                   ----------------------------------\n                   TABLE 4.  ARP Table after Response\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"44-arp-场景续scenario-continued\"\u003e4.4 ARP 场景续（Scenario Continued）\u003c/h2\u003e\n\n\u003cp\u003e新规则此时已经自动加到 ARP 表，整个过程仅花费微秒级时间。\u003c/p\u003e\n\n\u003cp\u003e回忆前面过程，此时\u003cstrong\u003e待发送的 IP 包还缓存在队列里\u003c/strong\u003e。因此接下来会\u003cstrong\u003e再进行一次 ARP\n查询\u003c/strong\u003e，得到目的 IP 地址对应的以太网地址，然后将以太帧在以太网上发送出去。\u003c/p\u003e\n\n\u003cp\u003e因此，对于发送计算机来说，\u003cstrong\u003e完整的步骤\u003c/strong\u003e是：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e发送一个 ARP 请求，目的以太网地址是广播地址，即，向所有计算机发送这份请求。\u003c/li\u003e\n  \u003cli\u003e将待发送的 IP 包（在等待相应的以太网地址）放入队列。\u003c/li\u003e\n  \u003cli\u003e收到 ARP 响应，其中包含了目的 IP 对应的以太网地址，将这条转换规则插入 ARP 表中。\u003c/li\u003e\n  \u003cli\u003e从队列中取出待发送的 IP 包，查询 ARP 表找到对应的以太网地址。\u003c/li\u003e\n  \u003cli\u003e将以太帧发送到以太网。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e总结起来就是，\u003cstrong\u003e当 ARP 转换未命中\u003c/strong\u003e（missing）时，这个包就会被\u003cstrong\u003e放到队列\u003c/strong\u003e。然后\n通过 ARP 请求和响应的方式\u003cstrong\u003e迅速地补充缺失的转换规则\u003c/strong\u003e，然后再将缓存的 IP 包发送出\n去。\u003c/p\u003e\n\n\u003cp\u003e计算机中，\u003cstrong\u003e每个以太接口都有自己独立的 ARP 表\u003c/strong\u003e。如果目的计算机不存在，就收不到\nARP 应答，因此 ARP 表将为空。接下来 IP 模块就会丢弃到这个地址的 IP 包。\n由以上原理可知，\u003cstrong\u003e上层协议无法区分下面两种情况\u003c/strong\u003e：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e以太网故障（a broken Ethernet）\u003c/li\u003e\n  \u003cli\u003e目的 IP 地址对应的机器不存在\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e某些 IP 和 ARP 模块的实现中，在等待 ARP 响应的期间，不会将待发送的 IP 包放到队\n列。它们会直接丢弃这个 IP 包，然后由更上层的 TCP 模块或 UDP 网络应用来决定接下来\n如何应对（recovery from the IP packet loss）。因对方式就是超时和重传。重传的消\n息能成功地发送出去，因为前面被丢弃的那个包已经触发了 ARP 表的填充。\u003c/p\u003e\n\n\u003ch1 id=\"5--互联网协议internet-protocol\"\u003e5.  互联网协议（Internet Protocol）\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003eIP 模块是 internet 技术的核心，而路由表（route table）是 IP 模块的核心\u003c/strong\u003e。\nIP 模块利用这个内存中的表来判断每个 IP 包应该路由到哪里。路由表的内容由网络管理\n员配置；如果配错会导致无法通信。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e理解路由表是如何工作的，就是在理解网络互连\u003c/strong\u003e（internetworking）。要管理和维护\nIP 网络，必须得理解这个原理。\u003c/p\u003e\n\n\u003cp\u003e按下面的步骤来理解路由表比较容易：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e对路由有一个高层概览（overview of routing）\u003c/li\u003e\n  \u003cli\u003e学习 IP 网络和 IP 地址\u003c/li\u003e\n  \u003cli\u003e深入理解细节\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"51-直接路由direct-routing\"\u003e5.1 直接路由（Direct Routing）\u003c/h2\u003e\n\n\u003cp\u003e下图是一个由 3 台计算机 A、B、C 组成的微型 internet 。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e每台计算机都有图 1 中所示的 TCP/IP 协议栈。\u003c/li\u003e\n  \u003cli\u003e每台计算机的以太网接口都有自己的以太网地址。\u003c/li\u003e\n  \u003cli\u003e网络管理员给每台计算机的 IP 接口都配置了 IP 地址\u003c/li\u003e\n  \u003cli\u003e另外，管理员还为以太网分配了一个 IP 网络号（IP network number）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                          A      B      C\n                          |      |      |\n                        --o------o------o--\n                        Ethernet 1\n                        IP network \u0026#34;development\u0026#34;\n\n                       Figure 6.  One IP Network\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e当 A 向 B 发送 IP 包时，IP 头中信息如下：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e源 IP 地址：A 的 IP\u003c/li\u003e\n  \u003cli\u003e源以太网地址：A 的以太网地址\u003c/li\u003e\n  \u003cli\u003e目的 IP 地址：B 的 IP\u003c/li\u003e\n  \u003cli\u003e目的以太网地址：B 的以太网地址\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ----------------------------------------\n                |address            source  destination|\n                ----------------------------------------\n                |IP header          A       B          |\n                |Ethernet header    A       B          |\n                ----------------------------------------\n       TABLE 5.  Addresses in an Ethernet frame for an IP packet\n                              from A to B\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对于这个简单的例子（将包从计算机 A 发送到计算机 B）来说，\u003cstrong\u003e以太层其实就足够了\u003c/strong\u003e\n，IP 层并没有提供更多的服务，反而增加了开销：生成、发送和解析 IP 头都需要额外的\nCPU 和带宽资源。\u003c/p\u003e\n\n\u003cp\u003eB 收到这个包后，检查目的 IP 地址是不是自己，然后根据头信息中的内容，将包交给合适\n的上层协议。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eA 和 B 之间的这种通信，称为直接路由\u003c/strong\u003e（direct routing）。\u003c/p\u003e\n\n\u003ch2 id=\"52-间接路由indirect-routing\"\u003e5.2 间接路由（Indirect Routing）\u003c/h2\u003e\n\n\u003cp\u003e相比图 6，下面的图 7 更接近真实 internet 。它\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e由 3 个以太网组成\u003c/li\u003e\n  \u003cli\u003e以太网之上的 3 个 IP 网络（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eaccounting\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003efactory\u003c/code\u003e）由一个 IP\n路由器（计算机 D）连接到一起\u003c/li\u003e\n  \u003cli\u003e每个 IP 网络中有 4 台计算机\u003c/li\u003e\n  \u003cli\u003e每台计算机有自己的 IP 地址和以太网地址\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e          A      B      C      ----D----      E      F      G\n          |      |      |      |   |   |      |      |      |\n        --o------o------o------o-  |  -o------o------o------o--\n        Ethernet 1                 |  Ethernet 2\n        IP network \u0026#34;development\u0026#34;   |  IP network \u0026#34;accounting\u0026#34;\n                                   |\n                                   |\n                                   |     H      I      J\n                                   |     |      |      |\n                                 --o-----o------o------o--\n                                  Ethernet 3\n                                  IP network \u0026#34;factory\u0026#34;\n\n               Figure 7.  Three IP Networks; One internet\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n  \u003cli\u003e除了计算机 D 之外，其他计算机都有图 1 所示的 TCP/IP 协议栈。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e计算机 D 是一台 IP 路由器\u003c/strong\u003e；它\u003cstrong\u003e连接到 3 个网络，因此有 3 个 IP 地址和 3 个以太网地址\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003eD 的 TCP/IP 协议栈和图 3 比较类似，但不同的是，D 有 3 个 ARP 模块和 3 个以太网驱动。\u003c/li\u003e\n  \u003cli\u003e另外注意，D 只有一个 IP 模块。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e网络管理员\u003cstrong\u003e为每个以太网分配一个唯一的编号，称为 IP 网络号\u003c/strong\u003e（IP network number\n）。这张图中没有标出网络号，只标出了网络名。\u003c/p\u003e\n\n\u003cp\u003e当 A 向 B 发送 IP 包时，流程与前面的单网络例子是一样的。\u003cstrong\u003e同一 IP 网络内的任意计\n算机之间通信，都遵循直接路由原则\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e当 D 和 A 通信时，它们之间走直接路由。当 D 和 E 通信时，也是直接路由。D 和 H 通\n信时，还是直接路由\u003c/strong\u003e。这是因为：\u003cstrong\u003eD 和这几台计算机（分别）都在同一个 IP 网络中\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e但是，当 A 与 IP 路由器连接的其他网络内的计算机通信时，它们之间不再是直接的（\ndirect）。必须要\u003cstrong\u003e由 D 将 IP 包转发给下一个 IP 网络\u003c/strong\u003e。这种通信称为\u003cstrong\u003e“间接的”\u003c/strong\u003e\n（indirect）。\u003c/p\u003e\n\n\u003cp\u003eIP 包的路由过程是由 IP 模块处理的，对上层的 TCP、UDP 和网络应用是透明的。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eA 向 E 发送 IP 包时\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e源 IP 和源以太网地址是 A 的。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e目的 IP 地址是 E 的 IP 地址\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e目的以太网地址是 D 的以太网地址\u003c/strong\u003e：因为 A 的 IP 模块需要将这个 IP 包发送给 D 做转发。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ----------------------------------------\n                |address            source  destination|\n                ----------------------------------------\n                |IP header          A       E          |\n                |Ethernet header    A       D          |\n                ----------------------------------------\n       TABLE 6.  Addresses in an Ethernet frame for an IP packet\n                         from A to E (before D)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eD 的 IP 模块接收到这个 IP 后，\u003cstrong\u003e检查目的 IP 地址，发现这不是自己的 IP，然后会\n直接将包发给 E\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                ----------------------------------------\n                |address            source  destination|\n                ----------------------------------------\n                |IP header          A       E          |\n                |Ethernet header    D       E          |\n                ----------------------------------------\n       TABLE 7.  Addresses in an Ethernet frame for an IP packet\n                         from A to E (after D)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e因此，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e直接路由：源 IP 和源以太网地址都是发送端的；目的 IP 地址和目的以太网地址都是接\n收端的。\u003c/li\u003e\n  \u003cli\u003e间接路由：\u003cstrong\u003e目的 IP 地址和目的以太网地址不属于同一台机器\u003c/strong\u003e（do not pair up）。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这是一个非常简单的 internet 。实际的网络要比这个复杂地多，会涉及多个 IP 路由器和\n不同类型的物理网络。如果网络管理员想将一个很大的以太网分割为几个较小的以太网，以\n限制以太网广播流量，那可能会采用我们这种 internet 划分方式。\u003c/p\u003e\n\n\u003ch2 id=\"53-ip-模块的路由规则\"\u003e5.3 IP 模块的路由规则\u003c/h2\u003e\n\n\u003cp\u003e至此，我们已经向大家介绍了路由过程发生了什么（what happens），但还没介绍它是如何\n发生的（how it happens）。我们来看 \u003cstrong\u003eIP 模块所使用的规则，或者称为算法\u003c/strong\u003e：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e对于从上层进入 IP 层的出向（outgoing）包，IP 模块必须\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003cstrong\u003e判断是通过直接路由还是间接路由\u003c/strong\u003e发送\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e选择一个下层的网络接口\u003c/strong\u003e\u003c/li\u003e\n    \u003c/ol\u003e\n\n    \u003cp\u003e这些判断是\u003cstrong\u003e通过查询路由表\u003c/strong\u003e做出的。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e对于从下层的接口进入 IP 层的入向（incoming）包，\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003eIP 模块必须\u003cstrong\u003e判断是将包转发出去，还是送到上层\u003c/strong\u003e。\u003c/li\u003e\n      \u003cli\u003e如果是转发，那接下来将这个包作为出向（outgoing）IP 包处理。\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e当收到一个入向 IP 包时，\u003cstrong\u003e永远不会通过同一个接口再将它转发出去\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e这些判断都发生在\u003cstrong\u003e将包交给底层的网络接口之前\u003c/strong\u003e，以及\u003cstrong\u003e查询 ARP 表之前\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"54-ip-地址\"\u003e5.4 IP 地址\u003c/h2\u003e\n\n\u003cp\u003e网络管理员根据计算机所处的 IP 网络为它们分配 IP 地址。每个 IP 地址分为两部分：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e网络号（IP network number）\u003c/li\u003e\n  \u003cli\u003e计算机号（IP computer number）或主机号（IP network number）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e表 1 中，对于 IP 地址 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2.1\u003c/code\u003e，网络号为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2\u003c/code\u003e，主机号为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1\u003c/code\u003e。\u003c/p\u003e\n\n\u003cp\u003e一个 IP 地址的网络号和主机号分别是多少，是由 \u003cstrong\u003eIP 地址的前 4 比特决定的\u003c/strong\u003e。本文\n所有例子中的 IP 地址都属于 C 类，这意味着，前 3 比特表示：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e接下来的 21 比特表示网络号\u003c/li\u003e\n  \u003cli\u003e剩下的 8 比特表示主机号\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这意味着理论上有 2,097,152 个 C 类网络，每个网络中有 254 个主机。\u003c/p\u003e\n\n\u003cp\u003eIP 地址空间是由 NIC（Network Information Center，网络信息中心）管理的。所有连接\n到\u003cstrong\u003e全球互联网\u003c/strong\u003e（the single world-wide Internet ）的 internet ，其网络号必须从\nNIC 申请。即使你只是在搭建自己的 internet ，并且没有连接到全球互联网的打算，你还\n是应该从 NIC 获取网络号。否则，假如某一天你的 internet 最终连接到了另一个\ninternet，将会产生混乱。\u003c/p\u003e\n\n\u003ch2 id=\"55-名字主机名和网络名\"\u003e5.5 名字（主机名和网络名）\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e人们习惯用名字（字符串）指代计算机，而不是用主机号（数字）\u003c/strong\u003e。例如，一台名为\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的计算机可能有一个IP 地址 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2.1\u003c/code\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e对于较小的网络来说，这些 “名字 - IP 地址” 关联信息通常保存在每台\u003cstrong\u003e计算机的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehosts\u003c/code\u003e 文件\u003c/strong\u003e中。\u003c/li\u003e\n  \u003cli\u003e对于较大的网络，这些数据保存在一个\u003cstrong\u003e服务器上\u003c/strong\u003e，在需要时跨网络去获取。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这些数据的格式如下：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e   223.1.2.1     alpha\n   223.1.2.2     beta\n   223.1.2.3     gamma\n   223.1.2.4     delta\n   223.1.3.2     epsilon\n   223.1.4.2     iota\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e第一列是 IP 地址，第二列是对应的主机名。\u003c/p\u003e\n\n\u003cp\u003e在大部分情况下，你可以为所有计算机维护一份完全一致的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehosts\u003c/code\u003e 文件。注意在上面的\n例子中，主机 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e （即路由器 D）只有一个条目，但它实际上有 3 个 IP 地址。用 3\n个中的任何一个 IP 地址都能访问到 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e。当 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 收到一个 IP 包判断目标IP 地\n址是不是自己时，它也会拿这个 IP 跟自己的 3 个 IP 地址分别进行比较。\u003c/p\u003e\n\n\u003cp\u003eIP 网络也有自己的名字。如果你有 3 个 IP 网络，你的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enetworks\u003c/code\u003e 文件可能长这样：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e   223.1.2     development\n   223.1.3     accounting\n   223.1.4     factory\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e第一列是网络号，第二列是网络名。\u003c/p\u003e\n\n\u003cp\u003e从这个例子可以看出，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment\u003c/code\u003e 网络中编号为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1\u003c/code\u003e 的计算机\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment\u003c/code\u003e 网络中编号为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2\u003c/code\u003e 的计算机，以此类推。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e你也可以说 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment.1\u003c/code\u003e，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment.2\u003c/code\u003e，等等。\u003c/p\u003e\n\n\u003cp\u003e对于用户来说，以上 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehosts\u003c/code\u003e 文件已经足够了；但网络管理员可能会将 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 那一行\n写成另一种格式：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e   223.1.2.4     devnetrouter    delta\n   223.1.3.1     facnetrouter\n   223.1.4.1     accnetrouter\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这三行分别给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 计算机的 3 个 IP 地址一个更有意义的名字。实际上，第一\n行给了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2.4\u003c/code\u003e 这个 IP 地址两个名字；\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevnetrouter\u003c/code\u003e 是 alias。\n在实践中，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 是计算机最常用的名字，其他 3 个名字都是在管理 IP 路由表的时候\n才会用到。\u003c/p\u003e\n\n\u003cp\u003e这些文件都是网络管理命令和网络应用使用的，用于提供更有意义的名字。这些工作方式不\n会影响 internet 运营，但会使后者更简单。\u003c/p\u003e\n\n\u003ch2 id=\"56--ip-路由表\"\u003e5.6  IP 路由表\u003c/h2\u003e\n\n\u003cp\u003e当发送 IP 包时，IP 模块如何知道该使用下面的哪个网络接口？答案是：\u003cstrong\u003e从目标 IP 地\n址中提取网络号，然后用网络号查询路由表\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e路由表中，每行表示一条路由。路由表的主要字段包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eIP 网络号\u003c/li\u003e\n  \u003cli\u003e直接/间接标记\u003c/li\u003e\n  \u003cli\u003e路由器 IP 地址\u003c/li\u003e\n  \u003cli\u003e接口号（interface number）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e对于每个出向 IP 包，IP 模块都会去查询路由表。\u003c/p\u003e\n\n\u003cp\u003e在大部分计算机上，都可以用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eroute\u003c/code\u003e 命令修改路由表。路由表的内容是由网络管理员修\n改的，因为他们负责给计算机分配 IP 地址。\u003c/p\u003e\n\n\u003ch2 id=\"57-直接路由的若干细节\"\u003e5.7 直接路由的若干细节\u003c/h2\u003e\n\n\u003cp\u003e为解释路由表是如何工作的，我们需要针对前面的例子深入到更细节。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e                        ---------         ---------\n                        | alpha |         | beta  |\n                        |    1  |         |  1    |\n                        ---------         ---------\n                             |               |\n                     --------o---------------o-\n                      Ethernet 1\n                      IP network \u0026#34;development\u0026#34;\n\n               Figure 8.  Close-up View of One IP Network\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 内的路由表长下面这样：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e     --------------------------------------------------------------\n     |network      direct/indirect flag  router   interface number|\n     --------------------------------------------------------------\n     |development  direct                \u0026lt;blank\u0026gt;  1               |\n     --------------------------------------------------------------\n                  TABLE 8.  Example Simple Route Table\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e在某些 UNIX 系统上，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003enetstat -r\u003c/code\u003e 能够看到这个信息。在这个简单网络中，所有计算机\n都有完全一样的路由表。\u003c/p\u003e\n\n\u003cp\u003e为使讨论方便，我们打印网络的数字表示（网络号），而不是网络名。如下图所示：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e     --------------------------------------------------------------\n     |network      direct/indirect flag  router   interface number|\n     --------------------------------------------------------------\n     |223.1.2      direct                \u0026lt;blank\u0026gt;  1               |\n     --------------------------------------------------------------\n           TABLE 9.  Example Simple Route Table with Numbers\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"58-直接路由的场景\"\u003e5.8 直接路由的场景\u003c/h2\u003e\n\n\u003cp\u003e假设 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 正在向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 发送 IP 包。IP 包位于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的 IP 模块中，目标 IP\n地址是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 或 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2.2\u003c/code\u003e。IP 模块从这个 IP 地址中提取出网络号部分，然后去路\n由表的第一列中匹配。在这个例子中，会匹配到第一条规则。\u003c/p\u003e\n\n\u003cp\u003e这条路由规则中的信息显示：\u003cstrong\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2\u003c/code\u003e 网络中的计算机能够通过直接路由到达\u003c/strong\u003e（第二\n列），只要将包\u003cstrong\u003e从接口 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1\u003c/code\u003e 发送出去\u003c/strong\u003e（最后一列）就行了。因此，接下来会针对\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 的 IP 地址发送一个 ARP 请求，获取其以太网地址，然后就通过接口 1 将 IP 包\n发送给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 了。\u003c/p\u003e\n\n\u003cp\u003e如果应用试图向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.2\u003c/code\u003e 之外的某个网络发包，IP 模块将无法在路由表中找到匹配的\n路由规则。这些 IP 包将被丢弃。某些计算机会提示 “Network not reachable” 错误信息。\u003c/p\u003e\n\n\u003ch2 id=\"59-间接路由的若干细节\"\u003e5.9 间接路由的若干细节\u003c/h2\u003e\n\n\u003cp\u003e现在我们来看看间接路由的细节。\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e          ---------           ---------           ---------\n          | alpha |           | delta |           |epsilon|\n          |    1  |           |1  2  3|           |   1   |\n          ---------           ---------           ---------\n               |               |  |  |                |\n       --------o---------------o- | -o----------------o--------\n        Ethernet 1                |     Ethernet 2\n        IP network \u0026#34;Development\u0026#34;  |     IP network \u0026#34;accounting\u0026#34;\n                                  |\n                                  |     --------\n                                  |     | iota |\n                                  |     |  1   |\n                                  |     --------\n                                  |        |\n                                --o--------o--------\n                                    Ethernet 3\n                                    IP network \u0026#34;factory\u0026#34;\n\n             Figure 9.  Close-up View of Three IP Networks\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 内的路由表如下：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e ---------------------------------------------------------------------\n |network      direct/indirect flag  router          interface number|\n ---------------------------------------------------------------------\n |development  direct                \u0026lt;blank\u0026gt;         1               |\n |accounting   indirect              devnetrouter    1               |\n |factory      indirect              devnetrouter    1               |\n ---------------------------------------------------------------------\n                      TABLE 10.  Alpha Route Table\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e同样，为使讨论方便，我们打印网络号而不是网络名：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  --------------------------------------------------------------------\n  |network      direct/indirect flag  router         interface number|\n  --------------------------------------------------------------------\n  |223.1.2      direct                \u0026lt;blank\u0026gt;        1               |\n  |223.1.3      indirect              223.1.2.4      1               |\n  |223.1.4      indirect              223.1.2.4      1               |\n  --------------------------------------------------------------------\n               TABLE 11.  Alpha Route Table with Numbers\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的路由表中，路由器的 IP 地址是 \u003cstrong\u003e计算机 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 连接 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment\u003c/code\u003e 网\n络的接口的 IP 地址\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"510-间接路由的场景\"\u003e5.10 间接路由的场景\u003c/h2\u003e\n\n\u003cp\u003e假设 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 正在向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 发送 IP 包。此时，IP 包位于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的 IP 模块中，目的\nIP 地址是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e（223.1.3.2）。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eIP 模块从这个 IP 地址中提取出网络号部分（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.3\u003c/code\u003e），然后扫描路由表的第一列\n寻找匹配项。可以看出，匹配到了第二项。\u003c/li\u003e\n  \u003cli\u003e这条路由显示，位于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.3\u003c/code\u003e 网络上的目标计算机能通过 IP 路由器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevnetrouter\u003c/code\u003e 到达。\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的 IP 模块为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevnetrouter\u003c/code\u003e 的 IP 地址执行一次 ARP 查询，获取\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevnetrouter\u003c/code\u003e 对应的以太网地址。\u003c/li\u003e\n  \u003cli\u003e然后通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 的接口 1 将 IP 包直接发送出去。这个 IP 包仍然携带了\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 的 IP 地址（但携带了 IP 路由器的以太网地址）。\u003c/li\u003e\n  \u003cli\u003eIP 包到达 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edevelopment\u003c/code\u003e 网络接口后，向上传递给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 的 IP 模块\n。\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 查看包的目的 IP 地址，发现不是自己的 IP，因此判断应该对这个 IP 包进\n行转发。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e接下来，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 的 IP 模块从目的 IP 地址中提取出网络号（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e223.1.3\u003c/code\u003e），扫描路由\n表寻找匹配项。\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 的路由表如下：\u003c/p\u003e\n\n    \u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  ----------------------------------------------------------------------\n  |network      direct/indirect flag  router           interface number|\n  ----------------------------------------------------------------------\n  |development  direct                \u0026lt;blank\u0026gt;          1               |\n  |factory      direct                \u0026lt;blank\u0026gt;          3               |\n  |accounting   direct                \u0026lt;blank\u0026gt;          2               |\n  ----------------------------------------------------------------------\n                      TABLE 12.  Delta\u0026#39;s Route Table\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e显示网络号而不是网络名：\u003c/p\u003e\n\n    \u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  ----------------------------------------------------------------------\n  |network      direct/indirect flag  router           interface number|\n  ----------------------------------------------------------------------\n  |223.1.2      direct                \u0026lt;blank\u0026gt;          1               |\n  |223.1.3      direct                \u0026lt;blank\u0026gt;          3               |\n  |223.1.4      direct                \u0026lt;blank\u0026gt;          2               |\n  ----------------------------------------------------------------------\n               TABLE 13.  Delta\u0026#39;s Route Table with Numbers\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e匹配到第二行。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 的 IP 模块接下来将包通过接口 3 直接发送给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 计算机。\n  此时，IP 包的目的 IP 地址和目的以太网地址都是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 的。\u003c/li\u003e\n  \u003cli\u003eIP 包到达 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 后，传递给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 的 IP 模块。\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepsilon\u003c/code\u003e 检查包的目的 IP，\n  发现是自己的，接下来将包传给更上层协议。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"511-路由部分总结\"\u003e5.11 路由部分总结\u003c/h2\u003e\n\n\u003cp\u003e当 IP 在很大的 internet 上传输时，可能要经过多个 IP 路由器才能到达最终目的地。这\n条路径并不是由某个中心节点规定的，而是通过\u003cstrong\u003e查询路径上的每个路由器的路由表得到的\u003c/strong\u003e\n（a result of consulting each of the routing tables used in the journey）。\n\u003cstrong\u003e每台计算机只能决定下一跳（the next hop），并将包发往这下一跳\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"512-管理路由\"\u003e5.12 管理路由\u003c/h2\u003e\n\n\u003cp\u003e在大型 internet 中，准确地维护所有计算机上的路由表是一项非常困难的工作；网络管理\n员在不断针对各种需求变化修改网络的配置。路由表中出现错误会导致无法通信，并且排查\n起来极其痛苦。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e保持网络配置的简单，是构建可靠 internet 的康庄大道\u003c/strong\u003e。例如，给以太网分配 IP 网\n络的最直接方式就是：只为每个 internet 分配一个 IP 网络号。\u003c/p\u003e\n\n\u003cp\u003e某些协议和网络应用能协助我们排查问题。ICMP (Internet Control Message Protocol，\ninternet 控制消息协议) 能报告某些路由问题。对于小型网络，每台计算机上的路由表由\n网络管理员配置。对于大型网络，网络管理员通过路由协议来在网络上分发路由，实现这些\n配置步骤的自动化。\u003c/p\u003e\n\n\u003cp\u003e当将一台计算机从一个网络移动到另一个网络时，它的 IP 地址必须修改。当该计算机离开\n原来的网络时，它的 IP 地址将变为无效的。这些变动都需要频繁的更新 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehosts\u003c/code\u003e 文件。\n即使对于中型网络，该文件也将变得难以维护。域名系统（Domain Name System，DNS）可\n用于解决这个难题。\u003c/p\u003e\n\n\u003ch1 id=\"6-udpuser-datagram-protocol\"\u003e6. UDP（User Datagram Protocol）\u003c/h1\u003e\n\n\u003cp\u003eUDP 是 IP 层之上的两种主要协议之一。它给用户的网络应用提供服务。使用 UDP 的网络\n服务有：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eNetwork File System (NFS)\u003c/li\u003e\n  \u003cli\u003eSimple Network Management Protocol (SNMP)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这种服务并不仅仅是 IP 之上的一个接口那么简单。\u003c/p\u003e\n\n\u003cp\u003eUDP 是一个无连接的数据报传送服务（a connectionless datagram delivery service）。\n本机 UDP 模块不与对端 UDP 模块维护端到端的连接；它仅仅是简单地将数据报发送到网络\n上，以及从网络上接收进来的数据报。\u003c/p\u003e\n\n\u003cp\u003eUDP \u003cstrong\u003e在 IP 之上提供了两种价值\u003c/strong\u003e：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e基于端口号（port number），实现\u003cstrong\u003e应用之间的信息复用\u003c/strong\u003e（multiplexing of information）\u003c/li\u003e\n  \u003cli\u003e校验和，\u003cstrong\u003e校验数据的完整性\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"61-端口ports\"\u003e6.1 端口（Ports）\u003c/h2\u003e\n\n\u003cp\u003e一台计算机上的客户端（client）如何访问到另一台计算机上的服务端（server）？\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e应用和 UDP 之间的通信路径是 UDP 端口\u003c/strong\u003e。这些端口是用数字表示的，从 0 开始。提\n供服务的应用，会在特定于这个应用的端口上（specific port dedicated to that\nservice）等待接收消息进来。服务端会耐心地等待客户端的请求过来。\u003c/p\u003e\n\n\u003cp\u003e例如，名为 SNMP agent 的 SNMP 服务程序，永远在 161 端口等待。每台计算机上只能运\n行一个 SNMP agent，因为每台计算机只有一个 UDP 161 端口。这个端口是 well known 的\n；是由 internet 分配的数字；如果一个 SNMP 客户端想获取 SNMP 服务，它会向目标计算\n机的 UDP 161 端口发送请求。\u003c/p\u003e\n\n\u003cp\u003e当应用通过 UDP 发送数据时，数据会作为一个整体（as a single unit）到达对端。例如\n，如果一个应用在 UDP 端口上执行了 5 次写，对端应用会在 UDP 端口上执行 5 次读。\n\u003cstrong\u003e每次写的大小和每次读的大小是匹配的\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eUDP \u003cstrong\u003e保留了应用定义的消息边界\u003c/strong\u003e（message boundary defined by the application）\n。它不会将应用的两条消息合并，或者将一条消息做拆分。\u003c/p\u003e\n\n\u003ch2 id=\"62-校验和checksum\"\u003e6.2 校验和（Checksum）\u003c/h2\u003e\n\n\u003cp\u003e计算机收到的 IP 包，如果 IP 头中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etype\u003c/code\u003e 字段是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eUDP\u003c/code\u003e 类型，这个包会被 IP 模块\n传递给 UDP 模块。\u003c/p\u003e\n\n\u003cp\u003eUDP 模块从 IP 模块收到 UDP 数据报之后，会检查 UDP 校验和（checksum）。如果\nchecksum 是 0，表示发送端没有计算校验和，可以忽略。因此，发送端可能生成也可能不\n能生成校验和。如果通信双方的两个 UDP 模块之间，以太网是唯一的网络，那你可以选择\n不需要校验和功能。但推荐打开校验和功能，因为在后面的路径中，路由表可能会指示将包\n通过可靠性较差的媒介（less reliable media）发送。\u003c/p\u003e\n\n\u003cp\u003e如果校验和合法（或为 0），接下来会检查目的端口号；\u003cstrong\u003e如果有应用绑定到这个端口号，\n就会为这个应用将这条消息缓存起来，等待应用的读取\u003c/strong\u003e。否则，该 UDP 数据报将被丢弃\n。如果接收 UDP 数据报的速度比应用读取的速度还快，直到队列已经满了，那接下来的\nUDP 数据将被丢弃。直到队列有空闲，否则接下来还会持续丢弃新收到的 UDP 报文。\u003c/p\u003e\n\n\u003ch1 id=\"7-tcptransmission-control-protocol\"\u003e7. TCP（Transmission Control Protocol）\u003c/h1\u003e\n\n\u003cp\u003eTCP 提供了不同于 UDP 的另一种服务。TCP 提供了\u003cstrong\u003e面向连接的字节流\u003c/strong\u003e（\nconnection-oriented byte stream），而非无连接的数据报传送服务。TCP 保证传输，而\nUDP 不保证。\u003c/p\u003e\n\n\u003cp\u003e对于需要保证传输可靠性、不想自己处理超时和重传的网络服务，使用 TCP 比较合适。两\n个最典型的TCP 网络应用：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eFile Transfer Protocol (FTP)\u003c/li\u003e\n  \u003cli\u003eTELNET\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e其他流行的 TCP 网络应用还包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eX-Window System\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ercp\u003c/code\u003e (remote copy)\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003er\u003c/code\u003e 开头的一些命令\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eTCP 的强大能力也是有开销的：它需要更多的 CPU 和网络带宽。TCP 的内部机制要比 UDP\n复杂的多。\u003c/p\u003e\n\n\u003cp\u003e与 UDP 类似，网络应用也是连接到 TCP 端口。一些 well-known 端口是为特殊的应用预留\n的。例如，TELNET server 使用 23 端口。TELNET client 只需要连接指定计算机的 TCP\n23 端口，就能找到上面的 TELENT 服务。\u003c/p\u003e\n\n\u003cp\u003e当应用开始使用 TCP 时，客户侧计算机上的 TCP 模块和服务侧计算机上的 TCP 模块开始互\n信通信。这两个终端 TCP 模块（end-point TCP modules）包含了定义一条\u003cstrong\u003e虚拟电路\u003c/strong\u003e所\n需的状态信息（state information that defines a virtual circuit）。这条虚拟电路会\n消耗两边 TCP 端终的资源。虚拟电路是全双工的（full duplex）；数据可以同时双向传输\n。应用将数据写到 TCP 端口，数据经过网络传输，最终被对端的应用读取。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eTCP 对字节流进行任意组包\u003c/strong\u003e（packetizes the byte stream at will）；它\u003cstrong\u003e不会保留\n相邻写操作之间的边界\u003c/strong\u003e。例如，如果应用在 TCP 端口上写了 5 次，对端的应用可能会读\n10 次才能将这份数据读完。或者，也可能 1 次就将数据读完了。\u003cstrong\u003e一侧的写大小和写次数，\n和另一侧的读大小和读次数没有关系\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eTCP 是一个带超时和重传功能的滑动窗口协议（sliding window protocol）。发出去的包\n必须被对端应答（be acknowledged）。应答可以附带在数据中（be piggybacked on data\n）。两端的接收端都能能够对端的控制（flow control the far end），因此可以防止缓冲\n区溢出（buffer overrun）。\u003c/p\u003e\n\n\u003cp\u003e就像所有的滑动窗口协议一样，TCP 协议有一个窗口大小（window size）。窗口大小决定\n了在收到应答之前，最多可以发送的数据量（the amount of data that can be\ntransmitted before an acknowledgement is required）。对于 TCP 来说，这个窗口大小\n的单位是字节，不是 TCP segments。\u003c/p\u003e\n\n\u003ch1 id=\"8-网络应用\"\u003e8. 网络应用\u003c/h1\u003e\n\n\u003cp\u003e为什么会存在 TCP 和 UDP 两个协议，而不是只有一个？\u003c/p\u003e\n\n\u003cp\u003e它们用于不同的服务。大部分应用都只会用到其中之一。作为程序员，你应该根据你的需求\n选择最合适的协议。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果你需要一个可靠的流服务，TCP 可能最合适。\u003c/li\u003e\n  \u003cli\u003e如果你需要一个数据报服务，UDP 可能最合适。\u003c/li\u003e\n  \u003cli\u003e如果你需要跨长距离、高效的传输，TCP 可能最合适。\u003c/li\u003e\n  \u003cli\u003e如果你需要跨快速网络、低延迟的传输，UDP 可能最合适。\u003c/li\u003e\n  \u003cli\u003e如果你的需求无法落到以上类别，那“最合适”的选择还得再评估。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e但是，协议的缺点可以在应用层做一些弥补。例如，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果你选择的是 UDP 协议，并且你需要可靠性，那应用必须提供可靠性。\u003c/li\u003e\n  \u003cli\u003e如果你选择的是 TCP 协议，并且你要求传输数据时有基本单位（record oriented\nservice），那应用必须在字节流中插入标识符（markers）来识别记录。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e现在有哪些网络应用呢？\u003c/p\u003e\n\n\u003cp\u003e太多了，无法一一列举。并且数量还在不断增加。其中一些应用在 internet 技术发展初期\n就已经存在，例如 TELNET 和 FTP。其他一些相对比较新，例如 X-Windows 和 SNMMP。下\n面分别介绍本文提到的几个网络应用。\u003c/p\u003e\n\n\u003ch2 id=\"81-telnet\"\u003e8.1 TELNET\u003c/h2\u003e\n\n\u003cp\u003eTELNET 在 TCP 之上提供了远程登录能力。其操作和外观（operation and appearance）与\n通过电话交换机拨号连接看到的类似。在命令行上，用户输入 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etelnet delta\u003c/code\u003e 就会从计\n算机 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edelta\u003c/code\u003e 收到一个登录提示符。\u003c/p\u003e\n\n\u003cp\u003eTELNET 工作良好；这是一个古老的应用，具有广泛的互操作性。在不同的操作系统上，通\n常运行着不同版本的 TELNET 实现。例如，VAX/VMS 上可能是 TELNET client，UNIX\nSystem V 上可能是 TELNET server。\u003c/p\u003e\n\n\u003ch2 id=\"82-ftp\"\u003e8.2 FTP\u003c/h2\u003e\n\n\u003cp\u003eFile Transfer Protocol (FTP) 和 TELNET 一样古老，也基于 TCP，具有广泛的互操作性\n。其操作和界面就好像 TELNET 到了一台远程计算机一样。但不同的是，不能敲任意命\n令，而只能从一些预置的 FTP 命令中选择，例如列出文件目录命令。\u003c/p\u003e\n\n\u003cp\u003eFTP 命令使我们可以在不同计算机之间拷贝文件。\u003c/p\u003e\n\n\u003ch2 id=\"83-rsh\"\u003e8.3 rsh\u003c/h2\u003e\n\n\u003cp\u003eRemote shell (rsh or remsh) is one of an entire family of remote UNIX\nstyle commands.  The UNIX copy command, cp, becomes rcp.  The UNIX\n“who is logged in” command, who, becomes rwho.  The list continues\nand is referred to collectively to as the “r” series commands or the\n“r*” (r star) commands.\u003c/p\u003e\n\n\u003cp\u003eThe r* commands mainly work between UNIX systems and are designed for\ninteraction between trusted hosts.  Little consideration is given to\nsecurity, but they provide a convenient user environment.\u003c/p\u003e\n\n\u003cp\u003eTo execute the “cc file.c” command on a remote computer called delta,\ntype “rsh delta cc file.c”.  To copy the “file.c” file to delta, type\n“rcp file.c delta:”.  To login to delta, type “rlogin delta”, and if\nyou administered the computers in a certain way, you will not be\nchallenged with a password prompt.\u003c/p\u003e\n\n\u003ch2 id=\"84-nfs\"\u003e8.4 NFS\u003c/h2\u003e\n\n\u003cp\u003eNetwork File System，最早由 Sun Microsystems 公司开发，基于 UDP，是将 UNIX 文件\n系统挂载到多个计算机上的优秀工具。无盘工作站（diskless workstation）能够访问它的\n服务器的硬盘，就好像这个磁盘就插在工作站本机一样。大型机（mainframe）\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ealpha\u003c/code\u003e 上\n数据库的一个硬盘拷贝，也能够被大型机 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e 使用 —— 如果数据库的文件系统挂载到\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebeta\u003c/code\u003e。\u003c/p\u003e\n\n\u003cp\u003eNFS 给网络增加了显著负载，并且如果链路很慢，NFS 的性能将很差，但它的收益也是很大\n的。NFS client 在内核实现，允许所有应用和命令使用以 NFS 方式挂载的磁盘，就好像是\n本地磁盘一样。\u003c/p\u003e\n\n\u003ch2 id=\"85-snmp\"\u003e8.5 SNMP\u003c/h2\u003e\n\n\u003cp\u003eSimple Network Management Protocol (SNMP) 使用 UDP 协议，设计用于集中式网络管理\n站（central network management stations）。\u003c/p\u003e\n\n\u003cp\u003e显然，能收集到的信息越多，网络管理员\n就越能检测和诊断网络问题。集中式平台通过 SNMP 从网络中的计算机上收集这些数据。\nSNMP 定义了数据的格式；而集中式平台或网络管理员负责解读（interpret）这些数据。\u003c/p\u003e\n\n\u003ch2 id=\"86-x-window\"\u003e8.6 X-Window\u003c/h2\u003e\n\n\u003cp\u003eThe X Window System uses the X Window protocol on TCP to draw windows\non a workstation’s bitmap display.  X Window is much more than a\nutility for drawing windows; it is entire philosophy for designing a\nuser interface.\u003c/p\u003e\n\n\u003ch1 id=\"9-其他信息\"\u003e9. 其他信息\u003c/h1\u003e\n\n\u003cp\u003e很多与 internet 相关的信息本文都没有涉及。如果读者在阅读本文之后，有兴趣进行更深\n入的学习，推荐下面一些方向：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e管理命令：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003earp\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eroute\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enetstat\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eARP：添加永久（permanent）entry、发布新（publish）entry、time-out entry、ARP 欺骗（spoofing）\u003c/li\u003e\n  \u003cli\u003eIP 路由表：host entry, default gateway, subnets\u003c/li\u003e\n  \u003cli\u003eIP: time-to-live counter, fragmentation, ICMP\u003c/li\u003e\n  \u003cli\u003eRIP，路由环路\u003c/li\u003e\n  \u003cli\u003e域名系统（DNS）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"10-参考文献\"\u003e10. 参考文献\u003c/h1\u003e\n\n\u003cp\u003e[1] Comer, D., “Internetworking with TCP/IP Principles, Protocols,\n    and Architecture”, Prentice Hall, Englewood Cliffs, New Jersey,\n    U.S.A., 1988.\u003c/p\u003e\n\n\u003cp\u003e[2] Feinler, E., et al, DDN Protocol Handbook, Volume 2 and 3, DDN\n    Network Information Center, SRI International, 333 Ravenswood\n    Avenue, Room EJ291, Menlow Park, California, U.S.A., 1985.\u003c/p\u003e\n\n\u003cp\u003e[3] Spider Systems, Ltd., “Packets and Protocols”, Spider Systems\n    Ltd., Stanwell Street, Edinburgh, U.K. EH6 5NG, 1990.\u003c/p\u003e\n\n\u003ch1 id=\"11-与其他-rfc-的关系\"\u003e11. 与其他 RFC 的关系\u003c/h1\u003e\n\n\u003cp\u003e本文没有更新任何其他 RFC，也没有使任何其他 RFC 失效。\u003c/p\u003e\n\n\u003ch1 id=\"12-安全方面的考虑\"\u003e12. 安全方面的考虑\u003c/h1\u003e\n\n\u003cp\u003eTCP/IP 协议族有一些安全方面需要考虑的问题。对一部分人来说，这非常重要；但对另一\n部分人来说，可能无关紧要；要视具体的用户需求而定。\u003c/p\u003e\n\n\u003cp\u003e本文没有涉及这方面的内容，但如果你有兴趣学习，建议从 ARP-spoofing 开始学起，然后\n按照 RFC 1122 中 “Security Considerations” 章节的指导获取更多信息。\u003c/p\u003e\n\n\u003ch1 id=\"13-作者联系方式\"\u003e13. 作者联系方式\u003c/h1\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e   Theodore John Socolofsky\n   Spider Systems Limited\n   Spider Park\n   Stanwell Street\n   Edinburgh EH6 5NG\n   United Kingdom\n\n   Phone:\n     from UK        031-554-9424\n     from USA 011-44-31-554-9424\n   Fax:\n     from UK        031-554-0649\n     from USA 011-44-31-554-0649\n\n   EMail: TEDS@SPIDER.CO.UK\n\n\n   Claudia Jeanne Kale\n   12 Gosford Place\n   Edinburgh EH6 4BJ\n   United Kingdom\n\n   Phone:\n     from UK        031-554-7432\n     from USA 011-44-31-554-7432\n\n   EMail: CLAUDIAK@SPIDER.CO.UK\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/google-beyondprod-zh/\"\u003e\u003cspan\u003e« [译] BeyondProd：云原生安全的一种新方法（Google, 2019）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/facebook-f4-data-center-fabric-zh/\"\u003e\u003cspan\u003e[译] 数据中心 Fabric：Facebook 的下一代数据中心网络（2014） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2020-06-11T00:00:00Z",
  "Author": "Arthur Chiao"
}