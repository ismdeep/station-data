{
  "Source": "arthurchiao.art",
  "Title": "BPF 进阶笔记（二）：BPF Map 类型详解：使用场景、程序示例",
  "Link": "https://arthurchiao.art/blog/bpf-advanced-notes-2-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eBPF 进阶笔记（二）：BPF Map 类型详解：使用场景、程序示例\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2021-07-13 | Last Update 2022-05-01\u003c/p\u003e\n  \n  \u003cp\u003e内核目前支持 \u003ca href=\"https://github.com/torvalds/linux/blob/v5.8/include/uapi/linux/bpf.h#L122\"\u003e30 来种\u003c/a\u003e\nBPF map 类型。对于主要的类型，本文将介绍其：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e使用场景\u003c/strong\u003e：适合用来做什么？\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e程序示例\u003c/strong\u003e：一些实际例子。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e本文参考：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://blogs.oracle.com/linux/notes-on-bpf-3\"\u003enotes-on-bpf-3\u003c/a\u003e，内容较老，基于内核 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e4.14\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/iovisor/bcc/blob/v0.20.0/docs/kernel-versions.md\"\u003eBPF Features by Linux Kernel Version\u003c/a\u003e，bcc 文档，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ev0.20.0\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"关于-bpf-进阶笔记-系列\"\u003e关于 “BPF 进阶笔记” 系列\u003c/h2\u003e\n\n\u003cp\u003e平时学习和使用 BPF 时所整理。由于是笔记而非教程，因此内容不会追求连贯，有基础的\n同学可作查漏补缺之用。\u003c/p\u003e\n\n\u003cp\u003e文中涉及的代码，如无特殊说明，均基于内核 \u003cstrong\u003e\u003cmark\u003e5.8/5.10\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"/blog/bpf-advanced-notes-1-zh/\"\u003eBPF 进阶笔记（一）：BPF 程序（BPF Prog）类型详解：使用场景、函数签名、执行位置及程序示例\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/bpf-advanced-notes-2-zh/\"\u003eBPF 进阶笔记（二）：BPF Map 类型详解：使用场景、程序示例\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/bpf-advanced-notes-3-zh/\"\u003eBPF 进阶笔记（三）：BPF Map 内核实现\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/bpf-advanced-notes-4-zh/\"\u003eBPF 进阶笔记（四）：调试 BPF 程序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/bpf-advanced-notes-5-zh/\"\u003eBPF 进阶笔记（五）：几种 TCP 相关的 BPF（sockops、struct_ops、header options）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#关于-bpf-进阶笔记-系列\" id=\"markdown-toc-关于-bpf-进阶笔记-系列\"\u003e关于 “BPF 进阶笔记” 系列\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#基础\" id=\"markdown-toc-基础\"\u003e基础\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#bpf-map-类型完整列表\" id=\"markdown-toc-bpf-map-类型完整列表\"\u003eBPF map 类型：完整列表\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#每种-map-引入时的内核版本\" id=\"markdown-toc-每种-map-引入时的内核版本\"\u003e每种 map 引入时的内核版本\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#\" id=\"markdown-toc-\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#hash-maps\" id=\"markdown-toc-hash-maps\"\u003eHash Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-1\" id=\"markdown-toc--1\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_hash\" id=\"markdown-toc-1-bpf_map_type_hash\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景\" id=\"markdown-toc-使用场景\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一将内核态得到的数据传递给用户态程序\" id=\"markdown-toc-场景一将内核态得到的数据传递给用户态程序\"\u003e场景一：将内核态得到的数据，传递给用户态程序\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#场景二存放全局配置信息供-bpf-程序使用\" id=\"markdown-toc-场景二存放全局配置信息供-bpf-程序使用\"\u003e场景二：存放全局配置信息，供 BPF 程序使用\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例\" id=\"markdown-toc-程序示例\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-将内核态数据传递到用户态samplesbpfsockex2\" id=\"markdown-toc-1-将内核态数据传递到用户态samplesbpfsockex2\"\u003e1. 将内核态数据传递到用户态：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex2\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_percpu_hash\" id=\"markdown-toc-2-bpf_map_type_percpu_hash\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_HASH\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-1\" id=\"markdown-toc-使用场景-1\"\u003e使用场景\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-1\" id=\"markdown-toc-程序示例-1\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpfmap_perf_test_kernc\" id=\"markdown-toc-1-samplesbpfmap_perf_test_kernc\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_lru_hash\" id=\"markdown-toc-3-bpf_map_type_lru_hash\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_HASH\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-2\" id=\"markdown-toc-使用场景-2\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一连接跟踪conntrack表nat-表等固定大小哈希表\" id=\"markdown-toc-场景一连接跟踪conntrack表nat-表等固定大小哈希表\"\u003e场景一：连接跟踪（conntrack）表、NAT 表等固定大小哈希表\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-2\" id=\"markdown-toc-程序示例-2\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpfmap_perf_test_kernc-1\" id=\"markdown-toc-1-samplesbpfmap_perf_test_kernc-1\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#2-cilium-conntrack--nat-表\" id=\"markdown-toc-2-cilium-conntrack--nat-表\"\u003e2. Cilium Conntrack \u0026amp; NAT 表\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-bpf_map_type_lru_percpu_hash\" id=\"markdown-toc-4-bpf_map_type_lru_percpu_hash\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_PERCPU_HASH\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-bpf_map_type_hash_of_maps\" id=\"markdown-toc-5-bpf_map_type_hash_of_maps\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH_OF_MAPS\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-3\" id=\"markdown-toc-使用场景-3\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一map-in-map\" id=\"markdown-toc-场景一map-in-map\"\u003e场景一：map-in-map\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-3\" id=\"markdown-toc-程序示例-3\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpftest_map_in_map_kernc\" id=\"markdown-toc-1-samplesbpftest_map_in_map_kernc\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_map_in_map_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-2\" id=\"markdown-toc--2\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#array-maps\" id=\"markdown-toc-array-maps\"\u003eArray Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-3\" id=\"markdown-toc--3\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_array\" id=\"markdown-toc-1-bpf_map_type_array\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景key-是整形\" id=\"markdown-toc-使用场景key-是整形\"\u003e使用场景：key 是整形\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-4\" id=\"markdown-toc-程序示例-4\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-根据协议类型proto-as-key统计流量samplesbpfsockex1\" id=\"markdown-toc-1-根据协议类型proto-as-key统计流量samplesbpfsockex1\"\u003e1. 根据协议类型（proto as key）统计流量：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex1\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_percpu_array\" id=\"markdown-toc-2-bpf_map_type_percpu_array\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_ARRAY\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_prog_array\" id=\"markdown-toc-3-bpf_map_type_prog_array\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PROG_ARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景尾调用tail-call\" id=\"markdown-toc-使用场景尾调用tail-call\"\u003e使用场景：尾调用（tail call）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-5\" id=\"markdown-toc-程序示例-5\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-根据协议类型尾调用到下一层-parsersamplesbpfsockex3\" id=\"markdown-toc-1-根据协议类型尾调用到下一层-parsersamplesbpfsockex3\"\u003e1. 根据协议类型尾调用到下一层 parser：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex3\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-bpf_map_type_perf_event_array\" id=\"markdown-toc-4-bpf_map_type_perf_event_array\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景保存-tracing-结果\" id=\"markdown-toc-使用场景保存-tracing-结果\"\u003e使用场景：保存 tracing 结果\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-6\" id=\"markdown-toc-程序示例-6\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-保存-perf-eventsamplesbpftrace_output_kernc\" id=\"markdown-toc-1-保存-perf-eventsamplesbpftrace_output_kernc\"\u003e1. 保存 perf event：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/trace_output_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-bpf_map_type_array_of_maps\" id=\"markdown-toc-5-bpf_map_type_array_of_maps\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY_OF_MAPS\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景map-in-map\" id=\"markdown-toc-使用场景map-in-map\"\u003e使用场景：map-in-map\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-7\" id=\"markdown-toc-程序示例-7\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpfmap_perf_test_kernc-2\" id=\"markdown-toc-1-samplesbpfmap_perf_test_kernc-2\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#2-samplesbpftest_map_in_map_kernc\" id=\"markdown-toc-2-samplesbpftest_map_in_map_kernc\"\u003e2. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_map_in_map_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-bpf_map_type_cgroup_array\" id=\"markdown-toc-6-bpf_map_type_cgroup_array\"\u003e6 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-4\" id=\"markdown-toc-使用场景-4\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一cgroup-级别的包过滤拒绝放行\" id=\"markdown-toc-场景一cgroup-级别的包过滤拒绝放行\"\u003e场景一：cgroup 级别的包过滤（拒绝/放行）\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#场景二cgroup-级别的进程过滤权限控制等\" id=\"markdown-toc-场景二cgroup-级别的进程过滤权限控制等\"\u003e场景二：cgroup 级别的进程过滤（权限控制等）\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-8\" id=\"markdown-toc-程序示例-8\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-pin--update-pinned-cgroup-arraysamplesbpftest_cgrp2_array_pinc\" id=\"markdown-toc-1-pin--update-pinned-cgroup-arraysamplesbpftest_cgrp2_array_pinc\"\u003e1. Pin \u0026amp; update pinned cgroup array：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_cgrp2_array_pin.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#2-cgroup-级别的包过滤samplesbpftest_cgrp2_tc_kernc\" id=\"markdown-toc-2-cgroup-级别的包过滤samplesbpftest_cgrp2_tc_kernc\"\u003e2. CGroup 级别的包过滤：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_cgrp2_tc_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#3-判断进程是否在给定-cgroup-中samplesbpftest_current_task_under_cgroup_kernc\" id=\"markdown-toc-3-判断进程是否在给定-cgroup-中samplesbpftest_current_task_under_cgroup_kernc\"\u003e3. 判断进程是否在给定 cgroup 中：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_current_task_under_cgroup_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-4\" id=\"markdown-toc--4\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#cgroup-maps\" id=\"markdown-toc-cgroup-maps\"\u003eCGroup Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-5\" id=\"markdown-toc--5\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_cgroup_array\" id=\"markdown-toc-1-bpf_map_type_cgroup_array\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_cgroup_storage\" id=\"markdown-toc-2-bpf_map_type_cgroup_storage\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_STORAGE\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-5\" id=\"markdown-toc-使用场景-5\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一cgroup-内所有-bpf-程序的共享存储\" id=\"markdown-toc-场景一cgroup-内所有-bpf-程序的共享存储\"\u003e场景一：cgroup 内所有 BPF 程序的共享存储\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-9\" id=\"markdown-toc-程序示例-9\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpfhbm_kernhhost-bandwidth-manager\" id=\"markdown-toc-1-samplesbpfhbm_kernhhost-bandwidth-manager\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/hbm_kern.h\u003c/code\u003e：host bandwidth manager\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_percpu_cgroup_storage\" id=\"markdown-toc-3-bpf_map_type_percpu_cgroup_storage\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_CGROUP_STORAGE\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-6\" id=\"markdown-toc--6\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#tracing-maps\" id=\"markdown-toc-tracing-maps\"\u003eTracing Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-7\" id=\"markdown-toc--7\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_stack_trace\" id=\"markdown-toc-1-bpf_map_type_stack_trace\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STACK_TRACE\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-6\" id=\"markdown-toc-使用场景-6\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一存储-profiling-信息\" id=\"markdown-toc-场景一存储-profiling-信息\"\u003e场景一：存储 profiling 信息\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-10\" id=\"markdown-toc-程序示例-10\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-打印调用栈samplesbpfoffwaketime_kernc\" id=\"markdown-toc-1-打印调用栈samplesbpfoffwaketime_kernc\"\u003e1. 打印调用栈：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/offwaketime_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_stack\" id=\"markdown-toc-2-bpf_map_type_stack\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STACK\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-7\" id=\"markdown-toc-使用场景-7\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一\" id=\"markdown-toc-场景一\"\u003e场景一：\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_ringbuf\" id=\"markdown-toc-3-bpf_map_type_ringbuf\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_RINGBUF\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-8\" id=\"markdown-toc-使用场景-8\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一更高效保证事件顺序地往用户空间发送数据\" id=\"markdown-toc-场景一更高效保证事件顺序地往用户空间发送数据\"\u003e场景一：更高效、保证事件顺序地往用户空间发送数据\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-11\" id=\"markdown-toc-程序示例-11\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-替代-perf-event-array\" id=\"markdown-toc-1-替代-perf-event-array\"\u003e1. 替代 perf event array\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-bpf_map_type_perf_event_array-1\" id=\"markdown-toc-4-bpf_map_type_perf_event_array-1\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-9\" id=\"markdown-toc-使用场景-9\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一perf-events\" id=\"markdown-toc-场景一perf-events\"\u003e场景一：Perf events\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-12\" id=\"markdown-toc-程序示例-12\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpftrace_outputtrace-write-系统调用\" id=\"markdown-toc-1-samplesbpftrace_outputtrace-write-系统调用\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/trace_output\u003c/code\u003e：trace \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ewrite()\u003c/code\u003e 系统调用\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-8\" id=\"markdown-toc--8\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#socket-maps\" id=\"markdown-toc-socket-maps\"\u003eSocket Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-9\" id=\"markdown-toc--9\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_sockmap\" id=\"markdown-toc-1-bpf_map_type_sockmap\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SOCKMAP\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-10\" id=\"markdown-toc-使用场景-10\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一socket-redirection重定向\" id=\"markdown-toc-场景一socket-redirection重定向\"\u003e场景一：socket redirection（重定向）\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-13\" id=\"markdown-toc-程序示例-13\"\u003e程序示例\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_reuseport_sockarray\" id=\"markdown-toc-2-bpf_map_type_reuseport_sockarray\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_REUSEPORT_SOCKARRAY\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-11\" id=\"markdown-toc-使用场景-11\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一配合-_sk_reuseport-类型-bpf-程序加速-socket-查找\" id=\"markdown-toc-场景一配合-_sk_reuseport-类型-bpf-程序加速-socket-查找\"\u003e场景一：配合 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e_SK_REUSEPORT\u003c/code\u003e 类型 BPF 程序，加速 socket 查找\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_sk_storage\" id=\"markdown-toc-3-bpf_map_type_sk_storage\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SK_STORAGE\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-12\" id=\"markdown-toc-使用场景-12\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一per-socket-存储空间\" id=\"markdown-toc-场景一per-socket-存储空间\"\u003e场景一：per-socket 存储空间\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-14\" id=\"markdown-toc-程序示例-14\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-在内核定期-dump-socket-详情samplesbpftcp_dumpstats_kernc\" id=\"markdown-toc-1-在内核定期-dump-socket-详情samplesbpftcp_dumpstats_kernc\"\u003e1. 在内核定期 dump socket 详情：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/tcp_dumpstats_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-10\" id=\"markdown-toc--10\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#xdp-maps\" id=\"markdown-toc-xdp-maps\"\u003eXDP Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-11\" id=\"markdown-toc--11\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_sockhash\" id=\"markdown-toc-1-bpf_map_type_sockhash\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SOCKHASH\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-13\" id=\"markdown-toc-使用场景-13\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一xdp-重定向\" id=\"markdown-toc-场景一xdp-重定向\"\u003e场景一：XDP 重定向\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-15\" id=\"markdown-toc-程序示例-15\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-译-利用-ebpf-sockmapredirection-提升-socket-性能2020\" id=\"markdown-toc-1-译-利用-ebpf-sockmapredirection-提升-socket-性能2020\"\u003e1. (译) 利用 ebpf sockmap/redirection 提升 socket 性能（2020）\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_devmap\" id=\"markdown-toc-2-bpf_map_type_devmap\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-14\" id=\"markdown-toc-使用场景-14\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一存放-xdp-配置信息\" id=\"markdown-toc-场景一存放-xdp-配置信息\"\u003e场景一：存放 XDP 配置信息\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#场景二xdp-redirection\" id=\"markdown-toc-场景二xdp-redirection\"\u003e场景二：XDP redirection\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-16\" id=\"markdown-toc-程序示例-16\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-存储-xdp-配置信息samplesbpfxdp_fwd_kernc\" id=\"markdown-toc-1-存储-xdp-配置信息samplesbpfxdp_fwd_kernc\"\u003e1. 存储 XDP 配置信息：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_fwd_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#2-xdp-重定向samplesbpfxdp_redirect_map_kernc\" id=\"markdown-toc-2-xdp-重定向samplesbpfxdp_redirect_map_kernc\"\u003e2. XDP 重定向：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_redirect_map_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#3-极简-xdp-路由器samplesbpfxdp_router_ipv4_kernc\" id=\"markdown-toc-3-极简-xdp-路由器samplesbpfxdp_router_ipv4_kernc\"\u003e3. 极简 XDP 路由器：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_router_ipv4_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_devmap_hash\" id=\"markdown-toc-3-bpf_map_type_devmap_hash\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_DEVMAP_HASH\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-bpf_map_type_cpumap\" id=\"markdown-toc-4-bpf_map_type_cpumap\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CPUMAP\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景xdp-中将包重定向到指定-cpu\" id=\"markdown-toc-使用场景xdp-中将包重定向到指定-cpu\"\u003e使用场景：XDP 中将包重定向到指定 CPU\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-bpf_map_type_xskmap\" id=\"markdown-toc-5-bpf_map_type_xskmap\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_XSKMAP\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景xdp\" id=\"markdown-toc-使用场景xdp\"\u003e使用场景：XDP\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-17\" id=\"markdown-toc-程序示例-17\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-xdp-socket-重定向samplesbpfxdpsock_kernc\" id=\"markdown-toc-1-xdp-socket-重定向samplesbpfxdpsock_kernc\"\u003e1. XDP socket 重定向：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdpsock_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-12\" id=\"markdown-toc--12\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#其他-maps\" id=\"markdown-toc-其他-maps\"\u003e其他 Maps\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-13\" id=\"markdown-toc--13\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-bpf_map_type_queue\" id=\"markdown-toc-1-bpf_map_type_queue\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_QUEUE\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-15\" id=\"markdown-toc-使用场景-15\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一-1\" id=\"markdown-toc-场景一-1\"\u003e场景一：\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-bpf_map_type_struct_ops\" id=\"markdown-toc-2-bpf_map_type_struct_ops\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STRUCT_OPS\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-16\" id=\"markdown-toc-使用场景-16\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一-2\" id=\"markdown-toc-场景一-2\"\u003e场景一：\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-bpf_map_type_lpm_trie\" id=\"markdown-toc-3-bpf_map_type_lpm_trie\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LPM_TRIE\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#使用场景-17\" id=\"markdown-toc-使用场景-17\"\u003e使用场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#场景一存储-ip-路由等\" id=\"markdown-toc-场景一存储-ip-路由等\"\u003e场景一：存储 IP 路由等\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#程序示例-18\" id=\"markdown-toc-程序示例-18\"\u003e程序示例\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#1-samplesbpfmap_perf_test_kernc-3\" id=\"markdown-toc-1-samplesbpfmap_perf_test_kernc-3\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#2-samplesbpfxdp_router_ipv4_kernc\" id=\"markdown-toc-2-samplesbpfxdp_router_ipv4_kernc\"\u003e2. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_router_ipv4_kern.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#3-cilium-todo\" id=\"markdown-toc-3-cilium-todo\"\u003e3. Cilium (TODO)\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-14\" id=\"markdown-toc--14\"\u003e————————————————————————\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#其他相关内容\" id=\"markdown-toc-其他相关内容\"\u003e其他相关内容\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#-15\" id=\"markdown-toc--15\"\u003e————————————————————————\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#用户空间-map-操作toolslibbpfbpfc-提供的封装\" id=\"markdown-toc-用户空间-map-操作toolslibbpfbpfc-提供的封装\"\u003e用户空间 map 操作：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etools/lib/bpf/bpf.c\u003c/code\u003e 提供的封装\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#声明创建-bpf-map-的方式\" id=\"markdown-toc-声明创建-bpf-map-的方式\"\u003e声明/创建 BPF map 的方式\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#常规方式\" id=\"markdown-toc-常规方式\"\u003e常规方式\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#tciproute2-方式\" id=\"markdown-toc-tciproute2-方式\"\u003etc/iproute2 方式\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#map-pinning\" id=\"markdown-toc-map-pinning\"\u003eMap pinning\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"基础\"\u003e基础\u003c/h1\u003e\n\n\u003ch2 id=\"bpf-map-类型完整列表\"\u003eBPF map 类型：完整列表\u003c/h2\u003e\n\n\u003cp\u003e所有 map 类型的定义：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// https://github.com/torvalds/linux/blob/v5.10/include/uapi/linux/bpf.h#L130\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_type\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_UNSPEC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PROG_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PERCPU_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PERCPU_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_STACK_TRACE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_LRU_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_LRU_PERCPU_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_LPM_TRIE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_ARRAY_OF_MAPS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_HASH_OF_MAPS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_SOCKMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CPUMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_XSKMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_SOCKHASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_REUSEPORT_SOCKARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PERCPU_CGROUP_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_QUEUE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_STACK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_SK_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_DEVMAP_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_STRUCT_OPS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_RINGBUF\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_INODE_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"每种-map-引入时的内核版本\"\u003e每种 map 引入时的内核版本\u003c/h2\u003e\n\n\u003cp\u003e见 bcc \u003ca href=\"https://github.com/iovisor/bcc/blob/master/docs/kernel-versions.md#tables-aka-maps\"\u003e维护的文档\u003c/a\u003e，\n记录了哪个内核版本引入的，以及对应的 patch。\u003c/p\u003e\n\n\u003ch1\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"hash-maps\"\u003eHash Maps\u003c/h1\u003e\n\u003ch1 id=\"-1\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003cp\u003eHash map 的实现见\n\u003ca href=\"https://github.com/torvalds/linux/blob/v5.8/kernel/bpf/hashtab.c\"\u003ekernel/bpf/hashtab.c\u003c/a\u003e。\n五种类型共用一套代码：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_HASH\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_HASH\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_PERCPU_HASH\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH_OF_MAPS\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eHash map 的特点：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003ekey 的长度没有限制\u003c/mark\u003e\u003c/strong\u003e，但显然应该大于 0。\u003c/li\u003e\n  \u003cli\u003e给定 key 查找 value 时，内部通过哈希实现，而非数组索引。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003ekey/value 是可删除的\u003c/mark\u003e\u003c/strong\u003e；作为对比，\u003cstrong\u003e\u003cmark\u003eArray 类型\u003c/mark\u003e\u003c/strong\u003e的\nmap 中，key/value 是\u003cstrong\u003e\u003cmark\u003e不可删除的\u003c/mark\u003e\u003c/strong\u003e（但用空值覆盖掉 value\n，可实现删除效果）。\u003c/p\u003e\n\n    \u003cp\u003e原因其实也很简单：哈希表是链表，可以删除链表中的元素；array 是内存空间连续的\n  数组，即使某个 index 处的 value 不用了，这段内存区域还是得留着，不可能将其释放掉。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e不带与带 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePERCPU\u003c/code\u003e 的 map 的区别：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e前者是 global 的，只有一个实例；后者是 cpu-local 的，每个 CPU 上都有一个 map 实例；\u003c/li\u003e\n  \u003cli\u003e多核并发访问时，global map 要加锁；per-cpu map 无需加锁，每个核上的程序访问\nlocal-cpu 上的 map；最后将所有 CPU 上的 map 汇总。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"1-bpf_map_type_hash\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e最简单的哈希 map。\u003c/p\u003e\n\n\u003cp\u003e初始化时需要指定\u003cstrong\u003e\u003cmark\u003e支持的最大条目数\u003c/mark\u003e\u003c/strong\u003e（max_entries）。\n满了之后继续插入数据时，会报 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eE2BIG\u003c/code\u003e 错误。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一将内核态得到的数据传递给用户态程序\"\u003e场景一：将内核态得到的数据，传递给用户态程序\u003c/h3\u003e\n\n\u003cp\u003e这是非常典型的\u003cstrong\u003e\u003cmark\u003e在内核态和用户态传递数据\u003c/mark\u003e\u003c/strong\u003e场景。\u003c/p\u003e\n\n\u003cp\u003e例如，BPF 程序过滤网络设备设备上的包，统计流量信息，并将其写到 map。\n用户态程序从 map 读取统计，做后续处理。\u003c/p\u003e\n\n\u003ch3 id=\"场景二存放全局配置信息供-bpf-程序使用\"\u003e场景二：存放全局配置信息，供 BPF 程序使用\u003c/h3\u003e\n\n\u003cp\u003e例如，对于防火墙功能的 BPF 程序，将过滤规则放到 map 里。用户态控制程序通过\nbpftool 之类的工具更新 map 里的配置信息，BPF 程序动态加载。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例\"\u003e程序示例\u003c/h2\u003e\n\n\u003cp\u003e\u003ca name=\"sockex2\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"1-将内核态数据传递到用户态samplesbpfsockex2\"\u003e1. 将内核态数据传递到用户态：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex2\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e这个例子用 BPF 程序 \u003cstrong\u003e\u003cmark\u003e过滤网络设备设备上的包\u003c/mark\u003e\u003c/strong\u003e，统计包数和字节数，\n并以目的 IP 地址为 key 将统计信息写到 map：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/sockex2_kern.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// BPF map 类型\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__be32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e              \u003cspan class=\"c1\"\u003e// 目的 IP 地址\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epair\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 包数和字节数\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1024\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 最大 entry 数量\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003ehash_map\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;socket2\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_prog2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__sk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eflow_dissector\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eflow\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eflow\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edst\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 目的 IP 地址\u003c/span\u003e\n    \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_lookup_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehash_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 如果已经存在，则更新相应计数\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e__sync_fetch_and_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epackets\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e__sync_fetch_and_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 否则，新建一个 entry\u003c/span\u003e\n        \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003epair\u003c/span\u003e \u003cspan class=\"n\"\u003eval\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebpf_map_update_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehash_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eval\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_ANY\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"2-bpf_map_type_percpu_hash\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_HASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-1\"\u003e使用场景\u003c/h2\u003e\n\n\u003cp\u003e基本同上。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例-1\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpfmap_perf_test_kernc\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch1 id=\"3-bpf_map_type_lru_hash\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_HASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e普通 hash map 的问题是有大小限制，超过最大数量后无法再插入了。LRU map 可以避\n免这个问题，如果 map 满了，再插入时它会自动将\u003cstrong\u003e\u003cmark\u003e最久未被使用（least\nrecently used）\u003c/mark\u003e\u003c/strong\u003e的 entry 从 map 中移除。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-2\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一连接跟踪conntrack表nat-表等固定大小哈希表\"\u003e场景一：连接跟踪（conntrack）表、NAT 表等固定大小哈希表\u003c/h3\u003e\n\n\u003cp\u003e满了之后最老的 entry 会被踢出去。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例-2\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpfmap_perf_test_kernc-1\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch3 id=\"2-cilium-conntrack--nat-表\"\u003e2. \u003ca href=\"\"\u003eCilium Conntrack \u0026amp; NAT 表\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eTODO: update this.\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch1 id=\"4-bpf_map_type_lru_percpu_hash\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LRU_PERCPU_HASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e基本同上。\u003c/p\u003e\n\n\u003ch1 id=\"5-bpf_map_type_hash_of_maps\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_HASH_OF_MAPS\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003emap-in-map：\u003cstrong\u003e\u003cmark\u003e第一个 map 内的元素是指向另一个 map 的指针\u003c/mark\u003e\u003c/strong\u003e。\n与后面将介绍的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY_OF_MAPS\u003c/code\u003e 类似，但外层 map 使用的是哈希而不是数组。\u003c/p\u003e\n\n\u003cp\u003e可以将 \u003cstrong\u003e\u003cmark\u003e整个（内层）map 在运行时实现原子替换\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e相关 \u003ca href=\"https://www.mail-archive.com/netdev@vger.kernel.org/msg159383.html\"\u003ecommit message\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-3\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一map-in-map\"\u003e场景一：map-in-map\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-3\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpftest_map_in_map_kernc\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_map_in_map_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e测试了如下两级查找场景:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eArray of array\u003c/li\u003e\n  \u003cli\u003eHash of array\u003c/li\u003e\n  \u003cli\u003eHash of hash\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"-2\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"array-maps\"\u003eArray Maps\u003c/h1\u003e\n\u003ch1 id=\"-3\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_array\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e最大的特点：\u003cstrong\u003e\u003cmark\u003ekey 就是数组中的索引（index）\u003c/mark\u003e\u003c/strong\u003e（因此 key 一定\n是整形），因此无需对 key 进行哈希。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景key-是整形\"\u003e使用场景：key 是整形\u003c/h2\u003e\n\n\u003ch2 id=\"程序示例-4\"\u003e程序示例\u003c/h2\u003e\n\n\u003cp\u003e\u003ca name=\"sockex1\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"1-根据协议类型proto-as-key统计流量samplesbpfsockex1\"\u003e1. 根据协议类型（proto as key）统计流量：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex1\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/sockex1_kern.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eu32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                  \u003cspan class=\"c1\"\u003e// L4 协议类型（长度是 uint8），例如 IPPROTO_TCP，范围是 0~255\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e               \u003cspan class=\"c1\"\u003e// 累计包长（skb-\u0026gt;len）\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003emy_map\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;socket1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_prog1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__sk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eload_byte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eETH_HLEN\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eoffsetof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiphdr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eprotocol\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e \u003cspan class=\"c1\"\u003e// L4 协议类型\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003epkt_type\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ePACKET_OUTGOING\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 注意：在用户态程序和这段 BPF 程序里都没有往 my_map 里插入数据；\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//   * 如果这是 hash map 类型，那下面的 lookup 一定失败，因为我们没插入过任何数据；\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//   * 但这里是 array 类型，而且 index 表示的 L4 协议类型，在 IP 头里占一个字节，因此范围在 255 以内；\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e//     又 map 的长度声明为 256，所以这里的 lookup 一定能定位到 array 的某个位置，即查找一定成功。\u003c/span\u003e\n    \u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_lookup_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emy_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003e__sync_fetch_and_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"2-bpf_map_type_percpu_array\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e基本同上。\u003c/p\u003e\n\n\u003ch1 id=\"3-bpf_map_type_prog_array\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PROG_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e程序数组，尾调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebpf_tail_call()\u003c/code\u003e 时会用到。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ekey：任意整形（因为要作为 array index），具体表示什么由使用者设计（例如表示协议类型 proto）。\u003c/li\u003e\n  \u003cli\u003evalue：\u003cstrong\u003e\u003cmark\u003eBPF 程序的文件描述符（fd）\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"使用场景尾调用tail-call\"\u003e使用场景：尾调用（tail call）\u003c/h2\u003e\n\n\u003ch2 id=\"程序示例-5\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-根据协议类型尾调用到下一层-parsersamplesbpfsockex3\"\u003e1. 根据协议类型尾调用到下一层 parser：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/sockex3\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch1 id=\"4-bpf_map_type_perf_event_array\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景保存-tracing-结果\"\u003e使用场景：保存 tracing 结果\u003c/h2\u003e\n\n\u003ch2 id=\"程序示例-6\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-保存-perf-eventsamplesbpftrace_output_kernc\"\u003e1. 保存 perf event：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/trace_output_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/trace_output_kern.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_def\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003emy_map\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu32\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;kprobe/sys_write\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_prog1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ept_regs\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eS\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eu64\u003c/span\u003e \u003cspan class=\"n\"\u003epid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eu64\u003c/span\u003e \u003cspan class=\"n\"\u003ecookie\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_get_current_pid_tgid\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecookie\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mh\"\u003e0x12345678\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebpf_perf_event_output\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emy_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"5-bpf_map_type_array_of_maps\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY_OF_MAPS\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景map-in-map\"\u003e使用场景：map-in-map\u003c/h2\u003e\n\n\u003cp\u003emap-in-map，values 是指向内层 map 的 fd。只支持两层 map。\ntwo levels of map，也就是一层 map 嵌套另一层 map。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PROG_ARRAY\u003c/code\u003e 类型的 BPF 程序\u003cstrong\u003e\u003cmark\u003e不支持 map-in-map 功能\u003c/mark\u003e\u003c/strong\u003e\n，因为这会使 tail call 的 verification 更加困难。\n详见 \u003ca href=\"https://www.mail-archive.com/netdev@vger.kernel.org/msg159387.html\"\u003epatch\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例-7\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpfmap_perf_test_kernc-2\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch3 id=\"2-samplesbpftest_map_in_map_kernc\"\u003e2. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_map_in_map_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003ca name=\"bpf_map_type_cgroup_array\"\u003e\u003c/a\u003e\u003c/p\u003e\n\u003ch1 id=\"6-bpf_map_type_cgroup_array\"\u003e6 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e在用户空间存放 cgroup fds，用来 \u003cstrong\u003e\u003cmark\u003e检查给定的 skb 是否与 cgroup_array[index] 指向的 cgroup 关联\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-4\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一cgroup-级别的包过滤拒绝放行\"\u003e场景一：cgroup 级别的包过滤（拒绝/放行）\u003c/h3\u003e\n\n\u003ch3 id=\"场景二cgroup-级别的进程过滤权限控制等\"\u003e场景二：cgroup 级别的进程过滤（权限控制等）\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-8\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-pin--update-pinned-cgroup-arraysamplesbpftest_cgrp2_array_pinc\"\u003e1. Pin \u0026amp; update pinned cgroup array：\u003ca href=\"https://github.com/torvalds/linux/blob/v5.10/samples/bpf/test_cgrp2_array_pin.c\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_cgrp2_array_pin.c\u003c/code\u003e\u003c/a\u003e\u003c/h3\u003e\n\n\u003cp\u003e程序功能：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e将 cgroupv2 array pin 到 BPFFS\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e更新 pinned cgroupv2 array\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/test_cgrp2_array_pin.c\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_array\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003earray_fd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_create_map\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003earray_fd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_obj_get\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epinned_file\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebpf_map_update_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earray_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003earray_key\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecg2_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecreate_array\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_obj_pin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003earray_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epinned_file\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"2-cgroup-级别的包过滤samplesbpftest_cgrp2_tc_kernc\"\u003e2. CGroup 级别的包过滤：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_cgrp2_tc_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e核心是\u003cstrong\u003e\u003cmark\u003e调用 \u003ccode\u003ebpf_skb_under_cgroup()\u003c/code\u003e 判断 skb 是否在给定 cgroup 中\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/test_cgrp2_tc_kern.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_elf_map\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003etest_cgrp2_array_pin\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esize_key\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esize_value\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32_t\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epinning\u003c/span\u003e     \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePIN_GLOBAL_NS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_elem\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;filter\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ehandle_egress\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003e__sk_buff\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ebpf_skb_under_cgroup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eskb\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etest_cgrp2_array_pin\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebpf_trace_printk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epass_msg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epass_msg\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eTC_ACT_OK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"3-判断进程是否在给定-cgroup-中samplesbpftest_current_task_under_cgroup_kernc\"\u003e3. 判断进程是否在给定 cgroup 中：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/test_current_task_under_cgroup_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebpf_current_task_under_cgroup()\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e判断当前进程是否在给定 cgroup 中\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_def\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecgroup_map\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e            \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu32\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu32\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* Writes the last PID that called sync to a map at index 0 */\u003c/span\u003e\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;kprobe/sys_sync\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_prog1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ept_regs\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ebpf_current_task_under_cgroup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecgroup_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"-4\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"cgroup-maps\"\u003eCGroup Maps\u003c/h1\u003e\n\u003ch1 id=\"-5\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_cgroup_array\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e\u003ca href=\"#bpf_map_type_cgroup_array\"\u003e上面\u003c/a\u003e 已经有详细介绍。\u003c/p\u003e\n\n\u003ch1 id=\"2-bpf_map_type_cgroup_storage\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CGROUP_STORAGE\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003eAttach 到一个 cgroup 的所有 BPF 程序，会共用一组 cgroup storage，包括：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003estype\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eMAX_BPF_CGROUP_STORAGE_TYPE\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003estype\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003estorages\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003estype\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_cgroup_storage_alloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprog\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estype\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这里的 types 目前只有两种：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eshared\u003c/li\u003e\n  \u003cli\u003eper-cpu\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"使用场景-5\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一cgroup-内所有-bpf-程序的共享存储\"\u003e场景一：cgroup 内所有 BPF 程序的共享存储\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-9\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpfhbm_kernhhost-bandwidth-manager\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/hbm_kern.h\u003c/code\u003e：host bandwidth manager\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_CGROUP_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_cgroup_storage_key\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ehbm_vqueue\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003equeue_state\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"3-bpf_map_type_percpu_cgroup_storage\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERCPU_CGROUP_STORAGE\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e同上。\u003c/p\u003e\n\n\u003ch1 id=\"-6\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"tracing-maps\"\u003eTracing Maps\u003c/h1\u003e\n\u003ch1 id=\"-7\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_stack_trace\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STACK_TRACE\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e内核程序能通过 bpf_get_stackid() helper 存储 stack 信息。\n将 stack 信息关联到一个 id，而这个 id 是\u003cstrong\u003e\u003cmark\u003e对当前栈的\n指令指针地址（instruction pointer address）进行 32-bit hash\u003c/mark\u003e\u003c/strong\u003e 得到的。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-6\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一存储-profiling-信息\"\u003e场景一：存储 profiling 信息\u003c/h3\u003e\n\n\u003cp\u003e在内核中获取 stack id，用它作为 key 更新另一个 map。\n例如通过对指定的 stack traces 进行 profiling，统计它们的出现次数，或者将 stack\ntrace 信息与当前 pid 关联起来。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例-10\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-打印调用栈samplesbpfoffwaketime_kernc\"\u003e1. 打印调用栈：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/offwaketime_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch1 id=\"2-bpf_map_type_stack\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STACK\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-7\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一\"\u003e场景一：\u003c/h3\u003e\n\n\u003ch1 id=\"3-bpf_map_type_ringbuf\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_RINGBUF\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e依赖：内核 5.7+。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-8\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一更高效保证事件顺序地往用户空间发送数据\"\u003e场景一：更高效、保证事件顺序地往用户空间发送数据\u003c/h3\u003e\n\n\u003cp\u003e详见\n\u003ca href=\"/blog/bpf-ringbuf-zh/\"\u003e(译) BPF ring buffer：使用场景、核心设计及程序示例（2020）\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"程序示例-11\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-替代-perf-event-array\"\u003e1. 替代 perf event array\u003c/h3\u003e\n\n\u003cp\u003e\u003ca href=\"/blog/bpf-ringbuf-zh/\"\u003e(译) BPF ring buffer：使用场景、核心设计及程序示例（2020）\u003c/a\u003e\u003c/p\u003e\n\n\u003ch1 id=\"4-bpf_map_type_perf_event_array-1\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_PERF_EVENT_ARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-9\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一perf-events\"\u003e场景一：Perf events\u003c/h3\u003e\n\n\u003cp\u003eBPF 程序将数据存储在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emmap()\u003c/code\u003e 共享内存中，用户空间程序可以访问。\u003c/p\u003e\n\n\u003cp\u003e场景：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e非固定大小数据（不适合 map）\u003c/li\u003e\n  \u003cli\u003e无需与其他 BPF 程序共享数据\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"程序示例-12\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpftrace_outputtrace-write-系统调用\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/trace_output\u003c/code\u003e：trace \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ewrite()\u003c/code\u003e 系统调用\u003c/h3\u003e\n\n\u003ch1 id=\"-8\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"socket-maps\"\u003eSocket Maps\u003c/h1\u003e\n\u003ch1 id=\"-9\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_sockmap\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SOCKMAP\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e主要用于 socket redirection：将 sockets 信息插入到 map，后面执行到\nbpf_sockmap_redirect() 时，用 map 里的信息触发重定向。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-10\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一socket-redirection重定向\"\u003e场景一：socket redirection（重定向）\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-13\"\u003e程序示例\u003c/h2\u003e\n\n\u003cp\u003eTODO.\u003c/p\u003e\n\n\u003ch1 id=\"2-bpf_map_type_reuseport_sockarray\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_REUSEPORT_SOCKARRAY\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e配合 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_PROG_TYPE_SK_REUSEPORT\u003c/code\u003e 类型的 BPF 程序使用，加速 socket 查找。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-11\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一配合-_sk_reuseport-类型-bpf-程序加速-socket-查找\"\u003e场景一：配合 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e_SK_REUSEPORT\u003c/code\u003e 类型 BPF 程序，加速 socket 查找\u003c/h3\u003e\n\n\u003ch1 id=\"3-bpf_map_type_sk_storage\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SK_STORAGE\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-12\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一per-socket-存储空间\"\u003e场景一：per-socket 存储空间\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-14\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-在内核定期-dump-socket-详情samplesbpftcp_dumpstats_kernc\"\u003e1. 在内核定期 dump socket 详情：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/tcp_dumpstats_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003emap_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u64\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_next_dump\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_SK_STORAGE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emap_flags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_F_NO_PREALLOC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;sockops\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003e_sockops\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_sock_ops\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_tcp_sock\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_sock\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esk\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u64\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enext_dump\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eop\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_SOCK_OPS_TCP_CONNECT_CB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ebpf_sock_ops_cb_flags_set\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_SOCK_OPS_RTT_CB_FLAG\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_SOCK_OPS_RTT_CB\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"nl\"\u003edefault:\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esk\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enext_dump\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_sk_storage_get\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ebpf_next_dump\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esk\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_SK_STORAGE_GET_F_CREATE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003enow\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_ktime_get_ns\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003enow\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enext_dump\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_tcp_sock\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esk\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003enext_dump\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enow\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eINTERVAL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ebpf_printk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;dsack_dups=%u delivered=%u\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edsack_dups\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edelivered\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ebpf_printk\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;delivered_ce=%u icsk_retransmits=%u\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003edelivered_ce\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003etcp_sk\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eicsk_retransmits\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"-10\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"xdp-maps\"\u003eXDP Maps\u003c/h1\u003e\n\u003ch1 id=\"-11\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_sockhash\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_SOCKHASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-13\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一xdp-重定向\"\u003e场景一：XDP 重定向\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-15\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-译-利用-ebpf-sockmapredirection-提升-socket-性能2020\"\u003e1. \u003ca href=\"/blog/socket-acceleration-with-ebpf-zh/\"\u003e(译) 利用 ebpf sockmap/redirection 提升 socket 性能（2020）\u003c/a\u003e\u003c/h3\u003e\n\n\u003ch1 id=\"2-bpf_map_type_devmap\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e功能与 sockmap 类似，但用于 XDP 场景\u003c/mark\u003e\u003c/strong\u003e，在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebpf_redirect()\u003c/code\u003e 时触发。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-14\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一存放-xdp-配置信息\"\u003e场景一：存放 XDP 配置信息\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e对于 TC BPF 程序，配置信息放到普通的 hash 或 array map 里就行了\u003c/mark\u003e\u003c/strong\u003e。但对于\nXDP 程序来说，由于它们开始执行的位置非常靠前，此时大部分网络基础设施它们都是用\n不了的。因此引入了一些专门针对 XDP 的基础设施，例如这里的 DEVMAP（对应 TC 场景\n下的普通 BPF MAP）。\u003c/p\u003e\n\n\u003ch3 id=\"场景二xdp-redirection\"\u003e场景二：XDP redirection\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-16\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-存储-xdp-配置信息samplesbpfxdp_fwd_kernc\"\u003e1. 存储 XDP 配置信息：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_fwd_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e这个例子里，将允许通过哪些网卡发送数据的配置信息放到了一个 DEVMAP 里，\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// key 表示 ifindex，即网卡 ID\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// val 表示是否允许从这个网卡发送（TX）数据\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003exdp_tx_ports\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e主逻辑里查询这个 map，判断是否能通过这个网卡发送数据：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erc\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_FIB_LKUP_RET_SUCCESS\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c1\"\u003e// Verify egress index has been configured as TX-port.\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ebpf_map_lookup_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003exdp_tx_ports\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003efib_params\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eifindex\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eXDP_PASS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ememcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eh_dest\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efib_params\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003edmac\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eETH_ALEN\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ememcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eeth\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eh_source\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efib_params\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esmac\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eETH_ALEN\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_redirect_map\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003exdp_tx_ports\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efib_params\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eifindex\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"2-xdp-重定向samplesbpfxdp_redirect_map_kernc\"\u003e2. XDP 重定向：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_redirect_map_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e将包从指定网卡重定向出去：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// virtual port index\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// physical port index\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003etx_port\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;xdp_redirect_map\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003exdp_redirect_map_prog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003exdp_md\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eswap_src_dst_mac\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"cm\"\u003e/* send packet out physical port */\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_redirect_map\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etx_port\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003evport\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"3-极简-xdp-路由器samplesbpfxdp_router_ipv4_kernc\"\u003e3. 极简 XDP 路由器：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_router_ipv4_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e用到了多种类型的 MAP，实现 IPv4 路由功能：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* Map for trie implementation*/\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_LPM_TRIE\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003etrie_value\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emap_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_F_NO_PREALLOC\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003elpm_map\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* Map for ARP table*/\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__be32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__be64\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003earp_table\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"cm\"\u003e/* Map to keep the exact match entries in the route table*/\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_HASH\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__be32\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__type\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003edirect_map\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e50\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003eexact_match\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_DEVMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e100\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003etx_port\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"3-bpf_map_type_devmap_hash\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_DEVMAP_HASH\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e同上。\u003c/p\u003e\n\n\u003ch1 id=\"4-bpf_map_type_cpumap\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_CPUMAP\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景xdp-中将包重定向到指定-cpu\"\u003e使用场景：XDP 中将包重定向到指定 CPU\u003c/h2\u003e\n\n\u003ch1 id=\"5-bpf_map_type_xskmap\"\u003e5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_XSKMAP\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e都是 XDP map，都可用于 XDP socket 重定向，\u003cstrong\u003e\u003cmark\u003e与 DEVMAP 有什么区别？\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n\u003ch2 id=\"使用场景xdp\"\u003e使用场景：XDP\u003c/h2\u003e\n\n\u003ch2 id=\"程序示例-17\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-xdp-socket-重定向samplesbpfxdpsock_kernc\"\u003e1. XDP socket 重定向：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdpsock_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_XSKMAP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMAX_SOCKS\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__uint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"n\"\u003exsks_map\u003c/span\u003e \u003cspan class=\"nf\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;.maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003err\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;xdp_sock\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003exdp_sock_prog\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003exdp_md\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003err\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003err\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eMAX_SOCKS\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_redirect_map\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003exsks_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003err\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eXDP_DROP\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"-12\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"其他-maps\"\u003e其他 Maps\u003c/h1\u003e\n\u003ch1 id=\"-13\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch1 id=\"1-bpf_map_type_queue\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_QUEUE\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-15\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一-1\"\u003e场景一：\u003c/h3\u003e\n\n\u003ch1 id=\"2-bpf_map_type_struct_ops\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_STRUCT_OPS\u003c/code\u003e\u003c/h1\u003e\n\n\u003ch2 id=\"使用场景-16\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一-2\"\u003e场景一：\u003c/h3\u003e\n\n\u003ch1 id=\"3-bpf_map_type_lpm_trie\"\u003e3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_LPM_TRIE\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e支持高效的 longest-prefix matching。\u003c/p\u003e\n\n\u003ch2 id=\"使用场景-17\"\u003e使用场景\u003c/h2\u003e\n\n\u003ch3 id=\"场景一存储-ip-路由等\"\u003e场景一：存储 IP 路由等\u003c/h3\u003e\n\n\u003ch2 id=\"程序示例-18\"\u003e程序示例\u003c/h2\u003e\n\n\u003ch3 id=\"1-samplesbpfmap_perf_test_kernc-3\"\u003e1. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/map_perf_test_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch3 id=\"2-samplesbpfxdp_router_ipv4_kernc\"\u003e2. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esamples/bpf/xdp_router_ipv4_kern.c\u003c/code\u003e\u003c/h3\u003e\n\n\u003ch3 id=\"3-cilium-todo\"\u003e3. \u003ca href=\"\"\u003eCilium (TODO)\u003c/a\u003e\u003c/h3\u003e\n\n\u003ch1 id=\"-14\"\u003e————————————————————————\u003c/h1\u003e\n\u003ch1 id=\"其他相关内容\"\u003e其他相关内容\u003c/h1\u003e\n\u003ch1 id=\"-15\"\u003e————————————————————————\u003c/h1\u003e\n\n\u003ch2 id=\"用户空间-map-操作toolslibbpfbpfc-提供的封装\"\u003e用户空间 map 操作：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etools/lib/bpf/bpf.c\u003c/code\u003e 提供的封装\u003c/h2\u003e\n\n\u003cp\u003eBPF map 是内核对象，为方便从用户空间对 map 进行操作，\n\u003ca href=\"https://github.com/torvalds/linux/blob/v5.8/tools/lib/bpf/bpf.c\"\u003etools/lib/bpf/bpf.c\u003c/a\u003e\n封装了一些通用 API。例如，\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e# 带 _node 字样的函数或类型都表示感知 NUMA 结构\n\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_create_map_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_type\u003c/span\u003e \u003cspan class=\"n\"\u003emap_type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n       \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003emap_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ebpf_create_map_in_map_node\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003eenum\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_type\u003c/span\u003e \u003cspan class=\"n\"\u003emap_type\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n       \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einner_map_fd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003emap_flags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enode\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e二者最后都会执行到 bpf 系统调用：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003esys_bpf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eBPF_MAP_CREATE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eattr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eattr\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"声明创建-bpf-map-的方式\"\u003e声明/创建 BPF map 的方式\u003c/h2\u003e\n\n\u003ch3 id=\"常规方式\"\u003e常规方式\u003c/h3\u003e\n\n\u003cp\u003e下面是来自 samples/bpf 中的一个例子：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/lathist_kern.c\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_map_def\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003emy_map\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekey_size\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue_size\u003c/span\u003e  \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu64\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_entries\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eMAX_CPU\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以上声明了一个 BPF map，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003emap 类型是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eBPF_MAP_TYPE_ARRAY\u003c/code\u003e，\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e指定 key 和 value 的长度；\u003c/p\u003e\n\n    \u003cp\u003eBPF map 是任意类型的 key/value 存储，key 和 value 类型都是在 BPF 程序中定义的。\n  因此内核关心的并不是 key/value 类型，而且它们的大小（长度）。BPF map 操作也\n  用的的是 key/value 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evoid *\u003c/code\u003e 类型地址。BPF 程序需要解析 map 数据时，先拿到\n  key/value 地址，然后自己做相应的强制类型转换。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e数组最大长度（map size）\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e建议声明 map 时优先使用这种封装好的方式，不要重复造轮子。\u003c/p\u003e\n\n\u003ch3 id=\"tciproute2-方式\"\u003etc/iproute2 方式\u003c/h3\u003e\n\n\u003cp\u003e如果使用的是 tc/iproute2，那声明和创建 map 的过程会稍有不同，见 iproute2\n\u003ca href=\"https://git.kernel.org/pub/scm/network/iproute2/iproute2.git/tree/include/bpf_elf.h?h=v4.14.1\"\u003e源码\u003c/a\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// samples/bpf/tc_l2_redirect_kern.c\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// key 结构体需要 64bit 对其，否则内核校验器会拒绝加载程序\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_elf_map\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003esize_key\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003esize_value\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003emax_elem\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003eid\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003e__u32\u003c/span\u003e \u003cspan class=\"n\"\u003epinning\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ebpf_elf_map\u003c/span\u003e \u003cspan class=\"n\"\u003eSEC\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;maps\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003etun_iface\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etype\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBPF_MAP_TYPE_ARRAY\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esize_key\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esize_value\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epinning\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ePIN_GLOBAL_NS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003emax_elem\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"map-pinning\"\u003eMap pinning\u003c/h2\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* Object pinning settings */\u003c/span\u003e\n\n\u003cspan class=\"cp\"\u003e#define PIN_NONE        0\n#define PIN_OBJECT_NS   1\n#define PIN_GLOBAL_NS   2 // 绑定到 `/sys/fs/bpf/tc/globals/` 下面\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这个选项决定了\u003cstrong\u003e\u003cmark\u003e以何种文件系统方式将 map 暴露出来\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e例如，如果使用的是 libbpf 库，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e可以通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebpf_obj_pin(fd, path)\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e将 map fd 绑定到文件系统中的指定文件\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e接下来，其他程序\u003cstrong\u003e\u003cmark\u003e获取这个 fd\u003c/mark\u003e\u003c/strong\u003e，只需执行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebpf_obj_get(pinned_file)\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/bpf-advanced-notes-1-zh/\"\u003e\u003cspan\u003e« BPF 进阶笔记（一）：BPF 程序（BPF Prog）类型详解：使用场景、函数签名、执行位置及程序示例\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/bpf-advanced-notes-3-zh/\"\u003e\u003cspan\u003eBPF 进阶笔记（三）：BPF Map 内核实现 »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2021-07-13T00:00:00Z",
  "Author": "Arthur Chiao"
}