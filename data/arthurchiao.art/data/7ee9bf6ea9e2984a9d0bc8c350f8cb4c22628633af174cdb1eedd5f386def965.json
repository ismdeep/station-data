{
  "Source": "arthurchiao.art",
  "Title": "K8s 集群稳定性：LIST 请求源码分析、性能评估与大规模基础服务部署调优",
  "Link": "https://arthurchiao.art/blog/k8s-reliability-list-data-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eK8s 集群稳定性：LIST 请求源码分析、性能评估与大规模基础服务部署调优\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2022-05-19 | Last Update 2022-12-11\u003c/p\u003e\n  \n  \u003cp\u003e对于非结构化的数据存储系统来说，LIST 操作通常都是非常重量级的，不仅占用大量的\n磁盘 IO、网络带宽和 CPU，而且会影响同时间段的其他请求（尤其是响应延迟要求极高的\n选主请求），是集群稳定性的一大杀手。\u003c/p\u003e\n\n\u003cp\u003e例如，对于 Ceph 对象存储来说，每个 LIST bucket 请求都需要去多个磁盘中捞出这个\nbucket 的全部数据；不仅自身很慢，还影响了同一时间段内的其他普通读写请求，因为 IO\n是共享的，导致响应延迟上升乃至超时。如果 bucket 内的对象非常多（例如用作\nharbor/docker-registry 的存储后端），LIST 操作甚至都无法在常规时间内完成（\n因而依赖 LIST bucket 操作的 registry GC 也就跑不起来）。\u003c/p\u003e\n\n\u003cp\u003e又如 KV 存储 etcd。相比于 Ceph，一个实际 etcd 集群存储的数据量可能很小（几个 ~\n几十个 GB），甚至足够缓存到内存中。但与 Ceph 不同的是，它的并发请求数量可能会高\n几个量级，比如它是一个 ~4000 nodes 的 k8s 集群的 etcd。单个 LIST 请求可能只需要\n返回几十 MB 到上 GB 的流量，但并发请求一多，etcd 显然也扛不住，所以最好在前面有\n一层缓存，这就是 apiserver 的功能（之一）。K8s 的 LIST 请求大部分都应该被\napiserver 挡住，从它的本地缓存提供服务，但如果使用不当，就会跳过缓存直接到达\netcd，有很大的稳定性风险。\u003c/p\u003e\n\n\u003cp\u003e本文深入研究 k8s apiserver/etcd 的 LIST 操作处理逻辑和性能瓶颈，并提供一些基础服务的 LIST 压力测试、\n部署和调优建议，提升大规模 K8s 集群的稳定性。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-apiserver\u003c/code\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLIST\u003c/code\u003e 请求处理逻辑：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/k8s-reliability-list-data/apiserver-processing-list-request.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e代码基于 v1.24.0，不过 1.19~1.24 的基本逻辑和代码路径是一样的，有需要可对照参考。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-引言\" id=\"markdown-toc-1-引言\"\u003e1 引言\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-k8s-架构环形层次视图\" id=\"markdown-toc-11-k8s-架构环形层次视图\"\u003e1.1 K8s 架构：环形层次视图\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-apiserveretcd-角色\" id=\"markdown-toc-12-apiserveretcd-角色\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver/etcd\u003c/code\u003e 角色\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-apiserveretcd-list-开销\" id=\"markdown-toc-13-apiserveretcd-list-开销\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver/etcd\u003c/code\u003e List 开销\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#131-请求举例\" id=\"markdown-toc-131-请求举例\"\u003e1.3.1 请求举例\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#132-处理开销\" id=\"markdown-toc-132-处理开销\"\u003e1.3.2 处理开销\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-大规模部署时潜在的问题\" id=\"markdown-toc-14-大规模部署时潜在的问题\"\u003e1.4 大规模部署时潜在的问题\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#15-本文目的\" id=\"markdown-toc-15-本文目的\"\u003e1.5 本文目的\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-apiserver-list-操作源码分析\" id=\"markdown-toc-2-apiserver-list-操作源码分析\"\u003e2 apiserver \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eList()\u003c/code\u003e 操作源码分析\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-调用栈和流程图\" id=\"markdown-toc-21-调用栈和流程图\"\u003e2.1 调用栈和流程图\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-请求处理入口list\" id=\"markdown-toc-22-请求处理入口list\"\u003e2.2 请求处理入口：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eList()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-listpredicate\" id=\"markdown-toc-23-listpredicate\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eListPredicate()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-请求指定了资源名resource-name获取单个对象\" id=\"markdown-toc-24-请求指定了资源名resource-name获取单个对象\"\u003e2.4 请求指定了资源名（resource name）：获取单个对象\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-请求未指定资源名获取全量数据做过滤\" id=\"markdown-toc-25-请求未指定资源名获取全量数据做过滤\"\u003e2.5 请求未指定资源名，获取全量数据做过滤\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#251-apiserver-缓存层getlist-处理逻辑\" id=\"markdown-toc-251-apiserver-缓存层getlist-处理逻辑\"\u003e2.5.1 apiserver 缓存层：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGetList()\u003c/code\u003e 处理逻辑\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#252-判断是否必须从-etcd-读数据shoulddelegatelist\" id=\"markdown-toc-252-判断是否必须从-etcd-读数据shoulddelegatelist\"\u003e2.5.2 判断是否必须从 etcd 读数据：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eshouldDelegateList()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#253-情况一listoption-要求从-etcd-读数据\" id=\"markdown-toc-253-情况一listoption-要求从-etcd-读数据\"\u003e2.5.3 情况一：ListOption 要求从 etcd 读数据\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#254-情况二本地缓存还没建好只能从-etcd-读数据\" id=\"markdown-toc-254-情况二本地缓存还没建好只能从-etcd-读数据\"\u003e2.5.4 情况二：本地缓存还没建好，只能从 etcd 读数据\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#255-情况三使用本地缓存\" id=\"markdown-toc-255-情况三使用本地缓存\"\u003e2.5.5 情况三：使用本地缓存\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-list-测试\" id=\"markdown-toc-3-list-测试\"\u003e3 LIST 测试\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-指定-limit2response-将返回分页信息continue\" id=\"markdown-toc-31-指定-limit2response-将返回分页信息continue\"\u003e3.1 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u003c/code\u003e：response 将返回分页信息（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtinue\u003c/code\u003e）\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#311-curl-测试\" id=\"markdown-toc-311-curl-测试\"\u003e3.1.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e 测试\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#312-kubectl-测试\" id=\"markdown-toc-312-kubectl-测试\"\u003e3.1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl\u003c/code\u003e 测试\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-指定-limit2resourceversion0limit2-将被忽略返回全量数据\" id=\"markdown-toc-32-指定-limit2resourceversion0limit2-将被忽略返回全量数据\"\u003e3.2 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u0026amp;resourceVersion=0\u003c/code\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u003c/code\u003e 将被忽略，返回全量数据\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-指定-specnodenamenode1resourceversion0-vs-specnodenamenode1\" id=\"markdown-toc-33-指定-specnodenamenode1resourceversion0-vs-specnodenamenode1\"\u003e3.3 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003espec.nodeName=node1\u0026amp;resourceVersion=0\u003c/code\u003e vs. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003espec.nodeName=node1\u0026#34;\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#结果相同\" id=\"markdown-toc-结果相同\"\u003e结果相同\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#速度差异很大\" id=\"markdown-toc-速度差异很大\"\u003e速度差异很大\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-list-请求对控制平面压力量化分析\" id=\"markdown-toc-4-list-请求对控制平面压力量化分析\"\u003e4 LIST 请求对控制平面压力：量化分析\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-收集-list-请求\" id=\"markdown-toc-41-收集-list-请求\"\u003e4.1 收集 LIST 请求\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-测试-list-请求数据量和耗时\" id=\"markdown-toc-22-测试-list-请求数据量和耗时\"\u003e2.2 测试 LIST 请求数据量和耗时\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-测试结果分析\" id=\"markdown-toc-43-测试结果分析\"\u003e4.3 测试结果分析\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-大规模基础服务部署和调优建议\" id=\"markdown-toc-5-大规模基础服务部署和调优建议\"\u003e5 大规模基础服务：部署和调优建议\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-list-请求默认设置-resourceversion0\" id=\"markdown-toc-51-list-请求默认设置-resourceversion0\"\u003e5.1 List 请求默认设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion=0\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-优先使用-namespaced-api\" id=\"markdown-toc-52-优先使用-namespaced-api\"\u003e5.2 优先使用 namespaced API\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#53-restart-backoff\" id=\"markdown-toc-53-restart-backoff\"\u003e5.3 Restart backoff\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#54-优先通过-labelfield-selector-在服务端做过滤\" id=\"markdown-toc-54-优先通过-labelfield-selector-在服务端做过滤\"\u003e5.4 优先通过 label/field selector 在服务端做过滤\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#541-label-selector\" id=\"markdown-toc-541-label-selector\"\u003e5.4.1 Label selector\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#542-field-selector\" id=\"markdown-toc-542-field-selector\"\u003e5.4.2 Field selector\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#543-namespace-selector\" id=\"markdown-toc-543-namespace-selector\"\u003e5.4.3 Namespace selector\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#55-配套基础设施监控告警等\" id=\"markdown-toc-55-配套基础设施监控告警等\"\u003e5.5 配套基础设施（监控、告警等）\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#551-使用独立-serviceaccount\" id=\"markdown-toc-551-使用独立-serviceaccount\"\u003e5.5.1 使用独立 ServiceAccount\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#552-liveness-监控告警\" id=\"markdown-toc-552-liveness-监控告警\"\u003e5.5.2 Liveness 监控告警\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#553-监控和调优-etcd\" id=\"markdown-toc-553-监控和调优-etcd\"\u003e5.5.3 监控和调优 etcd\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-其他\" id=\"markdown-toc-6-其他\"\u003e6 其他\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-get-请求getoptions\" id=\"markdown-toc-61-get-请求getoptions\"\u003e6.1 Get 请求：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGetOptions{}\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-引言\"\u003e1 引言\u003c/h1\u003e\n\n\u003ch2 id=\"11-k8s-架构环形层次视图\"\u003e1.1 K8s 架构：环形层次视图\u003c/h2\u003e\n\n\u003cp\u003e从架构层次和组件依赖角度，可以将一个 K8s 集群和一台 Linux 主机做如下类比：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/k8s-reliability-list-data/linux-node-vs-k8s-cluster.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 1. Anology: a Linux host and a Kubernetes cluster\u003c/p\u003e\n\n\u003cp\u003e对于 K8s 集群，从内到外的几个组件和功能：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eetcd\u003c/mark\u003e\u003c/strong\u003e：持久化 KV 存储，集群资源（pods/services/networkpolicies/…）的唯一的权威数据（状态）源；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eapiserver\u003c/mark\u003e\u003c/strong\u003e：从 etcd 读取（\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eListWatch\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）全量数据，并缓存在内存中；\u003cstrong\u003e\u003cmark\u003e无状态服务\u003c/mark\u003e\u003c/strong\u003e，可水平扩展；\u003c/li\u003e\n  \u003cli\u003e各种\u003cstrong\u003e\u003cmark\u003e基础服务\u003c/mark\u003e\u003c/strong\u003e（e.g. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e*-agent\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e*-operator\u003c/code\u003e）：连接 apiserver，获取（\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eList/ListWatch\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）各自需要的数据；\u003c/li\u003e\n  \u003cli\u003e集群内的 \u003cstrong\u003e\u003cmark\u003eworkloads\u003c/mark\u003e\u003c/strong\u003e：在 1 和 2 正常的情况下由 3 来创建、管理和 reconcile，例如 kubelet 创建 pod、cilium 配置网络和安全策略。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"12-apiserveretcd-角色\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver/etcd\u003c/code\u003e 角色\u003c/h2\u003e\n\n\u003cp\u003e以上可以看到，系统路径中存在\u003cstrong\u003e\u003cmark\u003e两级 List/ListWatch\u003c/mark\u003e\u003c/strong\u003e（但数据是同一份）：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eapiserver List/ListWatch etcd\u003c/li\u003e\n  \u003cli\u003e基础服务 List/ListWatch apiserver\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e因此，从最简形式上来说，\u003cstrong\u003e\u003cmark\u003eapiserver 就是挡在 etcd 前面的一个代理\u003c/mark\u003e\u003c/strong\u003e（proxy），\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e           +--------+              +---------------+                 +------------+\n           | Client | -----------\u0026gt; | Proxy (cache) | --------------\u0026gt; | Data store |\n           +--------+              +---------------+                 +------------+\n\n         infra services               apiserver                         etcd\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003col\u003e\n  \u003cli\u003e绝大部分情况下，apiserver 直接从本地缓存提供服务（因为它缓存了集群全量数据）；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e某些特殊情况，例如，\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e客户端明确要求从 etcd 读数据\u003c/mark\u003e\u003c/strong\u003e（追求最高的数据准确性），\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eapiserver 本地缓存还没建好\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n    \u003c/ol\u003e\n\n    \u003cp\u003eapiserver 就只能将请求转发给 etcd —— \u003cstrong\u003e\u003cmark\u003e这里就要特别注意了\u003c/mark\u003e\u003c/strong\u003e ——\n 客户端 LIST 参数设置不当也可能会走到这个逻辑。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"13-apiserveretcd-list-开销\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapiserver/etcd\u003c/code\u003e List 开销\u003c/h2\u003e\n\n\u003ch3 id=\"131-请求举例\"\u003e1.3.1 请求举例\u003c/h3\u003e\n\n\u003cp\u003e考虑下面几个 LIST 操作：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eLIST apis/cilium.io/v2/ciliumendpoints?limit=500\u0026amp;resourceVersion=0\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n    \u003cp\u003e这里同时传了两个参数，但 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion=0\u003c/code\u003e 会导致 apiserver 忽略 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=500\u003c/code\u003e，\n 所以客户端拿到的是全量 ciliumendpoints 数据。\u003c/p\u003e\n\n    \u003cp\u003e一种资源的全量数据可能是比较大的，\u003cstrong\u003e\u003cmark\u003e需要考虑清楚是否真的需要全量数据\u003c/mark\u003e\u003c/strong\u003e。\n 后文会介绍\u003cstrong\u003e\u003cmark\u003e定量测量与分析\u003c/mark\u003e\u003c/strong\u003e方法。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eLIST api/v1/pods?filedSelector=spec.nodeName%3Dnode1\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n    \u003cp\u003e这个请求是获取 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enode1\u003c/code\u003e 上的所有 pods（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e%3D\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e=\u003c/code\u003e 的转义）。\u003c/p\u003e\n\n    \u003cp\u003e根据 nodename 做过滤，给人的感觉可能是数据量不太大，但其实背后要比看上去复杂：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e首先，这里没有指定 resourceVersion=0，导致 \u003cstrong\u003e\u003cmark\u003eapiserver 跳过缓存，直接去 etcd 读数据\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e其次，\u003cstrong\u003e\u003cmark\u003eetcd 只是 KV 存储，没有按 label/field 过滤功能\u003c/mark\u003e\u003c/strong\u003e（只处理 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit/continue\u003c/code\u003e），\u003c/li\u003e\n      \u003cli\u003e所以，apiserver 是从 etcd 拉全量数据，然后在\u003cstrong\u003e\u003cmark\u003e内存做过滤\u003c/mark\u003e\u003c/strong\u003e，开销也是很大的，后文有代码分析。\u003c/li\u003e\n    \u003c/ul\u003e\n\n    \u003cp\u003e这种行为是要避免的，除非对数据准确性有极高要求，特意要绕过 apiserver 缓存。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eLIST api/v1/pods?filedSelector=spec.nodeName%3Dnode1\u0026amp;resourceVersion=0\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/p\u003e\n\n    \u003cp\u003e跟 2 的区别是加上了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion=0\u003c/code\u003e，因此 apiserver 会从缓存读数据，\u003cstrong\u003e\u003cmark\u003e性能会有量级的提升\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n    \u003cp\u003e但要注意，虽然实际上返回给客户端的可能只有\u003cstrong\u003e\u003cmark\u003e几百 KB 到上百\n MB\u003c/mark\u003e\u003c/strong\u003e（取决于 node 上 pod 的数量、pod 上 label 的多少等因素），\n 但 apiserver 需要处理的数据量可能是\u003cstrong\u003e\u003cmark\u003e几个 GB\u003c/mark\u003e\u003c/strong\u003e。\n 后面会有定量分析。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e以上可以看到，不同的 LIST 操作产生的影响是不一样的，而客户端看到数据还有可能只\n是 apiserver/etcd 处理数据的很小一部分。如果基础服务大规模启动或重启，\n就极有可能把控制平面打爆。\u003c/p\u003e\n\n\u003ch3 id=\"132-处理开销\"\u003e1.3.2 处理开销\u003c/h3\u003e\n\n\u003cp\u003eList 请求可以分为两种：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eList 全量数据：开销主要花在数据传输；\u003c/li\u003e\n  \u003cli\u003e指定用 label 或字段（field）过滤，只需要匹配的数据。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e这里需要特别说明的是第二种情况，也就是 list 请求带了过滤条件。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e大部分情况下，apiserver 会用自己的缓存做过滤，这个很快，因此\u003cstrong\u003e\u003cmark\u003e耗时主要花在数据传输\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e需要将请求转给 etcd 的情况，\u003c/p\u003e\n\n    \u003cp\u003e前面已经提到，etcd 只是 KV 存储，并不理解 label/field 信息，因此它无法处理过滤请求。\n  实际的过程是：\u003cstrong\u003e\u003cmark\u003eapiserver 从 etcd 拉全量数据，然后在内存做过滤\u003c/mark\u003e\u003c/strong\u003e，再返回给客户端。\u003c/p\u003e\n\n    \u003cp\u003e因此除了数据传输开销（网络带宽），这种情况下还会占用大量 apiserver \u003cstrong\u003e\u003cmark\u003eCPU 和内存\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"14-大规模部署时潜在的问题\"\u003e1.4 大规模部署时潜在的问题\u003c/h2\u003e\n\n\u003cp\u003e再来看个例子，下面这行代码用 k8s client-go 根据 nodename 过滤 pod，\u003c/p\u003e\n\n\u003cp\u003e\u003ca name=\"client_code_empty_rv\"\u003e\u003c/a\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003epodList\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eClient\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCoreV1\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePods\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eFieldSelector\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;spec.nodeName=node1\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e})\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e看起来非常简单的操作，我们来实际看一下它背后的数据量。\n以一个 4000 node，10w pod 的集群为例，\u003cstrong\u003e\u003cmark\u003e全量 pod 数据量\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eetcd 中\u003c/mark\u003e\u003c/strong\u003e：紧凑的非结构化 KV 存储，在 \u003cstrong\u003e\u003cmark\u003e1GB 量级\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eapiserver 缓存中\u003c/mark\u003e\u003c/strong\u003e：已经是结构化的 golang objects，在 \u003cstrong\u003e\u003cmark\u003e2GB 量级\u003c/mark\u003e\u003c/strong\u003e（\nTODO：需进一步确认）；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eapiserver 返回\u003c/mark\u003e\u003c/strong\u003e：client 一般选择默认的 json 格式接收，\n  也已经是结构化数据。全量 pod 的 json 也在 \u003cstrong\u003e\u003cmark\u003e2GB 量级\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e可以看到，某些请求看起来很简单，只是客户端一行代码的事情，但背后的数据量是惊人的。\n指定按 nodeName 过滤 pod 可能只返回了 500KB 数据，但 apiserver 却需要过滤\n2GB 数据 —— \u003cstrong\u003e\u003cmark\u003e最坏的情况，etcd 也要跟着处理 1GB 数据\u003c/mark\u003e\u003c/strong\u003e\n（以上参数配置确实命中了最坏情况，见下文代码分析）。\u003c/p\u003e\n\n\u003cp\u003e集群规模比较小的时候，这个问题可能看不出来（etcd 在 LIST 响应延迟超过某个阈值\n后才开始打印 warning 日志）；规模大了之后，如果这样的请求比较多，apiserver/etcd\n肯定是扛不住的。\u003c/p\u003e\n\n\u003ch2 id=\"15-本文目的\"\u003e1.5 本文目的\u003c/h2\u003e\n\n\u003cp\u003e通过深入代码查看 k8s 的 List/ListWatch 实现，加深对性能问题的理解，对大规模\nK8s 集群的稳定性优化提供一些参考。\u003c/p\u003e\n\n\u003ch1 id=\"2-apiserver-list-操作源码分析\"\u003e2 apiserver \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eList()\u003c/code\u003e 操作源码分析\u003c/h1\u003e\n\n\u003cp\u003e有了以上理论预热，接下来可以看代码实现了。\u003c/p\u003e\n\n\u003ch2 id=\"21-调用栈和流程图\"\u003e2.1 调用栈和流程图\u003c/h2\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003estore.List\n|-store.ListPredicate\n   |-if opt == nil\n   |   opt = ListOptions{ResourceVersion: \u0026#34;\u0026#34;}\n   |-Init SelectionPredicate.Limit/Continue fileld\n   |-list := e.NewListFunc()                               // objects will be stored in this list\n   |-storageOpts := storage.ListOptions{opt.ResourceVersion, opt.ResourceVersionMatch, Predicate: p}\n   |\n   |-if MatchesSingle ok                                   // 1. when \u0026#34;metadata.name\u0026#34; is specified,  get single obj\n   |   // Get single obj from cache or etcd\n   |\n   |-return e.Storage.List(KeyRootFunc(ctx), storageOpts)  // 2. get all objs and perform filtering\n      |-cacher.List()\n         | // case 1: list all from etcd and filter in apiserver\n         |-if shouldDelegateList(opts)                     // true if resourceVersion == \u0026#34;\u0026#34;\n         |    return c.storage.List                        // list from etcd\n         |             |- fromRV *int64 = nil\n         |             |- if len(storageOpts.ResourceVersion) \u0026gt; 0\n         |             |     rv = ParseResourceVersion\n         |             |     fromRV = \u0026amp;rv\n         |             |\n         |             |- for hasMore {\n         |             |    objs := etcdclient.KV.Get()\n         |             |    filter(objs)                   // filter by labels or filelds\n         |             | }\n         |\n         | // case 2: list \u0026amp; filter from apiserver local cache (memory)\n         |-if cache.notready()\n         |   return c.storage.List                         // get from etcd\n         |\n         | // case 3: list \u0026amp; filter from apiserver local cache (memory)\n         |-obj := watchCache.WaitUntilFreshAndGet\n         |-for elem in obj.(*storeElement)\n         |   listVal.Set()                                 // append results to listOjb\n         |-return  // results stored in listObj\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对应的流程图：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/k8s-reliability-list-data/apiserver-processing-list-request.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig 2-1. List operation processing in apiserver\u003c/p\u003e\n\n\u003ch2 id=\"22-请求处理入口list\"\u003e2.2 请求处理入口：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eList()\u003c/code\u003e\u003c/h2\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L361\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// 根据 PredicateFunc 中指定的 LabelSelector 和 FieldSelector 过滤，返回一个对象列表\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emetainternalversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elabel\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003elabels\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEverything\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLabelSelector\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003elabel\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLabelSelector\u003c/span\u003e \u003cspan class=\"c\"\u003e// Label 过滤器，例如 app=nginx\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003efield\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003efields\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEverything\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFieldSelector\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efield\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFieldSelector\u003c/span\u003e \u003cspan class=\"c\"\u003e// 字段过滤器，例如 spec.nodeName=node1\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListPredicate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePredicateFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elabel\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efield\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 拉取（List）数据并过滤（Predicate）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDecorator\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDecorator\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"23-listpredicate\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eListPredicate()\u003c/code\u003e\u003c/h2\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go#L411\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ee\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eStore\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eListPredicate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSelectionPredicate\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emetainternalversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// Step 1: 初始化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003emetainternalversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLimit\u003c/span\u003e    \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLimit\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContinue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContinue\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elist\u003c/span\u003e      \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewListFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e        \u003cspan class=\"c\"\u003e// 返回结果将存储在这里面\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estorageOpts\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 将 API 侧的 ListOption 转成底层存储侧的 ListOption，字段区别见下文\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e      \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ePredicate\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e            \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRecursive\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e            \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Step 2：如果请求指定了 metadata.name，则应获取单个 object，无需对全量数据做过滤\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMatchesSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 检查是否设置了 metadata.name 字段\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 获取这个 object 在 etcd 中的 key（唯一或不存在）\u003c/span\u003e\n            \u003cspan class=\"n\"\u003estorageOpts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRecursive\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estorageOpts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e// else 逻辑：如果执行到这里，说明没有从 context 中拿到过滤用的 key，则 fallback 到下面拿全量数据再过滤\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// Step 3: 对全量数据做过滤\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyRootFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003estorageOpts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// KeyRootFunc() 用来获取这种资源在 etcd 里面的 root key（即 prefix，不带最后的 /）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e1.24.0 中 case 1 \u0026amp; 2 都是 调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ee.Storage.GetList()\u003c/code\u003e，之前的版本有点不同：\u003c/p\u003e\n\n  \u003cul\u003e\n    \u003cli\u003eCase 1 中的 e.Storage.GetToList\u003c/li\u003e\n    \u003cli\u003eCase 1 中的 e.Storage.List\u003c/li\u003e\n  \u003c/ul\u003e\n\n  \u003cp\u003e不过基本流程是一样的。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e如果客户端没传 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eListOption\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，则初始化一个默认值，其中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion\u003c/code\u003e 设置为空字符串，\n  这将使 apiserver \u003cstrong\u003e\u003cmark\u003e从 etcd 拉取数据来返回给客户端，而不使用本地缓存\u003c/mark\u003e\u003c/strong\u003e（除非本地缓存还没有建好）；\u003c/p\u003e\n\n    \u003cp\u003e举例，客户端设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eListOption{Limit: 5000, ResourceVersion: 0}\u003c/code\u003e list ciliumendpoints 时，发送的请求将为\n \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e/apis/cilium.io/v2/ciliumendpoints?limit=500\u0026amp;resourceVersion=0\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion\u003c/code\u003e 为空字符串的行为，后面会看到对它的解析。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e用 listoptions 中的字段分别\u003cstrong\u003e\u003cmark\u003e初始化过滤器\u003c/mark\u003e\u003c/strong\u003e（SelectionPredicate）的 limit/continue 字段；\u003c/li\u003e\n  \u003cli\u003e初始化返回结果，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elist := e.NewListFunc()\u003c/code\u003e；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e将 API 侧的 ListOption 转成底层存储的 ListOption，字段区别见下文\u003c/p\u003e\n\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003emetainternalversion.ListOptions\u003c/code\u003e 是 \u003cstrong\u003e\u003cmark\u003eAPI 侧的结构体\u003c/mark\u003e\u003c/strong\u003e，包含了\u003c/p\u003e\n\n    \u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"c\"\u003e// staging/src/k8s.io/apimachinery/pkg/apis/meta/internalversion/types.go\u003c/span\u003e\n    \n \u003cspan class=\"c\"\u003e// ListOptions is the query options to a standard REST list call.\u003c/span\u003e\n \u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"n\"\u003emetav1\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTypeMeta\u003c/span\u003e\n    \n     \u003cspan class=\"n\"\u003eLabelSelector\u003c/span\u003e \u003cspan class=\"n\"\u003elabels\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSelector\u003c/span\u003e \u003cspan class=\"c\"\u003e// 标签过滤器，例如 app=nginx\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eFieldSelector\u003c/span\u003e \u003cspan class=\"n\"\u003efields\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSelector\u003c/span\u003e \u003cspan class=\"c\"\u003e// 字段过滤器，例如 spec.nodeName=node1\u003c/span\u003e\n    \n     \u003cspan class=\"n\"\u003eWatch\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eAllowWatchBookmarks\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e \u003cspan class=\"n\"\u003emetav1\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e\n    \n     \u003cspan class=\"n\"\u003eTimeoutSeconds\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003eint64\u003c/span\u003e         \u003cspan class=\"c\"\u003e// Timeout for the list/watch call.\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eLimit\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eContinue\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e               \u003cspan class=\"c\"\u003e// a token returned by the server. return a 410 error if the token has expired.\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003estorage.ListOptions\u003c/code\u003e 是传给\u003cstrong\u003e\u003cmark\u003e底层存储的结构体\u003c/mark\u003e\u003c/strong\u003e，字段有一些区别：\u003c/p\u003e\n\n    \u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e \u003cspan class=\"c\"\u003e// staging/src/k8s.io/apiserver/pkg/storage/interfaces.go\u003c/span\u003e\n    \n \u003cspan class=\"c\"\u003e// ListOptions provides the options that may be provided for storage list operations.\u003c/span\u003e\n \u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e \u003cspan class=\"n\"\u003emetav1\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e\n     \u003cspan class=\"n\"\u003ePredicate\u003c/span\u003e \u003cspan class=\"n\"\u003eSelectionPredicate\u003c/span\u003e \u003cspan class=\"c\"\u003e// Predicate provides the selection rules for the list operation.\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eRecursive\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e               \u003cspan class=\"c\"\u003e// true: 根据 key 获取单个对象；false：根据 key prefix 获取全量数据\u003c/span\u003e\n     \u003cspan class=\"n\"\u003eProgressNotify\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e          \u003cspan class=\"c\"\u003e// storage-originated bookmark, ignored for non-watch requests.\u003c/span\u003e\n \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"24-请求指定了资源名resource-name获取单个对象\"\u003e2.4 请求指定了资源名（resource name）：获取单个对象\u003c/h2\u003e\n\n\u003cp\u003e接下来根据请求中是否指定了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emeta.Name\u003c/code\u003e 分为两种情况：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e如果指定了，说明是查询单个对象，因为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eName\u003c/code\u003e 是唯一的，接下来转入查询单个 object 的逻辑；\u003c/li\u003e\n  \u003cli\u003e如果未指定，则需要\u003cstrong\u003e\u003cmark\u003e获取全量数据\u003c/mark\u003e\u003c/strong\u003e，然后在 apiserver 内存中根据 SelectionPredicate 中的过滤条件进行过滤，将最终结果返回给客户端；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e代码如下：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"c\"\u003e// case 1：根据 metadata.name 获取单个 object，无需对全量数据做过滤\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMatchesSingle\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e \u003cspan class=\"n\"\u003eok\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 检查是否设置了 metadata.name 字段\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKeyFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"n\"\u003eerr\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ee\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estorageOpts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003elist\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e// else 逻辑：如果执行到这里，说明没有从 context 中拿到过滤用的 key，则 fallback 到下面拿全量数据再过滤\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ee.Storage 是一个 Interface，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// staging/src/k8s.io/apiserver/pkg/storage/interfaces.go\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// Interface offers a common interface for object marshaling/unmarshaling operations and\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// hides all the storage-related operations behind it.\u003c/span\u003e\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eInterface\u003c/span\u003e \u003cspan class=\"k\"\u003einterface\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCreate\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ettl\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDelete\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eout\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epreconditions\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ePreconditions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eWatch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewatch\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInterface\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003eGetOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eobjPtr\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// unmarshall objects found at key into a *List api object (an object that satisfies runtime.IsList definition).\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// If \u0026#39;opts.Recursive\u0026#39; is false, \u0026#39;key\u0026#39; is used as an exact match; if is true, \u0026#39;key\u0026#39; is used as a prefix.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// The returned contents may be delayed, but it is guaranteed that they will\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// match \u0026#39;opts.ResourceVersion\u0026#39; according \u0026#39;opts.ResourceVersionMatch\u0026#39;.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ee.Storage.GetList() 会执行到 cacher 代码。\u003c/p\u003e\n\n\u003cp\u003e不管是获取单个 object，还是获取全量数据，都经历类似的过程：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e优先从 apiserver 本地缓存获取（决定因素包括 ResourceVersion 等），\u003c/li\u003e\n  \u003cli\u003e不得已才到 etcd 去获取；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e获取单个对象的逻辑相对比较简单，这里就不看了。接下来看 List 全量数据再做过滤的逻辑。\u003c/p\u003e\n\n\u003ch2 id=\"25-请求未指定资源名获取全量数据做过滤\"\u003e2.5 请求未指定资源名，获取全量数据做过滤\u003c/h2\u003e\n\n\u003ch3 id=\"251-apiserver-缓存层getlist-处理逻辑\"\u003e2.5.1 apiserver 缓存层：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGetList()\u003c/code\u003e 处理逻辑\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L622\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetList implements storage.Interface\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eCacher\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erecursive\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRecursive\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epred\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePredicate\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 情况一：ListOption 要求必须从 etcd 读\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eshouldDelegateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// c.storage 指向 etcd\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// If resourceVersion is specified, serve it from cache.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistRV\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParseResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 情况二：apiserver 缓存未建好，只能从 etcd 读\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003elistRV\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eready\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003echeck\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003emeta\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetItemsPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistVal\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003econversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnforcePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efilter\u003c/span\u003e  \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003efilterWithAttrsFunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 最终的过滤器\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eobjs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereadResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindexUsed\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elistItems\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistRV\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 根据 index 预筛，性能优化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eobjs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eelem\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003estoreElement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003efilter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLabels\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFields\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                           \u003cspan class=\"c\"\u003e// 真正的过滤\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistVal\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereflect\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistVal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereflect\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValueOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 更新最后一次读到的 ResourceVersion\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereadResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"252-判断是否必须从-etcd-读数据shoulddelegatelist\"\u003e2.5.2 判断是否必须从 etcd 读数据：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eshouldDelegateList()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L591\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003eshouldDelegateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersion\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epred\u003c/span\u003e            \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePredicate\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epagingEnabled\u003c/span\u003e   \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eDefaultFeatureGate\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnabled\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efeatures\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAPIListChunking\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e      \u003cspan class=\"c\"\u003e// 默认是启用的\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehasContinuation\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003epagingEnabled\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContinue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e                   \u003cspan class=\"c\"\u003e// Continue 是个 token\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ehasLimit\u003c/span\u003e        \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003epagingEnabled\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLimit\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e \u003cspan class=\"c\"\u003e// 只有在 resourceVersion != \u0026#34;0\u0026#34; 的情况下，hasLimit 才有可能为 true\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// 1. 如果未指定 resourceVersion，从底层存储（etcd）拉去数据；\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 2. 如果有 continuation，也从底层存储拉数据；\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 3. 只有 resourceVersion != \u0026#34;0\u0026#34; 时，才会将 limit 传给底层存储（etcd），因为 watch cache 不支持 continuation\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ehasContinuation\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ehasLimit\u003c/span\u003e \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersionMatch\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003emetav1\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResourceVersionMatchExact\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这里非常重要：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e问：客户端未设置 ListOption{} 中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion\u003c/code\u003e 字段，是否对应到这里的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion == \u0026#34;\u0026#34;\u003c/code\u003e？\u003c/p\u003e\n\n    \u003cp\u003e答：是的，所以\u003cstrong\u003e\u003cmark\u003e第一节\u003c/mark\u003e\u003c/strong\u003e的 \u003ca href=\"#client_code_empty_rv\"\u003e例子\u003c/a\u003e 会导致从 etcd 拉全量数据。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e问：客户端设置了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=500\u0026amp;resourceVersion=0\u003c/code\u003e 是否会导致下次 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehasContinuation==true\u003c/code\u003e？\u003c/p\u003e\n\n    \u003cp\u003e答：不会，\u003cstrong\u003e\u003cmark\u003eresourceVersion=0 将导致 limit 被忽略\u003c/mark\u003e\u003c/strong\u003e（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehasLimit\u003c/code\u003e 那一行代码），也就是说，\n 虽然指定了 limit=500，但\u003cstrong\u003e\u003cmark\u003e这个请求会返回全量数据\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e问：ResourceVersionMatch 是什么用途？\u003c/p\u003e\n\n    \u003cp\u003e答：用来告诉 apiserver，该如何解读 ResourceVersion。官方有个很复杂的\n \u003ca href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/#the-resourceversion-parameter\"\u003e\u003cmark\u003e表格\u003c/mark\u003e\u003c/a\u003e\n ，有兴趣可以看看。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e接下来再返回到 cacher 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGetList()\u003c/code\u003e 逻辑，来看下具体有哪几种处理情况。\u003c/p\u003e\n\n\u003ch3 id=\"253-情况一listoption-要求从-etcd-读数据\"\u003e2.5.3 情况一：ListOption 要求从 etcd 读数据\u003c/h3\u003e\n\n\u003cp\u003e这种情况下，apiserver 会直接从 etcd 读取所有 objects 并过滤，然后返回给客户端，\n适用于数据一致性要求极其高的场景。\n当然，也容易\u003cstrong\u003e\u003cmark\u003e误入这种场景造成 etcd 压力过大\u003c/mark\u003e\u003c/strong\u003e，例如\n\u003cstrong\u003e\u003cmark\u003e第一节\u003c/mark\u003e\u003c/strong\u003e的\u003ca href=\"#client_code_empty_rv\"\u003e例子\u003c/a\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go#L563\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetList implements storage.Interface.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003estore\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e   \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003emeta\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetItemsPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ev\u003c/span\u003e         \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003econversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnforcePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekey\u003c/span\u003e        \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eJoin\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epathPrefix\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekeyPrefix\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"c\"\u003e// append \u0026#39;/\u0026#39; if needed\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003enewItemFunc\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003egetNewItemFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003efromRV\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c\"\u003e// 如果 RV 非空（客户端不传时，默认是空字符串）\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eparsedRV\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParseResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efromRV\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eparsedRV\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// ResourceVersion, ResourceVersionMatch 等处理逻辑\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003erecursive\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epagingEnabled\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContinue\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003erecursive\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epagingEnabled\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLimit\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e        \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edefault\u003c/span\u003e                                                    \u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// loop until we have filled the requested limit from etcd or there are no more results\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003egetResp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKV\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 从 etcd 拉数据\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enumFetched\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"nb\"\u003elen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egetResp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKvs\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ehasMore\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003egetResp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMore\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003egetResp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKvs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003elimitOption\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLen\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLimit\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ehasMore\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003elastKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etransformer\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTransformFromStorage\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eappendListItem\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eModRevision\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ecodec\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enewItemFunc\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 这里面会做过滤\u003c/span\u003e\n            \u003cspan class=\"n\"\u003enumEvald\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elastKey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x00\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// instruct the client to begin querying from immediately after the last key we returned\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ehasMore\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"c\"\u003e// we want to start immediately after the last key\u003c/span\u003e\n        \u003cspan class=\"n\"\u003enext\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eencodeContinue\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elastKey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"se\"\u003e\\x00\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekeyPrefix\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereturnedRV\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereturnedRV\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003enext\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eremainingItemCount\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e// no continuation\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003es\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereturnedRV\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eclient.KV.Get()\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 就进入 etcd client 库了，感兴趣可以继续往下挖。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eappendListItem()\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 会\u003cstrong\u003e\u003cmark\u003e对拿到的数据进行过滤\u003c/mark\u003e\u003c/strong\u003e，这就是我们第一节提到的 apiserver 内存过滤操作。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"254-情况二本地缓存还没建好只能从-etcd-读数据\"\u003e2.5.4 情况二：本地缓存还没建好，只能从 etcd 读数据\u003c/h3\u003e\n\n\u003cp\u003e具体执行过程与情况一相同。\u003c/p\u003e\n\n\u003ch3 id=\"255-情况三使用本地缓存\"\u003e2.5.5 情况三：使用本地缓存\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/kubernetes/kubernetes/blob/v1.24.0/staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go#L622\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetList implements storage.Interface\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eCacher\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"n\"\u003estorage\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eListOptions\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003elistObj\u003c/span\u003e \u003cspan class=\"n\"\u003eruntime\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eObject\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 情况一：ListOption 要求必须从 etcd 读\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 情况二：apiserver 缓存未建好，只能从 etcd 读\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003emeta\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetItemsPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// List elements with at least \u0026#39;listRV\u0026#39; from cache.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003elistVal\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003econversion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eEnforcePtr\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistPtr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efilter\u003c/span\u003e  \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003efilterWithAttrsFunction\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 最终的过滤器\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eobjs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereadResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eindexUsed\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003elistItems\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistRV\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epred\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// 根据 index 预筛，性能优化\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eobjs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eelem\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eobj\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003estoreElement\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003efilter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLabels\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eFields\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                           \u003cspan class=\"c\"\u003e// 真正的过滤\u003c/span\u003e\n            \u003cspan class=\"n\"\u003elistVal\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ereflect\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eAppend\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistVal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereflect\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eValueOf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eelem\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eversioner\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eUpdateList\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003elistObj\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereadResourceVersion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"3-list-测试\"\u003e3 LIST 测试\u003c/h1\u003e\n\n\u003cp\u003e为了避免客户端库（例如 client-go）自动帮我们设置一些参数，我们直接用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e 来测试，指定证书就行了：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e$ cat curl-k8s-apiserver.sh\ncurl -s --cert /etc/kubernetes/pki/admin.crt --key /etc/kubernetes/pki/admin.key --cacert /etc/kubernetes/pki/ca.crt $@\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e使用方式：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443/api/v1/pods?limit=2\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;kind\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;PodList\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;metadata\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s2\"\u003e\u0026#34;resourceVersion\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2127852936\u0026#34;\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;continue\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;items\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003epod1 data \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"o\"\u003e{\u003c/span\u003epod2 data\u003cspan class=\"o\"\u003e}]\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"31-指定-limit2response-将返回分页信息continue\"\u003e3.1 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u003c/code\u003e：response 将返回分页信息（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtinue\u003c/code\u003e）\u003c/h2\u003e\n\n\u003ch3 id=\"311-curl-测试\"\u003e3.1.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecurl\u003c/code\u003e 测试\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443/api/v1/pods?limit=2\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;kind\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;PodList\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;metadata\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s2\"\u003e\u0026#34;resourceVersion\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2127852936\u0026#34;\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;continue\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;items\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003epod1 data \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"o\"\u003e{\u003c/span\u003epod2 data\u003cspan class=\"o\"\u003e}]\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e确实返回了两个 pod 信息，在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eitems[]\u003c/code\u003e 字段中；\u003c/li\u003e\n  \u003cli\u003e另外在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emetadata\u003c/code\u003e 中返回了一个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtinue\u003c/code\u003e 字段，客户端下次带上这个参数，apiserver 将继续返回剩下的内容，直到 apiserver 不再返回 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtinue\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"312-kubectl-测试\"\u003e3.1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl\u003c/code\u003e 测试\u003c/h3\u003e\n\n\u003cp\u003e调大 kubectl 的日志级别，也可以看到它背后用了 continue 来获取全量 pods：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ekubectl get pods \u003cspan class=\"nt\"\u003e--all-namespaces\u003c/span\u003e \u003cspan class=\"nt\"\u003e--v\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e10\n\u003cspan class=\"c\"\u003e# 以下都是 log 输出，做了适当调整\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# curl -k -v -XGET  -H \u0026#34;User-Agent: kubectl/v1.xx\u0026#34; -H \u0026#34;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json\u0026#34;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#   \u0026#39;http://localhost:8080/api/v1/pods?limit=500\u0026#39;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# GET http://localhost:8080/api/v1/pods?limit=500 200 OK in 202 milliseconds\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# Response Body: {\u0026#34;kind\u0026#34;:\u0026#34;Table\u0026#34;,\u0026#34;metadata\u0026#34;:{\u0026#34;continue\u0026#34;:\u0026#34;eyJ2Ijoib...\u0026#34;,\u0026#34;remainingItemCount\u0026#34;:54},\u0026#34;columnDefinitions\u0026#34;:[...],\u0026#34;rows\u0026#34;:[...]}\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# \u003c/span\u003e\n\u003cspan class=\"c\"\u003e# curl -k -v -XGET  -H \u0026#34;Accept: application/json;as=Table;v=v1;g=meta.k8s.io,application/json;as=Table;v=v1beta1;g=meta.k8s.io,application/json\u0026#34; -H \u0026#34;User-Agent: kubectl/v1.xx\u0026#34;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e#   \u0026#39;http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib\u0026amp;limit=500\u0026#39;\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# GET http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib\u0026amp;limit=500 200 OK in 44 milliseconds\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# Response Body: {\u0026#34;kind\u0026#34;:\u0026#34;Table\u0026#34;,\u0026#34;metadata\u0026#34;:{\u0026#34;resourceVersion\u0026#34;:\u0026#34;2122644698\u0026#34;},\u0026#34;columnDefinitions\u0026#34;:[],\u0026#34;rows\u0026#34;:[...]}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e第一次请求拿到了 500 个 pods，第二次请求把返回的 continue 带上了：\n\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eGET http://localhost:8080/api/v1/pods?continue=eyJ2Ijoib\u0026amp;limit=500\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，continue 是个 token，\n有点长，为了更好的展示这里把它截断了。\u003c/p\u003e\n\n\u003ch2 id=\"32-指定-limit2resourceversion0limit2-将被忽略返回全量数据\"\u003e3.2 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u0026amp;resourceVersion=0\u003c/code\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elimit=2\u003c/code\u003e 将被忽略，返回全量数据\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443/api/v1/pods?limit=2\u0026amp;resourceVersion=0\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;kind\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;PodList\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;metadata\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s2\"\u003e\u0026#34;resourceVersion\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;2127852936\u0026#34;\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;continue\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;eyJ2IjoibWV0YS5rOHMuaW8vdjEiLCJ...\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;items\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003epod1 data \u003cspan class=\"o\"\u003e}\u003c/span\u003e, \u003cspan class=\"o\"\u003e{\u003c/span\u003epod2 data\u003cspan class=\"o\"\u003e}\u003c/span\u003e, ...]\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eitems[]\u003c/code\u003e 里面是全量 pod 信息。\u003c/p\u003e\n\n\u003ch2 id=\"33-指定-specnodenamenode1resourceversion0-vs-specnodenamenode1\"\u003e3.3 指定 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003espec.nodeName=node1\u0026amp;resourceVersion=0\u003c/code\u003e vs. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003espec.nodeName=node1\u0026#34;\u003c/code\u003e\u003c/h2\u003e\n\n\u003ch3 id=\"结果相同\"\u003e结果相同\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443/api/v1/namespaces/default/pods?fieldSelector=spec.nodeName%3Dnode1\u0026#34;\u003c/span\u003e | jq \u003cspan class=\"s1\"\u003e\u0026#39;.items[].spec.nodeName\u0026#39;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n...\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443/api/v1/namespaces/default/pods?fieldSelector=spec.nodeName%3Dnode1\u0026amp;resourceVersion=0\u0026#34;\u003c/span\u003e | jq \u003cspan class=\"s1\"\u003e\u0026#39;.items[].spec.nodeName\u0026#39;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n\u003cspan class=\"s2\"\u003e\u0026#34;node1\u0026#34;\u003c/span\u003e\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e结果是一样的，除非是 apiserver 缓存和 etcd 数据出现不一致，这个概率极小，我们这里不讨论。\u003c/p\u003e\n\n\u003ch3 id=\"速度差异很大\"\u003e速度差异很大\u003c/h3\u003e\n\n\u003cp\u003e用 time 测量以上两种情况下的耗时，会发现对于大一些的集群，这两种请求的响应时间就会有明显差异。\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003etime\u003c/span\u003e ./curl-k8s-apiserver.sh \u0026lt;url\u0026gt; \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e result\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对于 4K nodes, 100K pods 规模的集群，以下数据供参考：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e不带 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion=0\u003c/code\u003e（读 etcd 并在 apiserver 过滤）: 耗时 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e10s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n  \u003cli\u003e带 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion=0\u003c/code\u003e（读 apiserver 缓存）: 耗时 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e0.05s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e差了 200 倍。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e全量 pod 的总大小按 2GB 计算，平均每个 20KB。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch1 id=\"4-list-请求对控制平面压力量化分析\"\u003e4 LIST 请求对控制平面压力：量化分析\u003c/h1\u003e\n\n\u003cp\u003e本节以 cilium-agent 为例，介绍定量测量它启动时对控制平面压力。\u003c/p\u003e\n\n\u003ch2 id=\"41-收集-list-请求\"\u003e4.1 收集 LIST 请求\u003c/h2\u003e\n\n\u003cp\u003e首先获取 agent 启动时，都 LIST k8s 哪些资源。有几种收集方式：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e在 k8s access log，按 ServiceAccount、verb、request_uri 等过滤；\u003c/li\u003e\n  \u003cli\u003e通过 agent 日志；\u003c/li\u003e\n  \u003cli\u003e通过进一步代码分析等等。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e假设我们收集到如下 LIST 请求：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapi/v1/namespaces?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapi/v1/pods?filedSelector=spec.nodeName%3Dnode1\u0026amp;resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapi/v1/nodes?fieldSelector=metadata.name%3Dnode1\u0026amp;resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapi/v1/services?labelSelector=%21service.kubernetes.io%2Fheadless%2C%21service.kubernetes.io%2Fservice-proxy-name\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapis/discovery.k8s.io/v1beta1/endpointslices?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapis/networking.k8s.io/networkpolicies?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapis/cilium.io/v2/ciliumnodes?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapis/cilium.io/v2/ciliumnetworkpolicies?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapis/cilium.io/v2/ciliumclusterwidenetworkpolicies?resourceVersion=0\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"22-测试-list-请求数据量和耗时\"\u003e2.2 测试 LIST 请求数据量和耗时\u003c/h2\u003e\n\n\u003cp\u003e有了 LIST 请求列表，接下来就可以手动执行这些请求，拿到如下数据：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e请求耗时\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e请求处理的数据量，这里分为两种：\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003eapiserver 处理的数据量（全量数据），评估对 apiserver/etcd 的性能影响应该以这个为主\u003c/li\u003e\n      \u003cli\u003eagent 最终拿到的数据量（按 selector 做了过滤）\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e用下面这个脚本（放到真实环境 k8s master 上）来就可以执行一遍测试，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat \u003c/span\u003ebenchmark-list-overheads.sh\n\u003cspan class=\"nv\"\u003eapiserver_url\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;https://localhost:6443\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# List k8s core resources (e.g. pods, services)\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# API: GET/LIST /api/v1/\u0026lt;resources\u0026gt;?\u0026lt;fileld/label selector\u0026gt;\u0026amp;resourceVersion=0\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunction \u003c/span\u003ebenchmark_list_core_resource\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eresource\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eselectors\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\n\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;----------------------------------------------------\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Benchmarking list \u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003elisted_file\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;listed-\u003c/span\u003e\u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$apiserver_url\u003c/span\u003e\u003cspan class=\"s2\"\u003e/api/v1/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e\u003cspan class=\"s2\"\u003e?resourceVersion=0\u0026#34;\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e# first perform a request without selectors, this is the size apiserver really handles\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;curl \u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003etime\u003c/span\u003e ./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file\u003c/span\u003e\n\n    \u003cspan class=\"c\"\u003e# perform another request if selectors are provided, this is the size client receives\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003elisted_file2\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$listed_file\u003c/span\u003e\u003cspan class=\"s2\"\u003e-filtered\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"nt\"\u003e-z\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$selectors\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\n        \u003c/span\u003e\u003cspan class=\"nv\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$selectors\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;curl \u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"nb\"\u003etime\u003c/span\u003e ./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file2\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efi\n\n    \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e \u003cspan class=\"nt\"\u003e-ahl\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file2\u003c/span\u003e 2\u0026gt;/dev/null\n\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;----------------------------------------------------\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# List k8s apiextension resources (e.g. pods, services)\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# API: GET/LIST /apis/\u0026lt;api group\u0026gt;/\u0026lt;resources\u0026gt;?\u0026lt;fileld/label selector\u0026gt;\u0026amp;resourceVersion=0\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunction \u003c/span\u003ebenchmark_list_apiexternsion_resource\u003cspan class=\"o\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eapi_group\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$1\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eresource\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$2\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eselectors\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nv\"\u003e$3\u003c/span\u003e\n\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;----------------------------------------------------\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Benchmarking list \u003c/span\u003e\u003cspan class=\"nv\"\u003e$api_group\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eapi_group_flatten_name\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nv\"\u003e$api_group\u003c/span\u003e | \u003cspan class=\"nb\"\u003esed\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;s/\\//-/g\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003elisted_file\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;listed-\u003c/span\u003e\u003cspan class=\"nv\"\u003e$api_group_flatten_name\u003c/span\u003e\u003cspan class=\"s2\"\u003e-\u003c/span\u003e\u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nv\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$apiserver_url\u003c/span\u003e\u003cspan class=\"s2\"\u003e/apis/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$api_group\u003c/span\u003e\u003cspan class=\"s2\"\u003e/\u003c/span\u003e\u003cspan class=\"nv\"\u003e$resource\u003c/span\u003e\u003cspan class=\"s2\"\u003e?resourceVersion=0\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e \u003cspan class=\"nt\"\u003e-z\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$selectors\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\n        \u003c/span\u003e\u003cspan class=\"nv\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$selectors\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efi\n\n    \u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;curl \u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003etime\u003c/span\u003e ./curl-k8s-apiserver.sh \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$url\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003els\u003c/span\u003e \u003cspan class=\"nt\"\u003e-ahl\u003c/span\u003e \u003cspan class=\"nv\"\u003e$listed_file\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;----------------------------------------------------\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\nbenchmark_list_core_resource \u003cspan class=\"s2\"\u003e\u0026#34;namespaces\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_core_resource \u003cspan class=\"s2\"\u003e\u0026#34;pods\u0026#34;\u003c/span\u003e       \u003cspan class=\"s2\"\u003e\u0026#34;filedSelector=spec.nodeName%3Dnode1\u0026#34;\u003c/span\u003e\nbenchmark_list_core_resource \u003cspan class=\"s2\"\u003e\u0026#34;nodes\u0026#34;\u003c/span\u003e      \u003cspan class=\"s2\"\u003e\u0026#34;fieldSelector=metadata.name%3Dnode1\u0026#34;\u003c/span\u003e\nbenchmark_list_core_resource \u003cspan class=\"s2\"\u003e\u0026#34;services\u0026#34;\u003c/span\u003e   \u003cspan class=\"s2\"\u003e\u0026#34;labelSelector=%21service.kubernetes.io%2Fheadless%2C%21service.kubernetes.io%2Fservice-proxy-name\u0026#34;\u003c/span\u003e\n\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;discovery.k8s.io/v1beta1\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;endpointslices\u0026#34;\u003c/span\u003e                   \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;apiextensions.k8s.io/v1\u0026#34;\u003c/span\u003e  \u003cspan class=\"s2\"\u003e\u0026#34;customresourcedefinitions\u0026#34;\u003c/span\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;networking.k8s.io\u0026#34;\u003c/span\u003e        \u003cspan class=\"s2\"\u003e\u0026#34;networkpolicies\u0026#34;\u003c/span\u003e                  \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;cilium.io/v2\u0026#34;\u003c/span\u003e             \u003cspan class=\"s2\"\u003e\u0026#34;ciliumnodes\u0026#34;\u003c/span\u003e                      \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;cilium.io/v2\u0026#34;\u003c/span\u003e             \u003cspan class=\"s2\"\u003e\u0026#34;ciliumendpoints\u0026#34;\u003c/span\u003e                  \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;cilium.io/v2\u0026#34;\u003c/span\u003e             \u003cspan class=\"s2\"\u003e\u0026#34;ciliumnetworkpolicies\u0026#34;\u003c/span\u003e            \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\nbenchmark_list_apiexternsion_resource \u003cspan class=\"s2\"\u003e\u0026#34;cilium.io/v2\u0026#34;\u003c/span\u003e             \u003cspan class=\"s2\"\u003e\u0026#34;ciliumclusterwidenetworkpolicies\u0026#34;\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e执行效果如下：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ebenchmark-list-overheads.sh\n\u003cspan class=\"nt\"\u003e----------------------------------------------------\u003c/span\u003e\nBenchmarking list\ncurl https://localhost:6443/api/v1/namespaces?resourceVersion\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\n\nreal    0m0.090s\nuser    0m0.038s\nsys     0m0.044s\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 69K listed-namespaces\n\u003cspan class=\"nt\"\u003e----------------------------------------------------\u003c/span\u003e\n\nBenchmarking list \u003cspan class=\"nv\"\u003efieldSelector\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003espec.nodeName%3Dnode1\ncurl https://localhost:6443/api/v1/pods?resourceVersion\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\n\nreal    0m18.332s\nuser    0m1.355s\nsys     0m1.822s\ncurl https://localhost:6443/api/v1/pods?resourceVersion\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\u0026amp;fieldSelector\u003cspan class=\"o\"\u003e=\u003c/span\u003espec.nodeName%3Dnode1\n\nreal    0m0.242s\nuser    0m0.044s\nsys     0m0.188s\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 2.0G listed-pods\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 526K listed-pods-filtered\n\u003cspan class=\"nt\"\u003e----------------------------------------------------\u003c/span\u003e\n\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e说明：凡是带了 selector 的 LIST，例如 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLIST\npods?spec.nodeName=node1\u003c/code\u003e，这个脚本会先执行一遍不带 selector 的请求，目的是测量\napiserver 需要处理的数据量，例如上面的 list pods：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eagent 真正执行的是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epods?resourceVersion=0\u0026amp;fieldSelector=spec.nodeName%3Dnode1\u003c/code\u003e，所以请求耗时应该以这个为准\u003c/li\u003e\n  \u003cli\u003e额外执行了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epods?resourceVersion=0\u003c/code\u003e，这样是为了测试 1 的请求到底需要 apiserver 处理多少数据量\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e注意： list all pods 这样的操作会产生 2GB 的文件，因此谨慎使用这个 benchmark 工具，首先理解你写的脚本在测什么，尤其不要自动化或并发跑，可能会把 apiserver/etcd 打爆。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch2 id=\"43-测试结果分析\"\u003e4.3 测试结果分析\u003c/h2\u003e\n\n\u003cp\u003e以上输出有如下关键信息：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eLIST 的资源类型，例如 pods/endpoints/services\u003c/li\u003e\n  \u003cli\u003eLIST 操作耗时\u003c/li\u003e\n  \u003cli\u003eLIST 操作涉及的数据量\n    \u003col\u003e\n      \u003cli\u003eapiserver 需要处理的数据量（json 格式）：以上面 list pods 为例，对应的是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elisted-pods\u003c/code\u003e 文件，共 2GB；\u003c/li\u003e\n      \u003cli\u003eagent 收到的数据量（因为 agent 可能指定了 label/field 过滤器）：以上面 list pods 为例，对应 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elisted-pods-filtered\u003c/code\u003e 文件，共计 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e526K\u003c/code\u003e\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e按以上方式将所有 LIST 请求都收集起来并排序，就知道了 agent 一次启动操作，对 apiserver/etcd 的压力。\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e \u003cspan class=\"nt\"\u003e-ahl\u003c/span\u003e listed-\u003cspan class=\"k\"\u003e*\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  222 listed-apiextensions.k8s.io-v1-customeresourcedefinitions\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 5.8M listed-apiextensions.k8s.io-v1-customresourcedefinitions\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 2.0M listed-cilium.io-v2-ciliumclusterwidenetworkpolicies\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 193M listed-cilium.io-v2-ciliumendpoints\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  185 listed-cilium.io-v2-ciliumnetworkpolicies\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 6.6M listed-cilium.io-v2-ciliumnodes\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  42M listed-discovery.k8s.io-v1beta1-endpointslices\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  69K listed-namespaces\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  222 listed-networking.k8s.io-networkpolicies\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  70M listed-nodes    \u003cspan class=\"c\"\u003e# 仅用于评估 apiserver 需要处理的数据量\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  25K listed-nodes-filtered\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 2.0G listed-pods     \u003cspan class=\"c\"\u003e# 仅用于评估 apiserver 需要处理的数据量\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root 526K listed-pods-filtered\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  23M listed-services \u003cspan class=\"c\"\u003e# 仅用于评估 apiserver 需要处理的数据量\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e-rw-r--r--\u003c/span\u003e 1 root root  23M listed-services-filtered\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e还是以 cilium 为例，有大致这样一个排序（apiserver 处理的数据量，json 格式）：\u003c/p\u003e\n\n\u003ctable\u003e\n  \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth style=\"text-align: left\"\u003eList 资源类型\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eapiserver 处理的数据量（json）\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003e耗时\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eCiliumEndpoints (全量）\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e193MB\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e11s\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eCiliumNodes (全量）\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e70MB\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e0.5s\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003e…\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e…\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e…\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch1 id=\"5-大规模基础服务部署和调优建议\"\u003e5 大规模基础服务：部署和调优建议\u003c/h1\u003e\n\n\u003ch2 id=\"51-list-请求默认设置-resourceversion0\"\u003e5.1 List 请求默认设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion=0\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e前面已经介绍，不设置这个参数将导致 apiserver 从 etcd 拉全量数据再过滤，导致\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e很慢\u003c/li\u003e\n  \u003cli\u003e规模大了 etcd 扛不住\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e因此，除非对数据准确性要求极高，必须从 etcd 拉数据，否则应该在 LIST 请求时设置\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion=0\u003c/code\u003e 参数， 让 apiserver 用缓存提供服务。\u003c/p\u003e\n\n\u003cp\u003e如果你使用的是 \u003cstrong\u003e\u003cmark\u003eclient-go 的 ListWatch/informer 接口\u003c/mark\u003e\u003c/strong\u003e，\n那它默认已经设置了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion=0\u003c/code\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"52-优先使用-namespaced-api\"\u003e5.2 优先使用 namespaced API\u003c/h2\u003e\n\n\u003cp\u003e如果要 LIST 的资源在单个或少数几个 namespace，考虑使用 namespaced API：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eNamespaced API: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/api/v1/namespaces/\u0026lt;ns\u0026gt;/pods?query=xxx\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003eUn-namespaced API: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/api/v1/pods?query=xxx\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"53-restart-backoff\"\u003e5.3 Restart backoff\u003c/h2\u003e\n\n\u003cp\u003e对于 per-node 部署的基础服务，例如 kubelet、cilium-agent、daemonsets，需要\n通过有效的 restart backoff 降低大面积重启时对控制平面的压力。\u003c/p\u003e\n\n\u003cp\u003e例如，同时挂掉后，每分钟重启的 agent\n数量不超过集群规模的 10%（可配置，或可自动计算）。\u003c/p\u003e\n\n\u003ch2 id=\"54-优先通过-labelfield-selector-在服务端做过滤\"\u003e5.4 优先通过 label/field selector 在服务端做过滤\u003c/h2\u003e\n\n\u003cp\u003e如果需要缓存某些资源并监听变动，那需要使用 ListWatch 机制，将数据拉到本地，业务逻辑根据需要自己从 local cache 过滤。\n这是 client-go 的 ListWatch/informer 机制。\u003c/p\u003e\n\n\u003cp\u003e但如果只是一次性的 LIST 操作，并且有筛选条件，例如前面提到的根据 nodename 过滤 pod 的例子，\n那显然应该通过设置 label 或字段过滤器，让 apiserver 帮我们把数据过滤出来。\nLIST 10w pods 需要几十秒（大部分时间花在数据传输上，同时也占用 apiserver 大量 CPU/BW/IO），\n而如果只需要本机上的 pod，那设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enodeName=node1\u003c/code\u003e 之后，LIST 可能只需要 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0.05s\u003c/code\u003e 就能返回结果。\n另外非常重要的一点时，不要忘记在请求中同时带上 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eresourceVersion=0\u003c/code\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"541-label-selector\"\u003e5.4.1 Label selector\u003c/h3\u003e\n\n\u003cp\u003e在 apiserver 内存过滤。\u003c/p\u003e\n\n\u003ch3 id=\"542-field-selector\"\u003e5.4.2 Field selector\u003c/h3\u003e\n\n\u003cp\u003e在 apiserver 内存过滤。\u003c/p\u003e\n\n\u003ch3 id=\"543-namespace-selector\"\u003e5.4.3 Namespace selector\u003c/h3\u003e\n\n\u003cp\u003eetcd 中 namespace 是前缀的一部分，因此能指定 namespace 过滤资源，速度比不是前缀的 selector 快很多。\u003c/p\u003e\n\n\u003ch2 id=\"55-配套基础设施监控告警等\"\u003e5.5 配套基础设施（监控、告警等）\u003c/h2\u003e\n\n\u003cp\u003e以上分析可以看成，client 的单个请求可能只返回几百 KB 的数据，但 apiserver（更糟糕的情况，etcd）需要处理上 GB 的数据。\n因此，应该极力避免基础服务的大规模重启，为此需要在监控、告警上做的尽量完善。\u003c/p\u003e\n\n\u003ch3 id=\"551-使用独立-serviceaccount\"\u003e5.5.1 使用独立 ServiceAccount\u003c/h3\u003e\n\n\u003cp\u003e每个基础服务（例如 kubelet、cilium-agent 等），以及对 apiserver 有大量 LIST 操作的各种 operator，\n都使用各自独立的 SA，\n这样便于 apiserver 区分请求来源，对监控、排障和服务端限流都非常有用。\u003c/p\u003e\n\n\u003ch3 id=\"552-liveness-监控告警\"\u003e5.5.2 Liveness 监控告警\u003c/h3\u003e\n\n\u003cp\u003e基础服务必须覆盖到 liveness 监控。\u003c/p\u003e\n\n\u003cp\u003e必须有 P1 级别的 liveness 告警，能第一时间发现大规模挂掉的场景。然后通过 restart backoff 降低对控制平面的压力。\u003c/p\u003e\n\n\u003ch3 id=\"553-监控和调优-etcd\"\u003e5.5.3 监控和调优 etcd\u003c/h3\u003e\n\n\u003cp\u003e需要针对性能相关的关键指标做好监控和告警：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e内存\u003c/li\u003e\n  \u003cli\u003e带宽\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e大 LIST 请求数量及响应耗时\u003c/p\u003e\n\n    \u003cp\u003e比如下面这个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLIST all pods\u003c/code\u003e 日志：\u003c/p\u003e\n\n    \u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;level\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;warn\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;apply request took too long\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;took\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;5357.87304ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;expected-duration\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;100ms\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;prefix\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;read-only range \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;request\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;key:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/registry/pods/\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e range_end:\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e/registry/pods0\u003c/span\u003e\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e\u003cspan class=\"s2\"\u003e \u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n     \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;response\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;range_response_count:60077 size:602251227\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e    \u003c/div\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e部署和配置调优：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eK8s events 拆到单独的 etcd 集群\u003c/li\u003e\n  \u003cli\u003e其他。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"6-其他\"\u003e6 其他\u003c/h1\u003e\n\n\u003ch2 id=\"61-get-请求getoptions\"\u003e6.1 Get 请求：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGetOptions{}\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e基本原理与 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eListOption{}\u003c/code\u003e 一样，不设置 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eResourceVersion=0\u003c/code\u003e 会导致 apiserver 去\netcd 拿数据，应该尽量避免。语义[3]：\u003c/p\u003e\n\n\u003ctable\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eresourceVersion unset\u003c/td\u003e\n      \u003ctd\u003eresourceVersion=”0”\u003c/td\u003e\n      \u003ctd\u003eresourceVersion=”{value other than 0}”\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd\u003eMost Recent\u003c/td\u003e\n      \u003ctd\u003eAny\u003c/td\u003e\n      \u003ctd\u003eNot older than\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cul\u003e\n  \u003cli\u003eMost Recent：去 etcd 拿数据；\u003c/li\u003e\n  \u003cli\u003eAny：优先用最新的，但不保证一定是最新的；\u003c/li\u003e\n  \u003cli\u003eNot older than：不低于某个版本号。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/\"\u003eKubernetes API Concepts\u003c/a\u003e, kubernetes doc\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/raft-paper-zh/\"\u003e(译) [论文] Raft 共识算法（及 etcd/raft 源码解析）（USENIX, 2014）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/#the-resourceversion-parameter\"\u003eKubernetes API Concepts: Resource version semantics\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/bpf-advanced-notes-4-zh/\"\u003e\u003cspan\u003e« BPF 进阶笔记（四）：调试 BPF 程序\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/k8s-is-about-apis-zh/\"\u003e\u003cspan\u003eK8s 的核心是 API 而非容器（一）：从理论到 CRD 实践（2022） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2022-05-19T00:00:00Z",
  "Author": "Arthur Chiao"
}