{
  "Source": "arthurchiao.art",
  "Title": "GPU 进阶笔记（一）：高性能 GPU 服务器硬件拓扑与集群组网（2023）",
  "Link": "https://arthurchiao.art/blog/gpu-advanced-notes-1-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eGPU 进阶笔记（一）：高性能 GPU 服务器硬件拓扑与集群组网（2023）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2023-09-16 | Last Update 2023-12-03\u003c/p\u003e\n  \n  \u003cp\u003e记录一些平时接触到的 GPU 知识。由于是笔记而非教程，因此内容不会追求连贯，有基础的同学可作查漏补缺之用。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-a100-node-hw-topo.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e水平有限，文中不免有错误或过时之处，请酌情参考。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"/blog/gpu-advanced-notes-1-zh/\"\u003eGPU 进阶笔记（一）：高性能 GPU 服务器硬件拓扑与集群组网（2023）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/gpu-advanced-notes-2-zh/\"\u003eGPU 进阶笔记（二）：华为昇腾 910B GPU 相关（2023）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/gpu-advanced-notes-3-zh/\"\u003eGPU 进阶笔记（三）：华为 NPU (GPU) 演进（2024）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-术语与基础\" id=\"markdown-toc-1-术语与基础\"\u003e1 术语与基础\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-pcie-交换芯片\" id=\"markdown-toc-11-pcie-交换芯片\"\u003e1.1 PCIe 交换芯片\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-nvlink\" id=\"markdown-toc-12-nvlink\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNVLink\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#定义\" id=\"markdown-toc-定义\"\u003e定义\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#演进1234-代\" id=\"markdown-toc-演进1234-代\"\u003e演进：1/2/3/4 代\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#监控\" id=\"markdown-toc-监控\"\u003e监控\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-nvswitch\" id=\"markdown-toc-13-nvswitch\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNVSwitch\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-nvlink-switch\" id=\"markdown-toc-14-nvlink-switch\"\u003e1.4 NVLink Switch\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#15-hbm-high-bandwidth-memory\" id=\"markdown-toc-15-hbm-high-bandwidth-memory\"\u003e1.5 HBM (High Bandwidth Memory)\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#由来\" id=\"markdown-toc-由来\"\u003e由来\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#演进hbm-122e33e\" id=\"markdown-toc-演进hbm-122e33e\"\u003e演进：HBM 1/2/2e/3/3e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#16-带宽单位\" id=\"markdown-toc-16-带宽单位\"\u003e1.6 带宽单位\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-典型-8a1008a800-主机\" id=\"markdown-toc-2-典型-8a1008a800-主机\"\u003e2 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e8*A100/8*A800\u003c/code\u003e 主机\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-主机内拓扑2-2-4-6-8-8\" id=\"markdown-toc-21-主机内拓扑2-2-4-6-8-8\"\u003e2.1 主机内拓扑：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-4-6-8-8\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#存储网卡\" id=\"markdown-toc-存储网卡\"\u003e存储网卡\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#nvswitch-fabricintra-node-full-mesh\" id=\"markdown-toc-nvswitch-fabricintra-node-full-mesh\"\u003eNVSwitch fabric：\u003cmark\u003eintra-node\u003c/mark\u003e full-mesh\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#用-nvidia-smi-topo-查看拓扑\" id=\"markdown-toc-用-nvidia-smi-topo-查看拓扑\"\u003e用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003envidia-smi topo\u003c/code\u003e 查看拓扑\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-gpu-训练集群组网idc-gpu-fabirc\" id=\"markdown-toc-12-gpu-训练集群组网idc-gpu-fabirc\"\u003e1.2 GPU 训练集群组网：IDC GPU fabirc\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#计算网络\" id=\"markdown-toc-计算网络\"\u003e计算网络\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#存储网络\" id=\"markdown-toc-存储网络\"\u003e存储网络\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#roce-vs-infiniband\" id=\"markdown-toc-roce-vs-infiniband\"\u003eRoCE vs. InfiniBand\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-数据链路带宽瓶颈分析\" id=\"markdown-toc-13-数据链路带宽瓶颈分析\"\u003e1.3 数据链路带宽瓶颈分析\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-典型-8h1008h800-主机\" id=\"markdown-toc-3-典型-8h1008h800-主机\"\u003e3 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e8*H100/8*H800\u003c/code\u003e 主机\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-h100-芯片-layout\" id=\"markdown-toc-31-h100-芯片-layout\"\u003e3.1 H100 芯片 layout\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-主机内硬件拓扑\" id=\"markdown-toc-32-主机内硬件拓扑\"\u003e3.2 主机内硬件拓扑\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-组网\" id=\"markdown-toc-33-组网\"\u003e3.3 组网\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-典型-4l40s8l40s-主机\" id=\"markdown-toc-4-典型-4l40s8l40s-主机\"\u003e4 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e4*L40S/8*L40S\u003c/code\u003e 主机\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-l40s-vs-a100-配置及特点对比\" id=\"markdown-toc-41-l40s-vs-a100-配置及特点对比\"\u003e4.1 L40S vs A100 配置及特点对比\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-l40s-与-a100-性能对比\" id=\"markdown-toc-42-l40s-与-a100-性能对比\"\u003e4.2 L40S 与 A100 性能对比\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-l40s-攒机\" id=\"markdown-toc-43-l40s-攒机\"\u003e4.3 L40S 攒机\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#推荐架构2-2-4\" id=\"markdown-toc-推荐架构2-2-4\"\u003e推荐架构：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-4\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#不推荐架构2-2-8\" id=\"markdown-toc-不推荐架构2-2-8\"\u003e不推荐架构：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-8\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-组网\" id=\"markdown-toc-44-组网\"\u003e4.4 组网\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#45-数据链路带宽瓶颈分析\" id=\"markdown-toc-45-数据链路带宽瓶颈分析\"\u003e4.5 数据链路带宽瓶颈分析\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#46-测试注意事项\" id=\"markdown-toc-46-测试注意事项\"\u003e4.6 测试注意事项\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-术语与基础\"\u003e1 术语与基础\u003c/h1\u003e\n\n\u003cp\u003e大模型训练一般都是用单机 8 卡 GPU 主机组成集群，机型包括 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e8*{A100,A800,H100,H800}\u003c/code\u003e\n\u003cdel\u003e可能还会用最近即将上市的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e{4,8}*L40S\u003c/code\u003e 等\u003c/del\u003e。\n下面一台典型 8*A100 GPU 的主机内硬件拓扑：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-a100-node-hw-topo.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e典型 8 卡 A100 主机硬件拓扑\u003c/p\u003e\n\n\u003cp\u003e本节将基于这张图来介绍一些概念和术语，有基础的可直接跳过。\u003c/p\u003e\n\n\u003ch2 id=\"11-pcie-交换芯片\"\u003e1.1 PCIe 交换芯片\u003c/h2\u003e\n\n\u003cp\u003eCPU、内存、存储（NVME）、GPU、网卡等\u003cstrong\u003e\u003cmark\u003e支持 PICe 的设备\u003c/mark\u003e\u003c/strong\u003e，都可以连接到\nPCIe 总线或专门的 PCIe 交换芯片，实现互联互通。\u003c/p\u003e\n\n\u003cp\u003ePCIe 目前有 5 代产品，最新的是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eGen5\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"12-nvlink\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNVLink\u003c/code\u003e\u003c/h2\u003e\n\n\u003ch3 id=\"定义\"\u003e定义\u003c/h3\u003e\n\n\u003cp\u003eWikipedia 上 \u003ca href=\"https://en.wikipedia.org/wiki/NVLink\"\u003eNVLink\u003c/a\u003e 上的定义：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eNVLink is a wire-based serial multi-lane near-range communications link\ndeveloped by Nvidia. Unlike PCI Express, a device can consist of multiple\nNVLinks, and devices use mesh networking to communicate instead of a central\nhub. The protocol was first announced in March 2014 and uses a proprietary\nhigh-speed signaling interconnect (NVHS).\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e简单总结：同主机内不同 GPU 之间的一种高速互联方式，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e是一种短距离\u003cstrong\u003e\u003cmark\u003e通信链路\u003c/mark\u003e\u003c/strong\u003e，保证包的成功传输，更高性能，替代 PCIe，\u003c/li\u003e\n  \u003cli\u003e支持多 lane，link 带宽随 lane 数量线性增长，\u003c/li\u003e\n  \u003cli\u003e同一台 node 内的 GPU 通过 NVLink 以 \u003cstrong\u003e\u003cmark\u003efull-mesh\u003c/mark\u003e\u003c/strong\u003e 方式（类似 spine-leaf）互联，\u003c/li\u003e\n  \u003cli\u003eNVIDIA 专利技术。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"演进1234-代\"\u003e演进：1/2/3/4 代\u003c/h3\u003e\n\n\u003cp\u003e主要区别是单条 NVLink 链路的 \u003cstrong\u003e\u003cmark\u003elane 数量\u003c/mark\u003e\u003c/strong\u003e、每个 \u003cstrong\u003e\u003cmark\u003elane 的带宽\u003c/mark\u003e\u003c/strong\u003e（图中给的都是双向带宽）等：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/nvlink-generations.png\" width=\"90%\" height=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eNVLink 演进。Image from: HotChips 2022 [1]\u003c/p\u003e\n\n\u003cp\u003e例如，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eA100 是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e2 lanes/NVSwitch * 6 NVSwitch * 50GB/s/lane= 600GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 双向带宽（单向 300GB/s）。注意：这是\u003cstrong\u003e\u003cmark\u003e一个 GPU 到所有 NVSwitch 的总带宽\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003eA800 被阉割了 4 条 lane，所以是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e8 lane * 50GB/s/lane = 400GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 双向带宽（单向 200GB/s）。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"监控\"\u003e监控\u003c/h3\u003e\n\n\u003cp\u003e基于 DCGM 可以采集到实时 NVLink 带宽：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/understanding-gpu-performance/dcgm-metrics-2.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eMetrics from dcgm-exporter [5]\u003c/p\u003e\n\n\u003ch2 id=\"13-nvswitch\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNVSwitch\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e还是参考下图，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-a100-node-hw-topo.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e典型 8 卡 A100 主机硬件拓扑\u003c/p\u003e\n\n\u003cp\u003eNVSwitch 是 NVIDIA 的一款\u003cstrong\u003e\u003cmark\u003e交换芯片\u003c/mark\u003e\u003c/strong\u003e，封装在 GPU module 上，并\u003cstrong\u003e\u003cmark\u003e不是主机外的独立交换机\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e下面是真机图，浪潮的机器，图中 8 个盒子就是 8 片 A100，右边的 6 块超厚散热片下面就是 NVSwitch 芯片：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/inspur-nf5488a5-hgx-a100.jpg\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eInspur NF5488A5 NVIDIA HGX A100 8 GPU Assembly Side View. Image source: [2]\u003c/p\u003e\n\n\u003ch2 id=\"14-nvlink-switch\"\u003e1.4 NVLink Switch\u003c/h2\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNVSwitch\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 听名字像是交换机，但实际上是 GPU module 上的交换芯片，用来\u003cstrong\u003e\u003cmark\u003e连接同一台主机内的 GPU\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e2022 年，NVIDIA 把这块芯片拿出来真的做成了交换机，叫 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNVLink Switch\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e [3]，\n用来\u003cstrong\u003e\u003cmark\u003e跨主机连接 GPU 设备\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e这俩名字很容易让人混淆。\u003c/p\u003e\n\n\u003ch2 id=\"15-hbm-high-bandwidth-memory\"\u003e1.5 HBM (High Bandwidth Memory)\u003c/h2\u003e\n\n\u003ch3 id=\"由来\"\u003e由来\u003c/h3\u003e\n\n\u003cp\u003e传统上，GPU 显存和普通内存（DDR）一样插在主板上，通过 PCIe 连接到处理器（CPU、GPU），\n因此速度瓶颈在 PCIe，Gen4 是 64GB/s，Gen5 是 128GB/s。\u003c/p\u003e\n\n\u003cp\u003e因此，一些 GPU 厂商（不是只有 NVIDIA 一家这么做）将\u003cstrong\u003e\u003cmark\u003e将多个 DDR 芯片堆叠之后与 GPU 封装到一起\u003c/mark\u003e\u003c/strong\u003e\n（后文讲到 H100 时有图），这样每片 GPU 和它自己的显存交互时，就不用再去 PCIe 交换芯片绕一圈，速度最高可以提升一个量级。\n这种\u003cstrong\u003e\u003cmark\u003e“高带宽内存”\u003c/mark\u003e\u003c/strong\u003e（High Bandwidth Memory）缩写就是 HBM。\u003c/p\u003e\n\n\u003cp\u003eHBM 的市场目前被 SK 海力士和三星等韩国公司垄断。\u003c/p\u003e\n\n\u003ch3 id=\"演进hbm-122e33e\"\u003e演进：HBM 1/2/2e/3/3e\u003c/h3\u003e\n\n\u003cp\u003eFrom wikipedia \u003ca href=\"https://en.wikipedia.org/wiki/High_Bandwidth_Memory\"\u003eHBM\u003c/a\u003e，\u003c/p\u003e\n\n\u003ctable\u003e\n  \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth style=\"text-align: left\"\u003e \u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eBandwidth\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eYear\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eGPU\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eHBM\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e128GB/s/package\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e \u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e \u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eHBM2\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e256GB/s/package\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e2016\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eV100\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eHBM2e\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e~450GB/s\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e2018\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eA100, ~2TB/s\u003c/code\u003e; 华为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eAscend 910B\u003c/code\u003e\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eHBM3\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e600GB/s/site\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e2020\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eH100, 3.35TB/s\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eHBM3e\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e~1TB/s\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e2023\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eH200\u003c/code\u003e, \u003ca href=\"https://www.nvidia.com/en-us/data-center/h200/\"\u003e4.8TB/s\u003c/a\u003e\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/nvidia-gpus-hbm.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e使用了 HBM 的近几代高端 NVIDIA GPU \u003cmark\u003e显存带宽\u003c/mark\u003e（双向），纵坐标是 TB/s。Image source: [3]\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eAMD MI300X 采用 192GB HBM3 方案，带宽 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e5.2TB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003eHBM3e 是 HBM3 的增强版，速度从 6.4GT/s 到 8GT/s。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"16-带宽单位\"\u003e1.6 带宽单位\u003c/h2\u003e\n\n\u003cp\u003e大规模 GPU 训练的性能与数据传输速度有直接关系。这里面涉及到很多链路，比如 PCIe 带宽、内存带宽、NVLink 带宽、HBM 带宽、网络带宽等等。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e网络习惯用 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ebits/second (b/s)\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 表示之外，并且一般说的都是\u003cstrong\u003e\u003cmark\u003e单向\u003c/mark\u003e\u003c/strong\u003e（TX/RX）；\u003c/li\u003e\n  \u003cli\u003e其他模块带宽基本用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebyte/sedond (B/s)\u003c/code\u003e 或 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etransactions/second (T/s)\u003c/code\u003e 表示，并且一般都是\u003cstrong\u003e\u003cmark\u003e双向总带宽\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e比较带宽时注意区分和转换。\u003c/p\u003e\n\n\u003ch1 id=\"2-典型-8a1008a800-主机\"\u003e2 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e8*A100/8*A800\u003c/code\u003e 主机\u003c/h1\u003e\n\n\u003ch2 id=\"21-主机内拓扑2-2-4-6-8-8\"\u003e2.1 主机内拓扑：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-4-6-8-8\u003c/code\u003e\u003c/h2\u003e\n\n\u003cul\u003e\n  \u003cli\u003e2 片 CPU（及两边的内存，NUMA）\u003c/li\u003e\n  \u003cli\u003e2 张\u003cstrong\u003e\u003cmark\u003e存储网卡\u003c/mark\u003e\u003c/strong\u003e（\u003cstrong\u003e\u003cmark\u003e访问分布式存储\u003c/mark\u003e\u003c/strong\u003e，带内管理等）\u003c/li\u003e\n  \u003cli\u003e4 个 PCIe Gen4 Switch 芯片\u003c/li\u003e\n  \u003cli\u003e6 个 NVSwitch 芯片\u003c/li\u003e\n  \u003cli\u003e8 个 GPU\u003c/li\u003e\n  \u003cli\u003e8 个 \u003cstrong\u003e\u003cmark\u003eGPU 专属网卡\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-a100-node-hw-topo.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e典型 8 卡 A100 主机硬件拓扑\u003c/p\u003e\n\n\u003cp\u003e下面这个图画的更专业，需要更多细节的可参考：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/NVIDIA-DGX-A100-Block-Diagram.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eNVIDIA DGX A100 主机（\u003cmark\u003e官方 8 卡机器\u003c/mark\u003e）硬件拓扑。Image source: [4]\u003c/p\u003e\n\n\u003ch3 id=\"存储网卡\"\u003e存储网卡\u003c/h3\u003e\n\n\u003cp\u003e通过 PCIe \u003cstrong\u003e\u003cmark\u003e直连 CPU\u003c/mark\u003e\u003c/strong\u003e。用途：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e从分布式存储读写数据，例如\u003cstrong\u003e\u003cmark\u003e读训练数据\u003c/mark\u003e\u003c/strong\u003e、\u003cstrong\u003e\u003cmark\u003e写 checkpoint\u003c/mark\u003e\u003c/strong\u003e 等；\u003c/li\u003e\n  \u003cli\u003e正常的 node 管理，ssh，监控采集等等。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e官方推荐用 BF3 DPU。但其实只要带宽达标，用什么都行。组网经济点的话用 RoCE，追求最好的性能用 IB。\u003c/p\u003e\n\n\u003ch3 id=\"nvswitch-fabricintra-node-full-mesh\"\u003eNVSwitch fabric：\u003cmark\u003eintra-node\u003c/mark\u003e full-mesh\u003c/h3\u003e\n\n\u003cp\u003e8 个 GPU 通过 6 个 NVSwitch 芯片 full-mesh 连接，这个 full-mesh\n也叫 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNVSwitch fabric\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\nfull-mesh 里面的\u003cstrong\u003e\u003cmark\u003e每根线的带宽是 n * bw-per-nvlink-lane\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eA100 用的 NVLink3，\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e50GB/s/lane\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，所以 full-mesh\n里的每条线就是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e12*50GB/s=600GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，注意这个是双向带宽，单向只有 300GB/s。\u003c/li\u003e\n  \u003cli\u003eA800 是阉割版，\u003cstrong\u003e\u003cmark\u003e12 lane 变成 8 lane\u003c/mark\u003e\u003c/strong\u003e，所以每条线 8*50GB/s=400GB/s，单向 200GB/s。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"用-nvidia-smi-topo-查看拓扑\"\u003e用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003envidia-smi topo\u003c/code\u003e 查看拓扑\u003c/h3\u003e\n\n\u003cp\u003e下面是一台 8*A800 机器上 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003envidia-smi\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 显示的实际拓扑（网卡两两做了 bond，NIC 0~3 都是 bond）：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/nvidia-smi-topo-output.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eGPU 之间（左上角区域）：都是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNV8\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示 \u003cstrong\u003e\u003cmark\u003e8 条 NVLink\u003c/mark\u003e\u003c/strong\u003e 连接；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eNIC 之间：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e在同一片 CPU 上：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNODE\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示\u003cstrong\u003e\u003cmark\u003e不需要跨 NUMA，但需要跨 PCIe 交换芯片\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e不在同一片 CPU 上：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eSYS\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示\u003cstrong\u003e\u003cmark\u003e需要跨 NUMA\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003eGPU 和 NIC 之间：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e在同一片 CPU 上，且在同一个 PCIe Switch 芯片下面：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNODE\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示\u003cstrong\u003e\u003cmark\u003e只需要跨 PCIe 交换芯片\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e在同一片 CPU 上，且不在同一个 PCIe Switch 芯片下面：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eNODE\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示\u003cstrong\u003e\u003cmark\u003e需要跨 PCIe 交换芯片和 PCIe Host Bridge\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e不在同一片 CPU 上：\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eSYS\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，表示\u003cstrong\u003e\u003cmark\u003e需要跨 NUMA、PCIe 交换芯片，距离最远\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"12-gpu-训练集群组网idc-gpu-fabirc\"\u003e1.2 GPU 训练集群组网：IDC GPU fabirc\u003c/h2\u003e\n\n\u003cp\u003eGPU node 互联架构：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/a100-idc-network.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\n\u003ch3 id=\"计算网络\"\u003e计算网络\u003c/h3\u003e\n\n\u003cp\u003eGPU 网卡直连到置顶交换机（leaf），leaf 通过 full-mesh 连接到 spine，形成跨主机 GPU 计算网络。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e这个网络的目的是 GPU 与其他 node 的 GPU \u003cstrong\u003e\u003cmark\u003e交换数据\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e每个 GPU 和自己的网卡之间通过 \u003cstrong\u003e\u003cmark\u003ePCIe 交换芯片连接\u003c/mark\u003e\u003c/strong\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eGPU \u0026lt;--\u0026gt; PCIe Switch \u0026lt;--\u0026gt; NIC\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"存储网络\"\u003e存储网络\u003c/h3\u003e\n\n\u003cp\u003e直连 CPU 的两张网卡，连接到另一张网络里，主要作用是读写数据，以及 SSH 管理等等。\u003c/p\u003e\n\n\u003ch3 id=\"roce-vs-infiniband\"\u003eRoCE vs. InfiniBand\u003c/h3\u003e\n\n\u003cp\u003e不管是计算网络还是存储网络，都需要 RDMA 才能实现 AI 所需的高性能。RDMA 目前有两种选择：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eRoCEv2：公有云卖的 8 卡 GPU 主机基本都是这种网络，比如 CX6 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e8*100Gbps\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 配置；在性能达标的前提下，（相对）便宜；\u003c/li\u003e\n  \u003cli\u003eInfiniBand (IB)：同等网卡带宽下，性能比 RoCEv2 好 20% 以上，但是价格贵一倍。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"13-数据链路带宽瓶颈分析\"\u003e1.3 数据链路带宽瓶颈分析\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-a100-bw-limits.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e单机 8 卡 A100 GPU 主机带宽瓶颈分析\u003c/p\u003e\n\n\u003cp\u003e几个关键链路带宽都标在图上了，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e同主机 GPU 之间：走 NVLink，双向 600GB/s，单向 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e300GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e同主机 GPU 和自己的网卡之间：走 PICe Gen4 Switch 芯片，双向 64GB/s，单向 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e32GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e跨主机 GPU 之间：需要通过网卡收发数据，这个就看网卡带宽了，目前国内 A100/A800\n  机型配套的主流带宽是（单向） \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e100Gbps=12.5GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\n  所以跨机通信相比主机内通信性能要下降很多。\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e200Gbps==25GB/s\u003c/code\u003e：已经\u003cstrong\u003e\u003cmark\u003e接近\u003c/mark\u003e\u003c/strong\u003e PCIe Gen4 的单向带宽；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e400Gbps==50GB/s\u003c/code\u003e：已经\u003cstrong\u003e\u003cmark\u003e超过\u003c/mark\u003e\u003c/strong\u003e PCIe Gen4 的单向带宽。\u003c/li\u003e\n    \u003c/ul\u003e\n\n    \u003cp\u003e所以在这种机型里用 400Gbps 网卡作用不大，400Gbps 需要 PCIe Gen5 性能才能发挥出来。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"3-典型-8h1008h800-主机\"\u003e3 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e8*H100/8*H800\u003c/code\u003e 主机\u003c/h1\u003e\n\n\u003cp\u003eGPU Board Form Factor 分为两种类型：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003ePCIe Gen5\u003c/li\u003e\n  \u003cli\u003eSXM5：性能更高一些\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"31-h100-芯片-layout\"\u003e3.1 H100 芯片 layout\u003c/h2\u003e\n\n\u003cp\u003e下面是一片 H100 GPU 芯片的内部结构：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/h100-chip-layout.jpg\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e单片 H100 GPU 内部逻辑布局。Image source: [3]\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e4nm\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 工艺；\u003c/li\u003e\n  \u003cli\u003e最下面一排是 18 根 Gen4 NVLink；双向总带宽 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e18 lanes * 25GB/s/lane = 900GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e中间蓝色的是 L2 cache；\u003c/li\u003e\n  \u003cli\u003e左右两侧是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eHBM\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 芯片，即显存；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"32-主机内硬件拓扑\"\u003e3.2 主机内硬件拓扑\u003c/h2\u003e\n\n\u003cp\u003e跟 A100 8 卡机结构大致类似，区别：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003eNVSwitch 芯片从 6 个减少到了 4 个；真机图如下，\u003c/p\u003e\n\n    \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/HGX_H100_board.jpg\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e与 CPU 的互联从 PCIe Gen4 x16 升级到 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ePCIe Gen5 x16\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，双向带宽 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e128GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"33-组网\"\u003e3.3 组网\u003c/h2\u003e\n\n\u003cp\u003e与 A100 也类似，只是标配改成了 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e400Gbps\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 的 CX7 网卡，\n否则网络带宽与 PCIe Switch 和 NVLink/NVSwitch 之间的差距更大了。\u003c/p\u003e\n\n\u003ch1 id=\"4-典型-4l40s8l40s-主机\"\u003e4 典型 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e4*L40S/8*L40S\u003c/code\u003e 主机\u003c/h1\u003e\n\n\u003cp\u003eL40S 是今年（2023）即将上市的新一代“性价比款”多功能 GPU，\u003cstrong\u003e\u003cmark\u003e对标 A100\u003c/mark\u003e\u003c/strong\u003e。\n除了不适合训练基座大模型之外（后面会看到为什么），官方的宣传里它几乎什么都能干。\n\u003cdel\u003e价格的话，目前第三方服务器厂商给到的口头报价都是 A100 的 8 折左右\u003c/del\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"41-l40s-vs-a100-配置及特点对比\"\u003e4.1 L40S vs A100 配置及特点对比\u003c/h2\u003e\n\n\u003cp\u003eL40S 最大的特点之一是 \u003cstrong\u003e\u003cmark\u003etime-to-market 时间短\u003c/mark\u003e\u003c/strong\u003e，也就是从订货到拿到货周期比 A100/A800/H800 快很多。\n这里面技术和非技术原因都有，比如：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cdel\u003e不存在被美国禁售的功能\u003c/del\u003e（根据 2023.10 的新规定，已经禁售了），比如 \u003cstrong\u003e\u003cmark\u003eFP64 和 NVLink 都干掉了\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e使用 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eGDDR6\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 显存，不依赖 HBM 产能（及先进封装）；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e价格便宜也有几方面原因，后面会详细介绍：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e大头可能来自  GPU 本身价格降低：因为去掉了一些模块和功能，或者用便宜的产品替代；\u003c/li\u003e\n  \u003cli\u003e整机成本也有节省：例如去掉了一层 PCIe Gen4 Swtich；不过相比于 4x/8x GPU，整机的其他部分都可以说送的了；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"42-l40s-与-a100-性能对比\"\u003e4.2 L40S 与 A100 性能对比\u003c/h2\u003e\n\n\u003cp\u003e下面是一个官方标称性能对比：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/l40s-vs-a100.png\" width=\"75%\" height=\"75%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e具体场景的性能对比网上也有很多官方资料，这里就不列举了。简单来，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e性能 1.2x ~ 2x（看具体场景）。\u003c/li\u003e\n  \u003cli\u003e功耗：两台 L40S 和单台 A100 差不多\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e需要注意，\u003cstrong\u003e\u003cmark\u003eL40S 主机官方推荐的是单机 4 卡而不是 8 卡\u003c/mark\u003e\u003c/strong\u003e（后面会介绍为什么），\n所以对比一般是用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e两台 4*L40S\u003c/code\u003e vs \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e单台 8*A100\u003c/code\u003e。另外，很多场景的性能提升有个\n\u003cstrong\u003e\u003cmark\u003e大前提\u003c/mark\u003e\u003c/strong\u003e：网络需要是 200Gbps RoCE 或 IB 网络，接下来介绍为什么。\u003c/p\u003e\n\n\u003ch2 id=\"43-l40s-攒机\"\u003e4.3 L40S 攒机\u003c/h2\u003e\n\n\u003ch3 id=\"推荐架构2-2-4\"\u003e推荐架构：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-4\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e相比于 A100 的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e2-2-4-6-8-8\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 架构，\n官方推荐的 L40S GPU 主机是 2-2-4 架构，一台机器物理拓扑如下：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/4x-l40s-node-hw-topo.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e推荐单机 4 卡 L40S GPU 主机拓扑\u003c/p\u003e\n\n\u003cp\u003e最明显的变化是\u003cstrong\u003e\u003cmark\u003e去掉了 CPU 和 GPU 之间的 PCIe Switch 芯片\u003c/mark\u003e\u003c/strong\u003e，\n网卡和 GPU 都是直连 CPU 上自带的 PCIe Gen4 x16（64GB/s），\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e2 片 CPU（NUMA）\u003c/li\u003e\n  \u003cli\u003e2 张双口 CX7 网卡（每张网卡 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e2*200Gbps\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）\u003c/li\u003e\n  \u003cli\u003e4 片 L40S GPU\u003c/li\u003e\n  \u003cli\u003e另外，存储网卡只配 1 张（双口），直连在任意一片 CPU 上\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这样\u003cstrong\u003e每片 GPU 平均 200Gbps 网络带宽\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"不推荐架构2-2-8\"\u003e不推荐架构：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2-2-8\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/8x-l40s-topo.png\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e单机 8 卡 L40S GPU 主机拓扑，来自 NVIDIA L40S 官方推介材料\u003c/p\u003e\n\n\u003cp\u003e如图，跟单机 4 卡相比，单机 8 卡需要引入两片 PCIe Gen5 Switch 芯片：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e说是现在\u003cstrong\u003e\u003cmark\u003ePCIe Gen5 Switch 单片价格 1w 刀\u003c/mark\u003e\u003c/strong\u003e（不知真假），一台机器需要 2 片；价格不划算；\u003c/li\u003e\n  \u003cli\u003ePCIe switch 只有一家在生产，产能受限，周期很长；\u003c/li\u003e\n  \u003cli\u003e平摊到每片 GPU 的网络带宽减半；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"44-组网\"\u003e4.4 组网\u003c/h2\u003e\n\n\u003cp\u003e官方建议 4 卡机型，搭配 200Gbps RoCE/IB 组网。\u003c/p\u003e\n\n\u003ch2 id=\"45-数据链路带宽瓶颈分析\"\u003e4.5 数据链路带宽瓶颈分析\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/gpu-notes/4x-l40s-bw-limits.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e单机 4 卡 L40S GPU 主机带宽瓶颈分析\u003c/p\u003e\n\n\u003cp\u003e以同 CPU 下面的两种 L40S 为例，这里面有两条链路可选：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e直接通过 CPU 处理：\u003ccode\u003eGPU0 \u0026lt;--PCIe--\u0026gt; \u003cmark\u003eCPU\u003c/mark\u003e \u0026lt;--PCIe--\u0026gt; GPU1\u003c/code\u003e\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003ePCIe Gen4 x16 双向 64GB/s，单向 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e32GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eCPU 处理瓶颈？TODO\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e完全绕过 CPU 处理，\u003cstrong\u003e\u003cmark\u003e通过网卡去外面绕一圈再回来\u003c/mark\u003e\u003c/strong\u003e：\u003ccode\u003eGPU0 \u0026lt;--PCIe--\u0026gt; \u003cmark\u003eNIC \u0026lt;-- RoCe/IB Switch --\u0026gt; NIC\u003c/mark\u003e \u0026lt;--PCIe--\u0026gt; GPU1\u003c/code\u003e\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003ePCIe Gen4 x16 双向 64GB/s，单向 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e32GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e平均每个 GPU 一个单向 200Gbps 网口，单向折算 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e25GB/s\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e需要 NCCL 支持\u003c/mark\u003e\u003c/strong\u003e，官方说新版本 NCCL 正在针对 L40S 适配，默认行为就是去外面绕一圈回来；\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e第二种方式看着长了很多，但官方说其实比方式一还要快很多（这里还每太搞懂，CPU 那里是怎么处理的？）——\n\u003cstrong\u003e\u003cmark\u003e前提是网卡和交换机配到位\u003c/mark\u003e\u003c/strong\u003e：200Gbps RoCE/IB 网络。在这种网络架构下（网络带宽充足），\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e任何两片 GPU 的通信带宽和延迟都是一样的\u003c/mark\u003e\u003c/strong\u003e，是否在一台机器内或一片 CPU 下面并不重要，集群可以\u003cstrong\u003e\u003cmark\u003e横向扩展\u003c/mark\u003e\u003c/strong\u003e（scaling up，compared with scaling in）；\u003c/li\u003e\n  \u003cli\u003eGPU 机器成本降低；但其实对于那些对网络带宽要求没那么高的业务来说，是\u003cstrong\u003e把 NVLINK 的成本转嫁给了网络\u003c/strong\u003e，这时候必须要组建 200Gbps 网络，否则发挥不出 L40S 多卡训练的性能。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e如果是方式二，同主机内 GPU 卡间的带宽瓶颈在网卡速度。即使网络是推荐的 2*CX7 配置，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eL40S： 200Gbps（网卡单向线速）\u003c/li\u003e\n  \u003cli\u003eA100： 300GB/s（NVLINK3 单向） == \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e12x\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e200Gbps\u003c/li\u003e\n  \u003cli\u003eA800： 200GB/s（NVLINK3 单向） == \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e8x\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e200Gbps\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e可以看到，\u003cstrong\u003e\u003cmark\u003eL40S 卡间带宽还是比 A100 NVLINK 慢了 12 倍\u003c/mark\u003e\u003c/strong\u003e，\n比 A800 NVLink 慢了 8 倍，所以\u003cstrong\u003e不适合数据密集交互的基础大模型训练\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"46-测试注意事项\"\u003e4.6 测试注意事项\u003c/h2\u003e\n\n\u003cp\u003e如上，即便只测试单机 4 卡 L40S 机器，也需要搭配 200Gbps 交换机，否则卡间性能发挥不出来。\u003c/p\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://hc34.hotchips.org/\"\u003eNVLink-Network Switch - NVIDIA’s Switch Chip for High Communication-Bandwidth SuperPODs\u003c/a\u003e, Hot Chips 2022\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://www.servethehome.com/chatgpt-hardware-a-look-at-8x-nvidia-a100-systems-powering-the-tool-openai-microsoft-azure-supermicro-inspur-asus-dell-gigabyte/\"\u003eChatGPT Hardware a Look at 8x NVIDIA A100 Powering the Tool\u003c/a\u003e, 2023\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://developer.nvidia.com/blog/nvidia-hopper-architecture-in-depth/\"\u003eNVIDIA Hopper Architecture In-Depth\u003c/a\u003e, nvidia.com, 2022\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://www.microway.com/hpc-tech-tips/dgx-a100-review-throughput-and-hardware-summary/\"\u003eDGX A100 review: Throughput and Hardware Summary\u003c/a\u003e, 2020\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/understanding-gpu-performance/\"\u003eUnderstanding NVIDIA GPU Performance: Utilization vs. Saturation\u003c/a\u003e, 2023\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/how-to-train-a-gpt-assistant-zh/\"\u003e\u003cspan\u003e« [译] 如何训练一个企业级 GPT 助手（OpenAI，2023）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/linux-loadavg-zh/\"\u003e\u003cspan\u003eLinux Load Average：算法、实现与实用指南（2023） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2023-09-16T00:00:00Z",
  "Author": "Arthur Chiao"
}