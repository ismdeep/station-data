{
  "Source": "arthurchiao.art",
  "Title": "Spawn a Virtual Machine in Kubernetes with kubevirt: A Deep Dive (2023)",
  "Link": "https://arthurchiao.art/blog/kubevirt-create-vm/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eSpawn a Virtual Machine in Kubernetes with kubevirt: A Deep Dive (2023)\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2023-11-30 | Last Update 2023-11-30\u003c/p\u003e\n  \n  \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/kubevirt-arch.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. kubevirt architecture overview\u003c/p\u003e\n\n\u003cp\u003eAn introductory post before this deep dive:\n\u003ca href=\"/blog/vm-on-k8s/\"\u003eVirtual Machines on Kubernetes: Requirements and Solutions (2023)\u003c/a\u003e\u003c/p\u003e\n\n\u003cp\u003eBased on kubevirt \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ev1.0.0\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ev1.1.0\u003c/code\u003e.\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-virt-handler-startup\" id=\"markdown-toc-1-virt-handler-startup\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e startup\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-agent-responsibilities\" id=\"markdown-toc-11-agent-responsibilities\"\u003e1.1 Agent responsibilities\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-start-and-initialization-call-stack\" id=\"markdown-toc-12-start-and-initialization-call-stack\"\u003e1.2 Start and initialization (call stack)\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-summary\" id=\"markdown-toc-13-summary\"\u003e1.3 Summary\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-create-a-virtualmachine-in-kubernetes\" id=\"markdown-toc-2-create-a-virtualmachine-in-kubernetes\"\u003e2 Create a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e in Kubernetes\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-kube-apiserver-create-a-virtualmachine-cr\" id=\"markdown-toc-21-kube-apiserver-create-a-virtualmachine-cr\"\u003e2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-apiserver\u003c/code\u003e: create a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e CR\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-virt-controller-translate-virtualmachine-to-virtualmachineinstance-and-pod\" id=\"markdown-toc-22-virt-controller-translate-virtualmachine-to-virtualmachineinstance-and-pod\"\u003e2.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-controller\u003c/code\u003e: translate \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-kube-scheduler-schedule-pod\" id=\"markdown-toc-23-kube-scheduler-schedule-pod\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-scheduler\u003c/code\u003e: schedule \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-kubelet-create-pod\" id=\"markdown-toc-24-kubelet-create-pod\"\u003e2.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e: create \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#241-pause-container\" id=\"markdown-toc-241-pause-container\"\u003e2.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epause\u003c/code\u003e container\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#242-1st-init-container-install-container-disk-binary-to-pod\" id=\"markdown-toc-242-1st-init-container-install-container-disk-binary-to-pod\"\u003e2.4.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1st\u003c/code\u003e init container: install \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disk-binary\u003c/code\u003e to Pod\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#243-2nd-init-container-volumecontainerdisk-init\" id=\"markdown-toc-243-2nd-init-container-volumecontainerdisk-init\"\u003e2.4.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2nd\u003c/code\u003e init container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evolumecontainerdisk-init\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#244-1st-main-container-volumecontainerdisk\" id=\"markdown-toc-244-1st-main-container-volumecontainerdisk\"\u003e2.4.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1st\u003c/code\u003e main container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evolumecontainerdisk\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#245-2nd-main-container-compute\" id=\"markdown-toc-245-2nd-main-container-compute\"\u003e2.4.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2nd\u003c/code\u003e main container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecompute\u003c/code\u003e\u003c/a\u003e            \u003cul\u003e\n              \u003cli\u003e\u003ca href=\"#virt-launcher-monitor\" id=\"markdown-toc-virt-launcher-monitor\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher-monitor\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#virt-launcher-call-stack-start-virtqemudcmdserver\" id=\"markdown-toc-virt-launcher-call-stack-start-virtqemudcmdserver\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e call stack: start \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud/cmdserver\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#virtqemud-management-for-qemu-vms\" id=\"markdown-toc-virtqemud-management-for-qemu-vms\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud\u003c/code\u003e: management for QEMU VMs\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#process-tree\" id=\"markdown-toc-process-tree\"\u003eProcess tree\u003c/a\u003e\u003c/li\u003e\n            \u003c/ul\u003e\n          \u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-virt-launcher-reconcile-vm-state-create-vm-in-this-case\" id=\"markdown-toc-25-virt-launcher-reconcile-vm-state-create-vm-in-this-case\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e: reconcile VM state (create VM in this case)\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#251-virt-handlercmdclient---virt-launchercmdserver-sync-vmi\" id=\"markdown-toc-251-virt-handlercmdclient---virt-launchercmdserver-sync-vmi\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler/cmdclient -\u0026gt; virt-launcher/cmdserver\u003c/code\u003e: sync VMI\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#252-virt-launchercmdserver-syncvirtualmachine---libvirt-c-api-virdomaincreatewithflags\" id=\"markdown-toc-252-virt-launchercmdserver-syncvirtualmachine---libvirt-c-api-virdomaincreatewithflags\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher/cmdserver: SyncVirtualMachine()\u003c/code\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-\u0026gt;\u003c/code\u003e libvirt C API \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirDomainCreateWithFlags()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#253-libvirt-api---virtqemud-create-domain-vm\" id=\"markdown-toc-253-libvirt-api---virtqemud-create-domain-vm\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elibvirt API -\u0026gt; virtqemud\u003c/code\u003e: create domain (VM)\u003c/a\u003e            \u003cul\u003e\n              \u003cli\u003e\u003ca href=\"#libvirtdomainmanager\" id=\"markdown-toc-libvirtdomainmanager\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLibvirtDomainManager\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#libvirt-c-api\" id=\"markdown-toc-libvirt-c-api\"\u003elibvirt C API\u003c/a\u003e\u003c/li\u003e\n            \u003c/ul\u003e\n          \u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#254-virtqemud---kvm-subsystem\" id=\"markdown-toc-254-virtqemud---kvm-subsystem\"\u003e2.5.4 virtqemud -\u0026gt; KVM subsystem\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#26-recap\" id=\"markdown-toc-26-recap\"\u003e2.6 Recap\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-management-vm-states\" id=\"markdown-toc-3-management-vm-states\"\u003e3 Management VM states\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-resize-cpumemorydisk\" id=\"markdown-toc-31-resize-cpumemorydisk\"\u003e3.1 Resize CPU/Memory/Disk\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-delete-vm\" id=\"markdown-toc-32-delete-vm\"\u003e3.2 Delete VM\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-summary\" id=\"markdown-toc-4-summary\"\u003e4 Summary\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#references\" id=\"markdown-toc-references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/kubevirt-arch.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Architecture overview of the kubevirt solution\u003c/p\u003e\n\n\u003cp\u003eThis post assumes there is already a running Kubernetes cluster, and kubevirt\nis correctly deployed in this cluster.\u003c/p\u003e\n\n\u003ch1 id=\"1-virt-handler-startup\"\u003e1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e startup\u003c/h1\u003e\n\n\u003ch2 id=\"11-agent-responsibilities\"\u003e1.1 Agent responsibilities\u003c/h2\u003e\n\n\u003cp\u003eAs the node agent, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e is responsible for\n\u003cstrong\u003e\u003cmark\u003emanaging the lifecycle of all VMs on that node\u003c/mark\u003e\u003c/strong\u003e, such as creating, destroying,\npausing, …, freezing those VMs. It functions similarly to\nOpenStack’s \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enova-compute\u003c/code\u003e, but with the added complexity of \u003cstrong\u003e\u003cmark\u003erunning each VM\ninside a Kubernetes Pod\u003c/mark\u003e\u003c/strong\u003e, which requires collaboration with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e - Kubernete’s node agent.\nFor example,\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eWhen creating a VM, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e must wait until kubelet creates the corresponding Pod,\u003c/li\u003e\n  \u003cli\u003eWhen destroying a VM, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e handles the VM destruction first,\nfollowed by kubelet performing the remaining cleanup steps (destroying the Pod).\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"12-start-and-initialization-call-stack\"\u003e1.2 Start and initialization (call stack)\u003c/h2\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eRun                                           // cmd/virt-handler/virt-handler.go\n  |-vmController := NewController()\n  |-vmController.Run()\n      |-Run()                                 // pkg/virt-handler/vm.go\n         |-go c.deviceManagerController.Run()\n         | \n         |-for domain in c.domainInformer.GetStore().List() {\n         |     d := domain.(*api.Domain)\n         |     vmiRef := v1.NewVMIReferenceWithUUID(...)\n         |     key := controller.VirtualMachineInstanceKey(vmiRef)\n         | \n         |     exists := c.vmiSourceInformer.GetStore().GetByKey(key)\n         |     if !exists\n         |         c.Queue.Add(key)\n         |-}\n         | \n         |-for i := 0; i \u0026lt; threadiness; i++ // 10 goroutine by default\n               go c.runWorker\n                  /\n      /----------/\n     /\nrunWorker\n  |-for c.Execute() {\n         |-key := c.Queue.Get()\n         |-c.execute(key) // handle VM changes\n              |-vmi, vmiExists := d.getVMIFromCache(key)\n              |-domain, domainExists, domainCachedUID := d.getDomainFromCache(key)\n              |-if !vmiExists \u0026amp;\u0026amp; string(domainCachedUID) != \u0026#34;\u0026#34;\n              |     vmi.UID = domainCachedUID\n              |-if string(vmi.UID) == \u0026#34;\u0026#34; {\n              |     uid := virtcache.LastKnownUIDFromGhostRecordCache(key)\n              |     if uid != \u0026#34;\u0026#34; {\n              |         vmi.UID = uid\n              |     } else { // legacy support, attempt to find UID from watchdog file it exists.\n              |         uid := watchdog.WatchdogFileGetUID(d.virtShareDir, vmi)\n              |         if uid != \u0026#34;\u0026#34;\n              |             vmi.UID = types.UID(uid)\n              |     }\n              |-}\n              |-return d.defaultExecute(key, vmi, vmiExists, domain, domainExists)\n    }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eSteps done during \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e boostrap:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eStart necessary controllers\u003c/mark\u003e\u003c/strong\u003e, such as the device-related controller.\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eScan all VMs on the node\u003c/mark\u003e\u003c/strong\u003e and perform any necessary cleanups.\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003eSpawn goroutines to handle VM-related tasks\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n\n    \u003cp\u003eEach goroutine runs an infinite loop, monitoring changes to kubevirt’s VMI (Virtual\n Machine Instance) custom resources and responding accordingly. This includes\n actions like creating, deleting, …, unpausing VMs. For example, if a\n new VM is detected to be created on the node, the goroutine will initiate the\n creation process.\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"13-summary\"\u003e1.3 Summary\u003c/h2\u003e\n\n\u003cp\u003eNow that the agent is ready to handle VM-related tasks, let’s create a VM in this\nKubernetes cluster and see what happens in the behind.\u003c/p\u003e\n\n\u003ch1 id=\"2-create-a-virtualmachine-in-kubernetes\"\u003e2 Create a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e in Kubernetes\u003c/h1\u003e\n\n\u003cp\u003eLet’s see how to create a KVM-based virtual machine (just like the ones you’ve created in OpenStack,\nor the EC2 instances you’re using on public clouds) with kubevirt, and what happens in the behind.\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/vm-on-k8s/kubevirt-workflow.png\" width=\"75%\" height=\"75%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Workflow of creating a VM in kubevirt.\n\u003cmark\u003eLeft: steps added by kubevirt\u003c/mark\u003e; Right: vanilla precedures of creating a Pod in k8s. [2]\n\u003c/p\u003e\n\n\u003ch2 id=\"21-kube-apiserver-create-a-virtualmachine-cr\"\u003e2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-apiserver\u003c/code\u003e: create a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e CR\u003c/h2\u003e\n\n\u003cp\u003ekubevirt introduces a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e CRD, which allows to define the\nspecifications of virtual machines, such as CPU, memory, network, and disk\nconfigurations. \nBelow is the spec of our to-be-created VM, it’s ok if you don’t undertand all the fields:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt.io/v1\u003c/span\u003e\n\u003cspan class=\"na\"\u003ekind\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eVirtualMachine\u003c/span\u003e\n\u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt-smoke-fedora\u003c/span\u003e\n\u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"na\"\u003erunning\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"na\"\u003etemplate\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"na\"\u003emetadata\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eannotations\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ekubevirt.io/keep-launcher-alive-after-failure\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"na\"\u003espec\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003enodeSelector\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ekubevirt.io/schedulable\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003etrue\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"na\"\u003earchitecture\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eamd64\u003c/span\u003e\n      \u003cspan class=\"na\"\u003edomain\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eclock\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003etimer\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ehpet\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003epresent\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ehyperv\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e{}\u003c/span\u003e\n            \u003cspan class=\"na\"\u003epit\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003etickPolicy\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003edelay\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ertc\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003etickPolicy\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecatchup\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eutc\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e{}\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003ecores\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eresources\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003erequests\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e4G\u003c/span\u003e\n        \u003cspan class=\"na\"\u003emachine\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eq35\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003einterfaces\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ebridge\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e{}\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n          \u003cspan class=\"na\"\u003edisks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003edisk\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003ebus\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirtio\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainerdisk\u003c/span\u003e\n          \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003edisk\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003ebus\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirtio\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemptydisk\u003c/span\u003e\n          \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003edisk\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n              \u003cspan class=\"na\"\u003ebus\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirtio\u003c/span\u003e\n            \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecloudinitdisk\u003c/span\u003e\n        \u003cspan class=\"na\"\u003efeatures\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eacpi\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"na\"\u003eenabled\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n        \u003cspan class=\"na\"\u003efirmware\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003euuid\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ec3ecdb42-282e-44c3-8266-91b99ac91261\u003c/span\u003e\n      \u003cspan class=\"na\"\u003enetworks\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n        \u003cspan class=\"na\"\u003epod\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e{}\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003econtainerDisk\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt/fedora-cloud-container-disk-demo:latest\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eimagePullPolicy\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eAlways\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainerdisk\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003eemptyDisk\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003ecapacity\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e2Gi\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eemptydisk\u003c/span\u003e\n      \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ecloudInitNoCloud\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003euserData\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"pi\"\u003e|-\u003c/span\u003e\n            \u003cspan class=\"s\"\u003e#cloud-config\u003c/span\u003e\n            \u003cspan class=\"s\"\u003epassword: changeme               # password of this VM\u003c/span\u003e\n            \u003cspan class=\"s\"\u003echpasswd: { expire: False }\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecloudinitdisk\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eNow just apply it:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003emaster\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek apply \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e kubevirt-smoke-fedora.yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"22-virt-controller-translate-virtualmachine-to-virtualmachineinstance-and-pod\"\u003e2.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-controller\u003c/code\u003e: translate \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-controller\u003c/code\u003e, a control plane component of kubevirt, monitors\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e CRs/objects and generates corresponding \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e\nobjects, and further creates a standard Kubernetes Pod object to describe the VM.\nSee \u003ca href=\"https://github.com/kubevirt/kubevirt/blob/v1.1.0/pkg/virt-controller/services/template.go#L320\"\u003erenderLaunchManifest()\u003c/a\u003e\nfor details.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e is a running instance of the corresponding VirtualMachine,\nsuch as, if you stop a VirtualMachine, the corresponding \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e will be deleted,\nbut it will be recreated after you start this VirtualMachine again.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get vm\nNAME                    AGE    STATUS    READY\nkubevirt-smoke-fedora   ...\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get vmi\nNAME                    AGE     PHASE     IP             NODENAME         READY   LIVE-MIGRATABLE   PAUSED\nkubevirt-smoke-fedora   ...\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e wide | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003efedora\nvirt-launcher-kubevirt-smoke-fedora-2kx25   \u0026lt;status\u0026gt; ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eOnce the Pod object is created, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-scheduler\u003c/code\u003e takes over and selects a suitable\nnode for the Pod. This has no differences compared with scheduling a normal Kubernetes pod.\u003c/p\u003e\n\n\u003cp\u003eThe Pod’s yaml specification is very lengthy, we’ll see them piece by piece in following\nsections.\u003c/p\u003e\n\n\u003ch2 id=\"23-kube-scheduler-schedule-pod\"\u003e2.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-scheduler\u003c/code\u003e: schedule \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003eBased on Pod’s label selectors, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube-scheduler\u003c/code\u003e will choose a node for the Pod, then\nupdate the pod spec.\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/kubevirt-arch.png\" width=\"100%\" height=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Architecture overview of the kubevirt solution\u003c/p\u003e\n\n\u003cp\u003eThe steps described above, from applying a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e CR to the scheduling\nof the corresponding Pod on a node, all occur within the master node or control\nplane. Subsequent steps involve happen within the selected node.\u003c/p\u003e\n\n\u003ch2 id=\"24-kubelet-create-pod\"\u003e2.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e: create \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePod\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003eUpon detecting a Pod has been scheduled to this node, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e on that node initiates the\ncreation of the Pod using its specifications.\u003c/p\u003e\n\n\u003cp\u003eWhile a standard Pod typically\nconsists of a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epause\u003c/code\u003e container for holding namespaces and a main container for\nexecuting user-defined tasks, Kubernetes also allows for multiple containers to\nbe included within a single Pod. This is particularly useful in scenarios such\nas service mesh, where a sidecar container can be injected into each Pod to\nprocess network requests.\u003c/p\u003e\n\n\u003cp\u003eIn the case of kubevirt, this “multi-container”\nproperty is leveraged even further. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-controller\u003c/code\u003e described 4 containers within the Pod:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e2 init containers for creating shared directories for containers in this Pod and copying files;\u003c/li\u003e\n  \u003cli\u003e1 volume container for holding volumes;\u003c/li\u003e\n  \u003cli\u003e1 compute container for \u003cstrong\u003e\u003cmark\u003eholding the VM\u003c/mark\u003e\u003c/strong\u003e in this Pod.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"241-pause-container\"\u003e2.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epause\u003c/code\u003e container\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecrictl ps\u003c/code\u003e won’t show the pause container, but we can check it with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eps\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003eps \u003cspan class=\"nt\"\u003e-ef\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003evirt-launcher\nqemu     822447 821556  /usr/bin/virt-launcher-monitor \u003cspan class=\"nt\"\u003e--qemu-timeout\u003c/span\u003e 288s \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e kubevirt-smoke-fedora \u003cspan class=\"nt\"\u003e--uid\u003c/span\u003e 413e131b-408d-4ec6-9d2c-dc691e82cfda \u003cspan class=\"nt\"\u003e--namespace\u003c/span\u003e default \u003cspan class=\"nt\"\u003e--kubevirt-share-dir\u003c/span\u003e /var/run/kubevirt \u003cspan class=\"nt\"\u003e--ephemeral-disk-dir\u003c/span\u003e /var/run/kubevirt-ephemeral-disks \u003cspan class=\"nt\"\u003e--container-disk-dir\u003c/span\u003e /var/run/kubevirt/container-disks \u003cspan class=\"nt\"\u003e--grace-period-seconds\u003c/span\u003e 45 \u003cspan class=\"nt\"\u003e--hook-sidecars\u003c/span\u003e 0 \u003cspan class=\"nt\"\u003e--ovmf-path\u003c/span\u003e /usr/share/OVMF \u003cspan class=\"nt\"\u003e--run-as-nonroot\u003c/span\u003e \u003cspan class=\"nt\"\u003e--keep-after-failure\u003c/span\u003e\nqemu     822464 822447  /usr/bin/virt-launcher         \u003cspan class=\"nt\"\u003e--qemu-timeout\u003c/span\u003e 288s \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e kubevirt-smoke-fedora \u003cspan class=\"nt\"\u003e--uid\u003c/span\u003e 413e131b-408d-4ec6-9d2c-dc691e82cfda \u003cspan class=\"nt\"\u003e--namespace\u003c/span\u003e default \u003cspan class=\"nt\"\u003e--kubevirt-share-dir\u003c/span\u003e /var/run/kubevirt \u003cspan class=\"nt\"\u003e--ephemeral-disk-dir\u003c/span\u003e /var/run/kubevirt-ephemeral-disks \u003cspan class=\"nt\"\u003e--container-disk-dir\u003c/span\u003e /var/run/kubevirt/container-disks \u003cspan class=\"nt\"\u003e--grace-period-seconds\u003c/span\u003e 45 \u003cspan class=\"nt\"\u003e--hook-sidecars\u003c/span\u003e 0 \u003cspan class=\"nt\"\u003e--ovmf-path\u003c/span\u003e /usr/share/OVMF \u003cspan class=\"nt\"\u003e--run-as-nonroot\u003c/span\u003e\nqemu     822756 822447  /usr/libexec/qemu-kvm \u003cspan class=\"nt\"\u003e-name\u003c/span\u003e ... \u003cspan class=\"c\"\u003e# parent is virt-launcher-monitor\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003eps \u003cspan class=\"nt\"\u003e-ef\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003epause\nroot     820808 820788  /pause\nqemu     821576 821556  /pause\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eProcess start information:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/821576/cmdline | \u003cspan class=\"nb\"\u003etr\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\0\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e \u003cspan class=\"c\"\u003e# the `pause` process\u003c/span\u003e\n/pause\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /proc/821556/cmdline | \u003cspan class=\"nb\"\u003etr\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;\\0\u0026#39;\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39; \u0026#39;\u003c/span\u003e \u003cspan class=\"c\"\u003e# the parent process\u003c/span\u003e\n/usr/bin/containerd-shim-runc-v2 \u003cspan class=\"nt\"\u003e-namespace\u003c/span\u003e k8s.io \u003cspan class=\"nt\"\u003e-id\u003c/span\u003e 09c4b \u003cspan class=\"nt\"\u003e-address\u003c/span\u003e /run/containerd/containerd.sock\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"242-1st-init-container-install-container-disk-binary-to-pod\"\u003e2.4.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1st\u003c/code\u003e init container: install \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disk-binary\u003c/code\u003e to Pod\u003c/h3\u003e\n\n\u003cp\u003eSnippet from Pod yaml:\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"na\"\u003einitContainers\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin/cp\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin/container-disk\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/init/usr/bin/container-disk\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eenv\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_CACHE_HOME\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-private\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_CONFIG_HOME\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-private\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_RUNTIME_DIR\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirt-launcher:v1.0.0\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainer-disk-binary\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eresources\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elimits\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e100m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e40M\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erequests\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e10m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e1M\u003c/span\u003e\n    \u003cspan class=\"na\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eallowPrivilegeEscalation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ecapabilities\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edrop\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eALL\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eprivileged\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsGroup\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsNonRoot\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsUser\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/init/usr/bin\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirt-bin-share-dir\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt copies a binary named \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disk\u003c/code\u003e from container image to a directory of the Pod,\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eSource code \u003ca href=\"https://github.com/kubevirt/kubevirt/blob/v1.1.0/cmd/container-disk-v2alpha/main.c\"\u003ecmd/container-disk/main.c\u003c/a\u003e.\nAbout ~100 lines of C code.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eso this binary is \u003cstrong\u003e\u003cmark\u003eshared among all containers of this Pod\u003c/mark\u003e\u003c/strong\u003e.\n\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003evirt-bin-share-dir\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e is declared as a Kubernetes\n\u003ca href=\"https://kubernetes.io/docs/concepts/storage/volumes/#emptydir\"\u003eemptyDir\u003c/a\u003e,\nkubelet will create a volume for it automatically in local disk:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eFor a Pod that defines an emptyDir volume, the volume is created when the Pod\nis assigned to a node. As the name says, the emptyDir volume is initially\nempty. All containers in the Pod can read and write the same files in the\nemptyDir volume, though that volume can be mounted at the same or different\npaths in each container. When a Pod is removed from a node for any reason, the\ndata in the emptyDir is deleted permanently.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eCheck the container:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecrictl ps \u003cspan class=\"nt\"\u003e-a\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003econtainer-disk-binary \u003cspan class=\"c\"\u003e# init container runs and exits\u003c/span\u003e\n55f4628feb5a0   Exited   container-disk-binary   ...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eCheck the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eemptyDir\u003c/code\u003e created for it:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecrictl inspect 55f4628feb5a0\n    ...\n    \u003cspan class=\"s2\"\u003e\u0026#34;mounts\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;containerPath\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/init/usr/bin\u0026#34;\u003c/span\u003e,\n        \u003cspan class=\"s2\"\u003e\u0026#34;hostPath\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/var/lib/k8s/kubelet/pods/8364158c/volumes/kubernetes.io~empty-dir/virt-bin-share-dir\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eCheck \u003cstrong\u003e\u003cmark\u003ewhat\u0026#39;s inside the directory\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e /var/lib/k8s/kubelet/pods/8364158c/volumes/kubernetes.io~empty-dir/virt-bin-share-dir\ncontainer-disk \u003cspan class=\"c\"\u003e# an excutable that will be used by the other containers in this Pod\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"243-2nd-init-container-volumecontainerdisk-init\"\u003e2.4.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2nd\u003c/code\u003e init container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evolumecontainerdisk-init\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin/container-disk\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eargs\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--no-op\u003c/span\u003e                   \u003cspan class=\"c1\"\u003e# exit(0) directly\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt/fedora-cloud-container-disk-demo:latest\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evolumecontainerdisk-init\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eresources\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elimits\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e10m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e40M\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erequests\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e1m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eephemeral-storage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e50M\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e1M\u003c/span\u003e\n    \u003cspan class=\"na\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eallowPrivilegeEscalation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ecapabilities\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edrop\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eALL\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eprivileged\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsNonRoot\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsUser\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks/container-disk-data/413e131b-408d-4ec6-9d2c-dc691e82cfda\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainer-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirt-bin-share-dir\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWith \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--no-op\u003c/code\u003e option, the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disk\u003c/code\u003e program will exit\nimmediately with a return code of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0\u003c/code\u003e, indicating success.\u003c/p\u003e\n\n\u003cp\u003eSo, what is the purpose of this container? It appears that it references a volume named\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disks\u003c/code\u003e, suggesting that it uses this approach as a workaround for\ncertain edge cases. This ensures that the directory (emptyDir) is created\nbefore being utilized by the subsequent container.\u003c/p\u003e\n\n\u003ch3 id=\"244-1st-main-container-volumecontainerdisk\"\u003e2.4.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1st\u003c/code\u003e main container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evolumecontainerdisk\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin/container-disk\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eargs\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--copy-path\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks/container-disk-data/413e131b-408d-4ec6-9d2c-dc691e82cfda/disk_0\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt/fedora-cloud-container-disk-demo:latest\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evolumecontainerdisk\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eresources\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e                         \u003cspan class=\"c1\"\u003e# needs little CPU \u0026amp; memory\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elimits\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e10m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e40M\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erequests\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e1m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eephemeral-storage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e50M\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e1M\u003c/span\u003e\n    \u003cspan class=\"na\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eallowPrivilegeEscalation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ecapabilities\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edrop\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eALL\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eprivileged\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsNonRoot\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsUser\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirt-bin-share-dir\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks/container-disk-data/413e131b-408d-4ec6-9d2c-dc691e82cfda\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainer-disks\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis container uses two directories created by the init containers:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-bin-share-dir\u003c/code\u003e: an emptyDir, created by the 1st init container;\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disks\u003c/code\u003e: an emptyDir, created by the 2nd init container;\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--copy-path \u0026lt;path\u0026gt;\u003c/code\u003e:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eCreate this path is not exist;\u003c/li\u003e\n  \u003cli\u003eCreate a unix domain socket, listen requests and close them;\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eIt seems that this container serves the purpose of holding the\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainer-disk-data\u003c/code\u003e volume and does not perform any other significant tasks.\u003c/p\u003e\n\n\u003ch3 id=\"245-2nd-main-container-compute\"\u003e2.4.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2nd\u003c/code\u003e main container: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecompute\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ecommand\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/bin/virt-launcher-monitor\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--qemu-timeout\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e288s\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--name\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003ekubevirt-smoke-fedora\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--uid\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e413e131b-408d-4ec6-9d2c-dc691e82cfda\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--namespace\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003edefault\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--kubevirt-share-dir\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--ephemeral-disk-dir\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--container-disk-dir\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt/container-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--grace-period-seconds\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e45\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--hook-sidecars\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e0\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--ovmf-path\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e/usr/share/OVMF\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--run-as-nonroot\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003e--keep-after-failure\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eenv\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_CACHE_HOME\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-private\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_CONFIG_HOME\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-private\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eXDG_RUNTIME_DIR\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eVIRT_LAUNCHER_LOG_VERBOSITY\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e6\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eLIBVIRT_DEBUG_LOGS\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eVIRTIOFSD_DEBUG_LOGS\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalue\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ePOD_NAME\u003c/span\u003e\n      \u003cspan class=\"na\"\u003evalueFrom\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003efieldRef\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n          \u003cspan class=\"na\"\u003eapiVersion\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ev1\u003c/span\u003e\n          \u003cspan class=\"na\"\u003efieldPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003emetadata.name\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eimage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003evirt-launcher:v1.0.0\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ecompute\u003c/span\u003e\n    \u003cspan class=\"na\"\u003eresources\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003elimits\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/kvm\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/tun\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/vhost-net\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erequests\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ecpu\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e100m\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/kvm\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/tun\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edevices.kubevirt.io/vhost-net\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e1\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eephemeral-storage\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e50M\u003c/span\u003e\n        \u003cspan class=\"na\"\u003ememory\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"s\"\u003e4261567892\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"na\"\u003esecurityContext\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eallowPrivilegeEscalation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ecapabilities\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"na\"\u003eadd\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eNET_BIND_SERVICE\u003c/span\u003e\n        \u003cspan class=\"na\"\u003edrop\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n        \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"s\"\u003eALL\u003c/span\u003e\n      \u003cspan class=\"na\"\u003eprivileged\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsGroup\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsNonRoot\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003efalse\u003c/span\u003e\n      \u003cspan class=\"na\"\u003erunAsUser\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"m\"\u003e107\u003c/span\u003e\n    \u003cspan class=\"na\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-private\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eprivate\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003epublic\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eephemeral-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt/container-disks\u003c/span\u003e\n      \u003cspan class=\"na\"\u003emountPropagation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eHostToContainer\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003econtainer-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/libvirt\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003elibvirt-runtime\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt/sockets\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003esockets\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt/hotplug-disks\u003c/span\u003e\n      \u003cspan class=\"na\"\u003emountPropagation\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eHostToContainer\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ehotplug-disks\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/run/kubevirt-ephemeral-disks/disk-data/containerdisk\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003elocal\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis container runs a binary called \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003evirt-launcher-monitor\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e,\nwhich is \u003cstrong\u003e\u003cmark\u003ea simple wrapper\u003c/mark\u003e\u003c/strong\u003e around \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e.\nThe main purpose of adding a wrapping layer is for better cleaning up when process exits.\u003c/p\u003e\n\n\u003ch4 id=\"virt-launcher-monitor\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher-monitor\u003c/code\u003e\u003c/h4\u003e\n\n\u003cp\u003eAll \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher-monitor\u003c/code\u003e’s arguments will be passed to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e changed, except\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--keep-after-failure\u003c/code\u003e will be removed - this is a monitor-only flag.\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// run virt-launcher process and monitor it to give qemu an extra grace period to properly terminate in case of crashes\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003eRunAndMonitor\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econtainerDiskDir\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eargs\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eremoveArg\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eArgs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;--keep-after-failure\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eexec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCommand\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/usr/bin/virt-launcher\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSysProcAttr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSysProcAttr\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eAmbientCaps\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003euintptr\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eunix\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eCAP_NET_BIND_SERVICE\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStart\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esigs\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"nb\"\u003emake\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003echan\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSignal\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e10\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esignal\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNotify\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esigs\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGINT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGTERM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGQUIT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ego\u003c/span\u003e \u003cspan class=\"k\"\u003efunc\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003esigs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"n\"\u003esig\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n                \u003cspan class=\"k\"\u003evar\u003c/span\u003e \u003cspan class=\"n\"\u003ewstatus\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWaitStatus\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ewpid\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWait4\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"m\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ewstatus\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWNOHANG\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n                \u003cspan class=\"n\"\u003elog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLog\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eInfof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Reaped pid %d with status %d\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ewpid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewstatus\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003ewpid\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePid\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                    \u003cspan class=\"n\"\u003eexitStatus\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan class=\"n\"\u003ewstatus\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eExitStatus\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"c\"\u003e// Log(\u0026#34;signalling virt-launcher to shut down\u0026#34;)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecmd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eProcess\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSignal\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSIGTERM\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n                \u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSignal\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}()\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eexitCode\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;-\u003c/span\u003e\u003cspan class=\"n\"\u003eexitStatus\u003c/span\u003e \u003cspan class=\"c\"\u003e// wait for VM\u0026#39;s exit\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// do cleanups here\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4 id=\"virt-launcher-call-stack-start-virtqemudcmdserver\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e call stack: start \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud/cmdserver\u003c/code\u003e\u003c/h4\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003emain // cmd/virt-launcher/virt-launcher.go\n  |-NewLibvirtWrapper(*runWithNonRoot)\n  |-SetupLibvirt(libvirtLogFilters)\n  |-StartVirtquemud(stopChan)\n  |    |-go func() {\n  |    |     for {\n  |    |         Run(\u0026#34;/usr/sbin/virtqemud -f /var/run/libvirt/virtqemud.conf\u0026#34;)\n  |    |\n  |    |         select {\n  |    |         case \u0026lt;-stopChan:\n  |    |             return cmd.Process.Kill()\n  |    |         }\n  |    |     }\n  |    |-}()\n  |\n  |-domainConn := createLibvirtConnection() // \u0026#34;qemu+unix:///session?socket=/var/run/libvirt/virtqemud-sock\u0026#34; or \u0026#34;qemu:///system\u0026#34;\n  |\n  |-notifier := notifyclient.NewNotifier(*virtShareDir)\n  |-domainManager := NewLibvirtDomainManager()\n  |\n  |-startCmdServer(\u0026#34;/var/run/kubevirt/sockets/launcher-init-sock\u0026#34;)\n  |-startDomainEventMonitoring\n  |-domain := waitForDomainUUID()\n  |\n  |-mon := virtlauncher.NewProcessMonitor(domainName,)\n  |-mon.RunForever()\n        |-monitorLoop()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIt starts two processes inside the container:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003evirtqemud\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e: a libvirt component, runs as a daemon process;\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ecmdserver: a gRPC server\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e, provides VM operation (delete/pause/freeze/…) interfaces to the caller;\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch4 id=\"virtqemud-management-for-qemu-vms\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud\u003c/code\u003e: management for QEMU VMs\u003c/h4\u003e\n\n\u003cp\u003e\u003ca href=\"https://libvirt.org/manpages/virtqemud.html\"\u003evirtqemud\u003c/a\u003e is a server side daemon component of the libvirt virtualization management system,\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eone of a collection of modular daemons that replace functionality previously provided by the monolithic libvirtd daemon.\u003c/li\u003e\n  \u003cli\u003eprovide management for QEMU virtual machines.\u003c/li\u003e\n  \u003cli\u003elistens for requests on a \u003cstrong\u003e\u003cmark\u003elocal Unix domain socket\u003c/mark\u003e\u003c/strong\u003e by default. Remote access via TLS/TCP and backwards compatibility with legacy\nclients expecting libvirtd is provided by the virtproxyd daemon.\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eCheck the container that will hold the VM:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecrictl ps \u003cspan class=\"nt\"\u003e-a\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003ecompute\nf67f57d432534       Running     compute     0       09c4b63f6bca5       virt-launcher-kubevirt-smoke-fedora-2kx25\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eConfigurations of \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud\u003c/code\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecrictl \u003cspan class=\"nb\"\u003eexec\u003c/span\u003e \u003cspan class=\"nt\"\u003e-it\u003c/span\u003e f67f57d432534 sh\nsh-5.1\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /var/run/libvirt/virtqemud.conf\nlisten_tls \u003cspan class=\"o\"\u003e=\u003c/span\u003e 0\nlisten_tcp \u003cspan class=\"o\"\u003e=\u003c/span\u003e 0\nlog_outputs \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;1:stderr\u0026#34;\u003c/span\u003e\n\u003cspan class=\"nv\"\u003elog_filters\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;3:remote 4:event 3:util.json 3:util.object 3:util.dbus 3:util.netlink 3:node_device 3:rpc 3:access 3:util.threadjob 3:cpu.cpu 3:qemu.qemu_monitor 1:*\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4 id=\"process-tree\"\u003eProcess tree\u003c/h4\u003e\n\n\u003cp\u003eThere are several processes inside the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecompute\u003c/code\u003e container, show their relationships\nwith \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003epstree\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003epstree \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e \u0026lt;virt-launcher-monitor pid\u0026gt; \u003cspan class=\"nt\"\u003e--hide-threads\u003c/span\u003e\nvirt-launcher-m\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u0026lt;pid\u0026gt;\u003cspan class=\"o\"\u003e)\u003c/span\u003e─┬─qemu-kvm\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u0026lt;pid\u0026gt;\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# The real VM process, we\u0026#39;ll see this in the next chapter\u003c/span\u003e\n                       └─virt-launcher\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u0026lt;pid\u0026gt;\u003cspan class=\"o\"\u003e)\u003c/span\u003e─┬─virtlogd\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u0026lt;pid\u0026gt;\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n                                              └─virtqemud\u003cspan class=\"o\"\u003e(\u003c/span\u003e\u0026lt;pid\u0026gt;\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e# Show the entire process arguments\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003epstree \u003cspan class=\"nt\"\u003e-p\u003c/span\u003e \u0026lt;virt-launcher-monitor pid\u0026gt; \u003cspan class=\"nt\"\u003e--hide-threads\u003c/span\u003e \u003cspan class=\"nt\"\u003e--arguments\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003evirt-launcher-monitor \u003cspan class=\"nt\"\u003e--qemu-timeout\u003c/span\u003e 321s \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e kubevirt-smoke-fedora ...\n  ├─qemu-kvm            \u003cspan class=\"nt\"\u003e-name\u003c/span\u003e \u003cspan class=\"nv\"\u003eguest\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003edefault_kubevirt-smoke-fedora,debug-threads\u003cspan class=\"o\"\u003e=\u003c/span\u003eon ...\n  └─virt-launcher       \u003cspan class=\"nt\"\u003e--qemu-timeout\u003c/span\u003e 321s \u003cspan class=\"nt\"\u003e--name\u003c/span\u003e kubevirt-smoke-fedora ...\n      ├─virtlogd        \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e /etc/libvirt/virtlogd.conf\n      └─virtqemud       \u003cspan class=\"nt\"\u003e-f\u003c/span\u003e /var/run/libvirt/virtqemud.conf\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"25-virt-launcher-reconcile-vm-state-create-vm-in-this-case\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e: reconcile VM state (create VM in this case)\u003c/h2\u003e\n\n\u003cp\u003eStatus til now:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/before-vm-creation.png\" width=\"65%\" height=\"65%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. \u003cmark\u003eReady to create a KVM VM inside the Pod\u003c/mark\u003e\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubelet\u003c/code\u003e has successfully created a Pod and is reconciling the Pod status based on the Pod specification.\u003c/p\u003e\n\n    \u003cp\u003eNote that certain details, such as network creation for the Pod, have been omitted to keep this post concise.\n There are no differences from normal Pods.\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e is prepared to synchronize the status of the\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachineInstance\u003c/code\u003e with a real KVM virtual machine on this node. As\nthere is currently no virtual machine present, the first task of the\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e is to \u003cstrong\u003e\u003cmark\u003ecreate the virtual machine\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eNow, let’s delve into the detailed steps involved in creating a KVM virtual machine.\u003c/p\u003e\n\n\u003ch3 id=\"251-virt-handlercmdclient---virt-launchercmdserver-sync-vmi\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler/cmdclient -\u0026gt; virt-launcher/cmdserver\u003c/code\u003e: sync VMI\u003c/h3\u003e\n\n\u003cp\u003eAn informer is used in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e to sync VMI, it will call to the following stack:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003edefaultExecute\n  |-switch {\n    case shouldShutdown:\n        d.processVmShutdown(vmi, domain)\n    case shouldDelete:\n        d.processVmDelete(vmi)\n    case shouldCleanUp:\n        d.processVmCleanup(vmi)\n    case shouldUpdate:\n        d.processVmUpdate(vmi, domain)\n          |// handle migration if needed\n          |\n          |// handle vm create\n          |-d.vmUpdateHelperDefault\n               |-client.SyncVirtualMachine(vmi, options)\n                   |-// lots of preparation work here\n                   |-genericSendVMICmd(\u0026#34;SyncVMI\u0026#34;, c.v1client.SyncVirtualMachine, vmi, options)\n  }\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ca href=\"\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclient.SyncVirtualMachine(vmi, options)\u003c/code\u003e\u003c/a\u003e does lots of preparation work, then\ncalls \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSyncVMI()\u003c/code\u003e gRPC method to synchronize VM status - if not exist, then create it.\nThis method will be handled by the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecmdserver\u003c/code\u003e in \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch3 id=\"252-virt-launchercmdserver-syncvirtualmachine---libvirt-c-api-virdomaincreatewithflags\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-launcher/cmdserver: SyncVirtualMachine()\u003c/code\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-\u0026gt;\u003c/code\u003e libvirt C API \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirDomainCreateWithFlags()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eSyncVirtualMachine // pkg/virt-launcher/virtwrap/cmd-server/server.go\n  |-vmi, response := getVMIFromRequest(request.Vmi)\n  |-domainManager.SyncVMI(vmi, l.allowEmulation, request.Options)\n      |-domain := \u0026amp;api.Domain{}\n      |-c := l.generateConverterContext // generate libvirt domain from VMI spec\n      |-dom := l.virConn.LookupDomainByName(domain.Spec.Name)\n      |-if notFound {\n      |     domain = l.preStartHook(vmi, domain, false)\n      |     dom = withNetworkIfacesResources(\n      |         vmi, \u0026amp;domain.Spec,\n      |         func(v *v1.VirtualMachineInstance, s *api.DomainSpec) (cli.VirDomain, error) {\n      |             return l.setDomainSpecWithHooks(v, s)\n      |         },\n      |     )\n      |\n      |     l.metadataCache.UID.Set(vmi.UID)\n      |     l.metadataCache.GracePeriod.Set( api.GracePeriodMetadata{DeletionGracePeriodSeconds: converter.GracePeriodSeconds(vmi)},)\n      |     logger.Info(\u0026#34;Domain defined.\u0026#34;)\n      |-}\n      | \n      |-switch domState {\n      |     case vm create:\n      |         l.generateCloudInitISO(vmi, \u0026amp;dom)\n      |         dom.CreateWithFlags(getDomainCreateFlags(vmi)) // start VirtualMachineInstance\n      |     case vm pause/unpause:\n      |     case disk attach/detach/resize disks:\n      |     case hot plug/unplug virtio interfaces:\n      |-}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAs the above code shows, it eventually calls into \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003elibvirt API\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\nto create a \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e\u0026#34;domain\u0026#34;\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003ehttps://unix.stackexchange.com/questions/408308/why-are-vms-in-kvm-qemu-called-domains\u003c/p\u003e\n\n  \u003cp\u003eThey’re not kvm exclusive terminology (xen also refers to machines as\ndomains). \u003cmark\u003eA hypervisor is a rough equivalent to domain zero\u003c/mark\u003e, or dom0, which\nis the first system initialized on the kernel and has special privileges.\nOther domains started later are called domU and are the equivalent to a guest\nsystem or virtual machine.  The reason is probably that both are very similar\nas they are executed on the kernel that handles them.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch3 id=\"253-libvirt-api---virtqemud-create-domain-vm\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elibvirt API -\u0026gt; virtqemud\u003c/code\u003e: create domain (VM)\u003c/h3\u003e\n\n\u003ch4 id=\"libvirtdomainmanager\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLibvirtDomainManager\u003c/code\u003e\u003c/h4\u003e\n\n\u003cp\u003eAll VM/VMI operations are abstracted into a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eLibvirtDomainManager\u003c/code\u003e struct:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e// pkg/virt-launcher/virtwrap/manager.go\n\ntype LibvirtDomainManager struct {\n    virConn cli.Connection\n\n    // Anytime a get and a set is done on the domain, this lock must be held.\n    domainModifyLock sync.Mutex\n    // mutex to control access to the guest time context\n    setGuestTimeLock sync.Mutex\n\n    credManager *accesscredentials.AccessCredentialManager\n\n    hotplugHostDevicesInProgress chan struct{}\n    memoryDumpInProgress         chan struct{}\n\n    virtShareDir             string\n    ephemeralDiskDir         string\n    paused                   pausedVMIs\n    agentData                *agentpoller.AsyncAgentStore\n    cloudInitDataStore       *cloudinit.CloudInitData\n    setGuestTimeContextPtr   *contextStore\n    efiEnvironment           *efi.EFIEnvironment\n    ovmfPath                 string\n    ephemeralDiskCreator     ephemeraldisk.EphemeralDiskCreatorInterface\n    directIOChecker          converter.DirectIOChecker\n    disksInfo                map[string]*cmdv1.DiskInfo\n    cancelSafetyUnfreezeChan chan struct{}\n    migrateInfoStats         *stats.DomainJobInfo\n\n    metadataCache *metadata.Cache\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch4 id=\"libvirt-c-api\"\u003elibvirt C API\u003c/h4\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// vendor/libvirt.org/go/libvirt/domain.go\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// See also https://libvirt.org/html/libvirt-libvirt-domain.html#virDomainCreateWithFlags\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eDomain\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eCreateWithFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"n\"\u003eDomainCreateFlags\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evirDomainCreateWithFlagsWrapper\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ed\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eC\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"kt\"\u003euint\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eerr\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"254-virtqemud---kvm-subsystem\"\u003e2.5.4 virtqemud -\u0026gt; KVM subsystem\u003c/h3\u003e\n\n\u003cp\u003eCreate VM with xml spec.\u003c/p\u003e\n\n\u003cp\u003eThe domain (VM) will be created, and the \u003cstrong\u003e\u003cmark\u003eVCPU will enter running state\u003c/mark\u003e\u003c/strong\u003e\nunless special flags are specified.\u003c/p\u003e\n\n\u003ch2 id=\"26-recap\"\u003e2.6 Recap\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/vm-is-created.png\" width=\"65%\" height=\"65%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. \u003cmark\u003eA KVM VM is created inside the Pod\u003c/mark\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ecrictl ps \u003cspan class=\"nt\"\u003e-a\u003c/span\u003e | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003ekubevirt\n960d3e86991fa     Running     volumecontainerdisk        0   09c4b63f6bca5       virt-launcher-kubevirt-smoke-fedora-2kx25\nf67f57d432534     Running     compute                    0   09c4b63f6bca5       virt-launcher-kubevirt-smoke-fedora-2kx25\ne8b79067667b7     Exited      volumecontainerdisk-init   0   09c4b63f6bca5       virt-launcher-kubevirt-smoke-fedora-2kx25\n55f4628feb5a0     Exited      container-disk-binary      0   09c4b63f6bca5       virt-launcher-kubevirt-smoke-fedora-2kx25\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eThis finishes our journey of creating a VM in kubevirt.\u003c/p\u003e\n\n\u003cp\u003eWhat it looks like if we created two kubevir \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003es and they are scheduled to the same node:\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/kubevirt-create-vm/node-topo.png\" width=\"65%\" height=\"65%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. \u003cmark\u003eTwo KVM VMs on the node\u003c/mark\u003e\u003c/p\u003e\n\n\u003ch1 id=\"3-management-vm-states\"\u003e3 Management VM states\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003eControl path\u003c/mark\u003e\u003c/strong\u003e of VM state changes:\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekube-apiserver -\u0026gt; virt-handler -\u0026gt; cmdserver -\u0026gt; virtqemud -\u0026gt; KVM subsystem -\u0026gt; VM\n\n VMI states         VM agent     |-- virt-launcher pod --|     kernel\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"31-resize-cpumemorydisk\"\u003e3.1 Resize CPU/Memory/Disk\u003c/h2\u003e\n\n\u003cp\u003eWorkflow (non hotplug):\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/VirtualMachine/VirtualMachineInstance\u003c/code\u003e spec is modified;\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirt-handler\u003c/code\u003e receives the changes and modifies KVM VM configurations via \u003ccode class=\"language-plaintext highlighter-rouge\"\u003evirtqemud-\u0026gt;KVM\u003c/code\u003e;\u003c/li\u003e\n  \u003cli\u003eRestart pod and KVM VM to make the changes take effect.\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eIf hotplug is supported (e.g. Kubernetes VPA is supported), kubevirt should be able\nto hot-reload the changes.\u003c/p\u003e\n\n\u003ch2 id=\"32-delete-vm\"\u003e3.2 Delete VM\u003c/h2\u003e\n\n\u003cp\u003eSimilar workflow as the above.\u003c/p\u003e\n\n\u003ch1 id=\"4-summary\"\u003e4 Summary\u003c/h1\u003e\n\n\u003cp\u003eThis post illustrates what happens in the underlying when user\ncreates a \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eVirtualMachine\u003c/code\u003e in Kubernetes with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubevirt\u003c/code\u003e.\u003c/p\u003e\n\n\u003ch1 id=\"references\"\u003eReferences\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/kubevirt/kubevirt\"\u003egithub.com/kubevirt\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/vm-on-k8s/\"\u003eVirtual Machines on Kubernetes: Requirements and Solutions (2023)\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/vm-on-k8s/\"\u003e\u003cspan\u003e« Virtual Machines on Kubernetes: Requirements and Solutions (2023)\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/linux-container-and-runtime-zh/\"\u003e\u003cspan\u003eLinux 容器底层工作机制：从 500 行 C 代码到生产级容器运行时（2023） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2023-11-30T00:00:00Z",
  "Author": "Arthur Chiao"
}