{
  "Source": "arthurchiao.art",
  "Title": "OVS balance-slb bond Forwards Unknown Unicast",
  "Link": "https://arthurchiao.art/blog/ovs-forwards-unknown-unicast/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eOVS balance-slb bond Forwards Unknown Unicast\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2019-10-13 | Last Update 2019-10-13\u003c/p\u003e\n  \n  \u003ch2 id=\"tl-dr\"\u003eTL; DR\u003c/h2\u003e\n\n\u003cp\u003eIn some cases, OVS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.6\u003c/code\u003e bond with mode \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e will forward the \u003ca href=\"https://en.wikipedia.org/wiki/Broadcast,_unknown-unicast_and_multicast_traffic\"\u003eunknown\nunicast\u003c/a\u003e\n[4] traffic it received from one physical NIC back into the physical network\nthrough another NIC, which will \u003cstrong\u003eresult in a L2 loop\u003c/strong\u003e with physical network,\nthis in turn will cause the physical switches complaining \u003cstrong\u003eMAC flapping\u003c/strong\u003e (the\nsame MAC address presents at multiple places at a short time) and then\n\u003cstrong\u003estopping MAC learning\u003c/strong\u003e for some time (e.g. 1 minute), which will be a severe\nnetwork problem.\u003c/p\u003e\n\n\u003cp\u003eNote that at the time of writing this post, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.x\u003c/code\u003e is the latest LTS, and\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.3.x\u003c/code\u003e is the previous LTS. The documents on \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e bond are same in\nthose two series, however, the behavior changed according to our experiences.\u003c/p\u003e\n\n\u003ch1 id=\"1-problem-description\"\u003e1 Problem Description\u003c/h1\u003e\n\n\u003cp\u003eRecently, our datacenter network team found that there were occasional MAC\nflapping problems, these problems \u003cstrong\u003eoccurred several times a day\u003c/strong\u003e, but the\n\u003cstrong\u003econsequences were severe\u003c/strong\u003e: affected switches would stop learning new MAC for 1\nminute or so, this would further result to, e.g. new instances (containers, VMs)\nbooted during period would report gateway unreachable.\u003c/p\u003e\n\n\u003cp\u003eThe physical switch errors looked like this:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003eFWM-6-MAC_MOVE_NOTIFICATION: Host fa16.2ead.e6cf \u003cspan class=\"k\"\u003ein \u003c/span\u003evlan 2001 is flapping between port Po19 and port Po22\nFWM-6-MAC_MOVE_NOTIFICATION: Host fa16.2ead.e6cf \u003cspan class=\"k\"\u003ein \u003c/span\u003evlan 2001 is flapping between port Po22 and port Po19\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"2-infra--environment-info\"\u003e2 Infra \u0026amp; Environment Info\u003c/h2\u003e\n\n\u003cp\u003eThis section provides some basic infrastructure information to help understand\nthe problem. For more detailed information, please refer to my previous post \u003ca href=\"/blog/ctrip-network-arch-evolution/\"\u003eCtrip\nNetwork Architecture Evolution in the Cloud Computing Era\u003c/a\u003e.\u003c/p\u003e\n\n\u003cp\u003eThe data center network utilizes a 3-tier architecture, TOR switches are \u003cstrong\u003eNOT\u003c/strong\u003e\nstacked (stacking, e.g, Cisco vPC).\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/ovs-forwards-unicast-flooding/2-1.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. 2.1 Physical topology\u003c/p\u003e\n\n\u003cp\u003eOthers:\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eOVS version: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.6\u003c/code\u003e (contrast group: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.3.1\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eOVS bond mode: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e, with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003erebalance\u003c/code\u003e turned off (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erebalance-interval=0\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eLinux Kernel: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e4.14\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"3-trouble-shooting\"\u003e3 Trouble Shooting\u003c/h1\u003e\n\n\u003ch2 id=\"31-confirm-balance-slb-mode-bond-forwards-unicast-flooding-packets\"\u003e3.1 Confirm: \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e mode bond forwards unicast flooding packets\u003c/h2\u003e\n\n\u003cp\u003eAs the problem appeared only since recently, we went through all our\nconfiguration and software changes within this period. At last, we suspected\nthat upgrading OVS from 2.3.1 to 2.5.6 maybe the most potential cause.\u003c/p\u003e\n\n\u003cp\u003eWe also found \u003cstrong\u003eseveral similar reports [1,2]\u003c/strong\u003e, unfortunately these ended\nwith no conclusions. But at this point, we were ensure that we were not the only\nuser encountered this problem.\u003c/p\u003e\n\n\u003cp\u003eDigging into the \u003ca href=\"https://ovs-reviews.readthedocs.io/en/latest/topics/bonding.html#slb-bonding\"\u003edocumentation\u003c/a\u003e:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eWhen the remote switch has not learned the MAC for the destination of a\nunicast packet and hence floods the packet to all of the links on the SLB\nbond, Open vSwitch will forward duplicate packets, one per link, to each other\nswitch port.\u003c/p\u003e\n\n  \u003cp\u003eOpen vSwitch does not solve this problem.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003eIt clearly says that it \u003cstrong\u003edose behave in this way\u003c/strong\u003e.\u003c/p\u003e\n\n\u003ch2 id=\"32-verifycapture\"\u003e3.2 Verify/Capture\u003c/h2\u003e\n\n\u003cp\u003eThen we’d like to capture the occurrance when this problem happens.\nWe used the following script to capture packets on an OVS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.6\u003c/code\u003e node:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat \u003c/span\u003ecapture.sh\n\u003cspan class=\"c\"\u003e#!/bin/bash\u003c/span\u003e\n\n\u003cspan class=\"nb\"\u003etimeout \u003c/span\u003e36000 tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0 \u003cspan class=\"nt\"\u003e--direction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e  \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e 16 \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e eth0-in.pcap \u0026amp;\n\u003cspan class=\"nb\"\u003etimeout \u003c/span\u003e36000 tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth1 \u003cspan class=\"nt\"\u003e--direction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eout \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e 16 \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e eth1-out.pcap \u0026amp;\n\n\u003cspan class=\"nb\"\u003etimeout \u003c/span\u003e36000 tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth1 \u003cspan class=\"nt\"\u003e--direction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003ein\u003c/span\u003e  \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e 16 \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e eth1-in.pcap \u0026amp;\n\u003cspan class=\"nb\"\u003etimeout \u003c/span\u003e36000 tcpdump \u003cspan class=\"nt\"\u003e-i\u003c/span\u003e eth0 \u003cspan class=\"nt\"\u003e--direction\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eout \u003cspan class=\"nt\"\u003e-s\u003c/span\u003e 16 \u003cspan class=\"nt\"\u003e-w\u003c/span\u003e eth0-out.pcap \u0026amp;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eAs we had a large traffic on NICs, we only captured the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eether+IP\u003c/code\u003e\nheaders of each packet (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-s 16\u003c/code\u003e: first 16 bytes); at the meantime, we separate\nthe traffic into two diretions:\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eTOR0 -\u0026gt; eth0 -\u0026gt; OVS -\u0026gt; eth1 -\u0026gt; TOR1\u003c/li\u003e\n  \u003cli\u003eTOR1 -\u0026gt; eth1 -\u0026gt; OVS -\u0026gt; eth2 -\u0026gt; TOR0\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eSo there are totally 4 captured files.\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eAccording to our observation, this problem was occasional\u003c/strong\u003e (this means not\nall unicast flooding packets would be forwarded, but I haven’t dig further into\nthis just some observation). We run 4 hours until the problem happened again on\nthis host (let’s call it \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHostA\u003c/code\u003e), resulted total 30GB pcap files.\u003c/p\u003e\n\n\u003cp\u003eWhen problem happened, MAC \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efa:16:3e:b2:2e:27\u003c/code\u003e was learned by TOR from this\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHostA\u003c/code\u003e’s eth1 interface, while this MAC actually belongs to a container on\nanother host (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHostB\u003c/code\u003e). So it is a unicast flooding traffic (we further\nconfirmed that the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edst_mac\u003c/code\u003e belongs to a container that’s not on \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eHostA\u003c/code\u003e).\u003c/p\u003e\n\n\u003cp\u003eCheck this in the pcap files:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpdump \u003cspan class=\"nt\"\u003e-e\u003c/span\u003e \u003cspan class=\"nt\"\u003e-r\u003c/span\u003e eth0-in.pcap | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003efa:16:3e:b2:2e:27\n15:10:40.110642 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 64: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.110891 fa:16:3e:d1:15:17 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:b2:2e:27, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.111090 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.111118 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.111214 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.111275 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.111299 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n15:10:40.292307 fa:16:3e:d1:15:17 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:b2:2e:27, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etcpdump \u003cspan class=\"nt\"\u003e-e\u003c/span\u003e \u003cspan class=\"nt\"\u003e-r\u003c/span\u003e eth1-out.pcap | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003efa:16:3e:b2:2e:27\n15:10:40.111248 fa:16:3e:b2:2e:27 \u003cspan class=\"o\"\u003e(\u003c/span\u003eoui Unknown\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e fa:16:3e:d1:15:17, length 78: \u003cspan class=\"o\"\u003e[\u003c/span\u003e|vlan]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eIndeed, it was received from \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eeth0\u003c/code\u003e and forwared to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eeth1\u003c/code\u003e then sent out. The\nprocess looked like Fig 2.1 (may not be that accurate, as I’m not very familir\nwith some data center network details):\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/ovs-forwards-unicast-flooding/2-2.png\" width=\"45%\" height=\"45%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. 2.2 OVS bond forwarded unicast flooding traffic, resulting a L2 loop which further caused MAC flapping\u003c/p\u003e\n\n\u003ch2 id=\"33-why-231-is-ok\"\u003e3.3 Why \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.3.1\u003c/code\u003e is OK?\u003c/h2\u003e\n\n\u003cp\u003eChecking 2.3.1 documentation, the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e mode description is the same: it\nclearly says it will forward unicast flooding, but why we never encounter this\nproblem in 2.3.1?\u003c/p\u003e\n\n\u003cp\u003eUnfortunately, I haven’t found any answer to this problem. But a code diff might\nprovide some hints:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egit diff v2.3.1 v2.5.6 \u003cspan class=\"nt\"\u003e--\u003c/span\u003e ofproto/ofproto-dpif-xlate.c | \u003cspan class=\"nb\"\u003egrep\u003c/span\u003e \u003cspan class=\"nt\"\u003e-C\u003c/span\u003e 2 xlate_normal_flood\n+\n+static void\n+xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003estruct xlate_ctx \u003cspan class=\"k\"\u003e*\u003c/span\u003ectx, struct xbundle \u003cspan class=\"k\"\u003e*\u003c/span\u003ein_xbundle,\n+                   uint16_t vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n+\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e--\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n+                xlate_report\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, \u003cspan class=\"s2\"\u003e\u0026#34;multicast traffic, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+                xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n+            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e--\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n+                xlate_report\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, \u003cspan class=\"s2\"\u003e\u0026#34;MLD query, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+                xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n+        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e--\u003c/span\u003e\n+                 \u003cspan class=\"k\"\u003e*\u003c/span\u003e be forwarded on all ports \u003cspan class=\"k\"\u003e*\u003c/span\u003e/\n+                xlate_report\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, \u003cspan class=\"s2\"\u003e\u0026#34;RFC4541: section 2.1.2, item 2, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+                xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e--\u003c/span\u003e\n+            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003emcast_snooping_flood_unreg\u003cspan class=\"o\"\u003e(\u003c/span\u003ems\u003cspan class=\"o\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n+                xlate_report\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, \u003cspan class=\"s2\"\u003e\u0026#34;unregistered multicast, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+                xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+            \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n+                xlate_normal_mcast_send_mrouters\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, ms, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"nt\"\u003e--\u003c/span\u003e\n+        \u003cspan class=\"o\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n+            xlate_report\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, \u003cspan class=\"s2\"\u003e\u0026#34;no learned MAC for destination, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n+            xlate_normal_flood\u003cspan class=\"o\"\u003e(\u003c/span\u003ectx, in_xbundle, vlan\u003cspan class=\"o\"\u003e)\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n         \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n-        ctx-\u0026gt;xout-\u0026gt;nf_output_iface \u003cspan class=\"o\"\u003e=\u003c/span\u003e NF_OUT_FLOOD\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eWe can see that \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5\u003c/code\u003e indeed added some flooding related logic, especially this:\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e+\u003c/span\u003e            \u003cspan class=\"n\"\u003exlate_report\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;no learned MAC for destination, flooding\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"o\"\u003e+\u003c/span\u003e            \u003cspan class=\"n\"\u003exlate_normal_flood\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ein_xbundle\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003evlan\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"34-fixupworkaround\"\u003e3.4 Fixup/Workaround\u003c/h2\u003e\n\n\u003cp\u003eTo continue with \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.6\u003c/code\u003e, we have to switch the bond to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eactive-backup\u003c/code\u003e mode\nbefore we have better solutions:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl \u003cspan class=\"nb\"\u003eset \u003c/span\u003ePort \u0026lt;bond\u0026gt; \u003cspan class=\"nv\"\u003elacp\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eoff bond-mode\u003cspan class=\"o\"\u003e=\u003c/span\u003eactive-backup\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003eChange back to \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ebalance-slb\u003c/code\u003e if you need:\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl \u003cspan class=\"nb\"\u003eset \u003c/span\u003ePort \u0026lt;bond\u0026gt; \u003cspan class=\"nv\"\u003ebond_mode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ebalance-slb\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eovs-vsctl \u003cspan class=\"nb\"\u003eset \u003c/span\u003eport \u0026lt;bond\u0026gt; other_config:bond-rebalance-interval\u003cspan class=\"o\"\u003e=\u003c/span\u003e0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"4-summary\"\u003e4 Summary\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003eOVS bond assumes\u003c/strong\u003e that all its slave devices (physical NICs) are \u003cstrong\u003econnected to a single\nlogical switch\u003c/strong\u003e, that involves some vendor-specific stacking technologies, such\nas \u003ca href=\"https://community.cisco.com/t5/switching/cisco-vpc-vs-stack/td-p/3079750\"\u003eCisco vPC\u003c/a\u003e.\nUnfortunately not all physical networks included that, such as our case.\u003c/p\u003e\n\n\u003cp\u003eOn the other hand, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.x\u003c/code\u003e seems to have broken \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.3.x\u003c/code\u003e behaviors, although\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.3.x\u003c/code\u003e should already behave like \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2.5.x\u003c/code\u003e according to its documentation.\u003c/p\u003e\n\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://bugzilla.redhat.com/show_bug.cgi?id=1557405\"\u003eOpenvswitch retransmits ARP unicast packets on incoming port\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://mail.openvswitch.org/pipermail/ovs-discuss/2017-February/043789.html\"\u003eOVS 2.5.1 in an LACP bond does not correctlyhandleunicast flooding\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://community.cisco.com/t5/switching/cisco-vpc-vs-stack/td-p/3079750\"\u003eCisco vPC vs Stack - Cisco Community\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Broadcast,_unknown-unicast_and_multicast_traffic\"\u003eBroadcast, unknown-unicast and multicast traffic - Wikipedia\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/tcp-handshake-in-modern-network-infra/\"\u003e\u003cspan\u003e« Beneath the TCP Handshakes in Modern Networking Infrastructures\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/ovs-unknown-unicast-flooding-under-distributed-gw/\"\u003e\u003cspan\u003eOVS Unknown Unicast Flooding Under Distributed L2 Gateway »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2019-10-13T00:00:00Z",
  "Author": "Arthur Chiao"
}