{
  "Source": "arthurchiao.art",
  "Title": "JuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）",
  "Link": "https://arthurchiao.art/blog/juicefs-metadata-deep-dive-4-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eJuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2024-09-22 | Last Update 2024-09-22\u003c/p\u003e\n  \n  \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-volume-bw-control.png\" width=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS upload/download data bandwidth control.\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-1-zh/\"\u003eJuiceFS 元数据引擎初探：高层架构、引擎选型、读写工作流（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-2-zh/\"\u003eJuiceFS 元数据引擎再探：开箱解读 TiKV 中的 JuiceFS 元数据（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-3-zh/\"\u003eJuiceFS 元数据引擎三探：从实践中学习 TiKV 的 MVCC 和 GC（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-4-zh/\"\u003eJuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-5-zh/\"\u003eJuiceFS 元数据引擎五探：元数据备份与恢复（2024）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e水平及维护精力所限，文中不免存在错误或过时之处，请酌情参考。\n\u003cstrong\u003e\u003cmark\u003e传播知识，尊重劳动，年满十八周岁，转载请注明\u003ca href=\"https://arthurchiao.art\"\u003e出处\u003c/a\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-元数据存储在哪儿文件名到-tikv-regions-的映射\" id=\"markdown-toc-1-元数据存储在哪儿文件名到-tikv-regions-的映射\"\u003e1 元数据存储在哪儿？文件名到 TiKV regions 的映射\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-pd-ctl-region-列出所有-region-信息\" id=\"markdown-toc-11-pd-ctl-region-列出所有-region-信息\"\u003e1.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epd-ctl region\u003c/code\u003e 列出所有 region 信息\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-tikv-ctl-region-properties-查看-region-属性详情\" id=\"markdown-toc-12-tikv-ctl-region-properties-查看-region-属性详情\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl region-properties\u003c/code\u003e 查看 region 属性详情\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-tikv-ctl---to-escaped从-region-的-startend-key-解码文件名范围\" id=\"markdown-toc-13-tikv-ctl---to-escaped从-region-的-startend-key-解码文件名范围\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl --to-escaped\u003c/code\u003e：从 region 的 start/end key 解码文件名范围\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-filename---region相关代码\" id=\"markdown-toc-14-filename---region相关代码\"\u003e1.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilename -\u0026gt; region\u003c/code\u003e：相关代码\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-juicefs-集群规模与元数据大小engine-size\" id=\"markdown-toc-2-juicefs-集群规模与元数据大小engine-size\"\u003e2 JuiceFS 集群规模与元数据大小（engine size）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-二者的关系\" id=\"markdown-toc-21-二者的关系\"\u003e2.1 二者的关系\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#211-文件数量--平均文件大小\" id=\"markdown-toc-211-文件数量--平均文件大小\"\u003e2.1.1 文件数量 \u0026amp; 平均文件大小\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#212-mvcc-gc-快慢\" id=\"markdown-toc-212-mvcc-gc-快慢\"\u003e2.1.2 MVCC GC 快慢\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-两个集群对比\" id=\"markdown-toc-22-两个集群对比\"\u003e2.2 两个集群对比\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-限速上传下载数据带宽设计\" id=\"markdown-toc-3-限速上传下载数据带宽设计\"\u003e3 限速（上传/下载数据带宽）设计\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-带宽限制--upload-limit--download-limit\" id=\"markdown-toc-31-带宽限制--upload-limit--download-limit\"\u003e3.1 带宽限制：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--upload-limit/--download-limit\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-juicefs-限速行为\" id=\"markdown-toc-32-juicefs-限速行为\"\u003e3.2 JuiceFS 限速行为\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-juicefs-client-reload-配置的调用栈\" id=\"markdown-toc-33-juicefs-client-reload-配置的调用栈\"\u003e3.3 JuiceFS client reload 配置的调用栈\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-限流metadata-请求设计\" id=\"markdown-toc-4-限流metadata-请求设计\"\u003e4 限流（metadata 请求）设计\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-为什么需要限流\" id=\"markdown-toc-41-为什么需要限流\"\u003e4.1 为什么需要限流？\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-打爆-tikv-api-的几种场景\" id=\"markdown-toc-42-打爆-tikv-api-的几种场景\"\u003e4.2 打爆 TiKV API 的几种场景\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#421-mlocate-updatedb-等扫盘工具\" id=\"markdown-toc-421-mlocate-updatedb-等扫盘工具\"\u003e4.2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emlocate (updatedb)\u003c/code\u003e 等扫盘工具\u003c/a\u003e            \u003cul\u003e\n              \u003cli\u003e\u003ca href=\"#一次故障复盘\" id=\"markdown-toc-一次故障复盘\"\u003e一次故障复盘\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#juicefs-mount-时会自动禁用-mlocate但-csi-部署方式中部分失效\" id=\"markdown-toc-juicefs-mount-时会自动禁用-mlocate但-csi-部署方式中部分失效\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 时会自动禁用 mlocate，但 CSI 部署方式中部分失效\u003c/a\u003e\u003c/li\u003e\n            \u003c/ul\u003e\n          \u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#422-版本控制工具\" id=\"markdown-toc-422-版本控制工具\"\u003e4.2.2 版本控制工具\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-需求对元数据引擎的保护能力\" id=\"markdown-toc-43-需求对元数据引擎的保护能力\"\u003e4.3 需求：对元数据引擎的保护能力\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#431-现状juicefs-目前还没有\" id=\"markdown-toc-431-现状juicefs-目前还没有\"\u003e4.3.1 现状：JuiceFS 目前还没有\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-客户端限流方案设计\" id=\"markdown-toc-44-客户端限流方案设计\"\u003e4.4 客户端限流方案设计\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#45-服务端限流方案设计\" id=\"markdown-toc-45-服务端限流方案设计\"\u003e4.5 服务端限流方案设计\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-元数据存储在哪儿文件名到-tikv-regions-的映射\"\u003e1 元数据存储在哪儿？文件名到 TiKV regions 的映射\u003c/h1\u003e\n\n\u003ch2 id=\"11-pd-ctl-region-列出所有-region-信息\"\u003e1.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epd-ctl region\u003c/code\u003e 列出所有 region 信息\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003epd-ctl.sh region | jq \u003cspan class=\"nb\"\u003e.\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;regions\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e: 11501,\n      \u003cspan class=\"s2\"\u003e\u0026#34;start_key\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;6161616161616161FF2D61692D6661742DFF6261636B7570FD41FFCF68030000000000FF4900000000000000F8\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;end_key\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;...\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;epoch\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;conf_ver\u0026#34;\u003c/span\u003e: 23,\n        \u003cspan class=\"s2\"\u003e\u0026#34;version\u0026#34;\u003c/span\u003e: 300\n      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;peers\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"s2\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e: 19038,\n          \u003cspan class=\"s2\"\u003e\u0026#34;store_id\u0026#34;\u003c/span\u003e: 19001,\n          \u003cspan class=\"s2\"\u003e\u0026#34;role_name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Voter\u0026#34;\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n        ...\n      \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;leader\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e: 20070,\n        \u003cspan class=\"s2\"\u003e\u0026#34;store_id\u0026#34;\u003c/span\u003e: 20001,\n        \u003cspan class=\"s2\"\u003e\u0026#34;role_name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;Voter\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;written_bytes\u0026#34;\u003c/span\u003e: 0,\n      \u003cspan class=\"s2\"\u003e\u0026#34;read_bytes\u0026#34;\u003c/span\u003e: 0,\n      \u003cspan class=\"s2\"\u003e\u0026#34;written_keys\u0026#34;\u003c/span\u003e: 0,\n      \u003cspan class=\"s2\"\u003e\u0026#34;read_keys\u0026#34;\u003c/span\u003e: 0,\n      \u003cspan class=\"s2\"\u003e\u0026#34;approximate_size\u0026#34;\u003c/span\u003e: 104,\n      \u003cspan class=\"s2\"\u003e\u0026#34;approximate_keys\u0026#34;\u003c/span\u003e: 994812\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n  \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"12-tikv-ctl-region-properties-查看-region-属性详情\"\u003e1.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl region-properties\u003c/code\u003e 查看 region 属性详情\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh region-properties \u003cspan class=\"nt\"\u003e-r\u003c/span\u003e 23293\nmvcc.min_ts: 438155461254971396\nmvcc.max_ts: 452403302095650819\nmvcc.num_rows: 1972540\nmvcc.num_puts: 3697509\nmvcc.num_deletes: 834889\nmvcc.num_versions: 4532503\nmvcc.max_row_versions: 54738\nnum_entries: 4549844\nnum_deletes: 17341\nnum_files: 6\nsst_files: 001857.sst, 001856.sst, 002222.sst, 002201.sst, 002238.sst, 002233.sst\nregion.start_key: 6e6772...\nregion.end_key: 6e6772...\nregion.middle_key_by_approximate_size: 6e6772...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"13-tikv-ctl---to-escaped从-region-的-startend-key-解码文件名范围\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl --to-escaped\u003c/code\u003e：从 region 的 start/end key 解码文件名范围\u003c/h2\u003e\n\n\u003cp\u003e如上，每个 region 都会有 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003estart_key/end_key\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 两个属性，\n这里面编码的就是这个 region 内存放是元数据的 key 范围。我们挑一个来解码看看：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etikv-ctl.sh \u003cspan class=\"nt\"\u003e--to-escaped\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;6161616161616161FF2D61692D6661742DFF6261636B7570FD41FFCF68030000000000FF4900000000000000F8\u0026#39;\u003c/span\u003e\naaaaaaaa\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77-ai-fat-\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77backup\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75A\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e17h\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e03\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77I\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e70\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e再 decode 一把会更清楚：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003etikv-ctl.sh \u003cspan class=\"nt\"\u003e--decode\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;aaaaaaaa\\377-ai-fat-\\377backup\\375A\\377\\317h\\003\\000\\000\\000\\000\\000\\377I\\000\\000\\000\\000\\000\\000\\000\\370\u0026#39;\u003c/span\u003e\naaaaaaaa-ai-fat-backup\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75A\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e17h\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e03\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00I\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对应的是一个名为 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eaaaaaaa-ai-fat-backup\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 的 volume 内的一部分元数据。\u003c/p\u003e\n\n\u003ch2 id=\"14-filename---region相关代码\"\u003e1.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilename -\u0026gt; region\u003c/code\u003e：相关代码\u003c/h2\u003e\n\n\u003cp\u003e这里看一下从文件名映射到 TiKV region 的代码。\u003c/p\u003e\n\n\u003cp\u003ePD 客户端代码，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"c\"\u003e// GetRegion gets a region and its leader Peer from PD by key.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// The region may expire after split. Caller is responsible for caching and\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// taking care of region change.\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// Also, it may return nil if PD finds no Region for the key temporarily,\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// client should retry later.\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eGetRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionOption\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetRegion implements the RPCClient interface.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionOption\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionOp\u003c/span\u003e\u003cspan class=\"p\"\u003e{}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eopt\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eopts\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eopt\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ereq\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epdpb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eHeader\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e      \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erequestHeader\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eRegionKey\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e   \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eNeedBuckets\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eneedBuckets\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eserviceClient\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecctx\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetRegionAPIClientAndContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoptions\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eallowFollowerHandle\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eoption\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetEnableFollowerHandle\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003epdpb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewPDClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eserviceClient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetClientConn\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecctx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ereq\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ehandleRegionResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003ePD 服务端代码，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eh\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eregionHandler\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e \u003cspan class=\"n\"\u003ehttp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eResponseWriter\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ehttp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003erc\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003egetCluster\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003evars\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003emux\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eVars\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eQueryUnescape\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003evars\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;key\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"c\"\u003e// decode hex if query has params with hex format\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eparamsByte\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"p\"\u003e[][]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e{[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e)}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eparamsByte\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eapiutil\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eParseHexKeys\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eURL\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eQuery\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;format\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"n\"\u003eparamsByte\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eregionInfo\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003erc\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionByKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eparamsByte\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"m\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e])\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eresponse\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eMarshalRegionInfoJSON\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e \u003cspan class=\"n\"\u003eregionInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eh\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erd\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eData\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ew\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ehttp\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eStatusOK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetRegionByKey searches RegionInfo from regionTree\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003er\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRegionsInfo\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetRegionByKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eregionKey\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRegionInfo\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eregion\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003etree\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esearch\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eregionKey\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eregion\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003er\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetRegionLocked\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eregion\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetID\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e返回的是 region info，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// RegionInfo records detail region info for api usage.\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// NOTE: This type is exported by HTTP API. Please pay more attention when modifying it.\u003c/span\u003e\n\u003cspan class=\"c\"\u003e// easyjson:json\u003c/span\u003e\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eRegionInfo\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eID\u003c/span\u003e          \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e              \u003cspan class=\"s\"\u003e`json:\u0026#34;id\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStartKey\u003c/span\u003e    \u003cspan class=\"kt\"\u003estring\u003c/span\u003e              \u003cspan class=\"s\"\u003e`json:\u0026#34;start_key\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eEndKey\u003c/span\u003e      \u003cspan class=\"kt\"\u003estring\u003c/span\u003e              \u003cspan class=\"s\"\u003e`json:\u0026#34;end_key\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eRegionEpoch\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003emetapb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eRegionEpoch\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;epoch,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePeers\u003c/span\u003e       \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"n\"\u003eMetaPeer\u003c/span\u003e          \u003cspan class=\"s\"\u003e`json:\u0026#34;peers,omitempty\u0026#34;`\u003c/span\u003e \u003cspan class=\"c\"\u003e// https://github.com/pingcap/kvproto/blob/master/pkg/metapb/metapb.pb.go#L734\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eLeader\u003c/span\u003e            \u003cspan class=\"n\"\u003eMetaPeer\u003c/span\u003e      \u003cspan class=\"s\"\u003e`json:\u0026#34;leader,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDownPeers\u003c/span\u003e         \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"n\"\u003ePDPeerStats\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;down_peers,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ePendingPeers\u003c/span\u003e      \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"n\"\u003eMetaPeer\u003c/span\u003e    \u003cspan class=\"s\"\u003e`json:\u0026#34;pending_peers,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCPUUsage\u003c/span\u003e          \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e        \u003cspan class=\"s\"\u003e`json:\u0026#34;cpu_usage\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eWrittenBytes\u003c/span\u003e      \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e        \u003cspan class=\"s\"\u003e`json:\u0026#34;written_bytes\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eReadBytes\u003c/span\u003e         \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e        \u003cspan class=\"s\"\u003e`json:\u0026#34;read_bytes\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eWrittenKeys\u003c/span\u003e       \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e        \u003cspan class=\"s\"\u003e`json:\u0026#34;written_keys\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eReadKeys\u003c/span\u003e          \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e        \u003cspan class=\"s\"\u003e`json:\u0026#34;read_keys\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eApproximateSize\u003c/span\u003e   \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e         \u003cspan class=\"s\"\u003e`json:\u0026#34;approximate_size\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eApproximateKeys\u003c/span\u003e   \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e         \u003cspan class=\"s\"\u003e`json:\u0026#34;approximate_keys\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eApproximateKvSize\u003c/span\u003e \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e         \u003cspan class=\"s\"\u003e`json:\u0026#34;approximate_kv_size\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBuckets\u003c/span\u003e           \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e      \u003cspan class=\"s\"\u003e`json:\u0026#34;buckets,omitempty\u0026#34;`\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eReplicationStatus\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eReplicationStatus\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;replication_status,omitempty\u0026#34;`\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e// GetRegionFromMember implements the RPCClient interface.\u003c/span\u003e\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eGetRegionFromMember\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ememberURLs\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionOption\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eurl\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003ememberURLs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003econn\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003epdSvcDiscovery\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetOrCreateGRPCConn\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eurl\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ecc\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003epdpb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewPDClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econn\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecc\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegion\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003epdpb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetRegionRequest\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eHeader\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e    \u003cspan class=\"n\"\u003ec\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erequestHeader\u003c/span\u003e\u003cspan class=\"p\"\u003e(),\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eRegionKey\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e \u003cspan class=\"n\"\u003ekey\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e})\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eresp\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ehandleRegionResponse\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eresp\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"2-juicefs-集群规模与元数据大小engine-size\"\u003e2 JuiceFS 集群规模与元数据大小（engine size）\u003c/h1\u003e\n\n\u003ch2 id=\"21-二者的关系\"\u003e2.1 二者的关系\u003c/h2\u003e\n\n\u003cp\u003e一句话总结：\u003cstrong\u003e\u003cmark\u003e并没有一个线性的关系\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"211-文件数量--平均文件大小\"\u003e2.1.1 文件数量 \u0026amp; 平均文件大小\u003c/h3\u003e\n\n\u003cp\u003eTiKV engine size 的大小，和集群的\u003cstrong\u003e\u003cmark\u003e文件数量\u003c/mark\u003e\u003c/strong\u003e和\u003cstrong\u003e\u003cmark\u003e每个文件的大小\u003c/mark\u003e\u003c/strong\u003e都有关系。\n例如，同样是一个文件，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e小文件可能对应一条 TiKV 记录；\u003c/li\u003e\n  \u003cli\u003e大文件会被拆分，对应多条 TiKV 记录。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"212-mvcc-gc-快慢\"\u003e2.1.2 MVCC GC 快慢\u003c/h3\u003e\n\n\u003cp\u003eGC 的勤快与否也会显著影响 DB size 的大小。第三篇中有过详细讨论和验证了，这里不再赘述，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/impacts-of-tikv-gc-lagging.png\" width=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. TiKV DB size soaring in a JuiceFS cluster, caused by TiKV GC lagging.\u003c/p\u003e\n\n\u003ch2 id=\"22-两个集群对比\"\u003e2.2 两个集群对比\u003c/h2\u003e\n\n\u003cul\u003e\n  \u003cli\u003e集群 1：~1PB 数据，以\u003cstrong\u003e\u003cmark\u003e小文件\u003c/mark\u003e\u003c/strong\u003e为主，\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e~30K\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e regions，\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e~140GB\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e TiKV engine size (3 replicas)；\u003c/li\u003e\n  \u003cli\u003e集群 2：~7PB 数据，以\u003cstrong\u003e\u003cmark\u003e大文件\u003c/mark\u003e\u003c/strong\u003e为主，\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e~800\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e regions，\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e~3GB\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e TiKV engine size (3 replicas)；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e如下面监控所示，虽然集群 2 的数据量是前者的\n\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e7\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 倍，但元数据只有前者的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e1/47\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/cluster-comparison-region-and-db-size.png\" width=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. TiKV DB sizes and region counts of 2 JuiceFS clusters:\ncluster-1 with ~1PB data composed of mainly small files, cluster-2 with ~7PB data composed of mainly large files.\u003c/p\u003e\n\n\u003ch1 id=\"3-限速上传下载数据带宽设计\"\u003e3 限速（上传/下载数据带宽）设计\u003c/h1\u003e\n\n\u003cp\u003e限速（upload/download bandwidth）本身是属于数据平面（data）的事情，也就是与 S3、Ceph、OSS 等等对象存储关系更密切。\u003c/p\u003e\n\n\u003cp\u003e但第二篇中已经看到，这个限速的配置信息是保存在元数据平面（metadata）TiKV 中 —— 具体来说就是 volume 的 setting 信息；\n此外，后面讨论元数据请求限流（rate limiting）时还需要参考限速的设计。所以，这里我们稍微展开讲讲。\u003c/p\u003e\n\n\u003ch2 id=\"31-带宽限制--upload-limit--download-limit\"\u003e3.1 带宽限制：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--upload-limit/--download-limit\u003c/code\u003e\u003c/h2\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e--upload-limit\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，单位 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eMbps\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e--download-limit\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，单位 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eMbps\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"32-juicefs-限速行为\"\u003e3.2 JuiceFS 限速行为\u003c/h2\u003e\n\n\u003col\u003e\n  \u003cli\u003e如果 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 挂载时指定了这两个参数，就会以指定的参数为准；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e如果 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 挂载时没指定，就会以 TiKV 里面的配置为准，\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003ejuicefs client 里面有一个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003erefresh()\u003c/code\u003e 方法一直在监听 TiKV 里面的 Format 配置变化，\u003c/li\u003e\n      \u003cli\u003e当这俩配置发生变化时（可以通过 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ejuicefs config\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 来修改 TiKV 中的配置信息），client 就会\u003cstrong\u003e\u003cmark\u003e把最新配置 reload 到本地（本进程）\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n      \u003cli\u003e这种情况下，可以看做是\u003cstrong\u003e\u003cmark\u003e中心式配置的客户端限速\u003c/mark\u003e\u003c/strong\u003e，工作流如下图所示，\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-volume-bw-control.png\" width=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS upload/download data bandwidth control.\u003c/p\u003e\n\n\u003ch2 id=\"33-juicefs-client-reload-配置的调用栈\"\u003e3.3 JuiceFS client reload 配置的调用栈\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 时注册一个 reload 方法，\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003emount\n |-metaCli.OnReload\n    |-m.reloadCb = append(m.reloadCb, func() {\n                                        updateFormat(c)(fmt) //  fmt 是从 TiKV 里面拉下来的最新配置\n                                        store.UpdateLimit(fmt.UploadLimit, fmt.DownloadLimit)\n                                      })\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e然后有个后台任务一直在监听 TiKV 里面的配置，一旦发现配置变了就会执行到上面注册的回调方法，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"n\"\u003erefresh\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n  \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eold\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003egetFormat\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eformat\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eLoad\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"no\"\u003efalse\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e// load from tikv\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003ereflect\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eDeepEqual\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eold\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ecbs\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ereloadCb\u003c/span\u003e\n            \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecb\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003ecbs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ecb\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eformat\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"4-限流metadata-请求设计\"\u003e4 限流（metadata 请求）设计\u003c/h1\u003e\n\n\u003ch2 id=\"41-为什么需要限流\"\u003e4.1 为什么需要限流？\u003c/h2\u003e\n\n\u003cp\u003e如下图所示，\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-tikv-cluster.png\" width=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS cluster initialization, and how POSIX file operations are handled by JuiceFS.\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e限速\u003c/mark\u003e\u003c/strong\u003e保护的是 5；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e限流\u003c/mark\u003e\u003c/strong\u003e保护的是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e3 \u0026amp; 4\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e下面我们通过实际例子看看可能会打爆 3 \u0026amp; 4 的几种场景。\u003c/p\u003e\n\n\u003ch2 id=\"42-打爆-tikv-api-的几种场景\"\u003e4.2 打爆 TiKV API 的几种场景\u003c/h2\u003e\n\n\u003ch3 id=\"421-mlocate-updatedb-等扫盘工具\"\u003e4.2.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emlocate (updatedb)\u003c/code\u003e 等扫盘工具\u003c/h3\u003e\n\n\u003ch4 id=\"一次故障复盘\"\u003e一次故障复盘\u003c/h4\u003e\n\n\u003cp\u003e下面的监控，左边是 TiKV 集群的请求数量，右边是 node CPU 利用率（主要是 PD leader 在用 CPU），\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/pd-cpu-soaring.png\" width=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. PD CPU soaring caused by too much requests.\u003c/p\u003e\n\n\u003cp\u003e大致时间线，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e14:30\u003c/code\u003e 开始，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekv_get\u003c/code\u003e 请求突然飙升，导致 PD leader 节点的 CPU 利用率大幅飙升；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e14:40\u003c/code\u003e 介入调查，确定暴增的请求来自\u003cstrong\u003e\u003cmark\u003e同一个 volume\u003c/mark\u003e\u003c/strong\u003e，但这个 volume 被几十个用户的 pod 挂载，\n能联系到的用户均表示 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e14:30\u003c/code\u003e 没有特殊操作；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e14:30~16:30\u003c/code\u003e 继续联系其他用户咨询使用情况 + 主动排查；期间删掉了几个用户暂时不用的 pod，减少挂载这个 volume 的 juicefs client 数量，请求量有一定下降；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e16:30\u003c/code\u003e 定位到\u003cstrong\u003e\u003cmark\u003e请求来源\u003c/mark\u003e\u003c/strong\u003e\n    \u003cul\u003e\n      \u003cli\u003e确定暴增的请求\u003cstrong\u003e\u003cmark\u003e不是用户程序读写导致的\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n      \u003cli\u003e客户端大部分都 ubuntu 容器（AI 训练），\u003c/li\u003e\n      \u003cli\u003e使用的是\u003cstrong\u003e\u003cmark\u003e同一个容器镜像\u003c/mark\u003e\u003c/strong\u003e，里面自带了一个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edaily\u003c/code\u003e 的定时 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emlocate\u003c/code\u003e 任务去扫盘磁盘，\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这个扫盘定时任务的时间是每天 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e14:30\u003c/code\u003e，因此把挂载到容器里的 JuiceFS volume 也顺带扫了。\n确定这个原因之后，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e16:40\u003c/code\u003e 开始，逐步强制停掉（\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003epkill -f updatedb.mlocate\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）\n并禁用（\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003emv /etc/cron.daily/mlocate /tmp/\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）这些扫盘任务，\n看到请求就下来了，PD CPU 利用率也跟着降下来了；\u003c/li\u003e\n  \u003cli\u003e第二天早上 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e6:00\u003c/code\u003e 又发生了一次（凌晨 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e00:00\u003c/code\u003e 其实也有一次），后来排查发生是还有几个基础镜像也有这个任务，只是 daily 时间不同。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4 id=\"juicefs-mount-时会自动禁用-mlocate但-csi-部署方式中部分失效\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 时会自动禁用 mlocate，但 CSI 部署方式中部分失效\u003c/h4\u003e\n\n\u003cp\u003e其实官方已经注意到了 mlocate，所以 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ejuicefs mount\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e\n的入口代码就专门有检测，开了之后就自动关闭，\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// cmd/mount_unix.go\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003emountMain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ev\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003evfs\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eVFS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecli\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eContext\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGetuid\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"m\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edisableUpdatedb\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n          \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/etc/updatedb.conf\u0026#34;\u003c/span\u003e\n          \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eOpen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n          \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003enewdata\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n          \u003cspan class=\"o\"\u003e|-\u003c/span\u003e\u003cspan class=\"n\"\u003eos\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eWriteFile\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enewdata\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"m\"\u003e0644\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e但是，\u003cstrong\u003e\u003cmark\u003e在 K8s CSI 部署方式中，这个代码是部分失效的\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/k8s-juicefs-csi/juicefs-pod-setup-workflow.png\" width=\"100%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS K8s CSI deployment\u003c/p\u003e\n\n\u003cp\u003eJuiceFS per-node daemon 在创建 mount pod 时，\u003cstrong\u003e\u003cmark\u003e会把宿主机的\u003c/mark\u003e\u003c/strong\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/etc/updatedb.conf\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e挂载到 mount pod 里面\u003c/mark\u003e\u003c/strong\u003e，\n所以它能禁掉宿主机上的 mlocate，\u003c/p\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e  \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ehostPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003epath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/etc/updatedb.conf\u003c/span\u003e\n      \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eFileOrCreate\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eupdatedb\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e但正如上一小结的例子看到的，\u003cstrong\u003e\u003cmark\u003e业务 pod 里如果开了 updatedb，它就管不到了\u003c/mark\u003e\u003c/strong\u003e。\n而且业务容器很可能是同一个镜像启动大量 pod，挂载同一个 volume，所以\u003cstrong\u003e\u003cmark\u003e扫描压力直线上升\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"422-版本控制工具\"\u003e4.2.2 版本控制工具\u003c/h3\u003e\n\n\u003cp\u003e类似的工具可能还有版本控制工具（git、svn）、编程 IDE（vscode）等等，威力可能没这么大，但排查时需要留意。\u003c/p\u003e\n\n\u003ch2 id=\"43-需求对元数据引擎的保护能力\"\u003e4.3 需求：对元数据引擎的保护能力\u003c/h2\u003e\n\n\u003cp\u003e以上 case，包括上一篇看到的用户疯狂 update 文件的 case，都暴露出同一个问题：\nJuiceFS 缺少对元数据引擎的保护能力。\u003c/p\u003e\n\n\u003ch3 id=\"431-现状juicefs-目前还没有\"\u003e4.3.1 现状：JuiceFS 目前还没有\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e社区版目前（2024.09）是没有的\u003c/mark\u003e\u003c/strong\u003e，企业版不知道有没有。\u003c/p\u003e\n\n\u003cp\u003e下面讨论下如果基于社区版，如何加上这种限流能力。\u003c/p\u003e\n\n\u003ch2 id=\"44-客户端限流方案设计\"\u003e4.4 客户端限流方案设计\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-volume-bw-control.png\" width=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS upload/download data bandwidth control.\u003c/p\u003e\n\n\u003cp\u003e基于 JuiceFS 已有的设计，再参考其限速实现，其实加上一个限流能力并不难，代码也不多：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e扩展 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 结构体，增加限流配置；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs format|config\u003c/code\u003e 增加配置项，允许配置具体限流值；这会将配置写到元数据引擎里面的 volume \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetting\u003c/code\u003e；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs mount\u003c/code\u003e 里面解析 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetting\u003c/code\u003e 里面的限流配置，传给 client 里面的 metadata 模块；\u003c/li\u003e\n  \u003cli\u003emetadata 模块做客户端限流，例如针对 txnkv 里面的不到 10 个方法，在函数最开始的地方增加一个限流检查，allow 再继续，否则就等待。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e这是一种（中心式配置的）\u003cstrong\u003e\u003cmark\u003e客户端限流\u003c/mark\u003e\u003c/strong\u003e方案。\u003c/p\u003e\n\n\u003ch2 id=\"45-服务端限流方案设计\"\u003e4.5 服务端限流方案设计\u003c/h2\u003e\n\n\u003cp\u003e在 TiKV 集群前面挡一层代理，在代理上做限流，属于\u003cstrong\u003e\u003cmark\u003e服务端限流\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/blog/k8s-juicefs-csi-workflow-zh/\"\u003e图解 JuiceFS CSI 工作流：K8s 创建带 PV 的 Pod 时，背后发生了什么（2024）\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/juicefs-metadata-deep-dive-3-zh/\"\u003e\u003cspan\u003e« JuiceFS 元数据引擎三探：从实践中学习 TiKV 的 MVCC 和 GC（2024）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/juicefs-metadata-deep-dive-5-zh/\"\u003e\u003cspan\u003eJuiceFS 元数据引擎五探：元数据备份与恢复（2024） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2024-09-22T00:00:00Z",
  "Author": "Arthur Chiao"
}