{
  "Source": "arthurchiao.art",
  "Title": "Linux 容器底层工作机制：从 500 行 C 代码到生产级容器运行时（2023）",
  "Link": "https://arthurchiao.art/blog/linux-container-and-runtime-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eLinux 容器底层工作机制：从 500 行 C 代码到生产级容器运行时（2023）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2023-12-27 | Last Update 2024-01-06\u003c/p\u003e\n  \n  \u003cp\u003e从几百行 C 代码创建一个 Linux 容器的过程，一窥内核底层技术机制及真实 container runtime 的工作原理。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-container-and-runtime/container-stack-3d.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Kernel machanisms that support Linux containers\u003c/p\u003e\n\n\u003cp\u003e本文所用的完整代码见\u003ca href=\"https://github.com/ArthurChiao/arthurchiao.github.io/tree/master/assets/code/linux-container-and-runtime\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e水平有限，文中不免有错误或过时之处，请酌情参考。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-引言\" id=\"markdown-toc-1-引言\"\u003e1 引言\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-linux-容器底层机制nscgroupscapabilitiesseccomp\" id=\"markdown-toc-11-linux-容器底层机制nscgroupscapabilitiesseccomp\"\u003e1.1 Linux 容器底层机制：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNS/cgroups/Capabilities/Seccomp/...\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-namespaces\" id=\"markdown-toc-12-namespaces\"\u003e1.2 Namespaces\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-500-行-c-代码创建一个容器ctn-dc\" id=\"markdown-toc-2-500-行-c-代码创建一个容器ctn-dc\"\u003e2 500 行 C 代码创建一个容器：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d.c\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#20-总览ctn-dc\" id=\"markdown-toc-20-总览ctn-dc\"\u003e2.0 总览：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d.c\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#21-初始化\" id=\"markdown-toc-21-初始化\"\u003e2.1 初始化\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-创建-socket-pair供容器进程和父进程通信\" id=\"markdown-toc-22-创建-socket-pair供容器进程和父进程通信\"\u003e2.2 创建 socket pair，供容器进程和父进程通信\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-分配栈空间供随后-execve-执行容器启动进程使用\" id=\"markdown-toc-23-分配栈空间供随后-execve-执行容器启动进程使用\"\u003e2.3 分配栈空间，供随后 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e 执行容器启动进程使用\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-创建-cgroup为容器设置资源限额\" id=\"markdown-toc-24-创建-cgroup为容器设置资源限额\"\u003e2.4 创建 cgroup，为容器设置资源限额\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-clone-启动子进程运行容器\" id=\"markdown-toc-25-clone-启动子进程运行容器\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclone()\u003c/code\u003e 启动子进程，运行容器\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#251-sethostname感知-uts-namespace\" id=\"markdown-toc-251-sethostname感知-uts-namespace\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esethostname()\u003c/code\u003e：感知 UTS namespace\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#252-setup_mounts安全考虑unmount-不需要的目录\" id=\"markdown-toc-252-setup_mounts安全考虑unmount-不需要的目录\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_mounts()\u003c/code\u003e：安全考虑，unmount 不需要的目录\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#253-setup_userns\" id=\"markdown-toc-253-setup_userns\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_userns()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#254-setup_capabilities禁用部分-capabilities\" id=\"markdown-toc-254-setup_capabilities禁用部分-capabilities\"\u003e2.5.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_capabilities()\u003c/code\u003e：禁用部分 capabilities\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#255-setup_seccomp禁用部分系统调用\" id=\"markdown-toc-255-setup_seccomp禁用部分系统调用\"\u003e2.5.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_seccomp()\u003c/code\u003e：禁用部分系统调用\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#256-execve执行指定的容器启动命令\" id=\"markdown-toc-256-execve执行指定的容器启动命令\"\u003e2.5.6 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e：执行指定的容器启动命令\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#26-处理容器事件user-namespace-相关\" id=\"markdown-toc-26-处理容器事件user-namespace-相关\"\u003e2.6 处理容器事件：user namespace 相关\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-测试\" id=\"markdown-toc-3-测试\"\u003e3 测试\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-下载官方-busybox-容器镜像\" id=\"markdown-toc-31-下载官方-busybox-容器镜像\"\u003e3.1 下载官方 busybox 容器镜像\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#311-下载镜像\" id=\"markdown-toc-311-下载镜像\"\u003e3.1.1 下载镜像\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#312-解压到本地目录\" id=\"markdown-toc-312-解压到本地目录\"\u003e3.1.2 解压到本地目录\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-编译\" id=\"markdown-toc-32-编译\"\u003e3.2 编译\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-测试\" id=\"markdown-toc-33-测试\"\u003e3.3 测试\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#331-运行-binsh交互式\" id=\"markdown-toc-331-运行-binsh交互式\"\u003e3.3.1 运行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/bin/sh\u003c/code\u003e：交互式\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#332-运行-binecho一次性执行\" id=\"markdown-toc-332-运行-binecho一次性执行\"\u003e3.3.2 运行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/bin/echo\u003c/code\u003e：一次性执行\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#333-将自己的程序放到-busybox-容器中执行\" id=\"markdown-toc-333-将自己的程序放到-busybox-容器中执行\"\u003e3.3.3 将自己的程序放到 busybox 容器中执行\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-与真实系统对比ctn-d-vs-containerdrunc\" id=\"markdown-toc-4-与真实系统对比ctn-d-vs-containerdrunc\"\u003e4 与真实系统对比：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d\u003c/code\u003e vs. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainerd+runc\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-角色和位置\" id=\"markdown-toc-41-角色和位置\"\u003e4.1 角色和位置\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#411-简化版-containerdrunc\" id=\"markdown-toc-411-简化版-containerdrunc\"\u003e4.1.1 简化版 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainerd+runc\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#412-容器运行时container-runtime\" id=\"markdown-toc-412-容器运行时container-runtime\"\u003e4.1.2 容器运行时（container runtime）\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-自动解压镜像创建容器\" id=\"markdown-toc-42-自动解压镜像创建容器\"\u003e4.2 自动解压镜像创建容器\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-容器网络\" id=\"markdown-toc-43-容器网络\"\u003e4.3 容器网络\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-特殊目录\" id=\"markdown-toc-44-特殊目录\"\u003e4.4 特殊目录\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#441-proc-procfs\" id=\"markdown-toc-441-proc-procfs\"\u003e4.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprocfs\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#442-sys-sysfs\" id=\"markdown-toc-442-sys-sysfs\"\u003e4.4.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esysfs\u003c/code\u003e)\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#443-容器-proc-存在的问题或挑战\" id=\"markdown-toc-443-容器-proc-存在的问题或挑战\"\u003e4.4.3 容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 存在的问题或挑战\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-容器-proc-信息不准解决方式\" id=\"markdown-toc-5-容器-proc-信息不准解决方式\"\u003e5 容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 信息不准解决方式\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-案例研究为什么容器-procmeminfo-对但-proccpuinfo-不对\" id=\"markdown-toc-51-案例研究为什么容器-procmeminfo-对但-proccpuinfo-不对\"\u003e5.1 案例研究：为什么容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e 对，但 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 不对\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#511-查看容器-proccpuinfo-和-procmeminfo\" id=\"markdown-toc-511-查看容器-proccpuinfo-和-procmeminfo\"\u003e5.1.1 查看容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#512-定位容器-proccpuinfo-和-procmeminfo-挂载来源varliblxcfs\" id=\"markdown-toc-512-定位容器-proccpuinfo-和-procmeminfo-挂载来源varliblxcfs\"\u003e5.1.2 定位容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e 挂载来源：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/var/lib/lxcfs/\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#513-查看-pod-lxcfs-路径挂载\" id=\"markdown-toc-513-查看-pod-lxcfs-路径挂载\"\u003e5.1.3 查看 Pod lxcfs 路径挂载\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-解决方式总结\" id=\"markdown-toc-52-解决方式总结\"\u003e5.2 解决方式总结\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#521-从上层解决应用主动适配-cgroup\" id=\"markdown-toc-521-从上层解决应用主动适配-cgroup\"\u003e5.2.1 从上层解决：应用主动适配 cgroup\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#522-从底层解决tmpfslxcfs\" id=\"markdown-toc-522-从底层解决tmpfslxcfs\"\u003e5.2.2 从底层解决：tmpfs/lxcfs\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#53-tmpfs\" id=\"markdown-toc-53-tmpfs\"\u003e5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etmpfs\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#54-lxcfs\" id=\"markdown-toc-54-lxcfs\"\u003e5.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elxcfs\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#541-lxcfsfuse-基本工作原理\" id=\"markdown-toc-541-lxcfsfuse-基本工作原理\"\u003e5.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elxcfs+fuse\u003c/code\u003e 基本工作原理\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#542-组件\" id=\"markdown-toc-542-组件\"\u003e5.4.2 组件\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#543-提供的目录挂载范围\" id=\"markdown-toc-543-提供的目录挂载范围\"\u003e5.4.3 提供的目录挂载范围\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-特殊容器运行时\" id=\"markdown-toc-6-特殊容器运行时\"\u003e6 特殊容器运行时\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-nvidia-container-runtime\" id=\"markdown-toc-61-nvidia-container-runtime\"\u003e6.1 NVIDIA container runtime\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#62-华为-ascend-docker-runtime\" id=\"markdown-toc-62-华为-ascend-docker-runtime\"\u003e6.2 华为 Ascend docker runtime\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#7-结束语\" id=\"markdown-toc-7-结束语\"\u003e7 结束语\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-引言\"\u003e1 引言\u003c/h1\u003e\n\n\u003cp\u003e从以 docker 为代表的 Linux 容器技术开始进入主流视野，到如今 k8s 一统容器编排\n（甚至\u003ca href=\"/blog/vm-on-k8s/\"\u003e虚拟机编排\u003c/a\u003e）领域，容器技术已经在大规模生产环境使用了十年以上。\n从基础设施层往上看，容器领域仍然在快速发展，新的项目层出不穷（看看 CNCF landscape 里密密麻麻的几百个项目就知道了）；\n但如果深入到\u003cstrong\u003e\u003cmark\u003e基础设施内部\u003c/mark\u003e\u003c/strong\u003e，特别深入到每台主机内部，\n会发现支撑容器的那些最基础技术其实都没怎么变 —— 对于基础设施工程师来说，\n排查和解决一些虚拟化相关的线上疑难杂症和偶发问题，需要的正是对这些底层技术的理解和把控。\u003c/p\u003e\n\n\u003cp\u003e本文试图通过一段简单但又尽量全面的代码来串联起这些底层核心技术，看看一个容器是如何创建出来的。\n有了对这个过程的理解，容器就不再是一个无从下手的黑盒，排查一些线上疑难杂症时也会更有方向。\u003c/p\u003e\n\n\u003ch2 id=\"11-linux-容器底层机制nscgroupscapabilitiesseccomp\"\u003e1.1 Linux 容器底层机制：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eNS/cgroups/Capabilities/Seccomp/...\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-container-and-runtime/container-stack-3d.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Kernel machanisms that support Linux containers\u003c/p\u003e\n\n\u003cp\u003e如上图所示，Linux 容器由几种内核机制组成，这里将它们分到了三个维度：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003enamespace\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：一种\u003cstrong\u003e\u003cmark\u003e资源视图\u003c/mark\u003e\u003c/strong\u003e隔离机制，\n  决定了进程可以看到什么，不能看到什么；例如，pid namespace 限制了进程能看到哪些其他的进程；network namespace 限制了进程能看到哪些网络设备等等。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ecgroup\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：一种限制\u003cstrong\u003e\u003cmark\u003e资源使用量\u003c/mark\u003e\u003c/strong\u003e的机制，例如一个进程最多能使用多少内存、磁盘 I/O、CPU 等等。\n    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"/blog/cgroupv2-zh/\"\u003e(译) Control Group v2 (cgroupv2)（KernelDoc, 2021）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003esetrlimit\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 是另一种限制\u003cstrong\u003e\u003cmark\u003e资源使用量\u003c/mark\u003e\u003c/strong\u003e的机制，比 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecgroups\u003c/code\u003e 要老，但能做一些 cgroups 做不了的事情。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ecapabilities\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：拆分 root privilege，精细化\u003cstrong\u003e\u003cmark\u003e用户/进程权限\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eseccomp\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：内核的一种\u003cstrong\u003e\u003cmark\u003e安全计算\u003c/mark\u003e\u003c/strong\u003e\n  （secure computation）机制，例如限制进程只能使用某些特定的系统调用。\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Seccomp\"\u003ewikipedia\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"https://man7.org/linux/man-pages/man2/seccomp.2.html\"\u003eman page\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e以上几种机制中，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecgroups\u003c/code\u003e 是通过\u003cstrong\u003e\u003cmark\u003e文件系统\u003c/mark\u003e\u003c/strong\u003e完成的，其他几种都是通过\u003cstrong\u003e\u003cmark\u003e系统调用\u003c/mark\u003e\u003c/strong\u003e完成的。\u003c/p\u003e\n\n\u003ch2 id=\"12-namespaces\"\u003e1.2 Namespaces\u003c/h2\u003e\n\n\u003cp\u003e这里只是简单列下，方面后面理解代码。其实除了 UTS，其他 namespace 都能直接从名字看出用途，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eMount：挂载空间，例如指定某个目录作为\u003cstrong\u003e\u003cmark\u003e进程看到的系统跟目录\u003c/mark\u003e\u003c/strong\u003e、独立挂载 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e 等；\u003c/li\u003e\n  \u003cli\u003ePID：进程空间，例如最大进程数量是独立的；\u003c/li\u003e\n  \u003cli\u003eNetwork (netns)：网络空间，例如能看到的网络设备是独立的，部分网络参数是独立的；\u003c/li\u003e\n  \u003cli\u003eIPC (inter-process communication)\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eUTS (UNIX Time-Sharing)\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e：让进程可以有独立的 \u003cstrong\u003e\u003cmark\u003ehost name 和 domain name\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003eUser ID：用的不多，例如 ubuntu 22.04 / kernel 6.1 默认还是关闭的。\u003c/li\u003e\n  \u003cli\u003ecgroup：独立的 cgroup 文件系统和资源管控；\u003c/li\u003e\n  \u003cli\u003eTime：kernel \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e5.6+\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"2-500-行-c-代码创建一个容器ctn-dc\"\u003e2 500 行 C 代码创建一个容器：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d.c\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e这里的代码来自\n\u003ca href=\"https://blog.lizzie.io/linux-containers-in-500-loc.html\"\u003eLinux containers in 500 lines of code (2016)\u003c/a\u003e。\n原文基于 Kernel 4.6，本文做了一些更新和重构。\u003c/p\u003e\n\n\u003ch2 id=\"20-总览ctn-dc\"\u003e2.0 总览：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d.c\u003c/code\u003e\u003c/h2\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// Step 1: parse CLI parameters, validate Linux kernel/cpu/..., generate hostname for container\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 2: setup a socket pair for container sending messages to the parent process\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esocketpair\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAF_LOCAL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSOCK_SEQPACKET\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efcntl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eF_SETFD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFD_CLOEXEC\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 3: allocate stack space for `execve()`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estack\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSTACK_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 4: setup cgroup for the container for resource isolation\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetup_cgroups\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 5: launch container 将 mount, pid, ipc, network device, hostname/domainname 放到独立的 namespace\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNS\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWCGROUP\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWPID\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWIPC\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNET\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUTS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estack\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSTACK_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// Step 6: error handling and cleanup\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e初始化\u003c/p\u003e\n\n    \u003col\u003e\n      \u003cli\u003e解析命令行参数\u003c/li\u003e\n      \u003cli\u003e检查内核版本、CPU 架构等等\u003c/li\u003e\n      \u003cli\u003e给容器随机生成一个 hostname\u003c/li\u003e\n    \u003c/ol\u003e\n  \u003c/li\u003e\n  \u003cli\u003e创建一个 socket pair，用于容器进程和主进程之间的通信；\u003c/li\u003e\n  \u003cli\u003e分配栈空间，供后面 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e 执行容器进程时使用；\u003c/li\u003e\n  \u003cli\u003e设置 cgroups 资源隔离；\u003c/li\u003e\n  \u003cli\u003e通过 clone 创建子进程，在里面通过 namespace/capabilities/seccomp 等技术实现资源管控和安全。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e核心科技在 4 和 5。下面分别来看下各步骤做的事情。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e另外需要说明，原作者的这段程序主要是为了研究容器安全，因此一些步骤是出于安全目的而做的，\n如果忽略安全考虑，要实现类似的“创建一个容器”效果，代码可以短很多，网上也有很多例子。\n本文还是基本沿用原作者的版本，但一些安全方面不详细展开，有需要可参考原文 [1]。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch2 id=\"21-初始化\"\u003e2.1 初始化\u003c/h2\u003e\n\n\u003cp\u003e程序提供了三个命令行参数，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-u \u0026lt;uid\u0026gt;\u003c/code\u003e 以什么用户权限运行；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-m \u0026lt;ctn rootfs path\u0026gt;\u003c/code\u003e 镜像解压之后的目录；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-c \u0026lt;command\u0026gt;\u003c/code\u003e 容器启动后运行的命令。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e程序会给容器随机生成一个 hostname，就像用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003edocker run\u003c/code\u003e 不指定容器名字的话，docker 也会自动生成一个名字。\u003c/p\u003e\n\n\u003ch2 id=\"22-创建-socket-pair供容器进程和父进程通信\"\u003e2.2 创建 socket pair，供容器进程和父进程通信\u003c/h2\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esocketpair\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eAF_LOCAL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSOCK_SEQPACKET\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;socketpair failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efcntl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eF_SETFD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eFD_CLOEXEC\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;fcntl failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esockets\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e子进程（容器进程）需要发消息给父进程，因此初始化一个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esocketpair\u003c/code\u003e。\n容器进程会告诉父进程是否需要设置 uid/gid mappings，\n如果需要，就会执行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetgroups/setresgid/setresuid\u003c/code\u003e。\n这些是权限相关的。\u003c/p\u003e\n\n\u003ch2 id=\"23-分配栈空间供随后-execve-执行容器启动进程使用\"\u003e2.3 分配栈空间，供随后 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e 执行容器启动进程使用\u003c/h2\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#define STACK_SIZE (1024 * 1024)\n\u003c/span\u003e    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003estack\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estack\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSTACK_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;=\u0026gt; malloc failed, out of memory?\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003egoto\u003c/span\u003e \u003cspan class=\"n\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这是后面通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e 来执行容器内进程的准备工作，是标准 Linux API，也不展开。\u003c/p\u003e\n\n\u003ch2 id=\"24-创建-cgroup为容器设置资源限额\"\u003e2.4 创建 cgroup，为容器设置资源限额\u003c/h2\u003e\n\n\u003cp\u003ecgroups 可以限制进程和进程组的资源使用量，避免有问题的容器进程影响整个系统。\n它有 v1 和 v2 两个版本，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://www.kernel.org/doc/Documentation/cgroup-v1/cgroups.txt\"\u003eDocumentation/cgroup-v1/cgroups.txt\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/cgroupv2-zh/\"\u003e(译) Control Group v2 (cgroupv2 权威指南)（KernelDoc, 2021）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e简单起见，程序里使用的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecgroupv1\u003c/code\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003econtrol\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e256\u003c/span\u003e\u003cspan class=\"p\"\u003e];\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"n\"\u003eadd_to_tasks\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c1\"\u003e// echo 0 \u0026gt; /sys/fs/cgroup/\u0026lt;controller\u0026gt;/\u0026lt;hostname\u0026gt;/tasks\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;tasks\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecgrps\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtrol\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;memory\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;memory.limit_in_bytes\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;1073741824\u0026#34;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* \u0026amp; (struct cgrp_setting) { */\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* \t.name = \u0026#34;memory.kmem.limit_in_bytes\u0026#34;, */\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* \t.value = \u0026#34;1073741824\u0026#34; */\u003c/span\u003e\n            \u003cspan class=\"cm\"\u003e/* }, */\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eadd_to_tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtrol\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;cpu.shares\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;256\u0026#34;\u003c/span\u003e \u003cspan class=\"c1\"\u003e// CPU shares\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eadd_to_tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003econtrol\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;pids\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;pids.max\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n                \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;64\u0026#34;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eadd_to_tasks\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e},\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \u0026amp; (struct cgrp_control) { */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t.control = \u0026#34;blkio\u0026#34;, */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t.settings = (struct cgrp_setting *[]) { */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\t\u0026amp; (struct cgrp_setting) { */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\t\t.name = \u0026#34;blkio.weight\u0026#34;, */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\t\t.value = \u0026#34;10\u0026#34; */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\t}, */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\t\u0026amp;add_to_tasks, */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t\tNULL */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* \t} */\u003c/span\u003e\n    \u003cspan class=\"cm\"\u003e/* }, */\u003c/span\u003e\n    \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_cgroups\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ectn_config\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_control\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003ecgrp\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrps\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecgrp\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePATH_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esnprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/sys/fs/cgroup/%s/%s\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecgrp\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003econtrol\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"n\"\u003emkdir\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_IRUSR\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eS_IWUSR\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eS_IXUSR\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ecgrp_setting\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003esetting\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecgrp\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003esettings\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esetting\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003esetting\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePATH_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n            \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003esnprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;%s/%s\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esetting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ename\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esetting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esetting\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003evalue\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esetrlimit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eRLIMIT_NOFILE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003erlimit\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{.\u003c/span\u003e\u003cspan class=\"n\"\u003erlim_max\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003erlim_cur\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e64\u003c/span\u003e\u003cspan class=\"p\"\u003e,});\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e设置 cgroups 的逻辑比较简单，基本上就是\u003cstrong\u003e\u003cmark\u003e创建 cgroup 目录\u003c/mark\u003e\u003c/strong\u003e，\n以及往 cgroups 配置文件\u003cstrong\u003e\u003cmark\u003e写入配置\u003c/mark\u003e\u003c/strong\u003e。\n上面的程序配置了以下几个资源限额：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/fs/cgroup/memory/$hostname/memory.limit_in_bytes=1GB\u003c/code\u003e：容器进程及其子进程使用的总内存不超过 1GB；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/fs/cgroup/memory/$hostname/memory.kmem.limit_in_bytes=1GB\u003c/code\u003e：容器进程及其子进程使用的总内存不超过 1GB；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/fs/cgroup/cpu/$hostname/cpu.shares=256\u003c/code\u003e：CPU 总 slice 是 1024，因此限制进程最多只能占用 1/4 CPU 时间；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/fs/cgroup/pids/$hostname/pid.max=64\u003c/code\u003e：允许容器进程及其子进程最多拥有 64 个 PID；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys/fs/cgroup/blkio/$hostname/weight=50\u003c/code\u003e：确保容器进程的 IO 优先级比系统其他进程低。\u003c/li\u003e\n  \u003cli\u003e降低文件描述符的 hard limit。fd 与 pid 类似，都是 per-user 的。这里设置上限之后，\n  后面还会 drop \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCAP_SYS_RESOURCE\u003c/code\u003e，因此容器内的用户是改不了的。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e另外，程序还通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eadd_to_tasks\u003c/code\u003e 向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e{memory,cpu,blkio,pids}/$hostname/tasks\u003c/code\u003e 文件写入 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0\u003c/code\u003e，即实现下面的效果：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003eecho \u003c/span\u003e0 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e /sys/fs/cgroup/\u0026lt;controller\u0026gt;/\u0026lt;\u003cspan class=\"nb\"\u003ehostname\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e/tasks\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etasks\u003c/code\u003e 里面存放的是受这个 cgroup 管控的进程 ID（\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ePID\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e）列表，\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0\u003c/code\u003e 是一个特殊值，表示\u003cstrong\u003e\u003cmark\u003e“执行当前写入操作的进程”\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"25-clone-启动子进程运行容器\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclone()\u003c/code\u003e 启动子进程，运行容器\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003efork()\u003c/code\u003e 是常见的创建子进程的方式，但它背后调用的是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclone()\u003c/code\u003e，后者暴露的细节更多，\n也是创建容器的关键技术。\n我们创建的子进程要能 \u003cstrong\u003e\u003cmark\u003emount 自己的根目录、设置自己的 hostname\u003c/mark\u003e\u003c/strong\u003e 以及做其他一些事情，\n要实现这个效果，需要向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eclone()\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e传递相应的 flags 参数\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNS\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWCGROUP\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWPID\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWIPC\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNET\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUTS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echild\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estack\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003eSTACK_SIZE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eSIGCHLD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eflags\u003c/code\u003e 规定了这个新创建的子进程要有多个独立的 namespace；\u003c/li\u003e\n  \u003cli\u003ex86 平台栈是向下增长的，因此将栈指针指向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003estack+STACK_SIZE\u003c/code\u003e 作为起始位置；\u003c/li\u003e\n  \u003cli\u003e最后还还加上了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eSIGCHLD\u003c/code\u003e 标志位，这样就能 \u003cstrong\u003e\u003cmark\u003ewait 子进程\u003c/mark\u003e\u003c/strong\u003e了。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e下面是子进程内做的事情：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003echild\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ectn_config\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esethostname\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estrlen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003ehostname\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esetup_mounts\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetup_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetup_capabilities\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetup_seccomp\u003c/span\u003e\u003cspan class=\"p\"\u003e();\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eexecve\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e具体来看下各步骤。\u003c/p\u003e\n\n\u003ch3 id=\"251-sethostname感知-uts-namespace\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esethostname()\u003c/code\u003e：感知 UTS namespace\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esethostname/gethostname\u003c/code\u003e 是 Linux \u003cstrong\u003e\u003cmark\u003e系统调用\u003c/mark\u003e\u003c/strong\u003e，用于设置或获取主机名（hostname）。\u003c/p\u003e\n\n\u003cp\u003ehostname 是 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eUTS\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e namespace 隔离的，\n刚才创建子进程时指定了要有独立的 UTS namespace，\n因此在这个子进程内设置 hostname 时，影响的只是\u003cstrong\u003e\u003cmark\u003e这个 UTS namespace 内（即这个容器内）所有进程\u003c/mark\u003e\u003c/strong\u003e\n看到的 hostname。\u003c/p\u003e\n\n\u003ch3 id=\"252-setup_mounts安全考虑unmount-不需要的目录\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_mounts()\u003c/code\u003e：安全考虑，unmount 不需要的目录\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eflags\u003c/code\u003e 指定了子进程有独立的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003emount namespace\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 中。\n按照最小权限原则，我们应该 \u003cstrong\u003e\u003cmark\u003eunmount 掉子进程不应访问的目录\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_mounts\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ectn_config\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// remounting everything with MS_PRIVATE...\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMS_REC\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eMS_PRIVATE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// making a temp directory and a bind mount there...\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/tmp/tmp.XXXXXX\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emkdtemp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emount\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMS_BIND\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eMS_PRIVATE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/tmp/tmp.XXXXXX/oldroot.XXXXXX\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ememcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003emkdtemp\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// pivoting root...\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esyscall\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSYS_pivot_root\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003emount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eold_root_dir\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebasename\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003eold_root\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einner_mount_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"n\"\u003estrcpy\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eold_root\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eold_root_dir\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// unmounting old_root\u003c/span\u003e\n    \u003cspan class=\"n\"\u003echdir\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eumount2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eold_root\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eMNT_DETACH\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ermdir\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eold_root\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e步骤：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e使用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eMS_PRIVATE\u003c/code\u003e 重新挂载所有内容；\u003c/li\u003e\n  \u003cli\u003e创建一个临时目录，并在其中创建一个子目录；\u003c/li\u003e\n  \u003cli\u003e将用户命令行指定的目录（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003econfig-\u0026gt;mount_dir\u003c/code\u003e）bind mount 到临时目录上；\u003c/li\u003e\n  \u003cli\u003e使用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epivot_root\u003c/code\u003e 将 bind mount 作为根目录，并将旧的根目录挂载到内部临时目录上。\n \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epivot_root\u003c/code\u003e 是一个系统调用，允许交换 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/\u003c/code\u003e 处的挂载点与另一个挂载点。\u003c/li\u003e\n  \u003cli\u003e卸载旧的根目录，删除内部临时目录。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"253-setup_userns\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_userns()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003euser namespace 实际中用的还不多，就不展开了。\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003ectn_config\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// trying a user namespace...\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"n\"\u003eunshare\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;done.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;unsupported? continuing.\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// switching to uid %d / gid %d...\u0026#34;, config-\u0026gt;uid, config-\u0026gt;uid\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetgroups\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003egid_t\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e \u003cspan class=\"p\"\u003e});\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetresgid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esetresuid\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003euid\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eUser namespace 是后来引入的一种新 namespace，但 enable user namespace 编译内\n核很复杂，另外它在系统层面（system-wide）改变了 capabilities 的语义，相比解决\n问题，它会带来更多的问题。更多信息见\n\u003ca href=\"https://www.nccgroup.trust/globalassets/our-research/us/whitepapers/2016/april/ncc_group_understanding_hardening_linux_containers-1-1.pdf\"\u003eUnderstanding and Hardening Linux Containers\u003c/a\u003e\n这个功能目前还是默认关闭的。\u003c/p\u003e\n\n  \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003esysctl kernel.unprivileged_userns_clone\nsysctl: cannot \u003cspan class=\"nb\"\u003estat\u003c/span\u003e /proc/sys/kernel/unprivileged_userns_clone: No such file or directory\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e  \u003c/div\u003e\n\u003c/blockquote\u003e\n\n\u003ch3 id=\"254-setup_capabilities禁用部分-capabilities\"\u003e2.5.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_capabilities()\u003c/code\u003e：禁用部分 capabilities\u003c/h3\u003e\n\n\u003cp\u003e同样，基于最小权限原则，drop 所有不需要的 capabilities，\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_capabilities\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"c1\"\u003e// dropping capabilities...\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edrop_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e[]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_AUDIT_CONTROL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_AUDIT_READ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_AUDIT_WRITE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_BLOCK_SUSPEND\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_DAC_READ_SEARCH\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_FSETID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_IPC_LOCK\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_MAC_ADMIN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_MAC_OVERRIDE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_MKNOD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SETFCAP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYSLOG\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_ADMIN\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_BOOT\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_MODULE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_NICE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_RAWIO\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_RESOURCE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_SYS_TIME\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eCAP_WAKE_ALARM\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e};\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003enum_caps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edrop_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e/\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edrop_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// bounding...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003enum_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eprctl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePR_CAPBSET_DROP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edrop_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// inheritable...\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ecap_t\u003c/span\u003e \u003cspan class=\"n\"\u003ecaps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecap_get_proc\u003c/span\u003e\u003cspan class=\"p\"\u003e())\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecap_set_flag\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCAP_INHERITABLE\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enum_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edrop_caps\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCAP_CLEAR\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003ecap_set_proc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003ecap_free\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003ecap_free\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecaps\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"255-setup_seccomp禁用部分系统调用\"\u003e2.5.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetup_seccomp()\u003c/code\u003e：禁用部分系统调用\u003c/h3\u003e\n\n\u003cp\u003e这里将一些有安全风险的系统调用都放到了黑名单，这可能不是最好的处理方式，但能够\n让大家非常直观地看到底层是\u003cstrong\u003e\u003cmark\u003e如何通过 seccomp 保证计算安全\u003c/mark\u003e\u003c/strong\u003e的：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_seccomp\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003escmp_filter_ctx\u003c/span\u003e \u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// filtering syscalls...\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e!\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_ACT_ALLOW\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echmod\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003echmod\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efchmod\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efchmod\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efchmodat\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISUID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efchmodat\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A2\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eS_ISGID\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eunshare\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A0\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eclone\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A0\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eioctl\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_A1\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eSCMP_CMP_MASKED_EQ\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTIOCSTI\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eTIOCSTI\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyctl\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eadd_key\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003erequest_key\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptrace\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003embind\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emigrate_pages\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003emove_pages\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eset_mempolicy\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euserfaultfd\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_rule_add\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FAIL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_SYS\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eperf_event_open\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_attr_set\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSCMP_FLTATR_CTL_NNP\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_load\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003eseccomp_release\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// all pass, return success\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eseccomp_release\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ectx\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003edocker 官方有一些\u003ca href=\"https://docs.docker.com/engine/security/seccomp/\"\u003e相关文档\u003c/a\u003e，感兴趣可移步。\u003c/p\u003e\n\n\u003ch3 id=\"256-execve执行指定的容器启动命令\"\u003e2.5.6 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexecve()\u003c/code\u003e：执行指定的容器启动命令\u003c/h3\u003e\n\n\u003cp\u003e前面资源视图隔离（namespace）、资源限额（cgroups）、文件目录（mount）、权限（capabilities）、安全（seccomp）等工作\n都做好之后，就可以启动用户指定的容器进程了（类似于 docker 中的 entrypoint 或 command）：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"n\"\u003eexecve\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003econfig\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"nb\"\u003eNULL\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e至此，如果一切正常，容器进程就起来了。接下来我们还要容器进程与主进程的通信，\n类似于真实环境中 containerd 处理来自具体容器的消息。\u003c/p\u003e\n\n\u003ch2 id=\"26-处理容器事件user-namespace-相关\"\u003e2.6 处理容器事件：user namespace 相关\u003c/h2\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cp\"\u003e#define USERNS_OFFSET 10000\n#define USERNS_COUNT 2000\n\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ehandle_child_uid_map\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epid_t\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003euid_map\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;couldn\u0026#39;t read from child!\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_userns\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ePATH_MAX\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n        \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;uid_map\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;gid_map\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e};\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esnprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/proc/%d/%s\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003echild_pid\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003efile\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;snprintf too big? %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;writing %s...\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003euid_map\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003epath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;open failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euid_map\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;0 %d %d\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUSERNS_OFFSET\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eUSERNS_COUNT\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n                \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;dprintf failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euid_map\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n                \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003euid_map\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e \u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;couldn\u0026#39;t write: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"3-测试\"\u003e3 测试\u003c/h1\u003e\n\n\u003ch2 id=\"31-下载官方-busybox-容器镜像\"\u003e3.1 下载官方 busybox 容器镜像\u003c/h2\u003e\n\n\u003ch3 id=\"311-下载镜像\"\u003e3.1.1 下载镜像\u003c/h3\u003e\n\n\u003cp\u003e这里用 docker 从官方 pull，然后保存为本地 tar 文件：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edk pull busybox:1.36\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003edk save busybox:1.36 \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e busybox-1.36.tar\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"312-解压到本地目录\"\u003e3.1.2 解压到本地目录\u003c/h3\u003e\n\n\u003cp\u003e将 tar 文件解压，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo tar \u003c/span\u003exvf busybox-1.36.tar\n244ed32d6820f8861f94beda2456fa7032a832a4e7ed7e72fa66b802518f9adc/\n244ed32d6820f8861f94beda2456fa7032a832a4e7ed7e72fa66b802518f9adc/VERSION\n244ed32d6820f8861f94beda2456fa7032a832a4e7ed7e72fa66b802518f9adc/json\n244ed32d6820f8861f94beda2456fa7032a832a4e7ed7e72fa66b802518f9adc/layer.tar\nf5fb98afcf9f5c6e8e069557f605b15b52643166c82ac5695f49fc6b0be04ee8.json\nmanifest.json\nrepositories\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e其中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elayer.tar\u003c/code\u003e 是镜像本身，其他都是元数据。\n我们先创建一个目录 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e~/busybox-1.36-rootfs\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e（名字随便），\n然后将 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elayer.tar\u003c/code\u003e 解压到这个目录：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003emkdir\u003c/span\u003e ~/busybox-1.36-rootfs \u003cspan class=\"c\"\u003e#\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003etar \u003c/span\u003exvf busybox-1.36/244ed32d6820f8861f94beda2456fa7032a832a4e7ed7e72fa66b802518f9adc/layer.tar \u003cspan class=\"nt\"\u003e-C\u003c/span\u003e ~/busybox-1.36-rootfs\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e得到的就是一个看着像 \u003cstrong\u003e\u003cmark\u003e一台 Linux node 根目录\u003c/mark\u003e\u003c/strong\u003e的文件夹了：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e ~/busybox-1.36-rootfs/\nbin  dev  etc  home  lib  lib64  root  tmp  usr  var\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e我们一会就是用这个目录作为\u003cstrong\u003e\u003cmark\u003e容器根目录\u003c/mark\u003e\u003c/strong\u003e来启动容器。\u003c/p\u003e\n\n\u003ch2 id=\"32-编译\"\u003e3.2 编译\u003c/h2\u003e\n\n\u003cp\u003e这里是在 ubuntu22 kernel 6.1 上编译：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo \u003c/span\u003eapt \u003cspan class=\"nb\"\u003einstall \u003c/span\u003elibseccomp-dev libcap-dev \u003cspan class=\"nt\"\u003e-y\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egcc \u003cspan class=\"nt\"\u003e-Wl\u003c/span\u003e,--no-as-needed \u003cspan class=\"nt\"\u003e-lcap\u003c/span\u003e \u003cspan class=\"nt\"\u003e-lseccomp\u003c/span\u003e ctn-d.c\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e得到 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ea.out\u003c/code\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"33-测试\"\u003e3.3 测试\u003c/h2\u003e\n\n\u003ch3 id=\"331-运行-binsh交互式\"\u003e3.3.1 运行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/bin/sh\u003c/code\u003e：交互式\u003c/h3\u003e\n\n\u003cp\u003e指定\u003cstrong\u003e\u003cmark\u003e解压之后的 busybox 容器镜像目录\u003c/mark\u003e\u003c/strong\u003e作为容器根目录（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-m ~/busybox-rootfs-1.36/\u003c/code\u003e），\n以 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eroot\u003c/code\u003e 权限（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-u 0\u003c/code\u003e）运行 shell（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e-c /bin/sh\u003c/code\u003e）：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo\u003c/span\u003e ./a.out \u003cspan class=\"nt\"\u003e-u\u003c/span\u003e 0 \u003cspan class=\"nt\"\u003e-m\u003c/span\u003e ~/busybox-rootfs-1.36/ \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e /bin/sh\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e validating Linux version...6.1.11-060111-generic on x86_64.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e generating \u003cspan class=\"nb\"\u003ehostname \u003c/span\u003e\u003cspan class=\"k\"\u003efor \u003c/span\u003econtainer ... 1cd132c-ten-of-pentacles \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e setting cgroups...memory...cpu...pids...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e setting rlimit...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e remounting everything with MS_PRIVATE...remounted.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e making a temp directory and a \u003cspan class=\"nb\"\u003ebind \u003c/span\u003emount there...\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e temp directory /tmp/tmp.j1SPbh\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e\u003cspan class=\"nb\"\u003e.\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e pivoting root...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e unmounting /oldroot.p216lf...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e trying a user namespace...writing /proc/3544398/uid_map...writing /proc/3544398/gid_map...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e switching to uid 0 / gid 0...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e dropping capabilities...bounding...inheritable...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e filtering syscalls...done.\n/ \u003cspan class=\"c\"\u003e#\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e最后一行的命令提示符变了，这就表示\u003cstrong\u003e\u003cmark\u003e已经进入到了容器内的 shell\u003c/mark\u003e\u003c/strong\u003e，\n接下来可以执行几个 busybox 镜像内有的命令来测试：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e/ \u003cspan class=\"c\"\u003e# whoami                       # \u0026lt;-- 已经进入到容器内\u003c/span\u003e\nroot\n/ \u003cspan class=\"c\"\u003e# hostname\u003c/span\u003e\n17bb49-death\n/ \u003cspan class=\"c\"\u003e# ls\u003c/span\u003e\nbin    dev    etc    home   lib    lib64  root   tmp    usr    var\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e最后通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eexit\u003c/code\u003e 命令正常退出 shell，由于这是容器主进程，因此 shell 退出之后容器也就退出了：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e/ \u003cspan class=\"c\"\u003e# exit                         # \u0026lt;-- 退出容器\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e cleaning cgroups...done.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"332-运行-binecho一次性执行\"\u003e3.3.2 运行 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/bin/echo\u003c/code\u003e：一次性执行\u003c/h3\u003e\n\n\u003cp\u003e再测试下直接在容器内执行一段任务（非交互式），运行完就会自动退出：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003esudo\u003c/span\u003e ./a.out \u003cspan class=\"nt\"\u003e-u\u003c/span\u003e 0 \u003cspan class=\"nt\"\u003e-m\u003c/span\u003e ~/busybox-rootfs-1.36/ \u003cspan class=\"nt\"\u003e-c\u003c/span\u003e /bin/echo \u003cspan class=\"s2\"\u003e\u0026#34;hello from inside container\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e validating Linux version...6.1.11-060111-generic on x86_64.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e generating \u003cspan class=\"nb\"\u003ehostname \u003c/span\u003e\u003cspan class=\"k\"\u003efor \u003c/span\u003econtainer ... 1cd132c-ten-of-pentacles \u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e setting cgroups...memory...cpu...pids...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e setting rlimit...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e remounting everything with MS_PRIVATE...remounted.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e making a temp directory and a \u003cspan class=\"nb\"\u003ebind \u003c/span\u003emount there...\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e temp directory /tmp/tmp.j1SPbh\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e\u003cspan class=\"nb\"\u003e.\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e pivoting root...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e unmounting /oldroot.p216lf...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e trying a user namespace...writing /proc/3544398/uid_map...writing /proc/3544398/gid_map...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e switching to uid 0 / gid 0...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e dropping capabilities...bounding...inheritable...done.\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e filtering syscalls...done.\nhello from inside container  \u003cspan class=\"c\"\u003e#   \u0026lt;-- 容器内执行 echo，执行完就退出了\u003c/span\u003e\n\u003cspan class=\"o\"\u003e=\u0026gt;\u003c/span\u003e cleaning cgroups...done.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"333-将自己的程序放到-busybox-容器中执行\"\u003e3.3.3 将自己的程序放到 busybox 容器中执行\u003c/h3\u003e\n\n\u003cp\u003e如果你有一些没什么依赖的程序（或者依赖已经在 busybox 中了），\n那将这样的程序放到 busybox 容器镜像中也是可以运行的。下面看个 golang 的例子。\u003c/p\u003e\n\n\u003cp\u003e源码：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"k\"\u003epackage\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003eimport\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;fmt\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efmt\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Hello World from Golang\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e编译，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ego build hello-world.go\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e编译生成的\u003cstrong\u003e\u003cmark\u003e可执行文件没有任何依赖\u003c/mark\u003e\u003c/strong\u003e，因此我们将它放到 busybox 容器的可执行文件目录：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003emv \u003c/span\u003ehello-world ~/busybox-rootfs-1.36/bin/\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e然后在容器 shell 内尝试执行：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e/ \u003cspan class=\"c\"\u003e# hello-world\u003c/span\u003e\nHello World from Golang\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e成功！\u003c/p\u003e\n\n\u003ch1 id=\"4-与真实系统对比ctn-d-vs-containerdrunc\"\u003e4 与真实系统对比：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ectn-d\u003c/code\u003e vs. \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainerd+runc\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003e通过以上内容，可以看到我们 500 来行的 C 程序可以实现创建和运行（简易版）Linux 容器的功能。\n那么，在实际上它对应的是容器技术栈中的哪些组件呢？\u003c/p\u003e\n\n\u003ch2 id=\"41-角色和位置\"\u003e4.1 角色和位置\u003c/h2\u003e\n\n\u003ch3 id=\"411-简化版-containerdrunc\"\u003e4.1.1 简化版 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econtainerd+runc\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/the-mysterious-container-somaxconn/create-pod-journey.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003ek8s 中容器相关的组件。dockerd 是可选的，较新版本的 k8s 中已经把 dockerd 这一层去掉了。[3]\u003c/p\u003e\n\n\u003cp\u003e上图是 k8s 创建 pod 所涉及的一些核心组件，大家对 docker/containerd 比较熟悉，\n但其实 containerd 并不是一线干活的，而是跟 kubelet/docker 一样，都是负责管理工作的“经理”（container manager），\n真正干活的是更底层的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003erunc\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e从软件栈上来说，本文的程序其实就是一个简化版的 containerd+runc。\n参考 [3] 中 k8s 容器的创建过程中可以看到，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erunc\u003c/code\u003e 是基于一个 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003econfig.json\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 创建容器的，本文程序中的 config 其实就是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003econfig.json\u003c/code\u003e 的一个极其简化版。\u003c/li\u003e\n  \u003cli\u003ek8s 创建容器时，是 containerd 通过 config.json 传给 runc 的；本文的程序也支持这些配置，只是简单起见在程序里 hardcode 了。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e下面是一个真实 k8s pod 对应的 config.json：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode1\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /run/containerd/io.containerd.runtime.v1.linux/moby/eedd6341c/config.json | jq\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;process\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s2\"\u003e\u0026#34;user\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;uid\u0026#34;\u003c/span\u003e: 0,\n      \u003cspan class=\"s2\"\u003e\u0026#34;gid\u0026#34;\u003c/span\u003e: 0\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;args\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n    ...\n    \u003cspan class=\"s2\"\u003e\u0026#34;memory\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;limit\u0026#34;\u003c/span\u003e: 2147483648,\n      \u003cspan class=\"s2\"\u003e\u0026#34;swap\u0026#34;\u003c/span\u003e: 2147483648,\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;cpu\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;shares\u0026#34;\u003c/span\u003e: 1024,\n      \u003cspan class=\"s2\"\u003e\u0026#34;quota\u0026#34;\u003c/span\u003e: 100000,\n      \u003cspan class=\"s2\"\u003e\u0026#34;period\u0026#34;\u003c/span\u003e: 100000,\n      \u003cspan class=\"s2\"\u003e\u0026#34;cpus\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;0-31\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;blockIO\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;weight\u0026#34;\u003c/span\u003e: 0\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;cgroupsPath\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/kubepods/besteffort/pod187acdb9/eedd6341c\u0026#34;\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;namespaces\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;mount\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n      \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;network\u0026#34;\u003c/span\u003e\n      \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n      ...\n    \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;maskedPaths\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/asound\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/acpi\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/kcore\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/keys\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/latency_stats\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/timer_list\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/timer_stats\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/sched_debug\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/scsi\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/sys/firmware\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e]\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;readonlyPaths\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/bus\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/fs\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/irq\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/sys\u0026#34;\u003c/span\u003e,\n      \u003cspan class=\"s2\"\u003e\u0026#34;/proc/sysrq-trigger\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e]\u003c/span\u003e\n  \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"412-容器运行时container-runtime\"\u003e4.1.2 容器运行时（container runtime）\u003c/h3\u003e\n\n\u003cp\u003e如果根据下面的定义，本文的程序其实就是一个\u003cstrong\u003e\u003cmark\u003e容器运行时\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eThe container runtime is a software package that knows how to\n\u003cstrong\u003e\u003cmark\u003eleverage specific features\u003c/mark\u003e\u003c/strong\u003e on a supported operating system\nto create a space \u003cstrong\u003e\u003cmark\u003eto run the specified container image\u003c/mark\u003e\u003c/strong\u003e.\u003c/p\u003e\n\n  \u003cp\u003e\u003ca href=\"https://sysdig.com/learn-cloud-native/container-security/what-are-container-runtimes\"\u003eWhat are container runtimes?\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch2 id=\"42-自动解压镜像创建容器\"\u003e4.2 自动解压镜像创建容器\u003c/h2\u003e\n\n\u003cp\u003e本文创建容器时，是先手动将一个 docker 镜像解压到本地目录，然再指定这个目录创建容器。\n这个过程用程序来实现也是很简单的，只需要对我们的程序稍加扩展就行，\n就能\u003cstrong\u003e\u003cmark\u003e直接指定 docker 镜像创建容器\u003c/mark\u003e\u003c/strong\u003e了。\u003c/p\u003e\n\n\u003cp\u003e不过这个过程（镜像打包和解压）\u003cstrong\u003e\u003cmark\u003e很容易引入安全漏洞\u003c/mark\u003e\u003c/strong\u003e，\n社区的几个\u003ca href=\"https://blog.lizzie.io/linux-containers-in-500-loc.html#fn.46\"\u003e相关 bug\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"43-容器网络\"\u003e4.3 容器网络\u003c/h2\u003e\n\n\u003cp\u003e这个要花的篇幅就比较长了，常规网络方案来说分几步：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e在宿主机上创建一个 Linux bridge；\u003c/li\u003e\n  \u003cli\u003e创建一个 veth pair，一端连接到 Linux bridge，一端放到容器的 network namespace 内；\u003c/li\u003e\n  \u003cli\u003e配置 IP/MAC/NAT 规则等，让容器网络能连通。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e可以用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003enet_prio\u003c/code\u003e cgroup controller 对网络资源进行限额。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://blog.lizzie.io/linux-containers-in-500-loc.html#fn.1\"\u003e编程参考\u003c/a\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c1\"\u003e// Compile: \u0026#34;gcc -Wall -Werror -static subverting_networking.c\u0026#34;\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define _GNU_SOURCE\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;stdio.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;unistd.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sched.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/ioctl.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;sys/socket.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026lt;linux/sockios.h\u0026gt;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e**\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eunshare\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eCLONE_NEWUSER\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eCLONE_NEWNET\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;++ unshare failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"cm\"\u003e/* this is how you create a bridge... */\u003c/span\u003e\n\t\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003esock\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e((\u003c/span\u003e\u003cspan class=\"n\"\u003esock\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esocket\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ePF_LOCAL\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSOCK_STREAM\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;++ socket failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eioctl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esock\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eSIOCBRADDBR\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;br0\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n\t\t\u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;++ ioctl failed: %m\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\t\u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\t\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\t\u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esock\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;++ success!\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\t\u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"44-特殊目录\"\u003e4.4 特殊目录\u003c/h2\u003e\n\n\u003cp\u003e我们\u003cstrong\u003e\u003cmark\u003e容器内的目录\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# ls /\u003c/span\u003e\nbin    dev    etc    home   lib    lib64  root   tmp    usr    var\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e就是\u003cstrong\u003e\u003cmark\u003ebusybox 镜像解压之后的目录\u003c/mark\u003e\u003c/strong\u003e，没有任何新增或减少。\n\u003cstrong\u003e\u003cmark\u003e对比宿主机根目录\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# In the container\u003c/span\u003e\n\u003cspan class=\"c\"\u003e# ls /\u003c/span\u003e\nbin        dev  etc  home  lib  lib64                         root                       tmp  usr  var\n\n\u003cspan class=\"c\"\u003e# On the node\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e /\nbin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到，少了 \u003ccode\u003eboot/mnt/opt/\u003cmark\u003eproc\u003c/mark\u003e/run/sbin/srv/\u003cmark\u003esys\u003c/mark\u003e\u003c/code\u003e\n这几个目录。\u003c/p\u003e\n\n\u003cp\u003e这里讨论下其中最重要的两个：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e，它们不是普通目录，也不是普通文件系统，\n所以需要容器运行时\u003cstrong\u003e\u003cmark\u003e单独处理\u003c/mark\u003e\u003c/strong\u003e，在创建容器时挂载进去。Linux node 上执行，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003emount | egrep \u003cspan class=\"s2\"\u003e\u0026#34;(/sys|/proc)\u0026#34;\u003c/span\u003e\nsysfs on /sys \u003cspan class=\"nb\"\u003etype \u003c/span\u003esysfs \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime\u003cspan class=\"o\"\u003e)\u003c/span\u003e\nproc on /proc \u003cspan class=\"nb\"\u003etype \u003c/span\u003eproc \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,nosuid,nodev,noexec,relatime\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到它们是两种不同的特殊文件系统：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eproc\u003c/code\u003e 类型，但一般也称为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprocfs\u003c/code\u003e；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esysfs\u003c/code\u003e 类型。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e他们都是\u003cstrong\u003e\u003cmark\u003e内核暴露给用户空间的接口\u003c/mark\u003e\u003c/strong\u003e，绝大部分都是只读，获取内核信息。\u003c/p\u003e\n\n\u003ch3 id=\"441-proc-procfs\"\u003e4.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprocfs\u003c/code\u003e)\u003c/h3\u003e\n\n\u003cp\u003e从发展过程来说 [4]，\u003cstrong\u003e\u003cmark\u003e先有的 /proc，后有的 /sys\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e从 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 这个名字上也可以看成，主要用于存储\u003cstrong\u003e\u003cmark\u003e进程信息\u003c/mark\u003e\u003c/strong\u003e，例如每个进程都有一个对应的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/\u0026lt;pid\u0026gt;/\u003c/code\u003e 目录，\n很多系统工具例如 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eps/top/free\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 之类的，也是通过读取 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 来获取系统信息的。\n但由于\u003cstrong\u003e\u003cmark\u003e缺乏统一设计和管理\u003c/mark\u003e\u003c/strong\u003e，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 越来越庞杂，有失控的趋势，\n因此后来又设计了一个全新的文件系统，这就是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"442-sys-sysfs\"\u003e4.4.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esysfs\u003c/code\u003e)\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/sys\u003c/code\u003e 更加\u003cstrong\u003e\u003cmark\u003e结构化\u003c/mark\u003e\u003c/strong\u003e，组织得更好。\n\u003cstrong\u003e\u003cmark\u003e较新的基础设施都是基于 sysfs 的\u003c/mark\u003e\u003c/strong\u003e，但开源产品惯性太大，\nLinux 惯性尤其大，所以 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 还是继续维护和使用的。\u003c/p\u003e\n\n\u003ch3 id=\"443-容器-proc-存在的问题或挑战\"\u003e4.4.3 容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 存在的问题或挑战\u003c/h3\u003e\n\n\u003cp\u003e如果看 docker/containerd/runc 之类的容器运行时，会发现它是把宿主机 /proc 挂载到了容器，\n这会导致什么问题呢？\n刚才说了，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 里面都是进程的统计信息，因此直接把宿主机 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 暴露给容器，将带来几方面问题：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e容器内能看到宿主机以及其他容器的进程信息（虽然原则上是只读的），存在安全风险；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e容器内读取某些文件，例如 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e，本来是希望得到容器自己的内存信息，但实际上拿到的是宿主机的，因此数据不准，\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e人看了或很困惑，但这还是不是最重要的，\u003c/li\u003e\n      \u003cli\u003e如果上层应用直接依赖这个数据，比如监控系统或一些 Java 业务应用，那会直接导致业务问题。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e资源视图错误：结合 1 \u0026amp; 2，容器看到的东西\u003cstrong\u003e\u003cmark\u003e比自己应该看到的多\u003c/mark\u003e\u003c/strong\u003e，或者看到的资源量\u003cstrong\u003e\u003cmark\u003e比自己真实能用的资源大\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e但要解决这个问题又是比较麻烦的，因为容器的设计目的只是\u003cstrong\u003e\u003cmark\u003e通过必要的资源隔离来完成计算任务\u003c/mark\u003e\u003c/strong\u003e，\n并不是让它像虚拟机一样作为独立机器提供给用户。\n那实际中是怎么解决呢？\u003c/p\u003e\n\n\u003ch1 id=\"5-容器-proc-信息不准解决方式\"\u003e5 容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 信息不准解决方式\u003c/h1\u003e\n\n\u003ch2 id=\"51-案例研究为什么容器-procmeminfo-对但-proccpuinfo-不对\"\u003e5.1 案例研究：为什么容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e 对，但 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 不对\u003c/h2\u003e\n\n\u003cp\u003e我们通过一个真实 k8s 环境中的例子来倒查一下。\u003c/p\u003e\n\n\u003ch3 id=\"511-查看容器-proccpuinfo-和-procmeminfo\"\u003e5.1.1 查看容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e在一个 k8s+docker+containerd+runc 的环境，挑一个容器，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e \u0026lt;ns\u0026gt; \u0026lt;pod\u0026gt; \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e yaml\n...\n    resources:\n      requests:\n        cpu: 125m\n        memory: 751619276800m\n      limits:\n        cpu: \u003cspan class=\"s2\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\n        memory: 1Gi\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这里的意思是，这个容器需要 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e125m = 125/1000 = 1/8\u003c/code\u003e 个 CPU，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e751 MB\u003c/code\u003e 内存；\n\u003cstrong\u003e\u003cmark\u003e最多\u003c/mark\u003e\u003c/strong\u003e能使用 \u003cstrong\u003e\u003cmark\u003e1 个 CPU，1GB 内存\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e在容器里面看 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 挂载信息：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cat /proc/mounts | grep proc\u003c/span\u003e\nproc /proc proc rw,nosuid,nodev,noexec,relatime 0 0\nlxcfs /proc/meminfo fuse.lxcfs ro,relatime,user_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,group_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,allow_other 0 0\nlxcfs /proc/diskstats fuse.lxcfs ro,relatime,user_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,group_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,allow_other 0 0\nproc /proc/bus proc ro,relatime 0 0\nproc /proc/fs proc ro,relatime 0 0\nproc /proc/irq proc ro,relatime 0 0\nproc /proc/sys proc ro,relatime 0 0\nproc /proc/sysrq-trigger proc ro,relatime 0 0\ntmpfs /proc/acpi tmpfs ro,relatime 0 0\ntmpfs /proc/kcore tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0\ntmpfs /proc/keys tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0\ntmpfs /proc/timer_list tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0\ntmpfs /proc/sched_debug tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0\ntmpfs /proc/scsi tmpfs ro,relatime 0 0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e然后通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 查看 CPU 和内存：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cat /proc/cpuinfo\u003c/span\u003e\nprocessor       : 0\nvendor_id       : GenuineIntel\n...\nprocessor       : 31            \u003cspan class=\"c\"\u003e# 32 CPU\u003c/span\u003e\nvendor_id       : GenuineIntel\n\n\u003cspan class=\"o\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cat /proc/meminfo\u003c/span\u003e\nMemTotal:        1048576 kB     \u003cspan class=\"c\"\u003e# 1GB\u003c/span\u003e\nMemFree:          893416 kB\nMemAvailable:     893416 kB\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到，\u003cstrong\u003e\u003cmark\u003eMemory 是对的，CPU 不对\u003c/mark\u003e\u003c/strong\u003e，实际上是\u003cstrong\u003e\u003cmark\u003e宿主机的 CPU 数量\u003c/mark\u003e\u003c/strong\u003e。\n我们接下来是看看为什么会这样。\u003c/p\u003e\n\n\u003ch3 id=\"512-定位容器-proccpuinfo-和-procmeminfo-挂载来源varliblxcfs\"\u003e5.1.2 定位容器 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e 挂载来源：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/var/lib/lxcfs/\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e在宿主机上查看容器的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003econfig.json\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 文件，\n前面提到过，runc 就是根据这个文件创建容器的，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /run/containerd/io.containerd.runtime.v1.linux/moby/d32b1bf.config.json | jq \u003cspan class=\"nb\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e里面能看到文件的挂载信息：\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"w\"\u003e    \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;destination\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/proc/meminfo\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;bind\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/var/lib/lxcfs/proc/meminfo\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;options\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;rbind\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ro\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;rprivate\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"err\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;destination\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/proc/diskstats\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;bind\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;/var/lib/lxcfs/proc/diskstats\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;options\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;rbind\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;ro\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n        \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;rprivate\u0026#34;\u003c/span\u003e\u003cspan class=\"w\"\u003e\n      \u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e\u003cspan class=\"w\"\u003e\n    \u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"err\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到有 meminfo 的挂载，但是没有 cpuinfo 的挂载。\u003c/p\u003e\n\n\u003cp\u003e这个配置是从 k8s 一路传下来的，因此我们去 k8s 里再看看 pod spec。\u003c/p\u003e\n\n\u003ch3 id=\"513-查看-pod-lxcfs-路径挂载\"\u003e5.1.3 查看 Pod lxcfs 路径挂载\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ek get pod xxx \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e \u0026lt;ns\u0026gt; \u0026lt;pod\u0026gt; \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e yaml\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cdiv class=\"language-yaml highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e    \u003cspan class=\"na\"\u003evolumeMounts\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/proc/meminfo\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ememinfo\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ereadOnly\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n    \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003emountPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/proc/diskstats\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ediskstats\u003c/span\u003e\n      \u003cspan class=\"na\"\u003ereadOnly\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"no\"\u003etrue\u003c/span\u003e\n\n  \u003cspan class=\"na\"\u003evolumes\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ehostPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003epath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/lib/lxcfs/proc/meminfo\u003c/span\u003e\n      \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eFile\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ememinfo\u003c/span\u003e\n  \u003cspan class=\"pi\"\u003e-\u003c/span\u003e \u003cspan class=\"na\"\u003ehostPath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e\n      \u003cspan class=\"na\"\u003epath\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003e/var/lib/lxcfs/proc/diskstats\u003c/span\u003e\n      \u003cspan class=\"na\"\u003etype\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003eFile\u003c/span\u003e\n    \u003cspan class=\"na\"\u003ename\u003c/span\u003e\u003cspan class=\"pi\"\u003e:\u003c/span\u003e \u003cspan class=\"s\"\u003ediskstats\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e确实是 pod 里面指定的，而且只有 meminfo 的挂载，没有 cpuinfo 的挂载。\u003c/p\u003e\n\n\u003cp\u003e到这里答案基本就猜到了：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e信息正确的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e，是通过 lxcfs 挂载来实现的；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e 不正确是因为没有配置 lxcfs 或者不支持。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"52-解决方式总结\"\u003e5.2 解决方式总结\u003c/h2\u003e\n\n\u003cp\u003e前面已经分析了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 不准的问题，以及把它搞准所面临的挑战。\n实际中怎么解决的呢？分两种。\u003c/p\u003e\n\n\u003ch3 id=\"521-从上层解决应用主动适配-cgroup\"\u003e5.2.1 从上层解决：应用主动适配 cgroup\u003c/h3\u003e\n\n\u003cp\u003e应用程序主动适配 cgroup，需要的信息都去容器的\n\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e/sys/fs/cgroup\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 目录读取，不要去容器的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/\u003c/code\u003e 目录读。\u003c/p\u003e\n\n\u003cp\u003e很多监控采集程序都是这么做的，比如 k8s 用的 cadvisor，采集 cpuload，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/google/cadvisor/blob/v0.48.1/manager/container.go#L652-L654\"\u003emanager/container.go\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/google/cadvisor/blob/v0.48.1/utils/cpuload/netlink/example/example.go\"\u003ecpuload/netlink/example\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"522-从底层解决tmpfslxcfs\"\u003e5.2.2 从底层解决：tmpfs/lxcfs\u003c/h3\u003e\n\n\u003cp\u003e为了兼容用户程序，用 tmpfs/lxcfs 等特殊文件系统挂载来模拟部分 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e 文件，也是一种解决方式。\u003c/p\u003e\n\n\u003ch2 id=\"53-tmpfs\"\u003e5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etmpfs\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Tmpfs\"\u003etmpfs\u003c/a\u003e (Temporary File System) 是很多 Unix-like 操作系统都支持的一种临时文件存储方案。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e看起来是挂载的文件系统（mounted file system）；\u003c/li\u003e\n  \u003cli\u003e但\u003cstrong\u003e\u003cmark\u003e数据在内存\u003c/mark\u003e\u003c/strong\u003e（非持久存储），\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e类似的还有 \u003ca href=\"https://en.wikipedia.org/wiki/RAM_disk\"\u003eRAM disk\u003c/a\u003e，\n看起来是一个虚拟磁盘，有磁盘文件系统，但其实数据在内存中。\u003c/p\u003e\n\n\u003cp\u003e从上面容器的输出可以看成，下面的文件都是用 tmpfs 覆盖的，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cat /proc/mounts | grep proc\u003c/span\u003e\n..\ntmpfs /proc/acpi tmpfs ro,relatime 0 0                            \u003cspan class=\"c\"\u003e# 只读\u003c/span\u003e\ntmpfs /proc/kcore tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0        \u003cspan class=\"c\"\u003e# 读写\u003c/span\u003e\ntmpfs /proc/keys tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0         \u003cspan class=\"c\"\u003e# 读写\u003c/span\u003e\ntmpfs /proc/timer_list tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0   \u003cspan class=\"c\"\u003e# 读写\u003c/span\u003e\ntmpfs /proc/sched_debug tmpfs rw,nosuid,size\u003cspan class=\"o\"\u003e=\u003c/span\u003e65536k,mode\u003cspan class=\"o\"\u003e=\u003c/span\u003e755 0 0  \u003cspan class=\"c\"\u003e# 读写\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"54-lxcfs\"\u003e5.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elxcfs\u003c/code\u003e\u003c/h2\u003e\n\n\u003ch3 id=\"541-lxcfsfuse-基本工作原理\"\u003e5.4.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elxcfs+fuse\u003c/code\u003e 基本工作原理\u003c/h3\u003e\n\n\u003cp\u003elxcfs 是一个简单的\u003cstrong\u003e\u003cmark\u003e用户空间文件系统\u003c/mark\u003e\u003c/strong\u003e，设计目的就是 workaround 当前的一些 Linux 内核限制。\n提供两个主要东西：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e一些文件\u003c/mark\u003e\u003c/strong\u003e：能 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ebind-mount\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 到 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc\u003c/code\u003e，做到 CGroup-aware；\u003c/li\u003e\n  \u003cli\u003e一个 cgroupfs-like tree：container aware。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e代码基于 libfuse 用纯 C 编写。\u003c/p\u003e\n\n\u003cp\u003e上面的容器输出里：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003econtainer\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"c\"\u003e# cat /proc/mounts | grep proc\u003c/span\u003e\n...\nlxcfs /proc/meminfo fuse.lxcfs ro,relatime,user_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,group_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,allow_other 0 0   \u003cspan class=\"c\"\u003e# 只读\u003c/span\u003e\nlxcfs /proc/diskstats fuse.lxcfs ro,relatime,user_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,group_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,allow_other 0 0 \u003cspan class=\"c\"\u003e# 只读\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e用 lxcfs 接管了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/meminfo\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/diskstats\u003c/code\u003e，但是没有接管 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e/proc/cpuinfo\u003c/code\u003e，这也是为什么\n我们前面看到 Memory 是对的，CPU 数量不对。\u003c/p\u003e\n\n\u003cp\u003elxcfs 工作原理说起来非常简单：node 上起一个 daemon 进程，\n\u003cstrong\u003e\u003cmark\u003e劫持容器内的 \u003ccode\u003e/proc\u003c/code\u003e 读操作\u003c/mark\u003e\u003c/strong\u003e，\n通过 fuse 文件系统转到对容器 cgroupfs 的读写，然后将信息返回给请求方，如下图所示：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-container-and-runtime/lxcfs-fuse.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. lxcfs/fuse workflow: how a read operation is handled\u003c/p\u003e\n\n\u003ch3 id=\"542-组件\"\u003e5.4.2 组件\u003c/h3\u003e\n\n\u003cp\u003e只有一个 daemon 进程，运行在每个 node 上：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"o\"\u003e(\u003c/span\u003enode\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"nv\"\u003e$ \u003c/span\u003esystemctl status lxcfs\n● lxcfs.service - FUSE filesystem \u003cspan class=\"k\"\u003efor \u003c/span\u003eLXC\n   Loaded: loaded \u003cspan class=\"o\"\u003e(\u003c/span\u003e/usr/lib/systemd/system/lxcfs.service\u003cspan class=\"p\"\u003e;\u003c/span\u003e enabled\u003cspan class=\"p\"\u003e;\u003c/span\u003e vendor preset: disabled\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n   Active: active \u003cspan class=\"o\"\u003e(\u003c/span\u003erunning\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e查看配置：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /usr/lib/systemd/system/lxcfs.service\n\u003cspan class=\"o\"\u003e[\u003c/span\u003eUnit]\n\u003cspan class=\"nv\"\u003eDescription\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eFUSE filesystem \u003cspan class=\"k\"\u003efor \u003c/span\u003eLXC\n\u003cspan class=\"nv\"\u003eConditionVirtualization\u003c/span\u003e\u003cspan class=\"o\"\u003e=!\u003c/span\u003econtainer\n\u003cspan class=\"nv\"\u003eBefore\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003elxc.service\n\u003cspan class=\"nv\"\u003eDocumentation\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eman:lxcfs\u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"o\"\u003e[\u003c/span\u003eService]\n\u003cspan class=\"nv\"\u003eExecStart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e/usr/bin/lxcfs /var/lib/lxcfs/\n\u003cspan class=\"nv\"\u003eKillMode\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eprocess\n\u003cspan class=\"nv\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003eon-failure\n\u003cspan class=\"nv\"\u003eExecStopPost\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e-/bin/fusermount \u003cspan class=\"nt\"\u003e-u\u003c/span\u003e /var/lib/lxcfs \u003cspan class=\"c\"\u003e# \u0026lt;-- fuse 挂载路径\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eRestart\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003ealways\n\u003cspan class=\"nv\"\u003eRestartSec\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e3\n\u003cspan class=\"nv\"\u003eDelegate\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"nb\"\u003eyes\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"543-提供的目录挂载范围\"\u003e5.4.3 提供的目录挂载范围\u003c/h3\u003e\n\n\u003cp\u003e默认 fuse 挂载路径 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e/var/lib/lxcfs/\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e$ tree /var/lib/lxcfs/ -L 2\n/var/lib/lxcfs/\n├── cgroup\n│   ├── blkio\n│   ├── cpu,cpuacct\n│   ├── cpuset\n│   ├── devices\n│   ├── freezer\n│   ├── hugetlb\n│   ├── memory\n│   ├── name=systemd\n│   ├── net_cls,net_prio\n│   ├── perf_event\n│   ├── pids\n│   └── rdma\n└── proc\n    ├── cpuinfo\n    ├── diskstats\n    ├── meminfo\n    ├── stat\n    ├── swaps\n    └── uptime\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"6-特殊容器运行时\"\u003e6 特殊容器运行时\u003c/h1\u003e\n\n\u003cp\u003e这里列几个生产环境在用但又比较特殊的容器运行时。\u003c/p\u003e\n\n\u003ch2 id=\"61-nvidia-container-runtime\"\u003e6.1 NVIDIA container runtime\u003c/h2\u003e\n\n\u003cp\u003e老的 \u003ca href=\"https://github.com/NVIDIA/nvidia-docker\"\u003envidia-docker\u003c/a\u003e 已经不再维护，官方建议用新方案\n\u003ca href=\"https://github.com/NVIDIA/nvidia-container-toolkit\"\u003egithub.com/NVIDIA/nvidia-container-toolkit\u003c/a\u003e：\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-container-and-runtime/nvidia-container-runtime.png\" width=\"80%\" height=\"80%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. A Kubernetes node with nvidia container runtime\u003c/p\u003e\n\n\u003cp\u003e注册了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003erunc\u003c/code\u003e 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePreStart\u003c/code\u003e hook，在这一步去修改容器的配置，例如挂载 GPU 相关设备。\n更多信息见官方 \u003ca href=\"https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/arch-overview.html\"\u003eArchitecture Overview\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/opencontainers/runtime-spec/blob/v1.1.0/config.md#prestart\"\u003eOCI  v1.1.0 PreStart Hook\u003c/a\u003e:\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eThe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprestart\u003c/code\u003e hooks MUST be called as part of the\n\u003ca href=\"https://github.com/opencontainers/runtime-spec/blob/v1.1.0/runtime.md#create\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecreate\u003c/code\u003e\u003c/a\u003e\noperation after the runtime environment has been created (according to the\nconfiguration in \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003econfig.json\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e) but before the \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003epivot_root\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e or any equivalent\noperation has been executed. 在 Linux 系统中，先后顺序：\u003c/p\u003e\n  \u003col\u003e\n    \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e创建 container namespaces\u003c/mark\u003e\u003c/strong\u003e\u003c/li\u003e\n    \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e执行 prestart hook\u003c/mark\u003e\u003c/strong\u003e：provide an opportunity to customize the container (e.g. the network namespace could be specified in this hook).\nThe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprestart\u003c/code\u003e hooks MUST be called before the \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecreateRuntime\u003c/code\u003e hooks.\u003c/li\u003e\n  \u003c/ol\u003e\n\n  \u003cp\u003eThe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprestart\u003c/code\u003e hooks’ path MUST resolve in the \u003ca href=\"https://github.com/opencontainers/runtime-spec/blob/v1.1.0/glossary.md#runtime-namespace\"\u003eruntime namespace\u003c/a\u003e.\nThe \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprestart\u003c/code\u003e hooks MUST be executed in the \u003ca href=\"https://github.com/opencontainers/runtime-spec/blob/v1.1.0/glossary.md#runtime-namespace\"\u003eruntime namespace\u003c/a\u003e.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eprestart\u003c/code\u003e hook 即将\u003cstrong\u003e\u003cmark\u003e废弃\u003c/mark\u003e\u003c/strong\u003e，OCI 官方建议用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecreateRuntime\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecreateContainer\u003c/code\u003e, \u003ccode class=\"language-plaintext highlighter-rouge\"\u003estartContainer\u003c/code\u003e hooks。\u003c/p\u003e\n\n\u003ch2 id=\"62-华为-ascend-docker-runtime\"\u003e6.2 华为 Ascend docker runtime\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/Ascend/ascend-docker-runtime\"\u003egithub.com/Ascend/ascend-docker-runtime\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e功能与 NVIDIA container runtime，供容器环境使用昇腾 GPU。\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /etc/docker/daemon.json\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"s2\"\u003e\u0026#34;runtimes\u0026#34;\u003c/span\u003e:     \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"s2\"\u003e\u0026#34;ascend\u0026#34;\u003c/span\u003e:       \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"s2\"\u003e\u0026#34;path\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/usr/local/Ascend/Ascend-Docker-Runtime/ascend-docker-runtime\u0026#34;\u003c/span\u003e,\n            \u003cspan class=\"s2\"\u003e\u0026#34;runtimeArgs\u0026#34;\u003c/span\u003e:  \u003cspan class=\"o\"\u003e[]\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;default-shm-size\u0026#34;\u003c/span\u003e:     \u003cspan class=\"s2\"\u003e\u0026#34;8G\u0026#34;\u003c/span\u003e,\n    \u003cspan class=\"s2\"\u003e\u0026#34;default-runtime\u0026#34;\u003c/span\u003e:      \u003cspan class=\"s2\"\u003e\u0026#34;ascend\u0026#34;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/linux-container-and-runtime/huawei-ascend-runtime.png\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. Huawei Ascend GPU: Container Engine Plugin. [5]\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eprestart\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e hook 做的事情 [5]:\u003c/p\u003e\n\n  \u003col\u003e\n    \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eMount NPU device\u003c/mark\u003e\u003c/strong\u003e to the namespace of the container based on ASCEND_VISBLE_DEVICES.\u003c/li\u003e\n    \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eConfigure device cgroup\u003c/mark\u003e\u003c/strong\u003e of the container on the host to ensure that the container can use only the specified NPU to ensure device isolation.\u003c/li\u003e\n    \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eMount CANN Runtime Library\u003c/mark\u003e\u003c/strong\u003e on the host to the container namespace.\u003c/li\u003e\n  \u003c/ol\u003e\n\u003c/blockquote\u003e\n\n\u003ch1 id=\"7-结束语\"\u003e7 结束语\u003c/h1\u003e\n\n\u003cp\u003e同样是百行代码（创建一个基本容器的代码还可以大幅缩减），\u003ca href=\"/blog/kvm-host-in-a-few-lines-of-code-zh/\"\u003e创建一个 VM\u003c/a\u003e\n的过程就跟创建一个容器就非常不同。\u003c/p\u003e\n\n\u003cp\u003eVM 的事情基本是内核一次性做的，更像一个黑盒，因此虚拟机时代基础设施开发者能做的事情更上层一些，\n更多地是基于 KVM API 来做一些更上层的资源和状态管理工作，而深入到 KVM 内部的机会和需求都比较少，粒度更粗。\u003c/p\u003e\n\n\u003cp\u003e到了容器时代，上面已经看到，它不再是内核封装好的一个“黑盒”，而像是拼积木一样，\n基于几种内核机制拼出来的一个东西。它在某些方面跟虚拟机很像，但通过本文应该看到，\n二者又有本质的差别，尤其是在隔离和安全性方面。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e实际上，关于容器的好处和场景业界都已经达成高度一致，大规模的生产部署也验证了这个方向的正确性，\n但关于什么是容器现在似乎仍然没有一个普遍接受的定义 —— 也说明并不是那么重要。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e希望本文能给基础设施研发/运维带来一些帮助和启发。\u003c/p\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"https://blog.lizzie.io/linux-containers-in-500-loc.html\"\u003eLinux containers in 500 lines of code\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/cgroupv2-zh/\"\u003e(译) Control Group v2 (cgroupv2)（KernelDoc, 2021）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/the-mysterious-container-somaxconn/\"\u003eThe Mysterious Container \u003ccode\u003enet.core.somaxconn\u003c/code\u003e (2022)\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://unix.stackexchange.com/questions/4884/what-is-the-difference-between-procfs-and-sysfs\"\u003eWhat is the difference between procfs and sysfs\u003c/a\u003e, unix.stackexchange.com\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://support.huawei.com/enterprise/en/doc/EDOC1100192462/6ec6647f/container-engine-plugin\"\u003eHuawei Ascend GPU: Container Engine Plugin\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/kubevirt-create-vm/\"\u003e\u003cspan\u003e« Spawn a Virtual Machine in Kubernetes with kubevirt: A Deep Dive (2023)\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/gpu-advanced-notes-3-zh/\"\u003e\u003cspan\u003eGPU 进阶笔记（三）：华为 NPU/GPU 演进（2024） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2023-12-27T00:00:00Z",
  "Author": "Arthur Chiao"
}