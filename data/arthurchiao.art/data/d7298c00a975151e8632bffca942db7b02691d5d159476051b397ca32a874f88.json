{
  "Source": "arthurchiao.art",
  "Title": "JuiceFS 元数据引擎再探：开箱解读 TiKV 中的 JuiceFS 元数据（2024）",
  "Link": "https://arthurchiao.art/blog/juicefs-metadata-deep-dive-2-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003eJuiceFS 元数据引擎再探：开箱解读 TiKV 中的 JuiceFS 元数据（2024）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2024-09-12 | Last Update 2024-09-12\u003c/p\u003e\n  \n  \u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-volume-bw-control.png\" width=\"90%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS upload/download data bandwidth control.\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-1-zh/\"\u003eJuiceFS 元数据引擎初探：高层架构、引擎选型、读写工作流（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-2-zh/\"\u003eJuiceFS 元数据引擎再探：开箱解读 TiKV 中的 JuiceFS 元数据（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-3-zh/\"\u003eJuiceFS 元数据引擎三探：从实践中学习 TiKV 的 MVCC 和 GC（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-4-zh/\"\u003eJuiceFS 元数据引擎四探：元数据大小评估、限流与限速的设计思考（2024）\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"/blog/juicefs-metadata-deep-dive-5-zh/\"\u003eJuiceFS 元数据引擎五探：元数据备份与恢复（2024）\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e水平及维护精力所限，文中不免存在错误或过时之处，请酌情参考。\n\u003cstrong\u003e\u003cmark\u003e传播知识，尊重劳动，年满十八周岁，转载请注明\u003ca href=\"https://arthurchiao.art\"\u003e出处\u003c/a\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#1-创建一个-volume\" id=\"markdown-toc-1-创建一个-volume\"\u003e1 创建一个 volume\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-juicefs-client-日志\" id=\"markdown-toc-11-juicefs-client-日志\"\u003e1.1 JuiceFS client 日志\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-juicefs-client-中的-tikvpd-client-初始化调用栈\" id=\"markdown-toc-12-juicefs-client-中的-tikvpd-client-初始化调用栈\"\u003e1.2 JuiceFS client 中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTiKV/PD client\u003c/code\u003e 初始化/调用栈\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-tikv-ctl-查看空-volume-的系统元数据\" id=\"markdown-toc-13-tikv-ctl-查看空-volume-的系统元数据\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl\u003c/code\u003e 查看空 volume 的系统元数据\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-例子tikv-ctl-mvcc-解码-volume-setting-元数据\" id=\"markdown-toc-14-例子tikv-ctl-mvcc-解码-volume-setting-元数据\"\u003e1.4 例子：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl mvcc\u003c/code\u003e 解码 volume setting 元数据\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#141-对应-juicefs-format-结构体\" id=\"markdown-toc-141-对应-juicefs-format-结构体\"\u003e1.4.1 对应 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 结构体\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-将-volume-挂载mount到机器\" id=\"markdown-toc-2-将-volume-挂载mount到机器\"\u003e2 将 volume 挂载（mount）到机器\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-juicefs-client-挂载日志\" id=\"markdown-toc-21-juicefs-client-挂载日志\"\u003e2.1 JuiceFS client 挂载日志\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-查看挂载信息\" id=\"markdown-toc-22-查看挂载信息\"\u003e2.2 查看挂载信息\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-查看-juicefs-隐藏系统文件\" id=\"markdown-toc-23-查看-juicefs-隐藏系统文件\"\u003e2.3 查看 JuiceFS 隐藏（系统）文件\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#231-accesslog\" id=\"markdown-toc-231-accesslog\"\u003e2.3.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#232-config\" id=\"markdown-toc-232-config\"\u003e2.3.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.config\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#233-stats\" id=\"markdown-toc-233-stats\"\u003e2.3.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.stats\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#234-trash\" id=\"markdown-toc-234-trash\"\u003e2.3.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.trash\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-创建更新删除文件\" id=\"markdown-toc-3-创建更新删除文件\"\u003e3 创建、更新、删除文件\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-创建文件\" id=\"markdown-toc-31-创建文件\"\u003e3.1 创建文件\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#311-创建文件\" id=\"markdown-toc-311-创建文件\"\u003e3.1.1 创建文件\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#312-juicefs-accesslog\" id=\"markdown-toc-312-juicefs-accesslog\"\u003e3.1.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#313-tikv-元数据\" id=\"markdown-toc-313-tikv-元数据\"\u003e3.1.3 TiKV 元数据\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-删除文件操作\" id=\"markdown-toc-32-删除文件操作\"\u003e3.2 删除文件操作\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#321-删除文件\" id=\"markdown-toc-321-删除文件\"\u003e3.2.1 删除文件\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#322-juicefs-accesslog\" id=\"markdown-toc-322-juicefs-accesslog\"\u003e3.2.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#323-tikv-元数据\" id=\"markdown-toc-323-tikv-元数据\"\u003e3.2.3 TiKV 元数据\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#33-更新追加文件\" id=\"markdown-toc-33-更新追加文件\"\u003e3.3 更新（追加）文件\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#331-更新文件\" id=\"markdown-toc-331-更新文件\"\u003e3.3.1 更新文件\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#332-juicefs-accesslog\" id=\"markdown-toc-332-juicefs-accesslog\"\u003e3.3.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#333-tikv-元数据\" id=\"markdown-toc-333-tikv-元数据\"\u003e3.3.3 TiKV 元数据\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-元数据操作和-tikv-keyvalue-编码规则\" id=\"markdown-toc-4-元数据操作和-tikv-keyvalue-编码规则\"\u003e4 元数据操作和 TiKV key/value 编码规则\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-juicefs-key-编码规则\" id=\"markdown-toc-41-juicefs-key-编码规则\"\u003e4.1 JuiceFS key 编码规则\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#411-每个-key-的公共前缀vol_name--0xfd\" id=\"markdown-toc-411-每个-key-的公共前缀vol_name--0xfd\"\u003e4.1.1 每个 key 的公共前缀：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\u0026lt;vol_name\u0026gt; + 0xFD\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#412-每个-key-后面的部分\" id=\"markdown-toc-412-每个-key-后面的部分\"\u003e4.1.2 每个 key 后面的部分\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#413-最终格式字节序列\" id=\"markdown-toc-413-最终格式字节序列\"\u003e4.1.3 最终格式：字节序列\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-tikv-对-juicefs-key-的进一步编码\" id=\"markdown-toc-42-tikv-对-juicefs-key-的进一步编码\"\u003e4.2 TiKV 对 JuiceFS key 的进一步编码\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-例子查看特殊元数据volume-的-settingformat-信息\" id=\"markdown-toc-43-例子查看特殊元数据volume-的-settingformat-信息\"\u003e4.3 例子：查看特殊元数据：volume 的 setting/format 信息\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-总结\" id=\"markdown-toc-5-总结\"\u003e5 总结\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e有了第一篇的铺垫，本文直接进入正题。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e首先创建一个 volume，然后在其中做一些文件操作，然后通过 tikv-ctl 等工具在 TiKV 中查看对应的元数据。\u003c/li\u003e\n  \u003cli\u003e有了这些基础，我们再讨论 JuiceFS metadata key 和 TiKV 的编码格式。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e之前有一篇类似的，开箱解读 etcd 中的 Cilium 元数据：\n\u003ca href=\"/blog/whats-inside-cilium-etcd/\"\u003eWhat’s inside Cilium Etcd (kvstore)\u003c/a\u003e。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch1 id=\"1-创建一个-volume\"\u003e1 创建一个 volume\u003c/h1\u003e\n\n\u003cp\u003e创建一个名为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efoo-dev\u003c/code\u003e 的 JuiceFS volume。\u003c/p\u003e\n\n\u003ch2 id=\"11-juicefs-client-日志\"\u003e1.1 JuiceFS client 日志\u003c/h2\u003e\n\n\u003cp\u003e用 juicefs client 的 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ejuicefs format\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 命令创建 volume，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ejuicefs format \u003cspan class=\"nt\"\u003e--storage\u003c/span\u003e oss \u003cspan class=\"nt\"\u003e--bucket\u003c/span\u003e \u0026lt;bucket\u0026gt; \u003cspan class=\"nt\"\u003e--access-key\u003c/span\u003e \u0026lt;key\u0026gt; \u003cspan class=\"nt\"\u003e--secret-key\u003c/span\u003e \u0026lt;secret key\u0026gt; \u003cspan class=\"se\"\u003e\\\u003c/span\u003e\n  tikv://192.168.1.1:2379,192.168.1.2:2379,192.168.1.3:2379/foo-dev foo-dev\n\n\u0026lt;INFO\u0026gt;: Meta address: tikv://192.168.1.1:2379,192.168.1.2:2379,192.168.1.3:2379/foo-dev\n\u0026lt;INFO\u0026gt;: Data use oss://xxx/foo-dev/\n\u0026lt;INFO\u0026gt;: Volume is formatted as \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;foo-dev\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UUID\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;ec843b\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Storage\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;oss\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;BlockSize\u0026#34;\u003c/span\u003e: 4096,\n  \u003cspan class=\"s2\"\u003e\u0026#34;MetaVersion\u0026#34;\u003c/span\u003e: 1,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UploadLimit\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;DownloadLimit\u0026#34;\u003c/span\u003e: 0,\n  ...\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cul\u003e\n  \u003cli\u003e对象存储用的是阿里云 OSS；\u003c/li\u003e\n  \u003cli\u003eTiKV 地址指向的是 \u003cstrong\u003e\u003cmark\u003ePD 集群地址\u003c/mark\u003e\u003c/strong\u003e，上一篇已经介绍过，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e2379\u003c/code\u003e 是 PD 接收客户端请求的端口；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"12-juicefs-client-中的-tikvpd-client-初始化调用栈\"\u003e1.2 JuiceFS client 中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eTiKV/PD client\u003c/code\u003e 初始化/调用栈\u003c/h2\u003e\n\n\u003cp\u003e下面我们进入 JuiceFS 代码，看看 JuiceFS client 初始化和\u003cstrong\u003e\u003cmark\u003e连接到元数据引擎\u003c/mark\u003e\u003c/strong\u003e的调用栈：\u003c/p\u003e\n\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003emount\n |-metaCli = meta.NewClient\n |-txnkv.NewClient(url)                                          // github.com/juicedata/juicefs: pkg/meta/tkv_tikv.go\n |  |-NewClient                                                  // github.com/tikv/client-go:    txnkv/client.go\n |     |-pd.NewClient                                            // github.com/tikv/client-go:    tikv/kv.go\n |          |-NewClient                                          // github.com/tikv/pd:           client/client.go\n |             |-NewClientWithContext                            // github.com/tikv/pd:           client/client.go\n |                |-createClientWithKeyspace                     // github.com/tikv/pd:           client/client.go\n |                   |-c.pdSvcDiscovery = newPDServiceDiscovery  // github.com/tikv/pd:           client/pd_xx.go\n |                   |-c.setup()                                 // github.com/tikv/pd:           client/pd_xx.go\n |                       |-c.pdSvcDiscovery.Init()\n |                       |-c.pdSvcDiscovery.AddServingURLSwitchedCallback\n |                       |-c.createTokenDispatcher()\n |-metaCli.NewSession\n    |-doNewSession\n       |-m.setValue(m.sessionKey(m.sid), m.expireTime())  // SE\n       |-m.setValue(m.sessionInfoKey(m.sid), sinfo)       // SI\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这里面连接到 TiKV/PD 的代码有点绕，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e传给 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ejuicefs\u003c/code\u003e client 的是 \u003cstrong\u003e\u003cmark\u003ePD 集群地址\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e但代码使用的是 \u003cstrong\u003e\u003cmark\u003etikv 的 client-go 包\u003c/mark\u003e\u003c/strong\u003e，创建的是一个 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003etikv transaction client\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003e这个 tikv transaction client 里面会去创建 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003epd client\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 连接到 PD 集群，\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e所以，\u003cstrong\u003e\u003cmark\u003e架构上看 juicefs 是直连 PD\u003c/mark\u003e\u003c/strong\u003e，但实现上\u003cstrong\u003e\u003cmark\u003e并没有直接创建 pd client\u003c/mark\u003e\u003c/strong\u003e，\n也没有直接使用 pd 的库。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/juicefs-metadata-deep-dive/juicefs-tikv-cluster.png\" width=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003eFig. JuiceFS cluster initialization, and how POSIX file operations are handled by JuiceFS.\u003c/p\u003e\n\n\u003ch2 id=\"13-tikv-ctl-查看空-volume-的系统元数据\"\u003e1.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl\u003c/code\u003e 查看空 volume 的系统元数据\u003c/h2\u003e\n\n\u003cp\u003e现在再把目光转到 TiKV。看看这个空的 volume 在 TiKV 中对应哪些元数据：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh scan \u003cspan class=\"nt\"\u003e--from\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfoo\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--to\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfop\u0026#39;\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77A\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e01\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00I\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e71  \u003cspan class=\"c\"\u003e# attr?\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77ClastCle\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77anupSess\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77ions\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e73                    \u003cspan class=\"c\"\u003e# lastCleanupSessions\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77CnextChu\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77nk\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e71                          \u003cspan class=\"c\"\u003e# nextChunk\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77CnextIno\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77de\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e71                          \u003cspan class=\"c\"\u003e# nextInode\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77CnextSes\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77sion\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e73                                \u003cspan class=\"c\"\u003e# nextSession\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77SE\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e01\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e71  \u003cspan class=\"c\"\u003e# session\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77SI\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e01\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e71  \u003cspan class=\"c\"\u003e# sessionInfo\u003c/span\u003e\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77setting\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e76                                                     \u003cspan class=\"c\"\u003e# setting\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e以上就是我们新建的 volume \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efoo-dev\u003c/code\u003e 的所有 entry 了。\n也就是说一个 volume 创建出来之后，默认就有这些 \u003cstrong\u003e\u003cmark\u003eJuiceFS 系统元数据\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eTiKV 中的\u003cstrong\u003e\u003cmark\u003e每个 key 都经过了两层编码\u003c/mark\u003e\u003c/strong\u003e（JuiceFS 和 TiKV），我们后面再介绍编码规则。\n就目前来说，根据 \u003cstrong\u003e\u003cmark\u003ekey 中的字符\u003c/mark\u003e\u003c/strong\u003e还是依稀能看出每个 \u003cstrong\u003e\u003cmark\u003ekey 是干啥用的\u003c/mark\u003e\u003c/strong\u003e，\n为方便起见直接注释在上面每行的最后了。比如，下面两个 session 相关的 entry 就是上面调用栈最后两个创建的：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esession\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esessionInfo\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"14-例子tikv-ctl-mvcc-解码-volume-setting-元数据\"\u003e1.4 例子：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl mvcc\u003c/code\u003e 解码 volume setting 元数据\u003c/h2\u003e\n\n\u003cp\u003eTiKV 中的每个 entry 都是 key/value。现在我们尝试解码最后一个 entry，key 是\n\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003ezfoo-dev\\375\\377setting\\000\\376\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e，\n我们\u003cstrong\u003e\u003cmark\u003e来看看它的 value —— 也就是它的内容 —— 是什么\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ value_hex\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e./tikv-ctl.sh mvcc \u003cspan class=\"nt\"\u003e-k\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfoo-dev\\375\\377setting\\000\\376\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--show-cf\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003edefault | \u003cspan class=\"nb\"\u003eawk\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;/default cf value:/ {print $NF}\u0026#39;\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ value_escaped\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"si\"\u003e$(\u003c/span\u003e./tikv-ctl.sh \u003cspan class=\"nt\"\u003e--to-escaped\u003c/span\u003e \u003cspan class=\"nv\"\u003e$value_hex\u003c/span\u003e\u003cspan class=\"si\"\u003e)\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"nt\"\u003e-e\u003c/span\u003e \u003cspan class=\"nv\"\u003e$value_escaped\u003c/span\u003e | \u003cspan class=\"nb\"\u003esed\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;s/\\\\\u0026#34;/\u0026#34;/g\u0026#39;\u003c/span\u003e | jq \u003cspan class=\"nb\"\u003e.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e输出：\u003c/p\u003e\n\n\u003cdiv class=\"language-json highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;foo-dev\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;UUID\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;1ce2973b\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Storage\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;S3\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;Bucket\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;http://xx/bucket\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;AccessKey\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;SecretKey\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;xx\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;BlockSize\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;MetaVersion\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;UploadLimit\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"nl\"\u003e\u0026#34;DownloadLimit\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e:\u003c/span\u003e\u003cspan class=\"w\"\u003e \u003c/span\u003e\u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e\u003cspan class=\"w\"\u003e\n  \u003c/span\u003e\u003cspan class=\"err\"\u003e...\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003cspan class=\"p\"\u003e}\u003c/span\u003e\u003cspan class=\"w\"\u003e\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到是个 JSON 结构体。这其实就是这个 volume 的配置信息。如果对 JuiceFS 代码有一定了解，\n就会看出来它对应的其实就是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etype Format\u003c/code\u003e 这个 struct。\u003c/p\u003e\n\n\u003ch3 id=\"141-对应-juicefs-format-结构体\"\u003e1.4.1 对应 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 结构体\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// https://github.com/juicedata/juicefs/blob/v1.2.0/pkg/meta/config.go#L72\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003etype\u003c/span\u003e \u003cspan class=\"n\"\u003eFormat\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eName\u003c/span\u003e             \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eUUID\u003c/span\u003e             \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStorage\u003c/span\u003e          \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eStorageClass\u003c/span\u003e     \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBucket\u003c/span\u003e           \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eAccessKey\u003c/span\u003e        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSecretKey\u003c/span\u003e        \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eSessionToken\u003c/span\u003e     \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eBlockSize\u003c/span\u003e        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCompression\u003c/span\u003e      \u003cspan class=\"kt\"\u003estring\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eShards\u003c/span\u003e           \u003cspan class=\"kt\"\u003eint\u003c/span\u003e    \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eHashPrefix\u003c/span\u003e       \u003cspan class=\"kt\"\u003ebool\u003c/span\u003e   \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eCapacity\u003c/span\u003e         \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eInodes\u003c/span\u003e           \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eUploadLimit\u003c/span\u003e      \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e  \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e \u003cspan class=\"c\"\u003e// Mbps\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eDownloadLimit\u003c/span\u003e    \u003cspan class=\"kt\"\u003eint64\u003c/span\u003e  \u003cspan class=\"s\"\u003e`json:\u0026#34;,omitempty\u0026#34;`\u003c/span\u003e \u003cspan class=\"c\"\u003e// Mbps\u003c/span\u003e\n    \u003cspan class=\"o\"\u003e...\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch1 id=\"2-将-volume-挂载mount到机器\"\u003e2 将 volume 挂载（mount）到机器\u003c/h1\u003e\n\n\u003cp\u003e接下来我们找一台机器，把这个 volume 挂载上去，这样就能在这个 volume 里面读写文件了。\u003c/p\u003e\n\n\u003ch2 id=\"21-juicefs-client-挂载日志\"\u003e2.1 JuiceFS client 挂载日志\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ejuicefs mount \u003cspan class=\"nt\"\u003e--verbose\u003c/span\u003e \u003cspan class=\"nt\"\u003e--backup-meta\u003c/span\u003e 0 tikv://192.168.1.1:2379,192.168.1.2:2379,192.168.1.3:2379/foo-dev /tmp/foo-dev\n\u0026lt;INFO\u0026gt;:  Meta address: tikv://192.168.1.1:2379,192.168.1.2:2379,192.168.1.3:2379/foo-dev \u003cspan class=\"o\"\u003e[\u003c/span\u003einterface.go:406]\n\u0026lt;DEBUG\u0026gt;: Creating oss storage at endpoint http://\u0026lt;url\u0026gt; \u003cspan class=\"o\"\u003e[\u003c/span\u003eobject_storage.go:154]\n\u0026lt;INFO\u0026gt;:  Data use oss://xx/foo-dev/ \u003cspan class=\"o\"\u003e[\u003c/span\u003emount.go:497]\n\u0026lt;INFO\u0026gt;:  Disk cache \u003cspan class=\"o\"\u003e(\u003c/span\u003e/var/jfsCache/ec843b85/\u003cspan class=\"o\"\u003e)\u003c/span\u003e: capacity \u003cspan class=\"o\"\u003e(\u003c/span\u003e10240 MB\u003cspan class=\"o\"\u003e)\u003c/span\u003e, free ratio \u003cspan class=\"o\"\u003e(\u003c/span\u003e10%\u003cspan class=\"o\"\u003e)\u003c/span\u003e, max pending pages \u003cspan class=\"o\"\u003e(\u003c/span\u003e15\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003edisk_cache.go:94]\n\u0026lt;DEBUG\u0026gt;: Scan /var/jfsCache/ec843b85/raw to find cached blocks \u003cspan class=\"o\"\u003e[\u003c/span\u003edisk_cache.go:487]\n\u0026lt;DEBUG\u0026gt;: Scan /var/jfsCache/ec843b85/rawstaging to find staging blocks \u003cspan class=\"o\"\u003e[\u003c/span\u003edisk_cache.go:530]\n\u0026lt;DEBUG\u0026gt;: Found 8 cached blocks \u003cspan class=\"o\"\u003e(\u003c/span\u003e32814 bytes\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"k\"\u003ein\u003c/span\u003e /var/jfsCache/ec843b85/ with 269.265µs \u003cspan class=\"o\"\u003e[\u003c/span\u003edisk_cache.go:515]\n\u0026lt;INFO\u0026gt;:  Create session 4 OK with version: 1.2.0 \u003cspan class=\"o\"\u003e[\u003c/span\u003ebase.go:279]\n\u0026lt;INFO\u0026gt;:  Prometheus metrics listening on 127.0.0.1:34849 \u003cspan class=\"o\"\u003e[\u003c/span\u003emount.go:165]\n\u0026lt;INFO\u0026gt;:  Mounting volume foo-dev at /tmp/foo-dev ... \u003cspan class=\"o\"\u003e[\u003c/span\u003emount_unix.go:203]\n\u0026lt;INFO\u0026gt;:  OK, foo-dev is ready at /tmp/foo-dev \u003cspan class=\"o\"\u003e[\u003c/span\u003emount_unix.go:46]\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到成功挂载到了本机路径 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003e/tmp/foo-dev/\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"22-查看挂载信息\"\u003e2.2 查看挂载信息\u003c/h2\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003emount | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003ejuicefs\nJuiceFS:foo-dev on /tmp/foo-dev \u003cspan class=\"nb\"\u003etype \u003c/span\u003efuse.juicefs \u003cspan class=\"o\"\u003e(\u003c/span\u003erw,relatime,user_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,group_id\u003cspan class=\"o\"\u003e=\u003c/span\u003e0,default_permissions,allow_other\u003cspan class=\"o\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/foo-dev\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els\u003c/span\u003e \u003cspan class=\"c\"\u003e# 空目录\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"23-查看-juicefs-隐藏系统文件\"\u003e2.3 查看 JuiceFS 隐藏（系统）文件\u003c/h2\u003e\n\n\u003cp\u003e新建的 volume 里面其实有几个隐藏文件：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/foo-dev\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003ell\n\u003cspan class=\"nt\"\u003e-r--------\u003c/span\u003e 1 root root  .accesslog\n\u003cspan class=\"nt\"\u003e-r--------\u003c/span\u003e 1 root root  .config\n\u003cspan class=\"nt\"\u003e-r--r--r--\u003c/span\u003e 1 root root  .stats\ndr-xr-xr-x 2 root root  .trash/\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"231-accesslog\"\u003e2.3.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e可以通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecat\u003c/code\u003e 这个文件看到一些 JuiceFS client 底层的操作日志，我们一会会用到。\u003c/p\u003e\n\n\u003ch3 id=\"232-config\"\u003e2.3.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.config\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e包括 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 在内的一些 volume 配置信息：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e .config\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\n \u003cspan class=\"s2\"\u003e\u0026#34;Meta\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;Strict\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Retries\u0026#34;\u003c/span\u003e: 10,\n  \u003cspan class=\"s2\"\u003e\u0026#34;CaseInsensi\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;ReadOnly\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;NoBGJob\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;OpenCache\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Heartbeat\u0026#34;\u003c/span\u003e: 12000000000,\n  \u003cspan class=\"s2\"\u003e\u0026#34;MountPoint\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/tmp/foo-dev\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Subdir\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;CleanObjFileLever\u0026#34;\u003c/span\u003e: 1\n \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n \u003cspan class=\"s2\"\u003e\u0026#34;Format\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;Name\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;foo-dev\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UUID\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;ec843b85\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Storage\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;oss\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Bucket\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;http://\u0026lt;url\u0026gt;\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UploadLimit\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;DownloadLimit\u0026#34;\u003c/span\u003e: 0,\n  ...\n \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n \u003cspan class=\"s2\"\u003e\u0026#34;Chunk\u0026#34;\u003c/span\u003e: \u003cspan class=\"o\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"s2\"\u003e\u0026#34;CacheDir\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;/var/jfsCache/ec843b85\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;CacheMode\u0026#34;\u003c/span\u003e: 384,\n  \u003cspan class=\"s2\"\u003e\u0026#34;CacheSize\u0026#34;\u003c/span\u003e: 10240,\n  \u003cspan class=\"s2\"\u003e\u0026#34;FreeSpace\u0026#34;\u003c/span\u003e: 0.1,\n  \u003cspan class=\"s2\"\u003e\u0026#34;AutoCreate\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Compress\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;MaxUpload\u0026#34;\u003c/span\u003e: 20,\n  \u003cspan class=\"s2\"\u003e\u0026#34;MaxDeletes\u0026#34;\u003c/span\u003e: 2,\n  \u003cspan class=\"s2\"\u003e\u0026#34;MaxRetries\u0026#34;\u003c/span\u003e: 10,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UploadLimit\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;DownloadLimit\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Writeback\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UploadDelay\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;HashPrefix\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;BlockSize\u0026#34;\u003c/span\u003e: 4194304,\n  \u003cspan class=\"s2\"\u003e\u0026#34;GetTimeout\u0026#34;\u003c/span\u003e: 60000000000,\n  \u003cspan class=\"s2\"\u003e\u0026#34;PutTimeout\u0026#34;\u003c/span\u003e: 60000000000,\n  \u003cspan class=\"s2\"\u003e\u0026#34;CacheFullBlock\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;BufferSize\u0026#34;\u003c/span\u003e: 314572800,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Readahead\u0026#34;\u003c/span\u003e: 0,\n  \u003cspan class=\"s2\"\u003e\u0026#34;Prefetch\u0026#34;\u003c/span\u003e: 1,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UseMountUploadLimitConf\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e,\n  \u003cspan class=\"s2\"\u003e\u0026#34;UseMountDownloadLimitConf\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n \u003cspan class=\"o\"\u003e}\u003c/span\u003e,\n \u003cspan class=\"s2\"\u003e\u0026#34;Version\u0026#34;\u003c/span\u003e: \u003cspan class=\"s2\"\u003e\u0026#34;1.2.0\u0026#34;\u003c/span\u003e,\n \u003cspan class=\"s2\"\u003e\u0026#34;AttrTimeout\u0026#34;\u003c/span\u003e: 1000000000,\n \u003cspan class=\"s2\"\u003e\u0026#34;DirEntryTimeout\u0026#34;\u003c/span\u003e: 1000000000,\n \u003cspan class=\"s2\"\u003e\u0026#34;EntryTimeout\u0026#34;\u003c/span\u003e: 1000000000,\n \u003cspan class=\"s2\"\u003e\u0026#34;BackupMeta\u0026#34;\u003c/span\u003e: 0,\n \u003cspan class=\"s2\"\u003e\u0026#34;HideInternal\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003efalse\u003c/span\u003e\n\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"233-stats\"\u003e2.3.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.stats\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecat\u003c/code\u003e 能输出一些 prometheus metrics：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e .stats\n...\njuicefs_uptime 374.021754516\njuicefs_used_buffer_size_bytes 0\njuicefs_used_inodes 7\njuicefs_used_space 28672\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e用 prometheus 采集器把这个数据收上去，就能在 grafana 上展示 volume 的各种内部状态。\u003c/p\u003e\n\n\u003ch3 id=\"234-trash\"\u003e2.3.4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.trash\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e类似于 Windows 的垃圾箱。如果启用了，删掉的文件会在里面保存一段时间再真正从对象存储删掉。\u003c/p\u003e\n\n\u003ch1 id=\"3-创建更新删除文件\"\u003e3 创建、更新、删除文件\u003c/h1\u003e\n\n\u003cp\u003e接下来做一些文件操作，看看 TiKV 中对应元数据的变化。\u003c/p\u003e\n\n\u003ch2 id=\"31-创建文件\"\u003e3.1 创建文件\u003c/h2\u003e\n\n\u003ch3 id=\"311-创建文件\"\u003e3.1.1 创建文件\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd\u003c/span\u003e /tmp/foo-dev\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003eecho \u003c/span\u003etest3 \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e file3.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"312-juicefs-accesslog\"\u003e3.1.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e .accesslog\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585251,1725585251,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001561\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] lookup \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,file3.txt\u003cspan class=\"o\"\u003e)\u003c/span\u003e: no such file or directory \u0026lt;0.000989\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] create \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,file3.txt,-rw-r-----:0100640\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,[-rw-r-----:0100640,1,0,0,1725585318,1725585318,1725585318,0]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003efh:27] \u0026lt;0.003850\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] flush \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,27\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000005\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] write \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,6,0,27\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000048\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] flush \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,27\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.026205\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:0     \u003cspan class=\"o\"\u003e]\u003c/span\u003e release \u003cspan class=\"o\"\u003e(\u003c/span\u003e103\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000006\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169749] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585318,1725585318,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.000995\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169750] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585318,1725585318,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001219\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"313-tikv-元数据\"\u003e3.1.3 TiKV 元数据\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh scan \u003cspan class=\"nt\"\u003e--from\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfoo\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--to\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfop\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--limit\u003c/span\u003e 100\n...\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77A\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e01\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00Dfile3.\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77txt\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e72\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e可以看到 meta 中多了几条元数据，依稀可以分辨出对应的就是我们创建的文件，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e这个 key 经过了 juicefs 和 tikv 两次编码，\u003c/li\u003e\n  \u003cli\u003e简单来说，它是 volume + \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0xFD\u003c/code\u003e（8 进制的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\\375\u003c/code\u003e）+ 文件名 + tikv 编码，最终得到的就是上面看到的这个 key。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e对应的 value\u003c/mark\u003e\u003c/strong\u003e 一般长这样：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh mvcc \u003cspan class=\"nt\"\u003e-k\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfoo-dev\\375\\377A\\001\\000\\000\\000\\000\\000\\000\\377\\000Dfile3.\\377txt\\000\\000\\000\\000\\000\\372\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--show-cf\u003c/span\u003e default,lock,write\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77A\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e01\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00Dfile3.\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77txt\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e72\n         write cf value: start_ts: 452330816414416901 commit_ts: 452330816414416903 short_value: 010000000000000002\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e先粗略感受一下，后面再具体介绍 key/value 的编解码规则。\u003c/p\u003e\n\n\u003ch2 id=\"32-删除文件操作\"\u003e3.2 删除文件操作\u003c/h2\u003e\n\n\u003ch3 id=\"321-删除文件\"\u003e3.2.1 删除文件\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003erm \u003c/span\u003efile4.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"322-juicefs-accesslog\"\u003e3.2.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e .accesslog\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585532,1725585532,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001294\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169902] lookup \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,file4.txt\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e104,[-rw-r-----:0100640,1,0,0,1725585532,1725585532,1725585532,6]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001631\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169902] \u003cspan class=\"nb\"\u003eunlink\u003c/span\u003e \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,file4.txt\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.004206\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169904] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585623,1725585623,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.000718\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169905] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585623,1725585623,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.000843\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"323-tikv-元数据\"\u003e3.2.3 TiKV 元数据\u003c/h3\u003e\n\n\u003cp\u003e对应的元数据就从 TiKV 删掉了。\u003c/p\u003e\n\n\u003ch2 id=\"33-更新追加文件\"\u003e3.3 更新（追加）文件\u003c/h2\u003e\n\n\u003ch3 id=\"331-更新文件\"\u003e3.3.1 更新文件\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003eecho \u003c/span\u003etest3 \u003cspan class=\"o\"\u003e\u0026gt;\u0026gt;\u003c/span\u003e file3.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"332-juicefs-accesslog\"\u003e3.3.2 JuiceFS \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.accesslog\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e .accesslog\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] getattr \u003cspan class=\"o\"\u003e(\u003c/span\u003e1\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,[drwxrwxrwx:0040777,3,0,0,1725503250,1725585623,1725585623,4096]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001767\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] lookup \u003cspan class=\"o\"\u003e(\u003c/span\u003e1,file3.txt\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,[-rw-r-----:0100640,1,0,0,1725585318,1725585318,1725585318,6]\u003cspan class=\"o\"\u003e)\u003c/span\u003e \u0026lt;0.001893\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] open \u003cspan class=\"o\"\u003e(\u003c/span\u003e103\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u003cspan class=\"o\"\u003e[\u003c/span\u003efh:51] \u0026lt;0.000884\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] flush \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,51\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000011\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] write \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,6,6,51\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000068\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:169604] flush \u003cspan class=\"o\"\u003e(\u003c/span\u003e103,51\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.036778\u0026gt;\n\u003cspan class=\"o\"\u003e[\u003c/span\u003euid:0,gid:0,pid:0     \u003cspan class=\"o\"\u003e]\u003c/span\u003e release \u003cspan class=\"o\"\u003e(\u003c/span\u003e103\u003cspan class=\"o\"\u003e)\u003c/span\u003e: OK \u0026lt;0.000024\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"333-tikv-元数据\"\u003e3.3.3 TiKV 元数据\u003c/h3\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果追加的内容不多，TiKV 中还是那条元数据，但 value 会被更新；\u003c/li\u003e\n  \u003cli\u003e如果追加的内容太多（例如几百兆），\u003cstrong\u003e\u003cmark\u003e文件就会被切分\u003c/mark\u003e\u003c/strong\u003e，这时候元数据就会有\u003cstrong\u003e\u003cmark\u003e多条\u003c/mark\u003e\u003c/strong\u003e了。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch1 id=\"4-元数据操作和-tikv-keyvalue-编码规则\"\u003e4 元数据操作和 TiKV key/value 编码规则\u003c/h1\u003e\n\n\u003cp\u003e上一节简单看了下创建、更新、删除 volume 中的文件，TiKV 中对应的元数据都有什么变化。\n我们有意跳过了 key/value 是如何编码的，这一节就来看看这块的内容。\u003c/p\u003e\n\n\u003ch2 id=\"41-juicefs-key-编码规则\"\u003e4.1 JuiceFS key 编码规则\u003c/h2\u003e\n\n\u003ch3 id=\"411-每个-key-的公共前缀vol_name--0xfd\"\u003e4.1.1 每个 key 的公共前缀：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\u0026lt;vol_name\u0026gt; + 0xFD\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003eTiKV 客户端初始化：\u003cstrong\u003e\u003cmark\u003e每个 key 的 base 部分\u003c/mark\u003e\u003c/strong\u003e：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\u0026lt;vol_name\u0026gt; + 0xFD\u003c/code\u003e\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// pkg/meta/tkv_tikv.go\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003einit\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eRegister\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tikv\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003enewKVMeta\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edrivers\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;tikv\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e]\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003enewTikvClient\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"n\"\u003enewTikvClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eaddr\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etkvClient\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eerror\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclient\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003etxnkv\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewClient\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estrings\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSplit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etUrl\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eHost\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprefix\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003estrings\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eTrimLeft\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003etUrl\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePath\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003ewithPrefix\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003etikvClient\u003c/span\u003e\u003cspan class=\"p\"\u003e{\u003c/span\u003e\u003cspan class=\"n\"\u003eclient\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eKVStore\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einterval\u003c/span\u003e\u003cspan class=\"p\"\u003e},\u003c/span\u003e \u003cspan class=\"nb\"\u003eappend\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eprefix\u003c/span\u003e\u003cspan class=\"p\"\u003e),\u003c/span\u003e \u003cspan class=\"m\"\u003e0xFD\u003c/span\u003e\u003cspan class=\"p\"\u003e)),\u003c/span\u003e \u003cspan class=\"no\"\u003enil\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"412-每个-key-后面的部分\"\u003e4.1.2 每个 key 后面的部分\u003c/h3\u003e\n\n\u003cp\u003e根据对应的是文件、目录、文件属性、系统元数据等等，会有不同的编码规则：\u003c/p\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// pkg/meta/tkv.go\u003c/span\u003e\n\n\u003cspan class=\"c\"\u003e/**\n  Ino     iiiiiiii\n  Length  llllllll\n  Indx    nnnn\n  name    ...\n  sliceId cccccccc\n  session ssssssss\n  aclId   aaaa\n\nAll keys:\n  setting            format\n  C...               counter\n  AiiiiiiiiI         inode attribute\n  AiiiiiiiiD...      dentry\n  AiiiiiiiiPiiiiiiii parents // for hard links\n  AiiiiiiiiCnnnn     file chunks\n  AiiiiiiiiS         symlink target\n  AiiiiiiiiX...      extented attribute\n  Diiiiiiiillllllll  delete inodes\n  Fiiiiiiii          Flocks\n  Piiiiiiii          POSIX locks\n  Kccccccccnnnn      slice refs\n  Lttttttttcccccccc  delayed slices\n  SEssssssss         session expire time\n  SHssssssss         session heartbeat // for legacy client\n  SIssssssss         session info\n  SSssssssssiiiiiiii sustained inode\n  Uiiiiiiii          data length, space and inodes usage in directory\n  Niiiiiiii          detached inde\n  QDiiiiiiii         directory quota\n  Raaaa                 POSIX acl\n*/\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e具体可以再看看这个文件中的代码。\u003c/p\u003e\n\n\u003ch3 id=\"413-最终格式字节序列\"\u003e4.1.3 最终格式：字节序列\u003c/h3\u003e\n\n\u003cdiv class=\"language-go highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e// pkg/meta/tkv.go\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efunc\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ekvMeta\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003efmtKey\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e \u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"k\"\u003einterface\u003c/span\u003e\u003cspan class=\"p\"\u003e{})\u003c/span\u003e \u003cspan class=\"p\"\u003e[]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eb\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003eutils\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eNewBuffer\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ekeyLen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargs\u003c/span\u003e\u003cspan class=\"o\"\u003e...\u003c/span\u003e\u003cspan class=\"p\"\u003e)))\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"n\"\u003e_\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"k\"\u003erange\u003c/span\u003e \u003cspan class=\"n\"\u003eargs\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eswitch\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e \u003cspan class=\"o\"\u003e:=\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003etype\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePut8\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"kt\"\u003euint32\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePut32\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"kt\"\u003euint64\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePut64\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"n\"\u003eIno\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003em\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eencodeInode\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eGet\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"m\"\u003e8\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ecase\u003c/span\u003e \u003cspan class=\"kt\"\u003estring\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003ePut\u003c/span\u003e\u003cspan class=\"p\"\u003e([]\u003c/span\u003e\u003cspan class=\"kt\"\u003ebyte\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003edefault\u003c/span\u003e\u003cspan class=\"o\"\u003e:\u003c/span\u003e\n            \u003cspan class=\"nb\"\u003epanic\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efmt\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eSprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;invalid type %T, value %v\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ea\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eb\u003c/span\u003e\u003cspan class=\"o\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eBytes\u003c/span\u003e\u003cspan class=\"p\"\u003e()\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"42-tikv-对-juicefs-key-的进一步编码\"\u003e4.2 TiKV 对 JuiceFS key 的进一步编码\u003c/h2\u003e\n\n\u003cp\u003eJuiceFS client 按照以上规则拼好一个 key 之后，接下来 TiKV 会再进行一次编码：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e加一些 TiKV 的前缀，例如给文件 key 加个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ez\u003c/code\u003e 前缀；\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003eTiKV 代码 \u003ca href=\"https://github.com/tikv/tikv/blob/v5.0.0/components/keys/src/lib.rs#L29\"\u003ecomponents/keys/src/lib.rs\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e转义\u003c/mark\u003e\u003c/strong\u003e，例如 8 个字节插入一个 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e\\377\u003c/code\u003e（对应 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e0xFF\u003c/code\u003e），不够 8 字节的补全等等；\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003etikv \u003ca href=\"https://tikv.github.io/doc/src/tikv_util/lib.rs.html#161-200\"\u003erust encode 代码\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e借鉴的是 golang \u003ca href=\"https://github.com/golang/protobuf/blob/v1.5.4/proto/text_encode.go#L406\"\u003e\u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eprotobuf\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e 的代码\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e最终得到的就是我们用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003etikv-ctl scan\u003c/code\u003e 看到的那些 key。\u003c/p\u003e\n\n\u003ch2 id=\"43-例子查看特殊元数据volume-的-settingformat-信息\"\u003e4.3 例子：查看特殊元数据：volume 的 setting/format 信息\u003c/h2\u003e\n\n\u003cp\u003eJuiceFS 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 配置保存在 tikv 中，原始 key 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003esetting\u003c/code\u003e，经过以上两层编码就变成了下面的样子：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh scan \u003cspan class=\"nt\"\u003e--from\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfoo\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--to\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;zfop\u0026#39;\u003c/span\u003e \u003cspan class=\"nt\"\u003e--limit\u003c/span\u003e 100\nkey: zfoo-dev\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e75\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e77setting\u003cspan class=\"se\"\u003e\\0\u003c/span\u003e00\u003cspan class=\"se\"\u003e\\3\u003c/span\u003e76\n        default cf value: start_ts: 452330324173520898 value: 7B0A22...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e其中的 value 是可以解码出来的，\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"c\"\u003e# hex -\u0026gt; escaped string\u003c/span\u003e\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./tikv-ctl.sh \u003cspan class=\"nt\"\u003e--to-escaped\u003c/span\u003e \u003cspan class=\"s1\"\u003e\u0026#39;7B0A22...\u0026#39;\u003c/span\u003e\n\u003cspan class=\"o\"\u003e{\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eName\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003efoo-dev\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eUUID\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e8cd1ac73\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eStorage\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003eS3\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eBucket\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003ehttp://xxx\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eAccessKey\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e...\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eBlockSize\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: 4096,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eCompression\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003enone\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eKeyEncrypted\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eMetaVersion\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: 1,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eUploadLimit\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: 0,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\u003c/span\u003eDownloadLimit\u003cspan class=\"se\"\u003e\\\u0026#34;\u003c/span\u003e: 0,\u003cspan class=\"se\"\u003e\\n\\\u0026#34;\\\u0026#34;\u003c/span\u003e: \u003cspan class=\"se\"\u003e\\\u0026#34;\\\u0026#34;\\n\u003c/span\u003e\u003cspan class=\"o\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e对应的就是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003epkg/meta/config.go\u003c/code\u003e 中的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eFormat\u003c/code\u003e 结构体。\u003c/p\u003e\n\n\u003ch1 id=\"5-总结\"\u003e5 总结\u003c/h1\u003e\n\n\u003cp\u003e本文结合一些具体 JuiceFS 操作，分析了 TiKV 内的元数据格式与内容。\u003c/p\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ca href=\"/blog/whats-inside-cilium-etcd/\"\u003eWhat’s inside Cilium Etcd (kvstore)\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-white.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\n\u003ca href=\"https://notbyai.fyi\"\u003e\u003cimg src=\"/assets/img/Written-By-Human-Not-By-AI-Badge-black.svg\" alt=\"Written by Human, Not by AI\"/\u003e\u003c/a\u003e\u003c/p\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/juicefs-metadata-deep-dive-1-zh/\"\u003e\u003cspan\u003e« JuiceFS 元数据引擎初探：高层架构、引擎选型、读写工作流（2024）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/juicefs-metadata-deep-dive-3-zh/\"\u003e\u003cspan\u003eJuiceFS 元数据引擎三探：从实践中学习 TiKV 的 MVCC 和 GC（2024） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2024-09-12T00:00:00Z",
  "Author": "Arthur Chiao"
}