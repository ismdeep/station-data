{
  "Source": "arthurchiao.art",
  "Title": "[译] 数据中心网络：Spine-Leaf 架构设计综述（2016）",
  "Link": "https://arthurchiao.art/blog/spine-leaf-design-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003e[译] 数据中心网络：Spine-Leaf 架构设计综述（2016）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2019-03-06 | Last Update 2023-02-20\u003c/p\u003e\n  \n  \u003ch2 id=\"译者序\"\u003e译者序\u003c/h2\u003e\n\n\u003cp\u003e本文内容翻译自 Cisco 的白皮书 \u003ca href=\"https://www.cisco.com/c/en/us/products/collateral/switches/nexus-7000-series-switches/white-paper-c11-737022.pdf\"\u003e\u003cstrong\u003e\u003cem\u003eCisco Data Center Spine-and-Leaf Architecture:\nDesign\nOverview\u003c/em\u003e\u003c/strong\u003e\u003c/a\u003e\n（2016），翻译非逐字逐句，请酌情参考。\u003c/p\u003e\n\n\u003cp\u003e搜索 spine-leaf 资料时看到这篇非常棒的文档，故通过翻译的方式做个笔\n记顺便加深理解（不知是否有没有中文版）。\u003cstrong\u003e本文翻译仅供个人学习交流，无任何商业目\n的，如有侵权将及时删除\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e另外，发现思科、华为、华三等厂商的官网上都有大量的优秀文档，其最终目的虽然是推介\n产品，但其中关于基础设施的内容大部分都是厂商无关的，可以作为很好的学习材料\n。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e以下是译文。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#译者序\" id=\"markdown-toc-译者序\"\u003e译者序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-数据中心演进\" id=\"markdown-toc-1-数据中心演进\"\u003e1 数据中心演进\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-spine-leaf-架构\" id=\"markdown-toc-2-spine-leaf-架构\"\u003e2 Spine-Leaf 架构\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-overlay-网络\" id=\"markdown-toc-3-overlay-网络\"\u003e3 Overlay 网络\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-cicso-fabricpath-spine-leaf-网络\" id=\"markdown-toc-4-cicso-fabricpath-spine-leaf-网络\"\u003e4 Cicso FabricPath Spine-Leaf 网络\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-封装格式和标准兼容\" id=\"markdown-toc-41-封装格式和标准兼容\"\u003e4.1 封装格式和标准兼容\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#411-underlay-网络\" id=\"markdown-toc-411-underlay-网络\"\u003e4.1.1 Underlay 网络\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#412-overlay-网络\" id=\"markdown-toc-412-overlay-网络\"\u003e4.1.2 Overlay 网络\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-广播和未知单播流量\" id=\"markdown-toc-42-广播和未知单播流量\"\u003e4.2 广播和未知单播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-主机检测和可达性\" id=\"markdown-toc-43-主机检测和可达性\"\u003e4.3 主机检测和可达性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-组播流量\" id=\"markdown-toc-44-组播流量\"\u003e4.4 组播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#45-l3-路由功能\" id=\"markdown-toc-45-l3-路由功能\"\u003e4.5 L3 路由功能\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#451-在-spine-层做内部和外部路由\" id=\"markdown-toc-451-在-spine-层做内部和外部路由\"\u003e4.5.1 在 Spine 层做内部和外部路由\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#452-在-border-leaf-做内部和外部路由\" id=\"markdown-toc-452-在-border-leaf-做内部和外部路由\"\u003e4.5.2 在 Border Leaf 做内部和外部路由\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#46-多租户\" id=\"markdown-toc-46-多租户\"\u003e4.6 多租户\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#47-总结\" id=\"markdown-toc-47-总结\"\u003e4.7 总结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-cicso-vxlan-flood-and-learn-spine-leaf-网络\" id=\"markdown-toc-5-cicso-vxlan-flood-and-learn-spine-leaf-网络\"\u003e5 Cicso VXLAN Flood-and-Learn Spine-Leaf 网络\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#51-封装格式和标准兼容\" id=\"markdown-toc-51-封装格式和标准兼容\"\u003e5.1 封装格式和标准兼容\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#511-underlay-网络\" id=\"markdown-toc-511-underlay-网络\"\u003e5.1.1 Underlay 网络\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#512-overlay-网络\" id=\"markdown-toc-512-overlay-网络\"\u003e5.1.2 Overlay 网络\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#52-广播和未知单播流量\" id=\"markdown-toc-52-广播和未知单播流量\"\u003e5.2 广播和未知单播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#53-主机检测和可达性\" id=\"markdown-toc-53-主机检测和可达性\"\u003e5.3 主机检测和可达性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#54-组播流量\" id=\"markdown-toc-54-组播流量\"\u003e5.4 组播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#55-l3-路由功能\" id=\"markdown-toc-55-l3-路由功能\"\u003e5.5 L3 路由功能\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#551-在-spine-层做内部和外部路由\" id=\"markdown-toc-551-在-spine-层做内部和外部路由\"\u003e5.5.1 在 Spine 层做内部和外部路由\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#552-在-border-leaf-做内部和外部路由\" id=\"markdown-toc-552-在-border-leaf-做内部和外部路由\"\u003e5.5.2 在 Border Leaf 做内部和外部路由\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#56-多租户\" id=\"markdown-toc-56-多租户\"\u003e5.6 多租户\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#57-总结\" id=\"markdown-toc-57-总结\"\u003e5.7 总结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-cicso-vxlan-mp-bgp-evpn-spine-leaf-网络\" id=\"markdown-toc-6-cicso-vxlan-mp-bgp-evpn-spine-leaf-网络\"\u003e6 Cicso VXLAN MP-BGP EVPN Spine-Leaf 网络\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#61-封装格式和标准兼容\" id=\"markdown-toc-61-封装格式和标准兼容\"\u003e6.1 封装格式和标准兼容\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#611-underlay-网络\" id=\"markdown-toc-611-underlay-网络\"\u003e6.1.1 Underlay 网络\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#612-overlay-网络\" id=\"markdown-toc-612-overlay-网络\"\u003e6.1.2 Overlay 网络\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#62-广播和未知单播流量\" id=\"markdown-toc-62-广播和未知单播流量\"\u003e6.2 广播和未知单播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#63-主机检测和可达性\" id=\"markdown-toc-63-主机检测和可达性\"\u003e6.3 主机检测和可达性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#64-组播流量\" id=\"markdown-toc-64-组播流量\"\u003e6.4 组播流量\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#65-l3-路由功能\" id=\"markdown-toc-65-l3-路由功能\"\u003e6.5 L3 路由功能\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#651-分布式任播网关解决-vxlan-网络内部路由\" id=\"markdown-toc-651-分布式任播网关解决-vxlan-网络内部路由\"\u003e6.5.1 分布式任播网关：解决 VXLAN 网络内部路由\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#652-在-border-leaf-做外部路由\" id=\"markdown-toc-652-在-border-leaf-做外部路由\"\u003e6.5.2 在 Border Leaf 做外部路由\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#653-在-border-spine-做外部路由\" id=\"markdown-toc-653-在-border-spine-做外部路由\"\u003e6.5.3 在 Border Spine 做外部路由\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#66-多租户\" id=\"markdown-toc-66-多租户\"\u003e6.6 多租户\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#67-总结\" id=\"markdown-toc-67-总结\"\u003e6.7 总结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#7-cicso-msdc-layer-3-spine-leaf-网络\" id=\"markdown-toc-7-cicso-msdc-layer-3-spine-leaf-网络\"\u003e7 Cicso MSDC Layer 3 Spine-Leaf 网络\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#8-数据中心-fabric-管理和自动化\" id=\"markdown-toc-8-数据中心-fabric-管理和自动化\"\u003e8 数据中心 Fabric 管理和自动化\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#9-总结\" id=\"markdown-toc-9-总结\"\u003e9 总结\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#10-更多信息\" id=\"markdown-toc-10-更多信息\"\u003e10 更多信息\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003ch1 id=\"1-数据中心演进\"\u003e1 数据中心演进\u003c/h1\u003e\n\n\u003cp\u003e数据中心是现代软件技术的基石，在扩展企业能力的过程中扮演着关键角色。传统的数据中\n心使用三级架构（three-tier architecture），根据物理位置将服务器划分为不同 POD，\n如图 1 所示。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/1-3-tier-arch.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 1 传统三级（Three-Tier）数据中心设计\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e这种架构由\u003cstrong\u003e核心路由器\u003c/strong\u003e、\u003cstrong\u003e聚合路由器\u003c/strong\u003e（有时叫分发路由器，distribution routers）和\u003cstrong\u003e接入交换机\u003c/strong\u003e组成。\u003c/li\u003e\n  \u003cli\u003e在\u003cstrong\u003e\u003cmark\u003e接入交换机和聚合路由器之间运行生成树协议\u003c/mark\u003e\u003c/strong\u003e\n（Spanning Tree Protocol，STP），以保证网络的二层部分（L2）没有环路。\nSTP 有许多好处：简单，即插即用（plug-and-play），只需很少配置。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e每个 POD 内的机器都属于同一个 VLAN，因此服务器无需修改 IP 地址和网关就可以在 POD 内部任意迁移位置\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSTP 无法使用并行转发路径（parallel forwarding path），它永远会禁用 VLAN 内的冗余路径。\n2010 年，Cisco 提出了 virtual-port-channel (vPC) 技术来解决 STP 的限制。\nvPC 解放了被 STP 禁用的端口，提供接入交换机到汇聚路由器之间的 active-active 上行链路，\n充分利用可用的带宽，如图 2 所示。使用 vPC 技术时，STP 会作为备用机制（\nfail-safe mechanism）。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/2-using-vPC.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 2 使用 vPC 技术的数据中心设计\u003c/p\u003e\n\n\u003cp\u003e从 2003 年开始，随着虚拟化技术的引入，原来三级（three-tier）数据中心中，\n\u003cstrong\u003e\u003cmark\u003e在二层（L2）以 POD 形式做了隔离\u003c/mark\u003e\u003c/strong\u003e的计算、网络和存储资源，现在都可以被池化（pooled）。\n这种革命性的技术产生了\u003cstrong\u003e\u003cmark\u003e从接入层到核心层的大二层域\u003c/mark\u003e\u003c/strong\u003e（larger L2 domain）需求，如图 3 所示。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/3-extended-L3-domain.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 3 扩展的 L3 域的数据中心设计\u003c/p\u003e\n\n\u003cp\u003e随着 L2 segment（二层网络段，例如 VLAN 划分的二层网络，译者注）被扩展到所有 POD\n，数据中心的管理员可以创建一个集中式的、更加灵活的、能够按需分配的资源池。物理服\n务器被虚拟化为许多\u003cstrong\u003e\u003cmark\u003e虚拟服务器（VM），无需修改参数就可以在物理服务器之间自由迁移\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e虚拟机的引入，使得应用的部署方式越来越分布式，导致\u003cstrong\u003e\u003cmark\u003e东西向流量（east-west-traffic）越来越大\u003c/mark\u003e\u003c/strong\u003e。\n这些流量需要被高效地处理，并且还要保证低的、可预测的延迟。\n然而，vPC 只能提供两个并行上行链路，因此三级数据中心架构中的\u003cstrong\u003e\u003cmark\u003e带宽成为了瓶颈\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e三级架构的另一个问题是\u003cstrong\u003e\u003cmark\u003e服务器到服务器延迟\u003c/mark\u003e\u003c/strong\u003e（server-to-server latency）随着流量路径的不同而不同。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e针对以上问题，提出了一种新的数据中心设计，称作\u003cstrong\u003e\u003cmark\u003e基于 CLOS 网络的 Spine-Leaf 架构\u003c/mark\u003e\u003c/strong\u003e\n（Clos network-based Spine-Leaf architecture）。事实已经证明，这种架构可以提供\n\u003cstrong\u003e\u003cmark\u003e高带宽、低延迟、非阻塞\u003c/mark\u003e\u003c/strong\u003e的服务器到服务器连接。\u003c/p\u003e\n\n\u003ch1 id=\"2-spine-leaf-架构\"\u003e2 Spine-Leaf 架构\u003c/h1\u003e\n\n\u003cp\u003e图 4 是一个典型的两级 Spine-Leaf 拓扑。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/4-spine-leaf.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 4 典型的 Spine-Leaf 拓扑\u003c/p\u003e\n\n\u003cp\u003e在以上两级 Clos 架构中，\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e每个低层级的交换机（leaf）都会连接到每个高层级的交换机（spine），形成一个 full-mesh 拓扑\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003eleaf 层由接入交换机组成，用于连接服务器等设备。\u003c/li\u003e\n  \u003cli\u003espine 层是网络的骨干（backbone），负责将所有的 leaf 连接起来。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003efabric 中的每个 leaf 都会连接到每个 spine，如果一个 spine 挂了，数据中心的吞吐性能只会略微下降。\u003c/p\u003e\n\n\u003cp\u003e如果某个链路被打满了，扩容过程也很直接：添加一个 spine 交换机就可以扩展每个 leaf\n的上行链路，增大了 leaf 和 spine 之间的带宽，缓解了链路被打爆的问题。如果接入层\n的端口数量成为了瓶颈，那就直接添加一个新的 leaf，然后将其连接到每个 spine 并做相\n应的配置即可。这种易于扩展（ease of expansion）的特性优化了 IT 部门扩展网络的过\n程。\u003cstrong\u003e\u003cmark\u003eleaf 层的接入和上行链路都没有瓶颈时，这个架构就实现了无阻塞\u003c/mark\u003e\u003c/strong\u003e（nonblocking）。\u003c/p\u003e\n\n\u003cp\u003e在 Spine-Leaf 架构中，\u003cstrong\u003e\u003cmark\u003e任意一个服务器到另一个服务器\u003c/mark\u003e\u003c/strong\u003e的连接，\n\u003cstrong\u003e\u003cmark\u003e都会经过相同数量的设备\u003c/mark\u003e\u003c/strong\u003e（除非这两个服务器在同一 leaf 下面），\n这\u003cstrong\u003e\u003cmark\u003e保证了延迟是可预测的\u003c/mark\u003e\u003c/strong\u003e，因为一个包只需要经过一个 spine 和另一个 leaf 就可以到达目的端。\u003c/p\u003e\n\n\u003ch1 id=\"3-overlay-网络\"\u003e3 Overlay 网络\u003c/h1\u003e\n\n\u003cp\u003e现代虚拟化数据中心的网络要加速应用部署和支持 DevOps，必须满足特定的前提\n条件。例如，需要支持扩展转发表、扩展网段、L2 segment\nextension、虚拟设备漂移（mobility）、转发路径优化、共享物理基础设施上的网络虚拟\n化和多租户等等。\u003c/p\u003e\n\n\u003cp\u003e虽然 overlay 的概念并不是最近才提出的，但因为它可以解决以上提到的问题，因此近几\n年这个概念又火了起来。最近专门针对数据中心提出的新的帧封装格式（encapsulation\nframe format）更是为这个势头添了一把火。这些格式包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003eVXLAN\u003c/strong\u003e：Virtual Extensible LAN\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eNVGRE\u003c/strong\u003e: Network Virtualization Using Generic Routing Encapsulation\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eTRILL\u003c/strong\u003e: Transparent Interconnection of Lots of Links\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eLISP\u003c/strong\u003e:  Location/Identifier Separation Protocol\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eoverlay 网络是共享底层网络（underlay network）的节点之间互连形成的虚拟网络，这使\n得在不修改底层（underlay）网络的情况下，可以部署对网络拓扑有特定要求的应用，如图\n5 所示。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/5-overlay-net.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 5 网络 Overlay 概念\u003c/p\u003e\n\n\u003cp\u003eoverlay 虚拟化带来的好处包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e优化的设备功能\u003c/strong\u003e：overlay 网络使得可以根据设备在网络中的位置不同而对设备进行\n分类（和定制）。edge 或 leaf 设备可以根据终端状态信息和规模优化它的功能和相关\n的协议；core 或 spine 设备可以根据链路状态优化它的功能和协议，以及针对快速收敛\n进行优化。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003efabric 的扩展性和灵活性\u003c/strong\u003e：overlay 技术使得可以在 overlay 边界设备上进行网络\n的扩展。当在 fabric 边界使用 overlay 时，spine 或 core 设备就无\n需向自己的转发表中添加终端主机的信息（例如，如果在宿主机内进行 overlay 的封\n装和解封装，那 overlay 边界就是在宿主机内部，译者注）。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e可重叠的寻址\u003c/strong\u003e：数据中心中使用的大部分 overlay 技术都支持虚拟网络 ID，用来唯\n一地对每个私有网络进行范围限定和识别（scope and identify）。这种限定使得不同租\n户的 MAC 和 IP 地址可以重叠（overlapping）。overlay 的封装使得租户地址空间和\nunderlay 地址空间的管理分开。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e本文档将介绍 Cisco 过去几年和当前提供的、以及不远的将来应该会提供的几种\nSpine-Leaf 架构设计，这些设计都是为了解决现代虚拟化数据中心中 fabric 面临的\n需求：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eCisco® FabricPath spine-and-leaf network\u003c/li\u003e\n  \u003cli\u003eCisco VXLAN \u003cstrong\u003e\u003cmark\u003eflood-and-learn\u003c/mark\u003e\u003c/strong\u003e spine-and-leaf network\u003c/li\u003e\n  \u003cli\u003eCisco VXLAN Multiprotocol Border Gateway Protocol (\u003cstrong\u003e\u003cmark\u003eMP-BGP\u003c/mark\u003e\u003c/strong\u003e)\nEthernet Virtual Private Network (\u003cstrong\u003e\u003cmark\u003eEVPN\u003c/mark\u003e\u003c/strong\u003e) spine-and-leaf network\u003c/li\u003e\n  \u003cli\u003eCisco Massively Scalable Data Center (MSDC) Layer 3 spine-and-leaf network\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e下面的几章将围绕写作本文时的一些最重要技术组件、通用设计和设计考虑（例如 L3 网关）进行讨论。\u003c/p\u003e\n\n\u003cp\u003e最重要的技术组件包括：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e封装\u003c/li\u003e\n  \u003cli\u003eend-host 检测和分发（end-host detection and distribution）\u003c/li\u003e\n  \u003cli\u003e广播\u003c/li\u003e\n  \u003cli\u003e未知单播（unknown unicast）\u003c/li\u003e\n  \u003cli\u003e组播流量转发\u003c/li\u003e\n  \u003cli\u003eunderlay 和 overlay 控制平面\u003c/li\u003e\n  \u003cli\u003e多租户支持\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"4-cicso-fabricpath-spine-leaf-网络\"\u003e4 Cicso FabricPath Spine-Leaf 网络\u003c/h1\u003e\n\n\u003cp\u003eCisco 在 2010 年推出了 FabricPath 技术。FabricPath 提供的新特性和设计选项使得网\n络管理员可以创建\u003cstrong\u003e以太网 fabrics\u003c/strong\u003e，后者可以提高带宽可用性、提供设计灵活性，以及\n简化和降低网络和应用的部署及运维成本。典型的 FabricPath 都是使用 Spine-Leaf 架构。\u003c/p\u003e\n\n\u003cp\u003eFabricPath 继承了很多传统 L2 和 L3 技术中的优良特性，它保留了 L2 环境易于配置和\n即插即用的部署模型，并引入了一个称为 \u003cstrong\u003eFabricPath IS-IS\u003c/strong\u003e（Intermediate System\nto Intermediate System）的控制平面协议。在 FabricPath 网络中，给定任意一个\nFabricPath 交换机作为目的端，\u003cstrong\u003e最短路径优先\u003c/strong\u003e（shortest path first, SPF）路由协\n议将用于判断可达性以及寻找最优路径。\u003c/p\u003e\n\n\u003cp\u003e这种设计的好处：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e更稳定、更易扩展\u003c/li\u003e\n  \u003cli\u003e快速收敛\u003c/li\u003e\n  \u003cli\u003e像典型的 L3 路由环境一样\u003cstrong\u003e使用多个并行路径（multiple parallel paths）的能力\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"41-封装格式和标准兼容\"\u003e4.1 封装格式和标准兼容\u003c/h2\u003e\n\n\u003cp\u003eFabricPath spine-and-leaf 网络是 Cisco 的专利，但基于 TRILL 标准。它使用\nFabricPath \u003cstrong\u003eMAC-in-MAC\u003c/strong\u003e 帧封装。\u003c/p\u003e\n\n\u003ch3 id=\"411-underlay-网络\"\u003e4.1.1 Underlay 网络\u003c/h3\u003e\n\n\u003cp\u003e数据平面使用 L2 FabricPath MAC-in-MAC 封装，控制面在 underlay 网络中使用\nFabricPath IS-IS。每个 FabricPath 交换机都有一个 FabricPath switch ID。\u003cstrong\u003eFabric\nIS-IS 控制平面构建可达性信息\u003c/strong\u003e（reachability information），即 FabricPath 交换机\n如何连接到其它 FabricPath 交换机。\u003c/p\u003e\n\n\u003ch3 id=\"412-overlay-网络\"\u003e4.1.2 Overlay 网络\u003c/h3\u003e\n\n\u003cp\u003e\u003cstrong\u003eFabricPath 没有 overlay 控制平面。overlay 网络中的 end-host 信息是通过带会话学\n习功能的“泛洪-学习”机制学习的\u003c/strong\u003e（flood-and-learn mechanism with conversational\nlearning）。\u003c/p\u003e\n\n\u003ch2 id=\"42-广播和未知单播流量\"\u003e4.2 广播和未知单播流量\u003c/h2\u003e\n\n\u003ch2 id=\"43-主机检测和可达性\"\u003e4.3 主机检测和可达性\u003c/h2\u003e\n\n\u003ch2 id=\"44-组播流量\"\u003e4.4 组播流量\u003c/h2\u003e\n\n\u003ch2 id=\"45-l3-路由功能\"\u003e4.5 L3 路由功能\u003c/h2\u003e\n\n\u003ch3 id=\"451-在-spine-层做内部和外部路由\"\u003e4.5.1 在 Spine 层做内部和外部路由\u003c/h3\u003e\n\n\u003ch3 id=\"452-在-border-leaf-做内部和外部路由\"\u003e4.5.2 在 Border Leaf 做内部和外部路由\u003c/h3\u003e\n\n\u003ch2 id=\"46-多租户\"\u003e4.6 多租户\u003c/h2\u003e\n\n\u003ch2 id=\"47-总结\"\u003e4.7 总结\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/table-1-fabricpath.PNG\" width=\"95%\" height=\"95%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e表 1 Cisco FabricPath 网络特性\u003c/p\u003e\n\n\u003ch1 id=\"5-cicso-vxlan-flood-and-learn-spine-leaf-网络\"\u003e5 Cicso VXLAN Flood-and-Learn Spine-Leaf 网络\u003c/h1\u003e\n\n\u003cp\u003eVXLAN 是网络虚拟化 overlay 技术之一，有一些自己的优势。它是一个工业标准（\nindustry-standard）协议，使用 underlay IP 网络。它将 L2 网络进行扩展，在 L3\n基础设施之上构建出一个 L2 overlay 逻辑网络。它将以太帧封装到 UDP IP 包里面，通\n过 underlay 网络以正常的 IP 路由和转发机制发送到对端 VTEP（VXLAN tunnel endpoint\n）。\u003c/p\u003e\n\n\u003cp\u003eCisco 从 2014 年开始，陆续在多个 Nexus 系列（例如 Nexus 5600、7000、9000 系列）交\n换机上支持 VXLAN flood-and-learn spine-and-leaf 技术。本节介绍这些硬件交换机\n的 Cisco VXLAN flood-and-learn 特性。\u003c/p\u003e\n\n\u003ch2 id=\"51-封装格式和标准兼容\"\u003e5.1 封装格式和标准兼容\u003c/h2\u003e\n\n\u003cp\u003eCisco VXLAN flood-and-learn 技术兼容 IETF VXLAN 标准（RFC 7348），后者定义了\u003cstrong\u003e无控\n制平面的基于组播的泛洪-学习 VXLAN\u003c/strong\u003e（multicast-based flood-and-learn VXLAN without\na control plane）。原始的 L2 帧封装一个 VXLAN 头，然后放到 UDP IP 包通过 IP 网络\n进行传输。\u003c/p\u003e\n\n\u003ch3 id=\"511-underlay-网络\"\u003e5.1.1 Underlay 网络\u003c/h3\u003e\n\n\u003cp\u003e使用 L3 IP 网络作为 underlay 网络。\u003c/p\u003e\n\n\u003cp\u003e使用 underlay IP multicast 减少 VXLAN 网段的主机之间泛洪的范围。\u003c/p\u003e\n\n\u003cp\u003e每个 VXLAN segment 都有一个 VNI（VXLAN network ID），\u003cstrong\u003eVNI 会映射到传输网络中的一\n个 IP 多播组\u003c/strong\u003e。每个 VTEP 设备独立配置多播组，参与 PIM 路由。基于参与的 VTEP 的位\n置，会在传输网络中形成这个组对应的多播分发树（multicast distribution tree）。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e这种方案需要在 underlay 网络中开启多播功能，而一些企业可能\n并不想在他们的数据中心或 WAN 中开启组播\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003eCisco 9000 特色介绍：略（TODO）。\u003c/p\u003e\n\n\u003ch3 id=\"512-overlay-网络\"\u003e5.1.2 Overlay 网络\u003c/h3\u003e\n\n\u003cp\u003e这种设计\u003cstrong\u003e没有 overlay 网络的控制平面\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e它在 L3 IP underlay 网络之上构建了一层 L2 overlay 网络，通过 VTEP 隧道机制传输 L2\n包。\u003cstrong\u003eoverlay 网络使用 flood-and-learn 语义\u003c/strong\u003e，如图 11 所示。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/11-vxlan-overlay.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 11 VXLAN overlay 网络\u003c/p\u003e\n\n\u003ch2 id=\"52-广播和未知单播流量\"\u003e5.2 广播和未知单播流量\u003c/h2\u003e\n\n\u003cp\u003e使用 underlay IP PIM 或 ingress replication 发送广播和未知的单播（unknown\nunicast）流量。注意 ingress replication 只有 Cisco Nexus 9000 系列交换机才支持。\u003c/p\u003e\n\n\u003ch2 id=\"53-主机检测和可达性\"\u003e5.3 主机检测和可达性\u003c/h2\u003e\n\n\u003cp\u003e依赖初始的数据平面泛洪，每个 VXLAN segment 的 VTEP 能发现其他主机，学习远端主机\n的 MAC 和 MAC-to-VTEP 映射。MAC-to-VTEP 映射完成后，VTEP 接下来就通过单播转发\nVXLAN 流量。\u003c/p\u003e\n\n\u003ch2 id=\"54-组播流量\"\u003e5.4 组播流量\u003c/h2\u003e\n\n\u003cp\u003e通过 underlay IP PIM 或 ingress replication 可以支持 overlay 租户的 \u003cstrong\u003eL2 组播\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eL3 组播\u003c/strong\u003e流量通过 L3 基于 PIM 的组播路由（L3 PIM-based multicast routing）实现。\u003c/p\u003e\n\n\u003cp\u003e略。\u003c/p\u003e\n\n\u003ch2 id=\"55-l3-路由功能\"\u003e5.5 L3 路由功能\u003c/h2\u003e\n\n\u003cp\u003e在一个传统的 VLAN 环境中，很多情况下需要 VXLAN segment 和 VLAN segment 之间的路由。\n典型的 VXLAN flood-and-learn spine-and-leaf 网络设计中，leaf ToR (top-of-rack)\n交换机会作为 VTEP 设备，在机柜（rack）之间扩展 L2 segment。\u003c/p\u003e\n\n\u003cp\u003eVXLAN 和 VLAN 之间的 二层流量转发时，VTEP 作为 L2 VXLAN 网关；三级流量路\n由时，还需要开启某些 VTEP 的 L3 VXLAN 网关功能。常见的设计有：内部和外部路由在\nspine 层，或内部和外部路由在 leaf 层。这两种设计都是集中式路由（centralized\nrouting），即：三层的内部和外部路由功能都集中在特定的交换机上做。\u003c/p\u003e\n\n\u003ch3 id=\"551-在-spine-层做内部和外部路由\"\u003e5.5.1 在 Spine 层做内部和外部路由\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/12-routing-on-spine.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 12 在 spine 上做内部和外部路由\u003c/p\u003e\n\n\u003cp\u003e图 12 是在 spine 层做内部和外部路由的示意图，\u003cstrong\u003eleaf ToR VTEP 交换机作为 L2 VXLAN\n网关\u003c/strong\u003e，在 underlay 网络上传输 L2 segment。spine 有两功能：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e作为 underlay 网络的一部分，传输 VXLAN 封装的包\u003c/li\u003e\n  \u003cli\u003e做内部的 inter-VXLAN 路由，以及外部路由\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e内部和外部路由流量需要从 VTEP 经过 underlay 的一跳到达 spine，然后被 spine 路由。\u003c/p\u003e\n\n\u003cp\u003e注意，在使用 HSRP（Hot-Standby Router Protocol）和 vPC 的配置下，VXLAN 之间\nactive-active 网关的最大数量是两个。另外，\u003cstrong\u003espine L3 VXLAN 网关会学习主机 MAC\n地址\u003c/strong\u003e，所以需要考虑 MAC 地址的规模，以免超出硬件的限制。\u003c/p\u003e\n\n\u003ch3 id=\"552-在-border-leaf-做内部和外部路由\"\u003e5.5.2 在 Border Leaf 做内部和外部路由\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/13-routing-on-border-leaf.PNG\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 13 在 Border Leaf 上做内部和外部路由\u003c/p\u003e\n\n\u003cp\u003e在 Border Leaf 上做内部和外部路由如图 13。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003eleaf ToR VTEP 交换机作为 L2 VXLAN 网关\u003c/strong\u003e，在 underlay 网络上传输 L2 segment。\u003cstrong\u003espine\n是 underlay 网络的一部分，它并不学习 overlay 主机的 MAC 地址\u003c/strong\u003e。\u003cstrong\u003eborder leaf 路由器\n承担 L3 VXLAN 网关功能\u003c/strong\u003e，负责 inter-VXLAN 路由和外部路由。\u003c/p\u003e\n\n\u003cp\u003e内部和外部路由流量需要\u003cstrong\u003e从 VTEP 经过 underlay 的两跳\u003c/strong\u003e（先到 spine 再到 border\nleaf）到达 border leaf，然后才能被路由到外部网络。\u003c/p\u003e\n\n\u003cp\u003e同样，在使用 HSRP 和 vPC 的配置下，inter-VXLAN active-active 网关的最大数量是两\n个。另外，\u003cstrong\u003eborder leaf L3 VXLAN 网关会学习主机 MAC 地址\u003c/strong\u003e，所以需要考虑 MAC 地\n址的规模，以免超出硬件的限制。\u003c/p\u003e\n\n\u003ch2 id=\"56-多租户\"\u003e5.6 多租户\u003c/h2\u003e\n\n\u003ch2 id=\"57-总结\"\u003e5.7 总结\u003c/h2\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/table-2-vxlan.PNG\" width=\"95%\" height=\"95%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e表 2 Cisco VXLAN flood-and-learn 网络特性\u003c/p\u003e\n\n\u003ch1 id=\"6-cicso-vxlan-mp-bgp-evpn-spine-leaf-网络\"\u003e6 Cicso VXLAN MP-BGP EVPN Spine-Leaf 网络\u003c/h1\u003e\n\n\u003cp\u003eRFC 7348 定义的 VXLAN flood-and-learn 模型中，\u003cstrong\u003eend-host（终端主机）学习\u003c/strong\u003e和\n\u003cstrong\u003eVTEP 发现\u003c/strong\u003e都是基于数据平面，并没有控制平面来在 VTEP 之间分发 end-host 可达性\n信息。为了克服这种方案的一些限制，Cisco VXLAN MP-BGP EVPN Spine-Leaf 架构使用了\n\u003cstrong\u003e\u003cmark\u003eMP-BGP EVPN 作为 VXLAN 的控制平面\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e这种设计使得\u003cstrong\u003e控制平面和数据平面分离\u003c/strong\u003e，并且为 overlay 网络的 L2/L3 转发提供了统\n一的控制平面。本节介绍这种方案中 Cisco 硬件交换机（例如 Cisco Nexus 5600\n、7000、9000 系列）上的应用。\u003c/p\u003e\n\n\u003ch2 id=\"61-封装格式和标准兼容\"\u003e6.1 封装格式和标准兼容\u003c/h2\u003e\n\n\u003cp\u003e使用 VXLAN 封装，原始 L2 帧加一层 VXLAN 头然后封装到 UDP-IP 包进行传输。\u003c/p\u003e\n\n\u003cp\u003e与 IETF RFC 7348 和 draft-ietf-bess-evpn-overlay 标准是兼容的。\u003c/p\u003e\n\n\u003ch3 id=\"611-underlay-网络\"\u003e6.1.1 Underlay 网络\u003c/h3\u003e\n\n\u003cp\u003e使用 L3 IP 网络作为 underlay 网络。\u003c/p\u003e\n\n\u003ch3 id=\"612-overlay-网络\"\u003e6.1.2 Overlay 网络\u003c/h3\u003e\n\n\u003cp\u003e使用 MP-BGP EVPN 作为 VXLAN overlay 网络的控制平面协议。\u003c/p\u003e\n\n\u003ch2 id=\"62-广播和未知单播流量\"\u003e6.2 广播和未知单播流量\u003c/h2\u003e\n\n\u003cp\u003e使用 underlay IP PIM 或 ingress replication 特性发送\u003cstrong\u003e广播\u003c/strong\u003e和\u003cstrong\u003e未知单播\u003c/strong\u003e流量。\u003c/p\u003e\n\n\u003cp\u003eunderlay 开启 IP 组播的情况下，每个 VXLAN segment，或者 VNI，都会映射到 underlay\n的一个 IP 组播组（multicast group）。每个 VTEP 设备独立配置组播组，参与 PIM 路由\n。基于参与的 VTEP 的位置，会在传输网络中形成这个组对应的多播分发树（multicast\ndistribution tree）。\u003c/p\u003e\n\n\u003cp\u003e如果使用 ingress replication 特性，那 underlay 就无需组播了。VTEP 之间通过 VTEP\n的 IP 地址发送广播和未知单播流量。这些 IP 地址是通过 BGP EVPN 控制平面在 VTEP 之\n间交换的，或者通过静态配置。\u003c/p\u003e\n\n\u003ch2 id=\"63-主机检测和可达性\"\u003e6.3 主机检测和可达性\u003c/h2\u003e\n\n\u003cp\u003eMP-BGP EVPN 控制平面提供内置的路由和转发（功能），它会对 VXLAN overlay 网络内的\nend-host 的 L2/L3 可达性信息进行分发（distribution）。\u003c/p\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e每个 VTEP 从与它相连的主机中自动学习 MAC 地址\u003c/mark\u003e\u003c/strong\u003e（通过传统的 MAC 地址学习）\n\u003cstrong\u003e\u003cmark\u003e和 IP 地址信息\u003c/mark\u003e\u003c/strong\u003e（基于 ARP snooping），然后\u003cstrong\u003e\u003cmark\u003e通过控制平面进行分发\u003c/mark\u003e\u003c/strong\u003e，\n因此远端主机的信息是控制平面同步过来的。这种方式\u003cstrong\u003e\u003cmark\u003e避免了通过网络泛洪\u003c/mark\u003e\u003c/strong\u003e\n学习远端主机信息的问题，为 end-host 可达性信息的分发提供了更好的控制。\u003c/p\u003e\n\n\u003ch2 id=\"64-组播流量\"\u003e6.4 组播流量\u003c/h2\u003e\n\n\u003cp\u003e使用 underlay IP 组播或 ingress replication 特性，可以支持 overlay 租户的 L2 组\n播。\u003c/p\u003e\n\n\u003cp\u003e通过外部路由器上 L3 PIM-based multicast 路由，可以支持 overlay 租户的 L3 组播。\u003c/p\u003e\n\n\u003ch2 id=\"65-l3-路由功能\"\u003e6.5 L3 路由功能\u003c/h2\u003e\n\n\u003cp\u003eL3 路由需要解决两个问题：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eVXLAN 网络内部\u003c/mark\u003e\u003c/strong\u003e的路由：使用\u003cstrong\u003e\u003cmark\u003e分布式任播网关\u003c/mark\u003e\u003c/strong\u003e（distributed anycast gateways）解决\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003eVXLAN 网络和外部网络\u003c/strong\u003e（包括园区网、WAN 和互联网）的路由：在几个特定交换机上实现\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch3 id=\"651-分布式任播网关解决-vxlan-网络内部路由\"\u003e6.5.1 分布式任播网关：解决 VXLAN 网络内部路由\u003c/h3\u003e\n\n\u003cp\u003e在 MP-BGP EVPN 网络中，一个 VNI 内的任意一个 VTEP 都可以作为它所在子网的分布式\n任播网关，对它们配置相同的虚拟网关 IP 和虚拟网关 MAC 即可，如图 16 所示。\u003c/p\u003e\n\n\u003cp\u003eEVPN 的这种任播网关功能，使得 VNI 内的主机可以将本地 VTEP 作为其网关，将跨网段的\n流量发送到 VTEP 设备。这使得 VXLAN 网络中从主机出来的北向流量可以达到最优转发。\n分布式任播网关还给 overlay 网络带来了透明主机漂移（transparent host mobility）的\n好处。因为一个 VNI 的所有 VTEP 设备上的网关 IP 和 MAC 地址都是相同的，当一个主机\n从一个 VTEP 移动到另一个 VTEP 后，它无需发送 ARP 请求来重新学习网关的 MAC 地址。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/16-distributed-anycast-gw.PNG\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 16 内部路由的分布式任播网关\u003c/p\u003e\n\n\u003ch3 id=\"652-在-border-leaf-做外部路由\"\u003e6.5.2 在 Border Leaf 做外部路由\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/17-external-routing-at-border-leaf.PNG\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 17 Border Leaf 做外部路由的设计\u003c/p\u003e\n\n\u003cp\u003e图 17 是典型的通过一对 border leaf 交换机连接到外部路由设备的设计。Border leaf\n在 VXLAN 网络侧运行 MP-BGP EVPN，和网络内的 VTEP 交换 EVPN 路由。同时，它在租户\nVRF 实例中运行普通的 IPv4 或 IPv6 单播路由协议和外部路由设备交换路由信息。路由协\n议可以是常规 eBGP，或任何内部网关协议（IGP）。Border leaf 将学习来的外部路由\n以 EVPN 路由的形式通告到 EVPN 域，因此 VTEP 就能学习到外部路由，然后就可以发送出\nVXLAN 网络的流量。\u003c/p\u003e\n\n\u003cp\u003e也可以配置 border leaf 将学习到的 L2 VPN EVPN 地址族到 IPv4 或 IPv6 单播地址族的\n路由，通告到外部路由。在这种设计中，租户流量需要经过 underlay 的两跳（VTEP 到\nspine 到 border leaf）到达外部网络。然而，这种情况下 spine 只需要运行 BGP-EVPN 控\n制平面和 IP 路由，无需支持 VXLAN VTEP 功能（即，无需支持 VXLAN 的封装和解封装，\n译者注）。\u003c/p\u003e\n\n\u003ch3 id=\"653-在-border-spine-做外部路由\"\u003e6.5.3 在 Border Spine 做外部路由\u003c/h3\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/18-external-routing-with-border-spine.PNG\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 18 Border Spine 做外部路由的设计\u003c/p\u003e\n\n\u003cp\u003e图 18 是典型的通过一对 border spine 交换机连接到外部路由设备的设计。这种设计中，\nspine 需要支持 VXLAN 路由。spine 在 VXLAN 网络侧运行 MP-BGP EVPN，和 VTEP 交换\nEVPN 路由信息。同时，它在租户\nVRF 实例中运行普通的 IPv4 或 IPv6 单播路由协议和外部路由设备交换路由信息。路由协\n议可以是常规 eBGP，或任何内部网关协议（IGP）协议。spine 将学习来的外部路由\n以 EVPN 路由的形式通告到 EVPN 域，因此 VTEP 就能学习到外部路由，然后就可以发送出\nVXLAN 网络的流量。\u003c/p\u003e\n\n\u003cp\u003e也可以配置 spine 将学习到的 L2 VPN EVPN 地址族到 IPv4 或 IPv6 单播地址族的\n路由，通告到外部路由。在这种设计中，租户流量只需经过 underlay 的一跳（VTEP 到\nspine）就可以到达外部网络。然而，这种情况下 spine 需要运行 BGP-EVPN\n控制平面和 IP 路由，以及支持 VXLAN VTEP 功能。\u003c/p\u003e\n\n\u003ch2 id=\"66-多租户\"\u003e6.6 多租户\u003c/h2\u003e\n\n\u003cp\u003e作为 MP-BGP 的扩展，MP-BGP EVPN 继承了 VPN 通过 VRF 实现的对多租户的支持。\u003c/p\u003e\n\n\u003cp\u003e在 MP-BGP EVPN 中，多个租户可以共存，它们共享同一个 IP 传输网络（underlay），而\n在 VXLAN overlay 网络中拥有独立的 VPN，入图 19 所示。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/19-mp-bgp-evpn-multi-tenancy.PNG\" width=\"70%\" height=\"70%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e图 19 Cisco VXLAN MP-BGP EVPN Spine-Leaf 网络的多租户\u003c/p\u003e\n\n\u003cp\u003e在 VXLAN MP-BGP EVPN spine-and-leaf 网络中，\u003cstrong\u003eVNI 定义了二层域\u003c/strong\u003e，不允许 L2 流量跨越\nVNI 边界。类似地，\u003cstrong\u003eVXLAN 租户的三层 segment 是通过 VRF 技术隔离的\u003c/strong\u003e，通过将不同 VNI\n映射到不同的 VRF 实例来隔离租户的三层网络。每个租户都有自己的 VRF 路由实例。同一\n租户的 VNI 的不同子网，都属于同一个 L3 VRF 实例，这个 VRF 将租户的三层路由与其他\n租户的路由隔离开来。\u003c/p\u003e\n\n\u003ch2 id=\"67-总结\"\u003e6.7 总结\u003c/h2\u003e\n\n\u003cp\u003e控制平面学习到 end-host 的 L2 和 L3 可达性信息（MAC 和 IP），然后通过 EVPN 地址\n族分发这些信息，因此提供了 VXLAN overlay 网络的桥接和路由功能。这种方案减少了网\n络泛洪，以及本地 VTEP 上的 ARP suppression。三层内部流量直接通过 ToR 上的分布式\n网关路由，扩展性（scale-out）比较好。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/spine-leaf-design/table-3-mp-bgp-evpn.PNG\" width=\"95%\" height=\"95%\"/\u003e\u003c/p\u003e\n\u003cp align=\"center\"\u003e表 3 Cisco VXLAN MP BGP EVPN 网络特性\u003c/p\u003e\n\n\u003ch1 id=\"7-cicso-msdc-layer-3-spine-leaf-网络\"\u003e7 Cicso MSDC Layer 3 Spine-Leaf 网络\u003c/h1\u003e\n\n\u003ch1 id=\"8-数据中心-fabric-管理和自动化\"\u003e8 数据中心 Fabric 管理和自动化\u003c/h1\u003e\n\n\u003ch1 id=\"9-总结\"\u003e9 总结\u003c/h1\u003e\n\n\u003ch1 id=\"10-更多信息\"\u003e10 更多信息\u003c/h1\u003e\n\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/hierarchical-network-design-zh/\"\u003e\u003cspan\u003e« [译] 数据中心网络：hierarchical（分层）网络设计综述（2014）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/are-you-a-software-architect-zh/\"\u003e\u003cspan\u003e[译] 你是软件架构师吗？（InfoQ，2010） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2019-03-06T00:00:00Z",
  "Author": "Arthur Chiao"
}