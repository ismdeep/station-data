{
  "Source": "arthurchiao.art",
  "Title": "[译] Linux 异步 I/O 框架 io_uring：基本原理、程序示例与性能压测（2020）",
  "Link": "https://arthurchiao.art/blog/intro-to-io-uring-zh/",
  "Content": "\u003cdiv class=\"post\"\u003e\n  \n  \u003ch1 class=\"postTitle\"\u003e[译] Linux 异步 I/O 框架 io_uring：基本原理、程序示例与性能压测（2020）\u003c/h1\u003e\n  \u003cp class=\"meta\"\u003ePublished at 2021-09-01 | Last Update 2021-11-19\u003c/p\u003e\n  \n  \u003ch3 id=\"译者序\"\u003e译者序\u003c/h3\u003e\n\n\u003cp\u003e本文组合翻译了以下两篇文章的干货部分，作为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 相关的入门参考：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://thenewstack.io/how-io_uring-and-ebpf-will-revolutionize-programming-in-linux\"\u003eHow io_uring and eBPF Will Revolutionize Programming in Linux\u003c/a\u003e, ScyllaDB, 2020\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://medium.com/oracledevs/an-introduction-to-the-io-uring-asynchronous-i-o-framework-fad002d7dfc1\"\u003eAn Introduction to the io_uring Asynchronous I/O Framework\u003c/a\u003e, Oracle, 2020\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 是 2019 年 \u003cstrong\u003e\u003cmark\u003eLinux 5.1\u003c/mark\u003e\u003c/strong\u003e 内核首次引入的高性能\n\u003cstrong\u003e\u003cmark\u003e异步 I/O 框架\u003c/mark\u003e\u003c/strong\u003e，能显著加速 I/O 密集型应用的性能。\n但如果你的应用\u003cstrong\u003e\u003cmark\u003e已经在使用\u003c/mark\u003e\u003c/strong\u003e 传统 Linux AIO 了，\u003cstrong\u003e\u003cmark\u003e并且使用方式恰当\u003c/mark\u003e\u003c/strong\u003e，\n那 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e并不会带来太大的性能提升\u003c/mark\u003e\u003c/strong\u003e —— 根据原文测试（以及我们\n自己的复现），即便打开高级特性，也只有 5%。除非你真的需要这 5% 的额外性能，否则\n\u003cstrong\u003e\u003cmark\u003e切换\u003c/mark\u003e\u003c/strong\u003e成 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e代价可能也挺大\u003c/mark\u003e\u003c/strong\u003e，因为要\n\u003cstrong\u003e\u003cmark\u003e重写应用\u003c/mark\u003e\u003c/strong\u003e来适配 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e（或者让依赖的平台或框架去适配，总之需要改代码）。\u003c/p\u003e\n\n\u003cp\u003e既然性能跟传统 AIO 差不多，那为什么还称 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 为革命性技术呢？\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e它首先和最大的贡献在于：\u003cstrong\u003e\u003cmark\u003e统一了 Linux 异步 I/O 框架\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003eLinux AIO \u003cstrong\u003e\u003cmark\u003e只支持 direct I/O\u003c/mark\u003e\u003c/strong\u003e 模式的\u003cstrong\u003e\u003cmark\u003e存储文件\u003c/mark\u003e\u003c/strong\u003e\n（storage file），而且主要用在\u003cstrong\u003e\u003cmark\u003e数据库这一细分领域\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 支持存储文件和网络文件（network sockets），也支持更多的异步系统调用\n（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eaccept/openat/stat/...\u003c/code\u003e），而非仅限于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eread/write\u003c/code\u003e 系统调用。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e在\u003cstrong\u003e\u003cmark\u003e设计上是真正的异步 I/O\u003c/mark\u003e\u003c/strong\u003e，作为对比，Linux AIO 虽然也\n是异步的，但仍然可能会阻塞，某些情况下的行为也无法预测；\u003c/p\u003e\n\n    \u003cp\u003e似乎之前 Windows 在这块反而是领先的，更多参考：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"https://zhuanlan.zhihu.com/p/361955546\"\u003e浅析开源项目之 io_uring\u003c/a\u003e，“分步试存储”专栏，知乎\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"https://stackoverflow.com/questions/13407542/is-there-really-no-asynchronous-block-i-o-on-linux\"\u003eIs there really no asynchronous block I/O on Linux?\u003c/a\u003e，stackoverflow\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e灵活性和可扩展性\u003c/mark\u003e\u003c/strong\u003e非常好，甚至能基于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 重写所有系统调用，而 Linux AIO 设计时就没考虑扩展性。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eeBPF 也算是异步框架（事件驱动），但与 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 没有本质联系，二者属于不同子系统，\n并且在模型上有一个本质区别：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eeBPF 对用户是透明的\u003c/mark\u003e\u003c/strong\u003e，只需升级内核（到合适的版本），\u003cstrong\u003e\u003cmark\u003e应用程序无需任何改造\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 提供了\u003cstrong\u003e\u003cmark\u003e新的系统调用和用户空间 API\u003c/mark\u003e\u003c/strong\u003e，因此\u003cstrong\u003e\u003cmark\u003e需要应用程序做改造\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eeBPF 作为动态跟踪工具，能够更方便地排查和观测 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 等模块在执行层面的具体问题。\u003c/p\u003e\n\n\u003cp\u003e本文介绍 Linux 异步 I/O 的发展历史，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 的原理和功能，\n并给出了一些\u003cstrong\u003e\u003cmark\u003e程序示例\u003c/mark\u003e\u003c/strong\u003e和\u003cstrong\u003e\u003cmark\u003e性能压测\u003c/mark\u003e\u003c/strong\u003e结果（我们在 5.10\n内核做了类似测试，结论与原文差不多）。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eCeph 代码上已经支持了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e，但发行版在编译时没有打开这个配置，判断是否支持 io_uring\n\u003ca href=\"https://github.com/ceph/ceph/blob/a67d1cf2a7a4031609a5d37baa01ffdfef80e993/src/blk/kernel/io_uring.cc#L256\"\u003e直接返回的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efalse\u003c/code\u003e\u003c/a\u003e，\n因此想测试得自己重新编译。测试时的参考配置：\u003c/p\u003e\n\n  \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecat\u003c/span\u003e /etc/ceph/ceph.conf\n\u003cspan class=\"o\"\u003e[\u003c/span\u003eosd]\nbluestore_ioring \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e  \u003c/div\u003e\n\n  \u003cp\u003e确认配置生效（这是只是随便挑一个 OSD）：\u003c/p\u003e\n\n  \u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003eceph config show osd.16 | \u003cspan class=\"nb\"\u003egrep \u003c/span\u003eioring\nbluestore_ioring                       \u003cspan class=\"nb\"\u003etrue                                            \u003c/span\u003efile\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e  \u003c/div\u003e\n\n  \u003cp\u003e还要去看下日志，是否因为检测 io_uring 失败而 fallback 回了 libaio。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003cstrong\u003e由于译者水平有限，本文不免存在遗漏或错误之处。如有疑问，请查阅原文。\u003c/strong\u003e\u003c/p\u003e\n\n\u003cp\u003e以下是译文。\u003c/p\u003e\n\n\u003chr/\u003e\n\n\u003cul id=\"markdown-toc\"\u003e\n  \u003cli\u003e\u003ca href=\"#译者序\" id=\"markdown-toc-译者序\"\u003e译者序\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#1-linux-io-系统调用演进\" id=\"markdown-toc-1-linux-io-系统调用演进\"\u003e1 Linux I/O 系统调用演进\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#11-基于-fd-的阻塞式-ioreadwrite\" id=\"markdown-toc-11-基于-fd-的阻塞式-ioreadwrite\"\u003e1.1 基于 fd 的阻塞式 I/O：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eread()/write()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#12-非阻塞式-ioselectpollepoll\" id=\"markdown-toc-12-非阻塞式-ioselectpollepoll\"\u003e1.2 非阻塞式 I/O：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eselect()/poll()/epoll()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#13-线程池方式\" id=\"markdown-toc-13-线程池方式\"\u003e1.3 线程池方式\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#14-direct-io数据库软件绕过-page-cache\" id=\"markdown-toc-14-direct-io数据库软件绕过-page-cache\"\u003e1.4 Direct I/O（数据库软件）：绕过 page cache\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#15-异步-ioaio\" id=\"markdown-toc-15-异步-ioaio\"\u003e1.5 异步 IO（AIO）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#16-小结\" id=\"markdown-toc-16-小结\"\u003e1.6 小结\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#2-io_uring\" id=\"markdown-toc-2-io_uring\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#21-与-linux-aio-的不同\" id=\"markdown-toc-21-与-linux-aio-的不同\"\u003e2.1 与 Linux AIO 的不同\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#22-原理及核心数据结构sqcqsqecqe\" id=\"markdown-toc-22-原理及核心数据结构sqcqsqecqe\"\u003e2.2 原理及核心数据结构：SQ/CQ/SQE/CQE\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#23-带来的好处\" id=\"markdown-toc-23-带来的好处\"\u003e2.3 带来的好处\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#24-三种工作模式\" id=\"markdown-toc-24-三种工作模式\"\u003e2.4 三种工作模式\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#25-io_uring-系统调用-api\" id=\"markdown-toc-25-io_uring-系统调用-api\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 系统调用 API\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#251-io_uring_setup\" id=\"markdown-toc-251-io_uring_setup\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_setup()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#252-io_uring_register\" id=\"markdown-toc-252-io_uring_register\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_register()\u003c/code\u003e\u003c/a\u003e            \u003cul\u003e\n              \u003cli\u003e\u003ca href=\"#注册的缓冲区buffer性质\" id=\"markdown-toc-注册的缓冲区buffer性质\"\u003e注册的缓冲区（buffer）性质\u003c/a\u003e\u003c/li\u003e\n              \u003cli\u003e\u003ca href=\"#通过-eventfd-订阅-completion-事件\" id=\"markdown-toc-通过-eventfd-订阅-completion-事件\"\u003e通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eeventfd()\u003c/code\u003e 订阅 completion 事件\u003c/a\u003e\u003c/li\u003e\n            \u003c/ul\u003e\n          \u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#253-io_uring_enter\" id=\"markdown-toc-253-io_uring_enter\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#26-高级特性\" id=\"markdown-toc-26-高级特性\"\u003e2.6 高级特性\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#27-用户空间库-liburing\" id=\"markdown-toc-27-用户空间库-liburing\"\u003e2.7 用户空间库 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eliburing\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#3-基于-liburing-的示例应用\" id=\"markdown-toc-3-基于-liburing-的示例应用\"\u003e3 基于 liburing 的示例应用\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#31-io_uring-test\" id=\"markdown-toc-31-io_uring-test\"\u003e3.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring-test\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#源码及注释\" id=\"markdown-toc-源码及注释\"\u003e源码及注释\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#其他说明\" id=\"markdown-toc-其他说明\"\u003e其他说明\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#32-link-cp\" id=\"markdown-toc-32-link-cp\"\u003e3.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elink-cp\u003c/code\u003e\u003c/a\u003e        \u003cul\u003e\n          \u003cli\u003e\u003ca href=\"#io-chain\" id=\"markdown-toc-io-chain\"\u003eI/O chain\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#源码及注释-1\" id=\"markdown-toc-源码及注释-1\"\u003e源码及注释\u003c/a\u003e\u003c/li\u003e\n          \u003cli\u003e\u003ca href=\"#其他说明-1\" id=\"markdown-toc-其他说明-1\"\u003e其他说明\u003c/a\u003e\u003c/li\u003e\n        \u003c/ul\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#4-io_uring-性能压测基于-fio\" id=\"markdown-toc-4-io_uring-性能压测基于-fio\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 性能压测（基于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efio\u003c/code\u003e）\u003c/a\u003e    \u003cul\u003e\n      \u003cli\u003e\u003ca href=\"#41-测试环境\" id=\"markdown-toc-41-测试环境\"\u003e4.1 测试环境\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-场景一direct-io-1kb-随机读绕过-page-cache\" id=\"markdown-toc-42-场景一direct-io-1kb-随机读绕过-page-cache\"\u003e4.2 场景一：direct I/O \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1KB\u003c/code\u003e 随机读（绕过 page cache）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#42-场景二buffered-io-1kb-随机读数据提前加载到内存100-hot-cache\" id=\"markdown-toc-42-场景二buffered-io-1kb-随机读数据提前加载到内存100-hot-cache\"\u003e4.2 场景二：buffered I/O \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1KB\u003c/code\u003e 随机读（数据提前加载到内存，100% hot cache）\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#43-性能测试小结\" id=\"markdown-toc-43-性能测试小结\"\u003e4.3 性能测试小结\u003c/a\u003e\u003c/li\u003e\n      \u003cli\u003e\u003ca href=\"#44-scylladb-与-io_uring\" id=\"markdown-toc-44-scylladb-与-io_uring\"\u003e4.4 ScyllaDB 与 io_uring\u003c/a\u003e\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#5-ebpf\" id=\"markdown-toc-5-ebpf\"\u003e5 eBPF\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#6-结束语\" id=\"markdown-toc-6-结束语\"\u003e6 结束语\u003c/a\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"#参考资料\" id=\"markdown-toc-参考资料\"\u003e参考资料\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003chr/\u003e\n\n\u003cp\u003e很多人可能还没意识到，Linux 内核在过去几年已经发生了一场革命。这场革命源于\n\u003cstrong\u003e\u003cmark\u003e两个激动人心的新接口\u003c/mark\u003e\u003c/strong\u003e的引入：\u003cstrong\u003e\u003cmark\u003eeBPF 和 io_uring\u003c/mark\u003e\u003c/strong\u003e。\n我们认为，二者将会完全\u003cstrong\u003e\u003cmark\u003e改变应用与内核交互的方式\u003c/mark\u003e\u003c/strong\u003e，以及\n\u003cstrong\u003e\u003cmark\u003e应用开发者思考和看待内核的方式\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e本文介绍 io_uring（我们在 ScyllaDB 中有 io_uring 的深入使用经验），并略微提及一下 eBPF。\u003c/p\u003e\n\n\u003ch1 id=\"1-linux-io-系统调用演进\"\u003e1 Linux I/O 系统调用演进\u003c/h1\u003e\n\n\u003ch2 id=\"11-基于-fd-的阻塞式-ioreadwrite\"\u003e1.1 基于 fd 的阻塞式 I/O：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eread()/write()\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e作为大家最熟悉的读写方式，Linux 内核提供了\u003cstrong\u003e\u003cmark\u003e基于文件描述符的系统调用\u003c/mark\u003e\u003c/strong\u003e，\n这些描述符指向的可能是\u003cstrong\u003e\u003cmark\u003e存储文件\u003c/mark\u003e\u003c/strong\u003e（storage file），也可能是 \u003cstrong\u003e\u003cmark\u003enetwork sockets\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003essize_t\u003c/span\u003e \u003cspan class=\"nf\"\u003eread\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003cspan class=\"kt\"\u003essize_t\u003c/span\u003e \u003cspan class=\"nf\"\u003ewrite\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003econst\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ecount\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e二者称为\u003cstrong\u003e\u003cmark\u003e阻塞式系统调用\u003c/mark\u003e\u003c/strong\u003e（blocking system calls），因为程序调用\n这些函数时会进入 sleep 状态，然后被调度出去（让出处理器），直到 I/O 操作完成：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e如果数据在文件中，并且文件内容\u003cstrong\u003e\u003cmark\u003e已经缓存在 page cache 中\u003c/mark\u003e\u003c/strong\u003e，调用会\u003cstrong\u003e\u003cmark\u003e立即返回\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e如果数据在另一台机器上，就需要通过网络（例如 TCP）获取，会阻塞一段时间；\u003c/li\u003e\n  \u003cli\u003e如果数据在硬盘上，也会阻塞一段时间。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e但很容易想到，随着存储\u003cstrong\u003e\u003cmark\u003e设备越来越快，程序越来越复杂\u003c/mark\u003e\u003c/strong\u003e，\n阻塞式（blocking）已经这种最简单的方式已经不适用了。\u003c/p\u003e\n\n\u003ch2 id=\"12-非阻塞式-ioselectpollepoll\"\u003e1.2 非阻塞式 I/O：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eselect()/poll()/epoll()\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e阻塞式之后，出现了一些新的、非阻塞的系统调用，例如 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eselect()\u003c/code\u003e、\u003ccode class=\"language-plaintext highlighter-rouge\"\u003epoll()\u003c/code\u003e 以及更新的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepoll()\u003c/code\u003e。\n应用程序在调用这些函数读写时不会阻塞，而是\u003cstrong\u003e\u003cmark\u003e立即返回\u003c/mark\u003e\u003c/strong\u003e，返回的是一个\n\u003cstrong\u003e\u003cmark\u003e已经 ready 的文件描述符列表\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/intro-to-io-uring/epoll.png\" width=\"50%\" height=\"50%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e但这种方式存在一个致命缺点：\u003cstrong\u003e\u003cmark\u003e只支持 network sockets 和 pipes\u003c/mark\u003e\u003c/strong\u003e ——\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepoll()\u003c/code\u003e 甚至连 storage files 都不支持。\u003c/p\u003e\n\n\u003ch2 id=\"13-线程池方式\"\u003e1.3 线程池方式\u003c/h2\u003e\n\n\u003cp\u003e对于 storage I/O，经典的解决思路是 \u003ca href=\"https://en.wikipedia.org/wiki/Thread_pool\"\u003ethread pool\u003c/a\u003e：\n主线程将 I/O 分发给 worker 线程，后者代替主线程进行阻塞式读写，主线程不会阻塞。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/intro-to-io-uring/thread-pools.png\" width=\"40%\" height=\"40%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e这种方式的问题是\u003cstrong\u003e\u003cmark\u003e线程上下文切换开销可能非常大\u003c/mark\u003e\u003c/strong\u003e，后面性能压测会看到。\u003c/p\u003e\n\n\u003ch2 id=\"14-direct-io数据库软件绕过-page-cache\"\u003e1.4 Direct I/O（数据库软件）：绕过 page cache\u003c/h2\u003e\n\n\u003cp\u003e随后出现了更加灵活和强大的方式：\u003cstrong\u003e\u003cmark\u003e数据库软件\u003c/mark\u003e\u003c/strong\u003e（database software）\n有时 \u003ca href=\"https://www.scylladb.com/2018/07/26/how-scylla-data-cache-works\"\u003e\u003cmark\u003e并不想使用操作系统的 page cache\u003c/mark\u003e\u003c/a\u003e，\n而是希望打开一个文件后，\u003cstrong\u003e\u003cmark\u003e直接从设备读写这个文件\u003c/mark\u003e\u003c/strong\u003e（direct access to the device）。\n这种方式称为\u003cstrong\u003e\u003cmark\u003e直接访问\u003c/mark\u003e\u003c/strong\u003e（direct access）或\u003cstrong\u003e\u003cmark\u003e直接 I/O\u003c/mark\u003e\u003c/strong\u003e（direct I/O），\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e需要指定 \u003cstrong\u003e\u003cmark\u003e\u003ccode\u003eO_DIRECT\u003c/code\u003e\u003c/mark\u003e\u003c/strong\u003e flag；\u003c/li\u003e\n  \u003cli\u003e需要\u003cstrong\u003e\u003cmark\u003e应用自己管理自己的缓存\u003c/mark\u003e\u003c/strong\u003e —— 这正是数据库软件所希望的；\u003c/li\u003e\n  \u003cli\u003e是 \u003cstrong\u003e\u003cmark\u003ezero-copy I/O\u003c/mark\u003e\u003c/strong\u003e，因为应用的缓冲数据直接发送到设备，或者直接从设备读取。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"15-异步-ioaio\"\u003e1.5 异步 IO（AIO）\u003c/h2\u003e\n\n\u003cp\u003e前面提到，随着存储设备越来越快，主线程和 worker 线性之间的上下文切换开销占比越来越高。\n现在市场上的一些设备，例如 \u003ca href=\"https://pcper.com/2018/12/intels-optane-dc-persistent-memory-dimms-push-latency-closer-to-dram\"\u003eIntel Optane\u003c/a\u003e\n，\u003cstrong\u003e\u003cmark\u003e延迟已经低到和上下文切换一个量级\u003c/mark\u003e\u003c/strong\u003e（微秒 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eus\u003c/code\u003e）。换个方式描述，\n更能让我们感受到这种开销：\n\u003cstrong\u003e\u003cmark\u003e上下文每切换一次，我们就少一次 dispatch I/O 的机会\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e因此，Linux \u003cstrong\u003e\u003cmark\u003e2.6\u003c/mark\u003e\u003c/strong\u003e 内核引入了异步 I/O（asynchronous I/O）接口，\n方便起见，本文简写为 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e。AIO \u003cstrong\u003e\u003cmark\u003e原理\u003c/mark\u003e\u003c/strong\u003e是很简单的：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e用户通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_submit()\u003c/code\u003e 提交 I/O 请求，\u003c/li\u003e\n  \u003cli\u003e过一会再调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_getevents()\u003c/code\u003e 来检查哪些 events 已经 ready 了。\u003c/li\u003e\n  \u003cli\u003e使程序员\u003cstrong\u003e\u003cmark\u003e能编写完全异步的代码\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e近期，\u003ca href=\"https://lwn.net/Articles/742978/\"\u003eLinux AIO 甚至支持了\u003c/a\u003e \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eepoll()\u003c/code\u003e：也就是说\n不仅能提交 storage I/O 请求，还能提交网络 I/O 请求。照这样发展下去，linux-aio\n\u003cstrong\u003e\u003cmark\u003e似乎能成为一个王者\u003c/mark\u003e\u003c/strong\u003e。但由于它糟糕的演进之路，这个愿望几乎不可能实现了。\n我们从 \u003cstrong\u003e\u003cmark\u003eLinus 标志性的激烈言辞中就能略窥一斑\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eReply to: \u003ca href=\"https://lwn.net/Articles/671657/\"\u003eto support opening files asynchronously\u003c/a\u003e\u003c/p\u003e\n\n  \u003cp\u003e\u003cem\u003eSo I think this is ridiculously ugly.\u003c/em\u003e\u003c/p\u003e\n\n  \u003cp\u003e\u003cem\u003eAIO is a horrible ad-hoc design, with the main excuse being “other, less\ngifted people, made that design, and we are implementing it for compatibility\nbecause database people — who seldom have any shred of taste — actually use\nit”.\u003c/em\u003e\u003c/p\u003e\n\n  \u003cp\u003e— Linus Torvalds (on lwn.net)\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e首先，作为数据库从业人员，我们想借此机会为我们的没品（lack of taste）向 Linus 道歉。\n但更重要的是，我们要进一步解释一下\u003cstrong\u003e\u003cmark\u003e为什么 Linus 是对的\u003c/mark\u003e\u003c/strong\u003e：Linux AIO 确实问题缠身，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e只支持 \u003ccode\u003eO_DIRECT\u003c/code\u003e 文件\u003c/mark\u003e\u003c/strong\u003e，因此\u003cstrong\u003e\u003cmark\u003e对常规的非数据库应用\u003c/mark\u003e\u003c/strong\u003e\n  （normal, non-database applications）\u003cstrong\u003e\u003cmark\u003e几乎是无用的\u003c/mark\u003e\u003c/strong\u003e；\u003c/li\u003e\n  \u003cli\u003e接口在\u003cstrong\u003e\u003cmark\u003e设计时并未考虑扩展性\u003c/mark\u003e\u003c/strong\u003e。虽然可以扩展 —— 我们也确实这么做了 —— 但每加一个东西都相当复杂；\u003c/li\u003e\n  \u003cli\u003e虽然从\u003cstrong\u003e\u003cmark\u003e技术上说接口是非阻塞的\u003c/mark\u003e\u003c/strong\u003e，但实际上有\n  \u003ca href=\"https://lwn.net/Articles/724198\"\u003e\u003cmark\u003e很多可能的原因都会导致它阻塞\u003c/mark\u003e\u003c/a\u003e，而且引发的方式难以预料。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"16-小结\"\u003e1.6 小结\u003c/h2\u003e\n\n\u003cp\u003e以上可以清晰地看出 Linux I/O 的演进：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e最开始是同步（阻塞式）系统调用；\u003c/li\u003e\n  \u003cli\u003e然后随着\u003cstrong\u003e\u003cmark\u003e实际需求和具体场景\u003c/mark\u003e\u003c/strong\u003e，不断加入新的异步接口，还要保持与老接口的兼容和协同工作。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e另外也看到，在非阻塞式读写的问题上\u003cstrong\u003e\u003cmark\u003e并没有形成统一方案\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eNetwork socket 领域：添加一个异步接口，然后去轮询（poll）请求是否完成（readiness）；\u003c/li\u003e\n  \u003cli\u003eStorage I/O 领域：\u003cstrong\u003e\u003cmark\u003e只针对某一细分领域\u003c/mark\u003e\u003c/strong\u003e（数据库）在某一特定时期的需求，添加了一个定制版的异步接口。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e这就是 Linux I/O 的演进历史\u003c/mark\u003e\u003c/strong\u003e —— 只着眼当前，出现一个问题就引入一种设计，而并没有多少前瞻性 —— 直到 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 的出现。\u003c/p\u003e\n\n\u003ch1 id=\"2-io_uring\"\u003e2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e\u003c/h1\u003e\n\n\u003cp\u003eio_uring 来自资深内核开发者 Jens Axboe 的想法，他在 Linux I/O stack 领域颇有研究。\n从最早的 patch \u003ca href=\"https://lwn.net/ml/linux-fsdevel/20181221192236.12866-9-axboe@kernel.dk\"\u003eaio: support for IO polling\u003c/a\u003e\n可以看出，这项工作始于一个很简单的观察：随着设备越来越快，\n\u003cstrong\u003e\u003cmark\u003e中断驱动（interrupt-driven）模式效率已经低于轮询模式\u003c/mark\u003e\u003c/strong\u003e\n（polling for completions） —— 这也是高性能领域最常见的主题之一。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 的\u003cstrong\u003e\u003cmark\u003e基本逻辑与 linux-aio 是类似的\u003c/mark\u003e\u003c/strong\u003e：提供两个接口，一个将\nI/O 请求提交到内核，一个从内核接收完成事件。\u003c/li\u003e\n  \u003cli\u003e但随着开发深入，它逐渐变成了一个完全不同的接口：设计者开始从源头思考\n\u003cstrong\u003e\u003cmark\u003e如何支持完全异步的操作\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"21-与-linux-aio-的不同\"\u003e2.1 与 Linux AIO 的不同\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 与 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 有着本质的不同：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e在设计上是真正异步的\u003c/mark\u003e\u003c/strong\u003e（truly asynchronous）。只要\n  设置了合适的 flag，它在\u003cstrong\u003e\u003cmark\u003e系统调用上下文中就只是将请求放入队列\u003c/mark\u003e\u003c/strong\u003e，\n  不会做其他任何额外的事情，\u003cstrong\u003e\u003cmark\u003e保证了应用永远不会阻塞\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e支持任何类型的 I/O\u003c/mark\u003e\u003c/strong\u003e：cached files、direct-access files 甚至 blocking sockets。\u003c/p\u003e\n\n    \u003cp\u003e由于设计上就是异步的（async-by-design nature），因此\u003cstrong\u003e\u003cmark\u003e无需 poll+read/write 来处理 sockets\u003c/mark\u003e\u003c/strong\u003e。\n 只需提交一个阻塞式读（blocking read），请求完成之后，就会出现在 completion ring。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e灵活、可扩展\u003c/mark\u003e\u003c/strong\u003e：基于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 甚至能重写（re-implement）Linux 的每个系统调用。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"22-原理及核心数据结构sqcqsqecqe\"\u003e2.2 原理及核心数据结构：SQ/CQ/SQE/CQE\u003c/h2\u003e\n\n\u003cp\u003e每个 io_uring 实例都有\u003cstrong\u003e\u003cmark\u003e两个环形队列\u003c/mark\u003e\u003c/strong\u003e（ring），在内核和应用程序之间共享：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e提交队列\u003c/mark\u003e\u003c/strong\u003e：submission queue (SQ)\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e完成队列\u003c/mark\u003e\u003c/strong\u003e：completion queue (CQ)\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/intro-to-io-uring/io_uring.png\" width=\"60%\" height=\"60%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e这两个队列：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e都是\u003cstrong\u003e\u003cmark\u003e单生产者、单消费者\u003c/mark\u003e\u003c/strong\u003e，size 是 2 的幂次；\u003c/li\u003e\n  \u003cli\u003e提供\u003cstrong\u003e\u003cmark\u003e无锁接口\u003c/mark\u003e\u003c/strong\u003e（lock-less access interface），内部使用\n\u003cstrong\u003e\u003cmark\u003e内存屏障\u003c/mark\u003e\u003c/strong\u003e做同步（coordinated with memory barriers）。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e使用方式\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\n    \u003cp\u003e请求\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e应用创建 SQ entries (SQE)，更新 SQ tail；\u003c/li\u003e\n      \u003cli\u003e内核消费 SQE，更新 SQ head。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e完成\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e内核为完成的一个或多个请求创建 CQ entries (CQE)，更新 CQ tail；\u003c/li\u003e\n      \u003cli\u003e应用消费 CQE，更新 CQ head。\u003c/li\u003e\n      \u003cli\u003e完成事件（completion events）可能以任意顺序到达，到总是与特定的 SQE 相关联的。\u003c/li\u003e\n      \u003cli\u003e消费 CQE 过程无需切换到内核态。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"23-带来的好处\"\u003e2.3 带来的好处\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 这种请求方式还有一个好处是：原来需要多次系统调用（读或写），现在变成批处理一次提交。\u003c/p\u003e\n\n\u003cp\u003e还记得 Meltdown 漏洞吗？当时我还写了\u003ca href=\"https://www.scylladb.com/2018/01/07/cost-of-avoiding-a-meltdown/\"\u003e一篇文章\u003c/a\u003e\n解释为什么我们的 Scylla NoSQL 数据库受影响很小：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eaio\u003c/code\u003e 已经将我们的 I/O 系统调用批处理化了。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e将这种批处理能力带给了\u003c/mark\u003e\u003c/strong\u003e storage I/O 系统调用之外的\n\u003cstrong\u003e\u003cmark\u003e其他一些系统调用\u003c/mark\u003e\u003c/strong\u003e，包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eread\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ewrite\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esend\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003erecv\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eaccept\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eopenat\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003estat\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e专用的一些系统调用，例如 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efallocate\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e此外，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 使异步 I/O 的使用场景也不再仅限于数据库应用，\u003cstrong\u003e\u003cmark\u003e普通的\n非数据库应用也能用\u003c/mark\u003e\u003c/strong\u003e。这一点值得重复一遍：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003e虽然 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 与 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eaio\u003c/code\u003e 有一些相似之处，但它的\u003cstrong\u003e\u003cmark\u003e扩展性和架构是革命性的\u003c/mark\u003e\u003c/strong\u003e：\n它\u003cstrong\u003e\u003cmark\u003e将异步操作的强大能力带给了所有应用\u003c/mark\u003e\u003c/strong\u003e（及其开发者），而\n\u003cstrong\u003e\u003cmark\u003e不再仅限于是数据库应用这一细分领域\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e我们的 CTO Avi Kivity 在 the Core C++ 2019 event 上 \u003ca href=\"https://www.scylladb.com/2020/03/26/avi-kivity-at-core-c-2019\"\u003e有一次关于 async 的分享\u003c/a\u003e。\n核心点包括：\u003cstrong\u003e\u003cmark\u003e从延迟上来说\u003c/mark\u003e\u003c/strong\u003e，\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e现代多核、多 CPU 设备，其内部本身就是一个基础网络；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eCPU 之间\u003c/mark\u003e\u003c/strong\u003e是另一个网络；\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eCPU 和磁盘 I/O 之间\u003c/mark\u003e\u003c/strong\u003e又是一个网络。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e因此网络编程采用异步是明智的，而现在开发自己的应用也应该考虑异步。\n这\u003cstrong\u003e\u003cmark\u003e从根本上改变了 Linux 应用的设计方式\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e之前都是一段顺序代码流，需要系统调用时才执行系统调用，\u003c/li\u003e\n  \u003cli\u003e现在需要思考一个文件是否 ready，因而自然地引入 event-loop，不断通过共享 buffer 提交请求和接收结果。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"24-三种工作模式\"\u003e2.4 三种工作模式\u003c/h2\u003e\n\n\u003cp\u003eio_uring 实例可工作在三种模式：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e中断驱动模式\u003c/mark\u003e\u003c/strong\u003e（interrupt driven）\u003c/p\u003e\n\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e默认模式\u003c/mark\u003e\u003c/strong\u003e。可通过 io_uring_enter() 提交 I/O 请求，然后直接检查 CQ 状态判断是否完成。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e轮询模式\u003c/mark\u003e\u003c/strong\u003e（polled）\u003c/p\u003e\n\n    \u003cp\u003eBusy-waiting for an I/O completion，而不是通过异步 IRQ（Interrupt Request）接收通知。\u003c/p\u003e\n\n    \u003cp\u003e这种模式需要文件系统（如果有）和块设备（block device）支持轮询功能。\n 相比中断驱动方式，这种方式延迟更低（\u003ca href=\"https://www.phoronix.com/scan.php?page=news_item\u0026amp;px=Linux-io_uring-Fast-Efficient\"\u003e连系统调用都省了\u003c/a\u003e），\n 但可能会消耗更多 CPU 资源。\u003c/p\u003e\n\n    \u003cp\u003e目前，只有指定了 O_DIRECT flag 打开的文件描述符，才能使用这种模式。当一个读\n 或写请求提交给轮询上下文（polled context）之后，应用（application）必须调用\n \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e 来轮询 CQ 队列，判断请求是否已经完成。\u003c/p\u003e\n\n    \u003cp\u003e对一个 io_uring 实例来说，\u003cstrong\u003e\u003cmark\u003e不支持混合使用轮询和非轮询模式\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003cstrong\u003e\u003cmark\u003e内核轮询模式\u003c/mark\u003e\u003c/strong\u003e（kernel polled）\u003c/p\u003e\n\n    \u003cp\u003e这种模式中，会 \u003cstrong\u003e\u003cmark\u003e创建一个内核线程\u003c/mark\u003e\u003c/strong\u003e（kernel thread）来执行 SQ 的轮询工作。\u003c/p\u003e\n\n    \u003cp\u003e使用这种模式的 io_uring 实例， \u003cstrong\u003e\u003cmark\u003e应用无需切到到内核态\u003c/mark\u003e\u003c/strong\u003e 就能触发（issue）I/O 操作。\n通过 SQ 来提交 SQE，以及监控 CQ 的完成状态，应用无需任何系统调用，就能提交和收割 I/O（submit and reap I/Os）。\u003c/p\u003e\n\n    \u003cp\u003e如果内核线程的空闲时间超过了用户的配置值，它会通知应用，然后进入 idle 状态。\n这种情况下，应用必须调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e 来唤醒内核线程。如果 I/O 一直很繁忙，内核线性是不会 sleep 的。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"25-io_uring-系统调用-api\"\u003e2.5 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 系统调用 API\u003c/h2\u003e\n\n\u003cp\u003e有三个：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_setup(2)\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_register(2)\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter(2)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e下面展开介绍。完整文档见 \u003ca href=\"https://github.com/axboe/liburing/tree/master/man\"\u003emanpage\u003c/a\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"251-io_uring_setup\"\u003e2.5.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_setup()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e执行异步 I/O 需要先\u003cstrong\u003e\u003cmark\u003e设置上下文\u003c/mark\u003e\u003c/strong\u003e：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eio_uring_setup\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eu32\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_params\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ep\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这个系统调用\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003e创建一个 SQ 和一个 CQ\u003c/mark\u003e\u003c/strong\u003e，\u003c/li\u003e\n  \u003cli\u003equeue size 至少 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eentries\u003c/code\u003e 个元素，\u003c/li\u003e\n  \u003cli\u003e返回一个文件描述符，随后用于在这个 io_uring 实例上执行操作。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eSQ 和 CQ 在应用和内核之间共享，避免了在初始化和完成 I/O 时（initiating and completing I/O）拷贝数据。\u003c/p\u003e\n\n\u003cp\u003e参数 p：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e应用用来配置 io_uring，\u003c/li\u003e\n  \u003cli\u003e内核返回的 SQ/CQ 配置信息也通过它带回来。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003eio_uring_setup() 成功时返回一个文件描述符（fd）。应用随后可以将这个 fd 传给 mmap(2) 系统调用，来\nmap the submission and completion queues 或者传给 to the io_uring_register() or io_uring_enter() system calls.\u003c/p\u003e\n\n\u003ch3 id=\"252-io_uring_register\"\u003e2.5.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_register()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cp\u003e注册用于异步 I/O 的\u003cstrong\u003e\u003cmark\u003e文件或用户缓冲区\u003c/mark\u003e\u003c/strong\u003e（files or user buffers）：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eio_uring_register\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eopcode\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003earg\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003enr_args\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e注册文件或用户缓冲区，使内核能\u003cstrong\u003e\u003cmark\u003e长时间持有对该文件在内核内部的数据结构引用\u003c/mark\u003e\u003c/strong\u003e（internal kernel data structures associated with the files），\n或创建\u003cstrong\u003e\u003cmark\u003e应用内存的长期映射\u003c/mark\u003e\u003c/strong\u003e（long term mappings of application memory associated with the buffers），\n这个操作只会在注册时执行一次，而不是每个 I/O 请求都会处理，因此减少了 \nper-I/O overhead。\u003c/p\u003e\n\n\u003ch4 id=\"注册的缓冲区buffer性质\"\u003e注册的缓冲区（buffer）性质\u003c/h4\u003e\n\n\u003cul\u003e\n  \u003cli\u003eRegistered buffers 将会\u003cstrong\u003e\u003cmark\u003e被锁定在内存中\u003c/mark\u003e\u003c/strong\u003e（be locked in memory），并\u003cstrong\u003e\u003cmark\u003e计入用户的 RLIMIT_MEMLOCK\u003c/mark\u003e\u003c/strong\u003e 资源限制。\u003c/li\u003e\n  \u003cli\u003e此外，每个 buffer 有 \u003cstrong\u003e\u003cmark\u003e1GB 的大小限制\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e当前，buffers 必须是\u003cstrong\u003e\u003cmark\u003e匿名、非文件后端的内存\u003c/mark\u003e\u003c/strong\u003e（anonymous,\nnon-file-backed memory），例如 malloc(3) or mmap(2) with the MAP_ANONYMOUS\nflag set 返回的内存。\u003c/li\u003e\n  \u003cli\u003eHuge pages 也是支持的。整个 huge page 都会被 pin 到内核，即使只用到了其中一部分。\u003c/li\u003e\n  \u003cli\u003e已经注册的 buffer 无法调整大小，想调整只能先 unregister，再重新 register 一个新的。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch4 id=\"通过-eventfd-订阅-completion-事件\"\u003e通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eeventfd()\u003c/code\u003e 订阅 completion 事件\u003c/h4\u003e\n\n\u003cp\u003e可以用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eeventfd(2)\u003c/code\u003e 订阅 io_uring 实例的 completion events。\n将 eventfd 描述符通过这个系统调用注册就行了。\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eThe credentials of the running application can be registered with io_uring which returns an id associated with\nthose credentials. Applications wishing to share a ring between separate\nusers/processes can pass in this credential id in the SQE personality field. If\nset, that particular SQE will be issued with these credentials.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003ch3 id=\"253-io_uring_enter\"\u003e2.5.3 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eio_uring_enter\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eto_submit\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003emin_complete\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003esigset_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esig\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e这个系统调用用于初始化和完成（initiate and complete）I/O，使用共享的 SQ 和 CQ。\n单次调用同时执行：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e提交新的 I/O 请求\u003c/li\u003e\n  \u003cli\u003e等待 I/O 完成\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e参数：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003efd\u003c/code\u003e 是 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_setup()\u003c/code\u003e 返回的文件描述符；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eto_submit\u003c/code\u003e 指定了 SQ 中提交的 I/O 数量；\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e依据不同模式：\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e默认模式，如果指定了 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emin_complete\u003c/code\u003e，会等待这个数量的 I/O 事件完成再返回；\u003c/li\u003e\n      \u003cli\u003e\n        \u003cp\u003e如果 io_uring 是 polling 模式，这个参数表示：\u003c/p\u003e\n\n        \u003col\u003e\n          \u003cli\u003e0：要求内核返回当前以及完成的所有 events，无阻塞；\u003c/li\u003e\n          \u003cli\u003e非零：如果有事件完成，内核仍然立即返回；如果没有完成事件，内核会 poll，等待指定的次数完成，或者这个进程的时间片用完。\u003c/li\u003e\n        \u003c/ol\u003e\n      \u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e注意：对于 interrupt driven I/O，\u003cstrong\u003e\u003cmark\u003e应用无需进入内核就能检查 CQ 的 event completions\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e 支持很多操作，包括：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eOpen, close, and stat files\u003c/li\u003e\n  \u003cli\u003eRead and write into multiple buffers or pre-mapped buffers\u003c/li\u003e\n  \u003cli\u003eSocket I/O operations\u003c/li\u003e\n  \u003cli\u003eSynchronize file state\u003c/li\u003e\n  \u003cli\u003eAsynchronously monitor a set of file descriptors\u003c/li\u003e\n  \u003cli\u003eCreate a timeout linked to a specific operation in the ring\u003c/li\u003e\n  \u003cli\u003eAttempt to cancel an operation that is currently in flight\u003c/li\u003e\n  \u003cli\u003eCreate I/O chains\u003c/li\u003e\n  \u003cli\u003eOrdered execution within a chain\u003c/li\u003e\n  \u003cli\u003eParallel execution of multiple chains\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e当这个系统调用返回时，表示一定数量的 SEQ 已经被消费和提交了，此时可以安全的重用队列中的 SEQ。\n此时 IO 提交有可能还停留在异步上下文中，即实际上 SQE 可能还没有被提交 —— 不过\n用户不用关心这些细节 —— 当随后内核需要使用某个特定的 SQE 时，它已经复制了一份。\u003c/p\u003e\n\n\u003ch2 id=\"26-高级特性\"\u003e2.6 高级特性\u003c/h2\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 提供了一些用于特殊场景的高级特性：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eFile registration\u003c/mark\u003e\u003c/strong\u003e（文件注册）：每次发起一个指定文件描述的操\n作，内核都需要\u003cstrong\u003e\u003cmark\u003e花费一些时钟周期\u003c/mark\u003e\u003c/strong\u003e（cycles）\u003cstrong\u003e\u003cmark\u003e将文件描述符映射到内部表示\u003c/mark\u003e\u003c/strong\u003e。\n对于那些\u003cstrong\u003e\u003cmark\u003e针对同一文件进行重复操作\u003c/mark\u003e\u003c/strong\u003e的场景，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 支持\u003cstrong\u003e\u003cmark\u003e提前注册这些文件\u003c/mark\u003e\u003c/strong\u003e，后面直接查找就行了。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eBuffer registration\u003c/mark\u003e\u003c/strong\u003e（缓冲区注册）：与 file registration 类\n似，direct I/O 场景中，内核需要 map/unmap memory areas。\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 支持提前\n注册这些缓冲区（buffers）。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003ePoll ring\u003c/mark\u003e\u003c/strong\u003e（轮询环形缓冲区）：对于非常快是设备，处理中断的开\n销是比较大的。\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 允许用户关闭中断，使用轮询模式。前面“三种工作模式”小节\n也介绍到了这一点。\u003c/li\u003e\n  \u003cli\u003e\u003cstrong\u003e\u003cmark\u003eLinked operations\u003c/mark\u003e\u003c/strong\u003e（链接操作）：允许用户发送串联的请求。这两\n个请求同时提交，但后面的会等前面的处理完才开始执行。\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"27-用户空间库-liburing\"\u003e2.7 用户空间库 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eliburing\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e\u003ca href=\"https://github.com/axboe/liburing/\"\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eliburing\u003c/code\u003e\u003c/a\u003e 提供了一个简单的高层 API，\n可用于一些基本场景，应用程序避免了直接使用更底层的系统调用。\n此外，这个 API 还避免了一些重复操作的代码，如设置 io_uring 实例。\u003c/p\u003e\n\n\u003cp\u003e举个例子，在 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_setup()\u003c/code\u003e 的 manpage 描述中，调用这个系统调用获得一个 ring 文\n件描述符之后，应用必须调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003emmap()\u003c/code\u003e 来这样的逻辑需要一段略长的代码，而用\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eliburing\u003c/code\u003e 的话，下面的函数已经将上述流程封装好了：\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eio_uring_queue_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"n\"\u003eflags\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e下一节来看两个例子基于 liburing 的例子。\u003c/p\u003e\n\n\u003ch1 id=\"3-基于-liburing-的示例应用\"\u003e3 基于 liburing 的示例应用\u003c/h1\u003e\n\n\u003cp\u003e编译：\u003c/p\u003e\n\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egit clone https://github.com/axboe/liburing.git\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003egit co \u003cspan class=\"nt\"\u003e-b\u003c/span\u003e liburing-2.0 tags/liburing-2.0\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003ecd \u003c/span\u003eliburing\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e\u003cspan class=\"nb\"\u003els \u003c/span\u003eexamples/\nio_uring-cp  io_uring-cp.c  io_uring-test  io_uring-test.c  link-cp  link-cp.c  Makefile  ucontext-cp  ucontext-cp.c\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003emake \u003cspan class=\"nt\"\u003e-j4\u003c/span\u003e\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./examples/io_uring-test \u0026lt;file\u0026gt;\n\u003cspan class=\"nv\"\u003eSubmitted\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4, \u003cspan class=\"nv\"\u003ecompleted\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e4, \u003cspan class=\"nv\"\u003ebytes\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e16384\n\n\u003cspan class=\"nv\"\u003e$ \u003c/span\u003e./examples/link-cp \u0026lt;\u003cspan class=\"k\"\u003ein\u003c/span\u003e\u003cspan class=\"nt\"\u003e-file\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u0026lt;out-file\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"31-io_uring-test\"\u003e3.1 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring-test\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003e这个程序使用 4 个 SQE，从输入文件中\u003cstrong\u003e\u003cmark\u003e读取最多 16KB 数据\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch3 id=\"源码及注释\"\u003e源码及注释\u003c/h3\u003e\n\n\u003cp\u003e为方便看清主要逻辑，忽略了一些错误处理代码，完整代码见\n\u003ca href=\"https://github.com/axboe/liburing/blob/liburing-2.0/examples/io_uring-test.c\"\u003eio_uring-test.c\u003c/a\u003e。\u003c/p\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* SPDX-License-Identifier: MIT */\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\n * Simple app that demonstrates how to setup an io_uring interface,\n * submit and complete IO against it, and then tear it down.\n *\n * gcc -Wall -O2 -D_GNU_SOURCE -o io_uring-test io_uring-test.c -luring\n */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026#34;liburing.h\u0026#34;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define QD    4 // io_uring 队列长度\n\u003c/span\u003e\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epending\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edone\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 1. 初始化一个 io_uring 实例\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_queue_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 队列长度\u003c/span\u003e\n                              \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"c1\"\u003e// io_uring 实例\u003c/span\u003e\n                              \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// flags，0 表示默认配置，例如使用中断驱动模式\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 2. 打开输入文件，注意这里指定了 O_DIRECT flag，内核轮询模式需要这个 flag，见前面介绍\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDONLY\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_DIRECT\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003estat\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efstat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 获取文件信息，例如文件长度，后面会用到\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 3. 初始化 4 个读缓冲区\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003essize_t\u003c/span\u003e \u003cspan class=\"n\"\u003efsize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e             \u003cspan class=\"c1\"\u003e// 程序的最大读取长度\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiovec\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eiovecs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiovec\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eposix_memalign\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eiovecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebuf\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 起始地址\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eiovecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 缓冲区大小\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efsize\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4096\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 4. 依次准备 4 个 SQE 读请求，指定将随后读入的数据写入 iovecs \u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_sqe\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003edo\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003esqe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_get_sqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 获取可用 SQE\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eio_uring_prep_readv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 用这个 SQE 准备一个待提交的 read 操作\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e         \u003cspan class=\"c1\"\u003e// 从 fd 打开的文件中读取数据\u003c/span\u003e\n                            \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003eiovecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"c1\"\u003e// iovec 地址，读到的数据写入 iovec 缓冲区\u003c/span\u003e\n                            \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e          \u003cspan class=\"c1\"\u003e// iovec 数量\u003c/span\u003e\n                            \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 读取操作的起始地址偏移量\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003eiovecs\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e].\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e    \u003cspan class=\"c1\"\u003e// 更新偏移量，下次使用\u003c/span\u003e\n        \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 如果超出了文件大小，停止准备后面的 SQE\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ebreak\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 5. 提交 SQE 读请求\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_submit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 4 个 SQE 一次提交，返回提交成功的 SQE 数量\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;io_uring_submit: %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estrerror\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;io_uring_submit submitted less %d\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 6. 等待读请求完成（CQE）\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_cqe\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edone\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003epending\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003efsize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003efor\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003epending\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"n\"\u003ei\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eio_uring_wait_cqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 等待系统返回一个读完成事件\u003c/span\u003e\n        \u003cspan class=\"n\"\u003edone\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e4096\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003efsize\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003esb\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_size\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003efprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003estderr\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"s\"\u003e\u0026#34;ret=%d, wanted 4096\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"n\"\u003efsize\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003eio_uring_cqe_seen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// 更新 io_uring 实例的完成队列\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 7. 打印统计信息\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;Submitted=%d, completed=%d, bytes=%lu\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003epending\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edone\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003efsize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"c1\"\u003e// 8. 清理工作\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_queue_exit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"其他说明\"\u003e其他说明\u003c/h3\u003e\n\n\u003cp\u003e代码中已经添加了注释，这里再解释几点：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e每个 SQE 都执行一个 allocated buffer，后者是用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eiovec\u003c/code\u003e 结构描述的；\u003c/li\u003e\n  \u003cli\u003e第 3 \u0026amp; 4 步：初始化所有 SQE，用于接下来的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIORING_OP_READV\u003c/code\u003e 操作，后者\n\u003cstrong\u003e\u003cmark\u003e提供了 \u003ccode\u003ereadv(2)\u003c/code\u003e 系统调用的异步接口\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e操作完成之后，这个 SQE iovec buffer 中存放的是相关 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ereadv\u003c/code\u003e 操作的结果；\u003c/li\u003e\n  \u003cli\u003e接下来调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_wait_cqe()\u003c/code\u003e 来 reap CQE，并通过 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecqe-\u0026gt;res\u003c/code\u003e 字段验证读取的字节数；\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_cqe_seen()\u003c/code\u003e 通知内核这个 CQE 已经被消费了。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"32-link-cp\"\u003e3.2 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elink-cp\u003c/code\u003e\u003c/h2\u003e\n\n\u003cp\u003elink-cp 使用 io_uring 高级特性 SQE chaining 特性来复制文件。\u003c/p\u003e\n\n\u003ch3 id=\"io-chain\"\u003eI/O chain\u003c/h3\u003e\n\n\u003cp\u003eio_uring 支持创建 I/O chain。一个 chain 内的 I/O 是顺序执行的，多个 I/O chain 可以并行执行。\u003c/p\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_enter()\u003c/code\u003e manpage 中对 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIOSQE_IO_LINK\u003c/code\u003e 有 \u003ca href=\"https://www.mankier.com/2/io_uring_enter#Description-IOSQE_IO_LINK\"\u003e详细解释\u003c/a\u003e：\u003c/p\u003e\n\n\u003cblockquote\u003e\n  \u003cp\u003eWhen this flag is specified, it forms a link with the next SQE in the\nsubmission ring. That next SQE will not be started before this one completes.\nThis, in effect, forms a chain of SQEs, which can be arbitrarily long. The tail\nof the chain is denoted by the first SQE that does not have this flag set. This\nflag has no effect on previous SQE submissions, nor does it impact SQEs that\nare outside of the chain tail. This means that multiple chains can be executing\nin parallel, or chains and individual SQEs. Only members inside the chain are\nserialized. A chain of SQEs will be broken, if any request in that chain ends\nin error. io_uring considers any unexpected result an error. This means that,\neg, a short read will also terminate the remainder of the chain. If a chain of\nSQE links is broken, the remaining unstarted part of the chain will be\nterminated and completed with -ECANCELED as the error code. Available since\n5.3.\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e为实现复制文件功能，link-cp 创建一个长度为 2 的 SQE chain。\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e第一个 SQE 是一个读请求，将数据从输入文件读到 buffer；\u003c/li\u003e\n  \u003cli\u003e第二个请求，与第一个请求是 linked，是一个写请求，将数据从 buffer 写入输出文件。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch3 id=\"源码及注释-1\"\u003e源码及注释\u003c/h3\u003e\n\n\u003cdiv class=\"language-c highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"cm\"\u003e/* SPDX-License-Identifier: MIT */\u003c/span\u003e\n\u003cspan class=\"cm\"\u003e/*\n * Very basic proof-of-concept for doing a copy with linked SQEs. Needs a\n * bit of error handling and short read love.\n */\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#include\u003c/span\u003e \u003cspan class=\"cpf\"\u003e\u0026#34;liburing.h\u0026#34;\u003c/span\u003e\u003cspan class=\"cp\"\u003e\n\u003c/span\u003e\n\u003cspan class=\"cp\"\u003e#define QD    64         // io_uring 队列长度\n#define BS    (32*1024)\n\u003c/span\u003e\n\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_data\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eiovec\u003c/span\u003e \u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e};\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003einfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutfd\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"n\"\u003einflight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 创建一个 read-\u0026gt;write SQE chain\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"nf\"\u003equeue_rw_pair\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_sqe\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_data\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003emalloc\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"k\"\u003esizeof\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"o\"\u003e+\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_base\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esqe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_get_sqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                            \u003cspan class=\"c1\"\u003e// 获取可用 SQE\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_prep_readv\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e   \u003cspan class=\"c1\"\u003e// 准备 read 请求\u003c/span\u003e\n    \u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eflags\u003c/span\u003e \u003cspan class=\"o\"\u003e|=\u003c/span\u003e \u003cspan class=\"n\"\u003eIOSQE_IO_LINK\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                             \u003cspan class=\"c1\"\u003e// 设置为 LINK 模式\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_sqe_set_data\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                        \u003cspan class=\"c1\"\u003e// 设置 data\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003esqe\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_get_sqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                            \u003cspan class=\"c1\"\u003e// 获取另一个可用 SQE\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_prep_writev\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoutfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 准备 write 请求\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_sqe_set_data\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esqe\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e                        \u003cspan class=\"c1\"\u003e// 设置 data\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e// 处理完成（completion）事件：释放 SQE 的内存缓冲区，通知内核已经消费了 CQE。\u003c/span\u003e\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ehandle_cqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_cqe\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_data\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_cqe_get_data\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 获取 CQE\u003c/span\u003e\n    \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e\u003cspan class=\"o\"\u003e++\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"n\"\u003eECANCELED\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003equeue_rw_pair\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBS\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einflight\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eprintf\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;cqe error: %s\u003c/span\u003e\u003cspan class=\"se\"\u003e\\n\u003c/span\u003e\u003cspan class=\"s\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003estrerror\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eres\u003c/span\u003e\u003cspan class=\"p\"\u003e));\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eindex\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// read-\u0026gt;write chain 完成，释放缓冲区内存\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003evoid\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e \u003cspan class=\"n\"\u003edata\u003c/span\u003e\u003cspan class=\"o\"\u003e-\u0026gt;\u003c/span\u003e\u003cspan class=\"n\"\u003eiov\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003eiov_len\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"n\"\u003efree\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eptr\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eio_uring_cqe_seen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// 通知内核已经消费了 CQE 事件\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003ecopy_file\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring_cqe\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003esize_t\u003c/span\u003e \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e                      \u003cspan class=\"c1\"\u003e// 数据还没处理完\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003ehas_inflight\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einflight\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e      \u003cspan class=\"c1\"\u003e// 当前正在进行中的 SQE 数量\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003edepth\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e  \u003cspan class=\"c1\"\u003e// SQE 阈值，当前进行中的 SQE 数量（inflight）超过这个值之后，需要阻塞等待 CQE 完成\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einsize\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e \u003cspan class=\"n\"\u003einflight\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 数据还没处理完，io_uring 队列也还没用完\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eBS\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 最后一段数据不足 BS 大小\u003c/span\u003e\n                \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n            \u003cspan class=\"n\"\u003equeue_rw_pair\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e \u003cspan class=\"c1\"\u003e// 创建一个 read-\u0026gt;write chain，占用两个 SQE\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eoffset\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einsize\u003c/span\u003e \u003cspan class=\"o\"\u003e-=\u003c/span\u003e \u003cspan class=\"n\"\u003ethis_size\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einflight\u003c/span\u003e \u003cspan class=\"o\"\u003e+=\u003c/span\u003e \u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                \u003cspan class=\"c1\"\u003e// 正在进行中的 SQE 数量 +2\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ehas_inflight\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"n\"\u003einflight\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e     \u003cspan class=\"c1\"\u003e// 如果有新创建的 SQE，\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eio_uring_submit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 就提交给内核\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e                       \u003cspan class=\"c1\"\u003e// 如果还有 data 等待处理，\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edepth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                   \u003cspan class=\"c1\"\u003e// 阈值设置 SQ 的队列长度，即 SQ 队列用完才开始阻塞等待 CQE；\u003c/span\u003e\n        \u003cspan class=\"k\"\u003eelse\u003c/span\u003e                              \u003cspan class=\"c1\"\u003e// data 处理已经全部提交，\u003c/span\u003e\n            \u003cspan class=\"n\"\u003edepth\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                    \u003cspan class=\"c1\"\u003e// 阈值设置为 1，即只要还有 SQE 未完成，就阻塞等待 CQE\u003c/span\u003e\n\n        \u003cspan class=\"c1\"\u003e// 下面这个 while 只有 SQ 队列用完或 data 全部提交之后才会执行到\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ewhile\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einflight\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan class=\"n\"\u003edepth\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e       \u003cspan class=\"c1\"\u003e// 如果所有 SQE 都已经用完，或者所有 data read-\u0026gt;write 请求都已经提交\u003c/span\u003e\n            \u003cspan class=\"n\"\u003eio_uring_wait_cqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\u003cspan class=\"c1\"\u003e// 等待内核 completion 事件\u003c/span\u003e\n            \u003cspan class=\"n\"\u003ehandle_cqe\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ecqe\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e        \u003cspan class=\"c1\"\u003e// 处理 completion 事件：释放 SQE 内存缓冲区，通知内核 CQE 已消费\u003c/span\u003e\n            \u003cspan class=\"n\"\u003einflight\u003c/span\u003e\u003cspan class=\"o\"\u003e--\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e                   \u003cspan class=\"c1\"\u003e// 正在进行中的 SQE 数量 -1\u003c/span\u003e\n        \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003esetup_context\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_queue_init\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eentries\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003estatic\u003c/span\u003e \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003eget_file_size\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003estat\u003c/span\u003e \u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efstat\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026lt;\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS_ISREG\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_mode\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_size\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e \u003cspan class=\"k\"\u003eelse\u003c/span\u003e \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eS_ISBLK\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003est\u003c/span\u003e\u003cspan class=\"p\"\u003e.\u003c/span\u003e\u003cspan class=\"n\"\u003est_mode\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"kt\"\u003eunsigned\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"kt\"\u003elong\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eioctl\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003efd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003eBLKGETSIZE64\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e \u003cspan class=\"o\"\u003e!=\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e)\u003c/span\u003e\n            \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n        \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003esize\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ebytes\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e0\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"o\"\u003e-\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"nf\"\u003emain\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eargc\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"kt\"\u003echar\u003c/span\u003e \u003cspan class=\"o\"\u003e*\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[])\u003c/span\u003e \u003cspan class=\"p\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"k\"\u003estruct\u003c/span\u003e \u003cspan class=\"n\"\u003eio_uring\u003c/span\u003e \u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eoff_t\u003c/span\u003e \u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"kt\"\u003eint\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003einfd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eO_RDONLY\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eoutfd\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003eopen\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eargv\u003c/span\u003e\u003cspan class=\"p\"\u003e[\u003c/span\u003e\u003cspan class=\"mi\"\u003e2\u003c/span\u003e\u003cspan class=\"p\"\u003e],\u003c/span\u003e \u003cspan class=\"n\"\u003eO_WRONLY\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_CREAT\u003c/span\u003e \u003cspan class=\"o\"\u003e|\u003c/span\u003e \u003cspan class=\"n\"\u003eO_TRUNC\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"mo\"\u003e0644\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003esetup_context\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eQD\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eget_file_size\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einfd\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e))\u003c/span\u003e\n        \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"mi\"\u003e1\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eret\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"n\"\u003ecopy_file\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e,\u003c/span\u003e \u003cspan class=\"n\"\u003einsize\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n\n    \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003einfd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eclose\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"n\"\u003eoutfd\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"n\"\u003eio_uring_queue_exit\u003c/span\u003e\u003cspan class=\"p\"\u003e(\u003c/span\u003e\u003cspan class=\"o\"\u003e\u0026amp;\u003c/span\u003e\u003cspan class=\"n\"\u003ering\u003c/span\u003e\u003cspan class=\"p\"\u003e);\u003c/span\u003e\n    \u003cspan class=\"k\"\u003ereturn\u003c/span\u003e \u003cspan class=\"n\"\u003eret\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e\n\u003cspan class=\"p\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch3 id=\"其他说明-1\"\u003e其他说明\u003c/h3\u003e\n\n\u003cp\u003e代码中实现了三个函数：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ecopy_file()\u003c/code\u003e：高层复制循环逻辑；它会调用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003equeue_rw_pair(ring, this_size, offset)\u003c/code\u003e 来构造 SQE pair；\n  并通过一次 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring_submit()\u003c/code\u003e 调用将所有构建的 SQE pair 提交。\u003c/p\u003e\n\n    \u003cp\u003e这个函数维护了一个最大 DQ 数量的 inflight SQE，只要数据 copy 还在进行中；否则，即数据已经全部读取完成，就开始等待和收割所有的 CQE。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003equeue_rw_pair()\u003c/code\u003e 构造一个 read-write SQE pair.\u003c/p\u003e\n\n    \u003cp\u003eread SQE 的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eIOSQE_IO_LINK\u003c/code\u003e flag 表示开始一个 chain，write SQE 不用设置这个 flag，标志着这个 chain 的结束。\n 用户 data 字段设置为同一个 data 描述符，并且在随后的 completion 处理中会用到。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ehandle_cqe()\u003c/code\u003e 从 CQE 中提取之前由  \u003ccode class=\"language-plaintext highlighter-rouge\"\u003equeue_rw_pair()\u003c/code\u003e 保存的 data 描述符，并在描述符中记录处理进展（index）。\u003c/p\u003e\n\n    \u003cp\u003e如果之前请求被取消，它还会重新提交 read-write pair。\u003c/p\u003e\n\n    \u003cp\u003e一个 CQE pair 的两个 member 都处理完成之后（\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eindex==2\u003c/code\u003e），释放共享的 data descriptor。\n最后通知内核这个 CQE 已经被消费。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"4-io_uring-性能压测基于-fio\"\u003e4 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 性能压测（基于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efio\u003c/code\u003e）\u003c/h1\u003e\n\n\u003cp\u003e\u003cstrong\u003e\u003cmark\u003e对于已经在使用 linux-aio 的应用\u003c/mark\u003e\u003c/strong\u003e，例如 ScyllaDB，\n\u003cstrong\u003e\u003cmark\u003e不要期望换成 io_uring 之后能获得大幅的性能提升\u003c/mark\u003e\u003c/strong\u003e，这是因为：\n\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 性能相关的底层机制与 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 并无本质不同（都是异步提交，轮询结果）。\u003c/p\u003e\n\n\u003cp\u003e在此，本文也希望使读者明白：\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e首先和最重要的贡献\u003c/mark\u003e\u003c/strong\u003e在于：\n\u003cstrong\u003e\u003cmark\u003e将 linux-aio 的所有优良特性带给了普罗大众\u003c/mark\u003e\u003c/strong\u003e（而非局限于数据库这样的细分领域）。\u003c/p\u003e\n\n\u003ch2 id=\"41-测试环境\"\u003e4.1 测试环境\u003c/h2\u003e\n\n\u003cp\u003e本节使用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efio\u003c/code\u003e 测试 4 种模式：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003esynchronous reads\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eposix-aio\u003c/code\u003e (implemented as a thread pool)\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e硬件：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003eNVMe 存储设备，物理极限能打到 \u003cstrong\u003e\u003cmark\u003e3.5M IOPS\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n  \u003cli\u003e8 核处理器\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003ch2 id=\"42-场景一direct-io-1kb-随机读绕过-page-cache\"\u003e4.2 场景一：direct I/O \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1KB\u003c/code\u003e 随机读（绕过 page cache）\u003c/h2\u003e\n\n\u003cp\u003e第一组测试中，我们希望所有的读请求都能\u003cstrong\u003e\u003cmark\u003e命中存储设备\u003c/mark\u003e\u003c/strong\u003e（all reads\nto hit the storage），\u003cstrong\u003e\u003cmark\u003e完全绕开操作系统的页缓存\u003c/mark\u003e\u003c/strong\u003e（page cache）。\u003c/p\u003e\n\n\u003cp\u003e测试配置：\u003c/p\u003e\n\n\u003cul\u003e\n  \u003cli\u003e8 个 CPU 执行 72 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003efio\u003c/code\u003e job，\u003c/li\u003e\n  \u003cli\u003e每个 job 随机读取 4 个文件，\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eiodepth=8\u003c/code\u003e（number of I/O units to keep in flight against the file.）。\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e这种配置\u003cstrong\u003e\u003cmark\u003e保证了 CPU 处于饱和状态\u003c/mark\u003e\u003c/strong\u003e，便于观察 I/O 性能。\n如果 CPU 数量足够多，那每组测试都可能会打满设备带宽，结果对 I/O 压测就没意义了。\u003c/p\u003e\n\n\u003cp align=\"center\"\u003e表 1. Direct I/O（绕过系统页缓存）：1KB 随机读，CPU 100% 下的 I/O 性能\u003c/p\u003e\n\n\u003ctable width=\"100%\"\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003e\u003cstrong\u003ebackend\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003eIOPS\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003econtext switches\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003eIOPS ±% vs io_uring\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003esync\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e814,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e27,625,004\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-42.6%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003eposix-aio (thread pool)\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e433,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e64,112,335\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-69.4%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003elinux-aio\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e1,322,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e10,114,149\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-6.7%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003eio_uring (basic)\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e1,417,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e11,309,574\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003e—\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align: center;\"\u003eio_uring (enhanced)\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e1,486,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e11,483,468\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #008000;\"\u003e\u003cstrong\u003e4.9%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/intro-to-io-uring/benchmark-1.png\" width=\"65%\" height=\"65%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e几点分析：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 相比 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 确实有一定提升，但并非革命性的。\u003c/li\u003e\n  \u003cli\u003e开启高级特性，例如 buffer \u0026amp; file registration 之后性能有进一步提升 —— 但也还\n没有到为了这些性能而重写整个应用的地步，除非你是搞数据库研发，想榨取硬件的最后一分性能。\u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e and \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e \u003cstrong\u003e\u003cmark\u003e都比同步 read 接口快 2 倍，而后者又比 posix-aio 快 2 倍\u003c/mark\u003e\u003c/strong\u003e ——\n初看有点差异。但看看\u003cstrong\u003e\u003cmark\u003e上下文切换次数\u003c/mark\u003e\u003c/strong\u003e，就不难理解为什么 posix-aio 这么慢了。\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e同步 read 性能差是因为：在这种没有 page cache 的情况下，\n\u003cstrong\u003e\u003cmark\u003e每次 read 系统调用都会阻塞，因此就会涉及一次上下文切换\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n      \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eposix-aio\u003c/code\u003e 性能更差是因为：不仅内核和应用程序之间要频繁上下文切换，线程池的\u003cstrong\u003e\u003cmark\u003e多个线程之间也在频繁切换\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"42-场景二buffered-io-1kb-随机读数据提前加载到内存100-hot-cache\"\u003e4.2 场景二：buffered I/O \u003ccode class=\"language-plaintext highlighter-rouge\"\u003e1KB\u003c/code\u003e 随机读（数据提前加载到内存，100% hot cache）\u003c/h2\u003e\n\n\u003cp\u003e第二组测试 buffered I/O：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e将文件数据提前加载到内存，然后再测随机读。\u003c/p\u003e\n\n    \u003cul\u003e\n      \u003cli\u003e由于\u003cstrong\u003e\u003cmark\u003e数据全部在 page cache\u003c/mark\u003e\u003c/strong\u003e，因此\u003cstrong\u003e\u003cmark\u003e同步 read 永远不会阻塞\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n      \u003cli\u003e这种场景下，我们预期\u003cstrong\u003e\u003cmark\u003e同步读和 io_uring 的性能差距不大（都是最好的）\u003c/mark\u003e\u003c/strong\u003e。\u003c/li\u003e\n    \u003c/ul\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e其他测试条件不变。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp align=\"center\"\u003e表 2. Buffered I/O（数据全部来自 page cache，\u003cmark\u003e100% hot cache\u003c/mark\u003e）：1KB 随机读，100% CPU 下的 I/O 性能\u003c/p\u003e\n\n\u003ctable width=\"100%\"\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003cstrong\u003eBackend\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003eIOPS\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003econtext switches\u003c/strong\u003e\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003eIOPS ±% vs io_uring\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003esync\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e4,906,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e 105,797\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-2.3%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eposix-aio (thread pool)\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e1,070,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e114,791,187\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-78.7%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003elinux-aio\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e4,127,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e105,052\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cspan style=\"color: #ff0000;\"\u003e\u003cstrong\u003e-17.9%\u003c/strong\u003e\u003c/span\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eio_uring\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e5,024,000\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e106,683\u003c/td\u003e\n\u003ctd style=\"text-align: right;\"\u003e\u003cstrong\u003e—\u003c/strong\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp align=\"center\"\u003e\u003cimg src=\"/assets/img/intro-to-io-uring/benchmark-2.png\" width=\"65%\" height=\"65%\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e结果分析：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e\n    \u003cp\u003e同步读和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 性能差距确实很小，二者都是最好的。\u003c/p\u003e\n\n    \u003cp\u003e但注意，\u003cstrong\u003e\u003cmark\u003e实际的应用\u003c/mark\u003e\u003c/strong\u003e不可能一直 100% 时间执行 IO 操作，因此\n基于同步读的真实应用性能\u003cstrong\u003e\u003cmark\u003e还是要比基于 io_uring 要差的\u003c/mark\u003e\u003c/strong\u003e，因为 io_uring 会将多个系统调用批处理化。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eposix-aio\u003c/code\u003e 性能最差，直接原因是\u003cstrong\u003e\u003cmark\u003e上下文切换次数太多\u003c/mark\u003e\u003c/strong\u003e，这也和场景相关：\n在这种 \u003cstrong\u003e\u003cmark\u003eCPU 饱和的情况下\u003c/mark\u003e\u003c/strong\u003e，它的线程池反而是累赘，会完全拖慢性能。\u003c/p\u003e\n  \u003c/li\u003e\n  \u003cli\u003e\n    \u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 并\u003cstrong\u003e\u003cmark\u003e不是针对 buffered I/O 设计的\u003c/mark\u003e\u003c/strong\u003e，在这种 page cache 直接返回的场景，\n它的\u003cstrong\u003e\u003cmark\u003e异步接口反而会造成性能损失\u003c/mark\u003e\u003c/strong\u003e —— 将操作分\n为 dispatch 和 consume 两步不但没有性能收益，反而有额外开销。\u003c/p\u003e\n  \u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch2 id=\"43-性能测试小结\"\u003e4.3 性能测试小结\u003c/h2\u003e\n\n\u003cp\u003e最后再次提醒，本节是极端应用/场景（\u003cstrong\u003e\u003cmark\u003e100% CPU + 100% cache miss/hit\u003c/mark\u003e\u003c/strong\u003e）测试，\n真实应用的行为通常处于同步读和异步读之间：时而一些阻塞操作，时而一些非阻塞操作。\n但不管怎么说，用了 io_uring 之后，用户就无需担心同步和异步各占多少比例了，因为它\u003cstrong\u003e\u003cmark\u003e在任何场景下都表现良好\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e如果操作是非阻塞的，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 不会有额外开销；\u003c/li\u003e\n  \u003cli\u003e如果操作是阻塞式的，也没关系，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 是完全异步的，并且不依赖线程池或昂贵的上下文切换来实现这种异步能力；\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e本文测试的都是随机读，但对\u003cstrong\u003e\u003cmark\u003e其他类型的操作\u003c/mark\u003e\u003c/strong\u003e，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 表现也是非常良好的。例如：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003e打开/关闭文件\u003c/li\u003e\n  \u003cli\u003e设置定时器\u003c/li\u003e\n  \u003cli\u003e通过 network sockets 传输数据\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003e而且\u003cstrong\u003e\u003cmark\u003e使用的是同一套 io_uring 接口\u003c/mark\u003e\u003c/strong\u003e。\u003c/p\u003e\n\n\u003ch2 id=\"44-scylladb-与-io_uring\"\u003e4.4 ScyllaDB 与 io_uring\u003c/h2\u003e\n\n\u003cp\u003eScylla 重度依赖 direct I/O，从一开始就使用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e。\n在我们转向 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 的过程中，最开始测试显示对某些 workloads，能取得 50% 以上的性能提升。\n但\u003cstrong\u003e\u003cmark\u003e深入研究之后发现\u003c/mark\u003e\u003c/strong\u003e，这是因为我们\u003cstrong\u003e\u003cmark\u003e之前的 linux-aio 用的不够好\u003c/mark\u003e\u003c/strong\u003e。\n这也揭示了一个\u003cstrong\u003e\u003cmark\u003e经常被忽视的事实\u003c/mark\u003e\u003c/strong\u003e：获得高性能没有那么难（前提是你得弄对了）。\n在对比 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 和 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 应用之后，我们\u003cstrong\u003e\u003cmark\u003e很快改进了一版，二者的性能差距就消失了\u003c/mark\u003e\u003c/strong\u003e。\n但坦率地说，解决这个问题\u003cstrong\u003e\u003cmark\u003e需要一些工作量\u003c/mark\u003e\u003c/strong\u003e，因为要改动一个已经使用\n了很多年的基于 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 的接口。而对 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 应用来说，做类似的改动是轻而\n易举的。\u003c/p\u003e\n\n\u003cp\u003e以上只是一个场景，\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 相比 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003elinux-aio\u003c/code\u003e 的\u003cstrong\u003e\u003cmark\u003e优势\u003c/mark\u003e\u003c/strong\u003e是能应用于 file I/O 之外的场景。\n此外，它还自带了特殊的 \u003ca href=\"https://www.p99conf.io/\"\u003e高性能\u003c/a\u003e 接口，例如\nbuffer registration、file registration、轮询模式等等。\u003c/p\u003e\n\n\u003cp\u003e启用 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 高级特性之后，我们看到性能确实有提升：Intel Optane 设备，单个\nCPU  读取 512 字节，观察到 5% 的性能提升。与 表 1 \u0026amp; 2 对得上。虽然 5% 的提升\n看上去不是太大，但对于希望压榨出硬件所有性能的数据库来说，还是非常宝贵的。\u003c/p\u003e\n\n\u003ctable width=\"100%\"\u003e\n \u003ctbody\u003e\n   \u003ctr\u003e\n   \u003ctd style=\"vertical-align: top; width: 50%;\"\u003e\n   \u003cmark\u003elinux-aio:\u003c/mark\u003e\n     \u003cp\u003e\n     Throughput         :      330 MB/s\u003cbr/\u003e\n     Lat average        :     1549 usec\u003cbr/\u003e\n     Lat quantile=  0.5 :     1547 usec\u003cbr/\u003e\n     Lat quantile= 0.95 :     1694 usec\u003cbr/\u003e\n     Lat quantile= 0.99 :     1703 usec\u003cbr/\u003e\n     Lat quantile=0.999 :     1950 usec\u003cbr/\u003e\n     Lat max            :     2177 usec\n     \u003c/p\u003e\n   \u003c/td\u003e\n   \u003ctd style=\"vertical-align: top; width: 50%;\"\u003e\n\n   \u003cmark\u003eio_uring, with buffer and file registration and poll:\u003c/mark\u003e\n   \n     \u003cp\u003e\n     Throughput         :      346 MB/s\u003cbr/\u003e\n     Lat average        :     1470 usec\u003cbr/\u003e\n     Lat quantile= 0.5  :     1468 usec\u003cbr/\u003e\n     Lat quantile= 0.95 :     1558 usec\u003cbr/\u003e\n     Lat quantile= 0.99 :     1613 usec\u003cbr/\u003e\n     Lat quantile=0.999 :     1674 usec\u003cbr/\u003e\n     Lat max            :     1829 usec\n     \u003c/p\u003e\n   \u003c/td\u003e\n   \u003c/tr\u003e\n   \u003ctr\u003e\n   \u003ctd colspan=\"2\"\u003e使用 1 个 CPU 从 Intel Optane 设备读取 512 字节。1000 并发请求。linux-aio 和 io_uring basic interface 性能差异很小。\n   但启用 io_uring 高级特性后，有 5% 的性能差距。\u003c/td\u003e\n   \u003c/tr\u003e\n \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003ch1 id=\"5-ebpf\"\u003e5 eBPF\u003c/h1\u003e\n\n\u003cp\u003eeBPF 也是一个\u003cstrong\u003e\u003cmark\u003e事件驱动框架\u003c/mark\u003e\u003c/strong\u003e（因此也是异步的），允许用户空间程序动态向内核注入字节码，主要有两个使用场景：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eNetworking：\u003ca href=\"https://arthurchiao.art\"\u003e本站\u003c/a\u003e 已经有相当多的文章\u003c/li\u003e\n  \u003cli\u003eTracing \u0026amp; Observability：例如 \u003ca href=\"https://github.com/iovisor/bcc\"\u003ebcc\u003c/a\u003e 等工具\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003cp\u003eeBPF 在内核  4.9 首次引入，4.19 以后功能已经很强大。更多关于 eBPF 的演进信息，可参考：\n\u003ca href=\"/blog/ebpf-and-k8s-zh/\"\u003e\u003cmark\u003e（译）大规模微服务利器：eBPF + Kubernetes（KubeCon, 2020）\u003c/mark\u003e\u003c/a\u003e。\u003c/p\u003e\n\n\u003cp\u003e谈到与 io_uring 的结合，就是用 bcc 之类的工具跟踪一些 I/O 相关的内核函数，例如：\u003c/p\u003e\n\n\u003col\u003e\n  \u003cli\u003eTrace how much time an application spends sleeping, and what led to those sleeps. (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ewakeuptime\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eFind all programs in the system that reached a particular place in the code (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etrace\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eAnalyze network TCP throughput aggregated by subnet (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003etcpsubnet\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eMeasure how much time the kernel spent processing softirqs (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003esoftirqs\u003c/code\u003e)\u003c/li\u003e\n  \u003cli\u003eCapture information about all short-lived files, where they come from, and for how long they were opened (\u003ccode class=\"language-plaintext highlighter-rouge\"\u003efilelife\u003c/code\u003e)\u003c/li\u003e\n\u003c/ol\u003e\n\n\u003ch1 id=\"6-结束语\"\u003e6 结束语\u003c/h1\u003e\n\n\u003cp\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eio_uring\u003c/code\u003e 和 eBPF 这两大特性\u003cstrong\u003e\u003cmark\u003e将给 Linux 编程带来革命性的变化\u003c/mark\u003e\u003c/strong\u003e。\n有了这两个特性的加持，开发者就能更充分地利用 \u003ca href=\"https://www.scylladb.com/2019/05/28/aws-new-i3en-meganode\"\u003eAmazon i3en meganode systems\u003c/a\u003e\n之类的多核/多处理器系统，以及 \u003ca href=\"https://www.scylladb.com/2017/09/27/intel-optane-scylla-providing-speed-memory-database-persistency\"\u003eIntel Optane 持久存储\u003c/a\u003e\n之类的 \u003ccode class=\"language-plaintext highlighter-rouge\"\u003eus\u003c/code\u003e 级延迟存储设备。\u003c/p\u003e\n\n\u003ch1 id=\"参考资料\"\u003e参考资料\u003c/h1\u003e\n\n\u003cul\u003e\n  \u003cli\u003e\u003ca href=\"https://kernel.dk/io_uring.pdf\"\u003eEfficient IO with io_uring\u003c/a\u003e, pdf\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://lwn.net/Articles/776703/\"\u003eRinging in a new asynchronous I/O API\u003c/a\u003e, lwn.net\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://lwn.net/Articles/810414/\"\u003eThe rapid growth of io_uring\u003c/a\u003e, lwn.net\u003c/li\u003e\n  \u003cli\u003e\u003ca href=\"https://github.com/axboe/liburing/tree/master/man\"\u003eSystem call API\u003c/a\u003e, manpage\u003c/li\u003e\n\u003c/ul\u003e\n\n\n  \u003c!-- POST NAVIGATION --\u003e\n  \u003cdiv class=\"postNav clearfix\"\u003e\n     \n      \u003ca class=\"prev\" href=\"/blog/linux-socket-filtering-aka-bpf-zh/\"\u003e\u003cspan\u003e« [译] Linux Socket Filtering (LSF, aka BPF)（KernelDoc，2021）\u003c/span\u003e\n      \n    \u003c/a\u003e\n      \n      \n      \u003ca class=\"next\" href=\"/blog/cgroupv2-zh/\"\u003e\u003cspan\u003e[译] Control Group v2（cgroupv2 权威指南）（KernelDoc, 2021） »\u003c/span\u003e\n       \n      \u003c/a\u003e\n     \n  \u003c/div\u003e\n\u003c/div\u003e",
  "Date": "2021-09-01T00:00:00Z",
  "Author": "Arthur Chiao"
}