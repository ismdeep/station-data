{
  "Source": "blog.zzbd.org",
  "Title": "盘古之白 - 如何更优雅地写 wiki",
  "Link": "https://blog.zzbd.org/2021/10/26/wiki-pangu/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003cscript type=\"text/javascript\" src=\"/attach/sm.js\"\u003e\u003c/script\u003e\u003clink rel=\"stylesheet\" type=\"text/css\" href=\"/attach/sm.css\"/\u003e\u003cblockquote class=\"blockquote-center\"\u003e\u003cform class=\"sm-banner\"\u003e\u003cdiv\u003e\u003ctextarea id=\"typearea\" class=\"text\"\u003e\u003c/textarea\u003e\u003cbr/\u003e \u003cimg data-src=\"/attach/tri.png\" alt=\"off\" id=\"img\"/\u003e\u003c/div\u003e\u003c/form\u003e\u003c/blockquote\u003e\u003cscript type=\"text/javascript\"\u003etype_text(new Array(\"\",\"\",\"\",\"中英文混排时 Space 很重要\",\"不只是因为美观\",\"还因为\",\"对搜索引擎友好\",\"\",\"怎么做\",\"插件可以帮忙\",\"但更重要的是\",\"习惯\",\"\",\"倡导盘古之白\",\"让打字更愉悦\",\"=^_^=\"))\u003c/script\u003e\u003cspan id=\"more\"\u003e\u003c/span\u003e 用了一段时间 mediawiki，对自带的搜索还是不太满意，主要表现为：\u003col\u003e\u003cli\u003e全文搜索的中文是按照单字分词，结果比较杂乱，同页面有多个匹配时预览显示不全就算了，有些页面一个都不显示。至今还没摸出规律\u003c/li\u003e\u003cli\u003eCargo 的 drill 页的标题快速过滤对中文支持太差，英文也仅支持“单词样式”的（也即单词在标题头尾或者前后有空格）。这也是写这篇心得的主要原因\u003c/li\u003e\u003cli\u003e英文的全文搜索结果只有在“单词样式”下才比较直观\u003c/li\u003e\u003cli\u003e等了很久的elastic升级也没有什么进展\u003c/li\u003e\u003c/ol\u003e\u003cp\u003e所以改造之路就此开始，既然只能依赖简单粗暴的数据库搜索，规范化写作就是唯一一条路，其中最重要的要算 \u003cstrong\u003e中英文混排用空格隔开\u003c/strong\u003e 这一条。然后就发现了宝藏工具 \u003ccode\u003ePangu.js\u003c/code\u003e。安装打包好的浏览器插件测试，功能比较简单，就一个按键，然后可以选择是否加载网页时自动排版。这个JS库针对的是纯文本或者html，不支持markdown以及其它标记型语言。最郁闷的是，VisualEditor 下基本不起作用。\u003c/p\u003e\u003cp\u003e然后就找到了一个用了 \u003ccode\u003ePanju.js\u003c/code\u003e 的 wiki 站，移植过来，感觉有戏。最初的设想是通过组合快捷键触发 JS 读取选中文本，格式化好之后写入剪切板，前端显示通知然后手动粘贴。想法很美好，然而就在快完工时突然意识到一个严重漏洞：这个只针对纯文本的内容好使，碰到带格式的这么一转换肯定撸的干干净净。就此开启挖坑之旅。\u003c/p\u003e\u003cp\u003e首先想到的是选中文本读取为 html 格式，转换后再以 html 粘贴。碰到的第一个问题就是： \u003ccode\u003ePangu.js\u003c/code\u003e 在 VisualEditor 下根本不起作用，而浏览器插件是可以的。研究源码发现问题出在 \u003ccode\u003espacingPageBody\u003c/code\u003e 可用而 \u003ccode\u003espacingNode\u003c/code\u003e 不可用。于是开始了无聊的逐句对比debug，找到根源在于 Xpath ：\u003c/p\u003e\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekey: \u003cspan class=\"string\"\u003e\u0026#34;spacingNode\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  value: \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"title\"\u003espacingNode\u003c/span\u003e(\u003cspan class=\"params\"\u003econtextNode\u003c/span\u003e) \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e xPathQuery = \u003cspan class=\"string\"\u003e\u0026#39;.//*/text()[normalize-space(.)]\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e || contextNode.children \u0026amp;\u0026amp; contextNode.children.length === \u003cspan class=\"number\"\u003e0\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// always TRUE!\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      xPathQuery = \u003cspan class=\"string\"\u003e\u0026#39;.//text()[normalize-space(.)]\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e虽然不知道 \u003ccode\u003e.//*/\u003c/code\u003e 意义是什么，至少可以读取到 Node 中的内容了。然而这还不够，作者在核心代码里屏蔽掉了 textarea 和带 contentEditable 属性的内容（debug到吐）。所以：\u003c/p\u003e\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekey: \u003cspan class=\"string\"\u003e\u0026#34;isContentEditable\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  value: \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"title\"\u003eisContentEditable\u003c/span\u003e(\u003cspan class=\"params\"\u003enode\u003c/span\u003e) \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e \u0026amp;\u0026amp; node.isContentEditable || node.getAttribute \u0026amp;\u0026amp; node.getAttribute(\u003cspan class=\"string\"\u003e\u0026#39;g_editable\u0026#39;\u003c/span\u003e) === \u003cspan class=\"string\"\u003e\u0026#39;true\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// always FALSE!\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e接下来就是获取选中 Node，然而又遇到另外一个问题，如果选取在段落边界，相邻的 element 可能会乱入。还有一个问题是如何保留格式再粘贴回来。所以暂时放弃这个办法，依赖 \u003ccode\u003ePangu.js\u003c/code\u003e 自带的DOM操作逻辑直接修改原位格式化。之后就碰到了最郁闷的事：每次格式化段落之前要把光标点击到这个段落，否则再点回来就会自动还原。注意是点击，键盘移动或者 JS 模拟点击都不行。追踪还原事件发现这个写在 VE 的核心代码里，这样的话就不能全文批量格式化了。找了很多可能的解决办法，最后的决定是：妥协。回归最原始的方式：点击快捷键时通过 \u003ccode\u003egetSelection\u003c/code\u003e 函数获取光标或者选区所在的段落，执行格式化。主要代码如下：\u003c/p\u003e\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edocument\u003c/span\u003e.addEventListener(\u003cspan class=\"string\"\u003e\u0026#39;keydown\u0026#39;\u003c/span\u003e,\u003cspan class=\"function\"\u003e(\u003cspan class=\"params\"\u003ee\u003c/span\u003e)=\u0026gt;\u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e(e.ctrlKey\u0026amp;\u0026amp;e.shiftKey\u0026amp;\u0026amp;e.altKey){\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t\u003cspan class=\"keyword\"\u003etry\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e sel = \u003cspan class=\"built_in\"\u003ewindow\u003c/span\u003e.getSelection();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e pos = sel.getRangeAt(\u003cspan class=\"number\"\u003e0\u003c/span\u003e).commonAncestorContainer;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (pos.nodeType == \u003cspan class=\"number\"\u003e3\u003c/span\u003e) pos = pos.parentNode;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  pos = pos.closest(\u003cspan class=\"string\"\u003e\u0026#39;p\u0026#39;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  pangu.spacingNode(pos);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e range = \u003cspan class=\"built_in\"\u003edocument\u003c/span\u003e.createRange();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      range.selectNodeContents(pos);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      sel.removeAllRanges();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      sel.addRange(range);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t} \u003cspan class=\"keyword\"\u003ecatch\u003c/span\u003e (e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  mw.notify($( \u003cspan class=\"string\"\u003e\u0026#39;\u0026lt;span\u0026gt;\u0026lt;b\u0026gt;Fail\u0026lt;/b\u0026gt; to format current section\u0026lt;/span\u0026gt;\u0026#39;\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \t}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    mw.notify($( \u003cspan class=\"string\"\u003e\u0026#39;\u0026lt;span\u0026gt;Success to format current section\u0026lt;/span\u0026gt;\u0026#39;\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e另外，VE 有个插件系统，这个需求通过这个 Gadget 实现应该会更好些。然鹅研究了半天就逐渐失去耐心，主要原因还是找不到方法直接操作文本或者 DOM，只能做些简单的文本替换。这个先这样凑活着用，有时间再去折腾。\u003c/p\u003e\u003ch4 id=\"参考\"\u003e\u003ca href=\"#参考\" class=\"headerlink\" title=\"参考\"\u003e\u003c/a\u003e参考\u003c/h4\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://gerrit.wikimedia.org/r/q/elastic\"\u003eelastic · Gerrit Code Review (wikimedia.org)\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.imfing.com/2020/05/chinese-typesetting-space/#\"\u003e中英文混排的“Social Distancing” - Fing’s Blog\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/vinta/pangu.js\"\u003evinta/pangu.js: Paranoid text spacing in JavaScript (github.com)\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://dev.fandom.com/wiki/MediaWiki:Pangu.js?action=edit\"\u003eView source for MediaWiki:Pangu.js | Fandom Developers Wiki\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.mediawiki.org/wiki/Adding_JavaScript_to_Wiki_Pages\"\u003eAdding JavaScript to Wiki Pages - MediaWiki\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.mediawiki.org/wiki/Bubble_notifications\"\u003eBubble notifications - MediaWiki\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/ArthurPatten/p/3317263.html\"\u003ejavascript获取选中的文本/html - ArthurPatten - 博客园 (cnblogs.com)\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://stackoverflow.com/questions/7781963/js-get-array-of-all-selected-nodes-in-contenteditable-div/7784176#7784176\"\u003ejavascript - JS: Get array of all selected nodes in contentEditable div - Stack Overflow\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://stackoverflow.com/questions/5643635/how-to-get-selected-html-text-with-javascript\"\u003egetselection - How to get selected html text with javascript? - Stack Overflow\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://doc.wikimedia.org/VisualEditor/master/js/#!/api/ve\"\u003eVisualEditor - Documentation\u003c/a\u003e\u003c/p\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.mediawiki.org/wiki/VisualEditor/Gadgets\"\u003eVisualEditor/Gadgets - MediaWiki\u003c/a\u003e\u003c/p\u003e\u003c/div\u003e",
  "Date": "2021-10-26T09:10:31Z",
  "Author": "J. F"
}