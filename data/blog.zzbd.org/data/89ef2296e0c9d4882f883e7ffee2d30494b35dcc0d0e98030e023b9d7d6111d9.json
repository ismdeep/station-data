{
  "Source": "blog.zzbd.org",
  "Title": "reverse group concat in sqlite",
  "Link": "https://blog.zzbd.org/2015/04/16/reverse-group-concat-in-sqlite/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003ch4 id=\"初（扯）衷（淡）\"\u003e\u003ca href=\"#初（扯）衷（淡）\" class=\"headerlink\" title=\"初（扯）衷（淡）\"\u003e\u003c/a\u003e初（扯）衷（淡）\u003c/h4\u003e\u003cp\u003e最近在研究关于文档整理的相关知识，基本需求就是随时随地记录和查看文档。恩，这个博客也是其中一部分。印象笔记已经很接近这一点了，参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.zhihu.com/people/houjoe\"\u003e移动城堡\u003c/a\u003e的这篇\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.zhihu.com/question/20418504/answer/15083561\"\u003e攻略\u003c/a\u003e（心理活动：这货看上去闷闷的，没想到这么能折腾），可惜移动端\u003cstrong\u003e不能离线，太费流量\u003c/strong\u003e，弃之。然后发现了这个\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/federicoiosue/Omni-Notes\"\u003eOmni-Notes\u003c/a\u003e，俗话说，\u003c/p\u003e\u003cblockquote\u003e\u003cp\u003e开源的就是好的\u003c/p\u003e\u003c/blockquote\u003e\u003cspan id=\"more\"\u003e\u003c/span\u003e\u003cp\u003e果断拿来用，可惜一堆Bug，不过也可以理解，老外用的好好的到我们手里就瘫掉多半是天朝特色。不出所料，这货用的是一个sqlite文件做数据存储，只不过附件是用路径引用的方式，这样的话备份就只涉及到这二者了。\u003c/p\u003e\u003ch4 id=\"正题\"\u003e\u003ca href=\"#正题\" class=\"headerlink\" title=\"正题\"\u003e\u003c/a\u003e正题\u003c/h4\u003e\u003cp\u003e我的第一个想法是把\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://plant.hzau.edu.cn/\"\u003ehttp://plant.hzau.edu.cn\u003c/a\u003e上的学校植物数据弄到omni-note上，爬取数据，当然首选scrapy。过程略去。最终得到两张表，**\u003ccode\u003ePLANT_DATA\u003c/code\u003e\u003cstrong\u003e是图片的\u003ccode\u003eblob\u003c/code\u003e和对应的\u003ccode\u003efile name\u003c/code\u003e，\u003c/strong\u003e\u003ccode\u003eIMAGES\u003c/code\u003e**是每个植物的详细信息以及对应网页的\u003ccode\u003eshort url\u003c/code\u003e，其中附件名一栏是逗号分隔的\u003ccode\u003efile name\u003c/code\u003e。现在的任务是:\u003cbr/\u003e\u003cem\u003e\u003cstrong\u003e如何把\u003ccode\u003efile name\u003c/code\u003e对应到\u003ccode\u003eshort url\u003c/code\u003e\u003c/strong\u003e\u003c/em\u003e\u003cbr/\u003e换句话说就是\u003cbr/\u003e\u003cem\u003e\u003cstrong\u003e把逗号分隔的\u003ccode\u003efile name\u003c/code\u003e拆开\u003c/strong\u003e\u003c/em\u003e\u003cbr/\u003e用脚本当然很容易实现，但我就是要用sql来搞（对这种全大写的语言中毒极深）。下面开搞\u003c/p\u003e\u003chr/\u003e\u003ch5 id=\"第一种方法：逐步填充\"\u003e\u003ca href=\"#第一种方法：逐步填充\" class=\"headerlink\" title=\"第一种方法：逐步填充\"\u003e\u003c/a\u003e第一种方法：逐步填充\u003c/h5\u003e\u003cp\u003e目前可用的大概就\u003ccode\u003elike\u003c/code\u003e和\u003ccode\u003einstr\u003c/code\u003e函数，但\u003ccode\u003einstr\u003c/code\u003e有个问题就是没法区分\u003cstrong\u003e部分匹配\u003c/strong\u003e。所以就\u003ccode\u003elike\u003c/code\u003e啦\u003c/p\u003e\u003cp\u003e首先，匹配**\u003ccode\u003e,xxx.jpg,\u003c/code\u003e**这种形式并填充\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eUPDATE\u003c/span\u003e IMAGES \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLI = (\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e PLANT_DATA.M \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;%,\u0026#34;\u003c/span\u003e || IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e || \u003cspan class=\"string\"\u003e\u0026#34;,%\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eEXISTS\u003c/span\u003e(\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e * \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;%,\u0026#34;\u003c/span\u003e || IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e || \u003cspan class=\"string\"\u003e\u0026#34;,%\u0026#34;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e然后，填充**\u003ccode\u003exxx.jpg,\u003c/code\u003e**\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eUPDATE\u003c/span\u003e IMAGES \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLI = (\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e PLANT_DATA.M \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e || \u003cspan class=\"string\"\u003e\u0026#34;,%\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eEXISTS\u003c/span\u003e(\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e * \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e (LI \u003cspan class=\"keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"literal\"\u003eNULL\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eAND\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e || \u003cspan class=\"string\"\u003e\u0026#34;,%\u0026#34;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e然后，**\u003ccode\u003e,xxx.jpg\u003c/code\u003e**\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eUPDATE\u003c/span\u003e IMAGES \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLI = (\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e PLANT_DATA.M \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;%,\u0026#34;\u003c/span\u003e || IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eEXISTS\u003c/span\u003e(\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e * \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e (LI \u003cspan class=\"keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"literal\"\u003eNULL\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eAND\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eLIKE\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;%,\u0026#34;\u003c/span\u003e || IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e最后，匹配没有逗号的（唯一）\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eUPDATE\u003c/span\u003e IMAGES \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLI = (\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e PLANT_DATA.M \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e=IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eEXISTS\u003c/span\u003e(\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e * \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e (LI \u003cspan class=\"keyword\"\u003eIS\u003c/span\u003e \u003cspan class=\"literal\"\u003eNULL\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eAND\u003c/span\u003e PLANT_DATA.\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e=IMAGES.\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003chr/\u003e\u003ch5 id=\"第二种方法：先替换再匹配\"\u003e\u003ca href=\"#第二种方法：先替换再匹配\" class=\"headerlink\" title=\"第二种方法：先替换再匹配\"\u003e\u003c/a\u003e第二种方法：先替换再匹配\u003c/h5\u003e\u003cp\u003e在每个字符串前后加上逗号，这样就不用逐步匹配啦\u003cbr/\u003e先\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eUPDATE\u003c/span\u003e PLANT_DATA \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eE\u003c/span\u003e = \u003cspan class=\"string\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e || \u003cspan class=\"built_in\"\u003eE\u003c/span\u003e || \u003cspan class=\"string\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u0026lt;\u0026gt; \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003cp\u003e然后用上面的第一个就好，不用担心部分匹配的问题。\u003c/p\u003e\u003chr/\u003e\u003ch5 id=\"当然还有其他更好的办法就不啰嗦了\"\u003e\u003ca href=\"#当然还有其他更好的办法就不啰嗦了\" class=\"headerlink\" title=\"当然还有其他更好的办法就不啰嗦了\"\u003e\u003c/a\u003e当然还有其他更好的办法就不啰嗦了\u003c/h5\u003e\u003cp\u003e最后可以在**\u003ccode\u003eIMAGES\u003c/code\u003e**里用这个验证一下\u003c/p\u003e\u003cfigure class=\"highlight n1ql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e GROUP_CONCAT(\u003cspan class=\"keyword\"\u003ePATH\u003c/span\u003e), LI \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e IMAGES \u003cspan class=\"keyword\"\u003eGROUP\u003c/span\u003e \u003cspan class=\"keyword\"\u003eBY\u003c/span\u003e LI;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"built_in\"\u003eE\u003c/span\u003e, M \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e PLANT_DATA \u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e \u003cspan class=\"built_in\"\u003eE\u003c/span\u003e \u0026lt;\u0026gt;\u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003c/div\u003e",
  "Date": "2015-04-16T07:47:20Z",
  "Author": "J. F"
}