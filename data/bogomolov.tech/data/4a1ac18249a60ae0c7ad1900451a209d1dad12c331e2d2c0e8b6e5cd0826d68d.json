{
  "Source": "bogomolov.tech",
  "Title": "How to install and configure send only Postfix SMTP server on Ubuntu 18.04",
  "Link": "https://bogomolov.tech/postfix-self-hosted-smtp/",
  "Content": "\u003cdiv class=\"post-content\"\u003e\u003cp\u003eI was needed to send emails for my new project. I have explored SaaS services first. Free packages provided by them have a small amount of sending emails. So as long as I am a programmer, I decided to host my own sending email server.\u003c/p\u003e\u003cp\u003eAfter some research, I decided to stay with Postfix send-only configuration. Continue to read how to install and configure SMTP server to send emails and not send them to a spam folder.\u003c/p\u003e\u003ch3 id=\"Prerequisites\"\u003e\u003ca href=\"#Prerequisites\" class=\"headerlink\" title=\"Prerequisites\"\u003e\u003c/a\u003ePrerequisites\u003c/h3\u003e\u003cp\u003eI used a single-core VPS with Ubuntu 18.04 for just 2.5 USD per month. My main app uses a table in DB as an email queue, so I have two NodeJS apps: one to handle the queue and second to get delivery status and update it in the main app DB. Tell me if you want to see it. Here is only the Postfix part.\u003c/p\u003e\u003cp\u003eI also have a domain. Let it be \u003cstrong\u003eexample.com\u003c/strong\u003e here. Since it will be used for a website, I am using a subdomain \u003cstrong\u003eemail.example.com\u003c/strong\u003e for the email server.\u003c/p\u003e\u003ch3 id=\"Postfix-installation\"\u003e\u003ca href=\"#Postfix-installation\" class=\"headerlink\" title=\"Postfix installation\"\u003e\u003c/a\u003ePostfix installation\u003c/h3\u003e\u003cp\u003eInstall Postfix using commands below:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo apt-get update\nsudo apt install mailutils\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eDuring installation, select \u003cstrong\u003eInternet Site\u003c/strong\u003e option for type of mail configuration. As a \u003cstrong\u003eSystem mail name\u003c/strong\u003e enter your domain, e.g. example.com.\u003c/p\u003e\u003cp\u003eYou can see domain later with this command:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003ecat /etc/mailname\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Server-configuration\"\u003e\u003ca href=\"#Server-configuration\" class=\"headerlink\" title=\"Server configuration\"\u003e\u003c/a\u003eServer configuration\u003c/h3\u003e\u003cp\u003eOpen the main config file with an editor:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo nano /etc/postfix/main.cf\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eFind \u003cstrong\u003einet_interfaces\u003c/strong\u003e parameter and change it to \u003cstrong\u003eloopback-only\u003c/strong\u003e. With that parameter, Postfix will not listen for any connection from outside of VPS.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003einet_interfaces = loopback-only\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOther parameters and values to change for now:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003emydestination = $myhostname, localhost.$mydomain, localhost\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSet your mail domain as a server hostname:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo hostnamectl set-hostname email.example.com\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCheck the hostname with the command:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003ehostname --f\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eEdit \u003cstrong\u003e/etc/hosts\u003c/strong\u003e file and add that subdomain with your remote IP:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003e1.2.3.4    email.example.com email\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCommand to restart Postfix after configuration change:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo systemctl restart postfix\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCommand to check current configuration:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003epostconf -d\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Create-DKIM-signature\"\u003e\u003ca href=\"#Create-DKIM-signature\" class=\"headerlink\" title=\"Create DKIM signature\"\u003e\u003c/a\u003eCreate DKIM signature\u003c/h3\u003e\u003cp\u003eInstall DKIM tools:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo apt-get install opendkim opendkim-tools\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd the user to the group:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo gpasswd -a postfix opendkim\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOpen configuration file /etc/opendkim.conf:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo nano /etc/opendkim.conf\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen add or update parameters below in the configuration file:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003eSocket              inet:8892@localhost\nCanonicalization    simple\nMode                sv\nSubDomains          no\nAutoRestart         yes\nAutoRestartRate     10/1M\nBackground          yes\nDNSTimeout          5\nSignatureAlgorithm  rsa-sha256\nUserID              opendkim\nKeyTable            refile:/etc/opendkim/key.table\nSigningTable        refile:/etc/opendkim/signing.table\nExternalIgnoreList  /etc/opendkim/trusted.hosts\nInternalHosts       /etc/opendkim/trusted.hosts\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCreate a folder for DKIM keys:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo mkdir -p /etc/opendkim/keys\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eChange folder permissions:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo chown -R opendkim:opendkim /etc/opendkim\nsudo chmod go-rw /etc/opendkim/keys\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCreate opendkim signing table:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo nano /etc/opendkim/signing.table\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWith content inside:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003e*@example.com    default._domainkey.example.com\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen create key table:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo nano /etc/opendkim/key.table\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWith content inside:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003edefault._domainkey.example.com     example.com:default:/etc/opendkim/keys/example.com/default.private\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd trusted hosts:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo nano /etc/opendkim/trusted.hosts\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eWith content inside:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003e127.0.0.1\nlocalhost\n*.example.com\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCreate keys folder:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo mkdir /etc/opendkim/keys/example.com\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen generate keys:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo opendkim-genkey -b 2048 -d example.com -D /etc/opendkim/keys/example.com -s default -v\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eChange the private key file owner:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo chown opendkim:opendkim /etc/opendkim/keys/example.com/default.private\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen restart opendkim service:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo service opendkim restart\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCheck the key:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo opendkim-testkey -d example.com -s default -vvv\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow add or update parameters in the Postfix configuration file (/etc/postfix/main.cf):\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003emilter_default_action = accept\nmilter_protocol = 2\nsmtpd_milters = inet:localhost:8892\nnon_smtpd_milters = inet:localhost:8892\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen restart Postfix:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo systemctl restart postfix\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"DNS-configuration\"\u003e\u003ca href=\"#DNS-configuration\" class=\"headerlink\" title=\"DNS configuration\"\u003e\u003c/a\u003eDNS configuration\u003c/h3\u003e\u003cp\u003eYou need to configure some DNS records. With that configuration, email services will not treat your emails as spam.\u003c/p\u003e\u003cp\u003eAdd A record for the email.example.com:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003eType: A\nName: email.example.com\nValue: 1.2.3.4\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd SPF record:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003eType: TXT\nName: example.com\nValue: v=spf1 mx ~all\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd DMARC record:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003eType: TXT\nName: _dmarc\nValue: v=DMARC1; p=none\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd DKIM record. Use previously generated DKIM signature (/etc/opendkim/keys/example.com/default.txt):\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003eType: TXT\nName: default._domainkey\nValue: v=DKIM1; h=sha256; k=rsa; p=you-key-here-without-spaces\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSet PTR record (rDNS). You need to set it in your hosting providerâ€™s control panel.\u003c/p\u003e\u003cp\u003eSet email.example.com as a hostname and 4.3.2.1.in-addr.arpa as IP address. IP should be in reversed order.\u003c/p\u003e\u003cp\u003eCheck if it set correctly with the command below:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003ehost 1.2.3.4\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Email-encryption\"\u003e\u003ca href=\"#Email-encryption\" class=\"headerlink\" title=\"Email encryption\"\u003e\u003c/a\u003eEmail encryption\u003c/h3\u003e\u003cp\u003eInstall Certbot:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo apt install certbot\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen generate keys:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esudo certbot certonly --standalone -d email.example.com\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eConfigure Postfix to use that keys. Add or edit parameters below in /etc/postfix/main.cf:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs plain\"\u003esmtpd_tls_cert_file = /etc/letsencrypt/live/email.example.com/fullchain.pem\nsmtpd_tls_key_file = /etc/letsencrypt/live/email.example.com/privkey.pem\nsmtpd_tls_security_level=may\nsmtp_tls_CApath=/etc/letsencrypt/live/email.example.com\nsmtp_tls_security_level=may\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen restart Postfix:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo service postfix restart\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Test\"\u003e\u003ca href=\"#Test\" class=\"headerlink\" title=\"Test\"\u003e\u003c/a\u003eTest\u003c/h3\u003e\u003cp\u003eSend a test email with command:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#34;This is the body of the email\u0026#34;\u003c/span\u003e | mail -r \u003cspan class=\"hljs-built_in\"\u003etest\u003c/span\u003e@example.com -s \u003cspan class=\"hljs-string\"\u003e\u0026#34;This is the subject\u0026#34;\u003c/span\u003e \u003ca href=\"/cdn-cgi/l/email-protection\" class=\"__cf_email__\" data-cfemail=\"fb82948e89a49e969a9297bb9c969a9297d5989496\"\u003e[emailÂ protected]\u003c/a\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCheck spam score with online services, e.g.: \u003ca href=\"https://www.mail-tester.com/\" target=\"_blank\" rel=\"noopener\"\u003ehttps://www.mail-tester.com/\u003c/a\u003e (not an ad).\u003c/p\u003e\u003cbr/\u003e\u003cdiv class=\"related-posts\"\u003e\u003chr/\u003e\u003ch3\u003eRelated posts:\u003c/h3\u003e\u003cul class=\"popular-posts\"\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Facebook-Log-Id-Symfony/\" title=\"Implement Facebook login button with Symfony\" rel=\"bookmark\"\u003eImplement Facebook login button with Symfony\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Basics-of-sound/\" title=\"Beat detection in Java for Android\" rel=\"bookmark\"\u003eBeat detection in Java for Android\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Nodejs-production-systemd/\" title=\"How to manage Nodejs process using systemd\" rel=\"bookmark\"\u003eHow to manage Nodejs process using systemd\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Telegram-notification-on-SSH-login/\" title=\"Send message to Telegram on any SSH login\" rel=\"bookmark\"\u003eSend message to Telegram on any SSH login\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/What-is-Big-O-notation/\" title=\"What is Big-O notation\" rel=\"bookmark\"\u003eWhat is Big-O notation\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/div\u003e\u003cdiv id=\"comment-container\"\u003e\u003c/div\u003e\u003cdiv id=\"disqus_thread\"\u003e\u003c/div\u003e\u003c/div\u003e",
  "Date": "2020-09-15T00:00:00Z",
  "Author": "Konstantin Bogomolov"
}