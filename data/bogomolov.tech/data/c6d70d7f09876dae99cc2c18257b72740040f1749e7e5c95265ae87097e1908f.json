{
  "Source": "bogomolov.tech",
  "Title": "Send message to Telegram on any SSH login",
  "Link": "https://bogomolov.tech/Telegram-notification-on-SSH-login/",
  "Content": "\u003cdiv class=\"post-content\"\u003e\u003cp\u003eIn this article, you will walk through the creation of a simple Bash shell script to send messages to Telegram messenger using the Curl command. Then you will use this script to send a notification on every ssh login into your server.\u003c/p\u003e\u003cp\u003eCheck my Telegram \u003ca href=\"https://t.me/vpn_bogomolov_tech_bot\" target=\"_blank\" rel=\"noopener\"\u003eVPN bot\u003c/a\u003e if you need personal private VPN.\u003c/p\u003e\u003ch3 id=\"Create-telegram-bot\"\u003e\u003ca href=\"#Create-telegram-bot\" class=\"headerlink\" title=\"Create telegram bot\"\u003e\u003c/a\u003eCreate telegram bot\u003c/h3\u003e\u003cp\u003eTo send a message to Telegram group or channel, you should first create your own bot. Just open Telegram, find @BotFather and type \u003ccode\u003e/start\u003c/code\u003e. Then follow instructions to create bot and get token to access the HTTP API.\u003c/p\u003e\u003ch3 id=\"Create-Channel\"\u003e\u003ca href=\"#Create-Channel\" class=\"headerlink\" title=\"Create Channel\"\u003e\u003c/a\u003eCreate Channel\u003c/h3\u003e\u003cp\u003eCreate a new Channel in Telegram and \u003cstrong\u003eadd your bot as a member\u003c/strong\u003e. So your bot could send messages to the Channel.\u003c/p\u003e\u003cp\u003eIn order to get Channel Id, first, post any message to the Channel. Then use this link template to get Channel Id:\u003cbr/\u003e\u003ccode\u003ehttps://api.telegram.org/bot\u0026lt;YourBOTToken\u0026gt;/getUpdates\u003c/code\u003e\u003c/p\u003e\u003cp\u003eHere is a response example:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs json\"\u003e{\n  \u003cspan class=\"hljs-attr\"\u003e\u0026#34;ok\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e,\n  \u003cspan class=\"hljs-attr\"\u003e\u0026#34;result\u0026#34;\u003c/span\u003e: [\n    {\n      \u003cspan class=\"hljs-attr\"\u003e\u0026#34;update_id\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e123\u003c/span\u003e,\n      \u003cspan class=\"hljs-attr\"\u003e\u0026#34;channel_post\u0026#34;\u003c/span\u003e: {\n        \u003cspan class=\"hljs-attr\"\u003e\u0026#34;message_id\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e48\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003e\u0026#34;chat\u0026#34;\u003c/span\u003e: {\n          \u003cspan class=\"hljs-attr\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e-123123123\u003c/span\u003e, \u003cspan class=\"hljs-comment\"\u003e// this is your channel id\u003c/span\u003e\n          \u003cspan class=\"hljs-attr\"\u003e\u0026#34;title\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\u0026#34;Notifications\u0026#34;\u003c/span\u003e,\n          \u003cspan class=\"hljs-attr\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\u0026#34;channel\u0026#34;\u003c/span\u003e\n        },\n        \u003cspan class=\"hljs-attr\"\u003e\u0026#34;date\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-number\"\u003e1574485277\u003c/span\u003e,\n        \u003cspan class=\"hljs-attr\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e:\u003cspan class=\"hljs-string\"\u003e\u0026#34;test\u0026#34;\u003c/span\u003e\n      }\n    }\n  ]\n}\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Script-to-send-message\"\u003e\u003ca href=\"#Script-to-send-message\" class=\"headerlink\" title=\"Script to send message\"\u003e\u003c/a\u003eScript to send message\u003c/h3\u003e\u003cp\u003eIn order to send a message we could use simple command:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003ecurl \u003cspan class=\"hljs-string\"\u003e\u0026#39;https://api.telegram.org/bot\u0026lt;YourBOTToken\u0026gt;/sendMessage?chat_id=\u0026lt;channel_id\u0026gt;\u0026amp;text=\u0026lt;text\u0026gt;\u0026#39;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eBut in programming, it is good practice to hide the low-level implementation. So we will create a linux terminal command \u003ccode\u003etelegram-send\u003c/code\u003e and could send messages with this simple command.\u003c/p\u003e\u003cp\u003eLets create file \u003ccode\u003etelegram-send.sh\u003c/code\u003e\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003etouch telegram-send.sh\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen add script to this file. Set your group id and token in script.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/bash\n    \u003c/span\u003e\nGROUP_ID=\u0026lt;group_id\u0026gt;\nBOT_TOKEN=\u0026lt;bot_token\u0026gt;\n\n\u003cspan class=\"hljs-comment\"\u003e# this 3 checks (if) are not necessary but should be convenient\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\u0026#34;\u003c/span\u003e == \u003cspan class=\"hljs-string\"\u003e\u0026#34;-h\u0026#34;\u003c/span\u003e ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n  \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#34;Usage: `basename \u003cspan class=\"hljs-variable\"\u003e$0\u003c/span\u003e` \\\u0026#34;text message\\\u0026#34;\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 0\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ -z \u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\u0026#34;\u003c/span\u003e ]\n  \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#34;Add message text as second arguments\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 0\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e [ \u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$#\u003c/span\u003e\u0026#34;\u003c/span\u003e -ne 1 ]; \u003cspan class=\"hljs-keyword\"\u003ethen\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#34;You can pass only one argument. For string with spaces put it on quotes\u0026#34;\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003eexit\u003c/span\u003e 0\n\u003cspan class=\"hljs-keyword\"\u003efi\u003c/span\u003e\n\ncurl -s --data \u003cspan class=\"hljs-string\"\u003e\u0026#34;text=\u003cspan class=\"hljs-variable\"\u003e$1\u003c/span\u003e\u0026#34;\u003c/span\u003e --data \u003cspan class=\"hljs-string\"\u003e\u0026#34;chat_id=\u003cspan class=\"hljs-variable\"\u003e$GROUP_ID\u003c/span\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026#39;https://api.telegram.org/bot\u0026#39;\u003c/span\u003e\u003cspan class=\"hljs-variable\"\u003e$BOT_TOKEN\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026#39;/sendMessage\u0026#39;\u003c/span\u003e \u0026gt; /dev/null\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIt is not a good practice to store your token in that place, but for now, it is ok. Also, you could limit actions your bot could do in the Channel only to send messages.\u003c/p\u003e\u003cp\u003eTo run this script we should add permission\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003echmod +x telegram-send.sh\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow you can test it\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003e./telegram-send.sh \u003cspan class=\"hljs-string\"\u003e\u0026#34;Test message\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIn order to use this script from everywhere and type \u003ccode\u003etelegram-send\u003c/code\u003e instead \u003ccode\u003e./telegram-send.sh\u003c/code\u003e add it to /usr/bin/ folder\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo mv telegram-send.sh /usr/bin/telegram-send\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOwner of all files in /usr/bin is root user. So let’s do the same with our script:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo chown root:root /usr/bin/telegram-send\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow you can test it\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003etelegram-send \u003cspan class=\"hljs-string\"\u003e\u0026#34;Test message\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"Send-notification-on-SSH-login\"\u003e\u003ca href=\"#Send-notification-on-SSH-login\" class=\"headerlink\" title=\"Send notification on SSH login\"\u003e\u003c/a\u003eSend notification on SSH login\u003c/h3\u003e\u003cp\u003eAll files with .sh extension in /etc/profile.d/ folder will be executed whenever a bash login shell is entered or the desktop session loads.\u003c/p\u003e\u003cp\u003eLet’s add a new script to send the notification.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003etouch login-notify.sh\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eAdd this code to script\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003e\u003cspan class=\"hljs-meta\"\u003e#!/bin/bash\n    \u003c/span\u003e\n\u003cspan class=\"hljs-comment\"\u003e# prepare any message you want\u003c/span\u003e\nlogin_ip=\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$(echo $SSH_CONNECTION | cut -d \u0026#34; \u0026#34; -f 1)\u003c/span\u003e\u0026#34;\u003c/span\u003e\nlogin_date=\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$(date +\u0026#34;%e %b %Y, %a %r\u0026#34;)\u003c/span\u003e\u0026#34;\u003c/span\u003e\nlogin_name=\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$(whoami)\u003c/span\u003e\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e# For new line I use $\u0026#39;\\n\u0026#39; here\u003c/span\u003e\nmessage=\u003cspan class=\"hljs-string\"\u003e\u0026#34;New login to server\u0026#34;\u003c/span\u003e$\u003cspan class=\"hljs-string\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$login_name\u003c/span\u003e\u0026#34;\u003c/span\u003e$\u003cspan class=\"hljs-string\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$login_ip\u003c/span\u003e\u0026#34;\u003c/span\u003e$\u003cspan class=\"hljs-string\"\u003e\u0026#39;\\n\u0026#39;\u003c/span\u003e\u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$login_date\u003c/span\u003e\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e#send it to telegram\u003c/span\u003e\ntelegram-send \u003cspan class=\"hljs-string\"\u003e\u0026#34;\u003cspan class=\"hljs-variable\"\u003e$message\u003c/span\u003e\u0026#34;\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThen move this script to /etc/profile.d/ folder\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs bash\"\u003esudo mv login-notify.sh /etc/profile.d/login-notify.sh\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNow re-login to your web server and check it works.\u003c/p\u003e\u003cbr/\u003e\u003cdiv class=\"related-posts\"\u003e\u003chr/\u003e\u003ch3\u003eRelated posts:\u003c/h3\u003e\u003cul class=\"popular-posts\"\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Facebook-Log-Id-Symfony/\" title=\"Implement Facebook login button with Symfony\" rel=\"bookmark\"\u003eImplement Facebook login button with Symfony\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Basics-of-sound/\" title=\"Beat detection in Java for Android\" rel=\"bookmark\"\u003eBeat detection in Java for Android\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/Nodejs-production-systemd/\" title=\"How to manage Nodejs process using systemd\" rel=\"bookmark\"\u003eHow to manage Nodejs process using systemd\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/What-is-Big-O-notation/\" title=\"What is Big-O notation\" rel=\"bookmark\"\u003eWhat is Big-O notation\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003cli class=\"popular-posts-item\"\u003e\u003cdiv class=\"popular-posts-title\"\u003e\u003ch3\u003e\u003ca href=\"/android-sms-forwarding/\" title=\"SMS Forwarding - Android App Sends Texts to Webserver\" rel=\"bookmark\"\u003eSMS Forwarding - Android App Sends Texts to Webserver\u003c/a\u003e\u003c/h3\u003e\u003c/div\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/div\u003e\u003cdiv id=\"comment-container\"\u003e\u003c/div\u003e\u003cdiv id=\"disqus_thread\"\u003e\u003c/div\u003e\u003c/div\u003e",
  "Date": "2019-11-22T00:00:00Z",
  "Author": "Konstantin Bogomolov"
}