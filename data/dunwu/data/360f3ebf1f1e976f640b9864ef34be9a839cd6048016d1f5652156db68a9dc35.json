{
  "Source": "dunwu",
  "Title": "扩展 SQL",
  "Link": "https://dunwu.github.io/blog/pages/55e9a7/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003ch1 id=\"扩展-SQL\"\u003e\u003ca href=\"#扩展-SQL\" class=\"headerlink\" title=\"扩展 SQL\"\u003e\u003c/a\u003e扩展 SQL\u003c/h1\u003e\u003ch2 id=\"数据库\"\u003e\u003ca href=\"#数据库\" class=\"headerlink\" title=\"数据库\"\u003e\u003c/a\u003e数据库\u003c/h2\u003e\u003ch2 id=\"表\"\u003e\u003ca href=\"#表\" class=\"headerlink\" title=\"表\"\u003e\u003c/a\u003e表\u003c/h2\u003e\u003ch3 id=\"查看表的基本信息\"\u003e\u003ca href=\"#查看表的基本信息\" class=\"headerlink\" title=\"查看表的基本信息\"\u003e\u003c/a\u003e查看表的基本信息\u003c/h3\u003e\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"operator\"\u003e*\u003c/span\u003e \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e information_schema.tables\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e table_schema \u003cspan class=\"operator\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;test\u0026#39;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eAND\u003c/span\u003e table_name \u003cspan class=\"operator\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;user\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"查看表的列信息\"\u003e\u003ca href=\"#查看表的列信息\" class=\"headerlink\" title=\"查看表的列信息\"\u003e\u003c/a\u003e查看表的列信息\u003c/h3\u003e\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"operator\"\u003e*\u003c/span\u003e \u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e information_schema.columns\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eWHERE\u003c/span\u003e table_schema \u003cspan class=\"operator\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;test\u0026#39;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eAND\u003c/span\u003e table_name \u003cspan class=\"operator\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;user\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"如何批量删除大量数据\"\u003e\u003ca href=\"#如何批量删除大量数据\" class=\"headerlink\" title=\"如何批量删除大量数据\"\u003e\u003c/a\u003e如何批量删除大量数据\u003c/h3\u003e\u003cp\u003e如果要根据时间范围批量删除大量数据，最简单的语句如下：\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e \u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e orders\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003ewhere\u003c/span\u003e \u003cspan class=\"type\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"operator\"\u003e\u0026lt;\u003c/span\u003e SUBDATE(CURDATE(),\u003cspan class=\"type\"\u003eINTERVAL\u003c/span\u003e \u003cspan class=\"number\"\u003e3\u003c/span\u003e \u003cspan class=\"keyword\"\u003emonth\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e上面的语句，大概率执行会报错，提示删除失败，因为需要删除的数据量太大了，所以需要分批删除。\u003c/p\u003e\n\u003cp\u003e可以先通过一次查询，找到符合条件的历史订单中最大的那个订单 ID，然后在删除语句中把删除的条件转换成按主键删除。\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eselect\u003c/span\u003e \u003cspan class=\"built_in\"\u003emax\u003c/span\u003e(id) \u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e orders\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003ewhere\u003c/span\u003e \u003cspan class=\"type\"\u003etimestamp\u003c/span\u003e \u003cspan class=\"operator\"\u003e\u0026lt;\u003c/span\u003e SUBDATE(CURDATE(),\u003cspan class=\"type\"\u003eINTERVAL\u003c/span\u003e \u003cspan class=\"number\"\u003e3\u003c/span\u003e \u003cspan class=\"keyword\"\u003emonth\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 分批删除，? 填上一条语句查到的最大 ID\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e \u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e orders\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003ewhere\u003c/span\u003e id \u003cspan class=\"operator\"\u003e\u0026lt;=\u003c/span\u003e ?\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eorder\u003c/span\u003e \u003cspan class=\"keyword\"\u003eby\u003c/span\u003e id limit \u003cspan class=\"number\"\u003e1000\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"修改表的编码格式\"\u003e\u003ca href=\"#修改表的编码格式\" class=\"headerlink\" title=\"修改表的编码格式\"\u003e\u003c/a\u003e修改表的编码格式\u003c/h3\u003e\u003cp\u003eutf8mb4 编码是 utf8 编码的超集，兼容 utf8，并且能存储 4 字节的表情字符。如果表的编码指定为 utf8，在保存 emoji 字段时会报错。\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eALTER\u003c/span\u003e \u003cspan class=\"keyword\"\u003eTABLE\u003c/span\u003e \u003cspan class=\"operator\"\u003e\u0026lt;\u003c/span\u003etableName\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eCONVERT\u003c/span\u003e \u003cspan class=\"keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"type\"\u003eCHARACTER\u003c/span\u003e \u003cspan class=\"keyword\"\u003eSET\u003c/span\u003e utf8mb4 \u003cspan class=\"keyword\"\u003eCOLLATE\u003c/span\u003e utf8mb4_general_ci;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch2 id=\"其他\"\u003e\u003ca href=\"#其他\" class=\"headerlink\" title=\"其他\"\u003e\u003c/a\u003e其他\u003c/h2\u003e\u003ch3 id=\"显示哪些线程正在运行\"\u003e\u003ca href=\"#显示哪些线程正在运行\" class=\"headerlink\" title=\"显示哪些线程正在运行\"\u003e\u003c/a\u003e显示哪些线程正在运行\u003c/h3\u003e\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eshow\u003c/span\u003e processlist;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e----+-----------------+-----------------+------+---------+-------+------------------------+------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e Id \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eUser\u003c/span\u003e            \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Host            \u003cspan class=\"operator\"\u003e|\u003c/span\u003e db   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Command \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"type\"\u003eTime\u003c/span\u003e  \u003cspan class=\"operator\"\u003e|\u003c/span\u003e State                  \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Info             \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e----+-----------------+-----------------+------+---------+-------+------------------------+------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e  \u003cspan class=\"number\"\u003e5\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e event_scheduler \u003cspan class=\"operator\"\u003e|\u003c/span\u003e localhost       \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eNULL\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Daemon  \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"number\"\u003e40230\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Waiting \u003cspan class=\"keyword\"\u003eon\u003c/span\u003e \u003cspan class=\"keyword\"\u003eempty\u003c/span\u003e queue \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eNULL\u003c/span\u003e             \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"number\"\u003e10\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e root            \u003cspan class=\"operator\"\u003e|\u003c/span\u003e localhost:\u003cspan class=\"number\"\u003e10120\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eNULL\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Query   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e     \u003cspan class=\"number\"\u003e0\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e init                   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eshow\u003c/span\u003e processlist \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e----+-----------------+-----------------+------+---------+-------+------------------------+------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"number\"\u003e2\u003c/span\u003e \u003cspan class=\"keyword\"\u003erows\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"keyword\"\u003eset\u003c/span\u003e (\u003cspan class=\"number\"\u003e0.00\u003c/span\u003e sec)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eMysql 连接完成后，如果你没有后续的动作，这个连接就处于空闲状态，你可以在 \u003ccode\u003eshow processlist\u003c/code\u003e 命令中看到它。其中的 Command 列显示为“Sleep”的这一行，就表示现在系统里面有一个空闲连接。客户端如果太长时间没动静，连接器就会自动将它断开。这个时间是由参数 wait_timeout 控制的，默认值是 8 小时。\u003c/p\u003e\n\u003ch2 id=\"参考资料\"\u003e\u003ca href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"\u003e\u003c/a\u003e参考资料\u003c/h2\u003e\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://book.douban.com/subject/35167240/\"\u003e《SQL 必知必会》\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n    \u003c/div\u003e",
  "Date": "2020-10-10T11:03:05Z",
  "Author": "钝悟 ◾ Dunwu"
}