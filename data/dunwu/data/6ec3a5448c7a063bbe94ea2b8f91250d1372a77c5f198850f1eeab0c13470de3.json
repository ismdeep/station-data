{
  "Source": "dunwu",
  "Title": "Mysql 高可用",
  "Link": "https://dunwu.github.io/blog/pages/083b48/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003ch1 id=\"Mysql-高可用\"\u003e\u003ca href=\"#Mysql-高可用\" class=\"headerlink\" title=\"Mysql 高可用\"\u003e\u003c/a\u003eMysql 高可用\u003c/h1\u003e\u003ch2 id=\"复制\"\u003e\u003ca href=\"#复制\" class=\"headerlink\" title=\"复制\"\u003e\u003c/a\u003e复制\u003c/h2\u003e\u003cp\u003e复制是解决系统高可用的常见手段。其思路就是：不要把鸡蛋都放在一个篮子里。\u003c/p\u003e\n\u003cp\u003e复制解决的基本问题是让一台服务器的数据与其他服务器保持同步。一台主库的数据可以同步到多台备库上，备库本身也可以被配置成另外一台服务器的主库。主库和备库之 间可以有多种不同的组合方式。\u003c/p\u003e\n\u003cp\u003eMySQL 支持两种复制方式：基于行的复制和基于语句的复制。这两种方式都是通过在主库上记录 bin log、在备库重放日志的方式来实现异步的数据复制。这意味着：复制过程存在时延，这段时间内，主从数据可能不一致。\u003c/p\u003e\n\u003ch3 id=\"复制如何工作\"\u003e\u003ca href=\"#复制如何工作\" class=\"headerlink\" title=\"复制如何工作\"\u003e\u003c/a\u003e复制如何工作\u003c/h3\u003e\u003cp\u003e在 Mysql 中，复制分为三个步骤，分别由三个线程完成：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003ebinlog dump 线程\u003c/strong\u003e - 主库上有一个特殊的 binlog dump 线程，负责将主服务器上的数据更改写入 binlog 中。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eI/O 线程\u003c/strong\u003e - 备库上有一个 I/O 线程，负责从主库上读取 binlog，并写入备库的中继日志（relay log）中。\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eSQL 线程\u003c/strong\u003e - 备库上有一个 SQL 线程，负责读取中继日志（relay log）并重放其中的 SQL 语句。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv align=\"center\"\u003e\n\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/cs/database/mysql/master-slave.png\"/\u003e\n\u003c/div\u003e\n\n\u003cp\u003e这种架构实现了数据备份和数据同步的异步解耦。但这种架构也限制了复制的过程，其中最重要 的一点是在主库上并发运行的查询在备库只能串行化执行，因为只有一个 SQL 线程来重放 中继日志中的事件。\u003c/p\u003e\n\u003ch3 id=\"主备配置\"\u003e\u003ca href=\"#主备配置\" class=\"headerlink\" title=\"主备配置\"\u003e\u003c/a\u003e主备配置\u003c/h3\u003e\u003cp\u003e假设需要配置一对 Mysql 主备节点，环境如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e主库节点：192.168.8.10\u003c/li\u003e\n\u003cli\u003e备库节点：192.168.8.11\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"主库上的操作\"\u003e\u003ca href=\"#主库上的操作\" class=\"headerlink\" title=\"主库上的操作\"\u003e\u003c/a\u003e主库上的操作\u003c/h4\u003e\u003cp\u003e（1）修改配置并重启\u003c/p\u003e\n\u003cp\u003e执行 \u003ccode\u003evi /etc/my.cnf\u003c/code\u003e ，添加如下配置：\u003c/p\u003e\n\u003cfigure class=\"highlight ini\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"section\"\u003e[mysqld]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eserver-id\u003c/span\u003e=\u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003elog_bin\u003c/span\u003e=/var/lib/mysql/binlog\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eserver-id\u003c/code\u003e - 服务器 ID 号。在主从架构中，每台机器的 ID 必须唯一。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog_bin\u003c/code\u003e - 同步的日志路径及文件名，一定注意这个目录要是 mysql 有权限写入的；\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e修改后，重启 mysql 使配置生效：\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003esystemctl restart mysql\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（2）创建用于同步的用户\u003c/p\u003e\n\u003cp\u003e进入 mysql 命令控制台：\u003c/p\u003e\n\u003cfigure class=\"highlight sh\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e$ mysql -u root -p\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ePassword:\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e执行以下 SQL：\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- a. 创建 slave 用户\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eUSER\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;%\u0026#39;\u003c/span\u003e IDENTIFIED \u003cspan class=\"keyword\"\u003eWITH\u003c/span\u003e mysql_native_password \u003cspan class=\"keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;密码\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 为 slave 赋予 REPLICATION SLAVE 权限\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eGRANT\u003c/span\u003e REPLICATION SLAVE \u003cspan class=\"keyword\"\u003eON\u003c/span\u003e \u003cspan class=\"operator\"\u003e*\u003c/span\u003e.\u003cspan class=\"operator\"\u003e*\u003c/span\u003e \u003cspan class=\"keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;%\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- b. 或者，创建 slave 用户，并指定该用户能在任意主机上登录\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 如果有多个备库，又想让所有备库都使用统一的用户名、密码认证，可以考虑这种方式\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eUSER\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;%\u0026#39;\u003c/span\u003e IDENTIFIED \u003cspan class=\"keyword\"\u003eWITH\u003c/span\u003e mysql_native_password \u003cspan class=\"keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;密码\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eGRANT\u003c/span\u003e REPLICATION SLAVE \u003cspan class=\"keyword\"\u003eON\u003c/span\u003e \u003cspan class=\"operator\"\u003e*\u003c/span\u003e.\u003cspan class=\"operator\"\u003e*\u003c/span\u003e \u003cspan class=\"keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;%\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 刷新授权表信息\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFLUSH PRIVILEGES;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e注意：在 Mysql 8 中，默认密码验证不再是 \u003ccode\u003epassword\u003c/code\u003e。所以在创建用户时，\u003ccode\u003ecreate user \u0026#39;username\u0026#39;@\u0026#39;%\u0026#39; identified by \u0026#39;password\u0026#39;;\u003c/code\u003e 客户端是无法连接服务的。所以，需要加上 \u003ccode\u003eIDENTIFIED WITH mysql_native_password BY \u0026#39;password\u0026#39;\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e补充用户管理 SQL:\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 查看所有用户\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSELECT\u003c/span\u003e \u003cspan class=\"keyword\"\u003eDISTINCT\u003c/span\u003e CONCAT(\u003cspan class=\"string\"\u003e\u0026#39;User: \u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e, \u003cspan class=\"keyword\"\u003euser\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u0026#39;@\u0026#39;\u0026#39;\u0026#39;\u003c/span\u003e, host, \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u0026#39;;\u0026#39;\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eAS\u003c/span\u003e query\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eFROM\u003c/span\u003e mysql.user;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 查看用户权限\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eSHOW\u003c/span\u003e GRANTS \u003cspan class=\"keyword\"\u003eFOR\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;root\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;%\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 创建用户\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- a. 创建 slave 用户，并指定该用户只能在主机 192.168.8.11 上登录\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eCREATE\u003c/span\u003e \u003cspan class=\"keyword\"\u003eUSER\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;192.168.8.11\u0026#39;\u003c/span\u003e IDENTIFIED \u003cspan class=\"keyword\"\u003eWITH\u003c/span\u003e mysql_native_password \u003cspan class=\"keyword\"\u003eBY\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;密码\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 为 slave 赋予 REPLICATION SLAVE 权限\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eGRANT\u003c/span\u003e REPLICATION SLAVE \u003cspan class=\"keyword\"\u003eON\u003c/span\u003e \u003cspan class=\"operator\"\u003e*\u003c/span\u003e.\u003cspan class=\"operator\"\u003e*\u003c/span\u003e \u003cspan class=\"keyword\"\u003eTO\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;192.168.8.11\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 删除用户\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eDROP\u003c/span\u003e \u003cspan class=\"keyword\"\u003eUSER\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e@\u003cspan class=\"string\"\u003e\u0026#39;192.168.8.11\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（3）加读锁\u003c/p\u003e\n\u003cp\u003e为了主库与从库的数据保持一致，我们先为 mysql 加入读锁，使其变为只读。\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e FLUSH TABLES \u003cspan class=\"keyword\"\u003eWITH\u003c/span\u003e READ LOCK;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（4）查看主库状态\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eshow\u003c/span\u003e master status;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e------------------+----------+--------------+---------------------------------------------+-------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e File             \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Position \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Binlog_Do_DB \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Binlog_Ignore_DB                            \u003cspan class=\"operator\"\u003e|\u003c/span\u003e Executed_Gtid_Set \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e------------------+----------+--------------+---------------------------------------------+-------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e mysql\u003cspan class=\"operator\"\u003e-\u003c/span\u003ebin\u003cspan class=\"number\"\u003e.000001\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e     \u003cspan class=\"number\"\u003e4202\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e              \u003cspan class=\"operator\"\u003e|\u003c/span\u003e mysql,information_schema,performance_schema \u003cspan class=\"operator\"\u003e|\u003c/span\u003e                   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e------------------+----------+--------------+---------------------------------------------+-------------------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"number\"\u003e1\u003c/span\u003e \u003cspan class=\"type\"\u003erow\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"keyword\"\u003eset\u003c/span\u003e (\u003cspan class=\"number\"\u003e0.00\u003c/span\u003e sec)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e注意：需要记录下 \u003ccode\u003eFile\u003c/code\u003e 和 \u003ccode\u003ePosition\u003c/code\u003e，后面会用到。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e（5）导出 sql\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysqldump -u root -p --all-databases --master-data \u0026gt; dbdump.sql\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（6）解除读锁\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e UNLOCK TABLES;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（7）将 sql 远程传送到备库上\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003escp dbdump.sql root@192.168.8.11:/home\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"备库上的操作\"\u003e\u003ca href=\"#备库上的操作\" class=\"headerlink\" title=\"备库上的操作\"\u003e\u003c/a\u003e备库上的操作\u003c/h4\u003e\u003cp\u003e（1）修改配置并重启\u003c/p\u003e\n\u003cp\u003e执行 \u003ccode\u003evi /etc/my.cnf\u003c/code\u003e ，添加如下配置：\u003c/p\u003e\n\u003cfigure class=\"highlight ini\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"section\"\u003e[mysqld]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eserver-id\u003c/span\u003e=\u003cspan class=\"number\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003elog_bin\u003c/span\u003e=/var/lib/mysql/binlog\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eserver-id\u003c/code\u003e - 服务器 ID 号。在主从架构中，每台机器的 ID 必须唯一。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog_bin\u003c/code\u003e - 同步的日志路径及文件名，一定注意这个目录要是 mysql 有权限写入的；\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e修改后，重启 mysql 使配置生效：\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003esystemctl restart mysql\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（2）导入 sql\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql -u root -p \u0026lt; /home/dbdump.sql\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（3）在备库上建立与主库的连接\u003c/p\u003e\n\u003cp\u003e进入 mysql 命令控制台：\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e$ \u003c/span\u003e\u003cspan class=\"language-bash\"\u003emysql -u root -p\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ePassword:\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e执行以下 SQL：\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 停止备库服务\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSTOP SLAVE;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e-- 注意：MASTER_USER 和\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCHANGE MASTER \u003cspan class=\"keyword\"\u003eTO\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMASTER_HOST\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#39;192.168.8.10\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMASTER_USER\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#39;slave\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMASTER_PASSWORD\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#39;密码\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMASTER_LOG_FILE\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#39;binlog.000001\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMASTER_LOG_POS\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"number\"\u003e4202\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eMASTER_LOG_FILE\u003c/code\u003e 和 \u003ccode\u003eMASTER_LOG_POS\u003c/code\u003e 参数要分别与 \u003ccode\u003eshow master status\u003c/code\u003e 指令获得的 \u003ccode\u003eFile\u003c/code\u003e 和 \u003ccode\u003ePosition\u003c/code\u003e 属性值对应。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eMASTER_HOST\u003c/code\u003e 是主库的 HOST。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eMASTER_USER\u003c/code\u003e 和 \u003ccode\u003eMASTER_PASSWORD\u003c/code\u003e 是在主节点上注册的用户及密码。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e（4）启动 slave 进程\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003estart\u003c/span\u003e slave;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（5）查看主从同步状态\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eshow\u003c/span\u003e slave status\\G;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e说明：如果以下两项参数均为 YES，说明配置正确。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eSlave_IO_Running\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSlave_SQL_Running\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e（6）将备库设为只读\u003c/p\u003e\n\u003cfigure class=\"highlight sql\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eset\u003c/span\u003e \u003cspan class=\"keyword\"\u003eglobal\u003c/span\u003e read_only\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"number\"\u003e1\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eset\u003c/span\u003e \u003cspan class=\"keyword\"\u003eglobal\u003c/span\u003e super_read_only\u003cspan class=\"operator\"\u003e=\u003c/span\u003e\u003cspan class=\"number\"\u003e1\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003emysql\u003cspan class=\"operator\"\u003e\u0026gt;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eshow\u003c/span\u003e \u003cspan class=\"keyword\"\u003eglobal\u003c/span\u003e variables \u003cspan class=\"keyword\"\u003elike\u003c/span\u003e \u0026#34;%read_only%\u0026#34;;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e-----------------------+-------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e Variable_name         \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eValue\u003c/span\u003e \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e-----------------------+-------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e innodb_read_only      \u003cspan class=\"operator\"\u003e|\u003c/span\u003e OFF   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e read_only             \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eON\u003c/span\u003e    \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e super_read_only       \u003cspan class=\"operator\"\u003e|\u003c/span\u003e \u003cspan class=\"keyword\"\u003eON\u003c/span\u003e    \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e|\u003c/span\u003e transaction_read_only \u003cspan class=\"operator\"\u003e|\u003c/span\u003e OFF   \u003cspan class=\"operator\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"operator\"\u003e+\u003c/span\u003e\u003cspan class=\"comment\"\u003e-----------------------+-------+\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003e注：设置 slave 服务器为只读，并不影响主从同步。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"复制的原理\"\u003e\u003ca href=\"#复制的原理\" class=\"headerlink\" title=\"复制的原理\"\u003e\u003c/a\u003e复制的原理\u003c/h2\u003e\u003ch2 id=\"读写分离\"\u003e\u003ca href=\"#读写分离\" class=\"headerlink\" title=\"读写分离\"\u003e\u003c/a\u003e读写分离\u003c/h2\u003e\u003cp\u003e主服务器用来处理写操作以及实时性要求比较高的读操作，而从服务器用来处理读操作。\u003c/p\u003e\n\u003cp\u003e读写分离常用代理方式来实现，代理服务器接收应用层传来的读写请求，然后决定转发到哪个服务器。\u003c/p\u003e\n\u003cp\u003eMySQL 读写分离能提高性能的原因在于：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e主从服务器负责各自的读和写，极大程度缓解了锁的争用；\u003c/li\u003e\n\u003cli\u003e从服务器可以配置 MyISAM 引擎，提升查询性能以及节约系统开销；\u003c/li\u003e\n\u003cli\u003e增加冗余，提高可用性。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv align=\"center\"\u003e\n\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/cs/database/mysql/master-slave-proxy.png\"/\u003e\n\u003c/div\u003e\n\n\u003ch2 id=\"参考资料\"\u003e\u003ca href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"\u003e\u003c/a\u003e参考资料\u003c/h2\u003e\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://book.douban.com/subject/23008813/\"\u003e《高性能 MySQL》\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://time.geekbang.org/column/intro/139\"\u003eMySQL 实战 45 讲\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n    \u003c/div\u003e",
  "Date": "2023-09-21T13:25:58Z",
  "Author": "钝悟 ◾ Dunwu"
}