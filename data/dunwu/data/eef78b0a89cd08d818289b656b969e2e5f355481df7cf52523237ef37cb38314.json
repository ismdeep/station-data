{
  "Source": "dunwu",
  "Title": "MongoDB 建模",
  "Link": "https://dunwu.github.io/blog/pages/562f99/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003ch1 id=\"MongoDB-建模\"\u003e\u003ca href=\"#MongoDB-建模\" class=\"headerlink\" title=\"MongoDB 建模\"\u003e\u003c/a\u003eMongoDB 建模\u003c/h1\u003e\u003cp\u003eMongoDB 的数据模式是一种灵活模式，关系型数据库要求你在插入数据之前必须先定义好一个表的模式结构，而 MongoDB 的集合则并不限制 document 结构。这种灵活性让对象和数据库文档之间的映射变得很容易。即使数据记录之间有很大的变化，每个文档也可以很好的映射到各条不同的记录。 当然在实际使用中，同一个集合中的文档往往都有一个比较类似的结构。\u003c/p\u003e\n\u003cp\u003e数据模型设计中最具挑战性的是在应用程序需求，数据库引擎性能要求和数据读写模式之间做权衡考量。当设计数据模型的时候，一定要考虑应用程序对数据的使用模式（如查询，更新和处理）以及数据本身的天然结构。\u003c/p\u003e\n\u003ch2 id=\"MongoDB-数据建模入门\"\u003e\u003ca href=\"#MongoDB-数据建模入门\" class=\"headerlink\" title=\"MongoDB 数据建模入门\"\u003e\u003c/a\u003eMongoDB 数据建模入门\u003c/h2\u003e\u003cblockquote\u003e\n\u003cp\u003e参考：\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/guides/server/introduction/#what-you-ll-need\"\u003ehttps://docs.mongodb.com/guides/server/introduction/#what-you-ll-need\u003c/a\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"（一）定义数据集\"\u003e\u003ca href=\"#（一）定义数据集\" class=\"headerlink\" title=\"（一）定义数据集\"\u003e\u003c/a\u003e（一）定义数据集\u003c/h3\u003e\u003cp\u003e当需要建立数据存储时，首先应该思考以下问题：需要存储哪些数据？这些字段之间如何关联？\u003c/p\u003e\n\u003cp\u003e这是一个数据建模的过程。目标是\u003cstrong\u003e将业务需求抽象为逻辑模型\u003c/strong\u003e。\u003c/p\u003e\n\u003cp\u003e假设这样一个场景：我们需要建立数据库以跟踪物料及其数量，大小，标签和等级。\u003c/p\u003e\n\u003cp\u003e如果是存储在 RDBMS，可能以下的数据表：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth align=\"left\"\u003ename\u003c/th\u003e\n\u003cth align=\"left\"\u003equantity\u003c/th\u003e\n\u003cth align=\"left\"\u003esize\u003c/th\u003e\n\u003cth align=\"left\"\u003estatus\u003c/th\u003e\n\u003cth align=\"left\"\u003etags\u003c/th\u003e\n\u003cth align=\"left\"\u003erating\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd align=\"left\"\u003ejournal\u003c/td\u003e\n\u003ctd align=\"left\"\u003e25\u003c/td\u003e\n\u003ctd align=\"left\"\u003e14x21,cm\u003c/td\u003e\n\u003ctd align=\"left\"\u003eA\u003c/td\u003e\n\u003ctd align=\"left\"\u003ebrown, lined\u003c/td\u003e\n\u003ctd align=\"left\"\u003e9\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"left\"\u003enotebook\u003c/td\u003e\n\u003ctd align=\"left\"\u003e50\u003c/td\u003e\n\u003ctd align=\"left\"\u003e8.5x11,in\u003c/td\u003e\n\u003ctd align=\"left\"\u003eA\u003c/td\u003e\n\u003ctd align=\"left\"\u003ecollege-ruled,perforated\u003c/td\u003e\n\u003ctd align=\"left\"\u003e8\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"left\"\u003epaper\u003c/td\u003e\n\u003ctd align=\"left\"\u003e100\u003c/td\u003e\n\u003ctd align=\"left\"\u003e8.5x11,in\u003c/td\u003e\n\u003ctd align=\"left\"\u003eD\u003c/td\u003e\n\u003ctd align=\"left\"\u003ewatercolor\u003c/td\u003e\n\u003ctd align=\"left\"\u003e10\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"left\"\u003eplanner\u003c/td\u003e\n\u003ctd align=\"left\"\u003e75\u003c/td\u003e\n\u003ctd align=\"left\"\u003e22.85x30,cm\u003c/td\u003e\n\u003ctd align=\"left\"\u003eD\u003c/td\u003e\n\u003ctd align=\"left\"\u003e2019\u003c/td\u003e\n\u003ctd align=\"left\"\u003e10\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd align=\"left\"\u003epostcard\u003c/td\u003e\n\u003ctd align=\"left\"\u003e45\u003c/td\u003e\n\u003ctd align=\"left\"\u003e10x,cm\u003c/td\u003e\n\u003ctd align=\"left\"\u003eD\u003c/td\u003e\n\u003ctd align=\"left\"\u003edouble-sided,white\u003c/td\u003e\n\u003ctd align=\"left\"\u003e2\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003ch3 id=\"（二）思考-JSON-结构\"\u003e\u003ca href=\"#（二）思考-JSON-结构\" class=\"headerlink\" title=\"（二）思考 JSON 结构\"\u003e\u003c/a\u003e（二）思考 JSON 结构\u003c/h3\u003e\u003cp\u003e从上例中可以看出，表似乎是存储数据的好地方，但该数据集中的字段需要多个值，如果在单个列中建模，则不容易搜索或显示（对于 例如–大小和标签）。\u003c/p\u003e\n\u003cp\u003e在 SQL 数据库中，您可以通过创建关系表来解决此问题。\u003c/p\u003e\n\u003cp\u003e在 MongoDB 中，数据存储为文档（document）。 这些文档以 JSON（JavaScript 对象表示法）格式存储在 MongoDB 中。 JSON 文档支持嵌入式字段，因此相关数据和数据列表可以与文档一起存储，而不是与外部表一起存储。\u003c/p\u003e\n\u003cp\u003eJSON 格式为键/值对。 在 JSON 文档中，字段名和值用冒号分隔，字段名和值对用逗号分隔，并且字段集封装在“大括号”（\u003ccode\u003e{}\u003c/code\u003e）中。\u003c/p\u003e\n\u003cp\u003e如果要开始对上面的行之一进行建模，例如此行：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth align=\"left\"\u003ename\u003c/th\u003e\n\u003cth align=\"left\"\u003equantity\u003c/th\u003e\n\u003cth align=\"left\"\u003esize\u003c/th\u003e\n\u003cth align=\"left\"\u003estatus\u003c/th\u003e\n\u003cth align=\"left\"\u003etags\u003c/th\u003e\n\u003cth align=\"left\"\u003erating\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd align=\"left\"\u003enotebook\u003c/td\u003e\n\u003ctd align=\"left\"\u003e50\u003c/td\u003e\n\u003ctd align=\"left\"\u003e8.5x11,in\u003c/td\u003e\n\u003ctd align=\"left\"\u003eA\u003c/td\u003e\n\u003ctd align=\"left\"\u003ecollege-ruled,perforated\u003c/td\u003e\n\u003ctd align=\"left\"\u003e8\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e您可以从 name 和 quantity 字段开始。 在 JSON 中，这些字段如下所示：\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;notebook\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;qty\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e50\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"（三）确定哪些字段作为嵌入式数据\"\u003e\u003ca href=\"#（三）确定哪些字段作为嵌入式数据\" class=\"headerlink\" title=\"（三）确定哪些字段作为嵌入式数据\"\u003e\u003c/a\u003e（三）确定哪些字段作为嵌入式数据\u003c/h3\u003e\u003cp\u003e接下来，需要确定哪些字段可能需要多个值。可以考虑将这些字段作为嵌入式文档或嵌入式文档中的 列表/数组 对象。\u003c/p\u003e\n\u003cp\u003e例如，在上面的示例中，size 可能包含三个字段：\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;h\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e11\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;w\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e8.5\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;uom\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eAnd some items have multiple ratings, so \u003ccode\u003eratings\u003c/code\u003e might be represented as a list of documents containing the field \u003ccode\u003escores\u003c/code\u003e:\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;score\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e8\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;score\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e9\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eAnd you might need to handle multiple tags per item. So you might store them in a list too.\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#34;college-ruled\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;perforated\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eFinally, a JSON document that stores an inventory item might look like this:\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;notebook\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;qty\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e50\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;rating\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;score\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e8\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;score\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e9\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;size\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;height\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e11\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;width\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"number\"\u003e8.5\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;unit\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;status\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;A\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;tags\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#34;college-ruled\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;perforated\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eThis looks very different from the tabular data structure you started with in Step 1.\u003c/p\u003e\n\u003ch2 id=\"数据模型简介\"\u003e\u003ca href=\"#数据模型简介\" class=\"headerlink\" title=\"数据模型简介\"\u003e\u003c/a\u003e数据模型简介\u003c/h2\u003e\u003cp\u003e数据建模中的关键挑战是平衡应用程序的需求、数据库引擎的性能以及数据检索模式。 在设计数据模型时，始终需要考虑数据的应用程序使用情况（即数据的查询，更新和处理）以及数据本身的固有结构。\u003c/p\u003e\n\u003ch3 id=\"灵活的-Schema\"\u003e\u003ca href=\"#灵活的-Schema\" class=\"headerlink\" title=\"灵活的 Schema\"\u003e\u003c/a\u003e灵活的 Schema\u003c/h3\u003e\u003cp\u003e在关系型数据库中，必须在插入数据之前确定并声明表的结构。而 MongoDB 的 collection 默认情况下不需要其文档具有相同的架构。也就是说：\u003c/p\u003e\n\u003cp\u003e同一个 collection 中的 document 不需要具有相同的 field 集，并且 field 的数据类型可以在集合中的不同文档之间有所不同。\u003c/p\u003e\n\u003cp\u003e要更改 collection 中的 document 结构，例如添加新 field，删除现有 field 或将 field 值更改为新类型，只需要将文档更新为新结构即可。\u003c/p\u003e\n\u003cp\u003e这种灵活性有助于将 document 映射到实体或对象。每个 document 都可以匹配所表示实体的数据字段，即使该文档与集合中的其他文档有很大的不同。但是，实际上，集合中的文档具有相似的结构，并且您可以在更新和插入操作期间对 collection 强制执行 document 校验规则。\u003c/p\u003e\n\u003ch3 id=\"Document-结构\"\u003e\u003ca href=\"#Document-结构\" class=\"headerlink\" title=\"Document 结构\"\u003e\u003c/a\u003eDocument 结构\u003c/h3\u003e\u003ch4 id=\"嵌入式数据模型\"\u003e\u003ca href=\"#嵌入式数据模型\" class=\"headerlink\" title=\"嵌入式数据模型\"\u003e\u003c/a\u003e嵌入式数据模型\u003c/h4\u003e\u003cp\u003e嵌入式 document 通过将相关数据存储在单个 document 结构中来捕获数据之间的关系。 MongoDB document 可以将 document 结构嵌入到另一个 document 中的字段或数组中。这些非规范化的数据模型允许应用程序在单个数据库操作中检索和操纵相关数据。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/20200910193231.png\" alt=\"img\"/\u003e\u003c/p\u003e\n\u003cp\u003e对于 MongoDB 中的很多场景，非规范化数据模型都是最佳的。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e嵌入式 document 有大小限制：必须小于 16 MB。\u003c/p\u003e\n\u003cp\u003e如果是较大的二进制数据，可以考虑 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/core/gridfs/\"\u003eGridFS\u003c/a\u003e。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"引用式数据模型\"\u003e\u003ca href=\"#引用式数据模型\" class=\"headerlink\" title=\"引用式数据模型\"\u003e\u003c/a\u003e引用式数据模型\u003c/h4\u003e\u003cp\u003e引用通过包含从一个 document 到另一个 document 的链接或引用来存储数据之间的关系。 应用程序可以解析这些引用以访问相关数据。 广义上讲，这些是规范化的数据模型。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/20200910193234.png\" alt=\"img\"/\u003e\u003c/p\u003e\n\u003cp\u003e通常，在以下场景使用引用式的数据模型：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e嵌入时会导致数据重复，但无法提供足够的读取性能优势，无法胜过重复的含义。\u003c/li\u003e\n\u003cli\u003e代表更复杂的多对多关系。\u003c/li\u003e\n\u003cli\u003e为大规模分层数据集建模。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e为了 join collection，MongoDB 支持聚合 stage：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/aggregation/lookup/#pipe._S_lookup\"\u003e\u003ccode\u003e$lookup\u003c/code\u003e\u003c/a\u003e（MongoDB 3.2 开始支持）\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/aggregation/graphLookup/#pipe._S_graphLookup\"\u003e\u003ccode\u003e$graphLookup\u003c/code\u003e\u003c/a\u003e（MongoDB 3.4 开始支持）\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eMongoDB 还提供了引用来支持跨集合 join 数据：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e引用数据模型示例，参考：\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/tutorial/model-referenced-one-to-many-relationships-between-documents/#data-modeling-publisher-and-books\"\u003eModel One-to-Many Relationships with Document References\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e更多树形模型，参考：\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/applications/data-models-tree-structures/\"\u003eModel Tree Structures\u003c/a\u003e.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"原子写操作\"\u003e\u003ca href=\"#原子写操作\" class=\"headerlink\" title=\"原子写操作\"\u003e\u003c/a\u003e原子写操作\u003c/h3\u003e\u003ch4 id=\"单-document-的原子性\"\u003e\u003ca href=\"#单-document-的原子性\" class=\"headerlink\" title=\"单 document 的原子性\"\u003e\u003c/a\u003e单 document 的原子性\u003c/h4\u003e\u003cp\u003e在 MongoDB 中，针对单个 document 的写操作是原子性的，即使该 document 中嵌入了多个子 document。 具有嵌入数据的非规范化数据模型将所有相关数据合并在一个 document 中，而不是在多个 document 和 collection 中进行规范化。 该数据模型有助于原子操作。 当单个写入操作（例如 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/method/db.collection.updateMany/#db.collection.updateMany\"\u003e\u003ccode\u003edb.collection.updateMany()\u003c/code\u003e\u003c/a\u003e）修改多个 document 时，每个 document 的独立修改是原子的，但整个操作不是原子的。\u003c/p\u003e\n\u003ch4 id=\"多-document-事务\"\u003e\u003ca href=\"#多-document-事务\" class=\"headerlink\" title=\"多 document 事务\"\u003e\u003c/a\u003e多 document 事务\u003c/h4\u003e\u003cp\u003e对于需要对多个 document（在单个或多个集合中）进行读写原子性的情况，MongoDB 支持多 document 事务。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e在版本 4.0 中，MongoDB 在副本集上支持多 document 事务。\u003c/li\u003e\n\u003cli\u003e在版本 4.2 中，MongoDB 引入了分布式事务，它增加了对分片群集上多 document 事务的支持，并合并了对副本集上多 document 事务的现有支持。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e在大多数情况下，多 document 事务会比单 document 的写入产生更高的性能消耗，并且多 document 事务的可用性不能替代高效的结构设计。 在许多情况下，非规范化数据模型（嵌入式 document 和数组）仍是最佳选择。 也就是说，合理的数据建模，将最大程度地减少对多 document 事务的需求。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"数据使用和性能\"\u003e\u003ca href=\"#数据使用和性能\" class=\"headerlink\" title=\"数据使用和性能\"\u003e\u003c/a\u003e数据使用和性能\u003c/h3\u003e\u003cp\u003e在设计数据模型时，请考虑应用程序将如何使用您的数据库。 例如，如果您的应用程序仅使用最近插入的 document，请考虑使用上限集合。 或者，如果您的应用程序主要是对 collection 的读取操作，则添加索引以提高性能。\u003c/p\u003e\n\u003ch2 id=\"Schema-校验\"\u003e\u003ca href=\"#Schema-校验\" class=\"headerlink\" title=\"Schema 校验\"\u003e\u003c/a\u003eSchema 校验\u003c/h2\u003e\u003ch3 id=\"指定校验规则\"\u003e\u003ca href=\"#指定校验规则\" class=\"headerlink\" title=\"指定校验规则\"\u003e\u003c/a\u003e指定校验规则\u003c/h3\u003e\u003cp\u003e如果创建新 collection 时要指定校验规则，需要在使用 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/method/db.createCollection/#db.createCollection\"\u003e\u003ccode\u003edb.createCollection()\u003c/code\u003e\u003c/a\u003e 时指定 \u003ccode\u003evalidator\u003c/code\u003e 选项。\u003c/p\u003e\n\u003cp\u003e如果要将 document 校验添加到现有 collection 中，需要使用带有 \u003ccode\u003evalidator\u003c/code\u003e 选项的 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/command/collMod/#dbcmd.collMod\"\u003e\u003ccode\u003ecollMod\u003c/code\u003e\u003c/a\u003e 命令。\u003c/p\u003e\n\u003cp\u003eMongoDB 还提供以下相关选项：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003evalidationLevel\u003c/code\u003e 选项（用于确定 MongoDB 在更新过程中，对现有 document 应用校验规则的严格程度）\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evalidationAction\u003c/code\u003e 选项（用于确定 MongoDB 发现违反校验规则的 document 时，是选择报错并拒绝，还是接受数据但在日志中告警）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"JSON-Schema\"\u003e\u003ca href=\"#JSON-Schema\" class=\"headerlink\" title=\"JSON Schema\"\u003e\u003c/a\u003eJSON Schema\u003c/h3\u003e\u003cp\u003e从 3.6 版本开始，MongoDB 开始支持 JSON Schema 校验。\u003c/p\u003e\n\u003cp\u003e可以通过在 validator 表达式中使用 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema\"\u003e\u003ccode\u003e$jsonSchema\u003c/code\u003e\u003c/a\u003e 操作来指定 JSON Schema 校验。\u003c/p\u003e\n\u003cp\u003e【示例】\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edb.\u003cspan class=\"title function_\"\u003ecreateCollection\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;students\u0026#39;\u003c/span\u003e, {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidator\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e$jsonSchema\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;object\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003erequired\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;year\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;major\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;address\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eproperties\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eyear\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;int\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eminimum\u003c/span\u003e: \u003cspan class=\"number\"\u003e2017\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003emaximum\u003c/span\u003e: \u003cspan class=\"number\"\u003e3017\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be an integer in [ 2017, 3017 ] and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003emajor\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eenum\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;Math\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;English\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;Computer Science\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;History\u0026#39;\u003c/span\u003e, \u003cspan class=\"literal\"\u003enull\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;can only be one of the enum values and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003egpa\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;double\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a double if the field exists\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eaddress\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;object\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003erequired\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;city\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eproperties\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"attr\"\u003estreet\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e              \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e              \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string if the field exists\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"attr\"\u003ecity\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e              \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e              \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"其它查询表达式\"\u003e\u003ca href=\"#其它查询表达式\" class=\"headerlink\" title=\"其它查询表达式\"\u003e\u003c/a\u003e其它查询表达式\u003c/h3\u003e\u003cp\u003e除了使用 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/jsonSchema/#op._S_jsonSchema\"\u003e\u003ccode\u003e$jsonSchema\u003c/code\u003e\u003c/a\u003e 查询运算符的 JSON Schema 校验外，MongoDB 还支持其它查询运算符的校验，但以下情况除外：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/near/#op._S_near\"\u003e\u003ccode\u003e$near\u003c/code\u003e\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/nearSphere/#op._S_nearSphere\"\u003e\u003ccode\u003e$nearSphere\u003c/code\u003e\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/text/#op._S_text\"\u003e\u003ccode\u003e$text\u003c/code\u003e\u003c/a\u003e,\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/where/#op._S_where\"\u003e\u003ccode\u003e$where\u003c/code\u003e\u003c/a\u003e, and\u003c/li\u003e\n\u003cli\u003e带有 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/aggregation/function/#exp._S_function\"\u003e\u003ccode\u003e$function\u003c/code\u003e\u003c/a\u003e 表达式的 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.mongodb.com/manual/reference/operator/query/expr/#op._S_expr\"\u003e\u003ccode\u003e$expr\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e【示例】查询表达式中指定校验规则\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edb.\u003cspan class=\"title function_\"\u003ecreateCollection\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;contacts\u0026#39;\u003c/span\u003e, {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidator\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e$or\u003c/span\u003e: [\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      { \u003cspan class=\"attr\"\u003ephone\u003c/span\u003e: { \u003cspan class=\"attr\"\u003e$type\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e } },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      { \u003cspan class=\"attr\"\u003eemail\u003c/span\u003e: { \u003cspan class=\"attr\"\u003e$regex\u003c/span\u003e: \u003cspan class=\"regexp\"\u003e/@mongodb\\.com$/\u003c/span\u003e } },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      { \u003cspan class=\"attr\"\u003estatus\u003c/span\u003e: { \u003cspan class=\"attr\"\u003e$in\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;Unknown\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;Incomplete\u0026#39;\u003c/span\u003e] } }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"行为\"\u003e\u003ca href=\"#行为\" class=\"headerlink\" title=\"行为\"\u003e\u003c/a\u003e行为\u003c/h3\u003e\u003cp\u003e校验发生在更新和插入期间。添加校验规则到 collection 时，不会对现有的 document 进行校验，除非发生修改操作。\u003c/p\u003e\n\u003ch4 id=\"现有的-document\"\u003e\u003ca href=\"#现有的-document\" class=\"headerlink\" title=\"现有的 document\"\u003e\u003c/a\u003e现有的 document\u003c/h4\u003e\u003cp\u003e\u003ccode\u003evalidationLevel\u003c/code\u003e 选项确定 MongoDB 进行规则校验时执行的操作：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e如果 \u003ccode\u003evalidationLevel\u003c/code\u003e 是 strict（严格级别。这是 MongoDB 默认级别），则 MongoDB 将校验规则应用于所有插入和更新。\u003c/li\u003e\n\u003cli\u003e如果 \u003ccode\u003evalidationLevel\u003c/code\u003e 是 moderate（中等级别），则 MongoDB 只对已满足校验条件的现有文档的插入和更新操作进行校验；对不符合校验标准的现有文档的更新操作不进行校验。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e【示例】\u003c/p\u003e\n\u003cp\u003e下面是一个正常的插入操作：\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edb.\u003cspan class=\"property\"\u003econtacts\u003c/span\u003e.\u003cspan class=\"title function_\"\u003einsert\u003c/span\u003e([\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e_id\u003c/span\u003e: \u003cspan class=\"number\"\u003e1\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;Anne\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ephone\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;+1 555 123 456\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ecity\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;London\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;Complete\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  { \u003cspan class=\"attr\"\u003e_id\u003c/span\u003e: \u003cspan class=\"number\"\u003e2\u003c/span\u003e, \u003cspan class=\"attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;Ivan\u0026#39;\u003c/span\u003e, \u003cspan class=\"attr\"\u003ecity\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;Vancouver\u0026#39;\u003c/span\u003e }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e])\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在 collection 上配置一个校验规则：\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edb.\u003cspan class=\"title function_\"\u003erunCommand\u003c/span\u003e({\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecollMod\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;contacts\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidator\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e$jsonSchema\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;object\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003erequired\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;phone\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eproperties\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ephone\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidationLevel\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;moderate\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e则 \u003ccode\u003econtacts\u003c/code\u003e collection 现在添加了含中等级别（moderate） validationLevel 的 \u003ccode\u003evalidator\u003c/code\u003e：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e如果尝试更新 \u003ccode\u003e_id\u003c/code\u003e为 1 的文档，则 MongoDB 将应用校验规则，因为现有文档符合条件。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e相反，MongoDB 不会将校验 \u003ccode\u003e_id\u003c/code\u003e 为 2 的文档，因为它不符合校验规则。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e如果要完全禁用校验，可以将 \u003ccode\u003evalidationLevel\u003c/code\u003e 置为 \u003ccode\u003eoff\u003c/code\u003e。\u003c/p\u003e\n\u003ch4 id=\"接受或拒绝无效的-document\"\u003e\u003ca href=\"#接受或拒绝无效的-document\" class=\"headerlink\" title=\"接受或拒绝无效的 document\"\u003e\u003c/a\u003e接受或拒绝无效的 document\u003c/h4\u003e\u003cul\u003e\n\u003cli\u003e如果 validationAction 是 Error（默认），则 MongoDB 拒绝任何违反校验规则的插入或更新。\u003c/li\u003e\n\u003cli\u003e如果 validationAction 是 Warn，MongoDB 会记录所有的违规，但允许进行插入或更新。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e【示例】\u003c/p\u003e\n\u003cp\u003e创建集合时，配置 \u003ccode\u003evalidationAction\u003c/code\u003e 为 warn。\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edb.\u003cspan class=\"title function_\"\u003ecreateCollection\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;contacts2\u0026#39;\u003c/span\u003e, {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidator\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e$jsonSchema\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;object\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003erequired\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;phone\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eproperties\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ephone\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;must be a string and is required\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eemail\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003ebsonType\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;string\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003epattern\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;@mongodb.com$\u0026#39;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"string\"\u003e\u0026#39;must be a string and match the regular expression pattern\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003estatus\u003c/span\u003e: {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eenum\u003c/span\u003e: [\u003cspan class=\"string\"\u003e\u0026#39;Unknown\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;Incomplete\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003edescription\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;can only be one of the enum values\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003evalidationAction\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;warn\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e尝试插入一条违规记录\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u0026gt; db.\u003cspan class=\"property\"\u003econtacts2\u003c/span\u003e.\u003cspan class=\"title function_\"\u003einsert\u003c/span\u003e( { \u003cspan class=\"attr\"\u003ename\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;Amanda\u0026#34;\u003c/span\u003e, \u003cspan class=\"attr\"\u003estatus\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;Updated\u0026#34;\u003c/span\u003e } )\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"title class_\"\u003eWriteResult\u003c/span\u003e({ \u003cspan class=\"string\"\u003e\u0026#34;nInserted\u0026#34;\u003c/span\u003e : \u003cspan class=\"number\"\u003e1\u003c/span\u003e })\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eMongoDB 允许这条操作执行，但是服务器会记录下告警信息。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003cspan class=\"string\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e:{\u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e$date\u003c/span\u003e\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;2020-09-11T16:35:57.754+08:00\u0026#34;\u003c/span\u003e},\u003cspan class=\"string\"\u003e\u0026#34;s\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;W\u0026#34;\u003c/span\u003e,  \u003cspan class=\"string\"\u003e\u0026#34;c\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;STORAGE\u0026#34;\u003c/span\u003e,  \u003cspan class=\"string\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e:20294,   \u003cspan class=\"string\"\u003e\u0026#34;ctx\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;conn14\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Document would fail validation\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;attr\u0026#34;\u003c/span\u003e:{\u003cspan class=\"string\"\u003e\u0026#34;namespace\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;test.contacts2\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;document\u0026#34;\u003c/span\u003e:{\u003cspan class=\"string\"\u003e\u0026#34;_id\u0026#34;\u003c/span\u003e:{\u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e$oid\u003c/span\u003e\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;5f5b36ed8ea53d62a0b51c4e\u0026#34;\u003c/span\u003e},\u003cspan class=\"string\"\u003e\u0026#34;name\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Amanda\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;status\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Updated\u0026#34;\u003c/span\u003e}}}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"限制\"\u003e\u003ca href=\"#限制\" class=\"headerlink\" title=\"限制\"\u003e\u003c/a\u003e限制\u003c/h4\u003e\u003cp\u003e不能在 \u003ccode\u003eadmin\u003c/code\u003e、\u003ccode\u003elocal\u003c/code\u003e、\u003ccode\u003econfig\u003c/code\u003e 这几个特殊的数据库中指定校验规则。\u003c/p\u003e\n\u003cp\u003e不能在 \u003ccode\u003esystem.*\u003c/code\u003e collection 中指定校验。\u003c/p\u003e\n\u003ch2 id=\"参考资料\"\u003e\u003ca href=\"#参考资料\" class=\"headerlink\" title=\"参考资料\"\u003e\u003c/a\u003e参考资料\u003c/h2\u003e\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e官方\u003c/strong\u003e\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.mongodb.com/\"\u003eMongoDB 官网\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/mongodb/mongo\"\u003eMongoDB Github\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://university.mongodb.com/\"\u003eMongoDB 官方免费教程\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e教程\u003c/strong\u003e\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.runoob.com/mongodb/mongodb-tutorial.html\"\u003eMongoDB 教程\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://time.geekbang.org/course/intro/100040001\"\u003eMongoDB 高手课\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\n    \u003c/div\u003e",
  "Date": "2020-09-09T12:47:14Z",
  "Author": "钝悟 ◾ Dunwu"
}