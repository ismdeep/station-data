{
  "Source": "dunwu",
  "Title": "Redis æŒä¹…åŒ–",
  "Link": "https://dunwu.github.io/blog/pages/4de901/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\u003ch1 id=\"Redis-æŒä¹…åŒ–\"\u003e\u003ca href=\"#Redis-æŒä¹…åŒ–\" class=\"headerlink\" title=\"Redis æŒä¹…åŒ–\"\u003e\u003c/a\u003eRedis æŒä¹…åŒ–\u003c/h1\u003e\u003cblockquote\u003e\n\u003cp\u003eRedis æ˜¯å†…å­˜å‹æ•°æ®åº“ï¼Œä¸ºäº†ä¿è¯æ•°æ®åœ¨å®•æœºåä¸ä¼šä¸¢å¤±ï¼Œéœ€è¦å°†å†…å­˜ä¸­çš„æ•°æ®æŒä¹…åŒ–åˆ°ç¡¬ç›˜ä¸Šã€‚\u003c/p\u003e\n\u003cp\u003eRedis æ”¯æŒä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼šRDB å’Œ AOFã€‚è¿™ä¸¤ç§æŒä¹…åŒ–æ–¹å¼æ—¢å¯ä»¥åŒæ—¶ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å•ç‹¬ä½¿ç”¨ã€‚\u003c/p\u003e\n\u003cp\u003eå…³é”®è¯ï¼š\u003ccode\u003eRDB\u003c/code\u003eã€\u003ccode\u003eAOF\u003c/code\u003eã€\u003ccode\u003eSAVE\u003c/code\u003eã€\u003ccode\u003eBGSAVE\u003c/code\u003eã€\u003ccode\u003eappendfsync\u003c/code\u003e\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch2 id=\"RDB-å¿«ç…§\"\u003e\u003ca href=\"#RDB-å¿«ç…§\" class=\"headerlink\" title=\"RDB å¿«ç…§\"\u003e\u003c/a\u003eRDB å¿«ç…§\u003c/h2\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309150718907.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"RDB-ç®€ä»‹\"\u003e\u003ca href=\"#RDB-ç®€ä»‹\" class=\"headerlink\" title=\"RDB ç®€ä»‹\"\u003e\u003c/a\u003eRDB ç®€ä»‹\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eRDB å³â€œå¿«ç…§â€ï¼Œå®ƒå°†æŸæ—¶åˆ»çš„æ‰€æœ‰ Redis æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹æ•°æ®ä¿å­˜åˆ°ä¸€ä¸ªç»è¿‡å‹ç¼©çš„â€œäºŒè¿›åˆ¶æ–‡ä»¶â€ï¼ˆRDB æ–‡ä»¶ï¼‰ä¸­\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRDB æŒä¹…åŒ–å³å¯ä»¥â€œæ‰‹åŠ¨â€æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥å®šæœŸâ€œè‡ªåŠ¨â€æ‰§è¡Œ\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eRDB æ–‡ä»¶çš„â€œè½½å…¥â€å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨â€œå¯åŠ¨â€æ—¶â€œè‡ªåŠ¨â€æ‰§è¡Œçš„\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003eå¯¹äºä¸åŒç±»å‹çš„é”®å€¼å¯¹ï¼Œ RDB æ–‡ä»¶ä¼šä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥ä¿å­˜å®ƒä»¬ã€‚\u003c/p\u003e\n\u003cp\u003eåˆ›å»º RDB åï¼Œç”¨æˆ·å¯ä»¥å¯¹ RDB è¿›è¡Œå¤‡ä»½ï¼Œå¯ä»¥å°† RDB å¤åˆ¶åˆ°å…¶ä»–æœåŠ¡å™¨ä»è€Œåˆ›å»ºå…·æœ‰ç›¸åŒæ•°æ®çš„æœåŠ¡å™¨å‰¯æœ¬ï¼Œè¿˜å¯ä»¥åœ¨é‡å¯æœåŠ¡å™¨æ—¶ä½¿ç”¨ã€‚ä¸€å¥è¯æ¥è¯´ï¼š\u003cstrong\u003eRDB é€‚ç”¨äºä½œä¸ºâ€œå†·å¤‡â€\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003ch3 id=\"RDB-çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\"\u003e\u003ca href=\"#RDB-çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\" class=\"headerlink\" title=\"RDB çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\"\u003e\u003c/a\u003eRDB çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eRDB çš„ä¼˜ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eRDB æ–‡ä»¶éå¸¸ç´§å‡‘ï¼Œ\u003cstrong\u003eé€‚åˆä½œä¸ºâ€œå†·å¤‡â€\u003c/strong\u003eã€‚æ¯”å¦‚ä½ å¯ä»¥åœ¨æ¯ä¸ªå°æ—¶æŠ¥ä¿å­˜ä¸€ä¸‹è¿‡å» 24 å°æ—¶å†…çš„æ•°æ®ï¼ŒåŒæ—¶æ¯å¤©ä¿å­˜è¿‡å» 30 å¤©çš„æ•°æ®ï¼Œè¿™æ ·å³ä½¿å‡ºäº†é—®é¢˜ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚æ¢å¤åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®é›†ã€‚\u003c/li\u003e\n\u003cli\u003eå¿«ç…§åœ¨ä¿å­˜ RDB æ–‡ä»¶æ—¶çˆ¶è¿›ç¨‹å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å·¥ä½œå…¨éƒ¨ç”±å­è¿›ç¨‹æ¥åšï¼Œçˆ¶è¿›ç¨‹ä¸éœ€è¦å†åšå…¶ä»– IO æ“ä½œï¼Œæ‰€ä»¥å¿«ç…§æŒä¹…åŒ–æ–¹å¼å¯ä»¥æœ€å¤§åŒ– Redis çš„æ€§èƒ½ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ¢å¤å¤§æ•°æ®é›†æ—¶ï¼ŒRDB æ¯” AOF æ›´å¿«\u003c/strong\u003eã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eRDB çš„ç¼ºç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eå¦‚æœç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼Œå°†ä¼šä¸¢å¤±æœ€åä¸€æ¬¡åˆ›å»ºå¿«ç…§ä¹‹åçš„æ•°æ®\u003c/strong\u003eã€‚å¦‚æœä½ å¸Œæœ›åœ¨ Redis æ„å¤–åœæ­¢å·¥ä½œï¼ˆä¾‹å¦‚ç”µæºä¸­æ–­ï¼‰çš„æƒ…å†µä¸‹ä¸¢å¤±çš„æ•°æ®æœ€å°‘çš„è¯ï¼Œé‚£ä¹ˆ å¿«ç…§ä¸é€‚åˆä½ ã€‚è™½ç„¶ä½ å¯ä»¥é…ç½®ä¸åŒçš„ save æ—¶é—´ç‚¹(ä¾‹å¦‚æ¯éš” 5 åˆ†é’Ÿå¹¶ä¸”å¯¹æ•°æ®é›†æœ‰ 100 ä¸ªå†™çš„æ“ä½œ)ï¼Œæ˜¯ Redis è¦å®Œæ•´çš„ä¿å­˜æ•´ä¸ªæ•°æ®é›†æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¹é‡çš„å·¥ä½œï¼Œä½ é€šå¸¸ä¼šæ¯éš” 5 åˆ†é’Ÿæˆ–è€…æ›´ä¹…åšä¸€æ¬¡å®Œæ•´çš„ä¿å­˜ï¼Œä¸‡ä¸€åœ¨ Redis æ„å¤–å®•æœºï¼Œä½ å¯èƒ½ä¼šä¸¢å¤±å‡ åˆ†é’Ÿçš„æ•°æ®ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eå¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œä¿å­˜å¿«ç…§çš„æ—¶é—´ä¼šå¾ˆé•¿\u003c/strong\u003eã€‚å¿«ç…§éœ€è¦ç»å¸¸ fork å­è¿›ç¨‹æ¥ä¿å­˜æ•°æ®é›†åˆ°ç¡¬ç›˜ä¸Šã€‚å½“æ•°æ®é›†æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œfork çš„è¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ Redis åœ¨ä¸€äº›æ¯«ç§’çº§å†…ä¸èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚å¦‚æœæ•°æ®é›†å·¨å¤§å¹¶ä¸” CPU æ€§èƒ½ä¸æ˜¯å¾ˆå¥½çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æƒ…å†µä¼šæŒç»­ 1 ç§’ã€‚AOF ä¹Ÿéœ€è¦ forkï¼Œä½†æ˜¯ä½ å¯ä»¥è°ƒèŠ‚é‡å†™æ—¥å¿—æ–‡ä»¶çš„é¢‘ç‡æ¥æé«˜æ•°æ®é›†çš„è€ä¹…åº¦ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"RDB-çš„åˆ›å»º\"\u003e\u003ca href=\"#RDB-çš„åˆ›å»º\" class=\"headerlink\" title=\"RDB çš„åˆ›å»º\"\u003e\u003c/a\u003eRDB çš„åˆ›å»º\u003c/h3\u003e\u003cp\u003eæœ‰ä¸¤ä¸ª Redis å‘½ä»¤å¯ä»¥ç”¨äºç”Ÿæˆ RDB æ–‡ä»¶ï¼š\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://redis.io/commands/save\"\u003e\u003cstrong\u003e\u003ccode\u003eSAVE\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e å’Œ \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://redis.io/commands/bgsave\"\u003e\u003cstrong\u003e\u003ccode\u003eBGSAVE\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://redis.io/commands/save\"\u003e\u003cstrong\u003e\u003ccode\u003eSAVE\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e å‘½ä»¤ç”±æœåŠ¡å™¨è¿›ç¨‹ç›´æ¥æ‰§è¡Œä¿å­˜æ“ä½œï¼Œç›´åˆ° RDB åˆ›å»ºå®Œæˆä¸ºæ­¢ã€‚æ‰€ä»¥\u003cstrong\u003eè¯¥å‘½ä»¤â€œä¼šé˜»å¡â€æœåŠ¡å™¨\u003c/strong\u003eï¼Œåœ¨é˜»å¡æœŸé—´ï¼ŒæœåŠ¡å™¨ä¸èƒ½å“åº”ä»»ä½•å‘½ä»¤è¯·æ±‚ã€‚\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-bash\"\u003eSAVE\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026#34;OK\u0026#34;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://redis.io/commands/bgsave\"\u003e\u003cstrong\u003e\u003ccode\u003eBGSAVE\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e å‘½ä»¤ä¼š\u003cstrong\u003eâ€œæ´¾ç”Ÿâ€\u003c/strong\u003eï¼ˆforkï¼‰ä¸€ä¸ªå­è¿›ç¨‹ï¼Œç”±å­è¿›ç¨‹è´Ÿè´£åˆ›å»º RDB æ–‡ä»¶ï¼ŒæœåŠ¡å™¨è¿›ç¨‹ç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œæ‰€ä»¥\u003cstrong\u003eè¯¥å‘½ä»¤â€œä¸ä¼šé˜»å¡â€æœåŠ¡å™¨\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309172009198.png\" alt=\"BGSAVE æµç¨‹\"/\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-bash\"\u003eBGSAVE\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026#34;Background saving started\u0026#34;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cblockquote\u003e\n\u003cp\u003eğŸ”” \u003cstrong\u003eã€æ³¨æ„ã€‘\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤çš„å®ç°é‡‡ç”¨çš„æ˜¯å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Writeï¼Œç¼©å†™ä¸º CoWï¼‰ã€‚\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œ\u003ccode\u003eSAVE\u003c/code\u003eã€\u003ccode\u003eBGSAVE\u003c/code\u003eã€\u003ccode\u003eBGREWRITEAOF\u003c/code\u003e ä¸‰ä¸ªå‘½ä»¤ä¼šè¢«æ‹’ç»ï¼Œä»¥å…ä¸å½“å‰çš„ \u003ccode\u003eBGSAVE\u003c/code\u003e æ“ä½œäº§ç”Ÿç«æ€æ¡ä»¶ï¼Œé™ä½æ€§èƒ½ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eåˆ›å»º RDB çš„å·¥ä½œç”± \u003ccode\u003erdb.c/rdbSave\u003c/code\u003e å‡½æ•°å®Œæˆã€‚\u003c/p\u003e\n\u003ch3 id=\"RDB-çš„è½½å…¥\"\u003e\u003ca href=\"#RDB-çš„è½½å…¥\" class=\"headerlink\" title=\"RDB çš„è½½å…¥\"\u003e\u003c/a\u003eRDB çš„è½½å…¥\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eRDB æ–‡ä»¶çš„â€œè½½å…¥â€å·¥ä½œæ˜¯åœ¨æœåŠ¡å™¨â€œå¯åŠ¨â€æ—¶â€œè‡ªåŠ¨â€æ‰§è¡Œçš„\u003c/strong\u003eã€‚Redis å¹¶æ²¡æœ‰ä¸“é—¨ç”¨äºè½½å…¥ RDB æ–‡ä»¶çš„å‘½ä»¤ã€‚\u003c/p\u003e\n\u003cp\u003eæœåŠ¡å™¨è½½å…¥ RDB æ–‡ä»¶æœŸé—´ï¼Œä¼šä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°è½½å…¥å®Œæˆä¸ºæ­¢ã€‚\u003c/p\u003e\n\u003cp\u003eè½½å…¥ RDB çš„å·¥ä½œç”± \u003ccode\u003erdb.c/rdbLoad\u003c/code\u003e å‡½æ•°å®Œæˆã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ”” \u003cstrong\u003eã€æ³¨æ„ã€‘\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eå› ä¸º AOF çš„æ›´æ–°é¢‘ç‡é€šå¸¸æ¯” RDB çš„æ›´æ–°é¢‘ç‡é«˜ï¼Œæ‰€ä»¥ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eå¦‚æœæœåŠ¡å™¨å¼€äº† AOFï¼Œåˆ™æœåŠ¡å™¨ä¼šä¼˜å…ˆä½¿ç”¨ AOF æ¥è¿˜åŸæ•°æ®ã€‚\u003c/li\u003e\n\u003cli\u003eåªæœ‰åœ¨ AOF å¤„äºå…³é—­æ—¶ï¼ŒæœåŠ¡å™¨æ‰ä¼šä½¿ç”¨ RDB æ¥è¿˜åŸæ•°æ®ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"è‡ªåŠ¨é—´éš”ä¿å­˜\"\u003e\u003ca href=\"#è‡ªåŠ¨é—´éš”ä¿å­˜\" class=\"headerlink\" title=\"è‡ªåŠ¨é—´éš”ä¿å­˜\"\u003e\u003c/a\u003eè‡ªåŠ¨é—´éš”ä¿å­˜\u003c/h3\u003e\u003cp\u003eRedis æ”¯æŒé€šè¿‡åœ¨ \u003ccode\u003eredis.conf\u003c/code\u003e æ–‡ä»¶ä¸­é…ç½® \u003ccode\u003esave\u003c/code\u003e é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ \u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤ã€‚\u003ccode\u003esave\u003c/code\u003e é€‰é¡¹å¯ä»¥è®¾ç½®å¤šä¸ªä¿å­˜æ¡ä»¶ï¼Œåªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ªæ¡ä»¶è¢«æ»¡è¶³ï¼ŒæœåŠ¡å™¨å°±ä¼šæ‰§è¡Œ \u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤ã€‚\u003c/p\u003e\n\u003cp\u003eã€ç¤ºä¾‹ã€‘\u003ccode\u003eredis.conf\u003c/code\u003e ä¸­è‡ªåŠ¨ä¿å­˜é…ç½®\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003e900 ç§’å†…ï¼Œè‡³å°‘å¯¹æ•°æ®åº“è¿›è¡Œäº† 1 æ¬¡ä¿®æ”¹\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave 900 1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003e300 ç§’å†…ï¼Œè‡³å°‘å¯¹æ•°æ®åº“è¿›è¡Œäº† 10 æ¬¡ä¿®æ”¹\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave 300 10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta prompt_\"\u003e# \u003c/span\u003e\u003cspan class=\"language-bash\"\u003e60 ç§’å†…ï¼Œè‡³å°‘å¯¹æ•°æ®åº“è¿›è¡Œäº† 10000 æ¬¡ä¿®æ”¹\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave 60 10000\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eåªè¦æ»¡è¶³ä»¥ä¸Šä»»æ„æ¡ä»¶ï¼ŒRedis æœåŠ¡å°±ä¼šæ‰§è¡Œ \u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤ã€‚\u003c/p\u003e\n\u003cp\u003eè‡ªåŠ¨é—´éš”çš„ä¿å­˜æ¡ä»¶å®šä¹‰åœ¨ \u003ccode\u003eredis.h/redisServer\u003c/code\u003e ä¸­ï¼š\u003c/p\u003e\n\u003cfigure class=\"highlight c\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title\"\u003eredisServer\u003c/span\u003e {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// è®°å½•äº†ä¿å­˜æ¡ä»¶çš„æ•°ç»„\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title\"\u003esaveparam\u003c/span\u003e *\u003cspan class=\"title\"\u003esaveparams\u003c/span\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// è‡ªä»ä¸Šæ¬¡ SAVE æ‰§è¡Œä»¥æ¥ï¼Œæ•°æ®åº“è¢«ä¿®æ”¹çš„æ¬¡æ•°\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003elong\u003c/span\u003e \u003cspan class=\"type\"\u003elong\u003c/span\u003e dirty;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ä¸Šä¸€æ¬¡å®Œæˆ SAVE çš„æ—¶é—´\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003etime_t\u003c/span\u003e lastsave;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// æœåŠ¡å™¨çš„ä¿å­˜æ¡ä»¶ï¼ˆBGSAVE è‡ªåŠ¨æ‰§è¡Œçš„æ¡ä»¶ï¼‰\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title\"\u003esaveparam\u003c/span\u003e {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// å¤šå°‘ç§’ä¹‹å†…\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003etime_t\u003c/span\u003e seconds;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// å‘ç”Ÿå¤šå°‘æ¬¡ä¿®æ”¹\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003eint\u003c/span\u003e changes;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eredisServer ä¸­çš„ \u003ccode\u003esaveparams\u003c/code\u003e æ•°ç»„ç»´æŠ¤äº†å¤šä¸ªè‡ªåŠ¨é—´éš”ä¿å­˜æ¡ä»¶ã€‚\u003c/p\u003e\n\u003cp\u003eæœåŠ¡æ¯æ¬¡æˆåŠŸæ‰§è¡Œä¸€ä¸ªä¿®æ”¹å‘½ä»¤åï¼Œ\u003ccode\u003edirty\u003c/code\u003e è®¡æ•°å™¨å°±ä¼šåŠ  1ï¼›è€Œ \u003ccode\u003elastsave\u003c/code\u003e åˆ™è®°å½•äº†ä¸Šä¸€æ¬¡å®Œæˆ SAVE çš„æ—¶é—´ã€‚Redis ä¼šé€šè¿‡ä¸€ä¸ª \u003ccode\u003eserverCron\u003c/code\u003e å‡½æ•°å‘¨æœŸæ€§æ£€æŸ¥ \u003ccode\u003esave\u003c/code\u003e é€‰é¡¹æ‰€è®¾æ¡ä»¶æ˜¯å¦æ»¡è¶³ï¼Œå¦‚æœæ»¡è¶³ï¼Œåˆ™æ‰§è¡Œ \u003ccode\u003eBGSVAE\u003c/code\u003e å‘½ä»¤ã€‚\u003c/p\u003e\n\u003ch3 id=\"RDB-çš„æ–‡ä»¶ç»“æ„\"\u003e\u003ca href=\"#RDB-çš„æ–‡ä»¶ç»“æ„\" class=\"headerlink\" title=\"RDB çš„æ–‡ä»¶ç»“æ„\"\u003e\u003c/a\u003eRDB çš„æ–‡ä»¶ç»“æ„\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eRDB æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„â€œäºŒè¿›åˆ¶æ–‡ä»¶â€\u003c/strong\u003eï¼Œç”±å¤šä¸ªéƒ¨åˆ†ç»„æˆã€‚\u003c/p\u003e\n\u003cp\u003eå¯¹äºä¸åŒç±»å‹ï¼ˆSTRINGã€HASHã€LISTã€SETã€SORTED SETï¼‰çš„é”®å€¼å¯¹ï¼ŒRDB æ–‡ä»¶ä¼šä½¿ç”¨ä¸åŒçš„æ–¹å¼æ¥ä¿å­˜å®ƒä»¬ã€‚\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309171645336.png\" alt=\"RDB çš„æ–‡ä»¶ç»“æ„\"/\u003e\u003c/p\u003e\n\u003cp\u003eRedis æœ¬èº«æä¾›äº†ä¸€ä¸ª RDB æ–‡ä»¶æ£€æŸ¥å·¥å…· \u003ccode\u003eredis-check-dump\u003c/code\u003eã€‚\u003c/p\u003e\n\u003ch3 id=\"RDB-çš„é…ç½®\"\u003e\u003ca href=\"#RDB-çš„é…ç½®\" class=\"headerlink\" title=\"RDB çš„é…ç½®\"\u003e\u003c/a\u003eRDB çš„é…ç½®\u003c/h3\u003e\u003cp\u003eRedis RDB é»˜è®¤é…ç½®å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cfigure class=\"highlight apache\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003esave\u003c/span\u003e \u003cspan class=\"number\"\u003e900\u003c/span\u003e \u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003esave\u003c/span\u003e \u003cspan class=\"number\"\u003e300\u003c/span\u003e \u003cspan class=\"number\"\u003e10\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003esave\u003c/span\u003e \u003cspan class=\"number\"\u003e60\u003c/span\u003e \u003cspan class=\"number\"\u003e10000\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003estop\u003c/span\u003e-writes-\u003cspan class=\"literal\"\u003eon\u003c/span\u003e-bgsave-error yes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003erdbcompression\u003c/span\u003e yes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003erdbchecksum\u003c/span\u003e yes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003edbfilename\u003c/span\u003e dump.rdb\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attribute\"\u003edir\u003c/span\u003e ./\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eRedis çš„é…ç½®æ–‡ä»¶ \u003ccode\u003eredis.conf\u003c/code\u003e ä¸­ä¸ RDB æœ‰å…³çš„é€‰é¡¹ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003esave\u003c/code\u003e - Redis ä¼šæ ¹æ® \u003ccode\u003esave\u003c/code\u003e é€‰é¡¹ï¼Œè®©æœåŠ¡å™¨æ¯éš”ä¸€æ®µæ—¶é—´è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ \u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003estop-writes-on-bgsave-error\u003c/code\u003e - å½“ \u003ccode\u003eBGSAVE\u003c/code\u003e å‘½ä»¤å‡ºç°é”™è¯¯æ—¶åœæ­¢å†™ RDB æ–‡ä»¶\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003erdbcompression\u003c/code\u003e - RDB æ–‡ä»¶å¼€å¯å‹ç¼©åŠŸèƒ½\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003erdbchecksum\u003c/code\u003e - å¯¹ RDB æ–‡ä»¶è¿›è¡Œæ ¡éªŒ\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003edbfilename\u003c/code\u003e - RDB æ–‡ä»¶å\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003edir\u003c/code\u003e - RDB æ–‡ä»¶å’Œ AOF æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"AOF-æ—¥å¿—\"\u003e\u003ca href=\"#AOF-æ—¥å¿—\" class=\"headerlink\" title=\"AOF æ—¥å¿—\"\u003e\u003c/a\u003eAOF æ—¥å¿—\u003c/h2\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309150718055.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"AOF-ç®€ä»‹\"\u003e\u003ca href=\"#AOF-ç®€ä»‹\" class=\"headerlink\" title=\"AOF ç®€ä»‹\"\u003e\u003c/a\u003eAOF ç®€ä»‹\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eAOF(Append Only File)\u003c/code\u003e æ˜¯å°†æ‰€æœ‰å†™å‘½ä»¤è¿½åŠ å†™å…¥â€œæ—¥å¿—æ–‡ä»¶â€ï¼Œä»¥æ­¤æ¥è®°å½•æ•°æ®çš„å˜åŒ–ã€‚å½“æœåŠ¡å™¨é‡å¯æ—¶ï¼Œä¼šé‡æ–°è½½å…¥å’Œæ‰§è¡Œ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤ï¼Œå°±å¯ä»¥æ¢å¤åŸå§‹çš„æ•°æ®ã€‚AOF é€‚åˆä½œä¸º\u003cstrong\u003eâ€œçƒ­å¤‡â€\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003eAOF å¯ä»¥é€šè¿‡ \u003ccode\u003eappendonly yes\u003c/code\u003e é…ç½®é€‰é¡¹æ¥å¼€å¯ã€‚\u003c/p\u003e\n\u003ch3 id=\"AOF-çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\"\u003e\u003ca href=\"#AOF-çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\" class=\"headerlink\" title=\"AOF çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\"\u003e\u003c/a\u003eAOF çš„ä¼˜ç‚¹å’Œç¼ºç‚¹\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eAOF çš„ä¼˜ç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eå¦‚æœç³»ç»Ÿå‘ç”Ÿæ•…éšœï¼ŒAOF ä¸¢å¤±æ•°æ®æ¯” RDB å°‘\u003c/strong\u003eã€‚ä½ å¯ä»¥ä½¿ç”¨ä¸åŒçš„ fsync ç­–ç•¥ï¼šæ—  fsyncï¼›æ¯ç§’ fsyncï¼›æ¯æ¬¡å†™çš„æ—¶å€™ fsyncã€‚ä½¿ç”¨é»˜è®¤çš„æ¯ç§’ fsync ç­–ç•¥ï¼ŒRedis çš„æ€§èƒ½ä¾ç„¶å¾ˆå¥½(fsync æ˜¯ç”±åå°çº¿ç¨‹è¿›è¡Œå¤„ç†çš„,ä¸»çº¿ç¨‹ä¼šå°½åŠ›å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚)ï¼Œä¸€æ—¦å‡ºç°æ•…éšœï¼Œä½ æœ€å¤šä¸¢å¤± 1 ç§’çš„æ•°æ®ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAOF æ–‡ä»¶å¯ä¿®å¤\u003c/strong\u003e - AOF æ–‡ä»¶æ˜¯ä¸€ä¸ªåªè¿›è¡Œè¿½åŠ çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦å†™å…¥ seekï¼Œå³ä½¿ç”±äºæŸäº›åŸå› (ç£ç›˜ç©ºé—´å·²æ»¡ï¼Œå†™çš„è¿‡ç¨‹ä¸­å®•æœºç­‰ç­‰)æœªæ‰§è¡Œå®Œæ•´çš„å†™å…¥å‘½ä»¤ï¼Œä½ ä¹Ÿä¹Ÿå¯ä½¿ç”¨ redis-check-aof å·¥å…·ä¿®å¤è¿™äº›é—®é¢˜ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAOF æ–‡ä»¶å¯å‹ç¼©\u003c/strong\u003eã€‚Redis å¯ä»¥åœ¨ AOF æ–‡ä»¶ä½“ç§¯å˜å¾—è¿‡å¤§æ—¶ï¼Œè‡ªåŠ¨åœ°åœ¨åå°å¯¹ AOF è¿›è¡Œé‡å†™ï¼šé‡å†™åçš„æ–° AOF æ–‡ä»¶åŒ…å«äº†æ¢å¤å½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°å‘½ä»¤é›†åˆã€‚æ•´ä¸ªé‡å†™æ“ä½œæ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œå› ä¸º Redis åœ¨åˆ›å»ºæ–° AOF æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»§ç»­å°†å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ AOF æ–‡ä»¶é‡Œé¢ï¼Œå³ä½¿é‡å†™è¿‡ç¨‹ä¸­å‘ç”Ÿåœæœºï¼Œç°æœ‰çš„ AOF æ–‡ä»¶ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚è€Œä¸€æ—¦æ–° AOF æ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼ŒRedis å°±ä¼šä»æ—§ AOF æ–‡ä»¶åˆ‡æ¢åˆ°æ–° AOF æ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¯¹æ–° AOF æ–‡ä»¶è¿›è¡Œè¿½åŠ æ“ä½œã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eAOF æ–‡ä»¶å¯è¯»\u003c/strong\u003e - AOF æ–‡ä»¶æœ‰åºåœ°ä¿å­˜äº†å¯¹æ•°æ®åº“æ‰§è¡Œçš„æ‰€æœ‰å†™å…¥æ“ä½œï¼Œè¿™äº›å†™å…¥æ“ä½œä»¥ Redis å‘½ä»¤çš„æ ¼å¼ä¿å­˜ã€‚å› æ­¤ AOF æ–‡ä»¶çš„å†…å®¹éå¸¸å®¹æ˜“è¢«äººè¯»æ‡‚ï¼Œå¯¹æ–‡ä»¶è¿›è¡Œåˆ†æï¼ˆparseï¼‰ä¹Ÿå¾ˆè½»æ¾ã€‚ å¯¼å‡ºï¼ˆexportï¼‰ AOF æ–‡ä»¶ä¹Ÿéå¸¸ç®€å•ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ ä¸å°å¿ƒæ‰§è¡Œäº† FLUSHALL å‘½ä»¤ï¼Œä½†åªè¦ AOF æ–‡ä»¶æœªè¢«é‡å†™ï¼Œé‚£ä¹ˆåªè¦åœæ­¢æœåŠ¡å™¨ï¼Œç§»é™¤ AOF æ–‡ä»¶æœ«å°¾çš„ FLUSHALL å‘½ä»¤ï¼Œå¹¶é‡å¯ Redis ï¼Œå°±å¯ä»¥å°†æ•°æ®é›†æ¢å¤åˆ° FLUSHALL æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cstrong\u003eAOF çš„ç¼ºç‚¹\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eAOF æ–‡ä»¶ä½“ç§¯ä¸€èˆ¬æ¯” RDB å¤§\u003c/strong\u003e - å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼ŒAOF æ–‡ä»¶çš„ä½“ç§¯é€šå¸¸è¦å¤§äº RDB æ–‡ä»¶çš„ä½“ç§¯ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ¢å¤å¤§æ•°æ®é›†æ—¶ï¼ŒAOF æ¯” RDB æ…¢ã€‚\u003c/strong\u003e - æ ¹æ®æ‰€ä½¿ç”¨çš„ fsync ç­–ç•¥ï¼ŒAOF çš„é€Ÿåº¦å¯èƒ½ä¼šæ…¢äºå¿«ç…§ã€‚åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ç§’ fsync çš„æ€§èƒ½ä¾ç„¶éå¸¸é«˜ï¼Œè€Œå…³é—­ fsync å¯ä»¥è®© AOF çš„é€Ÿåº¦å’Œå¿«ç…§ä¸€æ ·å¿«ï¼Œå³ä½¿åœ¨é«˜è´Ÿè·ä¹‹ä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ä¸è¿‡åœ¨å¤„ç†å·¨å¤§çš„å†™å…¥è½½å…¥æ—¶ï¼Œå¿«ç…§å¯ä»¥æä¾›æ›´æœ‰ä¿è¯çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼ˆlatencyï¼‰ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"AOF-çš„åˆ›å»º\"\u003e\u003ca href=\"#AOF-çš„åˆ›å»º\" class=\"headerlink\" title=\"AOF çš„åˆ›å»º\"\u003e\u003c/a\u003eAOF çš„åˆ›å»º\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003eRedis å‘½ä»¤è¯·æ±‚ä¼šå…ˆä¿å­˜åˆ° AOF ç¼“å†²åŒºï¼Œå†å®šæœŸå†™å…¥å¹¶åŒæ­¥åˆ° AOF æ–‡ä»¶\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003eAOF çš„å®ç°å¯ä»¥åˆ†ä¸ºå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ã€æ–‡ä»¶åŒæ­¥ï¼ˆsyncï¼‰ä¸‰ä¸ªæ­¥éª¤ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eå‘½ä»¤è¿½åŠ \u003c/strong\u003e - å½“ Redis æœåŠ¡å™¨å¼€å¯ AOF åŠŸèƒ½æ—¶ï¼ŒæœåŠ¡å™¨åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤åï¼Œä¼šä»¥ Redis å‘½ä»¤åè®®æ ¼å¼å°†è¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ° AOF ç¼“å†²åŒºçš„æœ«å°¾ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eæ–‡ä»¶å†™å…¥\u003c/strong\u003eå’Œ\u003cstrong\u003eæ–‡ä»¶åŒæ­¥\u003c/strong\u003e\u003cul\u003e\n\u003cli\u003eRedis çš„æœåŠ¡å™¨è¿›ç¨‹å°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œè¿™ä¸ªå¾ªç¯ä¸­çš„æ–‡ä»¶äº‹ä»¶è´Ÿè´£æ¥æ”¶å®¢æˆ·ç«¯çš„å‘½ä»¤è¯·æ±‚ï¼Œä»¥åŠå‘å®¢æˆ·ç«¯å‘é€å‘½ä»¤å›å¤ã€‚è€Œæ—¶é—´äº‹ä»¶åˆ™è´Ÿè´£æ‰§è¡Œæƒ³ \u003ccode\u003eserverCron\u003c/code\u003e è¿™æ ·çš„å®šæ—¶è¿è¡Œçš„å‡½æ•°ã€‚\u003c/li\u003e\n\u003cli\u003eå› ä¸ºæœåŠ¡å™¨åœ¨å¤„ç†æ–‡ä»¶äº‹ä»¶æ—¶å¯èƒ½ä¼šæ‰§è¡Œå†™å‘½ä»¤ï¼Œè¿™äº›å†™å‘½ä»¤ä¼šè¢«è¿½åŠ åˆ° AOF ç¼“å†²åŒºï¼ŒæœåŠ¡å™¨æ¯æ¬¡ç»“æŸäº‹ä»¶å¾ªç¯å‰ï¼Œéƒ½ä¼šæ ¹æ® \u003ccode\u003eappendfsync\u003c/code\u003e é€‰é¡¹æ¥åˆ¤æ–­ AOF ç¼“å†²åŒºå†…å®¹æ˜¯å¦éœ€è¦å†™å…¥å’ŒåŒæ­¥åˆ° AOF æ–‡ä»¶ä¸­ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003eappendfsync\u003c/code\u003e ä¸åŒé€‰é¡¹å†³å®šäº†ä¸åŒçš„æŒä¹…åŒ–è¡Œä¸ºï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003ealways\u003c/code\u003e\u003c/strong\u003e - å°† AOF ç¼“å†²åŒºä¸­æ‰€æœ‰å†…å®¹å†™å…¥å¹¶åŒæ­¥åˆ° AOF æ–‡ä»¶ã€‚è¿™ç§æ–¹å¼æ˜¯æœ€æ•°æ®æœ€å®‰å…¨çš„ï¼Œä½†ä¹Ÿæ˜¯æ€§èƒ½æœ€å·®çš„ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eno\u003c/code\u003e\u003c/strong\u003e - å°† AOF ç¼“å†²åŒºæ‰€æœ‰å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œä½†å¹¶ä¸å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿå†³å®šã€‚è¿™ç§æ–¹å¼æ˜¯æ•°æ®æœ€ä¸å®‰å…¨çš„ï¼Œä¸€æ—¦å‡ºç°æ•…éšœï¼Œæœªæ¥å¾—åŠåŒæ­¥çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eeverysec\u003c/code\u003e\u003c/strong\u003e - \u003ccode\u003eappendfsync\u003c/code\u003e é»˜è®¤é€‰é¡¹ã€‚å°† AOF ç¼“å†²åŒºæ‰€æœ‰å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå¦‚æœä¸Šæ¬¡åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶é—´è·ç¦»ç°åœ¨è¶…è¿‡ä¸€ç§’é’Ÿï¼Œé‚£ä¹ˆå†æ¬¡å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªåŒæ­¥æ“ä½œæ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨è´Ÿè´£æ‰§è¡Œçš„ã€‚è¿™å¼ æ–¹å¼æ˜¯å‰é¢ä¸¤ç§çš„è¿™ç§æ–¹æ¡ˆâ€”â€”æ€§èƒ½è¶³å¤Ÿå¥½ï¼Œä¸”å³ä½¿å‡ºç°æ•…éšœï¼Œä»…ä¸¢å¤±ä¸€ç§’é’Ÿå†…çš„æ•°æ®ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003eappendfsync\u003c/code\u003e é€‰é¡¹çš„ä¸åŒå€¼å¯¹ AOF æŒä¹…åŒ–åŠŸèƒ½çš„å®‰å…¨æ€§ã€ä»¥åŠ Redis æœåŠ¡å™¨çš„æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚\u003c/p\u003e\n\u003ch3 id=\"AOF-çš„è½½å…¥\"\u003e\u003ca href=\"#AOF-çš„è½½å…¥\" class=\"headerlink\" title=\"AOF çš„è½½å…¥\"\u003e\u003c/a\u003eAOF çš„è½½å…¥\u003c/h3\u003e\u003cp\u003eå› ä¸º AOF æ–‡ä»¶ä¸­åŒ…å«äº†é‡å»ºæ•°æ®åº“æ‰€éœ€çš„æ‰€æœ‰å†™å‘½ä»¤ï¼Œæ‰€ä»¥æœåŠ¡å™¨åªè¦è½½å…¥å¹¶æ‰§è¡Œä¸€é AOF æ–‡ä»¶ä¸­ä¿å­˜çš„å†™å‘½ä»¤ï¼Œå°±å¯ä»¥è¿˜åŸæœåŠ¡å™¨å…³é—­å‰çš„æ•°æ®åº“çŠ¶æ€ã€‚\u003c/p\u003e\n\u003cp\u003eAOF è½½å…¥è¿‡ç¨‹å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eæœåŠ¡å™¨å¯åŠ¨è½½å…¥ç¨‹åºã€‚\u003c/li\u003e\n\u003cli\u003eåˆ›å»ºä¸€ä¸ªä¼ªå®¢æˆ·ç«¯ã€‚å› ä¸º Redis å‘½ä»¤åªèƒ½åœ¨å®¢æˆ·ç«¯ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦åˆ›å»ºä¸€ä¸ªä¼ªå®¢æˆ·ç«¯æ¥è½½å…¥ã€æ‰§è¡Œ AOF æ–‡ä»¶ä¸­è®°å½•çš„å‘½ä»¤ã€‚\u003c/li\u003e\n\u003cli\u003eä» AOF æ–‡ä»¶ä¸­åˆ†æå¹¶è¯»å–ä¸€æ¡å†™å‘½ä»¤ã€‚\u003c/li\u003e\n\u003cli\u003eä½¿ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå†™å‘½ä»¤ã€‚\u003c/li\u003e\n\u003cli\u003eå¾ªç¯æ‰§è¡Œæ­¥éª¤ 3ã€4ï¼Œç›´åˆ°æ‰€æœ‰å†™å‘½ä»¤éƒ½è¢«å¤„ç†å®Œæ¯•ä¸ºæ­¢ã€‚\u003c/li\u003e\n\u003cli\u003eè½½å…¥å®Œæ¯•ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309171705818.png\" alt=\"AOF æ–‡ä»¶è½½å…¥\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"AOF-çš„é‡å†™\"\u003e\u003ca href=\"#AOF-çš„é‡å†™\" class=\"headerlink\" title=\"AOF çš„é‡å†™\"\u003e\u003c/a\u003eAOF çš„é‡å†™\u003c/h3\u003e\u003cp\u003eéšç€ Redis ä¸æ–­è¿è¡Œï¼ŒAOF çš„ä½“ç§¯ä¹Ÿä¼šä¸æ–­å¢é•¿ï¼Œè¿™å°†å¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAOF è€—å°½ç£ç›˜å¯ç”¨ç©ºé—´ã€‚\u003c/li\u003e\n\u003cli\u003eRedis é‡å¯åéœ€è¦æ‰§è¡Œ AOF æ–‡ä»¶è®°å½•çš„æ‰€æœ‰å†™å‘½ä»¤æ¥è¿˜åŸæ•°æ®é›†ï¼Œå¦‚æœ AOF è¿‡å¤§ï¼Œåˆ™è¿˜åŸæ“ä½œæ‰§è¡Œçš„æ—¶é—´å°±ä¼šéå¸¸é•¿ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eä¸ºäº†è§£å†³ AOF ä½“ç§¯è†¨èƒ€é—®é¢˜ï¼ŒRedis æä¾›äº† AOF é‡å†™åŠŸèƒ½ï¼Œæ¥å¯¹ AOF æ–‡ä»¶è¿›è¡Œå‹ç¼©ã€‚\u003cstrong\u003eAOF é‡å†™å¯ä»¥äº§ç”Ÿä¸€ä¸ªæ–°çš„ AOF æ–‡ä»¶ï¼Œè¿™ä¸ªæ–°çš„ AOF æ–‡ä»¶å’ŒåŸæ¥çš„ AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ï¼Œä½†ä½“ç§¯æ›´å°\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003cp\u003eAOF é‡å†™å¹¶éè¯»å–å’Œåˆ†æç°æœ‰ AOF æ–‡ä»¶çš„å†…å®¹ï¼Œè€Œæ˜¯ç›´æ¥ä»æ•°æ®åº“ä¸­è¯»å–å½“å‰çš„æ•°æ®åº“çŠ¶æ€ã€‚å³\u003cstrong\u003eä»æ•°æ®åº“ä¸­è¯»å–é”®çš„å½“å‰å€¼ï¼Œç„¶åç”¨ä¸€æ¡å‘½ä»¤å»è®°å½•è¯¥é”®å€¼å¯¹\u003c/strong\u003eï¼Œä»¥æ­¤ä»£æ›¿ä¹‹å‰å¯èƒ½å­˜åœ¨å†—ä½™çš„å‘½ä»¤ã€‚\u003c/p\u003e\n\u003ch3 id=\"AOF-åå°é‡å†™\"\u003e\u003ca href=\"#AOF-åå°é‡å†™\" class=\"headerlink\" title=\"AOF åå°é‡å†™\"\u003e\u003c/a\u003eAOF åå°é‡å†™\u003c/h3\u003e\u003cp\u003eä½œä¸ºä¸€ç§è¾…åŠ©æ€§åŠŸèƒ½ï¼Œæ˜¾ç„¶ Redis å¹¶ä¸æƒ³åœ¨ AOF é‡å†™æ—¶é˜»å¡ Redis æœåŠ¡æ¥æ”¶å…¶ä»–å‘½ä»¤ã€‚å› æ­¤ï¼ŒRedis å†³å®šé€šè¿‡ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å‘½ä»¤åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œç„¶åç”±å­è¿›ç¨‹è´Ÿè´£å¯¹ AOF æ–‡ä»¶è¿›è¡Œé‡å†™ï¼Œè¿™ä¸ \u003ccode\u003eBGSAVE\u003c/code\u003e åŸç†ç±»ä¼¼ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eåœ¨æ‰§è¡Œ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å‘½ä»¤æ—¶ï¼ŒRedis æœåŠ¡å™¨ä¼šç»´æŠ¤ä¸€ä¸ª AOF é‡å†™ç¼“å†²åŒºã€‚å½“ AOF é‡å†™å­è¿›ç¨‹å¼€å§‹å·¥ä½œåï¼ŒRedis æ¯æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ï¼Œä¼šåŒæ—¶å°†è¿™ä¸ªå‘½ä»¤å‘é€ç»™ AOF ç¼“å†²åŒºå’Œ AOF é‡å†™ç¼“å†²åŒºã€‚\u003c/li\u003e\n\u003cli\u003eç”±äºå½¼æ­¤ä¸æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­å·¥ä½œï¼ŒAOF é‡å†™ä¸å½±å“ AOF å†™å…¥å’ŒåŒæ­¥ã€‚å½“å­è¿›ç¨‹å®Œæˆåˆ›å»ºæ–° AOF æ–‡ä»¶çš„å·¥ä½œä¹‹åï¼ŒæœåŠ¡å™¨ä¼šå°†é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–° AOF æ–‡ä»¶çš„æœ«å°¾ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ã€‚\u003c/li\u003e\n\u003cli\u003eæœ€åï¼ŒæœåŠ¡å™¨ç”¨æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢å°±çš„ AOF æ–‡ä»¶ï¼Œä»¥æ­¤æ¥å®Œæˆ AOF é‡å†™æ“ä½œã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/dunwu/images/master/snap/202309171957918.png\" alt=\"BGREWRITEAOF æµç¨‹\"/\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å‘½ä»¤çš„å®ç°é‡‡ç”¨çš„æ˜¯å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Writeï¼Œç¼©å†™ä¸º CoWï¼‰ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eå¯ä»¥é€šè¿‡è®¾ç½® \u003ccode\u003eauto-aof-rewrite-percentage\u003c/code\u003e å’Œ \u003ccode\u003eauto-aof-rewrite-min-size\u003c/code\u003eï¼Œä½¿å¾— Redis åœ¨æ»¡è¶³æ¡ä»¶æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003eã€‚\u003c/p\u003e\n\u003cp\u003eå‡è®¾é…ç½®å¦‚ä¸‹ï¼š\u003c/p\u003e\n\u003cfigure class=\"highlight arduino\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e-aof-rewrite-percentage \u003cspan class=\"number\"\u003e100\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e-aof-rewrite-min-size \u003cspan class=\"number\"\u003e64\u003c/span\u003emb\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eè¡¨æ˜ï¼Œå½“ AOF å¤§äº \u003ccode\u003e64MB\u003c/code\u003eï¼Œä¸” AOF ä½“ç§¯æ¯”ä¸Šä¸€æ¬¡é‡å†™åçš„ä½“ç§¯å¤§äº†è‡³å°‘ \u003ccode\u003e100%\u003c/code\u003e æ—¶ï¼Œæ‰§è¡Œ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003eã€‚\u003c/p\u003e\n\u003ch3 id=\"AOF-çš„é…ç½®\"\u003e\u003ca href=\"#AOF-çš„é…ç½®\" class=\"headerlink\" title=\"AOF çš„é…ç½®\"\u003e\u003c/a\u003eAOF çš„é…ç½®\u003c/h3\u003e\u003cp\u003eAOF çš„é»˜è®¤é…ç½®ï¼š\u003c/p\u003e\n\u003cfigure class=\"highlight coq\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eappendonly no\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eappendfsync everysec\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eno-appendfsync-on-\u003cspan class=\"built_in\"\u003erewrite\u003c/span\u003e no\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eauto\u003c/span\u003e-aof-\u003cspan class=\"built_in\"\u003erewrite\u003c/span\u003e-percentage \u003cspan class=\"number\"\u003e100\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eauto\u003c/span\u003e-aof-\u003cspan class=\"built_in\"\u003erewrite\u003c/span\u003e-min-size \u003cspan class=\"number\"\u003e64\u003c/span\u003emb\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eAOF æŒä¹…åŒ–é€šè¿‡åœ¨ \u003ccode\u003eredis.conf\u003c/code\u003e ä¸­çš„ \u003ccode\u003eappendonly yes\u003c/code\u003e é…ç½®é€‰é¡¹æ¥å¼€å¯ã€‚\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eappendonly\u003c/code\u003e\u003c/strong\u003e - å¼€å¯ AOF åŠŸèƒ½ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eappendfilename\u003c/code\u003e\u003c/strong\u003e - AOF æ–‡ä»¶åã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eappendfsync\u003c/code\u003e\u003c/strong\u003e - ç”¨äºè®¾ç½®åŒæ­¥é¢‘ç‡ï¼Œå®ƒæœ‰ä»¥ä¸‹å¯é€‰é¡¹ï¼š\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003ealways\u003c/code\u003e\u003c/strong\u003e - æ¯ä¸ª Redis å†™å‘½ä»¤éƒ½è¦åŒæ­¥å†™å…¥ç¡¬ç›˜ã€‚è¿™æ ·åšä¼šä¸¥é‡é™ä½ Redis çš„é€Ÿåº¦ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eeverysec\u003c/code\u003e\u003c/strong\u003e - æ¯ç§’æ‰§è¡Œä¸€æ¬¡åŒæ­¥ï¼Œæ˜¾ç¤ºåœ°å°†å¤šä¸ªå†™å‘½ä»¤åŒæ­¥åˆ°ç¡¬ç›˜ã€‚ä¸ºäº†å…¼é¡¾æ•°æ®å®‰å…¨å’Œå†™å…¥æ€§èƒ½ï¼Œæ¨èä½¿ç”¨ \u003ccode\u003eappendfsync everysec\u003c/code\u003e é€‰é¡¹ã€‚Redis æ¯ç§’åŒæ­¥ä¸€æ¬¡ AOF æ–‡ä»¶æ—¶çš„æ€§èƒ½å’Œä¸ä½¿ç”¨ä»»ä½•æŒä¹…åŒ–ç‰¹æ€§æ—¶çš„æ€§èƒ½ç›¸å·®æ— å‡ ã€‚\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eno\u003c/code\u003e\u003c/strong\u003e - è®©æ“ä½œç³»ç»Ÿæ¥å†³å®šåº”è¯¥ä½•æ—¶è¿›è¡ŒåŒæ­¥ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eno-appendfsync-on-rewrite\u003c/code\u003e - AOF é‡å†™æ—¶ä¸æ”¯æŒè¿½åŠ å‘½ä»¤ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eauto-aof-rewrite-percentage\u003c/code\u003e - AOF é‡å†™ç™¾åˆ†æ¯”ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eauto-aof-rewrite-min-size\u003c/code\u003e - AOF é‡å†™æ–‡ä»¶çš„æœ€å°å¤§å°ã€‚\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edir\u003c/code\u003e - RDB æ–‡ä»¶å’Œ AOF æ–‡ä»¶çš„å­˜å‚¨è·¯å¾„ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"RDB-å’Œ-AOF\"\u003e\u003ca href=\"#RDB-å’Œ-AOF\" class=\"headerlink\" title=\"RDB å’Œ AOF\"\u003e\u003c/a\u003eRDB å’Œ AOF\u003c/h2\u003e\u003cblockquote\u003e\n\u003cp\u003eå½“ Redis å¯åŠ¨æ—¶ï¼Œ å¦‚æœ RDB å’Œ AOF åŠŸèƒ½éƒ½å¼€å¯äº†ï¼Œé‚£ä¹ˆç¨‹åºä¼šä¼˜å…ˆä½¿ç”¨ AOF æ–‡ä»¶æ¥æ¢å¤æ•°æ®é›†ï¼Œå› ä¸º AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®é€šå¸¸æ˜¯æœ€å®Œæ•´çš„ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–\"\u003e\u003ca href=\"#å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–\" class=\"headerlink\" title=\"å¦‚ä½•é€‰æ‹©æŒä¹…åŒ–\"\u003e\u003c/a\u003eå¦‚ä½•é€‰æ‹©æŒä¹…åŒ–\u003c/h3\u003e\u003cul\u003e\n\u003cli\u003eå¦‚æœä¸å…³å¿ƒæ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥ä¸æŒä¹…åŒ–ã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœå¯ä»¥æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥åªä½¿ç”¨ RDBã€‚\u003c/li\u003e\n\u003cli\u003eå¦‚æœä¸èƒ½æ‰¿å—æ•°åˆ†é’Ÿä»¥å†…çš„æ•°æ®ä¸¢å¤±ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ RDB å’Œ AOFã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæœ‰å¾ˆå¤šç”¨æˆ·éƒ½åªä½¿ç”¨ AOF æŒä¹…åŒ–ï¼Œ ä½†å¹¶ä¸æ¨èè¿™ç§æ–¹å¼ï¼š å› ä¸ºå®šæ—¶ç”Ÿæˆ RDB å¿«ç…§ï¼ˆsnapshotï¼‰éå¸¸ä¾¿äºè¿›è¡Œæ•°æ®åº“å¤‡ä»½ï¼Œå¹¶ä¸”å¿«ç…§æ¢å¤æ•°æ®é›†çš„é€Ÿåº¦ä¹Ÿè¦æ¯” AOF æ¢å¤çš„é€Ÿåº¦è¦å¿«ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œä½¿ç”¨å¿«ç…§è¿˜å¯ä»¥é¿å…ä¹‹å‰æåˆ°çš„ AOF ç¨‹åºçš„ bug ã€‚\u003c/p\u003e\n\u003ch3 id=\"RDB-åˆ‡æ¢ä¸º-AOF\"\u003e\u003ca href=\"#RDB-åˆ‡æ¢ä¸º-AOF\" class=\"headerlink\" title=\"RDB åˆ‡æ¢ä¸º AOF\"\u003e\u003c/a\u003eRDB åˆ‡æ¢ä¸º AOF\u003c/h3\u003e\u003cp\u003eåœ¨ Redis 2.2 æˆ–ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ä¸é‡å¯çš„æƒ…å†µä¸‹ï¼Œä» RDB åˆ‡æ¢ä¸º AOF ï¼š\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eä¸ºæœ€æ–°çš„ dump.rdb æ–‡ä»¶åˆ›å»ºä¸€ä¸ªå¤‡ä»½ã€‚\u003c/li\u003e\n\u003cli\u003eå°†å¤‡ä»½æ”¾åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ã€‚\u003c/li\u003e\n\u003cli\u003eæ‰§è¡Œä»¥ä¸‹ä¸¤æ¡å‘½ä»¤:\u003c/li\u003e\n\u003cli\u003eredis-cli config set appendonly yes\u003c/li\u003e\n\u003cli\u003eredis-cli config set save\u003c/li\u003e\n\u003cli\u003eç¡®ä¿å†™å‘½ä»¤ä¼šè¢«æ­£ç¡®åœ°è¿½åŠ åˆ° AOF æ–‡ä»¶çš„æœ«å°¾ã€‚\u003c/li\u003e\n\u003cli\u003eæ‰§è¡Œçš„ç¬¬ä¸€æ¡å‘½ä»¤å¼€å¯äº† AOF åŠŸèƒ½ï¼š Redis ä¼šé˜»å¡ç›´åˆ°åˆå§‹ AOF æ–‡ä»¶åˆ›å»ºå®Œæˆä¸ºæ­¢ï¼Œ ä¹‹å Redis ä¼šç»§ç»­å¤„ç†å‘½ä»¤è¯·æ±‚ï¼Œ å¹¶å¼€å§‹å°†å†™å…¥å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æœ«å°¾ã€‚\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eæ‰§è¡Œçš„ç¬¬äºŒæ¡å‘½ä»¤ç”¨äºå…³é—­å¿«ç…§åŠŸèƒ½ã€‚ è¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ï¼Œ å¦‚æœä½ æ„¿æ„çš„è¯ï¼Œ ä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨å¿«ç…§å’Œ AOF è¿™ä¸¤ç§æŒä¹…åŒ–åŠŸèƒ½ã€‚\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eğŸ”” é‡è¦ï¼šåˆ«å¿˜äº†åœ¨ \u003ccode\u003eredis.conf\u003c/code\u003e ä¸­æ‰“å¼€ AOF åŠŸèƒ½ï¼å¦åˆ™çš„è¯ï¼ŒæœåŠ¡å™¨é‡å¯ä¹‹åï¼Œä¹‹å‰é€šè¿‡ CONFIG SET è®¾ç½®çš„é…ç½®å°±ä¼šè¢«é—å¿˜ï¼Œç¨‹åºä¼šæŒ‰åŸæ¥çš„é…ç½®æ¥å¯åŠ¨æœåŠ¡å™¨ã€‚\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"AOF-å’Œ-RDB-çš„ç›¸äº’ä½œç”¨\"\u003e\u003ca href=\"#AOF-å’Œ-RDB-çš„ç›¸äº’ä½œç”¨\" class=\"headerlink\" title=\"AOF å’Œ RDB çš„ç›¸äº’ä½œç”¨\"\u003e\u003c/a\u003eAOF å’Œ RDB çš„ç›¸äº’ä½œç”¨\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eBGSAVE\u003c/code\u003e å’Œ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å‘½ä»¤ä¸å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚è¿™æ˜¯ä¸ºäº†é¿å…ä¸¤ä¸ª Redis åå°è¿›ç¨‹åŒæ—¶å¯¹ç£ç›˜è¿›è¡Œå¤§é‡çš„ I/O æ“ä½œã€‚\u003c/p\u003e\n\u003cp\u003eå¦‚æœ \u003ccode\u003eBGSAVE\u003c/code\u003e æ­£åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”ç”¨æˆ·æ˜¾ç¤ºåœ°è°ƒç”¨ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å‘½ä»¤ï¼Œé‚£ä¹ˆæœåŠ¡å™¨å°†å‘ç”¨æˆ·å›å¤ä¸€ä¸ª OK çŠ¶æ€ï¼Œå¹¶å‘ŠçŸ¥ç”¨æˆ·ï¼Œ\u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å·²ç»è¢«é¢„å®šæ‰§è¡Œã€‚ä¸€æ—¦ \u003ccode\u003eBGSAVE\u003c/code\u003e æ‰§è¡Œå®Œæ¯•ï¼Œ \u003ccode\u003eBGREWRITEAOF\u003c/code\u003e å°±ä¼šæ­£å¼å¼€å§‹ã€‚\u003c/p\u003e\n\u003ch3 id=\"æ··åˆæŒä¹…åŒ–\"\u003e\u003ca href=\"#æ··åˆæŒä¹…åŒ–\" class=\"headerlink\" title=\"æ··åˆæŒä¹…åŒ–\"\u003e\u003c/a\u003eæ··åˆæŒä¹…åŒ–\u003c/h3\u003e\u003cp\u003eRedis 4.0 æå‡ºäº†\u003cstrong\u003eæ··åˆä½¿ç”¨ AOF æ—¥å¿—å’Œå†…å­˜å¿«ç…§\u003c/strong\u003eï¼Œä¹Ÿå«æ··åˆæŒä¹…åŒ–ï¼Œæ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚\u003c/p\u003e\n\u003cp\u003eæ··åˆæŒä¹…åŒ–å·¥ä½œåœ¨ \u003cstrong\u003eAOF æ—¥å¿—é‡å†™è¿‡ç¨‹\u003c/strong\u003eï¼Œå½“å¼€å¯äº†æ··åˆæŒä¹…åŒ–æ—¶ï¼Œåœ¨ AOF é‡å†™æ—¥å¿—æ—¶ï¼Œfork å‡ºæ¥çš„é‡å†™å­è¿›ç¨‹ä¼šå…ˆå°†ä¸ä¸»çº¿ç¨‹å…±äº«çš„å†…å­˜æ•°æ®ä»¥ RDB æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œç„¶åä¸»çº¿ç¨‹å¤„ç†çš„æ“ä½œå‘½ä»¤ä¼šè¢«è®°å½•åœ¨é‡å†™ç¼“å†²åŒºé‡Œï¼Œé‡å†™ç¼“å†²åŒºé‡Œçš„å¢é‡å‘½ä»¤ä¼šä»¥ AOF æ–¹å¼å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå†™å…¥å®Œæˆåé€šçŸ¥ä¸»è¿›ç¨‹å°†æ–°çš„å«æœ‰ RDB æ ¼å¼å’Œ AOF æ ¼å¼çš„ AOF æ–‡ä»¶æ›¿æ¢æ—§çš„çš„ AOF æ–‡ä»¶ã€‚\u003c/p\u003e\n\u003cp\u003eä¹Ÿå°±æ˜¯è¯´ï¼Œä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„\u003cstrong\u003eå‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®\u003c/strong\u003eã€‚\u003c/p\u003e\n\u003ch2 id=\"Redis-å¤‡ä»½\"\u003e\u003ca href=\"#Redis-å¤‡ä»½\" class=\"headerlink\" title=\"Redis å¤‡ä»½\"\u003e\u003c/a\u003eRedis å¤‡ä»½\u003c/h2\u003e\u003cp\u003eåº”è¯¥ç¡®ä¿ Redis æ•°æ®æœ‰å®Œæ•´çš„å¤‡ä»½ã€‚\u003c/p\u003e\n\u003cp\u003eå¤‡ä»½ Redis æ•°æ®å»ºè®®é‡‡ç”¨ RDBã€‚\u003c/p\u003e\n\u003ch3 id=\"å¤‡ä»½è¿‡ç¨‹\"\u003e\u003ca href=\"#å¤‡ä»½è¿‡ç¨‹\" class=\"headerlink\" title=\"å¤‡ä»½è¿‡ç¨‹\"\u003e\u003c/a\u003eå¤‡ä»½è¿‡ç¨‹\u003c/h3\u003e\u003col\u003e\n\u003cli\u003eåˆ›å»ºä¸€ä¸ªå®šæœŸä»»åŠ¡ï¼ˆcron jobï¼‰ï¼Œæ¯å°æ—¶å°†ä¸€ä¸ª RDB æ–‡ä»¶å¤‡ä»½åˆ°ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”æ¯å¤©å°†ä¸€ä¸ª RDB æ–‡ä»¶å¤‡ä»½åˆ°å¦ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚\u003c/li\u003e\n\u003cli\u003eç¡®ä¿å¿«ç…§çš„å¤‡ä»½éƒ½å¸¦æœ‰ç›¸åº”çš„æ—¥æœŸå’Œæ—¶é—´ä¿¡æ¯ï¼Œæ¯æ¬¡æ‰§è¡Œå®šæœŸä»»åŠ¡è„šæœ¬æ—¶ï¼Œä½¿ç”¨ find å‘½ä»¤æ¥åˆ é™¤è¿‡æœŸçš„å¿«ç…§ï¼šæ¯”å¦‚è¯´ï¼Œä½ å¯ä»¥ä¿ç•™æœ€è¿‘ 48 å°æ—¶å†…çš„æ¯å°æ—¶å¿«ç…§ï¼Œè¿˜å¯ä»¥ä¿ç•™æœ€è¿‘ä¸€ä¸¤ä¸ªæœˆçš„æ¯æ—¥å¿«ç…§ã€‚\u003c/li\u003e\n\u003cli\u003eè‡³å°‘æ¯å¤©ä¸€æ¬¡ï¼Œå°† RDB å¤‡ä»½åˆ°ä½ çš„æ•°æ®ä¸­å¿ƒä¹‹å¤–ï¼Œæˆ–è€…è‡³å°‘æ˜¯å¤‡ä»½åˆ°ä½ è¿è¡Œ Redis æœåŠ¡å™¨çš„ç‰©ç†æœºå™¨ä¹‹å¤–ã€‚\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"å®¹ç¾å¤‡ä»½\"\u003e\u003ca href=\"#å®¹ç¾å¤‡ä»½\" class=\"headerlink\" title=\"å®¹ç¾å¤‡ä»½\"\u003e\u003c/a\u003eå®¹ç¾å¤‡ä»½\u003c/h3\u003e\u003cp\u003eRedis çš„å®¹ç¾å¤‡ä»½åŸºæœ¬ä¸Šå°±æ˜¯å¯¹æ•°æ®è¿›è¡Œå¤‡ä»½ï¼Œå¹¶å°†è¿™äº›å¤‡ä»½ä¼ é€åˆ°å¤šä¸ªä¸åŒçš„å¤–éƒ¨æ•°æ®ä¸­å¿ƒã€‚\u003c/p\u003e\n\u003cp\u003eå®¹ç¾å¤‡ä»½å¯ä»¥åœ¨ Redis è¿è¡Œå¹¶äº§ç”Ÿå¿«ç…§çš„ä¸»æ•°æ®ä¸­å¿ƒå‘ç”Ÿä¸¥é‡çš„é—®é¢˜æ—¶ï¼Œä»ç„¶è®©æ•°æ®å¤„äºå®‰å…¨çŠ¶æ€ã€‚\u003c/p\u003e\n\u003ch2 id=\"å‚è€ƒèµ„æ–™\"\u003e\u003ca href=\"#å‚è€ƒèµ„æ–™\" class=\"headerlink\" title=\"å‚è€ƒèµ„æ–™\"\u003e\u003c/a\u003eå‚è€ƒèµ„æ–™\u003c/h2\u003e\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://item.jd.com/11486101.html\"\u003eã€ŠRedis è®¾è®¡ä¸å®ç°ã€‹\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\n    \u003c/div\u003e",
  "Date": "2020-06-24T02:45:38Z",
  "Author": "é’æ‚Ÿ â—¾ Dunwu"
}