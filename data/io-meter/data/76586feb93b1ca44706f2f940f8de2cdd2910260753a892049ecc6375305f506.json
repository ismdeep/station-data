{
  "Source": "io-meter",
  "Title": "写个 Icon Font Viewer : 贰",
  "Link": "https://io-meter.com/2014/04/19/seperate-codes-and-zoom-icon/",
  "Content": "\u003cdiv class=\"entry\"\u003e\n      \u003cp\u003e这次我们先来做一些代码拆分，将窗口管理的代码从\u003ccode\u003eIFDocument\u003c/code\u003e当中剥离出来。随后将会实现\nIcon 的缩放功能。\n完整代码可以在\u003ca href=\"https://github.com/shanzi/iconfontr/tree/R02_scale_and_color\" target=\"_blank\" rel=\"noopener\"\u003e这里\u003c/a\u003e找到。\u003c/p\u003e\n\u003ca id=\"more\"\u003e\u003c/a\u003e\n\u003cp\u003e这次的技术要点有：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e在\u003ccode\u003eNSDocument\u003c/code\u003e中切换为使用\u003ccode\u003eWindowController\u003c/code\u003e来管理窗体\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eNSScrollView\u003c/code\u003e 的 ZOOM 功能的使用，以及\u003ccode\u003eJNWCollectionView\u003c/code\u003e缩放问题的处理\u003c/li\u003e\n\u003cli\u003e键盘事件的侦听\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"u5207_u6362_u5230_WindowController\"\u003e\u003ca href=\"#u5207_u6362_u5230_WindowController\" class=\"headerlink\" title=\"切换到 WindowController\"\u003e\u003c/a\u003e切换到 WindowController\u003c/h2\u003e\u003cp\u003e对于初学者来说，理解 Xcode 当中的UI设计器与程序代码的交互可能需要一点时间。Xcode 4\n之前，现在的窗口设计器部分其实是独立于 Xcode 的一个应用，名叫\nInterface Builder(\u003ca href=\"wikipedia.org/wiki/Interface_Builder\"\u003eWiki\u003c/a\u003e，简称 IB)。\n现在说起来可能有点不可思议，不过 IB 最初是的确是开发出来写 Lisp 的。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"io-meter.com/2014/04/12/iconfontr-1/\"\u003e上一篇文章\u003c/a\u003e介绍了使用\u003ccode\u003eNSDocument\u003c/code\u003e来实现简单的\nIcon Font 预览，当时窗口管理的代码是写在\u003ccode\u003eIFDocument.m\u003c/code\u003e当中的。 这样做有一个坏处，\n如果窗口控制代码比较复杂，在\u003ccode\u003eIFDocument.m\u003c/code\u003e类当中的代码就会变得不好维护。\n所以我们需要一个独立的\u003ccode\u003eWindowController\u003c/code\u003e来控制窗口。\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003eFile\u0026gt;new\u0026gt;Files..\u003c/code\u003e菜单中选择新建一个 Objective-C Class，设置如下图所示\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/iconfontr/IFDocumentWindowController.png\" alt=\"IFDocumentWindowController\"/\u003e\u003c/p\u003e\n\u003cp\u003e这里如果勾选 Also create XIB file for user interface 的话，Xcode 会自动帮你新建并设置好 XIB 文件。\n我们想要复用原来的\u003ccode\u003eIFDocument.xib\u003c/code\u003e，因此取消勾选这个选项。\u003c/p\u003e\n\u003cp\u003e接下来重新调整 XIB 文件和代码关系，\u003ccode\u003eIFDocument.m\u003c/code\u003e中存在这么一个函数:\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"built_in\"\u003eNSString\u003c/span\u003e *)windowNibName\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"string\"\u003e@\u0026#34;IFDocument\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e这个函数指定了当前的\u003ccode\u003eIFDocument\u003c/code\u003e类对应的 UI 设计文件(也就是\u003ccode\u003eIFDocument.xib\u003c/code\u003e)。\n我们把这个函数删除掉以切断\u003ccode\u003eIFDocument.m\u003c/code\u003e与\u003ccode\u003eIFDocument.xib\u003c/code\u003e的关系。\u003c/p\u003e\n\u003cp\u003e将\u003ccode\u003eIFDocument.xib\u003c/code\u003e重命名为\u003ccode\u003eIFDocumentWindow.xib\u003c/code\u003e。点击进入设计器之后，我们先把这个 XIB\n文件分配给刚刚新建立的\u003ccode\u003eIFDocumentWindowController\u003c/code\u003e。如下图所示，在左边一栏点选\u003ccode\u003eFile\u0026#39;s Owner\u003c/code\u003e\n后右边的参数面板中作如下调整:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/iconfontr/set-files-owner.png\" alt=\"Set File\u0026#39;s Owner\"/\u003e\u003c/p\u003e\n\u003cp\u003e我们知道，在右边参数面板中的\u003ccode\u003eCustom Class\u003c/code\u003e选项，就是指定 IB 中的对象与代码中定义的类的对应关系的。\n我们在这里改变了\u003ccode\u003eFile\u0026#39;s Owner\u003c/code\u003e对应的类，就相当于在这个 XIB 文件和之前建立的\n\u003ccode\u003eIFDocumentWindowController\u003c/code\u003e类之间建立了一个关系。\u003c/p\u003e\n\u003cp\u003e右键单击\u003ccode\u003eFile\u0026#39;s Owner\u003c/code\u003e弹出的浮动窗口里有一栏叫做 outlets。这些 outlets 就是在代码中定义的用以和 XIB 中对象对接的接口。\n在此需确保\u003ccode\u003eWindow\u003c/code\u003e这一栏已经和设计器中的窗口连接在一起了\n(如果没有，从右边的圆点处，拖动到窗口上释放以绑定连接)。如下图所示。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/iconfontr/outlets.png\" alt=\"Outlets\"/\u003e\u003c/p\u003e\n\u003cp\u003e建立了连接之后，我们在\u003ccode\u003eIFDocumentWindowController.m\u003c/code\u003e当中就可以用\u003ccode\u003eself.window\u003c/code\u003e来获得 XIB 当中的窗口了，\n这个接口是在\u003ccode\u003eIFDocumentWindowController\u003c/code\u003e的父类\u003ccode\u003eNSWindowController\u003c/code\u003e当中定义的。\n我们在\u003ccode\u003eIFDocumentWindowController.h\u003c/code\u003e中用下面代码来添加一个新的接口。\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003e@interface\u003c/span\u003e \u003cspan class=\"title\"\u003eIFDocumentWindowController\u003c/span\u003e : \u003cspan class=\"title\"\u003eNSWindowController\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003e@property\u003c/span\u003e(\u003cspan class=\"keyword\"\u003eassign\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eIBOutlet\u003c/span\u003e JNWCollectionView *collectionView;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003e@end\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e注意，在对象的类型前有一个\u003ccode\u003eIBOutlet\u003c/code\u003e关键字，这个关键字就是声明这个指针可以绑定到 IB 中的一个对象\n(IBOutlet 中的 IB 当然代表 Interface Builder 咯)。在代码中声明了 Outlet 之后，我们可以在 IB 中把 \u003ccode\u003ecollectionView\u003c/code\u003e \n这个接口和 XIB 中的 collectionView 对象连接起来了。\u003c/p\u003e\n\u003cp\u003e最后我们还要让 WindowController 知道自己对应的 XIB 文件是谁，以便于在\n初始化的时候加载进来。在\u003ccode\u003eIFDocumentWindowController.m\u003c/code\u003e 中添加如下一个函数:\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"built_in\"\u003eNSString\u003c/span\u003e *)windowNibName\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"string\"\u003e@\u0026#34;IFDocumentWindow\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e接下来清理一下原来的\u003ccode\u003eIFDocument.m\u003c/code\u003e并把窗口控制相关的代码迁移到\u003ccode\u003eIFDocumentWindowController\u003c/code\u003e当中。\u003c/p\u003e\n\u003cp\u003e怎么样把原来的\u003ccode\u003eIFDocument\u003c/code\u003e和新的 \u003ccode\u003eIFDocumentWindowController\u003c/code\u003e 联系起来呢？在\u003ccode\u003emakeWindowControllers\u003c/code\u003e\n函数中创建\u003ccode\u003eIFDocumentWindowController\u003c/code\u003e的一个实例并调用\u003ccode\u003eaddWindowController:\u003c/code\u003e函数就可以了。\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"keyword\"\u003evoid\u003c/span\u003e) makeWindowControllers\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  IFDocumentWindowController *windowController = [[IFDocumentWindowController alloc] init];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  [(IFDocumentWindowController *)windowController setGlyphPathes:_glyphPathes];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  [\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e addWindowController:windowController];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e通过上面的步骤，可以看出了 XIB 和代码配合的的几个要点：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFile’s Owner 的类将 XIB 和一个 Controller 联系起来\u003c/li\u003e\n\u003cli\u003e在代码中可以用 IBOutlet 来定义一个接口，在运行时这个接口将会指向 XIB 中的一个对象\u003c/li\u003e\n\u003cli\u003e在 Files’s Owner 对应的 Controller 可以通过一个函数来指定对应 XIB 文件的名字\u003c/li\u003e\n\u003cli\u003e之后的文章还会介绍使用 IBAction 关键字来接收一个事件回调\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"u5B9E_u73B0_u7F29_u653E_u529F_u80FD\"\u003e\u003ca href=\"#u5B9E_u73B0_u7F29_u653E_u529F_u80FD\" class=\"headerlink\" title=\"实现缩放功能\"\u003e\u003c/a\u003e实现缩放功能\u003c/h2\u003e\u003cp\u003e老实说，缩放功能的实现比预计的要麻烦很多。本来以为作为\u003ccode\u003eNSScroller\u003c/code\u003e子类的\u003ccode\u003eJNWCollectionView\u003c/code\u003e\n能够很方便的开启缩放功能，结果却因在缩放过程中其会对子视图进行排版而导致各种 Bug，\n经过多次尝试，终于还是找到了一个解决方案。\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003eJNWCollectionView\u003c/code\u003e上实现缩放的要点主要有：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e在缩放进行时，必须要禁止\u003ccode\u003eJNWCollectionViewLayout\u003c/code\u003e更新 layout 布局，否则将会出现卡顿\u003c/li\u003e\n\u003cli\u003e缩放结束后要调整\u003ccode\u003eJNWCollectionViewLayout\u003c/code\u003e的\u003ccode\u003edocumentView\u003c/code\u003e大小，否则将无法横向滚动\u003c/li\u003e\n\u003cli\u003e如果要显示横向滚动条，需要修改\u003ccode\u003eJNWCollectionViewLayout\u003c/code\u003e的\u003ccode\u003eScrollDirection\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e首先创建几个子类：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/iconfontr/new-subclasses.png\" alt=\"New Subclasses\"/\u003e\u003c/p\u003e\n\u003cp\u003e其中\u003ccode\u003eIFMagnifyCollectionView\u003c/code\u003e是\u003ccode\u003eJNWCollectionView\u003c/code\u003e的子类，\u003ccode\u003eIFCollectionGridLayout\u003c/code\u003e\n是\u003ccode\u003eJNWCollectionGridLayout\u003c/code\u003e的子类。为了在缩放过程中禁止\u003ccode\u003eIFCollectionGridLayout\u003c/code\u003e刷新排版，\n给他添加一个新的属性并重载 \u003ccode\u003eshouldInvalidateLayoutForBoundsChange\u003c/code\u003e方法，\n此外还要复写\u003ccode\u003eScrollDirection\u003c/code\u003e方法来显示横向滚动条：\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// JNWCollectionGridLayout.h\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#import \u003cspan class=\"meta-string\"\u003e\u0026#34;JNWCollectionViewGridLayout.h\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003e@interface\u003c/span\u003e \u003cspan class=\"title\"\u003eIFCollectionGridLayout\u003c/span\u003e : \u003cspan class=\"title\"\u003eJNWCollectionViewGridLayout\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003e@property\u003c/span\u003e(\u003cspan class=\"keyword\"\u003enonatomic\u003c/span\u003e) \u003cspan class=\"built_in\"\u003eBOOL\u003c/span\u003e allowsLiveLayout;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003e@end\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// JNWCollectionGridLayout.m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"class\"\u003e\u003cspan class=\"keyword\"\u003e@implementation\u003c/span\u003e \u003cspan class=\"title\"\u003eIFCollectionGridLayout\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"built_in\"\u003eBOOL\u003c/span\u003e)shouldInvalidateLayoutForBoundsChange:(\u003cspan class=\"built_in\"\u003eCGRect\u003c/span\u003e)newBounds\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// Forbid layout update when zooming\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// _allowsLiveLayout will be set to NO when zooming\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e _allowsLiveLayout;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- (JNWCollectionViewScrollDirection)scrollDirection\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// scroll in both vertical and horizontal direction\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e JNWCollectionViewScrollDirectionBoth;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003e@end\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e\u003ccode\u003eIFMagnifyCollectionView\u003c/code\u003e的父类\u003ccode\u003eNSScrollView\u003c/code\u003e其实已经提供了缩放的支持，\n所以并不需要自己捕捉多点触摸的事件。开启缩放功能使用下面的函数就可以了。最关键的一句就是\n\u003ccode\u003eself.allowsMagnification=YES;\u003c/code\u003e，代表着允许使用缩放。\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"keyword\"\u003evoid\u003c/span\u003e)invokeMagnification\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (!\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.allowsMagnification) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.allowsMagnification = \u003cspan class=\"literal\"\u003eYES\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// turn on magnification\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.magnification = \u003cspan class=\"number\"\u003e1.0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.maxMagnification = \u003cspan class=\"number\"\u003e3\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.minMagnification = \u003cspan class=\"number\"\u003e1.0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    [[\u003cspan class=\"built_in\"\u003eNSNotificationCenter\u003c/span\u003e defaultCenter] addObserver:\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                             selector:\u003cspan class=\"keyword\"\u003e@selector\u003c/span\u003e(liveMagnifyWillStart:)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                                 name:\u003cspan class=\"built_in\"\u003eNSScrollViewWillStartLiveMagnifyNotification\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                               object:\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    [[\u003cspan class=\"built_in\"\u003eNSNotificationCenter\u003c/span\u003e defaultCenter] addObserver:\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                             selector:\u003cspan class=\"keyword\"\u003e@selector\u003c/span\u003e(liveMagnifyDidEnd:)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                                 name:\u003cspan class=\"built_in\"\u003eNSScrollViewDidEndLiveMagnifyNotification\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                               object:\u003cspan class=\"keyword\"\u003eself\u003c/span\u003e];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e在函数的最后用\u003ccode\u003eNSNotificationCenter\u003c/code\u003e添加了两个消息侦听，这两个消息分别在缩放开始和结束时发出。\n侦听这两个消息的目的就是为了在缩放开始和结束的时候设定\u003ccode\u003eIFCollectionGridLayout\u003c/code\u003e的\u003ccode\u003eallowsLiveLayout\u003c/code\u003e\n属性，以实现在缩放时禁止重新布局的需求。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eliveMagnifyWillStart:\u003c/code\u003e和\u003ccode\u003eliveMagnifyDidEnd:\u003c/code\u003e这两个回调函数的内容这里就略去不表了，\n具体实现看\n\u003ca href=\"https://github.com/shanzi/iconfontr/blob/R02_scale_and_color/iconfontr/IFMagnifyCollectionView.m\" target=\"_blank\" rel=\"noopener\"\u003eIFMagnifyCollectionView\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e接下来我们解决缩放后的滚动问题，不同于 iOS 上的\u003ccode\u003eUIScrollView\u003c/code\u003e，\u003ccode\u003eNSScrollView\u003c/code\u003e没有\u003ccode\u003econtentSize\u003c/code\u003e属性。\n实际上，\u003ccode\u003eNSScrollView\u003c/code\u003e包含一个子视图\u003ccode\u003edocumentView\u003c/code\u003e，所有\u003ccode\u003eNSScrollView\u003c/code\u003e显示的 Subviews\n都放置在\u003ccode\u003edocumentView\u003c/code\u003e中。而\u003ccode\u003edocumentView\u003c/code\u003e的\u003ccode\u003eframe\u003c/code\u003e属性指定了想要显示的内容的\u003cem\u003e完整\u003c/em\u003e大小，\n\u003ccode\u003eNSScrollView\u003c/code\u003e的\u003ccode\u003edocumentVisbleRect\u003c/code\u003e属性指定了想要内容\u003cem\u003e实际显示\u003c/em\u003e的范围。\u003c/p\u003e\n\u003cp\u003e想要实现正确的滚动效果，就要正确的设置\u003ccode\u003edocumentView.frame\u003c/code\u003e和\u003ccode\u003edocumentViewVisibleRect\u003c/code\u003e两个属性。\n在 Zoom 的过程中，\u003ccode\u003edocumentView\u003c/code\u003e的大小其实是不变的，之所以我们可以看到内容被放大了，是因为对\n\u003ccode\u003edocumentView\u003c/code\u003e发送了\u003ccode\u003escaleUnitSquareToSize:\u003c/code\u003e消息，而\u003ccode\u003edocumentViewVisibleRect\u003c/code\u003e也同时被缩小了。\u003c/p\u003e\n\u003cp\u003e现在的问题是，缩放结束之后\u003ccode\u003eJNWCollectionView\u003c/code\u003e会根据可视范围的大小重新调整\u003ccode\u003edocumentView\u003c/code\u003e的大小，\n\u003ccode\u003edocumetView\u003c/code\u003e的宽度将总是和\u003ccode\u003edocumventVisibleRect\u003c/code\u003e一样，这样横向滚动就失效了。\n一个最简单的解决方案是重载\u003ccode\u003edocumentVisibleRect\u003c/code\u003e函数，不让它的宽度随着放大而相对变小。\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"built_in\"\u003eNSRect\u003c/span\u003e)documentVisibleRect\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eNSRect\u003c/span\u003e visibleRect = [\u003cspan class=\"keyword\"\u003esuper\u003c/span\u003e documentVisibleRect];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  visibleRect.origin.x = \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  visibleRect.size.width *= \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.magnification;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e visibleRect;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e这样做牺牲了一定的性能，因为\u003ccode\u003eJNWCollectionView\u003c/code\u003e是根据\u003ccode\u003edocumentVisibleRect\u003c/code\u003e来决定一个子视图是否可见，\n据此移除看不见的 Subviews 并节约资源。最终还是是要修改\u003ccode\u003eJNWCollectionView\u003c/code\u003e的源码才能达到最好的效果，\n这里也不详细介绍了。\u003c/p\u003e\n\u003cp\u003e为了方便使用，还可以添加键盘的事件侦听，只要设定\u003ccode\u003eIFCollectionView\u003c/code\u003e的\u003ccode\u003emagnification\u003c/code\u003e属性的大小就行了:\u003c/p\u003e\n\u003cfigure class=\"highlight objectivec\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#define kEqualsKeyCode 24\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#define kMinusKeyCode 27\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"keyword\"\u003evoid\u003c/span\u003e)keyDown:(\u003cspan class=\"built_in\"\u003eNSEvent\u003c/span\u003e *)theEvent\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// cancel the sound played after keydown\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- (\u003cspan class=\"keyword\"\u003evoid\u003c/span\u003e)keyUp:(\u003cspan class=\"built_in\"\u003eNSEvent\u003c/span\u003e *)theEvent\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e ([theEvent keyCode]==kEqualsKeyCode) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.magnification += \u003cspan class=\"number\"\u003e0.2\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e([theEvent keyCode]==kMinusKeyCode) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eself\u003c/span\u003e.magnification -= \u003cspan class=\"number\"\u003e0.2\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\u003cp\u003e想要捕捉键盘事件，只要重载\u003ccode\u003ekeyUp\u003c/code\u003e、\u003ccode\u003ekeyDown\u003c/code\u003e这样的函数就行了。包括鼠标、键盘和触摸事件在内的回调函数最初都定义在\n\u003ca href=\"https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ApplicationKit/Classes/NSResponder_Class/Reference/Reference.html\" target=\"_blank\" rel=\"noopener\"\u003eNSResponder\u003c/a\u003e\n中，在所有的\u003ccode\u003eNSResponder\u003c/code\u003e的子类中都可以使用。\u003c/p\u003e\n\u003cp\u003e对于键盘事件，\u003ccode\u003e[theEvent keyCode]\u003c/code\u003e返回的是一个设备无关的虚拟键值，符号\u003ccode\u003e-\u003c/code\u003e的值是\u003ccode\u003e27\u003c/code\u003e，符号\u003ccode\u003e=\u003c/code\u003e(也就是\u003ccode\u003e+\u003c/code\u003e所在的键)\n的值是\u003ccode\u003e24\u003c/code\u003e。这里需要复写一下\u003ccode\u003ekeyDown\u003c/code\u003e函数，避免按键时出现提示音。\u003c/p\u003e\n\u003cp\u003e现在就可以在触摸板上用 Spin 手势和键盘上的加减符号实现放大缩小了，效果如下图所示：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/img/iconfontr/zoom-result.png\" alt=\"Zoom Result\"/\u003e\u003c/p\u003e\n\u003ch2 id=\"u4E00_u70B9_u603B_u7ED3_u548C_u9884_u544A\"\u003e\u003ca href=\"#u4E00_u70B9_u603B_u7ED3_u548C_u9884_u544A\" class=\"headerlink\" title=\"一点总结和预告\"\u003e\u003c/a\u003e一点总结和预告\u003c/h2\u003e\u003cp\u003e这次的文章主要记录了拆分代码和实现缩放的功能，其中详细介绍了 XIB 和代码之间的关系以及配合的问题，\n感觉讲解的还不是很清楚，如果各位看官有什么问题，欢迎直接询问我。\u003c/p\u003e\n\u003cp\u003e在上面的结果图上可以看到其实已经实现了选择预览颜色的功能，不过限于篇幅原因还是决定留到下一篇文章再讲。\n下次将会详细介绍一下如何编写一个自定义的 NSControl，附带图形绘制更详细的介绍以及用\u003ccode\u003eIBAction\u003c/code\u003e\n来实现事件的回调的方法。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2014-04-18T15:21:46Z",
  "Author": "Chase Zhang"
}