{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(在configmap中引用secret)",
  "Link": "https://izsk.me/2020/06/28/Kubernetes-configmap-reference-var-from-secret/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e使用kubernetes做为底层平台, 对于配置文件的部署形式, 如果没有统一的配置管理, 使用最多的就是configmap及secret\u003c/p\u003e\n\u003cp\u003e但有时候只会将敏感的信息放在secret中，而大多数的配置会放在configmap, 这就造成要么把secret以env的形式存在于容器中,要么就以volumn的形式挂载到容器中, 需要从两个源来引用配置， 从本质上, configmap与secret是一个东西, 有时候会觉得这种场景其实可以优化到一个配置中， 官方到目前为止并不打算支持在configmap中引用secret, 这是在github上讨论的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes/kubernetes/issues/79224\"\u003eissue\u003c/a\u003e\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003cp\u003e某天随便逛github时，发现一个可以实现该功能的开源库\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/machinezone/configmapsecrets\"\u003econfigmapsecrets\u003c/a\u003e,它能够在configmap中引用secret中的变量, 最后生成一个完整的secret. 这样， 应用直接把这个secret挂载到指定路径即可, 同时，支持热更新.\u003c/p\u003e\n\u003cp\u003e经过一番研究后，发现用在GitOps流程中还是非常方便的, 结合\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/bitnami-labs/sealed-secrets\"\u003eSealedSecrets\u003c/a\u003e对secret的加密， 两者结合更好的支持了配置安全，方便统一管理\u003c/p\u003e\n\u003ch3 id=\"原理\"\u003e\u003ca href=\"#原理\" class=\"headerlink\" title=\"原理\"\u003e\u003c/a\u003e原理\u003c/h3\u003e\u003cp\u003e原理非常简单，通过CRD来监控集群中特定资源(configmapSecret), 分析该资源引用的secret, 填充变量生成secret. \u003c/p\u003e\n\u003cp\u003e同时为了支持多个实例，多实例之间的竞争关系, 使用了\u003ccode\u003esync.RWMutex\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"使用\"\u003e\u003ca href=\"#使用\" class=\"headerlink\" title=\"使用\"\u003e\u003c/a\u003e使用\u003c/h3\u003e\u003ch4 id=\"安装CRD\"\u003e\u003ca href=\"#安装CRD\" class=\"headerlink\" title=\"安装CRD\"\u003e\u003c/a\u003e安装CRD\u003c/h4\u003e\u003cp\u003e按照github上的说明, 先生成CRD, 这里需要注意的是, 如果只想监视特定的ns中有效, 修改deployment.yaml中的容器的启动参数，\u003c/p\u003e\n\u003cp\u003e添加\u003ccode\u003eall-namespaces=false\u003c/code\u003e，这样，configmapsecret只会处理这个ns中的对象\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ekubectl apply -f manifest\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"secret\"\u003e\u003ca href=\"#secret\" class=\"headerlink\" title=\"secret\"\u003e\u003c/a\u003esecret\u003c/h4\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eSecret\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager-keys\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003emonitoring\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003estringData:\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 使用stringData，不需要事先使用base64加密\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eopsgenieKey:\u003c/span\u003e \u003cspan class=\"string\"\u003e9eccf784-bbad-11e9-9cb5-2a2ae2dbcce4xxxxyyyyyyzzzzz\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eslackURL:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttps://hooks.slack.com/services/EFNPN1/EVU44X/J51NVTYSKwuPtCz3yyyy\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"string\"\u003eOpaque\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"ConfigmapSecret\"\u003e\u003ca href=\"#ConfigmapSecret\" class=\"headerlink\" title=\"ConfigmapSecret\"\u003e\u003c/a\u003eConfigmapSecret\u003c/h4\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003esecrets.mz.com/v1alpha1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eConfigMapSecret\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager-config\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003emonitoring\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager-config\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ealertmanager.yaml:\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          global:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            resolve_timeout: 5m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            opsgenie_api_key: $(OPSGENIE_API_KEY)  # 在 Var中定义\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            slack_api_url: $(SLACK_API_URL)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            special_how: $(CONFIGMAP_HOW)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            special_type: $(CONFIGMAP_TYPE)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          route:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            receiver: default\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            group_by: [\u0026#34;alertname\u0026#34;, \u0026#34;job\u0026#34;, \u0026#34;team\u0026#34;]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            group_wait: 30s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            group_interval: 5m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            repeat_interval: 12h\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            routes:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              - receiver: foobar-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                match:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  team: foobar-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              - receiver: widget-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                match:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  team: widget-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          receivers:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            - name: default\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              slack_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                - channel: unrouted-alerts\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            - name: foobar-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              opsgenie_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                - responders:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                    - name: foobar-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                      type: team\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              slack_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                - channel: foobar-sre-alerts\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            - name: widget-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              opsgenie_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                - responders:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                    - name: widget-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                      type: team\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              slack_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                - channel: widget-sre\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e  \u003cspan class=\"attr\"\u003evars:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eOPSGENIE_API_KEY\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003esecretValue:\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 引用secret \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager-keys\u003c/span\u003e \u003cspan class=\"comment\"\u003e# secret 名字\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ekey:\u003c/span\u003e \u003cspan class=\"string\"\u003eopsgenieKey\u003c/span\u003e \u003cspan class=\"comment\"\u003e# secret key\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eSLACK_API_URL\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003esecretValue:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ealertmanager-keys\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ekey:\u003c/span\u003e \u003cspan class=\"string\"\u003eslackURL\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eCONFIGMAP_HOW\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 引用configmap\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003econfigMapValue:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003especial-config\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ekey:\u003c/span\u003e \u003cspan class=\"string\"\u003especial.how\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eCONFIGMAP_TYPE\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003econfigMapValue:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003especial-config\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ekey:\u003c/span\u003e \u003cspan class=\"string\"\u003especial.type\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003evars中内容即是引用的变量, 上面引用的是secret, 当然也可以引用configmap.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e注意: 引用的必须是同一ns中secret/configmap\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e使用命令生成以上2个对象\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubectl apply -f secret.yaml\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ekubectl apply -f confsec.yaml\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e最终会在同一ns中生成一个secret，名字跟ConfigMapSecret对象的名字相同， 当然secret的data数据是被base64加密的\u003c/p\u003e\n\u003ch3 id=\"其它测试\"\u003e\u003ca href=\"#其它测试\" class=\"headerlink\" title=\"其它测试\"\u003e\u003c/a\u003e其它测试\u003c/h3\u003e\u003col\u003e\n\u003cli\u003e如果修改引用的secret，会提示以下日志\u003c/li\u003e\n\u003c/ol\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003cspan class=\"string\"\u003e\u0026#34;level\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;INFO\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;time\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;2020-06-28T03:52:57.386Z\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers.controller.ConfigMapSecret\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;caller\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers/configmapsecret_controller.go:271\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Updating Secret\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;configmapsecret\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;monitoring/alertmanager-config\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;secret\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;monitoring/alertmanager-config\u0026#34;\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col start=\"2\"\u003e\n\u003cli\u003e修改configmapsecret本身,会提示以下错误, 但并不影响\u003c/li\u003e\n\u003c/ol\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003cspan class=\"string\"\u003e\u0026#34;level\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;ERROR\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;time\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;2020-06-28T03:50:08.555Z\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers.controller.ConfigMapSecret\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;caller\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers/configmapsecret_controller.go:462\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Unable to update status\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;configmapsecret\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;monitoring/alertmanager-config\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;error\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Operation cannot be fulfilled on configmapsecrets.secrets.mz.com \\\u0026#34;alertmanager-config\\\u0026#34;: the object has been modified; please apply your changes to the latest version and try again\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e1、2两种情况最终的secret会跟着被修改\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e而如果直接修改最终生成的secret，修改完之后会立即被复原.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003cspan class=\"string\"\u003e\u0026#34;level\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;INFO\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;time\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;2020-06-28T04:23:43.699Z\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;source\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers.controller.ConfigMapSecret\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;caller\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;controllers/configmapsecret_controller.go:271\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;Updating Secret\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;configmapsecret\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;monitoring/alertmanager-config\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;secret\u0026#34;\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;monitoring/alertmanager-config\u0026#34;\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col start=\"4\"\u003e\n\u003cli\u003e删除configmapsecret, 则最终生成的secret也会被删除, 引用的secret则不会.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"源码分析\"\u003e\u003ca href=\"#源码分析\" class=\"headerlink\" title=\"源码分析\"\u003e\u003c/a\u003e源码分析\u003c/h3\u003e\u003cp\u003e关键代码在\u003ccode\u003e/pkg/controllers/configmapsecret_controller.go\u003c/code\u003e中\u003c/p\u003e\n\u003cp\u003e首先通过\u003ccode\u003eSetupWithManager\u003c/code\u003e启动manager， 该manager用于监控configmapsecret及secret\u003c/p\u003e\n\u003cp\u003e关键函数\u003ccode\u003esync\u003c/code\u003e用于同步相关资源的变更，通过对比OwnerReferences的UID来判断是否有变更，它调用\u003ccode\u003erenderSecret\u003c/code\u003e根据configmapsecret及引用的secret/configmap来渲染生成最终的secret\u003c/p\u003e\n\u003cp\u003e而处理引用变量的逻辑则是在\u003ccode\u003emakeVariables\u003c/code\u003e函数\u003c/p\u003e\n\u003ch3 id=\"不足\"\u003e\u003ca href=\"#不足\" class=\"headerlink\" title=\"不足\"\u003e\u003c/a\u003e不足\u003c/h3\u003e\u003cp\u003e如果使用容器平台，如rancher, UI上不支持显示crd， 因此configmapsecret无法显示在页面上.\u003c/p\u003e\n\u003cp\u003e如果最终生成的形式为secret， 被base64编码，不能够直观地显示配置, 如果能够直接生成configmap，我觉得更合理\u003c/p\u003e\n\u003cp\u003e但生成的secret也不影响这个库用于GitOps中，结合\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/bitnami-labs/sealed-secrets\"\u003eSealedSecrets\u003c/a\u003e对secret的加密处理, 至此可以实现整个资源端到端的闭环.\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes/kubernetes/issues/79224\"\u003ehttps://github.com/kubernetes/kubernetes/issues/79224\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/machinezone/configmapsecrets\"\u003ehttps://github.com/machinezone/configmapsecrets\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-06-28T20:10:53+08:00",
  "Author": "Z.S.K."
}