{
  "Source": "izsk.me",
  "Title": "Prometheus学习(Prometheus基于kubernetes做服务发现)",
  "Link": "https://izsk.me/2019/09/20/prometheus-service-discovery-on-k8s/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e之前学习了prometheus的架构及一些基本术语, 今天学习一下Prometheus的服务发现机制，这块的内容占据比较大的份额， 主要学习下基于kubernetes做服务发现.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"服务发现\"\u003e\u003ca href=\"#服务发现\" class=\"headerlink\" title=\"服务发现\"\u003e\u003c/a\u003e服务发现\u003c/h3\u003e\u003cp\u003e由于是opnuPrometheus的服务发现的, 但\u003ccode\u003e服务发现\u003c/code\u003e这个词不应该放到里详细地展开说它是个什么东西，\u003c/p\u003e\n\u003cp\u003e大家可以想像下DNS的机制,它就是一种\u003ccode\u003e服务发现\u003c/code\u003e方法. 详解地可参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.jianshu.com/p/1bf9a46efe7a\"\u003e这里\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e随着kubernetes被光放地用于在微服务架构下, 错综复杂的服务间调用使得对\u003ccode\u003e服务发现\u003c/code\u003e机制越来越重要，\u003c/p\u003e\n\u003cp\u003e当然, 存在\u003ccode\u003e服务发现\u003c/code\u003e那必然就有\u003ccode\u003e服务注册\u003c/code\u003e，好在kubernetes本身做了这些事情, 使得我们可以更加专注于业务.\u003c/p\u003e\n\u003cp\u003e可以有很多种方式实现\u003ccode\u003e服务发现\u003c/code\u003e, 最早使用的DNS其实就是一种， \u003c/p\u003e\n\u003cp\u003e在prometheus的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\"\u003e官网\u003c/a\u003e上, 列出了目前支持的\u003ccode\u003e服务发现\u003c/code\u003e方式,图中的sd表示的\u003ccode\u003e service discovery\u003c/code\u003e, 这里了解下最kubernetes跟file这种方式\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200317182657.png\"/\u003e\u003c/p\u003e\n\u003ch4 id=\"static-config\"\u003e\u003ca href=\"#static-config\" class=\"headerlink\" title=\"static_config\"\u003e\u003c/a\u003estatic_config\u003c/h4\u003e\u003cp\u003e最简单的是静态配置, 这种也权当是一种\u003ccode\u003e服务发现\u003c/code\u003e吧, 就是直接在prometheus配置中直接指定需要抓取的目标\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200317184413.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e像上图那样直接在target中指定目标地址即可, 非常简单\u003c/p\u003e\n\u003ch4 id=\"file-sd-config\"\u003e\u003ca href=\"#file-sd-config\" class=\"headerlink\" title=\"file_sd_config\"\u003e\u003c/a\u003efile_sd_config\u003c/h4\u003e\u003cp\u003e基于文件的服务发现, 可以理解通过解析文件的方式获取目标, 这种方式跟static_config差不太多\u003c/p\u003e\n\u003cp\u003e这种方式的有点是可以根据业务进行分类, 而不用全都塞到一个配置文件中，当这个yaml或者json文件内容有改变的时候，prometheus 会通过watch file的形式感知到target内容的变动\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;test_server\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003efile_sd_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003efiles:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e/app/hananmin/prometheus/file_sd/test_server.json\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003erefresh_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecat\u003c/span\u003e test_server.json\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;targets\u0026#34;\u003c/span\u003e:  [\u003cspan class=\"string\"\u003e\u0026#34;10.161.4.63:9091\u0026#34;\u003c/span\u003e,\u003cspan class=\"string\"\u003e\u0026#34;10.161.4.61:9100\u0026#34;\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e文件支持通配规则.\u003c/p\u003e\n\u003ch4 id=\"kubernetes-sd-config\"\u003e\u003ca href=\"#kubernetes-sd-config\" class=\"headerlink\" title=\"kubernetes_sd_config\"\u003e\u003c/a\u003ekubernetes_sd_config\u003c/h4\u003e\u003cp\u003e要理解prometheus如何基于kubernetes做服务发现这个问题, 那么就需要理解kubernetes是如何做服务发现的.\u003c/p\u003e\n\u003cp\u003e这里一句话总结就是,\u003ccode\u003ekubernetes的服务发现机制是基于dns的,所有的service都注册到api-server最终存储到etcd中,任何组件想要访问其它服务的话都需要从api-server中获取, 因此etcd中存储有所有元数据\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e因此, prometheus要发现kubernetes中的服务, 只需要通过list-watch机制从api-server中获取即可, 当然获取之后prometheus是会缓存在自己的内存中.\u003c/p\u003e\n\u003cp\u003e从上面能看到prometheus知道从kube-api中获取服务, 但怎么知道具体哪些服务是真正需要获取的, 一个kubernetes集群中可能存在上千个服务, \u003ccode\u003e难道所有的服务都需要吗\u003c/code\u003e？显然不是.\u003c/p\u003e\n\u003cp\u003e在学习使用prometheus的时候，有同学看到prometheus的配置文件时肯定会疑惑, 而且整个配置文件中对kubernetes的部分占了大半部分,这里挑监控pod的部分简单说下, 先来看下配置文件\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes-pods\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e20s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_timeout:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emetrics_path:\u003c/span\u003e \u003cspan class=\"string\"\u003e/metrics\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escheme:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ekubernetes_sd_configs:\u003c/span\u003e\t\u003cspan class=\"comment\"\u003e# 指定kubernetes做为sd\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eapi_server:\u003c/span\u003e \u003cspan class=\"literal\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#指定kubernetes角色.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003enamespaces:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003enames:\u003c/span\u003e []\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003erelabel_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_pod_annotation_prometheus_io_scrape\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ekeep\u003c/span\u003e  \u003cspan class=\"comment\"\u003e#对于metric的label中存在__meta_kubernetes_pod_annotation_prometheus_io_scrape时才会保留\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_pod_annotation_prometheus_io_path\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e(.+)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__metrics_path__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__address__\u003c/span\u003e, \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_annotation_prometheus_io_port\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e([^:]+)(?::\\d+)?;(\\d+)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__address__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1:$2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_label_(.+)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003elabelmap\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_namespace\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e(.*)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes_namespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_pod_name\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e(.*)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes_pod_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_pod_node_name\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e(.*)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003enode\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这个配置文件可在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml\"\u003e这里\u003c/a\u003e看到，至于上面的配置文件的含义, 网上已经有人解释了，这里就不多说，感兴趣的可以看看\u003ca href=\"%5Bhttps://jeremyxu2010.github.io/2018/11/%E4%BD%BF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E5%A4%9Ak8s%E9%9B%86%E7%BE%A4/#prometheus%E9%87%87%E9%9B%86%E5%85%B6%E5%AE%83k8s%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE%5D(https://jeremyxu2010.github.io/2018/11/%E4%BD%BF%E7%94%A8prometheus%E7%9B%91%E6%8E%A7%E5%A4%9Ak8s%E9%9B%86%E7%BE%A4/#prometheus%E9%87%87%E9%9B%86%E5%85%B6%E5%AE%83k8s%E7%9B%91%E6%8E%A7%E6%95%B0%E6%8D%AE)\"\u003e这里\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e这里要说的是, 按照上面的理解, 我一定是需要指定target才行, 但是上面这段配置并没有target字段, 那又是为何呢?\u003c/p\u003e\n\u003cp\u003e秘密就在于\u003ccode\u003erole: pod\u003c/code\u003e,上面已经标注出来, 在prometheus的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/prometheus/prometheus/blob/master/discovery/kubernetes/pod.go\"\u003e源码\u003c/a\u003e中, 可以看到对pod的具体处理\u003c/p\u003e\n\u003cp\u003e从prometheus的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/prometheus/prometheus/blob/master/discovery/kubernetes/kubernetes.go\"\u003e源码\u003c/a\u003e中也可以看到对kubernetes支持的role共有\u003ccode\u003eendpoints,ingress,node,pod,service\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200317213527.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e所以，如果role 等于其它的值是没有用的, 因此在整个prometheus的配置文件中对于Kubernetes的配置只会有上面那5种role, 可以少, 比如我集群中没有ingress, 那么是可以没有ingress的配置的\u003c/p\u003e\n\u003cp\u003e所以总结一下, \u003cstrong\u003eprometheus通过list-watch机制来更新上面指定role资源\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e那另一个问题是, 对于上面pod的配置，\u003ccode\u003e难道所有的pod对象都会prometheus抓取吗\u003c/code\u003e？显然也不是的\u003c/p\u003e\n\u003cp\u003e如果kubernetes集群到达一个数据级, 全部的pod都scrape的话,那对prometheus跟kubernetes的性能都是个巨大考验, 而且一般情况下，我们只会关心想关心的应用pod，另一此不是很重要的pod其实是可以不监控的。\u003c/p\u003e\n\u003cp\u003e因此prometheus通过annotations的方式，指定哪些需要需要scrape, 哪些可以忽略.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200318112248.png\"/\u003e\u003c/p\u003e\n\u003cp\u003eprometheus.io/scrape: 如果加上这个annotations，表示当前pod是允许prometheus抓取数据的，如不加这个annotations，prometheus就不会自动把这个pod纳入到监控中,  scrape=true：允许抓取；scrape=flase：不允许抓取\u003c/p\u003e\n\u003cp\u003eprometheus.io/port: 抓取数据时使用的套接字端口, 这个端口用于暴露metric\u003c/p\u003e\n\u003cp\u003eprometheus.io/path: 当scrape=true时，再加此annotation，表示当前Pod能够输出指标数据的Url,默认为/metrics\u003c/p\u003e\n\u003cp\u003e因此, 整个annotations的完整url为 \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://alertmanager-logging:9093/metrics\"\u003ehttp://alertmanager-logging:9093/metrics\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eprometheus通过这种方式来决定哪些pod才是真正需要监控target, 同理其它role也是如此.\u003c/p\u003e\n\u003cp\u003epeometheus定时抓取target后将metrics数据存在在storge中\u003c/p\u003e\n\u003cp\u003e到此, 整个prometheus的服务发现target的流程就完了, 这里没有过多的介绍源码层面上的东西,网上有大神写的是感觉好, 大家有兴趣的话可以参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://xumc.github.io/blog/2018/09/12/promethues-scrape-source-lookup\"\u003e这篇\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://xumc.github.io/blog/2018/09/02/promethues-discover\"\u003ehttps://xumc.github.io/blog/2018/09/02/promethues-discover\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://xumc.github.io/blog/2018/09/12/promethues-scrape-source-lookup\"\u003ehttps://xumc.github.io/blog/2018/09/12/promethues-scrape-source-lookup\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.jianshu.com/p/1bf9a46efe7a\"\u003ehttps://www.jianshu.com/p/1bf9a46efe7a\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\"\u003ehttps://prometheus.io/docs/prometheus/latest/configuration/configuration/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/u010278923/article/details/70943506\"\u003ehttps://blog.csdn.net/u010278923/article/details/70943506\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml\"\u003ehttps://github.com/prometheus/prometheus/blob/master/documentation/examples/prometheus-kubernetes.yml\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-09-20T21:30:53+08:00",
  "Author": "Z.S.K."
}