{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(service机制)",
  "Link": "https://izsk.me/2019/10/15/Kubernetes-service-theory/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003eservice在kubernetes是一个比较核心的概念, 得益于service机制，才让业务可以don’t care后端real pod的IP 可动态变化. 可以说,\u003cstrong\u003eservice是一组具有提供相同能力pod的代理.\u003c/strong\u003e\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003cp\u003e在分析流量如何转发之前还是需要稍微带一下kubernetes的service基本概念\u003c/p\u003e\n\u003ch3 id=\"基本概念\"\u003e\u003ca href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"\u003e\u003c/a\u003e\u003cstrong\u003e基本概念\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121182950876.png\"/\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eService: 解决容器IP动态属性, 实为一个代理服务.\u003c/li\u003e\n\u003cli\u003eEndpoint( Endpoint Controller): 是k8s集群中的一个资源对象,存储在etcd中,用来记录一个service对应的所有pod的访问地址\u003cul\u003e\n\u003cli\u003e负责生成和维护所有endpoint对象的控制器\u003c/li\u003e\n\u003cli\u003e负责监听service和对应pod的变化\u003c/li\u003e\n\u003cli\u003e监听到service被删除，则删除和该service同名的endpoint对象\u003c/li\u003e\n\u003cli\u003e监听到新的service被创建，则根据新建service信息获取相关pod列表，然后创建对应endpoint对象\u003c/li\u003e\n\u003cli\u003e监听到service被更新，则根据更新后的service信息获取相关pod列表，然后更新对应endpoint对象\u003c/li\u003e\n\u003cli\u003e监听到pod事件，则更新对应的service的endpoint对象，将podIP记录到endpoint中\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eKube-proxy:\u003cul\u003e\n\u003cli\u003ekube-proxy负责service的实现，即实现了k8s内部从pod\u0026lt;==\u0026gt;service和外部从node port到service的访问。\u003c/li\u003e\n\u003cli\u003ekube-proxy采用iptables的方式配置负载均衡，基于iptables的kube-proxy的主要职责包括两大块\u003cul\u003e\n\u003cli\u003e一块是侦听service更新事件，并更新service相关的iptables规则，\u003c/li\u003e\n\u003cli\u003e一块是侦听endpoint更新事件，更新endpoint相关的iptables规则（如 KUBE-SVC-链中的规则），然后将包请求转入endpoint对应的Pod。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e如果某个service尚没有Pod创建，那么针对此service的请求将会被drop掉\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003ccode\u003eendpoint只是维护service到pod列表的映射关系，而这种映射关系的访问链路是通过 kube-proxy实现的.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e目前业务中用到了以下几种svc.\u003c/p\u003e\n\u003ch3 id=\"服务类型\"\u003e\u003ca href=\"#服务类型\" class=\"headerlink\" title=\"服务类型\"\u003e\u003c/a\u003e服务类型\u003c/h3\u003e\u003ch4 id=\"ClusterIP\"\u003e\u003ca href=\"#ClusterIP\" class=\"headerlink\" title=\"ClusterIP\"\u003e\u003c/a\u003e\u003cstrong\u003eClusterIP\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e这是最常用的一种svc, Yaml文件如下:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eService\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-svc\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003edefault\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#svc所在的ns\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"string\"\u003eClusterIP\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#指定svc的类型: ClusterIP, NodeIP, loadBalancer, ExternalName\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#svc对外暴露的端口\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eprotocol:\u003c/span\u003e \u003cspan class=\"string\"\u003eTCP\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#访问协议: TCP, UDP, HTTP...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etargetPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#映射到容器里的端口\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eselector:\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#根据以下标签选择后端pod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eapp:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003ekubectl apply -f svc.yaml后, kubernetes会为这个svc分配一个\u003ccode\u003eclusterIP\u003c/code\u003e的地址, 地址的范围从\u003ccode\u003ekube-apiserver\u003c/code\u003e的参数\u003ccode\u003eservice-cluster-ip-range\u003c/code\u003e获取.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eClusterIP因为是个虚IP(没有实际的网卡), 所以无法ping通,也无法单独使用,必须要跟端口一起使用\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003etype默认为ClusterIP, 这种service只能在集群内部访问.\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"无label-selector\"\u003e\u003ca href=\"#无label-selector\" class=\"headerlink\" title=\"无label selector\"\u003e\u003c/a\u003e\u003cstrong\u003e无label selector\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e这种场景一般用在服务搭建在kubernetes集群外,但是需要在集群内部访问(\u003ccode\u003e前提要网络可达\u003c/code\u003e)如数据库,中间件等.\u003c/p\u003e\n\u003cp\u003eYaml文件如下:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eService\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003econsul\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003eexternal\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eprotocol:\u003c/span\u003e \u003cspan class=\"string\"\u003eTCP\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e8500\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003etargetPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e8500\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eEndpoints\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003econsul\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003eexternal\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003esubsets:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaddresses:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eip:\u003c/span\u003e \u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.214\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eip:\u003c/span\u003e \u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.211\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eip:\u003c/span\u003e \u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.213\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e8500\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e由于consul服务是部署在集群外的, 所以这类的svc是不会自动创建endpoint对象(也就没法通过label选择后端应用),所以需要手工create endpoint对象, \u003ccode\u003e使svc跟ep配对\u003c/code\u003e,这样,从svc进来的请求即会路由到consul服务.\u003c/p\u003e\n\u003ch4 id=\"ExternalName\"\u003e\u003ca href=\"#ExternalName\" class=\"headerlink\" title=\"ExternalName\"\u003e\u003c/a\u003e\u003cstrong\u003eExternalName\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e这种场景一般用在服务搭建在kubernetes集群外,但是需要在集群内部访问(\u003ccode\u003e前提要网络可达\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eExternalName目的是构造一条dns记录,即通过svc访问的请求直接通过dns转发到目的服务.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eYaml文件如下:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eService\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eredis\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003eexternal\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eexternalName:\u003c/span\u003e \u003cspan class=\"string\"\u003er-bp123b06a718fd74.redis.rds.aliyuncs.com\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003edefault\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e6379\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eprotocol:\u003c/span\u003e \u003cspan class=\"string\"\u003eTCP\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etargetPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e6379\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esessionAffinity:\u003c/span\u003e \u003cspan class=\"string\"\u003eNone\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"string\"\u003eExternalName\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"服务发现\"\u003e\u003ca href=\"#服务发现\" class=\"headerlink\" title=\"服务发现\"\u003e\u003c/a\u003e\u003cstrong\u003e服务发现\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e目前kubernetes支持两种服务发现: \u003ccode\u003e环境变量, DNS\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"环境变量\"\u003e\u003ca href=\"#环境变量\" class=\"headerlink\" title=\"环境变量\"\u003e\u003c/a\u003e\u003cstrong\u003e环境变量\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e通过在资源对象中注入环境变量的方式,使应用能够感知对端应用. \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e不推荐\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"DNS\"\u003e\u003ca href=\"#DNS\" class=\"headerlink\" title=\"DNS\"\u003e\u003c/a\u003e\u003cstrong\u003eDNS\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e\u003ccode\u003eLabelSelector机制解决对象的关联关系,而DNS机制则解决服务路由问题.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e每个集群中都会部署dns服务,用于集群内部的\u003ccode\u003e域名解析\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/kube-dns2.png\"/\u003e\u003c/p\u003e\n\u003cp\u003eKube-dns由3个容器组成:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ekubedns\u003c/code\u003e：kubedns进程监视 Kubernetes master 中的 Service 和 Endpoint 的变化，并维护内存查找结构来服务DNS请求 \u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ednsmasq\u003c/code\u003e：dnsmasq容器添加 DNS 缓存以提高性能, 参数中指定upstream为kubedns\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esidecar\u003c/code\u003e：sidecar容器在执行双重健康检查（针对 dnsmasq 和 kubedns）时提供单个健康检查端点（监听在10054端口）\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003ekubernetes的新版本中,已经使用了coreDNS代替了kube-dns做为集群默认的dns, coredns在效率方面比kube-dns更高\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e具体dns如何做服务发现的呢?\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e每个node上运行的kube-proxy是实现service的载体,而kube-proxy则是创建一系列iptables规则实现代理\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"路由分析\"\u003e\u003ca href=\"#路由分析\" class=\"headerlink\" title=\"路由分析\"\u003e\u003c/a\u003e路由分析\u003c/h3\u003e\u003cp\u003e\u003ccode\u003e为何在应用中使用nginx-deployment:8008就能够访问某个应用?\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e首先了解一下\u003ccode\u003enginx-deployment\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enginx-deployment\u003c/code\u003e在kubernetes集群中其实是个域名, 完整的域名应该是\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003enginx-deployment.default.svc.cluster.local\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e集群中所说的服务发现一般是对于service来说的, service的域名规则如下:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eservice-name.namespace.svc.cluster.local\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e集群在部署时会要求给定一个\u003ccode\u003e静态的ip\u003c/code\u003e做为dns服务对外暴露的ip(也是个\u003ccode\u003eClusterIP, 不是真实的dns容器ip\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003e同时会定义好集群默认域名后缀: \u003ccode\u003ecluster.local\u003c/code\u003e, 默认地对于service类型的资源来说就是\u003ccode\u003esvc.cluster.local\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/unknown-4324463.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e部署时会把这两个当成是kubelet的启动命令的参数传入, 这样每次有新pod的创建请求时都会把这两个参数传入pod中, 这样会把dns的ip写在容器/etc/resolv.conf\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121165045218.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e除了写了nameserver之外,还有\u003ccode\u003esearch domain: 简单来讲就是通过这个列表把短域名拼接成完整域名的规则\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e因此,如果调用对端服务的容器跟对端服务是在一个namespace时, 是可以不指定namespace\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e而如果是在不同的namespace时,则必须使用service-xxx.namespace-xxx的形式,不然无法找到改域名.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e域名解析流程如下:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e当我们在容器内部使用\u003ccode\u003enginx-deployment\u003c/code\u003e时,从/etc/resolv.conf文件内的规则被dns resolver拼接成了\u003ccode\u003enginx-deployment.default.svc.cluster.local\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e然后再将\u003ccode\u003enginx-deployment.default.svc.cluster.local\u003c/code\u003e交由\u003ccode\u003e10.96.0.10\u003c/code\u003e进行解析\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e10.96.0.10\u003c/code\u003e将域名解析转到kube-dns容器, 因为kube-dns内缓存了所有service与ip的映射关系,返回service的ip, 这里是ClusterIP.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e接下来的流程就是 ClusterIP如何将流量转向real pod了.\u003c/p\u003e\n\u003cp\u003e假设有如下的svc, nginx:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esvc name: nginx-deployment.k8s-test.cluster.local\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eclusterIP: 10.108.141.150\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121171756110.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e根据ClusterIP查看iptables规则(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.zsythink.net/archives/1199\"\u003eiptables系列讲解\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121172244270.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以看到，目的地址为CLUSTER-IP、目的端口为80的数据包，会被转发到\u003ccode\u003eKUBE-MARK-MASQ与KUBE-SVC-Y7T6WNKYLXPYVSY3\u003c/code\u003e链上。\u003c/p\u003e\n\u003cp\u003e其中，\u003ccode\u003eKUBE-MARK-MASQ\u003c/code\u003e链的作用是给数据包打上特定的标记，以及后续对这些标记的数据做SNAT, \u003ccode\u003e可以无视\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e每个KUBE-SERVICES 说明是一条service, KUBE-SVC-xxx则是具体的svc规则.\u003c/p\u003e\n\u003cp\u003e重点来看下\u003ccode\u003eKUBE-SVC-Y7T6WNKYLXPYVSY3\u003c/code\u003e链:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121181631608.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e从图中可以看到KUBE-SVC-Y7T6WNKYLXPYVSY3按照等概率地(\u003ccode\u003e--mode random --probability 0.500000000\u003c/code\u003e)把请求转发给\u003ccode\u003eKUBE-SEP-L665HS3BZVTLMHTG\u003c/code\u003e及\u003ccode\u003eKUBE-SEP-BWQQW4YACEFQQND7\u003c/code\u003e\u003cbr/\u003e\u003ccode\u003e从这里也可以看到, 第一次转发的链名称是KUBE-SVC-xxx，第二次转发给具体pod的链名称是KUBE-SEP-xxx，这里的SEP实际指的是kubernetes的endpoint对象\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e看下SEP链:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121182204452.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以看到最终这两条规则转发到了CLusterIP后的某个pod的ip及端口上.\u003c/p\u003e\n\u003cp\u003e这样就完成了整个service name到readl pod的查找,\u003ccode\u003e后续如何将请求转发到pod内，这部分工作是由容器网络完成的,由于容器网络跟特定使用的组件有关,不同的容器网络机制大多不同,时间关系,这里不展开讨论.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eService默认是轮询选择后端, 到达kube-proxy则是使用–mode random –probability来设置pod承载的流量\u003c/p\u003e\n\u003cp\u003e我们也可以在service中指定会话保持.让同一个client的请求访问同一个backend. 只需要在service YAML中指即可，路由规则与上述原理类似.\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003esessionAffinity:\u003c/span\u003e \u003cspan class=\"string\"\u003eClientIP\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003esessionAffinityConfig:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eclientIP:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etimeoutSeconds:\u003c/span\u003e \u003cspan class=\"number\"\u003e10800\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e网上抄图总结一下: \u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121184027548.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/\"\u003ehttps://kubernetes.io\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://hansedong.github.io/2018/11/20/9/\"\u003ehttps://hansedong.github.io/2018/11/20/9/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-10-15T14:30:53+08:00",
  "Author": "Z.S.K."
}