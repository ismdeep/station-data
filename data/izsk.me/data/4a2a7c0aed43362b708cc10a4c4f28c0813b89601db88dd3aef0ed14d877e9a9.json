{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(apiserver证书中新增IP/DNS)",
  "Link": "https://izsk.me/2020/04/29/Kubernetes-add-new-cert-into-apiserver/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e主要用于修改由kubeadm部署的集群需要修改apiserver中证书信息的DNS. 比如apiserver的vip突然变动就会需要这个操作,防范于未然, 到真遇到的时候也不至于手忙脚乱不知所措, 有预案就好办. \u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003cp\u003e注: 以下步骤是假定集群部署时使用kubeadm, 且使用的默认的CA签署的证书.\u003c/p\u003e\n\u003cp\u003e###Kubeadm config配置修改 \u003c/p\u003e\n\u003ch4 id=\"查看证书中包含的dns\"\u003e\u003ca href=\"#查看证书中包含的dns\" class=\"headerlink\" title=\"查看证书中包含的dns\"\u003e\u003c/a\u003e查看证书中包含的dns\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eopenssl x509 -\u003cspan class=\"keyword\"\u003ein\u003c/span\u003e apiserver.crt -noout -text\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200507144124.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以看到当前证书中已经存在的认证的域名\u003c/p\u003e\n\u003cp\u003e查看当前存在的kubeadm config.yaml\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubeadm config view \u0026gt; /root/kubeadmconf.yml\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubeadm.k8s.io/v1beta1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eClusterConfiguration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekubernetesVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1.15.4\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003econtrolPlaneEndpoint:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;172.20.25.26:16443\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eimageRepository:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;registry.aliyuncs.com/google_containers\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003enetworking:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003epodSubnet:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;10.244.0.0/16\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiServer:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecertSANs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;172.20.25.26\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;k8s.cluster.local\u0026#34;\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 新增域名\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"删除证书\"\u003e\u003ca href=\"#删除证书\" class=\"headerlink\" title=\"删除证书\"\u003e\u003c/a\u003e删除证书\u003c/h4\u003e\u003cp\u003e删除k8s证书目录中的apiserver.crt 、apiserver.key\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecd\u003c/span\u003e /etc/kubernetes/pki\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003emv\u003c/span\u003e apiserver.crt apiserver.key ~\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"生成新证书\"\u003e\u003ca href=\"#生成新证书\" class=\"headerlink\" title=\"生成新证书\"\u003e\u003c/a\u003e生成新证书\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubeadm init phase certs apiserver --config kubeadm-config.yaml\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"更新kubeadm-ConfigMap\"\u003e\u003ca href=\"#更新kubeadm-ConfigMap\" class=\"headerlink\" title=\"更新kubeadm ConfigMap\"\u003e\u003c/a\u003e更新kubeadm ConfigMap\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubeadm config upload from-file --config /root/kubeadmconf.yml\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"重启kubelet\"\u003e\u003ca href=\"#重启kubelet\" class=\"headerlink\" title=\"重启kubelet\"\u003e\u003c/a\u003e重启kubelet\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003esystemctl daemon-reload\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esystemctl restart kubelet\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"重启apiserver\"\u003e\u003ca href=\"#重启apiserver\" class=\"headerlink\" title=\"重启apiserver\"\u003e\u003c/a\u003e重启apiserver\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003edocker ps -af name=k8s_kube-apiserver* -q | xargs --no-run-if-empty docker \u003cspan class=\"built_in\"\u003erm\u003c/span\u003e -f\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e再次查看证书后会发现新增域名已经包含在证书里面了.\u003c/p\u003e\n\u003ch3 id=\"certSANs的作用\"\u003e\u003ca href=\"#certSANs的作用\" class=\"headerlink\" title=\"certSANs的作用\"\u003e\u003c/a\u003ecertSANs的作用\u003c/h3\u003e\u003cp\u003eKubernetes apiserver使用数字证书来加密去往/来自API服务器的流量以及对与apiserver的连接进行身份验证。这样，如果您尝试使用诸如kubectl之类的命令行客户端连接到APIserver，并且使用的证书Subject Alternative Names（SAN）列表中未包含的主机名或IP地址，就会得到一个错误，指示证书对于指定的IP地址或主机名无效。要解决此问题，需要更新证书，以便SAN列表中包含用于访问API服务器的所有IP地址或主机名\u003c/p\u003e\n\u003cp\u003e使用kubeadm默认部署的情况下, kubeadm会将一些默认的dns比如\u003ccode\u003ekubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local\u003c/code\u003e等加入到证书列表中\u003c/p\u003e\n\u003cp\u003e这个从kubeadm的部署日志中可以看到\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eI0326 02:57:52.228780    2975 version.go:237] remote version is much newer: v1.14.0; falling back to: stable-1.13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[certs] Generating \u003cspan class=\"string\"\u003e\u0026#34;apiserver\u0026#34;\u003c/span\u003e certificate and key\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[certs] apiserver serving cert is signed \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e DNS names [master kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.148.0.39]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e因此也建议在部署时, \u003cstrong\u003e将所有master节点的hostname、ip、127.0.0.1、apiserver的VIP等加入到certSANs列表中\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"rancher是如何实现的\"\u003e\u003ca href=\"#rancher是如何实现的\" class=\"headerlink\" title=\"rancher是如何实现的\"\u003e\u003c/a\u003erancher是如何实现的\u003c/h3\u003e\u003cp\u003e因为生产环境使用的是rancher做为k8s集群管理平台, 看到上面的结论让我想到一个疑问:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e既然在证书列表中的ip才可以通过apiserver的认证, 为何从rancher上导出的kubeconfig file入到本地机器(ip不在apiserver的证书列表中, 与rancher平台网络是想通的)也可以访问集群？\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e其实想想也好解释, 我们在rancher上的操作，其实都不是直接访问的apiserver，而是通过rancher去连接的apiserver, 想想在用rancher托管k8s集群时, rancher是不是需要在k8s集群中安装agent?\u003c/p\u003e\n\u003cp\u003e答案就在agent上，rancher web上的所有操作都被转到了rancher server上而被下发到rancher agent上, 所有的认证及权限或者其它跟apiserver通信的操作都由rancher agent上完成\u003c/p\u003e\n\u003cp\u003e而rancher agent是以daemonset的方式部署在master上, 这样，master的ip自然是在apiserver的认证列表中.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200507164258.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/\"\u003ehttps://kubernetes.io\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.scottlowe.org/2019/07/30/adding-a-name-to-kubernetes-api-server-certificate/\"\u003ehttps://blog.scottlowe.org/2019/07/30/adding-a-name-to-kubernetes-api-server-certificate/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-04-29T13:30:53+08:00",
  "Author": "Z.S.K."
}