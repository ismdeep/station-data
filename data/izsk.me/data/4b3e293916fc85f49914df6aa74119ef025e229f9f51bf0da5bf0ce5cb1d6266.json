{
  "Source": "izsk.me",
  "Title": "supervisor使用自定义邮件报警模板",
  "Link": "https://izsk.me/2019/09/10/supervisor-alert-mail-template-customize/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e生产中由于历史遗留问题，有些程序还是二进制部署, 对于这类程序需要使用守护进程进行托管，常用的能实现对程序进行守护的用的多的有如systemd, supervisor,monit等工具, monit其实更好用一些，拓展性也很强，但是因为线上已经有一些使用了supervisor，为了工具统一化，就都使用了supervisor了，这次讲一讲supervisor使用\u003cstrong\u003e自定义邮件模板\u003c/strong\u003e实现报警的实现\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch3 id=\"supervisor\"\u003e\u003ca href=\"#supervisor\" class=\"headerlink\" title=\"supervisor\"\u003e\u003c/a\u003e\u003cstrong\u003esupervisor\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e需要说明一下,  \u003cstrong\u003esupervisor只能管理在前台运行的程序, 所以如果应用事先是以nohup \u0026amp;的方式启动的,则需要先停止该应用,然后使用supervisor守护启动\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003esupervisor的安装及使用很简单，大家可直接参考supervisor的\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://supervisord.org/\"\u003e官网\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"superlance\"\u003e\u003ca href=\"#superlance\" class=\"headerlink\" title=\"superlance\"\u003e\u003c/a\u003e\u003cstrong\u003esuperlance\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003esupervisor本身是没有邮件报警的, 好在它有上拓展插件可以直接使用, 但是它自带的邮件没有格式，非常难看，因此需要修改源码来使用我们自己的邮件模板\u003c/p\u003e\n\u003cp\u003esuperlane的gitlab在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/Supervisor/superlance\"\u003e这里\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003esuperlance中提供了多种报警场景, 这里使用\u003cstrong\u003ecrashmail\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e直接通过\u003ccode\u003epython setup.py install\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e这里安装的是已经被我修改了源码，集成了自定义邮件模板后的包, 修改后的包在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/zhoushuke/superlanceX\"\u003e这里\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e自定义邮件模块在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/zhoushuke/superlanceX/blob/master/superlance/sendxmail.py\"\u003e这个文件\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"启用crashmail\"\u003e\u003ca href=\"#启用crashmail\" class=\"headerlink\" title=\"启用crashmail\"\u003e\u003c/a\u003e\u003cstrong\u003e启用crashmail\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e在supervisor中加入一个配置文件,以开启crashmail\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[eventlistener:crashmail-exited]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e=crashmail -a -f \u003cspan class=\"string\"\u003e\u0026#34;http://your.mail.domain\u0026#34;\u003c/span\u003e -t \u003cspan class=\"string\"\u003e\u0026#34;\u003ca href=\"/cdn-cgi/l/email-protection\" class=\"__cf_email__\" data-cfemail=\"532b2b132a3c26217d363e323a3f7d303c3e\"\u003e[email protected]\u003c/a\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eevents=PROCESS_STATE_EXITED\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eredirect_stderr=\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estdout_logfile=/etc/supervisor/logs/crashmail-exited-stdout.log\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estderr_logfile=/etc/supervisor/logs/crashmail-exited-stderr.log\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003ehttp://your.mail.domain\u003c/code\u003e是一个用golang写的一个邮件接口,通过restfulapi暴露出来后,可直接调用.大家也可以使用自己的邮件服务.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eevents=PROCESS_STATE_EXITED\u003c/code\u003e指定当程序异常退出时产生事件.\u003c/p\u003e\n\u003cp\u003eCrashmail的参数大家可以参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/zhoushuke/superlanceX/blob/master/superlance/crashmail.py\"\u003egithub\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"安装守护进程\"\u003e\u003ca href=\"#安装守护进程\" class=\"headerlink\" title=\"安装守护进程\"\u003e\u003c/a\u003e\u003cstrong\u003e安装守护进程\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e假设要守护的进程为influxdb, 增加以下配置文件至 /etc/supervisor/conf.d/influxdb.conf\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e新配置文件的配置文件一定要以conf结尾\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[program:influxdb]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edirectory = /usr/bin\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e = /usr/bin/influxd -config /etc/influxdb/influxdb.conf\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estartsecs = 5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eautostart = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eautorestart = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estdout_logfile = /etc/supervisor/logs/supervisor-influxdb-stdout.log\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estderr_logfile = /etc/supervisor/logs/supervisor-influxdb-stderr.log\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e说明: 某些软件如果直接是从apt-get上下载安装的,可能会存在下载安装完之后已经被systemd托管了,这种情况下supervisor无法接管,可先从systemd中把该应用disable掉, 再使用supervisor托管\u003c/p\u003e\n\u003cp\u003e查看是否被systemd托管\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esystemctl status influxd.service\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e如果状态为active则说明已被托管.\u003c/p\u003e\n\u003cp\u003e从systemd去除托管状态\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esystemctl stop influxd.service\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esystemctl disable influxd.service\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e最后使用以下命令将新增的配置文件加入到supervisor中托管\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003esupervisorctl update\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e可使用\u003ccode\u003esupervisorctl status\u003c/code\u003e查看influxdb是否启动成功.\u003c/p\u003e\n\u003ch3 id=\"最终效果\"\u003e\u003ca href=\"#最终效果\" class=\"headerlink\" title=\"最终效果\"\u003e\u003c/a\u003e\u003cstrong\u003e最终效果\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003esupervisor检测到程序发生异常退出后，即会通过邮件发送报警\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200121115221.png\"/\u003e\u003c/p\u003e\n\u003cp\u003esuperlance自定义模块在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/zhoushuke/superlanceX\"\u003e这里\u003c/a\u003e可以找到\u003c/p\u003e\n\u003cp\u003e自定义邮件模块在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/zhoushuke/superlanceX/blob/master/superlance/sendxmail.py\"\u003e这个文件\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"supervisor常用命令\"\u003e\u003ca href=\"#supervisor常用命令\" class=\"headerlink\" title=\"supervisor常用命令\"\u003e\u003c/a\u003e\u003cstrong\u003esupervisor常用命令\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e#重启supervisor \u003c/p\u003e\n\u003cp\u003esupervisorctl reload \u003c/p\u003e\n\u003cp\u003e#查看当前守护的进程 \u003c/p\u003e\n\u003cp\u003esupervisorctl status \u003c/p\u003e\n\u003cp\u003e#加入新增加的配置文件 \u003c/p\u003e\n\u003cp\u003esupervisorctl update \u003c/p\u003e\n\u003cp\u003e#只会读取有更新的配置文件，不会启动新增加的配置文件 \u003c/p\u003e\n\u003cp\u003esupervisorctl reread \u003c/p\u003e\n\u003cp\u003e#关闭某一进程守护 \u003c/p\u003e\n\u003cp\u003esupervisorctl stop cassandra \u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://supervisord.org/\"\u003esupervisor\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/Supervisor/superlance\"\u003esuperlance\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-09-10T11:45:53+08:00",
  "Author": "Z.S.K."
}