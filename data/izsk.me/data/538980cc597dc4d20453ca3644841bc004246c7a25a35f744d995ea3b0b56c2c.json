{
  "Source": "izsk.me",
  "Title": "FELK学习(elastalert源码分析)",
  "Link": "https://izsk.me/2020/06/02/EFLK-elastalert-sourcecode/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在调研elastalert时几乎把整个源码都看了一遍，记录一下几个重要的部分.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"核心查询\"\u003e\u003ca href=\"#核心查询\" class=\"headerlink\" title=\"核心查询\"\u003e\u003c/a\u003e核心查询\u003c/h3\u003e\u003cp\u003erule文件配置的filter，最终都会转换成es底层支持的格式, 核心代码如下:\u003c/p\u003e\n \u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003eget_query\u003c/span\u003e(\u003cspan class=\"params\"\u003efilters, starttime=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, endtime=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, sort=\u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e, timestamp_field=\u003cspan class=\"string\"\u003e\u0026#39;@timestamp\u0026#39;\u003c/span\u003e, to_ts_func=dt_to_ts, desc=\u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"params\"\u003e              five=\u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u0026#34; Returns a query dict that will apply a list of filters, filter by\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    start and end time, and sort results by timestamp.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    :param filters: A list of Elasticsearch filters to use.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    :param starttime: A timestamp to use as the start time of the query.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    :param endtime: A timestamp to use as the end time of the query.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    :param sort: If true, sort results by timestamp. (Default True)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    :return: A query dictionary to pass to Elasticsearch.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    \u0026#34;\u0026#34;\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    starttime = to_ts_func(starttime)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    endtime = to_ts_func(endtime)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    filters = copy.copy(filters)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    es_filters = {\u003cspan class=\"string\"\u003e\u0026#39;filter\u0026#39;\u003c/span\u003e: {\u003cspan class=\"string\"\u003e\u0026#39;bool\u0026#39;\u003c/span\u003e: {\u003cspan class=\"string\"\u003e\u0026#39;must\u0026#39;\u003c/span\u003e: filters}}}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e starttime \u003cspan class=\"keyword\"\u003eand\u003c/span\u003e endtime:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        es_filters[\u003cspan class=\"string\"\u003e\u0026#39;filter\u0026#39;\u003c/span\u003e][\u003cspan class=\"string\"\u003e\u0026#39;bool\u0026#39;\u003c/span\u003e][\u003cspan class=\"string\"\u003e\u0026#39;must\u0026#39;\u003c/span\u003e].insert(\u003cspan class=\"number\"\u003e0\u003c/span\u003e, {\u003cspan class=\"string\"\u003e\u0026#39;range\u0026#39;\u003c/span\u003e: {timestamp_field: {\u003cspan class=\"string\"\u003e\u0026#39;gt\u0026#39;\u003c/span\u003e: starttime,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                                                                    \u003cspan class=\"string\"\u003e\u0026#39;lte\u0026#39;\u003c/span\u003e: endtime}}})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e five:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        query = {\u003cspan class=\"string\"\u003e\u0026#39;query\u0026#39;\u003c/span\u003e: {\u003cspan class=\"string\"\u003e\u0026#39;bool\u0026#39;\u003c/span\u003e: es_filters}}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        query = {\u003cspan class=\"string\"\u003e\u0026#39;query\u0026#39;\u003c/span\u003e: {\u003cspan class=\"string\"\u003e\u0026#39;filtered\u0026#39;\u003c/span\u003e: es_filters}}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e sort:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        query[\u003cspan class=\"string\"\u003e\u0026#39;sort\u0026#39;\u003c/span\u003e] = [{timestamp_field: {\u003cspan class=\"string\"\u003e\u0026#39;order\u0026#39;\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#39;desc\u0026#39;\u003c/span\u003e \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e desc \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;asc\u0026#39;\u003c/span\u003e}}]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e quer\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e最终转换成的格式如下, 如果查询的结果与期望值不一样，也可以生产的此语句进行排查.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl -H \u003cspan class=\"string\"\u003e\u0026#39;Content-Type: application/json\u0026#39;\u003c/span\u003e -XGET \u003cspan class=\"string\"\u003e\u0026#39;http://localhost:9200/demo.demo-*/_search?pretty\u0026amp;_source_include=%40timestamp%2C%2A\u0026amp;ignore_unavailable=true\u0026amp;scroll=30s\u0026amp;size=10000\u0026#39;\u003c/span\u003e -d \u003cspan class=\"string\"\u003e\u0026#39;{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;query\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    \u0026#34;bool\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;filter\u0026#34;: {                             \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;bool\u0026#34;: {                                                   \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          \u0026#34;must\u0026#34;: [            {                                                                                \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;range\u0026#34;: {                                                                                                                                                              \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;@timestamp\u0026#34;: {                                                                                           \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;gt\u0026#34;: \u0026#34;2020-05-29T11:04:00.198218Z\u0026#34;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;lte\u0026#34;: \u0026#34;2020-05-29T11:09:00.198218Z\u0026#34;                                                                                                                   \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                }                                          \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            },                                                 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;wildcard\u0026#34;: { # 这里是根据rule文件中的filter条件.                                                                                \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;backendMod\u0026#34;: \u0026#34;*senseface*\u0026#34;     \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }              \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            }                                    \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          ]                                                                                       \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        }                                                             \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }                                 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  },\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;sort\u0026#34;: [\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;@timestamp\u0026#34;: {                 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;order\u0026#34;: \u0026#34;asc\u0026#34;                                         \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }                                                                                             \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }                                                                                        \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  ]                                                                                     \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"match-body\"\u003e\u003ca href=\"#match-body\" class=\"headerlink\" title=\"match_body\"\u003e\u003c/a\u003ematch_body\u003c/h3\u003e\u003ch4 id=\"num-hits-vs-num-matches\"\u003e\u003ca href=\"#num-hits-vs-num-matches\" class=\"headerlink\" title=\"num_hits vs num_matches\"\u003e\u003c/a\u003enum_hits vs num_matches\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003enum_hits is the number of documents returned by elasticsearch \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e a given query. num_matches is how many \u003cspan class=\"built_in\"\u003etimes\u003c/span\u003e that data matched your rule, each one potentially generating an alert.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eIf it makes a query over a 10 minute range and gets 10 hits, and you have\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003etype\u003c/span\u003e: frequency\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003enum_events: 10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etimeframe:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  minutes: 10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003ethen\u003c/span\u003e you\u003cspan class=\"string\"\u003e\u0026#39;ll get 1 match.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e总结:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003enum_hits表示的是根据filter条件及查询时间段从es返回的记录,而num_matches表示的是预计会产生多少条报警\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e因此 num_matches = num_hits / num_events, 会四舍五入,所以在告警内容中会发现两者都是这样的关系\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"写回到es索引-elastalert-status\"\u003e\u003ca href=\"#写回到es索引-elastalert-status\" class=\"headerlink\" title=\"写回到es索引:elastalert_status\"\u003e\u003c/a\u003e写回到es索引:elastalert_status\u003c/h3\u003e\u003cp\u003e同样，产生的告警的现场日志在发送到告警介质后都会写入到es索引中\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003esend_alert\u003c/span\u003e(\u003cspan class=\"params\"\u003eself, matches, rule, alert_time=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, retried=\u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e alert \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e rule[\u003cspan class=\"string\"\u003e\u0026#39;alert\u0026#39;\u003c/span\u003e]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            alert.pipeline = alert_pipeline\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003etry\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert.alert(matches)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eexcept\u003c/span\u003e EAException \u003cspan class=\"keyword\"\u003eas\u003c/span\u003e e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                self.handle_error(\u003cspan class=\"string\"\u003e\u0026#39;Error while running alert %s: %s\u0026#39;\u003c/span\u003e % (alert.get_info()[\u003cspan class=\"string\"\u003e\u0026#39;type\u0026#39;\u003c/span\u003e], e), {\u003cspan class=\"string\"\u003e\u0026#39;rule\u0026#39;\u003c/span\u003e: rule[\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e]})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert_exception = \u003cspan class=\"built_in\"\u003estr\u003c/span\u003e(e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                self.thread_data.alerts_sent += \u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert_sent = \u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e matches:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            alert_body = self.get_alert_body(\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e, rule, alert_sent, alert_time, alert_exception)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"comment\"\u003e# Set all matches to aggregate together\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e agg_id:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert_body[\u003cspan class=\"string\"\u003e\u0026#39;aggregate_id\u0026#39;\u003c/span\u003e] = agg_id\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            res = self.writeback(\u003cspan class=\"string\"\u003e\u0026#39;elastalert\u0026#39;\u003c/span\u003e, alert_body, rule)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e res \u003cspan class=\"keyword\"\u003eand\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e agg_id:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                agg_id = res[\u003cspan class=\"string\"\u003e\u0026#39;_id\u0026#39;\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"starttime-x2F-endtime-x2F-original-time\"\u003e\u003ca href=\"#starttime-x2F-endtime-x2F-original-time\" class=\"headerlink\" title=\"starttime/endtime/original_time\"\u003e\u003c/a\u003estarttime/endtime/original_time\u003c/h3\u003e\u003cp\u003eendtime一般都是执行查询时取的当前时间，因此elastalert默认没有保存，starttime一般是由endtime减去timeframe计算而来，但是如果elastalert重启的话, starttime会跟期望的不太一样，通过源码可以看到还有一个original_time, original_time为存在在es中的上一次执行的endtime, 因此，每次查询的时候，都会从original_time处开始查询, endtime为当前时间\u003c/p\u003e\n\u003cp\u003e因此starttime最好设置为original_time，使用starttime有产生歧义\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ebody = {\u003cspan class=\"string\"\u003e\u0026#39;rule_name\u0026#39;\u003c/span\u003e: rule[\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;endtime\u0026#39;\u003c/span\u003e: endtime,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;starttime\u0026#39;\u003c/span\u003e: rule[\u003cspan class=\"string\"\u003e\u0026#39;original_starttime\u0026#39;\u003c/span\u003e],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;matches\u0026#39;\u003c/span\u003e: num_matches,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;hits\u0026#39;\u003c/span\u003e: max(self.thread_data.num_hits, self.thread_data.cumulative_hits),\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;@timestamp\u0026#39;\u003c/span\u003e: ts_now(),\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e               \u003cspan class=\"string\"\u003e\u0026#39;time_taken\u0026#39;\u003c/span\u003e: time_taken}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       self.writeback(\u003cspan class=\"string\"\u003e\u0026#39;elastalert_status\u0026#39;\u003c/span\u003e, body)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e当然为了避免elastalert重启时离上次运行的时间间隔太久, 默认情况下启动后会从es中读取\u003ccode\u003estarttime\u003c/code\u003e,以这个时间点到当前时间为时间窗口，然后以run_every给定的时间进行查询,所以，在这种情况下可能会出现刚重启时就出现大量的查询，很多时间太久的历史日志监控是无意义，因此可以在elastalert.yaml中指定\u003ccode\u003eold_query_limit: minutes: 1\u003c/code\u003e来限定starttime为当前时间的前一分钟.\u003c/p\u003e\n\u003ch3 id=\"enhancement\"\u003e\u003ca href=\"#enhancement\" class=\"headerlink\" title=\"enhancement\"\u003e\u003c/a\u003eenhancement\u003c/h3\u003e\u003cp\u003eelastalert提供两种方案可以让在找到匹配项后立即运行增强功能(run_enhancements_first)或者在发送告警前进行操作,比如修改match操作(match_enhancements)\u003c/p\u003e\n\u003ch4 id=\"run-enhancements-first\"\u003e\u003ca href=\"#run-enhancements-first\" class=\"headerlink\" title=\"run_enhancements_first\"\u003e\u003c/a\u003erun_enhancements_first\u003c/h4\u003e\u003cp\u003e如果在rule配置中指定的了run_enhancements_first，源码如下:\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003erun_rule\u003c/span\u003e(\u003cspan class=\"params\"\u003eself, rule, endtime, starttime=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  self.run_query()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e rule.get(\u003cspan class=\"string\"\u003e\u0026#39;run_enhancements_first\u0026#39;\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003etry\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e enhancement \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e rule[\u003cspan class=\"string\"\u003e\u0026#39;match_enhancements\u0026#39;\u003c/span\u003e]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003etry\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                            enhancement.process(\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e) \u003cspan class=\"comment\"\u003e# point\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003eexcept\u003c/span\u003e EAException \u003cspan class=\"keyword\"\u003eas\u003c/span\u003e e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                            self.handle_error(\u003cspan class=\"string\"\u003e\u0026#34;Error running match enhancement: %s\u0026#34;\u003c/span\u003e % (e), {\u003cspan class=\"string\"\u003e\u0026#39;rule\u0026#39;\u003c/span\u003e: rule[\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e]})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003eexcept\u003c/span\u003e DropMatchException:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003econtinue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"match-enhancements\"\u003e\u003ca href=\"#match-enhancements\" class=\"headerlink\" title=\"match_enhancements\"\u003e\u003c/a\u003ematch_enhancements\u003c/h4\u003e\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003esend_alert\u003c/span\u003e(\u003cspan class=\"params\"\u003eself, matches, rule, alert_time=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, retried=\u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e rule.get(\u003cspan class=\"string\"\u003e\u0026#39;run_enhancements_first\u0026#39;\u003c/span\u003e) \u003cspan class=\"keyword\"\u003eand\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e retried:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e enhancement \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e rule[\u003cspan class=\"string\"\u003e\u0026#39;match_enhancements\u0026#39;\u003c/span\u003e]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                valid_matches = []\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e matches:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003etry\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        enhancement.process(\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e) \u003cspan class=\"comment\"\u003e# point\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        valid_matches.append(\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003eexcept\u003c/span\u003e DropMatchException:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003epass\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003eexcept\u003c/span\u003e EAException \u003cspan class=\"keyword\"\u003eas\u003c/span\u003e e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        self.handle_error(\u003cspan class=\"string\"\u003e\u0026#34;Error running match enhancement: %s\u0026#34;\u003c/span\u003e % (e), {\u003cspan class=\"string\"\u003e\u0026#39;rule\u0026#39;\u003c/span\u003e: rule[\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e]})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                matches = valid_matches\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e matches:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003eNone\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    alert.alert(matches)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e很多人关心的elastalert没有保存的endtime字段，其实就可以match_enhancements中添加字段.\u003c/p\u003e\n\u003ch3 id=\"自定义告警\"\u003e\u003ca href=\"#自定义告警\" class=\"headerlink\" title=\"自定义告警\"\u003e\u003c/a\u003e自定义告警\u003c/h3\u003e\u003ch4 id=\"自定义邮件格式\"\u003e\u003ca href=\"#自定义邮件格式\" class=\"headerlink\" title=\"自定义邮件格式\"\u003e\u003c/a\u003e自定义邮件格式\u003c/h4\u003e\u003cp\u003e由于默认的邮件告警只是简单的把str格式的内容通过邮件发送出去,非常不美观，因此通过jinja2的形式自定义了邮件格式\u003c/p\u003e\n\u003cp\u003e首先在rule配置中定义\u003ccode\u003eemail_format: html\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e由于只是在发送邮件的时候才使用jinja2的html模板，因此需要对\u003ccode\u003ealert\u003c/code\u003e的类型进行判断\u003c/p\u003e\n\u003cp\u003e修改的源码如下:\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eBasicMatchString\u003c/span\u003e(\u003cspan class=\"title class_ inherited__\"\u003eobject\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u0026#34; Creates a string containing fields in match for the given rule. \u0026#34;\u0026#34;\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003e__init__\u003c/span\u003e(\u003cspan class=\"params\"\u003eself, rule, \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e, alert_type\u003c/span\u003e): \u003cspan class=\"comment\"\u003e# 新增一个alert_type，为告警类型\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        self.rule = rule\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        self.\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e = \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        self.alert_type = alert_type\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e    @staticmethod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003erender_html\u003c/span\u003e(\u003cspan class=\"params\"\u003esummary_str, data\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        env = Environment(loader=FileSystemLoader(\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            os.path.join(os.path.dirname(__file__), \u003cspan class=\"string\"\u003e\u0026#34;templates\u0026#34;\u003c/span\u003e)))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        template = env.get_template(\u003cspan class=\"string\"\u003e\u0026#39;mail.html.tpl\u0026#39;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        out = template.render(summary_str=summary_str, data=data)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e#with open(\u0026#39;mail.html\u0026#39;, \u0026#39;w\u0026#39;, encoding=\u0026#39;utf-8\u0026#39;) as f:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e#   f.write(out)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e out\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     \u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003e_add_custom_alert_text\u003c/span\u003e(\u003cspan class=\"params\"\u003eself\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        missing = self.rule.get(\u003cspan class=\"string\"\u003e\u0026#39;alert_missing_value\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;\u0026lt;MISSING VALUE\u0026gt;\u0026#39;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;alert_text_args\u0026#39;\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e self.rule:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            alert_text_args = self.rule.get(\u003cspan class=\"string\"\u003e\u0026#39;alert_text_args\u0026#39;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"comment\"\u003e# 判断告警的类型\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;email\u0026#39;\u003c/span\u003e == self.alert_type:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                summary_str = self.rule[\u003cspan class=\"string\"\u003e\u0026#39;type\u0026#39;\u003c/span\u003e].get_match_str(self.\u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert_text = \u003cspan class=\"built_in\"\u003estr\u003c/span\u003e(self.render_html(summary_str, alert_text_args))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"comment\"\u003e# 如果不是email则保存跟源码一致\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                alert_text = \u003cspan class=\"built_in\"\u003estr\u003c/span\u003e(self.rule.get(\u003cspan class=\"string\"\u003e\u0026#39;alert_text\u0026#39;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e由于所有的告警类型的基类都是\u003ccode\u003eAlerter\u003c/code\u003e,因此通过这个来传递告警类型.\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eAlerter\u003c/span\u003e(\u003cspan class=\"title class_ inherited__\"\u003eobject\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e#...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   \u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ecreate_alert_body\u003c/span\u003e(\u003cspan class=\"params\"\u003eself, matches\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        alert_type = self.get_info()[\u003cspan class=\"string\"\u003e\u0026#39;type\u0026#39;\u003c/span\u003e] \u003cspan class=\"comment\"\u003e# 通过get_info 获取alerter实例的type\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        body = self.get_aggregation_summary_text(matches)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e self.rule.get(\u003cspan class=\"string\"\u003e\u0026#39;alert_text_type\u0026#39;\u003c/span\u003e) != \u003cspan class=\"string\"\u003e\u0026#39;aggregation_summary_only\u0026#39;\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e matches:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                body += \u003cspan class=\"built_in\"\u003estr\u003c/span\u003e(BasicMatchString(self.rule, \u003cspan class=\"keyword\"\u003ematch\u003c/span\u003e, alert_type)) \u003cspan class=\"comment\"\u003e# 传入BasicMatchString\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"comment\"\u003e# Separate text of aggregated alerts with dashes\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(matches) \u0026gt; \u003cspan class=\"number\"\u003e1\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    body += \u003cspan class=\"string\"\u003e\u0026#39;\\n----------------------------------------\\n\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e body\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这样就完成自定义邮件格式了,模板如下:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200602165705.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e字段直接在rule文件中alert_text_args中传入即可.\u003c/p\u003e\n\u003ch4 id=\"微信报警\"\u003e\u003ca href=\"#微信报警\" class=\"headerlink\" title=\"微信报警\"\u003e\u003c/a\u003e微信报警\u003c/h4\u003e\u003cp\u003eelastalert本身支持自定义的告警接入，只需要实现\u003ccode\u003e body = self.create_alert_body(matches)\u003c/code\u003e方法即可.不难，难点在于企业微信api如何使用, 代码参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://anjia0532.github.io/2017/02/16/elastalert-wechat-plugin/\"\u003eelastalert-wechat-plugin\u003c/a\u003e, 亲测可用.\u003c/p\u003e\n\u003ch3 id=\"问题\"\u003e\u003ca href=\"#问题\" class=\"headerlink\" title=\"问题\"\u003e\u003c/a\u003e问题\u003c/h3\u003e\u003col\u003e\n\u003cli\u003e如果修改源码后rule执行出现问题, 则会自动地生成exception写入到索引中且该rule会被disable掉,直到不再报错之前都不再执行.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200601111948.png\"/\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e03:18:59.552Z ERROR elastalert-server:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ProcessController:  INFO:elastalert:Disabled rules are: [\u003cspan class=\"string\"\u003e\u0026#39;index realty find invalid keyword\u0026#39;\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003col start=\"2\"\u003e\n\u003cli\u003ees中的until字段记录了下次执行的时候(由apscheduler框架支持)\u003c/li\u003e\n\u003c/ol\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_index\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;demo.elastalert_status\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_type\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;silence\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_id\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;AXJt-tKUPz_v1Z2rFGRX\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_score\u0026#34;:\u003c/span\u003e \u003cspan class=\"literal\"\u003enull\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_source\u0026#34;:\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;exponent\u0026#34;:\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;rule_name\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;index realty find invalid keyword.senseface\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003cspan class=\"string\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;2020-06-01T03:44:13.967765Z\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;until\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;2020-06-01T03:49:13.967756Z\u0026#34;\u003c/span\u003e \u003cspan class=\"comment\"\u003e# here\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;fields\u0026#34;:\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003cspan class=\"string\"\u003e:\u003c/span\u003e [\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"number\"\u003e1590983053967\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ],\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;until\u0026#34;:\u003c/span\u003e [\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"number\"\u003e1590983353967\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;sort\u0026#34;:\u003c/span\u003e [\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"number\"\u003e1590983053967\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/Yelp/elastalert/issues/2754\"\u003ehttps://github.com/Yelp/elastalert/issues/2754\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://anjia0532.github.io/2017/02/16/elastalert-wechat-plugin/\"\u003ehttps://anjia0532.github.io/2017/02/16/elastalert-wechat-plugin/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://work.weixin.qq.com/api/doc\"\u003ehttps://work.weixin.qq.com/api/doc\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-06-02T15:30:53+08:00",
  "Author": "Z.S.K."
}