{
  "Source": "izsk.me",
  "Title": "Prometheus学习(Node-Exporter采集自定义Metrics)",
  "Link": "https://izsk.me/2019/08/28/prometheus-nodeexporter-customized-metrics/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e如果使用Prometheus做监控系统的话, node-exporter一定是不能绕过的采集工具, 开箱即用的实用性让运维同学节省很多时间, 最近也是发现了一个比较有意思的功能, NodeExporter可以采集额外的Metrics到Prometheus中\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003e假如有时我们有自定义的Metrics需要上传到Promethues中，一般情况下, 我们会通过PushGateway来做采集，假如这个时候恰恰没有部署PushGateway, 有没有更快捷的办法, 这个时候NodeExporter就派上用场了.\u003c/p\u003e\n\u003ch3 id=\"启动参数\"\u003e\u003ca href=\"#启动参数\" class=\"headerlink\" title=\"启动参数\"\u003e\u003c/a\u003e\u003cstrong\u003e启动参数\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e查看node-exporter的github描述,node-exporter启动的时候指定–collector.textfile.directory=/opt/exporter/node_exporter/key 即可, 这个参数会解析指定目录下的所有以prom结尾的文件.\u003c/p\u003e\n\u003cp\u003e即：\u003c/p\u003e\n\u003cp\u003e我们只需要把自定义脚本的输出Metrics数据写入到指定目录下的文件,并以Prom结尾即可, Prometheus在定时采集node exporter获取数据的时候，也会把这份数据一同上传, 非常方便\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e需要注意的是，要保证在Prometheus在一个周期内，自定义脚本将最新的数据写入文件中即可, 每次写入都需要覆盖之前的Metrics.如果文件内的Metrics没有更新，则会一直拿到之前的旧数据, 所以最好在执行之前执行旧数据的清理\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"自定义脚本\"\u003e\u003ca href=\"#自定义脚本\" class=\"headerlink\" title=\"自定义脚本\"\u003e\u003c/a\u003e\u003cstrong\u003e自定义脚本\u003c/strong\u003e\u003c/h3\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#! /bin/bash\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eprom_file=/opt/exporter/node_exporter/key/key.prom\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eIFS=\u003cspan class=\"string\"\u003e\u0026#34;;\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eexport\u003c/span\u003e TERM=vt100\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ekey_value=\u003cspan class=\"string\"\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eLogical_CPU_core_total  `cat /proc/cpuinfo| grep \u0026#34;\u003c/span\u003eprocessor\u003cspan class=\"string\"\u003e\u0026#34;| wc -l`;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003elogined_users_total     `who | wc -l`;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eprocs_total             `/bin/top -b -n 1|grep Tasks|sed \u0026#39;s/,/\\n/g\u0026#39;|grep total|awk \u0026#39;{ print \u003cspan class=\"subst\"\u003e$(NF-1)\u003c/span\u003e }\u0026#39;`;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eprocs_zombie            `/bin/top -b -n 1|grep Tasks|sed \u0026#39;s/,/\\n/g\u0026#39;|grep zombie|awk \u0026#39;{ print \u003cspan class=\"subst\"\u003e$(NF-1)\u003c/span\u003e }\u0026#39;`\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efor\u003c/span\u003e i \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"variable\"\u003e$key_value\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edo\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    IFS=\u003cspan class=\"string\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    j=(`\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"variable\"\u003e$i\u003c/span\u003e`)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    key=\u003cspan class=\"variable\"\u003e${j[0]}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    value=\u003cspan class=\"variable\"\u003e${j[1]}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e \u003cspan class=\"variable\"\u003e$key\u003c/span\u003e \u003cspan class=\"variable\"\u003e$value\u003c/span\u003e \u0026gt;\u0026gt; \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e$prom_file\u003c/span\u003e\u0026#34;\u003c/span\u003e.tmp\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edone\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecat\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e$prom_file\u003c/span\u003e\u0026#34;\u003c/span\u003e.tmp \u0026gt; \u003cspan class=\"variable\"\u003e$prom_file\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003erm\u003c/span\u003e -rf \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e$prom_file\u003c/span\u003e\u0026#34;\u003c/span\u003e.tmp\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eIFS=\u003cspan class=\"variable\"\u003e$OLD_IFS\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e加上可执行权限.\u003c/p\u003e\n\u003ch3 id=\"Crontab\"\u003e\u003ca href=\"#Crontab\" class=\"headerlink\" title=\"**Crontab **\"\u003e\u003c/a\u003e**Crontab **\u003c/h3\u003e\u003cp\u003e在系统的crontab上加上定时执行脚本\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/prometheus/node_exporter\"\u003enode_exporter\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/momoyan/p/11520676.html\"\u003enode-exporter的安装与配置\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-08-28T10:30:53+08:00",
  "Author": "Z.S.K."
}