{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(k8s基于InfiniBand实现HPC高性能容器网络组网方案实践一)",
  "Link": "https://izsk.me/2021/07/02/Kubernetes-Infinitband-SRIOV-network-1-backgroud/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在HPC场景下，底层网络的性能直接影响最终的结果，HPC往往会伴随海量的数据交换，特别是在跨Node之间，10Gb的以太网网络传输肯定要比100Gb的IB网络传输慢，本人所负责的训练平台也是如此，在一次训练过程中，GPU存在海量数据交换，虽然是在GPU之间，但本质还是通过网络进行传输，但是以太网的传输在HPC场景下往往显得不那么高效，因此可以通过RDMA或者如果预算够的话，通过硬件IB实现数据交换，能大大提高训练质量\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003cp\u003e本人所负责的训练平台是完全基于k8s的，现在要迁移至IB网络同时不影响现有业务进行，大大增加了实施难度，在经过一番调研之后，最终的方案为在原有的容器网络基础之上，再加一层IB网络层，即在k8s集群中同时存在2个网络，这在k8s是完全支持的，即在容器中除了eth0，由flannel cni分配， 还会有一个net1网络，由IB cni分配, eth0的网络用于集群之间的通信，而net1则用于训练时pod与pod节点进行通信，在实践之前先介绍几个比较重要的技术\u003c/p\u003e\n\u003ch3 id=\"Infinitband\"\u003e\u003ca href=\"#Infinitband\" class=\"headerlink\" title=\"Infinitband\"\u003e\u003c/a\u003eInfinitband\u003c/h3\u003e\u003cp\u003einfinitband做专门为高带宽，低时延，高可靠，不占用cpu资源的网络互联技术，大量被用于超算、AI等HPC场景下\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210704215748.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e这里不对infintband展开细说，感兴趣的可以参考下列连接\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/74238082\"\u003ehttps://zhuanlan.zhihu.com/p/74238082\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/163104439\"\u003ehttps://zhuanlan.zhihu.com/p/163104439\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/swingwang/article/details/72935461\"\u003ehttps://blog.csdn.net/swingwang/article/details/72935461\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"sr-iov\"\u003e\u003ca href=\"#sr-iov\" class=\"headerlink\" title=\"sr-iov\"\u003e\u003c/a\u003esr-iov\u003c/h3\u003e\u003cp\u003eSR-IOV (Single Root Input/Output Virtualization) 的主要作用是将一个物理设备模拟成多个虚拟设备,在虚拟化技术中使用非常频繁，\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003esr-iov需要硬件上的支持，好在目前大部分服务器都支持了该技术\u003c/strong\u003e，这里也不过多介绍其中的细节，后续用到的两个比较重要的概念:\u003c/p\u003e\n\u003cp\u003eSR-IOV引入了两种新的PCIe的Function：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ePFs：完整功能的PCIe Function包含了SR-IOV Extended Capability。这个Capability被用来配置和管理SR-IOV的功能。\u003c/li\u003e\n\u003cli\u003eVFs：一部分轻量级的PCIe function，只包含必要的用于数据移动的最小可配置的资源。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e一个 具备SR-IOV能力的设备可以被配置成被枚举出多个Virtual Functions（数量可控制），而且每个Funciton 都有自己的完整有BAR的配置空间。每个VF 分配给虚拟或者容器\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/347204232\"\u003ehttps://zhuanlan.zhihu.com/p/347204232\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/wangdd_199326/article/details/90476728\"\u003ehttps://blog.csdn.net/wangdd_199326/article/details/90476728\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"资源清单\"\u003e\u003ca href=\"#资源清单\" class=\"headerlink\" title=\"资源清单\"\u003e\u003c/a\u003e资源清单\u003c/h3\u003e\u003cp\u003e下列的资源清单为部分集群资源且机器ip不为真实ip\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e机器\u003c/th\u003e\n\u003cth\u003e角色\u003c/th\u003e\n\u003cth\u003e以太网/IB网卡\u003c/th\u003e\n\u003cth\u003e内核/发行版\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003e10.4.52.2\u003c/td\u003e\n\u003ctd\u003ek8s master/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/N\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10.4.52.3\u003c/td\u003e\n\u003ctd\u003ek8s master/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/N\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10.4.52.4\u003c/td\u003e\n\u003ctd\u003ek8s master/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/N\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10.4.52.5\u003c/td\u003e\n\u003ctd\u003ek8s node/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/Y，一个ib网口\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10.4.52.6\u003c/td\u003e\n\u003ctd\u003ek8s node/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/Y，一个ib网口\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e10.4.52.7\u003c/td\u003e\n\u003ctd\u003ek8s node/v1.15.5\u003c/td\u003e\n\u003ctd\u003eY/Y，一个ib网口\u003c/td\u003e\n\u003ctd\u003eLinux-4.19 centos7.4\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003emaster做为控制面，用于集群间的管理角色\u003c/p\u003e\n\u003cp\u003enode上做为数据面，以太网用于与控制面进行交互，同时IB网卡用于HPC业务\u003c/p\u003e\n\u003ch3 id=\"组网图\"\u003e\u003ca href=\"#组网图\" class=\"headerlink\" title=\"组网图\"\u003e\u003c/a\u003e组网图\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210704191648.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e在集群物理机器上，实际存在3个网络:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e管理网(eth1), 用于机器的管控网，一般叫做ipmi或者带外、外带等,在服务器上有专门的网口标识\u003c/li\u003e\n\u003cli\u003e业务网(eth0), 用于flannel的启动参数指定的网卡名，这个网络在pod中用于与k8s控制面进行交互\u003c/li\u003e\n\u003cli\u003eIB网(eth100), 用于ib网卡,在这个网卡上会通过sriov虚拟出若干网卡用于pod中\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"架构图\"\u003e\u003ca href=\"#架构图\" class=\"headerlink\" title=\"架构图\"\u003e\u003c/a\u003e架构图\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210704191622.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"实现目的\"\u003e\u003ca href=\"#实现目的\" class=\"headerlink\" title=\"实现目的\"\u003e\u003c/a\u003e实现目的\u003c/h3\u003e\u003cp\u003e最终要实现的目标为: 通过sriov在IB网卡上实现高性能容器网络以加速分布式训练的GPU数据交换\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/347204232\"\u003ehttps://zhuanlan.zhihu.com/p/347204232\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/wangdd_199326/article/details/90476728\"\u003ehttps://blog.csdn.net/wangdd_199326/article/details/90476728\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/74238082\"\u003ehttps://zhuanlan.zhihu.com/p/74238082\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/163104439\"\u003ehttps://zhuanlan.zhihu.com/p/163104439\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/swingwang/article/details/72935461\"\u003ehttps://blog.csdn.net/swingwang/article/details/72935461\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2021-07-02T16:10:53+08:00",
  "Author": "Z.S.K."
}