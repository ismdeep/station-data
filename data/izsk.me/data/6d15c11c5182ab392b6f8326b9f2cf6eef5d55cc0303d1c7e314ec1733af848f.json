{
  "Source": "izsk.me",
  "Title": "Kubernetes之ListOption参数源码分析",
  "Link": "https://izsk.me/2023/12/16/Kubernetes-listOption-2/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e书接上一篇\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2023/12/14/Kubernetes-listOption-1/\"\u003eKubernetes之List参数使用不当引发的ETCD网络风暴\u003c/a\u003e说最近排查了一个因业务层使用List接口时因参数使用不当引起的etcd压力极速增长的问题, 该篇将按图索骥来看看ListOption在源码是如何处理的\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\u003ch3 id=\"处理逻辑\"\u003e\u003ca href=\"#处理逻辑\" class=\"headerlink\" title=\"处理逻辑\"\u003e\u003c/a\u003e处理逻辑\u003c/h3\u003e\u003cp\u003e\u003ccode\u003ekube-apiserver\u003c/code\u003e \u003ccode\u003eLIST\u003c/code\u003e 请求处理逻辑可以看到下图\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://arthurchiao.art/blog/k8s-reliability-list-data-zh/\"\u003e原图地址\u003c/a\u003e：\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://arthurchiao.art/assets/img/k8s-reliability-list-data/apiserver-processing-list-request.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e以上可以看到，系统路径中存在\u003cstrong\u003e两级 List/ListWatch\u003c/strong\u003e（\u003cstrong\u003e但数据是同一份\u003c/strong\u003e）：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eapiserver List/ListWatch etcd\u003c/li\u003e\n\u003cli\u003e其它对象如controller/operator List/ListWatch apiserver\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e因此，从最简形式上来说，\u003cstrong\u003eapiserver 就是挡在 etcd 前面的一个代理\u003c/strong\u003e（proxy），\u003c/p\u003e\n\u003cfigure class=\"highlight plaintext\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e  +--------+              +---------------+                 +------------+\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  | Client | -----------\u0026gt; | Proxy (cache) | --------------\u0026gt; | Data store |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  +--------+              +---------------+                 +------------+\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003einfra services               apiserver                         etcd\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e对于List请求可归类为两种：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eapiserver直接从自己的缓存中读数据\u003c/li\u003e\n\u003cli\u003eapiserver跳过缓存，直接从etcd读数据\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e还是以使用client-go中listJob为例, 常见写法:\u003c/p\u003e\n\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// ListJobs lists all jobs details.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"title\"\u003eListJobs\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"type\"\u003eerror\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    config, err := util.BuildConfig(listJobFlags.Master, listJobFlags.Kubeconfig)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e listJobFlags.allNamespace {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        listJobFlags.Namespace = \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    jobClient := versioned.NewForConfigOrDie(config)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    jobs, err := jobClient.BatchV1alpha1().Jobs(listJobFlags.Namespace).List(context.TODO(), metav1.ListOptions{})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(jobs.Items) == \u003cspan class=\"number\"\u003e0\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        fmt.Printf(\u003cspan class=\"string\"\u003e\u0026#34;No resources found\\n\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    PrintJobs(jobs, os.Stdout)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e来看看ListOptions的struct, 这里因篇幅有限，所以将注释去除了\u003c/p\u003e\n\u003cp\u003e \u003cstrong\u003ekubernetes based on v1.22\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"ListOptions\"\u003e\u003ca href=\"#ListOptions\" class=\"headerlink\" title=\"ListOptions\"\u003e\u003c/a\u003eListOptions\u003c/h3\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// pkg/apis/meta/v1/types.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003etype\u003c/span\u003e ListOptions \u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    TypeMeta \u003cspan class=\"string\"\u003e`json:\u0026#34;,inline\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    LabelSelector \u003cspan class=\"type\"\u003estring\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;labelSelector,omitempty\u0026#34; protobuf:\u0026#34;bytes,1,opt,name=labelSelector\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    FieldSelector \u003cspan class=\"type\"\u003estring\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;fieldSelector,omitempty\u0026#34; protobuf:\u0026#34;bytes,2,opt,name=fieldSelector\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Watch \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;watch,omitempty\u0026#34; protobuf:\u0026#34;varint,3,opt,name=watch\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    AllowWatchBookmarks \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;allowWatchBookmarks,omitempty\u0026#34; protobuf:\u0026#34;varint,9,opt,name=allowWatchBookmarks\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ResourceVersion \u003cspan class=\"type\"\u003estring\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;resourceVersion,omitempty\u0026#34; protobuf:\u0026#34;bytes,4,opt,name=resourceVersion\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ResourceVersionMatch ResourceVersionMatch \u003cspan class=\"string\"\u003e`json:\u0026#34;resourceVersionMatch,omitempty\u0026#34; protobuf:\u0026#34;bytes,10,opt,name=resourceVersionMatch,casttype=ResourceVersionMatch\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    TimeoutSeconds *\u003cspan class=\"type\"\u003eint64\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;timeoutSeconds,omitempty\u0026#34; protobuf:\u0026#34;varint,5,opt,name=timeoutSeconds\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Limit \u003cspan class=\"type\"\u003eint64\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;limit,omitempty\u0026#34; protobuf:\u0026#34;varint,7,opt,name=limit\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Continue \u003cspan class=\"type\"\u003estring\u003c/span\u003e \u003cspan class=\"string\"\u003e`json:\u0026#34;continue,omitempty\u0026#34; protobuf:\u0026#34;bytes,8,opt,name=continue\u0026#34;`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col\u003e\n\u003cli\u003eLabelSelector/FieldSelector: 标签选择器与字段选择器, 上文提到, \u003cstrong\u003eetcd只是KV存储，并不理解label/field这些信息，因此在etcd层面无法处理这些过滤条件\u003c/strong\u003e。 所以如果是没走apiserver的缓存直接到达etcd的实际的过程是：apiserver 从 etcd 拉全量数据，然后在内存做过滤，再返回给客户端\u003c/li\u003e\n\u003cli\u003eWatch及AllowWatchBookmarks: AllowWatchBookmarks也是个很有用的功能，但并不是本文的重点，并不展开说明\u003c/li\u003e\n\u003cli\u003eResourceVersion/ResourceVersionMatch: 资源版本\u003c/li\u003e\n\u003cli\u003eLimit: 分页功能, 最常见的例子是kubectl命令行工具,会自动将请求加上limit=500这个查询参数, 可以使用kubectl –v=8看到\u003c/li\u003e\n\u003cli\u003eContinue: 是个token,是否期望从server端返回最多的结果\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这里主要会聚焦ResourceVersion\u003c/p\u003e\n\u003cp\u003e从上面可以看出ResousrceVersion的默认类型为string,所以默认值为空，来看看apiserver \u003ccode\u003eList()\u003c/code\u003e 操作源码分析\u003c/p\u003e\n\u003ch3 id=\"List-调用链\"\u003e\u003ca href=\"#List-调用链\" class=\"headerlink\" title=\"List()调用链\"\u003e\u003c/a\u003e\u003ccode\u003eList()调用链\u003c/code\u003e\u003c/h3\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003estore.List\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e|-store.ListPredicate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e opt == nil\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |   opt = ListOptions{ResourceVersion: \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-Init SelectionPredicate.Limit/Continue fileld\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-list := e.NewListFunc()                               // objects will be stored \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e this list\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-storageOpts := storage.ListOptions{opt.ResourceVersion, opt.ResourceVersionMatch, Predicate: p}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e MatchesSingle ok                                   // 1. when \u003cspan class=\"string\"\u003e\u0026#34;metadata.name\u0026#34;\u003c/span\u003e is specified,  get single obj\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |   // Get single obj from cache or etcd\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   |-\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e e.Storage.List(KeyRootFunc(ctx), storageOpts)  // 2. get all objs and perform filtering\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      |-cacher.List()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         | // \u003cspan class=\"keyword\"\u003ecase\u003c/span\u003e 1: list all from etcd and filter \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e apiserver\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |-\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e shouldDelegateList(opts)                     // \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e resourceVersion == \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |    \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e c.storage.List                        // list from etcd\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |- fromRV *int64 = nil\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |- \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e len(storageOpts.ResourceVersion) \u0026gt; 0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |     rv = ParseResourceVersion\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |     fromRV = \u0026amp;rv\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |- \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e hasMore {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |    objs := etcdclient.KV.Get()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             |    filter(objs)                   // filter by labels or filelds\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |             | }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         | // \u003cspan class=\"keyword\"\u003ecase\u003c/span\u003e 2: list \u0026amp; filter from apiserver \u003cspan class=\"built_in\"\u003elocal\u003c/span\u003e cache (memory)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |-\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e cache.notready()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |   \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e c.storage.List                         // get from etcd\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         | // \u003cspan class=\"keyword\"\u003ecase\u003c/span\u003e 3: list \u0026amp; filter from apiserver \u003cspan class=\"built_in\"\u003elocal\u003c/span\u003e cache (memory)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |-obj := watchCache.WaitUntilFreshAndGet\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |-\u003cspan class=\"keyword\"\u003efor\u003c/span\u003e elem \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e obj.(*storeElement)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |   listVal.Set()                                 // append results to listOjb\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e         |-\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e  // results stored \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e listObj\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"store\"\u003e\u003ca href=\"#store\" class=\"headerlink\" title=\"store\"\u003e\u003c/a\u003estore\u003c/h3\u003e\u003ch4 id=\"List\"\u003e\u003ca href=\"#List\" class=\"headerlink\" title=\"List()\"\u003e\u003c/a\u003e\u003ccode\u003eList()\u003c/code\u003e\u003c/h4\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// List returns a list of items matching labels and field according to the\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// store\u0026#39;s PredicateFunc.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(e *Store)\u003c/span\u003e\u003c/span\u003e List(ctx context.Context, options *metainternalversion.ListOptions) (runtime.Object, \u003cspan class=\"type\"\u003eerror\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    label := labels.Everything()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e options != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e \u0026amp;\u0026amp; options.LabelSelector != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        label = options.LabelSelector\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    field := fields.Everything()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e options != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e \u0026amp;\u0026amp; options.FieldSelector != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        field = options.FieldSelector\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    out, err := e.ListPredicate(ctx, e.PredicateFunc(label, field), options)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003enil\u003c/span\u003e, err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e e.Decorator != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        e.Decorator(out)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e out, \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"ListPredicate\"\u003e\u003ca href=\"#ListPredicate\" class=\"headerlink\" title=\"ListPredicate()\"\u003e\u003c/a\u003e\u003ccode\u003eListPredicate()\u003c/code\u003e\u003c/h4\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// staging/src/k8s.io/apiserver/pkg/registry/generic/registry/store.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// ListPredicate returns a list of all the items matching the given\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// SelectionPredicate.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(e *Store)\u003c/span\u003e\u003c/span\u003e ListPredicate(ctx context.Context, p storage.SelectionPredicate, options *metainternalversion.ListOptions) (runtime.Object, \u003cspan class=\"type\"\u003eerror\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e options == \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// By default we should serve the request from etcd.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        options = \u0026amp;metainternalversion.ListOptions{ResourceVersion: \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    p.Limit = options.Limit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    p.Continue = options.Continue\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    list := e.NewListFunc()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    qualifiedResource := e.qualifiedResourceFromContext(ctx)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    storageOpts := storage.ListOptions{ResourceVersion: options.ResourceVersion, ResourceVersionMatch: options.ResourceVersionMatch, Predicate: p}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e name, ok := p.MatchesSingle(); ok {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e key, err := e.KeyFunc(ctx, name); err == \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            err := e.Storage.GetToList(ctx, key, storageOpts, list)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e list, storeerr.InterpretListError(err, qualifiedResource)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// if we cannot extract a key based on the current context, the optimization is skipped\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    err := e.Storage.List(ctx, e.KeyRootFunc(ctx), storageOpts, list)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e list, storeerr.InterpretListError(err, qualifiedResource)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003eListPredicate()\u003c/code\u003e中:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e如果客户端没传 **\u003ccode\u003eListOption\u003c/code\u003e**，则初始化一个默认值，其中的 \u003ccode\u003eResourceVersion\u003c/code\u003e 设置为空字符串;\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e用 listoptions 中的字段分别\u003cstrong\u003e初始化过滤器\u003c/strong\u003e（SelectionPredicate）的 limit/continue 字段；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e初始化返回结果，\u003ccode\u003elist := e.NewListFunc()\u003c/code\u003e；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e将 API 侧的 ListOption 转成底层存储的 ListOption;\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003ep.MatchesSingle()判断请求中是否指定了metadata.name,如果指定了，说明是查询单个对象，因为 \u003ccode\u003eName\u003c/code\u003e 是唯一的，接下来转入查询单个 object 的逻辑；\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e如果p.MatchesSingle()不成立，则需要\u003cstrong\u003e获取全量数据\u003c/strong\u003e，然后在 apiserver 内存中根据 SelectionPredicate 中的过滤条件进行过滤，将最终结果返回给客户端；\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e最终\u003ccode\u003ee.Storage.GetToList()/e.Storage.List()\u003c/code\u003e会执行到cacher。这两个funciont很相似\u003c/p\u003e\n\u003cp\u003e不管是获取单个 object，还是获取全量数据，都经历类似的过程：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e优先从 apiserver 本地缓存获取（决定因素包括 ResourceVersion 等），\u003c/li\u003e\n\u003cli\u003e不得已才到 etcd 去获取；\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"apiserver-cache\"\u003e\u003ca href=\"#apiserver-cache\" class=\"headerlink\" title=\"apiserver cache\"\u003e\u003c/a\u003eapiserver cache\u003c/h3\u003e\u003ch4 id=\"List-1\"\u003e\u003ca href=\"#List-1\" class=\"headerlink\" title=\"List()\"\u003e\u003c/a\u003e\u003ccode\u003eList()\u003c/code\u003e\u003c/h4\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e74\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e75\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e76\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e77\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// List implements storage.Interface.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(c *Cacher)\u003c/span\u003e\u003c/span\u003e List(ctx context.Context, key \u003cspan class=\"type\"\u003estring\u003c/span\u003e, opts storage.ListOptions, listObj runtime.Object) \u003cspan class=\"type\"\u003eerror\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    resourceVersion := opts.ResourceVersion\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    pred := opts.Predicate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 是否必须从 etcd 读\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e shouldDelegateList(opts) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e c.storage.List(ctx, key, opts, listObj)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// If resourceVersion is specified, serve it from cache.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// It\u0026#39;s guaranteed that the returned value is at least that\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// fresh as the given resourceVersion.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    listRV, err := c.versioner.ParseResourceVersion(resourceVersion)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 如果缓存还没有建立好，只能从 etcd 读\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e listRV == \u003cspan class=\"number\"\u003e0\u003c/span\u003e \u0026amp;\u0026amp; !c.ready.check() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// If Cacher is not yet initialized and we don\u0026#39;t require any specific\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// minimal resource version, simply forward the request to storage.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e c.storage.List(ctx, key, opts, listObj)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    trace := utiltrace.New(\u003cspan class=\"string\"\u003e\u0026#34;cacher list\u0026#34;\u003c/span\u003e, utiltrace.Field{\u003cspan class=\"string\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e, c.objectType.String()})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003edefer\u003c/span\u003e trace.LogIfLong(\u003cspan class=\"number\"\u003e500\u003c/span\u003e * time.Millisecond)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    c.ready.wait()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    trace.Step(\u003cspan class=\"string\"\u003e\u0026#34;Ready\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// List elements with at least \u0026#39;listRV\u0026#39; from cache.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    listPtr, err := meta.GetItemsPtr(listObj)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    listVal, err := conversion.EnforcePtr(listPtr)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e listVal.Kind() != reflect.Slice {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e fmt.Errorf(\u003cspan class=\"string\"\u003e\u0026#34;need a pointer to slice, got %v\u0026#34;\u003c/span\u003e, listVal.Kind())\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    filter := filterWithAttrsFunction(key, pred)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    objs, readResourceVersion, err := c.watchCache.WaitUntilFreshAndList(listRV, pred.MatcherIndex(), trace)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    trace.Step(\u003cspan class=\"string\"\u003e\u0026#34;Listed items from cache\u0026#34;\u003c/span\u003e, utiltrace.Field{\u003cspan class=\"string\"\u003e\u0026#34;count\u0026#34;\u003c/span\u003e, \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(objs)})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(objs) \u0026gt; listVal.Cap() \u0026amp;\u0026amp; pred.Label.Empty() \u0026amp;\u0026amp; pred.Field.Empty() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// Resize the slice appropriately, since we already know that none\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// of the elements will be filtered out.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        listVal.Set(reflect.MakeSlice(reflect.SliceOf(c.objectType.Elem()), \u003cspan class=\"number\"\u003e0\u003c/span\u003e, \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(objs)))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        trace.Step(\u003cspan class=\"string\"\u003e\u0026#34;Resized result\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e _, obj := \u003cspan class=\"keyword\"\u003erange\u003c/span\u003e objs {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        elem, ok := obj.(*storeElement)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e !ok {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e fmt.Errorf(\u003cspan class=\"string\"\u003e\u0026#34;non *storeElement returned from storage: %v\u0026#34;\u003c/span\u003e, obj)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// 真正的过滤\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e filter(elem.Key, elem.Labels, elem.Fields) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            listVal.Set(reflect.Append(listVal, reflect.ValueOf(elem.Object).Elem()))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    trace.Step(\u003cspan class=\"string\"\u003e\u0026#34;Filtered items\u0026#34;\u003c/span\u003e, utiltrace.Field{\u003cspan class=\"string\"\u003e\u0026#34;count\u0026#34;\u003c/span\u003e, listVal.Len()})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 更新最后一次读到的 ResourceVersion\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e c.versioner != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err := c.versioner.UpdateList(listObj, readResourceVersion, \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e, \u003cspan class=\"literal\"\u003enil\u003c/span\u003e); err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"shouldDelegateList\"\u003e\u003ca href=\"#shouldDelegateList\" class=\"headerlink\" title=\"shouldDelegateList()\"\u003e\u003c/a\u003e\u003ccode\u003eshouldDelegateList()\u003c/code\u003e\u003c/h4\u003e\u003cp\u003e判断是否必须从 etcd 读数据\u003c/p\u003e\n\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"title\"\u003eshouldDelegateList\u003c/span\u003e\u003cspan class=\"params\"\u003e(opts storage.ListOptions)\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    resourceVersion := opts.ResourceVersion\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    pred := opts.Predicate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    pagingEnabled := utilfeature.DefaultFeatureGate.Enabled(features.APIListChunking)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    hasContinuation := pagingEnabled \u0026amp;\u0026amp; \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(pred.Continue) \u0026gt; \u003cspan class=\"number\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    hasLimit := pagingEnabled \u0026amp;\u0026amp; pred.Limit \u0026gt; \u003cspan class=\"number\"\u003e0\u003c/span\u003e \u0026amp;\u0026amp; resourceVersion != \u003cspan class=\"string\"\u003e\u0026#34;0\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// If resourceVersion is not specified, serve it from underlying\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// storage (for backward compatibility). If a continuation is\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// requested, serve it from the underlying storage as well.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// Limits are only sent to storage when resourceVersion is non-zero\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// since the watch cache isn\u0026#39;t able to perform continuations, and\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// limits are ignored when resource version is zero\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e resourceVersion == \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e || hasContinuation || hasLimit || opts.ResourceVersionMatch == metav1.ResourceVersionMatchExact\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里非常重要：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cp\u003e客户端未设置 ListOption{} 中的 \u003ccode\u003eResourceVersion\u003c/code\u003e 字段，对应到这里的 \u003ccode\u003eresourceVersion == \u0026#34;\u0026#34;\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e客户端设置了 \u003ccode\u003elimit=500\u0026amp;resourceVersion=0\u003c/code\u003e 不会导致下次 \u003ccode\u003ehasContinuation==true\u003c/code\u003e，因为\u003cstrong\u003eresourceVersion=0 将导致 limit 被忽略\u003c/strong\u003e（\u003ccode\u003ehasLimit\u003c/code\u003e 那一行代码），也就是说， 虽然指定了 limit=500，但\u003cstrong\u003e这个请求会返回全量数据\u003c/strong\u003e。\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eResourceVersionMatch的作用是用来告诉 apiserver，该如何解读 ResourceVersion。官方的详细说明\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/#the-resourceversion-parameter\"\u003e表格\u003c/a\u003e ，有兴趣可以看看。\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e接下来再返回到 cacher 的 \u003ccode\u003eGetList()\u003c/code\u003e 逻辑，来看下具体有哪几种处理情况。\u003c/p\u003e\n\u003cp\u003eListOption要求从 etcd 读数据\u003c/p\u003e\n\u003cp\u003e有两种情况:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e当客户端要求必须从etcd读取数据时，适用于数据一致性要求极其高的场景\u003c/li\u003e\n\u003cli\u003e当apiserver缓存还没有创建好时，比如apiserver重启到ready这阶段\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eapiserver 会直接从 etcd 读取所有 objects 并过滤，然后返回给客户端， 适用于数据一致性要求极其高的场景。 当然，也容易误入这种场景造成 etcd 压力过大\u003c/p\u003e\n\u003cp\u003e这里将会从cache的\u003ccode\u003eGetList()\u003c/code\u003e转到etcd的\u003ccode\u003eList()\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"etcd-List\"\u003e\u003ca href=\"#etcd-List\" class=\"headerlink\" title=\"etcd List()\"\u003e\u003c/a\u003e\u003ccode\u003eetcd List()\u003c/code\u003e\u003c/h4\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e74\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e75\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e76\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e77\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e78\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e79\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e81\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e82\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e83\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e84\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e85\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e86\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e87\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e88\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e89\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e90\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e//staging/src/k8s.io/apiserver/pkg/storage/etcd3/store.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// List implements storage.Interface.List.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(s *store)\u003c/span\u003e\u003c/span\u003e List(ctx context.Context, key \u003cspan class=\"type\"\u003estring\u003c/span\u003e, opts storage.ListOptions, listObj runtime.Object) \u003cspan class=\"type\"\u003eerror\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    resourceVersion := opts.ResourceVersion\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    match := opts.ResourceVersionMatch\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    pred := opts.Predicate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// set the appropriate clientv3 options to filter the returned data set\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e paging \u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    options := \u003cspan class=\"built_in\"\u003emake\u003c/span\u003e([]clientv3.OpOption, \u003cspan class=\"number\"\u003e0\u003c/span\u003e, \u003cspan class=\"number\"\u003e4\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e s.pagingEnabled \u0026amp;\u0026amp; pred.Limit \u0026gt; \u003cspan class=\"number\"\u003e0\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        paging = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        options = \u003cspan class=\"built_in\"\u003eappend\u003c/span\u003e(options, clientv3.WithLimit(pred.Limit))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    newItemFunc := getNewItemFunc(listObj, v)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e fromRV *\u003cspan class=\"type\"\u003euint64\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 如果 RV 非空\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(resourceVersion) \u0026gt; \u003cspan class=\"number\"\u003e0\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        parsedRV, err := s.versioner.ParseResourceVersion(resourceVersion)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e apierrors.NewBadRequest(fmt.Sprintf(\u003cspan class=\"string\"\u003e\u0026#34;invalid resource version: %v\u0026#34;\u003c/span\u003e, err))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        fromRV = \u0026amp;parsedRV\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e returnedRV, continueRV, withRev \u003cspan class=\"type\"\u003eint64\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e continueKey \u003cspan class=\"type\"\u003estring\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ResourceVersion, ResourceVersionMatch 等处理逻辑\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eswitch\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e withRev != \u003cspan class=\"number\"\u003e0\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        options = \u003cspan class=\"built_in\"\u003eappend\u003c/span\u003e(options, clientv3.WithRev(withRev))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// loop until we have filled the requested limit from etcd or there are no more results\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e lastKey []\u003cspan class=\"type\"\u003ebyte\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e hasMore \u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e getResp *clientv3.GetResponse\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        getResp = s.client.KV.Get(ctx, key, options...) \u003cspan class=\"comment\"\u003e// 从 etcd 拉数据\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        numFetched += \u003cspan class=\"built_in\"\u003elen\u003c/span\u003e(getResp.Kvs)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        hasMore = getResp.More\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// take items from the response until the bucket is full, filtering as we go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e _, kv := \u003cspan class=\"keyword\"\u003erange\u003c/span\u003e getResp.Kvs {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e paging \u0026amp;\u0026amp; \u003cspan class=\"type\"\u003eint64\u003c/span\u003e(v.Len()) \u0026gt;= pred.Limit {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                hasMore = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003ebreak\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            lastKey = kv.Key\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            data, _, err := s.transformer.TransformFromStorage(kv.Value, authenticatedDataString(kv.Key))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// instruct the client to begin querying from immediately after the last key we returned\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// we never return a key that the client wouldn\u0026#39;t be allowed to see\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e hasMore {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// we want to start immediately after the last key\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        next, err := encodeContinue(\u003cspan class=\"type\"\u003estring\u003c/span\u003e(lastKey)+\u003cspan class=\"string\"\u003e\u0026#34;\\x00\u0026#34;\u003c/span\u003e, keyPrefix, returnedRV)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e err != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e err\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e remainingItemCount *\u003cspan class=\"type\"\u003eint64\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// getResp.Count counts in objects that do not match the pred.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// Instead of returning inaccurate count for non-empty selectors, we return nil.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e// Only set remainingItemCount if the predicate is empty.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e utilfeature.DefaultFeatureGate.Enabled(features.RemainingItemCount) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e pred.Empty() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                c := \u003cspan class=\"type\"\u003eint64\u003c/span\u003e(getResp.Count - pred.Limit)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                remainingItemCount = \u0026amp;c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e s.versioner.UpdateList(listObj, \u003cspan class=\"type\"\u003euint64\u003c/span\u003e(returnedRV), next, remainingItemCount)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// no continuation\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e s.versioner.UpdateList(listObj, \u003cspan class=\"type\"\u003euint64\u003c/span\u003e(returnedRV), \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e, \u003cspan class=\"literal\"\u003enil\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eclient.KV.Get()\u003c/code\u003e\u003c/strong\u003e 就进入 etcd client 库了\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e\u003ccode\u003eappendListItem()\u003c/code\u003e\u003c/strong\u003e 会\u003cstrong\u003e对拿到的数据进行过滤\u003c/strong\u003e，这就是我们第一节提到的 apiserver 内存过滤操作。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"apiserver使用本地缓存\"\u003e\u003ca href=\"#apiserver使用本地缓存\" class=\"headerlink\" title=\"apiserver使用本地缓存\"\u003e\u003c/a\u003eapiserver使用本地缓存\u003c/h4\u003e\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// staging/src/k8s.io/apiserver/pkg/storage/cacher/cacher.go\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e// GetList implements storage.Interface\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(c *Cacher)\u003c/span\u003e\u003c/span\u003e List(ctx , key \u003cspan class=\"type\"\u003estring\u003c/span\u003e, opts storage.ListOptions, listObj runtime.Object) \u003cspan class=\"type\"\u003eerror\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 情况一：ListOption 要求必须从 etcd 读\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 情况二：apiserver 缓存未建好，只能从 etcd 读,跟情况一一\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// 情况三：apiserver 缓存正常，从缓存读：保证返回的 objects 版本不低于 `listRV`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    listPtr := meta.GetItemsPtr(listObj) \u003cspan class=\"comment\"\u003e// List elements with at least \u0026#39;listRV\u0026#39; from cache.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    listVal := conversion.EnforcePtr(listPtr)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    filter  := filterWithAttrsFunction(key, pred) \u003cspan class=\"comment\"\u003e// 最终的过滤器\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    objs, readResourceVersion, indexUsed := c.listItems(listRV, key, pred, ...) \u003cspan class=\"comment\"\u003e// 根据 index 预筛，性能优化\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e _, obj := \u003cspan class=\"keyword\"\u003erange\u003c/span\u003e objs {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        elem := obj.(*storeElement)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e filter(elem.Key, elem.Labels, elem.Fields)                           \u003cspan class=\"comment\"\u003e// 真正的过滤\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            listVal.Set(reflect.Append(listVal, reflect.ValueOf(elem))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e c.versioner != \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        c.versioner.UpdateList(listObj, readResourceVersion, \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e, \u003cspan class=\"literal\"\u003enil\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003enil\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"总结建议\"\u003e\u003ca href=\"#总结建议\" class=\"headerlink\" title=\"总结建议\"\u003e\u003c/a\u003e总结建议\u003c/h3\u003e\u003col\u003e\n\u003cli\u003eList请求默认设置 \u003ccode\u003eResourceVersion=0\u003c/code\u003e以防etcd拉全量数据再过滤，导致，很慢或者扛不住\u003c/li\u003e\n\u003cli\u003e不要滥用List接口，如果能使用watch就使用watch\u003c/li\u003e\n\u003cli\u003e优先通过 label/field selector 在服务端做过滤\u003cbr/\u003e如果需要缓存某些资源并监听变动，那需要使用 ListWatch 机制，将数据拉到本地，业务逻辑根据需要自己从 local cache 过滤。 这是 client-go 的 ListWatch/informer 机制。\u003c/li\u003e\n\u003cli\u003e优先使用 namespaced API,\u003cbr/\u003eetcd 中 namespace 是前缀的一部分，因此能指定 namespace 过滤资源，速度比不是前缀的 selector 快很多,如果要 LIST 的资源在单个或少数几个 namespace，考虑使用 namespaced API：\u003c/li\u003e\n\u003c/ol\u003e\n\u003cul\u003e\n\u003cli\u003eNamespaced API: \u003ccode\u003e/api/v1/namespaces/\u0026lt;ns\u0026gt;/pods?query=xxx\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eUn-namespaced API: \u003ccode\u003e/api/v1/pods?query=xxx\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003col start=\"5\"\u003e\n\u003cli\u003e细化etcd/apiserver等核心监控,比如作者之前不怎么关注的网络方面的metrics\u003c/li\u003e\n\u003cli\u003e经过上述的方法还是扛不住的话那可以把event等不是很重要的但很具有冲击对象的数据进行etcd分离\u003c/li\u003e\n\u003cli\u003e遇到性能问题是最容易出现多方的扯皮, 作者觉得最好的说服方式就是: \u003cstrong\u003e直接用数据说话，数据不会骗人\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"其它\"\u003e\u003ca href=\"#其它\" class=\"headerlink\" title=\"其它\"\u003e\u003c/a\u003e其它\u003c/h3\u003e\u003cp\u003e本篇主要追了一下ResourceVersion是怎么处理的，但还有很多细节是没有展开的，比如\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eListOption中的其它参数都起到什么作用\u003c/li\u003e\n\u003cli\u003eReflector中ListandWatch关于ResourceVersion又是怎样的\u003c/li\u003e\n\u003cli\u003erelist如何使用\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e但实在是不想篇幅太长，所以给自己留个作业，下回再探讨\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2023/12/14/Kubernetes-listOption-1/\"\u003eKubernetes之List参数使用不当引发的ETCD网络风暴\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/docs/reference/using-api/api-concepts/\"\u003eKubernetes API Concepts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://arthurchiao.art/blog/raft-paper-zh/\"\u003e(译) [论文] Raft 共识算法（及 etcd/raft 源码解析）（USENIX, 2014）\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://arthurchiao.art/blog/k8s-reliability-list-data-zh/\"\u003eK8s 集群稳定性：LIST 请求源码分析、性能评估与大规模基础服务部署调优\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/lianngkyle/p/16272494.html\"\u003ek8s client-go源码分析 informer源码分析(3)-Reflector源码分析 - 良凯尔 - 博客园\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.cnblogs.com/lianngkyle/p/16272494.html\"\u003ehttps://www.cnblogs.com/lianngkyle/p/16272494.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2023-12-16T11:30:53+08:00",
  "Author": "Z.S.K."
}