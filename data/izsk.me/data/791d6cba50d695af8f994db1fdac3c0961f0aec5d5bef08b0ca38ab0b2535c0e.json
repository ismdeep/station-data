{
  "Source": "izsk.me",
  "Title": "Kube-batch学习(kube-batch踩坑记)",
  "Link": "https://izsk.me/2021/03/27/Kubernetes-kubebatch-prombles/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e由于kube-batch经久未修，导致在引入kube-batch到环境中验证期间fix了很多问题，记录于此\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003eKube-batch版本为v1.5.0, kube-batch github上能看到的最后一个release版本.\u003c/p\u003e\n\u003ch3 id=\"解决集群中如果存在pdb时出现的空指针问题\"\u003e\u003ca href=\"#解决集群中如果存在pdb时出现的空指针问题\" class=\"headerlink\" title=\"解决集群中如果存在pdb时出现的空指针问题\"\u003e\u003c/a\u003e解决集群中如果存在pdb时出现的空指针问题\u003c/h3\u003e\u003cp\u003e在kube-batch的稳定版本中(目前是v1.5.0),如果集群中有pdb，pdb在k8s中是一种安全机制，可\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/\"\u003e参考\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e如果podb的属性值有空值时，kube-batch在启动时会出现空指针异常，核心代码:\u003c/p\u003e\n\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"params\"\u003e(ji *JobInfo)\u003c/span\u003e\u003c/span\u003e SetPDB(pdb *policyv1.PodDisruptionBudget) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tji.Name = pdb.Name\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\u003cspan class=\"comment\"\u003e//ji.MinAvailable = pdb.Spec.MinAvailable.IntVal  # fix之前的错误代码，以下是fix之后新增的代码\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  defaultMinAvailable := intstr.IntOrString{Type: intstr.Int, IntVal: \u003cspan class=\"type\"\u003eint32\u003c/span\u003e(\u003cspan class=\"number\"\u003e0\u003c/span\u003e)}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tminAvailable := pdb.Spec.MinAvailable\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tji.MinAvailable = \u003cspan class=\"type\"\u003eint32\u003c/span\u003e(intstr.ValueOrDefault(minAvailable, defaultMinAvailable).IntValue())\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tji.Namespace = pdb.Namespace\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tji.CreationTimestamp = pdb.GetCreationTimestamp()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\tji.PDB = pdb\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e异常代码在于注释的那行，代码中直接获取min值，但是这个值可能为NaN值，没有做安全处理\u003c/p\u003e\n\u003cp\u003efix之后的代码如注释之后的代码\u003c/p\u003e\n\u003cp\u003e经过本人的验证，这个\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/volcano-sh/volcano/pull/523\"\u003efix\u003c/a\u003e依然会有问题，没有考虑到pdb的所有情况，所以在volcano项目中(基于kube-batch衍生而来)，作者直接去除了pdb的支持，将pdb相关的代码直接去掉了\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/volcano-sh/volcano/pull/523\"\u003efix\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"failed-to-delete-pod\"\u003e\u003ca href=\"#failed-to-delete-pod\" class=\"headerlink\" title=\"failed to delete pod\"\u003e\u003c/a\u003efailed to delete pod\u003c/h3\u003e\u003cp\u003e在kube-batch的日志中会出现failed to delete pod之类的错误，这个错误的原因大部分是是由于cache模块在更新pod的调度状态时，首先针将pod删除，然后再添加pod， 但是在删pod时发现task此时已经不再它原来的node上，因此无法删除，也就无法再添加pod，所以fix是如果无法删除这种情况直接忽略，再添加就没问题\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://hub.fastgit.org/kubernetes-sigs/kube-batch/pull/936\"\u003efix\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"资源计算错误问题\"\u003e\u003ca href=\"#资源计算错误问题\" class=\"headerlink\" title=\"资源计算错误问题\"\u003e\u003c/a\u003e资源计算错误问题\u003c/h3\u003e\u003cp\u003eKube-batch中对每一次调度之后都会计划queue中所有的task所占用的资源是不是超过了queue能够使用的最大资源，如果超过，则会返回一个标志位overUsed，返回这个标志位，kube-batch则不会对属于该queue中的task进行调度\u003c/p\u003e\n\u003cp\u003e但是kube-batch在进行资源比较时出现了计算错误,\u003c/p\u003e\n\u003cp\u003e核心代码如下:\u003c/p\u003e\n\u003cfigure class=\"highlight go\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003essn.AddOverusedFn(pp.Name(), \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003efunc\u003c/span\u003e\u003cspan class=\"params\"\u003e(obj \u003cspan class=\"keyword\"\u003einterface\u003c/span\u003e{})\u003c/span\u003e\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\tqueue := obj.(*api.QueueInfo)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\tattr := pp.queueOpts[queue.UID]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e//overused := attr.deserved.Less(attr.allocated)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\toverused := attr.deserved.LessEqual(attr.allocated) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e overused {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\tglog.V(\u003cspan class=\"number\"\u003e3\u003c/span\u003e).Infof(\u003cspan class=\"string\"\u003e\u0026#34;Queue \u0026lt;%v\u0026gt;: deserved \u0026lt;%v\u0026gt;, allocated \u0026lt;%v\u0026gt;, share \u0026lt;%v\u0026gt;\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\t\tqueue.Name, attr.deserved, attr.allocated, attr.share)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e overused\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e该问题比较严重，\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://hub.fastgit.org/volcano-sh/volcano/pull/1116\"\u003efix\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"shadowpodgroup资源对象\"\u003e\u003ca href=\"#shadowpodgroup资源对象\" class=\"headerlink\" title=\"shadowpodgroup资源对象\"\u003e\u003c/a\u003eshadowpodgroup资源对象\u003c/h3\u003e\u003cp\u003ekube-batch支持直接在annotation中指定生成shadowpodgroup，这样就不需要每次都创建podgroup对象了\u003c/p\u003e\n\u003cp\u003e注意，生成的shaowpodgroup并不能通过kubectl查询得到，除了这点不一样之外，其它的跟podgroup的性质是一样的\u003c/p\u003e\n\u003cp\u003e使用方法:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplates:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eseg\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eschedulerName:\u003c/span\u003e \u003cspan class=\"string\"\u003ekube-batch\u003c/span\u003e          \u003cspan class=\"comment\"\u003e### 这里指定使用kube-batch调度器，没有指定则会使用k8s集群中默认的调度器 ###\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eannotations:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003e\u0026#34;scheduling.k8s.io/group-min-member\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;2\u0026#34;\u003c/span\u003e  \u003cspan class=\"comment\"\u003e### 这里指定podgroup中minMember\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ... \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://hub.fastgit.org/kubernetes-sigs/kube-batch/pull/908\"\u003emerge\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes-sigs/kube-batch\"\u003ehttps://github.com/kubernetes-sigs/kube-batch\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.jianshu.com/p/042692685cf4\"\u003ehttps://www.jianshu.com/p/042692685cf4\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://argoproj.github.io/argo-workflows/fields/\"\u003ehttps://argoproj.github.io/argo-workflows/fields/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/volcano-sh/volcano/pull/523\"\u003ehttps://github.com/volcano-sh/volcano/pull/523\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes-sigs/kube-batch/issues/670\"\u003ehttps://github.com/kubernetes-sigs/kube-batch/issues/670\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes-sigs/kube-batch/issues/904\"\u003ehttps://github.com/kubernetes-sigs/kube-batch/issues/904\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/\"\u003ehttps://kubernetes.io/zh/docs/tasks/run-application/configure-pdb/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://hub.fastgit.org/kubernetes-sigs/kube-batch/pull/908\"\u003ehttps://hub.fastgit.org/kubernetes-sigs/kube-batch/pull/908\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2021-03-27T19:10:53+08:00",
  "Author": "Z.S.K."
}