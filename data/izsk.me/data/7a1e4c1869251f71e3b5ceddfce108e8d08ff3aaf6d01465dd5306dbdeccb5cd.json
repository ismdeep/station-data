{
  "Source": "izsk.me",
  "Title": "Prometheus学习(prometheus基本原理)",
  "Link": "https://izsk.me/2019/08/21/prometheus-basic-theory/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003ePrometheus做为CNCF的第二个项目，被给予厚望,  现已然成为监控系统设计的标杆. 特别是对于Kubernetes的支持,可谓天衣无缝. 使用kubernetes，很难跳过prometheus不说.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"系统架构\"\u003e\u003ca href=\"#系统架构\" class=\"headerlink\" title=\"系统架构\"\u003e\u003c/a\u003e系统架构\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/prometheus-architecture.png\"/\u003e\u003c/p\u003e\n\u003cp\u003ePrometheus由多个组件组成，但是其中许多组件是可选的:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003ePrometheus Server: 用于抓取指标、存储时间序列数据\u003c/li\u003e\n\u003cli\u003eService discovery: 通过服务发现机制获取需要scrape目标\u003c/li\u003e\n\u003cli\u003ePushgateway: push的方式将指标数据推送到网关\u003c/li\u003e\n\u003cli\u003ealertmanager: 处理报警的报警组件\u003c/li\u003e\n\u003cli\u003eDataVisualization: 支持多种数据可视化UI\u003c/li\u003e\n\u003cli\u003ePromQL: 数据查询语言\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"数据抓取\"\u003e\u003ca href=\"#数据抓取\" class=\"headerlink\" title=\"数据抓取\"\u003e\u003c/a\u003e数据抓取\u003c/h3\u003e\u003cp\u003e\u003cstrong\u003ePULL\u003c/strong\u003e: prometheus\u003cstrong\u003e主动\u003c/strong\u003e地按照配置的时间周期去\u003cstrong\u003e需要抓取的\u003c/strong\u003e目标对象获取metrics\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ePUSH\u003c/strong\u003e: 程序按照配置的时间周期将metrics\u003cstrong\u003e推送\u003c/strong\u003e到pushgateway, pushgateway本地存储数据, prometheus\u003cstrong\u003e主动\u003c/strong\u003e去pushgateway\u003cstrong\u003e抓取\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e规则:\u003c/strong\u003e \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e按照promethus定义的\u003cstrong\u003emetric数据类型\u003c/strong\u003e及规则组织数据\u003cstrong\u003e格式\u003c/strong\u003e. \u003c/li\u003e\n\u003cli\u003e暴露指定的端口供prometheus scrape且表明自己需要被scrape\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003emetrics\u003c/strong\u003e: key-value对\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121135817702.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e一条metrics中\u003ccode\u003e{}\u003c/code\u003e引起来的部分为label, 可用于聚合/查询条件等.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e数据类型:\u003c/strong\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003ecounter: 只增不减,允许重置为0\u003c/li\u003e\n\u003cli\u003egauge: 没有规律的数值\u003c/li\u003e\n\u003cli\u003ehistogram: 用于统计一些数据分布的情况，用于计算在一定范围内的分布情况，同时还提供了度量指标值的总和\u003c/li\u003e\n\u003cli\u003eSummary: 主要用于计算在一定时间窗口范围内度量指标对象的总数以及所有对量指标值的总和，计算过程是在client端完成,计算结果存在server。因为没有最初的metric数据，所以summary不支持数据聚合\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003cstrong\u003escrape\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e对于scrape, 一个比较重要的指标是scrape timeout, 这个要根据具体场景来设置,过大或者过小都可能造成问题\u003c/p\u003e\n\u003cp\u003e关于如何发现scrape目标, 见\u003ca href=\"#ServiceDiscovery\"\u003eServiceDiscovery\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ePromSQL\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eprometheus中查询中使用了自有的查询语言,PromSQL,时间关系, 这节也不展开讲了,大家可参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/docs/prometheus/latest/querying/basics/\"\u003e官网\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eexporter\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eexporter是prometheus一类数据采集组件的总称, 随着prometheus逐渐流行, 并不是所有的第三方软件都支持prometheus的metric格式, 如果本身不改造的话,那无法使用prometheus进行scrapek,因此需要额外的一个东西从目标处收集数据, 将其转化为prometheus支持的格式.\u003c/p\u003e\n\u003ch3 id=\"服务发现\"\u003e\u003ca href=\"#服务发现\" class=\"headerlink\" title=\"服务发现\"\u003e\u003c/a\u003e服务发现\u003c/h3\u003e\u003cp\u003e所有的监控对象(基础设施、应用、服务)都在动态的变化, 显然无法静态的定义监控目标。而对于Prometheus而言其解决方案就是引入一个中间的代理人（服务注册中心），这个代理人掌握着当前所有监控目标的访问信息，Prometheus只需要向这个代理人询问有哪些监控目标控即可， 这种模式被称为\u003cstrong\u003e服务发现\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191121135214878.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e摘取prometheus配置文件部分, 完整的配置见\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/\"\u003e官网\u003c/a\u003e:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eglobal:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# How frequently to scrape targets by default.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  [ \u003cspan class=\"attr\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;duration\u0026gt;\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e \u003cspan class=\"string\"\u003edefault\u003c/span\u003e \u003cspan class=\"string\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e1m\u003c/span\u003e ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# How long until a scrape request times out.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  [ \u003cspan class=\"attr\"\u003escrape_timeout:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;duration\u0026gt;\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e \u003cspan class=\"string\"\u003edefault\u003c/span\u003e \u003cspan class=\"string\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# How frequently to evaluate rules.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  [ \u003cspan class=\"attr\"\u003eevaluation_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;duration\u0026gt;\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e \u003cspan class=\"string\"\u003edefault\u003c/span\u003e \u003cspan class=\"string\"\u003e=\u003c/span\u003e \u003cspan class=\"string\"\u003e1m\u003c/span\u003e ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# The labels to add to any time series or alerts when communicating with\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# external systems (federation, remote storage, Alertmanager).\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eexternal_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    [ \u003cspan class=\"string\"\u003e\u0026lt;labelname\u0026gt;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;labelvalue\u0026gt;\u003c/span\u003e \u003cspan class=\"string\"\u003e...\u003c/span\u003e ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003escrape_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003eprometheus\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e20s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_timeout:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emetrics_path:\u003c/span\u003e \u003cspan class=\"string\"\u003e/metrics\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escheme:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003estatic_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003etargets:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003elocalhost:9090\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes-service-endpoints\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_interval:\u003c/span\u003e \u003cspan class=\"string\"\u003e20s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escrape_timeout:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emetrics_path:\u003c/span\u003e \u003cspan class=\"string\"\u003e/metrics\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003escheme:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ekubernetes_sd_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eapi_server:\u003c/span\u003e \u003cspan class=\"literal\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003eendpoints\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003enamespaces:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003enames:\u003c/span\u003e []\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003erelabel_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e [\u003cspan class=\"string\"\u003e__meta_kubernetes_service_annotation_prometheus_io_scrape\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ekeep\u003c/span\u003e   \u003cspan class=\"comment\"\u003e#keep, drop\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e#其它relabel规则省略...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e#...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e对应的service主动expose metrics:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eService\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eprometheus-logging\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enamespace:\u003c/span\u003e \u003cspan class=\"string\"\u003elogging\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eprometheus.io/port:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;9090\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eprometheus.io/scrape:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;true\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e9090\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eprotocol:\u003c/span\u003e \u003cspan class=\"string\"\u003eTCP\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003etargetPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e9090\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eselector:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003eprometheus-logging\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003e一般情况下, 为避免抓取数据量太大对prometheus造成压力, 最佳实践是只抓取对监控有益的对象, \u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eprometheus配置文件中对指定某组目标使用了relabel_configs\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_service_annotation_prometheus_io_scrape\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ekeep\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003e该场景下: 只有当prometheus能通过服务发现机制找到抓取对象且抓取对象定义了prometheus.io/scrape: \u0026#34;true\u0026#34;时, prometheus才会进行抓取.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e抓取的数据格式如下:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191125104649435.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"报警规则\"\u003e\u003ca href=\"#报警规则\" class=\"headerlink\" title=\"报警规则\"\u003e\u003c/a\u003e报警规则\u003c/h3\u003e\u003cp\u003e这里举两个例子:\u003c/p\u003e\n\u003cp\u003e连续5分钟之内, 如果存在容器的启动时间一直小于180s的,则认为容器发生重启,则报警\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ealert: container_restart\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eexpr: (time()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  - (avg by(name) (container_start_time_seconds))) \u0026lt; 180\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efor: 5m\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003elabels:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  severity: warning\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eannotations:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  description: container {{$labels.name}} restart in 5 minutes.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e连续5分钟之内,如果node的可用使用内存大于90%且可用内存小于2G的, 则报警\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ealert:\u003c/span\u003e \u003cspan class=\"string\"\u003enode_memory_usage_higher_0.9\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eexpr:\u003c/span\u003e \u003cspan class=\"string\"\u003e(((node_memory_MemTotal\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003enode_memory_MemFree\u003c/span\u003e \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003enode_memory_Cached)\u003c/span\u003e \u003cspan class=\"string\"\u003e/\u003c/span\u003e \u003cspan class=\"string\"\u003e(node_memory_MemTotal))\u003c/span\u003e \u003cspan class=\"string\"\u003e*\u003c/span\u003e \u003cspan class=\"number\"\u003e100\u003c/span\u003e\u003cspan class=\"string\"\u003e)\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  90 and (node_memory_MemFree + node_memory_Cached) \u0026lt; 2 * 1024 * 1024 * 1024\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e\u003cspan class=\"attr\"\u003efor:\u003c/span\u003e \u003cspan class=\"string\"\u003e5m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eseverity:\u003c/span\u003e \u003cspan class=\"string\"\u003ewarning\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eannotations:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003edescription:\u003c/span\u003e \u003cspan class=\"string\"\u003eHost\u003c/span\u003e \u003cspan class=\"string\"\u003eavg\u003c/span\u003e \u003cspan class=\"string\"\u003ememory\u003c/span\u003e \u003cspan class=\"string\"\u003eusage\u003c/span\u003e \u003cspan class=\"string\"\u003ein\u003c/span\u003e \u003cspan class=\"string\"\u003e5m\u003c/span\u003e \u003cspan class=\"string\"\u003eis\u003c/span\u003e {{ \u003cspan class=\"string\"\u003e$value\u003c/span\u003e }}\u003cspan class=\"string\"\u003e%\u003c/span\u003e \u003cspan class=\"string\"\u003e(\u0026gt;90%).\u003c/span\u003e \u003cspan class=\"string\"\u003eReported\u003c/span\u003e \u003cspan class=\"string\"\u003eby\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003einstance\u003c/span\u003e {{ \u003cspan class=\"string\"\u003e$labels.instance\u003c/span\u003e }} \u003cspan class=\"string\"\u003eof\u003c/span\u003e \u003cspan class=\"string\"\u003ejob\u003c/span\u003e {{ \u003cspan class=\"string\"\u003e$labels.job\u003c/span\u003e }}\u003cspan class=\"string\"\u003e.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"报警管理\"\u003e\u003ca href=\"#报警管理\" class=\"headerlink\" title=\"报警管理\"\u003e\u003c/a\u003e报警管理\u003c/h3\u003e\u003cp\u003eprometheus中处理metric是否符合定义的报警规则,然后通过alertmanager组件实现了, alertmanager充当中间人,后端对接多种报警介质\u003c/p\u003e\n\u003cp\u003eprometheus将\u003ccode\u003e异常事件\u003c/code\u003e发送给alertmanager, alertmanager中我们可以设置各种报警规则等\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e报警静默\u003c/li\u003e\n\u003cli\u003e报警抑制\u003c/li\u003e\n\u003cli\u003e报警分类\u003c/li\u003e\n\u003cli\u003e报警聚合\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003ealertmanager的使用也相对容器, 不过Prometheus原生不支持某些实用的功能, 比如最大报警次数,因此, 如果产生报警, 如果不处理的话, prometheus会一直产生报警, prometheus开发者认为既然产生报警，那必然要尽快解决,因此觉得没必要支持设置最大报警次数，不过，可以直接通过修改prometheus的源码定制该功能.\u003c/p\u003e\n\u003cp\u003e###可视化\u003c/p\u003e\n\u003cp\u003eprometheus/alertmanager自带的webui实在是\u003ccode\u003e太过于丑陋\u003c/code\u003e, 一般只用于\u003ccode\u003edebug数据\u003c/code\u003e时使用, 数据可视化都会结合grafana进行展示\u003c/p\u003e\n\u003cp\u003egrafana支持alertmanager.\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/\"\u003ehttps://prometheus.io/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-08-21T14:20:53+08:00",
  "Author": "Z.S.K."
}