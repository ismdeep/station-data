{
  "Source": "izsk.me",
  "Title": "ArgoCD学习(argoCD之ResourceCheck及Notifications机制)",
  "Link": "https://izsk.me/2021/01/09/argoCD-ResourceHook-Notifications/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在之\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2020/12/04/argoCD-Usage/\"\u003e前一篇\u003c/a\u003e体验一把使用argocd对多k8s集群进行gitops的实践，在团队使用过程中会发现，argocd的sync状态跟app health状态是两个步骤，经常出现资源同步成功了但是deployment在k8s一起起不来，在argocd app status 一直都是\u003ccode\u003eProcessing\u003c/code\u003e,如何处理这种情况呢? argocd如何做 resource check,有没有必要引用notification机制\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"Resource-Check\"\u003e\u003ca href=\"#Resource-Check\" class=\"headerlink\" title=\"Resource Check\"\u003e\u003c/a\u003eResource Check\u003c/h3\u003e\u003cp\u003eargocd官网文档: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://argoproj.github.io/argo-cd/operator-manual/health/\"\u003ehealth\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e首先解决一下比较常见的 app的状态一直是\u003ccode\u003eProcessing\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e这里就要区别说一下argocd的两个命令:\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 1. argocd app sync \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# app sync只是用于对资源进行同步，也就是说，将git上的资源同步到argocd -- k8s, 一般情况下只要跟集群的连接、权限没有问题，sync一般都会成功，但是这个命令并不会验证资源运行能不能work,因此无法根据这个状态来判断整个pipeline是否成功\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 可以指定超时 --timeout, 单位: 秒\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 2. argocd app wait --health --timeout\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# app wait 则是等待资源达到某种状态, 这个是整个app的状态\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# --health 表示等待整个app达到health的状态，health状态表示所有同步的资源都运行成功\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# --timeout表示超时，如果超过这个时间，app还没有达到health状态，则表示失败\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 比如deployment一直重启，则过了timeout时间后，argocd会发现app未是health状态，则可以让整个pipeline会失败\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e作者最开始时，只使用\u003ccode\u003eapp sync\u003c/code\u003e,这就忽略了对整个app的health状态的判断，因此会出现CI/CD所有stage都成功了，但是pod一直处于重启状态\u003c/p\u003e\n\u003cp\u003e为解决这个问题，比较简单一点的做法就是在\u003ccode\u003eapp sync\u003c/code\u003e后使用\u003ccode\u003eapp wait --health --timeout\u003c/code\u003e来对\u003ccode\u003echeck app health\u003c/code\u003e，如果不成功，则\u003ccode\u003epipeline exit 1\u003c/code\u003e,这样可以在CI/CD阶段就暴露资源异常问题\u003c/p\u003e\n\u003cp\u003e但这也有明显的缺点: 如果资源异常，则必须要等\u003ccode\u003etimeout\u003c/code\u003e时间之后才能发现，这个问题则可以结合k8s集群的监控发现，还能接受.\u003c/p\u003e\n\u003cp\u003e从官网的文档来，argocd本身提供了对k8s中的常用资源对象的健康检查，比如对于deployment，argocd详细地说明了如何判断其达到health状态的.\u003c/p\u003e\n\u003cp\u003e同时，也提供了自定义的检查机制，有2种形式，本人看了一下，第一种使用LUA语言写的，也就几行代码，倒也不难，作者没有采用，原因首先现在的业务大部分都是k8s常用资源对象，argocd本身支持度非常高，不需要\u003c/p\u003e\n\u003cp\u003e第二种则需要以特殊的目录结构来组织，作者也没有采用，实在是在开发端维护这些跟业务无法的文件，会引起复杂性.\u003c/p\u003e\n\u003cp\u003e取舍作者最后还是采用 \u003ccode\u003eapp wait\u003c/code\u003e的方式，这还有一个好处是，不需要做额外的工作就可以将通知精准地发送给对应的enduser，比如gitlab本身的ci/cd,如果整个pipeline的失败会直接给发起pipeline的人发送邮件\u003c/p\u003e\n\u003ch3 id=\"notifications\"\u003e\u003ca href=\"#notifications\" class=\"headerlink\" title=\"notifications\"\u003e\u003c/a\u003enotifications\u003c/h3\u003e\u003cp\u003e这里还是需要分析一下argocd里的通知机制， argocd本身不提供notification，要依赖第三方提供的机制, 参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://argoproj.github.io/argo-cd/operator-manual/notifications/\"\u003enotifications\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"resource-hook\"\u003e\u003ca href=\"#resource-hook\" class=\"headerlink\" title=\"resource hook\"\u003e\u003c/a\u003eresource hook\u003c/h4\u003e\u003cp\u003eresource hook是argocd本身提供的功能，简单来说，就是在资源同步前，中，后提供hoo脚本来执行相应的动作, 那么想在资源同步后获取app的状态，然后根据状态进行通知就非常简单了，通知可以是很简单的curl命令\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ePreSync:\u003c/span\u003e \u003cspan class=\"string\"\u003e在同步之前执行相关操作，这个一般用于比如数据库操作等\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eSync:\u003c/span\u003e \u003cspan class=\"string\"\u003e同步时执行相关操作，主要用于复杂应用的编排\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ePostSync:\u003c/span\u003e \u003cspan class=\"string\"\u003e同步之后且app状态为health执行相关操作\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eSyncFail:\u003c/span\u003e \u003cspan class=\"string\"\u003e同步失败后执行相关操作，同步失败一般不常见\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e用的最多的就是PostSync，用来获取app是否成功启动，hook一般是放在job中执行，比如\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ebatch/v1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eJob\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003egenerateName:\u003c/span\u003e \u003cspan class=\"string\"\u003eapp-slack-notification-\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eannotations:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eargocd.argoproj.io/hook:\u003c/span\u003e \u003cspan class=\"string\"\u003ePostSync\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eargocd.argoproj.io/hook-delete-policy:\u003c/span\u003e \u003cspan class=\"string\"\u003eHookSucceeded\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003econtainers:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eslack-notification\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"string\"\u003ecurlimages/curl\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ecommand:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;curl\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;-X\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;POST\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;--data-urlencode\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;payload={\\\u0026#34;channel\\\u0026#34;: \\\u0026#34;#somechannel\\\u0026#34;, \\\u0026#34;username\\\u0026#34;: \\\u0026#34;hello\\\u0026#34;, \\\u0026#34;text\\\u0026#34;: \\\u0026#34;App Sync succeeded\\\u0026#34;, \\\u0026#34;icon_emoji\\\u0026#34;: \\\u0026#34;:ghost:\\\u0026#34;}\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;https://hooks.slack.com/services/...\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003erestartPolicy:\u003c/span\u003e \u003cspan class=\"string\"\u003eNever\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ebackoffLimit:\u003c/span\u003e \u003cspan class=\"number\"\u003e2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这个job比较容易理解，就是sync同步成功且app状态为health后发送一个slack消息\u003c/p\u003e\n\u003cp\u003e结合业务来说， 作者并没有采用这种方法来发送通知，原因如下:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e对于PostSync可以发送成功的通知，但对于状态为Processing的无法判断\u003c/li\u003e\n\u003cli\u003e存量的业务都需要将这个job加入到git中，最大的考量在于，通知还是没有办法做到\u003cstrong\u003e谁执行的pipeline,谁接收通知的原则\u003c/strong\u003e，比如上面的通知收件人，没有办法很好地更细粒度地指定，要么指定一个组，大家都收，要么指定一个人，但是模块都是多人开发，只发给一个人不合适\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch4 id=\"argocd-notifications\"\u003e\u003ca href=\"#argocd-notifications\" class=\"headerlink\" title=\"argocd-notifications\"\u003e\u003c/a\u003eargocd-notifications\u003c/h4\u003e\u003cp\u003eargocd-notification是argocd自家开发的通知系统,也是argocd推荐之一\u003c/p\u003e\n\u003cp\u003eArgocd-notifications v1.0之前的版本与v1.0+版本有很大的不一样，建议大家认真阅读\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj-labs/argocd-notifications/blob/d0da61d206/docs/upgrading/0.x-1.0.md\"\u003eupdate\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e安装很简单，就一条命令\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj-labs/argocd-notifications/stable/manifests/install.yaml\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e起来之后就一个controller应用，这里以邮件为例\u003c/p\u003e\n\u003cp\u003e首先，配置一下邮箱\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eapiVersion: v1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ekind: Secret\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003emetadata:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  name: argocd-notifications-secret\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  namespace: argocd\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estringData:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  service.email: |\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    host: smtp.xxx.com\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    port: 587\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    from: xxx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    username: xxx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    password: xxx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003etype\u003c/span\u003e: Opaque\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e然后添加相应状态通知:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eConfigMap\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003eargocd-notifications-cm\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003edata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# email的参数可以来自上面的secret\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eservice.email:\u003c/span\u003e \u003cspan class=\"string\"\u003e|    \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    host: smtp.gmail.com\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    port: 587\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    from: \u0026lt;myemail\u0026gt;@gmail.com\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    username: $email-username\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    password: $email-password\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e  \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# 触发条件\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etrigger.on-sync-status-unknown:\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    - when: app.status.sync.status == \u0026#39;Unknown\u0026#39;  # 指定条件\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      send: [my-custom-template]\t\t\t\t\t\t\t\t # 指定模板\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e  \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# 发送模板\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate.my-custom-template:\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    title: \u0026lt;argocd\u0026gt; Sync Application {{.app.metadata.name}} Status {{.app.status.health.status}}.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    body: |\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      App Name: {{.app.metadata.name}}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      Cluster Name: {{.context.clusterName}}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      Sync Status: {{.app.status.health.status}} \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      Following Error: {{.app.status.operationState.message}}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      Repo URL: {{.repo.FullNameByRepoURL}}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      Commit Msg: {{.repo.GetCommitMetadata}}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u003c/span\u003e  \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# 订阅者\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esubscriptions:\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    - recipients:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      - email:\u003ca href=\"/cdn-cgi/l/email-protection\" class=\"__cf_email__\" data-cfemail=\"097d6c7a7d496e64686065276a6664\"\u003e[email protected]\u003c/a\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      triggers:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      - on-sync-status-unknown\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如上面的配置，用于监控argocd同步状态为 Unknown的情况，发送邮件告警\u003c/p\u003e\n\u003cp\u003e当然， 在argocd部署应用的时候，也可以添加订阅者，直接在annotations中添加即可\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003enotifications.argoproj.io/subscribe.on-app-synched.eamil: \u003ca href=\"/cdn-cgi/l/email-protection\" class=\"__cf_email__\" data-cfemail=\"f8808080b8808080d69b9795\"\u003e[email protected]\u003c/a\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eargocd-notification每隔一分钟就会扫描所有argocd app，感觉还是比较频繁，如果应用一多的话，不知道是不是影响性能，这个时间目前不支持通过参数覆盖，如果需要调整只能修改源码后重新编译\u003c/p\u003e\n\u003cp\u003e作者最后也没有采用这种形式，原因在于argocd-notification还是用于监控argocd 的sync状态，并不关心app 是否health\u003c/p\u003e\n\u003ch4 id=\"argo-kube-notifier\"\u003e\u003ca href=\"#argo-kube-notifier\" class=\"headerlink\" title=\"argo-kube-notifier\"\u003e\u003c/a\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj-labs/argo-kube-notifier\"\u003eargo-kube-notifier\u003c/a\u003e\u003c/h4\u003e\u003cp\u003e最后argocd也推荐使用\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj-labs/argo-kube-notifier\"\u003eargo-kube-notifier\u003c/a\u003e，但感觉这个跟argocd本身就没多大关系了，完且是发布后的health check,这个主要用于k8s集群应用状态的check，实现这个目的的组件很多，而且\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj-labs/argo-kube-notifier\"\u003eargo-kube-notifier\u003c/a\u003e还是没办法实现\u003cstrong\u003e谁执行的pipeline,谁接收通知的原则\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e综上，还是直接使用\u003ccode\u003eargo app wait\u003c/code\u003e简单粗暴，加两行代码，贴合需求\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2020/12/04/argoCD-Usage/\"\u003ehttps://izsk.me/2020/12/04/argoCD-Usage/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj/argo-cd/blob/master/docs/operator-manual/webhook.md\"\u003ehttps://github.com/argoproj/argo-cd/blob/master/docs/operator-manual/webhook.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/argoproj-labs/argocd-notifications/blob/d0da61d206/docs/upgrading/0.x-1.0.md\"\u003ehttps://github.com/argoproj-labs/argocd-notifications/blob/d0da61d206/docs/upgrading/0.x-1.0.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.jianshu.com/p/a0613951c4b4\"\u003ehttps://www.jianshu.com/p/a0613951c4b4\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://argoproj.github.io/argo-cd/operator-manual/health/\"\u003ehttps://argoproj.github.io/argo-cd/operator-manual/health/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://argoproj.github.io/argo-cd/operator-manual/notifications/\"\u003ehttps://argoproj.github.io/argo-cd/operator-manual/notifications/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2021-01-09T16:30:53+08:00",
  "Author": "Z.S.K."
}