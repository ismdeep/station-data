{
  "Source": "izsk.me",
  "Title": "Grafana学习(Loki日志系统初试)",
  "Link": "https://izsk.me/2020/07/15/Loki/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e基于kubernetes为容器平台的业种中， 对于日志的收集，使用最多的是FEK， 不过有时候，FEK在架构上会略显重， ES的查询及全文检索功能其实使用的不是很多.LoKi做为日志架构的新面孔, 由grafana开源， 使用了与Prometheus同样的label理念, 同时摒弃了全文检索的能力, 因此比较轻便, 非常具有潜力\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"like-Prometheus-but-for-logs\"\u003e\u003ca href=\"#like-Prometheus-but-for-logs\" class=\"headerlink\" title=\"like Prometheus, but for logs\"\u003e\u003c/a\u003elike Prometheus, but for logs\u003c/h3\u003e\u003cp\u003e\u003ccode\u003eLoki\u003c/code\u003e是 Grafana Labs 团队最新的开源项目，是一个水平可扩展，高可用性，多租户的日志聚合系统。它的设计非常经济高效且易于操作，因为它不会为日志内容编制索引，而是为每个日志流编制一组标签。项目受 Prometheus 启发，官方的介绍就是：\u003ccode\u003eLike Prometheus, but for logs\u003c/code\u003e，类似于 Prometheus 的日志系统\u003c/p\u003e\n\u003cp\u003e与其他日志聚合系统相比，\u003ccode\u003eLoki\u003c/code\u003e具有下面的一些特性：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e不对日志进行全文索引。通过存储压缩非结构化日志和仅索引元数据，Loki 操作起来会更简单，更省成本。\u003c/li\u003e\n\u003cli\u003e通过使用与 Prometheus 相同的标签记录流对日志进行索引和分组，这使得日志的扩展和操作效率更高。\u003c/li\u003e\n\u003cli\u003e特别适合储存 Kubernetes Pod 日志; 诸如 Pod 标签之类的元数据会被自动删除和编入索引。\u003c/li\u003e\n\u003cli\u003e受 Grafana 原生支持。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eLoki 由以下3个部分组成：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eloki\u003c/code\u003e是主服务器，负责存储日志和处理查询。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epromtail\u003c/code\u003e是代理，负责收集日志并将其发送给 loki，当然也支持其它的收集端如fluentd等\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eGrafana\u003c/code\u003e用于 UI 展示\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e同时Loki也提示了command line工具，通过这个工具可以使用http的方式与loki进行交互，这个后面说\u003c/p\u003e\n\u003ch3 id=\"架构\"\u003e\u003ca href=\"#架构\" class=\"headerlink\" title=\"架构\"\u003e\u003c/a\u003e架构\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200718162524.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"安装\"\u003e\u003ca href=\"#安装\" class=\"headerlink\" title=\"安装\"\u003e\u003c/a\u003e安装\u003c/h3\u003e\u003cp\u003e官方提供了多种的部署方式, 这里选择使用\u003ccode\u003ehelm\u003c/code\u003e, 如果只是想试用的话则非常简单, 直接参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/v1.5.0/docs/installation/helm.md\"\u003ehelm\u003c/a\u003e即可run起来，这里就不做搬运工了\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ehelm repo add loki https://grafana.github.io/loki/charts\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ehelm repo update\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ehelm upgrade --install loki loki/loki-stack\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"配置\"\u003e\u003ca href=\"#配置\" class=\"headerlink\" title=\"配置\"\u003e\u003c/a\u003e配置\u003c/h3\u003e\u003cp\u003e对于loki来说，loki端的配置相对来说会比较简单, 采集端由于可以使用pipeline， 因此会稍复杂点，但是如果接触过prometheus，那其它会觉得还是挺情切.\u003c/p\u003e\n\u003cp\u003e先来看服务端loki的配置\u003c/p\u003e\n\u003ch4 id=\"loki-yaml\"\u003e\u003ca href=\"#loki-yaml\" class=\"headerlink\" title=\"loki.yaml\"\u003e\u003c/a\u003eloki.yaml\u003c/h4\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eauth_enabled:\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003echunk_store_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emax_look_back_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e0s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eingester:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003echunk_block_size:\u003c/span\u003e \u003cspan class=\"number\"\u003e262144\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003echunk_idle_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e3m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003echunk_retain_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e1m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elifecycler:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ering:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ekvstore:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003estore:\u003c/span\u003e \u003cspan class=\"string\"\u003einmemory\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ereplication_factor:\u003c/span\u003e \u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emax_transfer_retries:\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003elimits_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eenforce_metric_name:\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ereject_old_samples:\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ereject_old_samples_max_age:\u003c/span\u003e \u003cspan class=\"string\"\u003e168h\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eschema_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003econfigs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003efrom:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;2018-04-15\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eindex:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eperiod:\u003c/span\u003e \u003cspan class=\"string\"\u003e168h\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eprefix:\u003c/span\u003e \u003cspan class=\"string\"\u003eindex_\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eobject_store:\u003c/span\u003e \u003cspan class=\"string\"\u003efilesystem\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eschema:\u003c/span\u003e \u003cspan class=\"string\"\u003ev9\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003estore:\u003c/span\u003e \u003cspan class=\"string\"\u003eboltdb\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eserver:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ehttp_listen_port:\u003c/span\u003e \u003cspan class=\"number\"\u003e3100\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003estorage_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eboltdb:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edirectory:\u003c/span\u003e \u003cspan class=\"string\"\u003e/data/loki/index\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003efilesystem:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edirectory:\u003c/span\u003e \u003cspan class=\"string\"\u003e/data/loki/chunks\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etable_manager:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eretention_deletes_enabled:\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eretention_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e0s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eloki服务端主要定义了数据到达控制面之后的一些策略, 比如ingester size大小， 存储路径等的信息，最好使用SSD.\u003c/p\u003e\n\u003cp\u003e再看看采集端配置\u003c/p\u003e\n\u003ch4 id=\"promtail\"\u003e\u003ca href=\"#promtail\" class=\"headerlink\" title=\"promtail\"\u003e\u003c/a\u003epromtail\u003c/h4\u003e\u003cp\u003eprometail同时充当服务端及客户端\u003c/p\u003e\n\u003ch5 id=\"server\"\u003e\u003ca href=\"#server\" class=\"headerlink\" title=\"server\"\u003e\u003c/a\u003eserver\u003c/h5\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eserver:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ehttp_listen_port:\u003c/span\u003e \u003cspan class=\"number\"\u003e3101\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003epromtail做为服务端, 可同时提供http及grpc能力,而需要进行数据发送到loki时，promtail则为客户端\u003c/p\u003e\n\u003ch5 id=\"client\"\u003e\u003ca href=\"#client\" class=\"headerlink\" title=\"client\"\u003e\u003c/a\u003eclient\u003c/h5\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eclient:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eurl:\u003c/span\u003e \u003cspan class=\"string\"\u003ehttp://loki:3100/loki/api/v1/push\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebackoff_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003emax_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e5s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003emax_retries:\u003c/span\u003e \u003cspan class=\"number\"\u003e20\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003emin_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e100ms\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebatchsize:\u003c/span\u003e \u003cspan class=\"number\"\u003e102400\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ebatchwait:\u003c/span\u003e \u003cspan class=\"string\"\u003e1s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eexternal_labels:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003etimeout:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e当做为client时, promtail做为日志的收集端，然后发送到loki实例\u003c/p\u003e\n\u003cp\u003ebackoff_config 参数指定了当发送日志到loki实例失败时采取的重试策略\u003c/p\u003e\n\u003cp\u003eexternal_labels则可以在所有的日志发送到loki实例前加入k-v的labels.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# WARNING: If one of the remote Loki servers fails to respond or responds\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# with any error which is retryable, this will impact sending logs to any\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# other configured remote Loki servers.  Sending is done on a single thread!\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# It is generally recommended to run multiple promtail clients in parallel\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# if you want to send to multiple remote Loki instances.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"target-config\"\u003e\u003ca href=\"#target-config\" class=\"headerlink\" title=\"target_config\"\u003e\u003c/a\u003etarget_config\u003c/h4\u003e\u003cp\u003e控制从发现的日志文件中读取行为,比如多久读取一次\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etarget_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esync_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"scrape-configs\"\u003e\u003ca href=\"#scrape-configs\" class=\"headerlink\" title=\"scrape_configs\"\u003e\u003c/a\u003escrape_configs\u003c/h4\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003escrape_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes-pods-name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003epipeline_stages:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003edocker:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ekubernetes_sd_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003erelabel_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_label_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__service__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_node_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__host__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003edrop\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__service__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003elabelmap\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_label_(.+)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e/\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_namespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__service__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003ejob\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_namespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003enamespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_container_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003econtainer\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/log/pods/*$1/*.log\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e/\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_uid\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_container_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__path__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e上面是最重要的一个配置, 会发现跟prometheus的配置文件很像， 这里不对上述配置语法进行细说， 感兴趣的可以参考prometheus文档， 这里使用了\u003cstrong\u003e跟prometheus相同的服务发现机制, 同时也是基于lable进行一系列的增删改的操作， 最终实现一条日志上存在多个label，我们可以基于这些label来查询日志\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e这个是直接使用官方提供的example, 可以根据实际情况进行修改.\u003c/p\u003e\n\u003ch5 id=\"pipeline\"\u003e\u003ca href=\"#pipeline\" class=\"headerlink\" title=\"pipeline\"\u003e\u003c/a\u003epipeline\u003c/h5\u003e\u003cp\u003e可以看到上面的配置中出现一个pipeline的选项，这个是用于指定采集到日志后可以进行的操作, 以stage为单位, 目前支持4种stage.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e解析阶段：解析当前日志行并从中提取数据。然后，提取的数据可供其他阶段使用。 \u003c/li\u003e\n\u003cli\u003e转换阶段：转换从先前阶段提取的数据。 \u003c/li\u003e\n\u003cli\u003e行动阶段：从先前阶段中提取数据并对其进行处理。在日志行中添加或修改现有标签 更改日志行的时间戳 更改日志行的内容 根据提取的数据创建指标等\u003c/li\u003e\n\u003cli\u003e筛选阶段：可以根据某些条件选择应用阶段的子集或丢弃条目\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e同时每个stage又有一些预设的可直接供使用的操作.\u003c/p\u003e\n\u003cp\u003e比如上面指定的docker,就属于解析阶段, 它的作用是\u003ccode\u003e通过使用标准Docker格式解析日志行来提取数据\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e这对于直接将应用日志输出到console,然后通过docker的格式打印出来的情况下非常方便. 这也是最常见场景\u003c/p\u003e\n\u003cp\u003e官方的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/pipelines.md\"\u003e说明\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"使用\"\u003e\u003ca href=\"#使用\" class=\"headerlink\" title=\"使用\"\u003e\u003c/a\u003e使用\u003c/h3\u003e\u003col\u003e\n\u003cli\u003e选择数据源\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200718160645.png\"/\u003e\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e填写URL\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200718160706.png\"/\u003e\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e切换到\u003ccode\u003eExplore --\u0026gt; 选择Loki\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200708194140.png\"/\u003e\u003c/p\u003e\n\u003cp\u003eLog labels下拉框中可以下拉选择通过上述服务发现生成的的日志labels, 中间则可以使用label语法进行筛选\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{app=\u003cspan class=\"string\"\u003e\u0026#34;ingress-nginx\u0026#34;\u003c/span\u003e, pod=\u003cspan class=\"string\"\u003e\u0026#34;nginx-ingress-controller-fm24n\u0026#34;\u003c/span\u003e} |=\u003cspan class=\"string\"\u003e\u0026#34;error\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e前半部分很好理解, 后面的\u003ccode\u003e|=\u0026#34;error\u0026#34;\u003c/code\u003e则是在前半部分筛选出来的结果中再次grep出存在error的日志\u003c/p\u003e\n\u003cp\u003e这里使用的是LogQL语法, 见下文\u003c/p\u003e\n\u003col start=\"4\"\u003e\n\u003cli\u003e添加dashboard\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200708194343.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"LogQL\"\u003e\u003ca href=\"#LogQL\" class=\"headerlink\" title=\"LogQL\"\u003e\u003c/a\u003eLogQL\u003c/h3\u003e\u003cp\u003eLoki 使用一种称为 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/master/docs/logql.md#filter-expression\"\u003eLogQL\u003c/a\u003e 的语法来进行日志检索，语法类似 PromQL\u003c/p\u003e\n\u003ch4 id=\"Log-Stream-Selector\"\u003e\u003ca href=\"#Log-Stream-Selector\" class=\"headerlink\" title=\"Log Stream Selector\"\u003e\u003c/a\u003eLog Stream Selector\u003c/h4\u003e\u003cp\u003e也是使用大括号进行条件的筛选, 同时支持正则\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{app=\u003cspan class=\"string\"\u003e\u0026#34;mysql\u0026#34;\u003c/span\u003e,name=~\u003cspan class=\"string\"\u003e\u0026#34;mysql-backup.+\u0026#34;\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e=\u003c/code\u003e: exactly equal.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e!=\u003c/code\u003e: not equal.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e=~\u003c/code\u003e: regex matches.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e!~\u003c/code\u003e: regex does not match.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"Filter-Expression\"\u003e\u003ca href=\"#Filter-Expression\" class=\"headerlink\" title=\"Filter Expression\"\u003e\u003c/a\u003eFilter Expression\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{instance=~\u003cspan class=\"string\"\u003e\u0026#34;kafka-[23]\u0026#34;\u003c/span\u003e,name=\u003cspan class=\"string\"\u003e\u0026#34;kafka\u0026#34;\u003c/span\u003e} != \u003cspan class=\"string\"\u003e\u0026#34;kafka.server:type=ReplicaManager\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e|=\u003c/code\u003e: Log line contains string.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e!=\u003c/code\u003e: Log line does not contain string.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e|~\u003c/code\u003e: Log line matches regular expression.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e!~\u003c/code\u003e: Log line does not match regular expression.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"Metric-Queries\"\u003e\u003ca href=\"#Metric-Queries\" class=\"headerlink\" title=\"Metric Queries\"\u003e\u003c/a\u003eMetric Queries\u003c/h4\u003e\u003cp\u003e这个其实就跟prometheus中的很想像了.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003erate({job=\u003cspan class=\"string\"\u003e\u0026#34;mysql\u0026#34;\u003c/span\u003e} |= \u003cspan class=\"string\"\u003e\u0026#34;error\u0026#34;\u003c/span\u003e != \u003cspan class=\"string\"\u003e\u0026#34;timeout\u0026#34;\u003c/span\u003e [5m])\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003erate\u003c/code\u003e: calculates the number of entries per second\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecount_over_time\u003c/code\u003e: counts the entries for each log stream within the given range.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebytes_rate\u003c/code\u003e: calculates the number of bytes per second for each stream.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebytes_over_time\u003c/code\u003e: counts the amount of bytes used by each log stream for a given range.\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"Aggregation-operators\"\u003e\u003ca href=\"#Aggregation-operators\" class=\"headerlink\" title=\"Aggregation operators\"\u003e\u003c/a\u003eAggregation operators\u003c/h4\u003e\u003cp\u003e当然还支持一些聚合操作，比如\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eavg(rate(({job=\u003cspan class=\"string\"\u003e\u0026#34;nginx\u0026#34;\u003c/span\u003e} |= \u003cspan class=\"string\"\u003e\u0026#34;GET\u0026#34;\u003c/span\u003e)[10s])) by (region)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003esum\u003c/code\u003e: Calculate sum over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emin\u003c/code\u003e: Select minimum over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003emax\u003c/code\u003e: Select maximum over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eavg\u003c/code\u003e: Calculate the average over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estddev\u003c/code\u003e: Calculate the population standard deviation over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estdvar\u003c/code\u003e: Calculate the population standard variance over labels\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecount\u003c/code\u003e: Count number of elements in the vector\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ebottomk\u003c/code\u003e: Select smallest k elements by sample value\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etopk\u003c/code\u003e: Select largest k elements by sample value\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e还有很多比如’and, or’的操作都是支持, 就不一一搬运了\u003c/p\u003e\n\u003ch4 id=\"logcli\"\u003e\u003ca href=\"#logcli\" class=\"headerlink\" title=\"logcli\"\u003e\u003c/a\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/master/docs/getting-started/logcli.md\"\u003elogcli\u003c/a\u003e\u003c/h4\u003e\u003cp\u003elogcli做为一个命令行工具, 可以直接与loki进行交互, 目前grafana是不支持对loki进行告警, 可以通过logcli写脚本的方式进行，也是种办法\u003c/p\u003e\n\u003ch3 id=\"性能\"\u003e\u003ca href=\"#性能\" class=\"headerlink\" title=\"性能\"\u003e\u003c/a\u003e性能\u003c/h3\u003e\u003cp\u003e要知道es产生的索引可能跟日志本身一样大, loki最大的特点就是同一类型的日志带有相同的label，这样的话产生的索引就会压缩几个数量级，这就不需要像es查询一样将索引放入内存中， 从而可以使内存加载更大的日志量, 另一方面, loki实现了类型于分布式的grep,会将查询分解成较小的shard并行处理, 因为不需要全文检索，因此速度上会更快.\u003c/p\u003e\n\u003cp\u003e关于性能方面也局限于官方的说法, 还没有做过性能测试，目前还没有在生产上使用loki, 但是在QA/DEV环境中使用,体验还是不错的, 不用在grafana/kibana来回切换了.\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://dockone.io/article/10443\"\u003ehttp://dockone.io/article/10443\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/Linkthaha/article/details/100575651\"\u003ehttps://blog.csdn.net/Linkthaha/article/details/100575651\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/c3d3f2ba77/docs/operations/loki-canary.md\"\u003ehttps://github.com/grafana/loki/blob/c3d3f2ba77/docs/operations/loki-canary.md\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/docker.md\"\u003ehttps://github.com/grafana/loki/blob/v1.5.0/docs/clients/promtail/stages/docker.md\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-07-15T15:40:53+08:00",
  "Author": "Z.S.K."
}