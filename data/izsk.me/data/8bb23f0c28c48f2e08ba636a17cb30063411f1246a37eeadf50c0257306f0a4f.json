{
  "Source": "izsk.me",
  "Title": "Python学习(flask-apispec简洁之道)",
  "Link": "https://izsk.me/2022/10/05/python-flask-apispec/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在使用python写web框架时，经常会碰到需要对request参数进行检验或者过滤，如果将诸多的校验逻辑都堆积在业务逻辑中，会显得很臃肿，在flask中，推荐一个很棒的库，可以写法变得很清晰.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003c!-- more --\u003e\n\n\u003cp\u003e比如有这么个需求: 在flask中，有个app route需要验证requests的post中body传递过来的token字段必须在配置文件中才合法，同时phone字段需要符合规则，再同时，除了必要的字段外，不能有其它的字段，如果出现其它的字段，但返回指定的错误码.\u003cbr/\u003e如果在代码中直接写各种判断也是ok，之前作者也常是这么做，但明显不够优雅，引入flask-apispec就可以很好的解决问题，让代码看上去很简洁.\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e74\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e75\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e76\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e77\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e78\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e79\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e81\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e82\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e83\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e84\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e85\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#!/usr/local/bin/python \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#-* coding: utf-8-*-\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e os \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e re \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e json \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e fire \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e requests\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e config \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e cfg \u003cspan class=\"keyword\"\u003eas\u003c/span\u003e CFG \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e loguru \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e logger\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e utils.Dingtalk \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e DingtalkChatbot \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e pkg resources \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e require\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e marshmallow \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e fields, ValidationError\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e flask \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e request, Flask, jsonify, make_response \u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e flask_apispec \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e use_kwargs\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efrom\u003c/span\u003e tenacity \u003cspan class=\"keyword\"\u003eimport\u003c/span\u003e retry, stop_after_attempt, wait_fixed\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eapp.Flask(__name__)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eapp.Config[\u003cspan class=\"string\"\u003e\u0026#39;JSON_AS_ASCII\u0026#39;\u003c/span\u003e] = \u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 处理出现422及400错误，返回对应的信息，发送回403\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# Hand http error code 422 and 400 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@app.Errorhandler(\u003cspan class=\"params\"\u003e\u003cspan class=\"number\"\u003e422\u003c/span\u003e\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@app.Errorhandler(\u003cspan class=\"params\"\u003e\u003cspan class=\"number\"\u003e400\u003c/span\u003e\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ehandle_error\u003c/span\u003e(\u003cspan class=\"params\"\u003eerr\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  msg = err.Data.Get(\u003cspan class=\"string\"\u003e\u0026#34;messages\u0026#34;\u003c/span\u003e,  [\u003cspan class=\"string\"\u003e\u0026#34;Invalid Request\u0026#34;\u003c/span\u003e]) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  logger.Critical(msg)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e make_response(jsonify({\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: msg[\u003cspan class=\"string\"\u003e\u0026#34;json\u0026#34;\u003c/span\u003e]}), \u003cspan class=\"number\"\u003e403\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 这是dingding发送逻辑，不重要\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003edingtalk\u003c/span\u003e(\u003cspan class=\"params\"\u003e**kw\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  is_at_all=\u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  content = kw.Get(\u003cspan class=\"string\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;alarm: THIS-IS-DEFAULT-CONTENT-FROM-DINGTALK\u0026#34;\u003c/span\u003e) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  token = kw.Get(\u003cspan class=\"string\"\u003e\u0026#34;token\u0026#34;\u003c/span\u003e) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  to = kw.Get(\u003cspan class=\"string\"\u003e\u0026#34;to\u0026#34;\u003c/span\u003e) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e token \u003cspan class=\"keyword\"\u003eor\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e to:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    logger.Error(\u003cspan class=\"string\"\u003e\u0026#34;token or to can\u0026#39;t be null... \u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;@all\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e to:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      is_at_all = \u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      tos = []\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      tos = [x \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e x \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e to.Replace (\u003cspan class=\"string\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;\u0026#34;\u003c/span\u003e).Split(\u003cspan class=\"string\"\u003e\u0026#34;, \u0026#34;\u003c/span\u003e)]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      logger.Info (\u003cspan class=\"string\"\u003e\u0026#34;alert [dingtalk]: {}\u0026#34;\u003c/span\u003e.\u003cspan class=\"built_in\"\u003eformat\u003c/span\u003e(content))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      xiaoding.DingtalkChatbot(**{\u003cspan class=\"string\"\u003e\u0026#34;token\u0026#34;\u003c/span\u003e: token})\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      xiaoding.Send_text(msg=\u003cspan class=\"string\"\u003e\u0026#34;alarm: \u0026#34;\u003c/span\u003e + content, at_mobiles=tos, is_at_all=is_at_all)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 正则判断手机号是否合法\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ephone_check\u003c/span\u003e(\u003cspan class=\"params\"\u003ephone\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  phone_rule=\u003cspan class=\"string\"\u003e\u0026#34;^((13[0-9])|(14[5,7])|(15[0-3,5-9])|(17[0,3,5-8])|(18[0-9])166|198|199|(147))\\\\d{8}$\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e re.Match(phone_rule, phone.Strip()) \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"literal\"\u003eFalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 检验发送者手机号是否合法\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003echeck_sender\u003c/span\u003e(\u003cspan class=\"params\"\u003eto\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;@all\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e to:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e x \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e to.Strip().Split (\u003cspan class=\"string\"\u003e\u0026#34;, \u0026#34;\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e x.Strip().Isdigit() \u003cspan class=\"keyword\"\u003eor\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e phone_check(x):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003eraise\u003c/span\u003e ValidationError(\u003cspan class=\"string\"\u003e\u0026#34;phone NotFound or number is invalid\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看token是否在配置文件中, 配置文件是个yaml格式，格式不重要.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003emust_exist_in_conf\u003c/span\u003e(\u003cspan class=\"params\"\u003et\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e t.Strip() \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e CFG[\u003cspan class=\"string\"\u003e\u0026#34;dingtalk\u0026#34;\u003c/span\u003e][\u003cspan class=\"string\"\u003e\u0026#34;tokens\u0026#34;\u003c/span\u003e]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eraise\u003c/span\u003e ValidationError(\u003cspan class=\"string\"\u003e\u0026#34;token is invalid\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 重要\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eargs_dt = {\u003cspan class=\"string\"\u003e\u0026#34;token\u0026#34;\u003c/span\u003e: fields.Str(required=\u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e, validate=must_exist_in_conf), \u003cspan class=\"string\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: fields.Str(required=\u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e), \u003cspan class=\"string\"\u003e\u0026#34;to\u0026#34;\u003c/span\u003e: fields.Str(load_default=\u003cspan class=\"string\"\u003e\u0026#34;@all\u0026#34;\u003c/span\u003e, validate=check_sender)}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 重要\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# use kwargs dict field will pass to **kw args\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@app.Route(\u003cspan class=\"params\"\u003e\u003cspan class=\"string\"\u003e\u0026#34;/webhook/dingtalk\u0026#34;\u003c/span\u003e, methods=[\u003cspan class=\"string\"\u003e\u0026#34;POST\u0026#34;\u003c/span\u003e]\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@use_kwargs(\u003cspan class=\"params\"\u003eargs_dt, location=\u003cspan class=\"string\"\u003e\u0026#34;json\u0026#34;\u003c/span\u003e\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ewebhook_dingtalk\u003c/span\u003e(\u003cspan class=\"params\"\u003e**kw\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  _dingtalk (**kw)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e make_response(jsonify({\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;OK\u0026#34;\u003c/span\u003e}), \u003cspan class=\"number\"\u003e200\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 启动flask\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003erunapp\u003c/span\u003e():\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  app.Run(host=\u003cspan class=\"string\"\u003e\u0026#39;0.0.0.0\u0026#39;\u003c/span\u003e, port=\u003cspan class=\"number\"\u003e5555\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ewatchdog\u003c/span\u003e():\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003epass\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e name == \u003cspan class=\"string\"\u003e\u0026#34; main \u0026#34;\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  fire. Fire({\u003cspan class=\"string\"\u003e\u0026#34;runapp\u0026#34;\u003c/span\u003e: runapp, \u003cspan class=\"string\"\u003e\u0026#34;watchdog\u0026#34;\u003c/span\u003e: watchdog})\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e其它的也没什么，重要的只的\u003ccode\u003e@use_kwargs\u003c/code\u003e装饰器,接下来详细展开\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@app.Route(\u003cspan class=\"params\"\u003e\u003cspan class=\"string\"\u003e\u0026#34;/webhook/dingtalk\u0026#34;\u003c/span\u003e, methods= [\u003cspan class=\"string\"\u003e\u0026#34;POST\u0026#34;\u003c/span\u003e]\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@use_kwargs(\u003cspan class=\"params\"\u003eargs_dt, location=\u003cspan class=\"string\"\u003e\u0026#34;json\u0026#34;\u003c/span\u003e\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ewebhook_dingtalk\u003c/span\u003e(\u003cspan class=\"params\"\u003e**kw\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  _dingtalk (**kw)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e make_response(jsonify({\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;OK\u0026#34;\u003c/span\u003e}), \u003cspan class=\"number\"\u003e200\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如果按照正常的写法一般是\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e@app.Route(\u003cspan class=\"params\"\u003e\u003cspan class=\"string\"\u003e\u0026#34;/webhook/dingtalk\u0026#34;\u003c/span\u003e, methods=[\u003cspan class=\"string\"\u003e\u0026#34;POST\u0026#34;\u003c/span\u003e]\u003c/span\u003e) \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003ewebhook_dingtalk\u003c/span\u003e():\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  res = request.json()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# 调用各种逻辑对参数进行判断\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  _dingtalk (**res)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e make_response(jsonify({\u003cspan class=\"string\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;OK\u0026#34;\u003c/span\u003e}), \u003cspan class=\"number\"\u003e200\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在函数中直接使用\u003ccode\u003erequest.json()\u003c/code\u003e获取body的key-value, 然后做各种判断\u003cbr/\u003e那现在主函数\u003ccode\u003ewebhook_dingtalk(**kw)\u003c/code\u003e非常简短，答案就在引入了\u003ccode\u003euse_kwargs\u003c/code\u003e,简单来讲就是\u003ccode\u003euse_kwargs\u003c/code\u003e将接收request的参数，然后将参数作用于第一个参数指定的字典，即\u003ccode\u003eargs_dt\u003c/code\u003e，简单看一下\u003ccode\u003eargs_dt\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eargs_dt = {\u003cspan class=\"string\"\u003e\u0026#34;token\u0026#34;\u003c/span\u003e: fields.Str(required=\u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e, validate=must_exist_in_conf), \u003cspan class=\"string\"\u003e\u0026#34;content\u0026#34;\u003c/span\u003e: fields.Str(required=\u003cspan class=\"literal\"\u003eTrue\u003c/span\u003e), \u003cspan class=\"string\"\u003e\u0026#34;to\u0026#34;\u003c/span\u003e: fields.Str(load_default=\u003cspan class=\"string\"\u003e\u0026#34;@all\u0026#34;\u003c/span\u003e, validate=check_sender)}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e其实也是非常清晰，在这个字典中其它指定了参数列表，也指定了各个参数需要进行的判断,比如token字段，required=True,表明这个字段是必要的，validate则表示这个字段需要进行的逻辑处理, 那么这里就可以写各种业务上的判断了,其实内置了很多常用的一些规则，比如判断是不是布尔型\u003ccode\u003efields.Boolean()\u003c/code\u003e等等.\u003cbr/\u003e这种写法是不是让主函数看上去简洁了许多.\u003cbr/\u003e主函数\u003ccode\u003ewebhook_dingtalk(**kw)\u003c/code\u003e接收的参数只有kw, kw其它就是args_dt合法后传递过来，\u003cstrong\u003e如果从requst中拿到的参数不符合args_dt中指定的任一规则，则会触发422或者400错误，将会调用代码最上面定义的handle_error自定义逻辑，这里是返回403错误\u003c/strong\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003edef\u003c/span\u003e \u003cspan class=\"title function_\"\u003euse_kwargs\u003c/span\u003e(\u003cspan class=\"params\"\u003eargs, locations=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, inherit=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, apply=\u003cspan class=\"literal\"\u003eNone\u003c/span\u003e, **kwargs\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003epass\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e另外, use_kwargs的第2个参数location,表示的是从http传递过来的参数是以什么方式呈现，可以选用(‘json’, ‘querystring’, ‘form’, ‘headers’, ‘cookies’, ‘files’)作为locations的值,因为参数可以放在body中，也可以放在header或者是cookies中，这个参数主要是告诉use_kwargs需要的参数保存在哪里.\u003cbr/\u003eflask-apispec内部用了webargs用于参数解析, marshmallow库用于返回响应,也用了apispec，还有一些很实用的功能，感兴趣的可以查看\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/jmcarp/flask-apispec\"\u003e官网\u003c/a\u003e\u003cbr/\u003e使用flask-apispec, 代码看上去舒服多了\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/jmcarp/flask-apispec\"\u003ehttps://github.com/jmcarp/flask-apispec\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/weixin_43845541/article/details/95106349\"\u003ehttps://blog.csdn.net/weixin_43845541/article/details/95106349\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2022-10-05T13:30:53+08:00",
  "Author": "Z.S.K."
}