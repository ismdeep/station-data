{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(hostPort劫持了我的请求)",
  "Link": "https://izsk.me/2021/08/01/Kubernetes-hostport/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e最近排查了一个kubernetes中使用了hostport后遇到比较坑的问题，奇怪的知识又增加了.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"问题背景\"\u003e\u003ca href=\"#问题背景\" class=\"headerlink\" title=\"问题背景\"\u003e\u003c/a\u003e问题背景\u003c/h3\u003e\u003cp\u003e集群环境为K8s v1.15.9，cni指定了flannel-vxlan跟portmap, kube-proxy使用mode为ipvs，集群3台master,同时也是node，这里以node-1,node-2,node-3来表示。\u003c/p\u003e\n\u003cp\u003e集群中有2个mysql, 部署在两个ns下，mysql本身不是问题重点，这里就不细说，这里以mysql-A,mysql-B来表示。\u003c/p\u003e\n\u003cp\u003emysql-A落在node-1上，mysql-B落在node-2上， \u003cstrong\u003e两个数据库svc名跟用户、密码完全不相同\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e出现诡异的现象这里以一张图来说明会比较清楚一些:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210729220711.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e其中绿线的表示访问没有问题，红线表示连接Mysql-A提示用户名密码错误\u003c/p\u003e\n\u003cp\u003e特别诡异的是，当在Node-2上通过svc访问Mysql-A时，输入Mysql-A的用户名跟密码提示密码错误，密码确认无疑，但当输入Mysql-B的用户名跟密码，居然能够连接上，看了下数据，连上的是Mysql-B的数据库，给人的感觉就是请求转到了Mysql-A, 最后又转到了Mysql-B，当时让人大跌眼镜\u003c/p\u003e\n\u003cp\u003e碰到诡异的问题那就排查吧，排查的过程倒是不费什么事，最主要的是要通过这次踩坑机会挖掘一些奇怪的知识出来。\u003c/p\u003e\n\u003ch3 id=\"排查过程\"\u003e\u003ca href=\"#排查过程\" class=\"headerlink\" title=\"排查过程\"\u003e\u003c/a\u003e排查过程\u003c/h3\u003e\u003cp\u003e既然在Node-1上连接Mysql-A/Mysql-B都没有问题，那基本可以排查是Mysql-A的问题\u003c/p\u003e\n\u003cp\u003e经实验，在Node-2上所有的服务想要连Mysql-A时，都有这个问题，但是访问其它的服务又都没有问题，说明要么是mysql-A的3306这个端口有问题，通过上一步应该排查了mysql-A的问题，那问题只能出在Node-2上\u003c/p\u003e\n\u003cp\u003e在k8s中像这样的请求转发出现诡异现象，当排除了一些常见的原因之外，最大的嫌疑就是iptables了，作者遇到过多次\u003c/p\u003e\n\u003cp\u003e这次也不例外，虽然当前集群使用的ipvs， 但还是照例看下iptables规则，查看Node-2上的iptables与Node-1的iptables比对，结果有蹊跷, 在Node-2上发现有以下的规则在其它节点上没有\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e-A\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-DN-xxxx\u003c/span\u003e \u003cspan class=\"string\"\u003e-p\u003c/span\u003e \u003cspan class=\"string\"\u003etcp\u003c/span\u003e \u003cspan class=\"string\"\u003e-m\u003c/span\u003e \u003cspan class=\"string\"\u003etcp\u003c/span\u003e \u003cspan class=\"string\"\u003e--dport\u003c/span\u003e \u003cspan class=\"number\"\u003e3306\u003c/span\u003e \u003cspan class=\"string\"\u003e-j\u003c/span\u003e \u003cspan class=\"string\"\u003eDNAT\u003c/span\u003e \u003cspan class=\"string\"\u003e--to-destination\u003c/span\u003e \u003cspan class=\"number\"\u003e10.224\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.222\u003c/span\u003e\u003cspan class=\"string\"\u003e:3306\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e-A\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-HOSTPORT-DNAT\u003c/span\u003e \u003cspan class=\"string\"\u003e-m\u003c/span\u003e \u003cspan class=\"string\"\u003ecomment\u003c/span\u003e \u003cspan class=\"string\"\u003e--comment\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;dnat name\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\\\u0026#34;cni0\\\u0026#34;\u003c/span\u003e \u003cspan class=\"attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"string\"\u003e\\\u0026#34;xxxxxxxxxxxxx\\\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"string\"\u003e-j\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-DN-xxx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e-A\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-HOSTPORT-SNAT\u003c/span\u003e \u003cspan class=\"string\"\u003e-m\u003c/span\u003e \u003cspan class=\"string\"\u003ecomment\u003c/span\u003e \u003cspan class=\"string\"\u003e--comment\u003c/span\u003e \u003cspan class=\"attr\"\u003e\u0026#34;snat name\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\\\u0026#34;cni0\\\u0026#34;\u003c/span\u003e \u003cspan class=\"attr\"\u003eid:\u003c/span\u003e \u003cspan class=\"string\"\u003e\\\u0026#34;xxxxxxxxxxxxx\\\u0026#34;\u0026#34;\u003c/span\u003e \u003cspan class=\"string\"\u003e-j\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-SN-xxx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e-A\u003c/span\u003e \u003cspan class=\"string\"\u003eCNI-SN-xxx\u003c/span\u003e \u003cspan class=\"string\"\u003e-s\u003c/span\u003e \u003cspan class=\"number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.1\u003c/span\u003e\u003cspan class=\"string\"\u003e/32\u003c/span\u003e \u003cspan class=\"string\"\u003e-d\u003c/span\u003e \u003cspan class=\"number\"\u003e10.224\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.222\u003c/span\u003e\u003cspan class=\"string\"\u003e/32\u003c/span\u003e \u003cspan class=\"string\"\u003e-p\u003c/span\u003e \u003cspan class=\"string\"\u003etcp\u003c/span\u003e \u003cspan class=\"string\"\u003e-m\u003c/span\u003e \u003cspan class=\"string\"\u003etcp\u003c/span\u003e \u003cspan class=\"string\"\u003e--dport\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e \u003cspan class=\"string\"\u003e-j\u003c/span\u003e \u003cspan class=\"string\"\u003eMASQUERADE\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e其中10.224.0.222为Mysql-B的pod ip, xxxxxxxxxxxxx经查实为Mysql-B对应的pause容器的id\u003c/p\u003e\n\u003cp\u003e从上面的规则总结一下就是目的为3306端口的请求都会转发到10.224.0.222这个地址，即Mysql-B\u003c/p\u003e\n\u003cp\u003e看到这里，作者明白了为什么在Node-2上去访问Node-1上Mysql-A的3306会提示密码错误而输入Mysql-B的密码却可以正常访问\u003c/p\u003e\n\u003cp\u003e虽然两个mysql的svc名不一样，但上面的iptables只要目的端口是3306就转发到Mysql-B了，当请求到达mysql后，使用正确的用户名密码自然可以登录成功\u003c/p\u003e\n\u003cp\u003e原因是找到了，但是又引出来了更多的问题? \u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e这几条规则是谁入到iptables中的？\u003c/li\u003e\n\u003cli\u003e怎么解决呢，是不是删掉就可以?\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"问题复现\"\u003e\u003ca href=\"#问题复现\" class=\"headerlink\" title=\"问题复现\"\u003e\u003c/a\u003e问题复现\u003c/h3\u003e\u003cp\u003e同样是Mysql，为何Mysql-A没有呢? 那么比对一下这两个Mysql的部署差异\u003c/p\u003e\n\u003cp\u003e比对发现, 除了用户名密码，ns不一样外，Mysql-B部署时使用了hostPort=3306, 其它的并无异常\u003c/p\u003e\n\u003cp\u003e难道是因为hostPort？\u003c/p\u003e\n\u003cp\u003e作者日常会使用NodePort，倒却是没怎么在意hostPort,也就停留在hostPort跟NodePort的差别在于NodePort是所有Node上都会开启端口，而hostPort只会在运行机器上开启端口，由于hostPort使用的也少，也就没太多关注，网上短暂搜了一番，描述的也不是很多，看起来大家也用的不多\u003c/p\u003e\n\u003cp\u003e那到底是不是因为hostPort呢?\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eTalk is cheap, show me the code\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e通过实验来验证，这里简单使用了三个nginx来说明问题, 其中两个使用了hostPort，这里特意指定了不同的端口，其它的都完全一样，发布到集群中，yaml文件如下\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003eapps/v1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eDeployment\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-hostport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-hostport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ereplicas:\u003c/span\u003e \u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eselector:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ematchLabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-hostport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-hostport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003enodeName:\u003c/span\u003e \u003cspan class=\"string\"\u003espring-38\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003econtainers:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx:latest\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003econtainerPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e              \u003cspan class=\"attr\"\u003ehostPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e31123\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eFinally,问题复现:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210728133243.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以肯定，这些规则就是因为使用了hostPort而写入的,但是\u003cstrong\u003e由谁写入的这个问题还是没有解决?\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"罪魁祸首\"\u003e\u003ca href=\"#罪魁祸首\" class=\"headerlink\" title=\"罪魁祸首\"\u003e\u003c/a\u003e罪魁祸首\u003c/h3\u003e\u003cp\u003e作者开始以为这些iptables规则是由kube-proxy写入的, 但是查看kubelet的源码并未发现上述规则的关键字\u003c/p\u003e\n\u003cp\u003e再次实验及结合网上的探索，可以得到以下结论:\u003c/p\u003e\n\u003cp\u003e首先从kubernetes的官方发现以下描述:\u003c/p\u003e\n\u003cp\u003eThe CNI networking plugin supports \u003ccode\u003ehostPort\u003c/code\u003e. You can use the official \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/containernetworking/plugins/tree/master/plugins/meta/portmap\"\u003eportmap\u003c/a\u003e plugin offered by the CNI plugin team or use your own plugin with portMapping functionality.\u003c/p\u003e\n\u003cp\u003eIf you want to enable \u003ccode\u003ehostPort\u003c/code\u003e support, you must specify \u003ccode\u003eportMappings capability\u003c/code\u003e in your \u003ccode\u003ecni-conf-dir\u003c/code\u003e. For example:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;name\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;k8s-pod-network\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;cniVersion\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;0.3.0\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;plugins\u0026#34;:\u003c/span\u003e [\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e# ...其它的plugin\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003e\u0026#34;type\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;portmap\u0026#34;\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003e\u0026#34;capabilities\u0026#34;:\u003c/span\u003e {\u003cspan class=\"attr\"\u003e\u0026#34;portMappings\u0026#34;:\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/\"\u003ehttps://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e也就是如果使用了hostPort， 是由portmap这个cni提供portMapping能力，同时，如果想使用这个能力，在配置文件中一定需要开启portmap，这个在作者的集群中也开启了，这点对应上了\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e另外一个比较重要的结论是:\u003c/p\u003e\n\u003cp\u003eThe CNI ‘portmap’ plugin, used to setup HostPorts for CNI, inserts rules at the front of the iptables nat chains; which take precedence over the KUBE- SERVICES chain. Because of this, the HostPort/portmap rule could match incoming traffic even if there were better fitting, more specific service definition rules like NodePorts later in the chain\u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://ubuntu.com/security/CVE-2019-9946\"\u003ehttps://ubuntu.com/security/CVE-2019-9946\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e翻译过来就是使用hostPort后，会在iptables的nat链中插入相应的规则，而且这些规则是在KUBE- SERVICES规则之前插入的，也就是说会优先匹配hostPort的规则，我们常用的NodePort规则其实是在KUBE- SERVICES之中，也排在其后\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e从portmap的源码中果然是可以看到相应的代码\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210729225847.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e感兴趣的可以的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/containernetworking/plugins.git\"\u003eplugins\u003c/a\u003e项目的meta/portmap/portmap.go中查看完整的源码\u003c/p\u003e\n\u003cp\u003e所以，\u003cstrong\u003e最终是调用portmap写入的这些规则.\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"端口占用\"\u003e\u003ca href=\"#端口占用\" class=\"headerlink\" title=\"端口占用\"\u003e\u003c/a\u003e端口占用\u003c/h3\u003e\u003cp\u003e进一步实验发现，hostport可以通过iptables命令查看到， 但是无法在ipvsadm中查看到\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e使用lsof/netstat也查看不到这个端口,这是因为hostport是通过iptables对请求中的目的端口进行转发的，并不是在主机上通过端口监听\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210728133203.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e既然lsof跟netstat都查不到端口信息，那这个端口相当于没有处于listen状态?\u003c/p\u003e\n\u003cp\u003e如果这时再部署一个hostport提定相同端口的应用会怎么样呢?\u003c/p\u003e\n\u003cp\u003e结论是: \u003cstrong\u003e使用hostPort的应用在调度时无法调度在已经使用过相同hostPort的主机上，也就是说，在调度时会考虑hostport\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e如果强行让其调度在同一台机器上，那么就会出现以下错误，如果不删除的话，这样的错误会越来越多，吓的作者赶紧删了.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210728132630.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e如果这个时候创建一个nodePort类型的svc， 端口也为31123,结果会怎么样呢?\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003eapps/v1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eDeployment\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ereplicas:\u003c/span\u003e \u003cspan class=\"number\"\u003e1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eselector:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ematchLabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003elabels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003enodeName:\u003c/span\u003e \u003cspan class=\"string\"\u003espring-38\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003econtainers:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eimage:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx:latest\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003econtainerPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eService\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emetadata:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003espec:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"string\"\u003eNodePort\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eports:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eport:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003etargetPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e80\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003enodePort:\u003c/span\u003e \u003cspan class=\"number\"\u003e31123\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eselector:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ek8s-app:\u003c/span\u003e \u003cspan class=\"string\"\u003enginx-nodeport2\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210728133425.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以发现，NodePort是可以成功创建的，同时监听的端口也出现了.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e从这也可以说明使用hostposrt指定的端口并没有listen主机的端口，要不然这里就会提示端口重复之类\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e那么问题又来了，同一台机器上同时存在有hostPort跟nodePort的端口，这个时候如果curl 31123时， 访问的是哪一个呢?\u003c/p\u003e\n\u003cp\u003e经多次使用curl请求后，均是使用了hostport那个nginx pod收到请求\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e原因还是因为KUBE-NODE-PORT规则在KUBE-SERVICE的链中是处于最后位置，而hostPort通过portmap写入的规则排在其之前\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210728142725.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e因此会先匹配到hostport的规则，自然请求就被转到hostport所在的pod中，这两者的顺序是没办法改变的，因此无论是hostport的应用发布在前还是在后都无法影响请求转发\u003c/p\u003e\n\u003cp\u003e另外再提一下，\u003cstrong\u003ehostport的规则在ipvsadm中是查询不到的，而nodePort的规则则是可以使用ipvsadm查询得到\u003c/strong\u003e\u003c/p\u003e\n\u003ch3 id=\"问题解决\"\u003e\u003ca href=\"#问题解决\" class=\"headerlink\" title=\"问题解决\"\u003e\u003c/a\u003e问题解决\u003c/h3\u003e\u003cp\u003e要想把这些规则删除，可以直接将hostport去掉，那么规则就会随着删除,比如下图中去掉了一个nginx的hostport\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210727230931.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e另外使用较多的port-forward也是可以进行端口转发的，它又是个什么情况呢? 它其实使用的是socat及netenter工具，网上看到一篇文章，原理写的挺好的，感兴趣的可以看一看\u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://vflong.github.io/sre/k8s/2020/03/15/how-the-kubectl-port-forward-command-works.html\"\u003ehttps://vflong.github.io/sre/k8s/2020/03/15/how-the-kubectl-port-forward-command-works.html\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"生产建议\"\u003e\u003ca href=\"#生产建议\" class=\"headerlink\" title=\"生产建议\"\u003e\u003c/a\u003e生产建议\u003c/h3\u003e\u003cp\u003e一句话，生产环境除非是\u003cstrong\u003e必要且无他法\u003c/strong\u003e，不然\u003cstrong\u003e一定不要使用hostport\u003c/strong\u003e，除了会影响调度结果之外，还会出现上述问题，可能造成的后果是非常严重的\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.qikqiak.com/post/how-to-use-ipvs-in-kubernetes/\"\u003ehttps://www.qikqiak.com/post/how-to-use-ipvs-in-kubernetes/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://serenafeng.github.io/2020/03/26/kube-proxy-in-iptables-mode/\"\u003ehttps://serenafeng.github.io/2020/03/26/kube-proxy-in-iptables-mode/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zhuanlan.zhihu.com/p/94418251\"\u003ehttps://zhuanlan.zhihu.com/p/94418251\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://ronaknathani.com/blog/2020/07/kubernetes-nodeport-and-iptables-rules/\"\u003ehttps://ronaknathani.com/blog/2020/07/kubernetes-nodeport-and-iptables-rules/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/\"\u003ehttps://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://vflong.github.io/sre/k8s/2020/03/15/how-the-kubectl-port-forward-command-works.html\"\u003ehttps://vflong.github.io/sre/k8s/2020/03/15/how-the-kubectl-port-forward-command-works.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2021-08-01T10:20:53+08:00",
  "Author": "Z.S.K."
}