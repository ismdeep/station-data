{
  "Source": "izsk.me",
  "Title": "cilium在kubernetes中的生产实践二(cilium部署)",
  "Link": "https://izsk.me/2023/06/03/cilium-on-kubernetes-install/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在前东家的时候其实就有意将cilium强大的链路追踪能力集成到生产环境中,各种因素导致没有很大信心落地, 经过深入调研(也就把官网docs翻了四五遍)及测试, 终于有机会在生产kubernetes集群中(其中一个集群规模不算很大,2w+核心,持续增长)使用cilium做为cni,同时替换kube-proxy, 到现在已经有一段时间了，也算是有生产经验可以跟大家聊一聊这个工具，使用体验总结一句话: 轻松愉悦.\u003cbr/\u003e分享一下整个落地过程,同时也总结下方方面面, 工作之余尽量更新.\u003cbr/\u003e此篇为: cilium在kubernetes中的生产实践二(cilium部署)\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003e总体分为以下几块内容:\u003cbr/\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2023/04/01/cilium-on-kubernetes-introduction/\"\u003ecilium在kubernetes中的生产实践一(cilium介绍)\u003c/a\u003e\u003cbr/\u003ecilium在kubernetes中的生产实践二(cilium部署)\u003cbr/\u003ecilium在kubernetes中的生产实践三(cilium网络模型之关键配置)\u003cbr/\u003ecilium在kubernetes中的生产实践四(cilium网络模型之生产实践)\u003cbr/\u003ecilium在kubernetes中的生产实践五(cilium网络策略)\u003cbr/\u003ecilium在kubernetes中的生产实践六(cilium排错指南)\u003cbr/\u003ecilium在kubernetes中的生产实践七(cilium中的bpf hook)\u003c/p\u003e\n\u003ch3 id=\"内核要求\"\u003e\u003ca href=\"#内核要求\" class=\"headerlink\" title=\"内核要求\"\u003e\u003c/a\u003e内核要求\u003c/h3\u003e\u003cp\u003e由于eBPF是个较新的特性, 因此对内核版本有要求,建议最少4.18+以上的内核版本,cilium有些功能必须要5.0+之上的内核版本，生产环境下大多数都不会满足\u003c/p\u003e\n\u003cp\u003e相关参数如下:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eos:\u003c/span\u003e \u003cspan class=\"string\"\u003eRockey\u003c/span\u003e \u003cspan class=\"string\"\u003eLinux\u003c/span\u003e \u003cspan class=\"string\"\u003erelease\u003c/span\u003e \u003cspan class=\"number\"\u003e8.7\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekernel:\u003c/span\u003e \u003cspan class=\"number\"\u003e4.18\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e-425.10\u003c/span\u003e\u003cspan class=\"number\"\u003e.1\u003c/span\u003e\u003cspan class=\"string\"\u003e.el8_7.x86_64\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ek8s:\u003c/span\u003e \u003cspan class=\"string\"\u003ev1.22.13\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003edocker:\u003c/span\u003e \u003cspan class=\"string\"\u003ev20.10.18\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003ecilium功能对内核版本要求，查看如下列表:\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.cilium.io/en/v1.12/operations/system_requirements/#required-kernel-versions-for-advanced-features\"\u003eSystem Requirements \u0026amp;mdash; Cilium 1.12.10 documentation\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e基于该列表再结合已有环境的内核版本来决定是否开启相关功能\u003c/p\u003e\n\u003ch3 id=\"k8s安装\"\u003e\u003ca href=\"#k8s安装\" class=\"headerlink\" title=\"k8s安装\"\u003e\u003c/a\u003ek8s安装\u003c/h3\u003e\u003cp\u003e这里简单带一下k8s使用cilium替换kube-proxy的安装，kubeadm集群初始化配置文件参考: \u003ccode\u003ekubeadm-kubeproxy-free.conf\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e74\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e75\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e76\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e77\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e78\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e79\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e81\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e82\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e83\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e84\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e85\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e86\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e87\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e88\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e89\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e90\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e91\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e92\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e93\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e94\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e95\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e96\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e97\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e98\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e99\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubeadm.k8s.io/v1beta3\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ebootstrapTokens:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003egroups:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003esystem:bootstrappers:kubeadm:default-node-token\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etoken:\u003c/span\u003e \u003cspan class=\"string\"\u003eabcdef.0123456789abcdef\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ettl:\u003c/span\u003e \u003cspan class=\"string\"\u003e24h0m0s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eusages:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003esigning\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003eauthentication\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eInitConfiguration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003elocalAPIEndpoint:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eadvertiseAddress:\u003c/span\u003e \u003cspan class=\"string\"\u003exxx.xxx.xxx.xxx\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 指定本机的ip地址用于advertise\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ebindPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e6443\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003enodeRegistration:\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ekubeletExtraArgs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003enode-ip:\u003c/span\u003e \u003cspan class=\"string\"\u003exxx.xxx.xxx.xxx\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 指定本机的ip地址,用于kubelet向master注册,同advertiseAddress\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecriSocket:\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/run/dockershim.sock\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eimagePullPolicy:\u003c/span\u003e \u003cspan class=\"string\"\u003eIfNotPresent\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003emaster-1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etaints:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eeffect:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;NoSchedule\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ekey:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;node-role.kubernetes.io/master\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubeadm.k8s.io/v1beta3\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ecertificatesDir:\u003c/span\u003e \u003cspan class=\"string\"\u003e/etc/kubernetes/pki\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eclusterName:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003econtrollerManager:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003edns:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eetcd:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003elocal:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edataDir:\u003c/span\u003e \u003cspan class=\"string\"\u003e/mnt/nvme0/etcd\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eimageRepository:\u003c/span\u003e \u003cspan class=\"string\"\u003eharbor.local/k8s\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eClusterConfiguration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekubernetesVersion:\u003c/span\u003e \u003cspan class=\"number\"\u003e1.22\u003c/span\u003e\u003cspan class=\"number\"\u003e.13\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003econtrolPlaneEndpoint:\u003c/span\u003e \u003cspan class=\"string\"\u003exxx.xxx.xxx.xxx:6443\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiServer:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eextraArgs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eauthorization-mode:\u003c/span\u003e \u003cspan class=\"string\"\u003eNode,RBAC\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etimeoutForControlPlane:\u003c/span\u003e \u003cspan class=\"string\"\u003e4m0s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecertSANs:\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003edomain.xxx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003evip.k8s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003enodelist-xxx\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003enetworking:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ednsDomain:\u003c/span\u003e \u003cspan class=\"string\"\u003ecluster.local\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eserviceSubnet:\u003c/span\u003e \u003cspan class=\"number\"\u003e10.96\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"string\"\u003e/12\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003epodSubnet:\u003c/span\u003e \u003cspan class=\"number\"\u003e10.244\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"string\"\u003e/16\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003escheduler:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubelet.config.k8s.io/v1beta1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eauthentication:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eanonymous:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eenabled:\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ewebhook:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ecacheTTL:\u003c/span\u003e \u003cspan class=\"string\"\u003e30s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eenabled:\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ex509:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003eclientCAFile:\u003c/span\u003e \u003cspan class=\"string\"\u003e/etc/kubernetes/pki/ca.crt\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eauthorization:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003emode:\u003c/span\u003e \u003cspan class=\"string\"\u003eWebhook\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ewebhook:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ecacheAuthorizedTTL:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ecacheUnauthorizedTTL:\u003c/span\u003e \u003cspan class=\"string\"\u003e10s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eclusterDNS:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"number\"\u003e10.96\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.10\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eclusterDomain:\u003c/span\u003e \u003cspan class=\"string\"\u003ecluster.local\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ehealthzBindAddress:\u003c/span\u003e \u003cspan class=\"number\"\u003e127.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.0\u003c/span\u003e\u003cspan class=\"number\"\u003e.1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ehealthzPort:\u003c/span\u003e \u003cspan class=\"number\"\u003e10248\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eKubeletConfiguration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ecgroupDriver:\u003c/span\u003e \u003cspan class=\"string\"\u003esystemd\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003efailSwapOn:\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emaxPods:\u003c/span\u003e \u003cspan class=\"number\"\u003e250\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003erotateCertificates:\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003estaticPodPath:\u003c/span\u003e \u003cspan class=\"string\"\u003e/etc/kubernetes/manifests\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003esystemReserved:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecpu:\u003c/span\u003e \u003cspan class=\"string\"\u003e1000m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ememory:\u003c/span\u003e \u003cspan class=\"string\"\u003e2Gi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekubeReserved:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ecpu:\u003c/span\u003e \u003cspan class=\"string\"\u003e1000m\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ememory:\u003c/span\u003e \u003cspan class=\"string\"\u003e2Gi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eevictionHard:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eimagefs.available:\u003c/span\u003e \u003cspan class=\"number\"\u003e10\u003c/span\u003e\u003cspan class=\"string\"\u003e%\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ememory.available:\u003c/span\u003e \u003cspan class=\"string\"\u003e2Gi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003enodefs.available:\u003c/span\u003e \u003cspan class=\"number\"\u003e5\u003c/span\u003e\u003cspan class=\"string\"\u003e%\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eapiVersion:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubeproxy.config.k8s.io/v1alpha1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ekind:\u003c/span\u003e \u003cspan class=\"string\"\u003eKubeProxyConfiguration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emode:\u003c/span\u003e \u003cspan class=\"string\"\u003eipvs\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 说明\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 使用kubeadm-kubeproxy-free.conf做为集群的初始化配置文件, 注意修改如下参数:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 1. InitConfiguration: \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   a. localAPIEndpoint\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   b. name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 2. ClusterConfiguration(在集群中存在于Kube-system为configmap： kubeadm-config): \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   a. etcd的存储路劲\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   b. imageRepository的路径\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   c. controlPlaneEndpoint的地址，这里使用了kube-vip提供的高可用ip \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#   d. certSANs，这里需要加上所有的master的节点ip及主机名，以及集群的域名\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e集群初始化\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ekubeadm init --upload-certs --config kubeadm-kubeproxy-free.conf --skip-phases=addon/kube-proxy --apiserver-advertise-address xxx.xxx.xxx.xxx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# --skip-phases=addon/kube-proxy 不安装kube-proxy组件\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# --apiserver-advertise-address 指定需要绑定的ip，在机器有多网卡的时候用\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"cilium安装\"\u003e\u003ca href=\"#cilium安装\" class=\"headerlink\" title=\"cilium安装\"\u003e\u003c/a\u003ecilium安装\u003c/h3\u003e\u003cp\u003eCilium在kubernetes安装有2种运行模式，一种是完全替换kube-proxy, 如果底层 Linux 内核版本低，可以替换kube-proxy的部分功能，与原来的kube-proxy 共存。因此这里要注意kubeProxyReplacement参数,从官网上查看有如下几个选项:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003ekubeProxyReplacement=strict: 该选项期望使用无kube-proxy的Kubernetes设置，其中Cilium有望完全替代所有kube-proxy功能。 Cilium代理启动并运行后，将负责处理类型为ClusterIP，NodePort，ExternalIP和LoadBalancer的Kubernetes服务。如果不满足基本内核版本要求（请参阅不带kube-proxy注释的Kubernetes），则Cilium代理将在启动时退出并显示一条错误消息。\u003c/li\u003e\n\u003cli\u003ekubeProxyReplacement=probe: 此选项适用于混合设置，即kube-proxy在Kubernetes集群中运行，其中Cilium部分替换并优化了kube-proxy功能。一旦Cilium agent启动并运行，它就会在基础内核中探查所需BPF内核功能的可用性，如果不存在，则依靠kube-proxy补充其余的Kubernetes服务处理，从而禁用BPF中的部分功能。在这种情况下，Cilium代理将向其日志中发送一条信息消息。例如，如果内核不支持 Host-Reachable Services，则节点的主机名空间的ClusterIP转换是通过kube-proxy的iptables规则完成的。\u003c/li\u003e\n\u003cli\u003ekubeProxyReplacement=partial: 与探针类似，此选项用于混合设置，即kube-proxy在Kubernetes集群中运行，其中Cilium部分替换并优化了kube-proxy功能。与探查基础内核中可用的BPF功能并在缺少内核支持时自动禁用负责BPF kube-proxy替换的组件的探针相反，该部分选项要求用户手动指定应替换BPF kube-proxy的组件。与严格模式类似，如果不满足基本内核要求，则Cilium代理将在启动时通过错误消息进行援助。对于细粒度的配置，可以将global.hostServices.enabled，global.nodePort.enabled和global.externalIPs.enabled设置为true。默认情况下，所有三个选项均设置为false。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e由于k8s集群是全新安装，所以这里直接使用\u003cstrong\u003ekubeProxyReplacement=strict\u003c/strong\u003e, 使用helm安装, cilium 版本 v1.12.0\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ehelm install cilium cilium/cilium --version 1.12.0 --namespace kube-system --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e kubeProxyReplacement=strict --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e k8sServiceHost=xxx.xxx.xxx.xxx --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e k8sservicePort=6443 --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e ipam.Operator.clusterPoolIPv4PodCIDRList=10.244.0.0/16 --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e enable-bpf-masquerade=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e ipam.Operator.ClusterPoolIPv4MaskSize=24 --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e devices=ens192 --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Relay.Enabled=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Ui.Enabled=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e prometheus.Enabled=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e operator.Prometheus.Enabled=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Enabled=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Metrics.Enabled=\u003cspan class=\"string\"\u003e\u0026#34;{dns, drop, tcp, flow, port-distribution, icmp, http}\u0026#34;\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e image.UseDigest=\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e operator.image.useDigest=\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e operator.Image.Repository=harbor.io/k8s/cilium/operator --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e image.Repository=harbor.io/k8s/cilium/cilium --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Rela y.Image.UseDigest=\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Relay.Image.Repository=harbor.io/k8s/cilium/hubble-relay --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.ui.Backend.Image.Repository=harbor.io/k8s/cilium/hubble-ui-backend --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.Ui.Backend.Image.Tag=v0.9.0 --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.ui.Frontend.Image.Repository=harbor.io/k8s/cilium/hubble-ui --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e hubble.ui.Frontend.Image.Tag=v0.9.0\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e其中:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003ekubeProxyReplacement: cilium在哪种方式下运行，上文已进行了解释, 这里选择kube-proxy-free模式\u003c/li\u003e\n\u003cli\u003ek8sServiceHost: k8s集群的地址,如果是集群，则一般填写负载均衡地址(vip地址)\u003c/li\u003e\n\u003cli\u003ek8sservicePort: k8s集群的端口,如果是集群，则一般填写负载均衡端口(vip端口)\u003c/li\u003e\n\u003cli\u003eipam.Operator.clusterPoolIPv4PodCIDRList: pod的CIDR\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eenable-bpf-masquerade: 是否开启ip的masquerade, 下文解释\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003edevices: 非常重要的参数,下文解释\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003ehubble.xx: 跟hubble相关的参数,能开启的尽量开启hubble吧\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e后续如果需要对配置项进行更新，则可使用以下命令复用之前的配置(\u003ccode\u003e--reuse-values\u003c/code\u003e)，只更新给的配置项即可, 比如将将\u003ccode\u003ehost routing 由 legacy 改成 bpf\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ehelm upgrade cilium --version 1.12.0 --namespace kube-system --reuse-values --\u003cspan class=\"built_in\"\u003eset\u003c/span\u003e --bpf.Masquerade=\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e因为cilium号称可以完全取代kube-proxy, 但也需要支持kube-proxy已存在的场景，所以cilium会自动根据情况进行设置，还是比较人性化的\u003c/p\u003e\n\u003cp\u003e默认情况下cilium是使用kubernetes CRD-based来进行状态管理的，当然也支持使用外部的key-value数据库来存储状态, 一般情况下都会使用默认方式\u003c/p\u003e\n\u003cp\u003e这里要特别注意的参数做如下解释:\u003c/p\u003e\n\u003ch4 id=\"enable-bpf-masquerade\"\u003e\u003ca href=\"#enable-bpf-masquerade\" class=\"headerlink\" title=\"enable-bpf-masquerade\"\u003e\u003c/a\u003eenable-bpf-masquerade\u003c/h4\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.cilium.io/en/stable/network/concepts/masquerading/\"\u003eMasquerading \u0026amp;mdash; Cilium 1.13.3 documentation\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e是否开启bpf的封装, 一张图应该很容易看明白\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20230603173157.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e当在容器内部即访问外部资源时，如何让回来的流量可以再沿着出去的路径，kube-proxy的场景下是基于iptables实现，\u003c/p\u003e\n\u003cp\u003e而bpf比iptables高效的多, 它需要Linux内核4.19+的版本上才支持\u003c/p\u003e\n\u003cp\u003e当然，它需要devices参数的配合，即能访问外部资源所在的网卡必须在devices列表里\u003c/p\u003e\n\u003cp\u003ecilium还能容器哪些CIDR不被封装\u003c/p\u003e\n\u003ch4 id=\"devices\"\u003e\u003ca href=\"#devices\" class=\"headerlink\" title=\"devices\"\u003e\u003c/a\u003edevices\u003c/h4\u003e\u003cp\u003e如果k8s节点存在多张网卡，如果网卡层面上做了网络隔离的话，那么在指定devices就需要注意了\u003c/p\u003e\n\u003cp\u003e举个生产遇到的例子:\u003c/p\u003e\n\u003cp\u003e节点上有eth0, eth1, 在部署k8s集群时，如果没有指定网口名，则会选择默认的网口名或者是kubeadm挑出的第一个网卡名，但有时候不一定能选中我们期望的，因此建议最好是使用–apiserver-advertise-address来显式地指定需要绑定的IP地址(networ interface)，但是只能指定一个，比如指定eth0, 这样在集群中启动的容器会有一个eth0 ip, bind node eth0, 它想要访问集群外的资源，最终都会通过node eth0这个网口出入(可能做了masquerade也可能不做)\u003c/p\u003e\n\u003cp\u003e但有些集群外的资源只能通过eth1这个网段才能访问，这个时候容器里的网络就是不通的, 怎么办？\u003c/p\u003e\n\u003cp\u003e如果放在以前，那么可能会通过折腾multi-CNI的方式将eth0/eth1这两块网卡都映射进容器，即在容器里会同时看到两个ip地址，跟宿主机一样，这样的话，网络上就能通了，\u003c/p\u003e\n\u003cp\u003e但事实上这种实现方式还是有些复杂，成本较高，\u003c/p\u003e\n\u003cp\u003e放在cilium可就方便多了，直接devices列表里指定多个网卡即可实现上述能力，\u003c/p\u003e\n\u003cp\u003edevices参数的作用是: \u003cstrong\u003e当请求从容器到达节点时，允许从node的哪些network interface出去\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e指定多个network interface后, 容器里还是只有一个eth0，但是cilium会自行判断应该从哪个interface出入，是不是简单、清爽了很多. 在网络复杂的情况下，devices参数还是非常有用的\u003c/p\u003e\n\u003ch3 id=\"查看状态\"\u003e\u003ca href=\"#查看状态\" class=\"headerlink\" title=\"查看状态\"\u003e\u003c/a\u003e查看状态\u003c/h3\u003e\u003cp\u003e可以单独使用cilium-cli工具查看\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecilium status --\u003cspan class=\"built_in\"\u003ewait\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   /¯¯\\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e/¯¯\\__/¯¯\\    Cilium:         OK\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\\__/¯¯\\__/    Operator:       OK\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e/¯¯\\__/¯¯\\    Hubble:         disabled\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\\__/¯¯\\__/    ClusterMesh:    disabled\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   \\__/\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDaemonSet         cilium             Desired: 2, Ready: 2/2, Available: 2/2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDeployment        cilium-operator    Desired: 2, Ready: 2/2, Available: 2/2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContainers:       cilium-operator    Running: 2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                  cilium             Running: 2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eImage versions    cilium             quay.io/cilium/cilium:v1.9.5: 2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                  cilium-operator    quay.io/cilium/operator-generic:v1.9.5: 2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003ecilium-cli看到的是一些大面的信息，也可以通过cilium-agent查看，会列出一些详细信息\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# kubectl exec -it -n kube-system cilium-8wvvp -- cilium status\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDefaulted container \u003cspan class=\"string\"\u003e\u0026#34;cilium-agent\u0026#34;\u003c/span\u003e out of: cilium-agent, mount-cgroup (init), wait-for-node-init (init), clean-cilium-state (init)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eKVStor:                 Ok   Disabled\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eKubernetes:             Ok   1.24 (v1.24.0) [linux/amd64]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eKubernetes APIs:        [\u003cspan class=\"string\"\u003e\u0026#34;cilium/v2::CiliumClusterwideNetworkPolicy\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;cilium/v2::CiliumEgressNATPolicy\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;cilium/v2::CiliumLocalRedirectPolicy\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;cilium/v2::CiliumNetworkPolicy\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;cilium/v2::CiliumNode\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;cilium/v2alpha1::CiliumEndpointSlice\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;core/v1::Namespace\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;core/v1::Node\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;core/v1::Pods\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;core/v1::Service\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;discovery/v1::EndpointSlice\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;networking.k8s.io/v1::NetworkPolicy\u0026#34;\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eKubeProxyReplacement:   Strict   [eth0 172.16.127.45 (Direct Routing)]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eHost firewall:          Disabled\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCilium:                 Ok   1.11.4 (v1.11.4-9d25463)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNodeMonitor:            Disabled\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCilium health daemon:   Ok   \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eIPAM:                   IPv4: 4/254 allocated from 10.244.0.0/24, \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eAllocated addresses:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  10.244.0.105 (kube-system/coredns-6d4b75cb6d-wjk9p)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  10.244.0.146 (kube-system/coredns-6d4b75cb6d-956sh)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  10.244.0.225 (router)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  10.244.0.239 (health)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBandwidthManager:       EDT with BPF   [eth0]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eHost Routing:           BPF\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMasquerading:           BPF   [eth0]   10.244.0.0/16 [IPv4: Enabled, IPv6: Disabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eClock Source \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e BPF:   ktime\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eController Status:      30/30 healthy\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  Name                                  Last success   Last error   Count   Message\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  bpf-map-sync-cilium_ipcache           1s ago         34m13s ago   0       no error   \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ...省略\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003ecilium status --verbose\u003c/code\u003e可以显示更多的信息，在debug时很有用.\u003c/p\u003e\n\u003cp\u003e使用cilium后，再来查看\u003ccode\u003eiptables-save | grep KUBE-SVC\u003c/code\u003e, 干净的很了, \u003ccode\u003eipvsadm -ln\u003c/code\u003e也一目了然\u003c/p\u003e\n\u003cp\u003ecilium在线上集群跑了快一年了，还没有碰到过pod之间访问的奇葩网络问题, 爽.\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.cilium.io/en/v1.12/\"\u003ehttps://docs.cilium.io/en/v1.12/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2023/04/01/cilium-on-kubernetes-introduction/\"\u003ehttps://izsk.me/2023/04/01/cilium-on-kubernetes-introduction/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://juejin.cn/post/7208048755122339898\"\u003e使用Cilium 完全替换kube-proxy - 掘金\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2023-06-03T11:30:53+08:00",
  "Author": "Z.S.K."
}