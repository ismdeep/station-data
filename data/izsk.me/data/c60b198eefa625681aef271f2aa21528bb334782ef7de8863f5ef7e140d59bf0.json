{
  "Source": "izsk.me",
  "Title": "iptables学习一(iptables介绍)",
  "Link": "https://izsk.me/2017/10/12/iptables%E5%AD%A6%E4%B9%A0%E4%B8%80(iptables%E4%BB%8B%E7%BB%8D)/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e我们说linux系统下的大都指的是iptables,但事实是iptables只是一个用户层命令行工具,真正实现防火墙功能的是内核层的netfilter,我们可以不必区分这两者的区别,大多数情况下我们只对iptables进行操作,由iptables操作netfilter.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003enetfilet/iptables可做为主机防火墙,也可做为网络防火墙.\u003c/p\u003e\n\u003cp\u003e作用于主机防火墙则是针对单个主机的,网络防火墙则是针对该网络后的所有服务器集体,例如负载均衡、网关设备上\u003c/p\u003e\n\u003cp\u003e首先,盗用\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.zsythink.net/archives/1199\"\u003e一张图\u003c/a\u003e,我们先看看数据包在主机里的流向(假设已开启iptables).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://zskgithubblog.oss-cn-beijing.aliyuncs.com/blogpic/iptables2.JPG\" alt=\"iptables2\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"数据包流向\"\u003e\u003ca href=\"#数据包流向\" class=\"headerlink\" title=\"数据包流向\"\u003e\u003c/a\u003e\u003cstrong\u003e数据包流向\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003e一个数据包进入网卡时,它首先进入PREROUTING链,内核根据数据包目的IP判断是否需要转发出去.\u003c/li\u003e\n\u003cli\u003e如果数据包就是进入本机的,它就会沿着图向下移动,到达INPUT链.数据包到了INPUT链后,任何进程都会收到它.根据数据包中的目的端口号来决定具体由哪个进程处理,本机上运行的程序可以发送数据包,这些数据包会经 过OUTPUT链,然后到达POSTROUTING链输出.\u003c/li\u003e\n\u003cli\u003e如果数据包是要转发出去的,且内核允许转发,数据包就会如图所示向右移动,经过 FORWARD链,然后到达POSTROUTING链输出转发至其它主机\u003c/li\u003e\n\u003cli\u003e由本机出去的数据包经OUTPUT转到POSTROUTING\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e简言之:\u003c/p\u003e\n\u003cp\u003e**经过本机的数据包: PREROUTING —-\u0026gt; IPNUT —-\u0026gt; OUTPUT —-\u0026gt; POSTROUTING **\u003c/p\u003e\n\u003cp\u003e**经本机转发的数据包: PREROUTING —-\u0026gt; FORWARD —-\u0026gt; POSTROUTING **\u003c/p\u003e\n\u003cp\u003e**由本机出去的数据包: OUTPUT —-\u0026gt; POSTROUTING **\u003c/p\u003e\n\u003ch3 id=\"四表五链\"\u003e\u003ca href=\"#四表五链\" class=\"headerlink\" title=\"四表五链\"\u003e\u003c/a\u003e\u003cstrong\u003e四表五链\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e那上面的那些红色标注的是什么呢,还有大家常说的四表五链又到底什么意思?\u003c/p\u003e\n\u003ch4 id=\"规则\"\u003e\u003ca href=\"#规则\" class=\"headerlink\" title=\"规则\"\u003e\u003c/a\u003e\u003cstrong\u003e规则\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e\u003cstrong\u003e规则\u003c/strong\u003e(rules)其实就是网络管理员预定义的条件,规则一般的定义为“如果数据包头符合这样的条件,就这样处理这个数据包”.规则存储在内核空间的信息包过滤表中,这些规则分别指定了源地址、目的地址、传输协议(如TCP、UDP、ICMP)和服务类型(如HTTP、FTP和SMTP)等.当数据包与规则匹配时,iptables就根据规则所定义的方法来处理这些数据包,如放行(accept)、拒绝(reject)和丢弃(drop)等.配置防火墙的主要工作就是添加、修改和删除这些规则.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e总结之: 规则就是规定哪些数据可以通过/直接丢弃,哪些数据包需要转发,哪些数据包需要由本机处理,所有的规则一条一条按顺序去匹配直到匹配上,如果到最后一条规则执行完之后都匹配不上则使用默认规则.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e要说清楚四表五链,再盗\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.liuliqiang.info/post/dive-in-iptables/\"\u003e一张图\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://zskgithubblog.oss-cn-beijing.aliyuncs.com/blogpic/iptables1.JPG\" alt=\"iptables1\"/\u003e\u003c/p\u003e\n\u003cp\u003e上图中黄色方框框住的为四表\u003c/p\u003e\n\u003cp\u003e红色框住的为五链\u003c/p\u003e\n\u003ch4 id=\"四表\"\u003e\u003ca href=\"#四表\" class=\"headerlink\" title=\"四表\"\u003e\u003c/a\u003e\u003cstrong\u003e四表\u003c/strong\u003e\u003c/h4\u003e\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003efilter(默认表)\u003cbr/\u003e主要用于过滤数据包,该表根据系统管理员预定义的一组规则过滤符合条件的数据包.对于防火墙而言,主要利用在filter表中指定的规则来实现对数据包的过滤.\u003cstrong\u003eFilter表是默认的表\u003c/strong\u003e,如果没有指定哪个表,iptables 就默认使用filter表来执行所有命令,filter表包含了INPUT链(处理进入的数据包),RORWARD链(处理转发的数据包),OUTPUT链(处理本地生成的数据包)在filter表中只能允许对数据包进行接受,丢弃的操作,而无法对数据包进行更改.\u003c/li\u003e\n\u003cli\u003enat\u003cbr/\u003e主要用于网络地址转换NAT,该表可以实现一对一,一对多,多对多等NAT工作,iptables就是使用该表实现共享上网的,NAT表包含了PREROUTING链(修改即将到来的数据包),POSTROUTING链(修改即将出去的数据包),OUTPUT链(修改路由之前本地生成的数据包).\u003c/li\u003e\n\u003cli\u003emangle\u003cbr/\u003e主要用于对指定数据包进行更改,在内核版本2.4.18后的linux版本中该表包含的链为：INPUT链(处理进入的数据包),RORWARD链(处理转发的数据包),OUTPUT链(处理本地生成的数据包)POSTROUTING链(修改即将出去的数据包),PREROUTING链(修改即将到来的数据包).\u003c/li\u003e\n\u003cli\u003eraw\u003cbr/\u003e只使用在PREROUTING链和OUTPUT链上,因为优先级最高,从而可以对收到的数据包在连接跟踪前进行处理.一但用户使用了RAW表,在 某个链上,RAW表处理完后,将跳过NAT表和 ip_conntrack处理,即不再做地址转换和数据包的链接跟踪处理了.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"五链\"\u003e\u003ca href=\"#五链\" class=\"headerlink\" title=\"五链\"\u003e\u003c/a\u003e\u003cstrong\u003e五链\u003c/strong\u003e\u003c/h4\u003e\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003ePREROUTING: 在对数据包作路由选择之前,应用此链中的规则.\u003c/li\u003e\n\u003cli\u003eFORWARD: 当接收到需要通过防火墙发送给其他地址的数据包(转发)时,应用此链中的规则.\u003c/li\u003e\n\u003cli\u003eINPUT: 当接收到防火墙本机地址的数据包(入站)时,应用此链中的规则.\u003c/li\u003e\n\u003cli\u003eOUTPUT: 当防火墙本机向外发送数据包(出站)时,应用此链中的规则.\u003c/li\u003e\n\u003cli\u003ePOSTROUTING: 在对数据包作路由选择之后,应用此链中的规则.\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e从上面两张图可以看出,四表五链当中,有些链只能存在于特定的表或者说有些表只能包含特定的链\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e一般情况 下,写iptables规则的时候都是以表为入口,这点很重要\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003ePREROUTING 规则可以存在于: raw、mangle、nat\u003c/p\u003e\n\u003cp\u003eINPUT规则可以存在于: mangle、filter\u003c/p\u003e\n\u003cp\u003eFORWARD规则可以存在于: mangle、filter\u003c/p\u003e\n\u003cp\u003eOUTPUT规则可以存在于: raw、filter、mangle、nat\u003c/p\u003e\n\u003cp\u003ePOSTROUTING规则可以存在于:  mangle、nat\u003c/p\u003e\n\u003cp\u003e表中的规则可以被五链使用:\u003c/p\u003e\n\u003cp\u003eraw: PREROUTING、OUTPUT\u003c/p\u003e\n\u003cp\u003emangle: PREROUTING 、INPUT、FORWARD、OUTPUT、POSTROUTING\u003c/p\u003e\n\u003cp\u003enat: PREROUTING、OUTPUT、POSTROUTING\u003c/p\u003e\n\u003cp\u003efilter: INPUT、FORWARD、OUTPUT\u003c/p\u003e\n\u003cp\u003e再次盗用\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.zsythink.net/archives/1199\"\u003e一张图\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://zskgithubblog.oss-cn-beijing.aliyuncs.com/blogpic/iptables3.JPG\" alt=\"iptables1\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"动作\"\u003e\u003ca href=\"#动作\" class=\"headerlink\" title=\"动作\"\u003e\u003c/a\u003e\u003cstrong\u003e动作\u003c/strong\u003e\u003c/h3\u003e\u003cp\u003e前面我们说了,规则是按顺序一条一条进行匹配直到匹配上,那数据包匹配上了之后如何操作呢？这就是动作.常用的动作有如下几个:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003col\u003e\n\u003cli\u003eDROP: 直接丢弃该数据包,且对端不会有任何提示,对端可能在超时时才会知道\u003c/li\u003e\n\u003cli\u003eACCEPT: 接受数据包\u003c/li\u003e\n\u003cli\u003eREJECT:  拒绝该数据包,会在对端进行提示\u003c/li\u003e\n\u003cli\u003eLOG: 记录该数据包然后把该数据包传递到下一规则链中\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"总结\"\u003e\u003ca href=\"#总结\" class=\"headerlink\" title=\"总结\"\u003e\u003c/a\u003e\u003cstrong\u003e总结\u003c/strong\u003e\u003c/h3\u003e\u003col\u003e\n\u003cli\u003eiptables是处于用户空间的命令行工具,真正实现功能的位于内核空间的netfilter.\u003c/li\u003e\n\u003cli\u003eiptables有四表五链来实现数据包的流转.\u003c/li\u003e\n\u003cli\u003eiptables中的数据包是按规则顺序一条一条匹配的,如果匹配上的话则执行相应的动作,如果到最后一条规则执行完之后都匹配不上,则使用默认规则.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://wiki.archlinux.org/index.php/Iptables\"\u003eiptables-wiki\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.liuliqiang.info/post/dive-in-iptables/\"\u003eiptables 深度详解\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.zsythink.net/archives/1199\"\u003eiptables概念\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\u003chr/\u003e\n\n      \n    \u003c/div\u003e",
  "Date": "2017-10-12T20:12:53+08:00",
  "Author": "Z.S.K."
}