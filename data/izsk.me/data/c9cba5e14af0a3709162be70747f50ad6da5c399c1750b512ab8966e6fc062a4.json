{
  "Source": "izsk.me",
  "Title": "Ansible学习(ansible基础使用)",
  "Link": "https://izsk.me/2019/02/23/ansible-basic-theory/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003eAnsible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#Ansible\"\u003eAnsible\u003c/a\u003e\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#%E5%B7%A5%E4%BD%9C%E6%9E%B6%E6%9E%84\"\u003e工作架构\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8\"\u003e基本使用\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#Playbook/Role\"\u003ePlaybook/Role\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6\"\u003e执行机制\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ccode\u003eAnsible is a radically simple IT automation engine that automates cloud provisioning, configuration management, application deployment, intra-service orchestration, and many other IT needs.\u003c/code\u003e\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003esimple, based on python/jinja\u003c/li\u003e\n\u003cli\u003eno agent, based on ssh(default)\u003c/li\u003e\n\u003cli\u003emodular design\u003c/li\u003e\n\u003cli\u003eidempotency\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"工作架构\"\u003e\u003ca href=\"#工作架构\" class=\"headerlink\" title=\"工作架构\"\u003e\u003c/a\u003e\u003cstrong\u003e工作架构\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191122154626140.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eansible只是一种框架\u003c/code\u003e, 真正执行任务是各种模块:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003econnection plugins：连接插件，负责和被监控端实现通信\u003c/li\u003e\n\u003cli\u003ehost inventory：主机清单，是一个配置文件里面定义监控的主机\u003c/li\u003e\n\u003cli\u003emodules：ansible自身核心模块、自定义模块\u003c/li\u003e\n\u003cli\u003ePlugins：借助于插件完成记录日志邮件等功能\u003c/li\u003e\n\u003cli\u003eplaybook：剧本执行多个任务\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch4 id=\"基本使用\"\u003e\u003ca href=\"#基本使用\" class=\"headerlink\" title=\"基本使用\"\u003e\u003c/a\u003e\u003cstrong\u003e基本使用\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e\u003ccode\u003e在实际使用中, 为了安全一般不会直接在配置中使用明文, 都会提前配置好免密登录.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e常用ansible的执行有以下两种方式(\u003cstrong\u003eansible-galaxy没用过,不讨论\u003c/strong\u003e):\u003c/p\u003e\n\u003ch5 id=\"ad-hoc\"\u003e\u003ca href=\"#ad-hoc\" class=\"headerlink\" title=\"ad-hoc\"\u003e\u003c/a\u003e\u003cstrong\u003ead-hoc\u003c/strong\u003e\u003c/h5\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eansible  [ -i  inventory文件 ]  分组名  -m  模块名  -a \u003cspan class=\"string\"\u003e\u0026#39;模块参数\u0026#39;\u003c/span\u003e  ansible参数\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.ansible.com/ansible/latest/modules/modules_by_category.html\"\u003e官方模块列表\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e示例：\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ecat /etc/ansible/hosts\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[\u003cspan class=\"string\"\u003eall-machines\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.210\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.211\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[\u003cspan class=\"string\"\u003eecho_date\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"number\"\u003e172.16\u003c/span\u003e\u003cspan class=\"number\"\u003e.104\u003c/span\u003e\u003cspan class=\"number\"\u003e.210\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eHosts文件称之为\u003ccode\u003ehost inventory\u003c/code\u003e文件, 该文件指定机器组别.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eansible -i /etc/ansible/hosts echo_date -m shell -a \u0026#39;echo $(ifconfig|grep eth0)\u0026#39;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/image-20191122161721880.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e这里使用了免密登录, 所以可以直接执行, 如果没有免密登录的情况下, 可以在执行时输入密码(由于只能输入一次密码，这种情况要求所有机器上所使用的密码一致)或者直接在主机清单文件中直接指定用户名密码\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003ek8snode-1\u003c/span\u003e \u003cspan class=\"string\"\u003eansible_host=172.16.104.210\u003c/span\u003e \u003cspan class=\"string\"\u003eansible_user=root\u003c/span\u003e \u003cspan class=\"string\"\u003eansible_ssh_pass=\u0026#39;xxxx\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[\u003cspan class=\"string\"\u003eecho_date\u003c/span\u003e]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003ek8snode-1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch5 id=\"playbook\"\u003e\u003ca href=\"#playbook\" class=\"headerlink\" title=\"playbook\"\u003e\u003c/a\u003e\u003cstrong\u003eplaybook\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003e\u003ccode\u003ecat prepare.yaml\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ehosts:\u003c/span\u003e \u003cspan class=\"string\"\u003eecho_date\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"attr\"\u003eroles:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e { \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003ecommon\u003c/span\u003e }\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003eansible-playbook prepare.yml\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eplaybook详见下文\u003c/p\u003e\n\u003ch4 id=\"Playbook-x2F-Role\"\u003e\u003ca href=\"#Playbook-x2F-Role\" class=\"headerlink\" title=\"Playbook/Role\"\u003e\u003c/a\u003e\u003cstrong\u003ePlaybook/Role\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003e\u003ccode\u003ePlaybook及role是ansible为了实现更加复杂的编排任务及更好地组织对象而设定的抽象对象.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003erole主要将整个任务进行封装从而实现复用\u003c/p\u003e\n\u003cp\u003eplaybook则明确定义要完成这个任务需要执行哪些步骤\u003c/p\u003e\n\u003ch5 id=\"一个role的标准目录\"\u003e\u003ca href=\"#一个role的标准目录\" class=\"headerlink\" title=\"一个role的标准目录\"\u003e\u003c/a\u003e\u003cstrong\u003e一个role的\u003ccode\u003e标准目录\u003c/code\u003e\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/unknown-4411877.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e那么在其它有需要执行这个工作的地方则可以直接引用这个角色(或者角色中的部分步骤).\u003c/p\u003e\n\u003cp\u003eplaybook则明确定义了完成这个role需要执行的tasks.\u003c/p\u003e\n\u003ch5 id=\"playbook的样例\"\u003e\u003ca href=\"#playbook的样例\" class=\"headerlink\" title=\"playbook的样例\"\u003e\u003c/a\u003e\u003cstrong\u003eplaybook的样例\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003e\u003ccode\u003ecat roles/common/tasks/main.yml\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;make sure system:public-info-viewer cluster role manifests\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esrc:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edest:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ kube_config_dir }}\u003c/span\u003e/kubernetes-api-system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;enabled kubernetes api /version,/version/ auth\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eshell:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ kubectl }}\u003c/span\u003e apply -f \u003cspan class=\"template-variable\"\u003e{{ kube_config_dir }}\u003c/span\u003e/kubernetes-api-system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"string\"\u003e...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e两个大括号代表的是变量,在执行playbook前由jinja语法进行渲染, 执行时会被真正的value替换.\u003c/p\u003e\n\u003cp\u003e当然,playbook中配合各类module,可以实现更加复杂的逻辑\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.ansible.com/ansible/latest/modules/modules_by_category.html\"\u003e官方模块列表\u003c/a\u003e\u003c/p\u003e\n\u003ch6 id=\"var\"\u003e\u003ca href=\"#var\" class=\"headerlink\" title=\"var\"\u003e\u003c/a\u003e\u003cstrong\u003evar\u003c/strong\u003e\u003c/h6\u003e\u003cp\u003eansible中的变量规则比较灵活, 允许我们在\u003ccode\u003e多处定义同一个变量\u003c/code\u003e, 再根据优先级决定执行时使用哪个变量.\u003c/p\u003e\n\u003cp\u003e常用的有以下几种定义变量方式(\u003ccode\u003e优先级从高到低\u003c/code\u003e):\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003eset_fact/registry_vars\u003c/li\u003e\n\u003cli\u003eroles/vars/main.yml    \u003c/li\u003e\n\u003cli\u003egroup_vars/all.yaml\u003c/li\u003e\n\u003cli\u003eroles/defaults/main.yml\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e其它方式定义的变量优先级参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable\"\u003e官方文档\u003c/a\u003e\u003c/p\u003e\n\u003ch6 id=\"tag\"\u003e\u003ca href=\"#tag\" class=\"headerlink\" title=\"tag\"\u003e\u003c/a\u003e\u003cstrong\u003etag\u003c/strong\u003e\u003c/h6\u003e\u003cp\u003e\u003ccode\u003ecat roles/common/tasks/main.yml\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;make sure system:public-info-viewer cluster role manifests\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etemplate:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003esrc:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003edest:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ kube_config_dir }}\u003c/span\u003e/kubernetes-api-system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;enabled kubernetes api /version,/version/ auth\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eshell:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ kubectl }}\u003c/span\u003e apply -f \u003cspan class=\"template-variable\"\u003e{{ kube_config_dir }}\u003c/span\u003e/kubernetes-api-system-public-info-viewer-cluster-role.yml\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etag:\u003c/span\u003e \u003cspan class=\"string\"\u003eenabled_kubernetes\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e进行引用时可以指定存在tag的是执行还是跳过\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ehosts:\u003c/span\u003e \u003cspan class=\"string\"\u003ekube-master[0]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eroles:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e { \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003ecommon\u003c/span\u003e }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etags:\u003c/span\u003e \u003cspan class=\"string\"\u003eenabled_kubernetes\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eansible中内置4种tag: always、tagged、untagged、all 是四个系统内置的tag，有自己的特殊意义\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003ealways: 指定这个tag 后，task任务将永远被执行，除非明确使用–skip-tags always标记\u003c/li\u003e\n\u003cli\u003etagged: 当 –tags 指定为它时，则只要有tags标记的task都将被执行\u003c/li\u003e\n\u003cli\u003euntagged: 当 –tags 指定为它时，则所有没有tag标记的task 将被执行\u003c/li\u003e\n\u003cli\u003eall: 这个标记无需指定，ansible-playbook 默认执行的时候就是这个标记.所有task都被执行\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e\u003ccode\u003e通过tag机制可以实现执行部分role功能.\u003c/code\u003e\u003c/p\u003e\n\u003ch6 id=\"template\"\u003e\u003ca href=\"#template\" class=\"headerlink\" title=\"template\"\u003e\u003c/a\u003e\u003cstrong\u003etemplate\u003c/strong\u003e\u003c/h6\u003e\u003cp\u003e\u003ccode\u003ecat roles/common/template/docker_auth.j2\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\u003cspan class=\"attr\"\u003e\u0026#34;auths\u0026#34;:\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ docker_registry }}\u003c/span\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"string\"\u003e:\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t\t\u003cspan class=\"attr\"\u003e\u0026#34;auth\u0026#34;:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ docker_auth }}\u003c/span\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t\t}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\t}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003etemplate通过jinja2语法进行渲染, 模块中的变量由参数传递过来, 参数\u003ca href=\"#var\"\u003evar\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003etemplates机制可以让我们把共性的部分固定,将可变的部分由参数传递进模块,实现参数化.\u003c/p\u003e\n\u003ch4 id=\"执行机制\"\u003e\u003ca href=\"#执行机制\" class=\"headerlink\" title=\"执行机制\"\u003e\u003c/a\u003e\u003cstrong\u003e执行机制\u003c/strong\u003e\u003c/h4\u003e\u003cp\u003eansible执行分为同步和异步:\u003c/p\u003e\n\u003ch5 id=\"同步模式\"\u003e\u003ca href=\"#同步模式\" class=\"headerlink\" title=\"同步模式\"\u003e\u003c/a\u003e\u003cstrong\u003e同步模式\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003e也是默认值,\u003ccode\u003e按批执行\u003c/code\u003e, 即\u003ccode\u003e先在一批机器上(取决于fork的数量)执行playbook中第一个任务, 直到这批机器都执行完(默认配置下就算有机器提前执行完也需要等待所有机器都执行完这个任务)之后再在下一批机器执行第一个任务,待该任务在所有的机器上都执行完成之后，然后重新回到第一批机器开始执行playbook的下一个动作,依次循环\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eansible2.0+可指定\u003ccode\u003estrategy=free\u003c/code\u003e 即可让提前完成的机器无需等待同批机器一同完成而快速地让下批机器执行.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e默认情况下的playbook执行过程:\u003c/p\u003e\n\u003cp\u003e从这里也可以看出\u003ccode\u003eplaybook中的task是所有机器都执行完之后再执行下一个task\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/ansible-tasks.jpg\"/\u003e\u003c/p\u003e\n\u003ch5 id=\"异步模式\"\u003e\u003ca href=\"#异步模式\" class=\"headerlink\" title=\"异步模式\"\u003e\u003c/a\u003e\u003cstrong\u003e异步模式\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003eansible直接将机器的任务(取决于fork的数量)放在后台执行, 并每隔一段时间去检查这些节点的执行完成情况(通过job-id),同样直到这批机器都执行完(就算有机器提前执行完也需要等待所有机器执行完),ansible才会将下一批机器放在后台执行. 异步通过\u003ccode\u003easync跟poll\u003c/code\u003e两个参数决定\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e同步跟异步的主要区别就是异步是通过轮询状态来判断任务是否执行成功的.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e特殊地: 如果poll参数被指定为0, 则ansible在将机器的任务放在后台执行后立刻返回, 迅速地在下一批机器开始执行\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e也就是说ansible此时并不会管各机器的任务是否执行成功.\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e通过以上我们知道ansible默认是通过ssh远程登录执行的, 这个时间其实是受ssh的timeout控制, 如果任务的执行时间超过ssh的timeout时间, ssh会被断开, ansible会认为该任务失败.\u003c/p\u003e\n\u003cp\u003e因此, 我们可以直接将任务放到后台执行, 后续定时地去轮询任务执行完成与否. 这样即不受ssh Timeout限制.\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ehost:\u003c/span\u003e \u003cspan class=\"string\"\u003eall\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#strategy: free/linear\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003emax_fail_percentage:\u003c/span\u003e \u003cspan class=\"number\"\u003e30\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#serial指定的节点个数中执行失败的host大于这个百分比,则终止这个任务.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eserial:\u003c/span\u003e \u003cspan class=\"number\"\u003e5\u003c/span\u003e    \u003cspan class=\"comment\"\u003e#指定一次执行多少host\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etasks:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;YUM - async task\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eyum:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003edocker-io\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003estate:\u003c/span\u003e \u003cspan class=\"string\"\u003epresent\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003easync:\u003c/span\u003e \u003cspan class=\"number\"\u003e100\u003c/span\u003e     \u003cspan class=\"comment\"\u003e#参数值代表了这个任务执行时间的上限值。即任务执行所用时间如果超出这个时间，则认为任务失败\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003epoll:\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e        \u003cspan class=\"comment\"\u003e#任务异步执行时轮询的时间间隔,默认为10s,如果为0, 则表示不关心任务执行结果,只将任务推送到机器上执行，然后立即执行下一个任务\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eregister:\u003c/span\u003e \u003cspan class=\"string\"\u003eyum_sleeper\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ename:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;YUM - check on async task\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003easync_status:\u003c/span\u003e   \u003cspan class=\"comment\"\u003e#根据job_id获取任务执行状态\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ejid:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"template-variable\"\u003e{{ yum_sleeper.ansible_job_id }}\u003c/span\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eregister:\u003c/span\u003e \u003cspan class=\"string\"\u003ejob_result\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003euntil:\u003c/span\u003e \u003cspan class=\"string\"\u003ejob_result.finished\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"attr\"\u003eretries:\u003c/span\u003e \u003cspan class=\"number\"\u003e30\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003e--fork指定了同一时刻一个task能在多少个host上执行\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e--serial指定了同一时刻能够有多少个host执行完整个playbook(在strategy=free效果明显)\u003c/code\u003e\u003c/p\u003e\n\u003ch5 id=\"错误处理\"\u003e\u003ca href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"\u003e\u003c/a\u003e\u003cstrong\u003e错误处理\u003c/strong\u003e\u003c/h5\u003e\u003cp\u003e正常情况下, playbook中的任何一个任务失败都将导致整个playbook终止运行, 我们可以使用\u003ccode\u003eignore_errors: true\u003c/code\u003e来忽略这种场景, 即产生了错误也继续执行.\u003c/p\u003e\n\u003cp\u003e同时,也可使用fail/failed_when来捕获错误异常\u003c/p\u003e\n\u003cfigure class=\"highlight shell\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e---\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- hosts: xxx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  remote_user: root\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  tasks:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  - debug:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      msg: \u0026#34;I execute normally\u0026#34;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ignore_errors: true\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  - shell: \u0026#34;echo \u0026#39;This is a string for testing error\u0026#39;\u0026#34;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    register: return_value  #保留命令执行结果.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    failed_when: \u0026#39; \u0026#34;error\u0026#34; in return_value.stdout\u0026#39;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  - debug: \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      msg: \u0026#34;I never execute,Because the playbook has stopped\u0026#34;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e最后的debug不会被执行.因为第2个task failed了.\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://docs.ansible.com/ansible/latest/modules_by_category.html\"\u003ehttp://docs.ansible.com/ansible/latest/modules_by_category.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-02-23T20:10:53+08:00",
  "Author": "Z.S.K."
}