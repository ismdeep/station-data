{
  "Source": "izsk.me",
  "Title": "FELK学习(elastalert自定义邮件模板)",
  "Link": "https://izsk.me/2020/05/28/EFLK-elastalert-mail/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003eelastalert是专门为elastsearch开源的日志关键字监控工具, 支持非常多的告警方式且自定义程度很高, 代码写的也非常清晰, 最近调研了这个开源库进行了二次开发, 用在了业务日志关键字监控上,还是很不错的.这里站在用户使用的角度对邮件告警进行了改造, 期间踩了不少坑.\u003c/p\u003e\n\u003cp\u003e下次会记录一下常见的监控\u003ccode\u003erule\u003c/code\u003e类型及接入微信告警的方式.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"安装\"\u003e\u003ca href=\"#安装\" class=\"headerlink\" title=\"安装\"\u003e\u003c/a\u003e安装\u003c/h3\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003epip3 install elastalert\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"启动\"\u003e\u003ca href=\"#启动\" class=\"headerlink\" title=\"启动\"\u003e\u003c/a\u003e启动\u003c/h3\u003e\u003ch4 id=\"物理机\"\u003e\u003ca href=\"#物理机\" class=\"headerlink\" title=\"物理机\"\u003e\u003c/a\u003e物理机\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e/usr/bin/python -m elastalert.elastalert --rule /etc/elastalert/rules/my_rule.yaml --verbose\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"容器\"\u003e\u003ca href=\"#容器\" class=\"headerlink\" title=\"容器\"\u003e\u003c/a\u003e容器\u003c/h4\u003e\u003cp\u003e官方给出的docker启动方式, 但比较粗糙, 不建议, 建议直接运行在k8s中.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003egit \u003cspan class=\"built_in\"\u003eclone\u003c/span\u003e https://github.com/bitsensor/elastalert.git; \u003cspan class=\"built_in\"\u003ecd\u003c/span\u003e elastalert\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edocker run -d -p 3030:3030 \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    -v `\u003cspan class=\"built_in\"\u003epwd\u003c/span\u003e`/config/elastalert.yaml:/opt/elastalert/config.yaml \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    -v `\u003cspan class=\"built_in\"\u003epwd\u003c/span\u003e`/config/config.json:/opt/elastalert-server/config/config.json \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    -v `\u003cspan class=\"built_in\"\u003epwd\u003c/span\u003e`/rules:/opt/elastalert/rules \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    -v `\u003cspan class=\"built_in\"\u003epwd\u003c/span\u003e`/rule_templates:/opt/elastalert/rule_templates \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    --net=\u003cspan class=\"string\"\u003e\u0026#34;host\u0026#34;\u003c/span\u003e \\\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    --name elastalert bitsensor/elastalert:latest\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"k8s\"\u003e\u003ca href=\"#k8s\" class=\"headerlink\" title=\"k8s\"\u003e\u003c/a\u003ek8s\u003c/h4\u003e\u003cp\u003e这里推荐一个在elastalert的基础上集成restfulapi接口的库, \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/nsano-rururu/elastalert-server\"\u003eelastalert-server\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e直接支持最新的\u003ccode\u003epython3.8+elastalert2.0.4\u003c/code\u003e, 可通过http 接口进行\u003ccode\u003eCURD\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"创建索引\"\u003e\u003ca href=\"#创建索引\" class=\"headerlink\" title=\"创建索引\"\u003e\u003c/a\u003e创建索引\u003c/h3\u003e\u003cp\u003eelastalert在启动时会自动创建相关索引，当然也可事先使用\u003ccode\u003eelastalert-create-index\u003c/code\u003e提示创建索引\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eroot@python-debug-5fdd9d9cd5-fkfkh:/usr/local/lib/python3.5\u003cspan class=\"comment\"\u003e# elastalert-create-index\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eEnter Elasticsearch host: 127.0.0.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eEnter Elasticsearch port: 9200\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUse SSL? t/f: f\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eEnter optional basic-auth username (or leave blank): \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eEnter optional basic-auth password (or leave blank): \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eEnter optional Elasticsearch URL prefix (prepends a string to the URL of every request): \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNew index name? (Default elastalert_status) realtysense.elastalert_status\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNew \u003cspan class=\"built_in\"\u003ealias\u003c/span\u003e name? (Default elastalert_alerts) realtysense.elastalert_status\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eName of existing index to copy? (Default None) \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eElastic Version: 5.4.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading Elastic 5 index mappings:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading index mapping \u003cspan class=\"string\"\u003e\u0026#39;es_mappings/5/silence.json\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading index mapping \u003cspan class=\"string\"\u003e\u0026#39;es_mappings/5/elastalert_status.json\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading index mapping \u003cspan class=\"string\"\u003e\u0026#39;es_mappings/5/elastalert.json\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading index mapping \u003cspan class=\"string\"\u003e\u0026#39;es_mappings/5/past_elastalert.json\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading index mapping \u003cspan class=\"string\"\u003e\u0026#39;es_mappings/5/elastalert_error.json\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNew index realtysense.elastalert_status created\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDone!\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e上述的5个索引主要用于保存elastalert运行期间的相关数据, 会直接写回到es中, 主要用于计算比如聚合,发现日志关键字时的日志现场等,同时也会记录elastalert本身的数据.\u003c/p\u003e\n\u003ch3 id=\"配置热更新\"\u003e\u003ca href=\"#配置热更新\" class=\"headerlink\" title=\"配置热更新\"\u003e\u003c/a\u003e配置热更新\u003c/h3\u003e\u003cp\u003eelastalert代码中使用apscheduler库定时检查rule文件的hash值，在运行周期到达时会比对rules的hash值是否有变化从而修改apscheduler的modify_job来实现热更新\u003c/p\u003e\n\u003cfigure class=\"highlight python\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003enew_rule_hashes = self.rules_loader.get_hashes(self.conf, self.args.rule)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"comment\"\u003e# Check each current rule for changes\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e rule_file, hash_value \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e self.rule_hashes.items():\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e rule_file \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e new_rule_hashes:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"comment\"\u003e# Rule file was deleted\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                elastalert_logger.info(\u003cspan class=\"string\"\u003e\u0026#39;Rule file %s not found, stopping rule execution\u0026#39;\u003c/span\u003e % (rule_file))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e rule \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e self.rules:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e rule[\u003cspan class=\"string\"\u003e\u0026#39;rule_file\u0026#39;\u003c/span\u003e] == rule_file:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003ebreak\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003econtinue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                self.scheduler.remove_job(job_id=rule[\u003cspan class=\"string\"\u003e\u0026#39;name\u0026#39;\u003c/span\u003e])\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                self.rules.remove(rule)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003econtinue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e hash_value != new_rule_hashes[rule_file]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"comment\"\u003e# Rule file was changed, reload rule\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                \u003cspan class=\"keyword\"\u003etry\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    new_rule = self.rules_loader.load_configuration(rule_file, self.conf)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e new_rule:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        logging.error(\u003cspan class=\"string\"\u003e\u0026#39;Invalid rule file skipped: %s\u0026#39;\u003c/span\u003e % rule_file)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003econtinue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;is_enabled\u0026#39;\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e new_rule \u003cspan class=\"keyword\"\u003eand\u003c/span\u003e \u003cspan class=\"keyword\"\u003enot\u003c/span\u003e new_rule[\u003cspan class=\"string\"\u003e\u0026#39;is_enabled\u0026#39;\u003c/span\u003e]:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        elastalert_logger.info(\u003cspan class=\"string\"\u003e\u0026#39;Rule file %s is now disabled.\u0026#39;\u003c/span\u003e % (rule_file))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"comment\"\u003e# Remove this rule if it\u0026#39;s been disabled\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        self.rules = [rule \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e rule \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e self.rules \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e rule[\u003cspan class=\"string\"\u003e\u0026#39;rule_file\u0026#39;\u003c/span\u003e] != rule_file]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                        \u003cspan class=\"keyword\"\u003econtinue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e因此如果是rule文件是使用的k8s的configmap进行部署, 则可直接修改configmap，不需要重启.\u003c/p\u003e\n\u003ch3 id=\"告警方式\"\u003e\u003ca href=\"#告警方式\" class=\"headerlink\" title=\"告警方式\"\u003e\u003c/a\u003e告警方式\u003c/h3\u003e\u003cp\u003eelastalert支持非常多的报警方式, 而且官方也支持直接对报警方式进行二次开发，只要实现对应的类即可, 详情\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://elastalert.readthedocs.io/en/latest/ruletypes.html#alerts\"\u003ealerts\u003c/a\u003e, 这里以邮件为例来自定义邮件模板\u003c/p\u003e\n\u003ch3 id=\"自定义邮件格式\"\u003e\u003ca href=\"#自定义邮件格式\" class=\"headerlink\" title=\"自定义邮件格式\"\u003e\u003c/a\u003e自定义邮件格式\u003c/h3\u003e\u003ch4 id=\"邮件subject\"\u003e\u003ca href=\"#邮件subject\" class=\"headerlink\" title=\"邮件subject\"\u003e\u003c/a\u003e邮件subject\u003c/h4\u003e\u003cp\u003e默认的邮件的subject的格式是\u003ccode\u003eElastAlert: index realty contain is invalid\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eindex realty contain is invalid\u003c/code\u003e为rule文件中定义的名字\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ealert_subject: \u003cspan class=\"string\"\u003e\u0026#34;Issue {0} occurred at {1}\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealert_subject_args:  \u003cspan class=\"comment\"\u003e# 这两个参数会被替换到上面两个占位参数中.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- issue.name\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- \u003cspan class=\"string\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里使用的python中的字符串占位替换.类似于\u003ccode\u003e\u0026#34;{}, {}\u0026#34;.format(xxx, yyy)\u003c/code\u003e\u003c/p\u003e\n\u003ch4 id=\"邮件内容\"\u003e\u003ca href=\"#邮件内容\" class=\"headerlink\" title=\"邮件内容\"\u003e\u003c/a\u003e邮件内容\u003c/h4\u003e\u003cp\u003e官方支持的邮件内容是纯文本的，非常不美观， 好在直接在rule文件中使用\u003ccode\u003ealert_text\u003c/code\u003e字段来指定使用的模板,可以使用html格式，同样，使用参数来进行占位替换.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e但这存在一个问题是,每一个rule文件都需要写一大坨的html模板,虽然内容相差无几, 但还是需要根据需要展示的参数的个数来修改html模板, 因此，这里使用固定的html模板样式动态地对参数个数进行支持, 使用到jinja2来做, 最终实现的效果是: 使用者不需要关注模板内容, 直接指定alert_text_args的参数即可\u003c/strong\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ealert:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- \u003cspan class=\"string\"\u003e\u0026#34;email\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eemail_format: html\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealert_text_type: alert_text_only \u003cspan class=\"comment\"\u003e# alert_text_only: 不发送默认模板内容\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealert_subject: \u003cspan class=\"string\"\u003e\u0026#34;IDS Event From {0} Priority: {1}\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealert_subject_args:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- hostname\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- priority\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#alert_text: | # 不需要指定模板，由jinja根据alert_text_args字段动态生成.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#\t\u0026lt;html content\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealert_text_args:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- msg\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- \u003cspan class=\"string\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- \u003cspan class=\"string\"\u003e\u0026#34;@version\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- _id\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- _index\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- _type\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- service_name\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- kubernetes.host \u003cspan class=\"comment\"\u003e# 如果是嵌套的json. 需要用.的方式引用\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- num_hits\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- num_matches\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eemail:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e- \u003cspan class=\"string\"\u003e\u0026#34;\u003ca href=\"/cdn-cgi/l/email-protection\" class=\"__cf_email__\" data-cfemail=\"374d5f5842445f425c52774452594452435e5a521954585a\"\u003e[email protected]\u003c/a\u003e\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e邮件效果如下:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200602165705.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"问题\"\u003e\u003ca href=\"#问题\" class=\"headerlink\" title=\"问题\"\u003e\u003c/a\u003e问题\u003c/h3\u003e\u003col\u003e\n\u003cli\u003e镜像编译时提示以下\u003ccode\u003einvalid syntax\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200526124725.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: python3.7的版本需要jira2.0以上的版本, 默认requirements.txt中指定的jira版本为1.x的版本, 不相容.\u003c/p\u003e\n\u003cp\u003e解决: 升级jira的版本.\u003c/p\u003e\n\u003col start=\"2\"\u003e\n\u003cli\u003e启动时提示 \u003ccode\u003eduplicate rule name\u003c/code\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200526153919.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 由于elastalert是递归的遍历rules规则，如果rules是使用的kubernetes的configmap挂载进来的，最终在rules目录下生成的文件会是下面的这样\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200526154551.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e在..2020_05_26_07_37_04.030814278目录下也会存在一个同名的规则文件, 因此会提示rule 重复.\u003c/p\u003e\n\u003cp\u003e解决: 在elastalert的配置文件中可指定\u003ccode\u003escan_subdirectories: False\u003c/code\u003e即不对rules目录下的子目录进行扫描即可解决.\u003c/p\u003e\n\u003col start=\"3\"\u003e\n\u003cli\u003e发送邮件时出现以下错误:\u003c/li\u003e\n\u003c/ol\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eERROR elastalert-server:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eProcessController:  ERROR:root:Traceback (most recent call last):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/elastalert.py\u0026#34;\u003c/span\u003e, line 1450, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e alert\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e self.send_alert(matches, rule, alert_time=alert_time, retried=retried)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/elastalert.py\u0026#34;\u003c/span\u003e, line 1544, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e send_alert\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    alert.alert(matches)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/alerts.py\u0026#34;\u003c/span\u003e, line 484, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e alert\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    body = self.create_alert_body(matches)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/alerts.py\u0026#34;\u003c/span\u003e, line 291, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e create_alert_body\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    body += str(BasicMatchString(self.rule, match))\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/alerts.py\u0026#34;\u003c/span\u003e, line 171, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e __str__\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    self._add_custom_alert_text()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/opt/elastalert/elastalert/alerts.py\u0026#34;\u003c/span\u003e, line 99, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e _add_custom_alert_text\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    alert_text = alert_text.format(*alert_text_values)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eKeyError: \u003cspan class=\"string\"\u003e\u0026#39;\\n            background-color\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e原因: 由于使用了jinja2的语法, 在hmtl模板文件中会使用大括号来占位, 但是html的style有时也会使用大括号, 不知道为何jinja2错误地把style中的大括号当成是占位参数，从而出现以下错误, 类似下面这种\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u0026lt;style\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  table\u003cspan class=\"comment\"\u003e#t01 tr:nth-child(even) {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     background-color: \u003cspan class=\"comment\"\u003e#eee;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026lt;/style\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e我直接把以下内容删掉后就没问题了,这个有点坑，要注意.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     background-color: \u003cspan class=\"comment\"\u003e#eee;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e }\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"调试\"\u003e\u003ca href=\"#调试\" class=\"headerlink\" title=\"调试\"\u003e\u003c/a\u003e调试\u003c/h3\u003e\u003cp\u003e如果在日志中出现query hits为0的多半原因是因为转换后的es 查询语句查询出来的结果就是为0\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eProcessController:  INFO:elastalert:Queried rule index realty find invalid keyword from 2020-05-27 06:55 UTC to 2020-05-27 07:00 UTC: 0 / 0 hits\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e07:00:51.888Z ERROR elastalert-server:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ProcessController:  INFO:elastalert:Ran index realty find invalid keyword from 2020-05-27 06:55 UTC to 2020-05-27 07:00 UTC: 0 query hits (0 already seen), 0 matches, 0 alerts sent\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e可打开\u003ccode\u003ees_debug_trace\u003c/code\u003e将es查询记录到指定的文件中, 如下:\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl -H \u003cspan class=\"string\"\u003e\u0026#39;Content-Type: application/json\u0026#39;\u003c/span\u003e -XGET \u003cspan class=\"string\"\u003e\u0026#39;http://localhost:9200/demo.demo-*/_search?pretty\u0026amp;_source_include=%2A%2C%40timestamp\u0026amp;ignore_unavailable=true\u0026amp;scroll=30s\u0026amp;size=10\u0026#39;\u003c/span\u003e -d \u003cspan class=\"string\"\u003e\u0026#39;{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;query\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    \u0026#34;bool\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;filter\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;bool\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          \u0026#34;must\u0026#34;: [\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;range\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;@timestamp\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;gt\u0026#34;: \u0026#34;2020-05-27T08:31:43.695209Z\u0026#34;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;lte\u0026#34;: \u0026#34;2020-05-27T08:33:15.189058Z\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            },\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;wildcard\u0026#34;: { # 重点关注这里\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;msg\u0026#34;: \u0026#34;*unaryInterceptor*\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          ]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  },\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;sort\u0026#34;: [\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;@timestamp\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;order\u0026#34;: \u0026#34;asc\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  ]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在这里要注意的是es的语法中, 使用\u003ccode\u003ewildcard\u003c/code\u003e时只能使用小写的字符串, 这是一个坑, 原因可参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2020/05/27/EFK-prombles/\"\u003ezsk-blog\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"使用关键字参数\"\u003e\u003ca href=\"#使用关键字参数\" class=\"headerlink\" title=\"使用关键字参数\"\u003e\u003c/a\u003e使用关键字参数\u003c/h4\u003e\u003cp\u003e除了使用位置参数外，也支持在模板中使用关键字参数, 如下:\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etype:\u003c/span\u003e \u003cspan class=\"string\"\u003eany\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003efilter:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eterm:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003e_type:\u003c/span\u003e \u003cspan class=\"string\"\u003eelastalert_error\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003eindex:\u003c/span\u003e \u003cspan class=\"string\"\u003eelastalert_status\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ealert_subject:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;Error on rule elastalert \u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ealert_text_kw:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     \u003cspan class=\"attr\"\u003edata:\u003c/span\u003e \u003cspan class=\"string\"\u003edata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003ealert_text:\u003c/span\u003e \u003cspan class=\"string\"\u003e|\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    Error elastalert :\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    - {data}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch4 id=\"elastalert-server支持es-debug-trace\"\u003e\u003ca href=\"#elastalert-server支持es-debug-trace\" class=\"headerlink\" title=\"elastalert-server支持es_debug_trace\"\u003e\u003c/a\u003eelastalert-server支持es_debug_trace\u003c/h4\u003e\u003cp\u003e默认的elastalert-server对elastalert参够使用的参数不是很多, 目前只支持\u003ccode\u003e--verbose\u003c/code\u003e跟\u003ccode\u003e--debug\u003c/code\u003e这两个调试参数, 但是elastalert还有一个参数\u003ccode\u003ees_debug_trace\u003c/code\u003e在elastalert-server的配置文件中是不支持的，这对于需要debug es的查询语句时很不方便，需要修改源码支持\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eelastalert-server/src/controllers/process/index.js\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (config.get(\u003cspan class=\"string\"\u003e\u0026#39;es_debug_trace\u0026#39;\u003c/span\u003e) !== undefined \u0026amp;\u0026amp; config.get(\u003cspan class=\"string\"\u003e\u0026#39;es_debug_trace\u0026#39;\u003c/span\u003e) !== \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  logger.info(\u003cspan class=\"string\"\u003e\u0026#39;Setting ElastAlert es_debug_trace mode. Enable logging from Elasticsearch queries as curl command. Queries will be logged to file.\u0026#39;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  startArguments.push(\u003cspan class=\"string\"\u003e\u0026#39;--es_debug_trace\u0026#39;\u003c/span\u003e, config.get(\u003cspan class=\"string\"\u003e\u0026#39;es_debug_trace\u0026#39;\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003eelastalert-server/config/config.json\u003c/code\u003e添加`  “es_debug_trace”: “/tmp/“即可\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/Yelp/elastalert/issues/2690\"\u003ehttps://github.com/Yelp/elastalert/issues/2690\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/nsano-rururu/elastalert-server\"\u003ehttps://github.com/nsano-rururu/elastalert-server\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://chunlife.top/2019/03/27/es%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%E2%80%94%E2%80%94elastalert/\"\u003ehttps://chunlife.top/2019/03/27/es%E5%91%8A%E8%AD%A6%E5%8A%9F%E8%83%BD%E2%80%94%E2%80%94elastalert/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://segmentfault.com/a/1190000017553282\"\u003ehttps://segmentfault.com/a/1190000017553282\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.mamicode.com/info-detail-2269787.html\"\u003ehttp://www.mamicode.com/info-detail-2269787.html\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-05-28T17:30:53+08:00",
  "Author": "Z.S.K."
}