{
  "Source": "izsk.me",
  "Title": "Grafana学习(Loki踩坑记)",
  "Link": "https://izsk.me/2022/05/15/Loki-Prombles/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003egrafana出品的loki日志框架完美地与kubernetes的label理念结合，相对于EFK来说更加轻量级，非常适合不需要日志聚合的场景.目前新上集群考虑都彩loki做为基础工具, 直接在grafana中展示\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e在这里记录下使用Loki踩过的坑, 不定期更新\u003c/strong\u003e\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"LOKI启动时提示-panic-invalid-page-type-11-10\"\u003e\u003ca href=\"#LOKI启动时提示-panic-invalid-page-type-11-10\" class=\"headerlink\" title=\"LOKI启动时提示 panic: invalid page type: 11: 10\"\u003e\u003c/a\u003eLOKI启动时提示 panic: invalid page type: 11: 10\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20220607165538.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 对应的index table文件已经损坏\u003c/p\u003e\n\u003cp\u003e解决: 删除相应的index文件即可解决\u003c/p\u003e\n\u003ch3 id=\"日志的label不对\"\u003e\u003ca href=\"#日志的label不对\" class=\"headerlink\" title=\"日志的label不对\"\u003e\u003c/a\u003e日志的label不对\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20220513132435.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: promtail中的scrape_config存在问题.\u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2022/05/15/Loki-log-with-wrong-labels/\"\u003ehttps://izsk.me/2022/05/15/Loki-log-with-wrong-labels/\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"grafana中开启实时日志时提示Query-error\"\u003e\u003ca href=\"#grafana中开启实时日志时提示Query-error\" class=\"headerlink\" title=\"grafana中开启实时日志时提示Query error\"\u003e\u003c/a\u003egrafana中开启实时日志时提示Query error\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20211102143833.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 官方的解释是Note that live tailing relies on two websocket connections: one between the browser and the Grafana server, and another between the Grafana server and the Loki server. If you run any reverse proxies, please configure them accordingly.\u003c/p\u003e\n\u003cp\u003e也就是说，如果在web与grafana,grafana与loki之间存在如nginx类的proxy,则需要开启websocket特性，洽洽作者的grafana是在nginx后的\u003c/p\u003e\n\u003cp\u003e解决: nginx添加websocket配置,\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.nginx.com/blog/websocket-nginx/\"\u003e详见\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/grafana/blob/b5d8cb25e18fc73f37b3546246363464c9298684/docs/sources/features/datasources/loki.md\"\u003ehttps://github.com/grafana/grafana/blob/b5d8cb25e18fc73f37b3546246363464c9298684/docs/sources/features/datasources/loki.md\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"Loki-file-size-too-small-nerror-creating-index-client\"\u003e\u003ca href=\"#Loki-file-size-too-small-nerror-creating-index-client\" class=\"headerlink\" title=\"Loki: file size too small\\nerror creating index client\"\u003e\u003c/a\u003eLoki: file size too small\\nerror creating index client\u003c/h3\u003e\u003cp\u003e解决: 删除loki的持久化目录下的boltdb-shipper-active/index_18xxx目录 \u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/3219\"\u003ehttps://github.com/grafana/loki/issues/3219\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"protail-context-deadline-exceeded\"\u003e\u003ca href=\"#protail-context-deadline-exceeded\" class=\"headerlink\" title=\"protail: context deadline exceeded\"\u003e\u003c/a\u003eprotail: context deadline exceeded\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210607142742.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: promtail无法连接loki所致\u003c/p\u003e\n\u003ch3 id=\"promtail-cpu使用过高\"\u003e\u003ca href=\"#promtail-cpu使用过高\" class=\"headerlink\" title=\"promtail cpu使用过高\"\u003e\u003c/a\u003epromtail cpu使用过高\u003c/h3\u003e\u003cp\u003e原因: 由于集群中存在大量的job类pod，这会对loki的服务发现会有很大的压力，需要调整promtail的配置，查看官方的issue，后续可能会将ds由promtail转到服务端来做，promtail需要调整的配置主要为\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003etarget_config:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esync_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e30s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003epositions:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003efilename:\u003c/span\u003e \u003cspan class=\"string\"\u003e/run/promtail/positions.yaml\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esync_period:\u003c/span\u003e \u003cspan class=\"string\"\u003e30s\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e将 sync_period由默认的10s换成30s\u003c/p\u003e\n\u003cp\u003e可以使用以下的命令获取到pprof文件分析性能\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl localhost:3100/debug/pprof/profile\\?seconds\\=20\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1315\"\u003ehttps://github.com/grafana/loki/issues/1315\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"Maximum-active-stream-limit-exceeded\"\u003e\u003ca href=\"#Maximum-active-stream-limit-exceeded\" class=\"headerlink\" title=\"Maximum active stream limit exceeded\"\u003e\u003c/a\u003eMaximum active stream limit exceeded\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210312182643.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因： 同下，需要调整limit config中的max_streams_per_user， 设置为0即可\u003c/p\u003e\n\u003ch3 id=\"server-returned-HTTP-status-429-Too-Many-Requests\"\u003e\u003ca href=\"#server-returned-HTTP-status-429-Too-Many-Requests\" class=\"headerlink\" title=\"server returned HTTP status 429 Too Many Requests\"\u003e\u003c/a\u003eserver returned HTTP status 429 Too Many Requests\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210219121747.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: limit config中的参数: \u003ccode\u003eingestion_burst_size \u003c/code\u003e默认值太小，调整即可\u003c/p\u003e\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1923\"\u003ehttps://github.com/grafana/loki/issues/1923\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"Please-verify-permissions\"\u003e\u003ca href=\"#Please-verify-permissions\" class=\"headerlink\" title=\"Please verify permissions\"\u003e\u003c/a\u003ePlease verify permissions\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20201110195022.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 这条其实是warn,不影响promtail的正常工作，如果调整过日志的路径的话要确认promtail挂载的路径是否正常\u003c/p\u003e\n\u003ch3 id=\"loki-invalid-schema-config\"\u003e\u003ca href=\"#loki-invalid-schema-config\" class=\"headerlink\" title=\"loki: invalid schema config\"\u003e\u003c/a\u003eloki: invalid schema config\u003c/h3\u003e\u003cp\u003e原因: loki的配置文件格式错误.\u003c/p\u003e\n\u003ch3 id=\"promtail-too-many-open-files\"\u003e\u003ca href=\"#promtail-too-many-open-files\" class=\"headerlink\" title=\"promtail: too many open files\"\u003e\u003c/a\u003epromtail: too many open files\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200909190248.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: /var/log/pods下面的文件数量太多，导致超过内核参数(fs.inotify.max_user_instances)设置配置.\u003c/p\u003e\n\u003cp\u003e解决：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 先查看当前机器设置的配置\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecat\u003c/span\u003e /proc/sys/fs/inotify/max_user_instances\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 再查看promtail启动时watch的文件数\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecat\u003c/span\u003e /run/promtail/positions.yaml | \u003cspan class=\"built_in\"\u003ewc\u003c/span\u003e -l\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 如果这个值比max_user_instances要大，则会出现上面的错误，可以通过修改内核参数进行调整\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esysctl -w fs.inotify.max_user_instances=1024\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 生效\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esysctl -p\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e参考: \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1153\"\u003ehttps://github.com/grafana/loki/issues/1153\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"promtail-no-such-file-ro-directory\"\u003e\u003ca href=\"#promtail-no-such-file-ro-directory\" class=\"headerlink\" title=\"promtail: no such file ro directory\"\u003e\u003c/a\u003epromtail: no such file ro directory\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200909200457.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因： promtail daemonset启动时会自动挂载好几个hostpath,如果docker containers的配置调整过，则需要volume跟volumemount都需要对应上.\u003c/p\u003e\n\u003ch3 id=\"未完待续\"\u003e\u003ca href=\"#未完待续\" class=\"headerlink\" title=\"未完待续\"\u003e\u003c/a\u003e未完待续\u003c/h3\u003e\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/429\"\u003ehttps://github.com/grafana/loki/issues/429\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/3219\"\u003ehttps://github.com/grafana/loki/issues/3219\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1153\"\u003ehttps://github.com/grafana/loki/issues/1153\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1923\"\u003ehttps://github.com/grafana/loki/issues/1923\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://blog.csdn.net/weixin_44997607/article/details/108419144\"\u003ehttps://blog.csdn.net/weixin_44997607/article/details/108419144\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/1315\"\u003ehttps://github.com/grafana/loki/issues/1315\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.nginx.com/blog/websocket-nginx/\"\u003ehttps://www.nginx.com/blog/websocket-nginx/\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2022-05-15T14:30:53+08:00",
  "Author": "Z.S.K."
}