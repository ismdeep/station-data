{
  "Source": "izsk.me",
  "Title": "Grafana学习(loki日志存在错误的label)",
  "Link": "https://izsk.me/2022/05/15/Loki-log-with-wrong-labels/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e业务中使用的日志架构是基于Loki来搭建的，最近发现了一个很诡异的问题，有些log的label与label之间对应不上，经过一番尝试后虽然解决了问题，但不知道原由。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"集群信息\"\u003e\u003ca href=\"#集群信息\" class=\"headerlink\" title=\"集群信息\"\u003e\u003c/a\u003e集群信息\u003c/h3\u003e\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e软件\u003c/th\u003e\n\u003cth\u003e版本\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003eKubernetes stack\u003c/td\u003e\n\u003ctd\u003ev1.15.9\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eLoki\u003c/td\u003e\n\u003ctd\u003ev2.3.0\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003ePromtail\u003c/td\u003e\n\u003ctd\u003ev2.3.0\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eGrafana\u003c/td\u003e\n\u003ctd\u003eV8.1.6\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003ctd\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e日志路径: log location –\u0026gt; promtail –\u0026gt; loki –\u0026gt; grafana\u003c/p\u003e\n\u003ch3 id=\"k8s日志结构\"\u003e\u003ca href=\"#k8s日志结构\" class=\"headerlink\" title=\"k8s日志结构\"\u003e\u003c/a\u003ek8s日志结构\u003c/h3\u003e\u003cp\u003e先简单了解下k8s集群的日志结构，这样以便引出发现的问题\u003c/p\u003e\n\u003cp\u003e在v1.14之前及之后会有所区别，表现如下: \u003c/p\u003e\n\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003ebefore 1.14\u003c/strong\u003e: \u003ccode\u003e/var/log/pods/\u0026lt;pod_uid\u0026gt;/\u0026lt;container_name\u0026gt;/\u0026lt;num\u0026gt;.log\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e1.14 or later\u003c/strong\u003e: \u003ccode\u003e/var/log/pods/\u0026lt;namespace\u0026gt;_\u0026lt;pod_name\u0026gt;_\u0026lt;pod_uid\u0026gt;/\u0026lt;container_name\u0026gt;/\u0026lt;num\u0026gt;.log\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e详细的解释参考这个\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes/kubernetes/pull/74441\"\u003ePR\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e另外，\u003ccode\u003e\u0026lt;num\u0026gt;.log\u003c/code\u003e中的num代表pod重启的次数,参考这个[pull][\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes/kubernetes/pull/74441/files]%EF%BC%8C\"\u003ehttps://github.com/kubernetes/kubernetes/pull/74441/files]，\u003c/a\u003e 不过对于本文要解决的问题，num不重要.\u003c/p\u003e\n\u003ch3 id=\"问题现象\"\u003e\u003ca href=\"#问题现象\" class=\"headerlink\" title=\"问题现象\"\u003e\u003c/a\u003e问题现象\u003c/h3\u003e\u003cp\u003e通过loki收集到的日志，通过grafana UI查询之后，出现如下问题:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20220513132435.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e从这个图可以看到, \u003cstrong\u003epod跟filename是对应不上的\u003c/strong\u003e, 但从\u003ca href=\"#k8s%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84\"\u003ek8s日志结构\u003c/a\u003e来看, pod名跟filename中的部分是需要对应上的.\u003c/p\u003e\n\u003cp\u003e所以问题是: \u003cstrong\u003e从这个filename采集到的日志是属于这个pod的吗?\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e显然, log的label没有对应上最开始需要check一下是否是配置的问题，由于log的label的都是由promtail进行处理的，因此如果有问题，也只能是promtail配置文件的问题\u003c/p\u003e\n\u003ch3 id=\"Promtail配置\"\u003e\u003ca href=\"#Promtail配置\" class=\"headerlink\" title=\"Promtail配置\"\u003e\u003c/a\u003ePromtail配置\u003c/h3\u003e\u003cp\u003e由于篇幅有限，这里只贴与pod相关的配置进行说明.\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"attr\"\u003escrape_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e# Pods with a label \u0026#39;app\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003ejob_name:\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes-pods-app\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003epipeline_stages:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003edocker:\u003c/span\u003e {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003ekubernetes_sd_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003erole:\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003erelabel_configs:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# 将pod中带有label为app的label重写为app\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_label_app\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003eapp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# 将app为空的值丢弃\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003edrop\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eregex:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003eapp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# 将pod中带有label为component的label重写为component\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_label_component\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003ecomponent\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# prometheus中预定义的label\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_node_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003enode_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# prometheus中预定义的label\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_namespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003enamespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# prometheus中预定义的label\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# prometheus中预定义的label\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_container_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003econtainer\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"comment\"\u003e# 重点是以下部分\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/log/pods/*$1/*.log\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e/\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_uid\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_container_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__path__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003epromtail的配置是使用了kubernetes的serviceDiscovery及prometheus的relabel机制, 这两部分不是本文的重点，感兴趣的可以参考官网说明,这里只说明两点:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e以__开头的变量会在relabel后从label set中删除\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e__path__\u003c/code\u003e 是一个特殊标签,最终\u003ccode\u003e__path__\u003c/code\u003e会变成filename,参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://grafana.com/docs/loki/latest/clients/promtail/scraping\"\u003eloki File Target Discovery\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e由于是pod跟filename对应不上,那就只能是这两部分的relabel有问题，由于\u003ccode\u003e__meta_kubernetes_pod_container_name\u003c/code\u003e为prometheus中预定义的值，出错的可能不大，因此问题概率出在filename, 也就是配置中最下的部分\u003c/p\u003e\n\u003cp\u003e诈一看也没发现在任何问题，loki stack的helm charts也是这么使用的, 翻阅\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/3443\"\u003eloki github issue\u003c/a\u003e也只发现一个相关问题, 但现象不太一样, 被\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/helm-charts/pull/279\"\u003emerge 279\u003c/a\u003e fix了，但是个人对这个issue 的close表示怀疑.\u003c/p\u003e\n\u003cp\u003e不过作者参照这个mege对应的配置也做过尝试，发现确实无法解决作者的问题.\u003c/p\u003e\n\u003cp\u003e经过作者的不斷调整promtail的配置，发现有一种情况居然给解决了\u003c/p\u003e\n\u003ch3 id=\"问题解决\"\u003e\u003ca href=\"#问题解决\" class=\"headerlink\" title=\"问题解决\"\u003e\u003c/a\u003e问题解决\u003c/h3\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"attr\"\u003eaction:\u003c/span\u003e \u003cspan class=\"string\"\u003ereplace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003ereplacement:\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/log/pods/$1/**/*.log\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003eseparator:\u003c/span\u003e \u003cspan class=\"string\"\u003e_\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003esource_labels:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003enamespace\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003epod\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"bullet\"\u003e-\u003c/span\u003e \u003cspan class=\"string\"\u003e__meta_kubernetes_pod_uid\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003etarget_label:\u003c/span\u003e \u003cspan class=\"string\"\u003e__path__\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e由于promtail中使用的对文件的查询是基于一个开源库\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/bmatcuk/doublestar\"\u003edobulestar\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003epod跟filename能正常work后， 作者还是没想明白为何这种配置是work的(作者认为【Promtail配置】中的配置也是没问题)\u003c/p\u003e\n\u003cp\u003e知其然不知其所以然，是真的很痛苦，作者写记录这篇软文也是想给可能有同样困惑的同学提供一种解决方法.\u003c/p\u003e\n\u003cp\u003e作者也在loki github中提了 issue，目前未有反馈，如果有知道原因的同学可以联系作者告知，万分感谢\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/3402\"\u003ehttps://github.com/grafana/loki/issues/3402\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/helm-charts/commit/4c20b59b79d6599ecf7c7caaff169d2901bab80f\"\u003ehttps://github.com/grafana/helm-charts/commit/4c20b59b79d6599ecf7c7caaff169d2901bab80f\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/3443\"\u003ehttps://github.com/grafana/loki/issues/3443\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/helm-charts/pull/202\"\u003ehttps://github.com/grafana/helm-charts/pull/202\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/#regex\"\u003ehttps://grafana.com/blog/2022/03/21/how-relabeling-in-prometheus-works/#regex\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config\"\u003ehttps://prometheus.io/docs/prometheus/latest/configuration/configuration/#scrape_config\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/kubernetes/kubernetes/pull/74441/files\"\u003ehttps://github.com/kubernetes/kubernetes/pull/74441/files\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/bmatcuk/doublestar\"\u003ehttps://github.com/bmatcuk/doublestar\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/grafana/loki/issues/6140\"\u003ehttps://github.com/grafana/loki/issues/6140\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://grafana.com/docs/loki/latest/clients/promtail/scraping\"\u003ehttps://grafana.com/docs/loki/latest/clients/promtail/scraping\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2022-05-15T15:30:53+08:00",
  "Author": "Z.S.K."
}