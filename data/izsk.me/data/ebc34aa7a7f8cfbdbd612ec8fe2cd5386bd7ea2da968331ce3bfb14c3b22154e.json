{
  "Source": "izsk.me",
  "Title": "FELK学习(踩坑记)",
  "Link": "https://izsk.me/2020/05/27/EFK-prombles/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e各种各样的问题大部分都可以为是业务日志不规范的, 当然这个是不可避免的, 规范不是一天建立起来的.\u003c/p\u003e\n\u003cp\u003e在没有建立起来之前, 只能像打补丁一样修复\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e在这里记录下运维EFK踩过的坑, 不定期更新\u003c/strong\u003e\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"日志流\"\u003e\u003ca href=\"#日志流\" class=\"headerlink\" title=\"日志流\"\u003e\u003c/a\u003e日志流\u003c/h3\u003e\u003cp\u003e\u003ccode\u003e[Kubernetes/LB/...] --\u0026gt; fluentd --\u0026gt; kafka --\u0026gt; logstash --\u0026gt; es\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"type不覆盖\"\u003e\u003ca href=\"#type不覆盖\" class=\"headerlink\" title=\"type不覆盖\"\u003e\u003c/a\u003etype不覆盖\u003c/h3\u003e\u003cp\u003e最近就发现存在小部分的日志丢失了, 经过层层debug, 终于发现原来是因为源日志中就存在type这个字段, \u003c/p\u003e\n\u003cp\u003e因为logstash环节一般都会根据业务添加一个type来进行区别, 然后根据不同的type输出到不同的存储，\u003c/p\u003e\n\u003cp\u003e平时很少会关注日志本身的字段, 导致这个问题花了差不多一天的时间定位.\u003c/p\u003e\n\u003cp\u003e如果源日志中就存在有type字段, 而在logstash中又指定了type, 那么这个type不会覆盖源日志中的type(后来想想其实也可以理解, 业务数据为王嘛)\u003c/p\u003e\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.elastic.co/guide/en/logstash/current/plugins-inputs-kafka.html#plugins-inputs-kafka-type\"\u003e官方\u003c/a\u003e有说明, 这个有点巧, 刚好在页面的最下面, 都不怎么会看到\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200416163906.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e因此在output中出现使用type来做为判断条件的那就会被丢弃掉, 因此此时的type是你源日志中的type.\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eoutput \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  if \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003etype\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e == \u003cspan class=\"string\"\u003e\u0026#34;xxx\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    elasticsearch \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e找到问题解决办法也就容易多了, 直接在fluentd上把这个字段进行重命名, 就是add一个字段然后再把type字段remove\u003c/p\u003e\n\u003cfigure class=\"highlight yml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;filter\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.**\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003erecord_transformer\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eenable_ruby\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;record\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003ef_type\u003c/span\u003e \u003cspan class=\"string\"\u003e${record.dig(\u0026#34;type\u0026#34;)}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;/record\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/filter\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;filter\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.**\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003erecord_transformer\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eremove_keys\u003c/span\u003e \u003cspan class=\"string\"\u003etype\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/filter\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003cp\u003e这个问题也反映出本人对logstash用的不是很熟.\u003c/p\u003e\n\u003ch3 id=\"字段类型转换\"\u003e\u003ca href=\"#字段类型转换\" class=\"headerlink\" title=\"字段类型转换\"\u003e\u003c/a\u003e字段类型转换\u003c/h3\u003e\u003cp\u003e由于后端的存储使用的es, es中有个 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.elastic.co/guide/cn/elasticsearch/guide/current/dynamic-mapping.html\"\u003eDynamic Mapping\u003c/a\u003e, 默认情况下是开启状态, 这个特性能够根据文档的字段动态地进行填充, 也就是说新增字段会自动地添加mapping， 但是无法对已经存在的字段进行修改\u003c/p\u003e\n\u003cp\u003e一般情况下, 索引都是按天进行分隔, 也就是在零点的时候会自动生成新的索引，然后这个索引的mapping以第一条进来的文档为准, 假如有个字段, 比如下面的\u003ccode\u003ecall_db_dynamic_response.score\u003c/code\u003e这个field, 这个表示对比的一个得分(代码中的float64),假如第一个文档中的这个\u003ccode\u003escore\u003c/code\u003e为1, 那么这个在es中的类型为\u003ccode\u003elong\u003c/code\u003e类型, 那么就不能改变,\u003c/p\u003e\n\u003cp\u003e但是\u003ccode\u003escore\u003c/code\u003e可能会再传过来\u003ccode\u003e0.99\u003c/code\u003e,那么这个时候就会出现以下报错, 这条数据是无法进入es的,\u003cstrong\u003ees中long与float是不一样的类型\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200416164017.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e那么解决办法, 有以下几种方式:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e直接从源代码中修改, 代码中本身就是float类型, 而且这个值是底层SDK传过来的, 在业务层做判断不是很友好, 毕竟每次都将多一层判断, 影响性能\u003c/li\u003e\n\u003cli\u003e可以在logstash中对改字段进行类型转换\u003c/li\u003e\n\u003cli\u003e在创建索引时使用自定义的template\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这里我采取的是第2种办法， 没有采用第1种办法是因为代码中本身就是float类型, 而且这个值是底层SDK传过来的, 在业务层做判断不是很友好, 毕竟每次都将多一层该值判断, 影响性能，把这个操作移步到日志系统中，毕竟日志系统只是做为一个排查工具, 不需要那么实时\u003c/p\u003e\n\u003cp\u003e在logstash中进行类型转换用到了\u003ccode\u003efilter的mutate\u003c/code\u003e,当然这里最好也对索引做个判断\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eif \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003etag\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e == \u003cspan class=\"string\"\u003e\u0026#34;yourindex\u0026#34;\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  mutate \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    convert =\u0026gt; \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"string\"\u003e\u0026#34;[call_db_dynamic_response][score]\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;float\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这样的话, \u003ccode\u003escore\u003c/code\u003e就永远都是\u003ccode\u003efloat\u003c/code\u003e类型了.\u003c/p\u003e\n\u003cp\u003e这里没有使用自定义的template，理论上这种方法是性能最高的, 因为不需要每条日志都判断一下是否存在这个\u003ccode\u003escore\u003c/code\u003e字段, 不过本人还是觉得第2种方法更容易, 效果还行.\u003c/p\u003e\n\u003ch3 id=\"字段多种类型\"\u003e\u003ca href=\"#字段多种类型\" class=\"headerlink\" title=\"字段多种类型\"\u003e\u003c/a\u003e字段多种类型\u003c/h3\u003e\u003cp\u003e这个报错的原因跟上面的类似, 都是因为es对field的类型不支持多个, 如果是个object，那你就无法把一个值写进去,不然会提示以下错误\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200416164935.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e这个问题曾经引起过一次线上es的启机, 有兴趣的可以看这里的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2019/10/06/ES-FGC-Fix/\"\u003e分析\u003c/a\u003e\u003c/p\u003e\n\u003ch3 id=\"kafka版本不匹配\"\u003e\u003ca href=\"#kafka版本不匹配\" class=\"headerlink\" title=\"kafka版本不匹配\"\u003e\u003c/a\u003ekafka版本不匹配\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200416173539.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e这是本人遇到过的最坑爹的问题\u003c/p\u003e\n\u003cp\u003e由于有个环境需要下线, 在迁移的过程中使用了一个新版本的fluentd, 但是却无法对接这个kafka\u003c/p\u003e\n\u003cp\u003efluentd使用了一个\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/fluent/fluent-plugin-kafka\"\u003efluent-plugin-kafka\u003c/a\u003e, 比较坑的是里面有个ruby_kafka的client, 如果kafka的版本太旧而fluentd的版本又太新的话, 就会造成ruby_kafka_client无法适配旧版的kafka, 折腾半天无果后果断放弃, 由于这个kafka无法直接升级，最后只能重新搭建了一个新版本的kafka, 问题解决\u003c/p\u003e\n\u003ch3 id=\"fluentd的tag\"\u003e\u003ca href=\"#fluentd的tag\" class=\"headerlink\" title=\"fluentd的tag\"\u003e\u003c/a\u003efluentd的tag\u003c/h3\u003e\u003cp\u003e在使用fluentd中大家看fluentd的配置文件,开始的时候一定会对tag的使用有点懵\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;source\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@id\u003c/span\u003e \u003cspan class=\"string\"\u003efluentd-k8s-containers.log\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003etail\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003epath\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/log/containers/*.log\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003epos_file\u003c/span\u003e \u003cspan class=\"string\"\u003e/var/log/fluentd-k8s-containers.log.pos\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003etag\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.*\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;parse\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003emulti_format\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026lt;pattern\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"string\"\u003eformat\u003c/span\u003e \u003cspan class=\"string\"\u003ejson\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"string\"\u003etime_key\u003c/span\u003e \u003cspan class=\"string\"\u003etime\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"string\"\u003etime_format\u003c/span\u003e \u003cspan class=\"string\"\u003e%Y-%m-%dT%H:%M:%S.%NZ\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026lt;/pattern\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;/parse\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/source\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;filter\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.**\u0026gt;\u003c/span\u003e \u003cspan class=\"comment\"\u003e# --\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@id\u003c/span\u003e \u003cspan class=\"string\"\u003efilter_kubernetes_metadata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes_metadata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eskip_labels\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e#skip_container_metadata true\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eskip_master_url\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eskip_namespace_metadata\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/filter\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这是一段收集kubernetes容器日志的经典配置\u003c/p\u003e\n\u003cp\u003e在\u003ccode\u003esource\u003c/code\u003e中使用了\u003ccode\u003etail\u003c/code\u003e指定了\u003ccode\u003epath,tag\u003c/code\u003e, 那么这个时候的tag到底是什么?\u003c/p\u003e\n\u003cp\u003e先看下官方的\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/input/tail#tag\"\u003e说明\u003c/a\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#* can be used as a placeholder that expands to the actual file path, replacing \u0026#39;/\u0026#39; with \u0026#39;.\u0026#39;. For example, if you have the following configuration\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003epath /path/to/file\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etag foo.*\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# in_tail emits the parsed events with the \u0026#39;foo.path.to.file\u0026#39; tag.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e意思就是说, tag是由\u003ccode\u003etag+path\u003c/code\u003e一起组成，如上面, \u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epath=/var/log/containers/*.log\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003etag=kubernetes.*\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e那么在\u003ccode\u003efilter\u003c/code\u003e时使用了\u003ccode\u003ekubernetes.**\u003c/code\u003e来表示匹配所有以\u003ccode\u003ekubernetes开头的tag\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e每一个容器的tag为\u003ccode\u003ekubernetes.var.log.containers.xxxxx.log\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003exxxxx\u003c/code\u003e指/var/log/containers/目录下容器的信息\u003c/p\u003e\n\u003cp\u003e注意:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e.*\u003c/code\u003e跟\u003ccode\u003e.**\u003c/code\u003e是有区别的, 引入官方\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/configuration/config-file\"\u003e文档\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThe following match patterns can be used in \u003ccode\u003eand\u003c/code\u003e tags.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e*\u003c/code\u003e matches a single tag part.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cp\u003eFor example, the pattern \u003ccode\u003ea.*\u003c/code\u003e matches \u003ccode\u003ea.b\u003c/code\u003e, but does not match\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ea\u003c/code\u003e or \u003ccode\u003ea.b.c\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e**\u003c/code\u003e matches zero or more tag parts.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFor example, the pattern \u003ccode\u003ea.**\u003c/code\u003e matches \u003ccode\u003ea\u003c/code\u003e, \u003ccode\u003ea.b\u003c/code\u003e and \u003ccode\u003ea.b.c\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e{X,Y,Z}\u003c/code\u003e matches X, Y, or Z, where X, Y, and Z are match patterns.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eFor example, the pattern \u003ccode\u003e{a,b}\u003c/code\u003e matches \u003ccode\u003ea\u003c/code\u003e and \u003ccode\u003eb\u003c/code\u003e, but does not match \u003ccode\u003ec\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eThis can be used in combination with the \u003ccode\u003e*\u003c/code\u003e or \u003ccode\u003e**\u003c/code\u003e patterns. Examples include \u003ccode\u003ea.{b,c}.*\u003c/code\u003e and \u003ccode\u003ea.{b,c.**}\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003e\u003ccode\u003e#{...}\u003c/code\u003e evaluates the string inside brackets as a Ruby expression (See the section “Embedding Ruby Expressions” below)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cp\u003eWhen multiple patterns are listed inside a single tag (delimited by one or more whitespaces), it matches any of the listed patterns. For example:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe patterns `` match \u003ccode\u003ea\u003c/code\u003e and \u003ccode\u003eb\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThe patterns `` match \u003ccode\u003ea\u003c/code\u003e, \u003ccode\u003ea.b\u003c/code\u003e, \u003ccode\u003ea.b.c\u003c/code\u003e (from the first pattern) and \u003ccode\u003eb.d\u003c/code\u003e (from the second pattern).\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e所以,这个tag还是非常长的, 因此最后都会将tag改成故名知义, 比如改成服务名.\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;match\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.**\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003erewrite_tag_filter\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;rule\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003ekey\u003c/span\u003e \u003cspan class=\"string\"\u003erequest_method\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003epattern\u003c/span\u003e \u003cspan class=\"string\"\u003e/^HEAD$/\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003etag\u003c/span\u003e \u003cspan class=\"string\"\u003eclear\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;/rule\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;rule\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003ekey\u003c/span\u003e \u003cspan class=\"string\"\u003eservice_name\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003epattern\u003c/span\u003e \u003cspan class=\"string\"\u003e^(.+)$\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003etag\u003c/span\u003e \u003cspan class=\"string\"\u003e$1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026lt;/rule\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/match\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"The-connection-might-have-been-closed-Sleeping-for-64-seconds\"\u003e\u003ca href=\"#The-connection-might-have-been-closed-Sleeping-for-64-seconds\" class=\"headerlink\" title=\"The connection might have been closed. Sleeping for 64 seconds\"\u003e\u003c/a\u003eThe connection might have been closed. Sleeping for 64 seconds\u003c/h3\u003e\u003cp\u003e![image-20200519140723710](/Users/zhoushuke/Library/Application Support/typora-user-images/image-20200519140723710.png)\u003c/p\u003e\n\u003cp\u003e原因: 从grafana上来看，fluentd的cpu会出现周期性的突升，同时，在apiserver会出现大量的watch pod调用\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200519150847.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e解决: 增大fluentd的cpu使用，同时在配置文件中修改插件filter_kubernetes_metadata，\u003c/p\u003e\n\u003cp\u003e增加watch false,减少频繁地去请求apiserver\u003c/p\u003e\n\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# Enriches records with Kubernetes metadata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;filter\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes.**\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e@id\u003c/span\u003e \u003cspan class=\"string\"\u003efilter_kubernetes_metadata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e@type\u003c/span\u003e \u003cspan class=\"string\"\u003ekubernetes_metadata\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003ewatch\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e \u003cspan class=\"comment\"\u003e# 这行\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eskip_labels\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#skip_container_metadata true\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eskip_master_url\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eskip_namespace_metadata\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026lt;/filter\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"使用wildcard查询时无记录\"\u003e\u003ca href=\"#使用wildcard查询时无记录\" class=\"headerlink\" title=\"使用wildcard查询时无记录\"\u003e\u003c/a\u003e使用wildcard查询时无记录\u003c/h3\u003e\u003cp\u003e经常，会使用wildcard来查询某个时间段内的某个字段包含某个值的记录, 假如现在要筛选出15钟之内的msg中包含\u003ccode\u003eunaryInterceptor\u003c/code\u003e的记录\u003c/p\u003e\n\u003cp\u003e假如doc字段如下:\u003c/p\u003e\n\u003cfigure class=\"highlight json\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_index\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;realtysense.viking-jarl-2020.05.27\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_type\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;RealtySense\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_id\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;AXJVQxYRxgPqZboc0ExD\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_score\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"literal\"\u003e\u003cspan class=\"keyword\"\u003enull\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;_source\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;stream\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;stdout\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;service_name\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;demo\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;msg\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;unaryInterceptor done\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;@version\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;2020-05-27T08:32:36.928Z\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;type\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;RealtySense\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;fields\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"attr\"\u003e\u0026#34;@timestamp\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"number\"\u003e1590568356928\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"attr\"\u003e\u0026#34;sort\u0026#34;\u003c/span\u003e\u003cspan class=\"punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"punctuation\"\u003e[\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"number\"\u003e1590568356928\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"punctuation\"\u003e]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"punctuation\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e那么相应的会使用以下的查询语句:\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl -H \u003cspan class=\"string\"\u003e\u0026#39;Content-Type: application/json\u0026#39;\u003c/span\u003e -XGET \u003cspan class=\"string\"\u003e\u0026#39;http://localhost:9200/demo-*/_search?pretty\u0026amp;_source_include=%2A%2C%40timestamp\u0026amp;ignore_unavailable=true\u0026amp;scroll=30s\u0026amp;size=10\u0026#39;\u003c/span\u003e -d \u003cspan class=\"string\"\u003e\u0026#39;{\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;query\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    \u0026#34;bool\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;filter\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;bool\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          \u0026#34;must\u0026#34;: [\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;range\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;@timestamp\u0026#34;: { # 指定时间段\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;gt\u0026#34;: \u0026#34;2020-05-27T08:31:43.695209Z\u0026#34;, \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                  \u0026#34;lte\u0026#34;: \u0026#34;2020-05-27T08:33:15.189058Z\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            },\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              \u0026#34;wildcard\u0026#34;: { #使用通配符\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \u0026#34;msg\u0026#34;: \u0026#34;*unaryInterceptor*\u0026#34; # 正确的写法: 1. \u0026#34;msg.keyword\u0026#34;: \u0026#34;*unaryInterceptor*\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e                \t\t\t\t\t\t\t\t\t\t\t\t\t\t#\t\t\t\t\t\t2. \u0026#34;msg\u0026#34;: \u0026#34;*unaryinterceptor*\u0026#34; 注意全都是小写.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e              }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e            }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e          ]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  },\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  \u0026#34;sort\u0026#34;: [\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      \u0026#34;@timestamp\u0026#34;: {\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e        \u0026#34;order\u0026#34;: \u0026#34;asc\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e      }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e  ]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e执行之后会发现，得到的结果为空,百思不得其解.\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026#34;took\u0026#34;\u003c/span\u003e : 4,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026#34;timed_out\u0026#34;\u003c/span\u003e : \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026#34;_shards\u0026#34;\u003c/span\u003e : {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;total\u0026#34;\u003c/span\u003e : 20,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;successful\u0026#34;\u003c/span\u003e : 20,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;failed\u0026#34;\u003c/span\u003e : 0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  },\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003e\u0026#34;hits\u0026#34;\u003c/span\u003e : {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;total\u0026#34;\u003c/span\u003e : 0,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;max_score\u0026#34;\u003c/span\u003e : null,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003e\u0026#34;hits\u0026#34;\u003c/span\u003e : [ ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e但是从kibana上查看，在指定的时间段内是存在记录的, 原因就在于**\u003ccode\u003emsg\u003c/code\u003e字段本身是\u003ccode\u003eanalyzed\u003c/code\u003e的，elasticsearch对于\u003ccode\u003eanalyzed\u003c/code\u003e的字段会将字段按空格进行分隔, 而且会所有的大写字母转换成小写字母**, 因此，在上面使用的通配符中有大写字母就无法匹配上了,这也是为何结果无记录的原因,那么解决方案有两个\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e通配符里直接使用小写\u003c/li\u003e\n\u003cli\u003e对于\u003ccode\u003eanalyzed\u003c/code\u003e的字段可直接使用内置的keyword, 比如上面可改成 \u003ccode\u003e\u0026#34;msg.keyword\u0026#34;: \u0026#34;*unaryInterceptor*\u0026#34;\u003c/code\u003e,那么这样的话原始的字符就可以匹配上了,参考\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://stackoverflow.com/questions/51849598/elasticsearch-wild-card-query-not-working\"\u003egithub\u003c/a\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"排查技巧\"\u003e\u003ca href=\"#排查技巧\" class=\"headerlink\" title=\"排查技巧\"\u003e\u003c/a\u003e排查技巧\u003c/h3\u003e\u003ch4 id=\"fluentd\"\u003e\u003ca href=\"#fluentd\" class=\"headerlink\" title=\"fluentd\"\u003e\u003c/a\u003efluentd\u003c/h4\u003e\u003cp\u003efluentd的一个排查技巧就是debug模块, 只需要在fluentd的启动参数中指定级别\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200416174010.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e当然在各类的output插件中, 也支持开启debug模块, 这个大家可以查看官方\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/\"\u003e文档\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"kafka\"\u003e\u003ca href=\"#kafka\" class=\"headerlink\" title=\"kafka\"\u003e\u003c/a\u003ekafka\u003c/h4\u003e\u003cp\u003ekafka除了上次遇到过的版本问题也没出现过有问题是因为kafka造成的,但是有几条命令还是比较有用的, 毕竟数据经过它, 看看数据有时还是有必要\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看消费者\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e./kafka-consumer-groups.sh --bootstrap-server localhost:9092 —list\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看数据消费情况\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e./kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic yourtopic\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e后面那个命令可以看到数据进kafka是否符合预期, 当然这个数据可以直接在fluentd中看到, 是一样的\u003c/p\u003e\n\u003cp\u003e这里要注意一个问题就是, \u003cstrong\u003e版本不同的kafka, 上面两条命令有所不同, 有时可能会需要使用–zookeeper.\u003c/strong\u003e\u003c/p\u003e\n\u003ch4 id=\"logstash\"\u003e\u003ca href=\"#logstash\" class=\"headerlink\" title=\"logstash\"\u003e\u003c/a\u003elogstash\u003c/h4\u003e\u003cfigure class=\"highlight yaml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eoutput\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"string\"\u003eif\u003c/span\u003e [\u003cspan class=\"string\"\u003etype\u003c/span\u003e] \u003cspan class=\"string\"\u003e==\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;RealtySense\u0026#34;\u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"string\"\u003efile\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"string\"\u003epath\u003c/span\u003e \u003cspan class=\"string\"\u003e=\u0026gt;\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;/tmp/logstash/\u003cspan class=\"template-variable\"\u003e%{+yyyy}\u003c/span\u003e/\u003cspan class=\"template-variable\"\u003e%{+MM}\u003c/span\u003e/\u003cspan class=\"template-variable\"\u003e%{+dd-HH}\u003c/span\u003e.log\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003elogstash定位日志时可以打印到console或者文件中\u003c/p\u003e\n\u003cp\u003e在个grok在线debug的[工具][\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://grokdebug.herokuapp.com/\"\u003ehttps://grokdebug.herokuapp.com/\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"es\"\u003e\u003ca href=\"#es\" class=\"headerlink\" title=\"es\"\u003e\u003c/a\u003ees\u003c/h4\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看索引 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl \u003cspan class=\"string\"\u003e\u0026#39;http://elasticsearch:9200/_cat/indices?v\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看集群状态\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl \u003cspan class=\"string\"\u003e\u0026#39;http://elasticsearch:9200/_cluster/health?pretty\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 删除索引 \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -XDELETE http://elasticsearch:9200/yourindex\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看索引数据\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl \u003cspan class=\"string\"\u003e\u0026#39;http://elasticsearch:9200/logstash.index-2019.09.22/_doc/SjLHVG0BChdCCvDoTgAU?pretty\u0026#39;\u003c/span\u003e \u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看es集群占用磁盘资源\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -s \u003cspan class=\"string\"\u003e\u0026#39;http://localhost:9200/_cat/indices?h=index,store.size\u0026amp;bytes=m\u0026#39;\u003c/span\u003e|grep yourindex|grep -v \u003cspan class=\"string\"\u003e\u0026#39;close\u0026#39;\u003c/span\u003e|\u003cspan class=\"built_in\"\u003ehead\u003c/span\u003e|awk \u003cspan class=\"string\"\u003e\u0026#39;{sum+=$2} END {print \u0026#34;yourindex_size_sum_total = \u0026#34;, sum, \u0026#34;mb\u0026#34;}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 关闭集群自平衡,这个在集群重启时有用\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -XPUT http://localhost::9200/_cluster/settings -d\u003cspan class=\"string\"\u003e\u0026#39; {\u0026#34;transient\u0026#34;: {\u0026#34;cluster.routing.allocation.enable\u0026#34; : \u0026#34;none\u0026#34;}}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 开启/关闭索引: \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -XPOST \u003cspan class=\"string\"\u003e\u0026#39;localhost:9200/my_index/_close?pretty\u0026#39;\u003c/span\u003e  curl -XPOST \u003cspan class=\"string\"\u003e\u0026#39;localhost:9200/my_index/_open?pretty\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查询索引: \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGET /_cat/indices/senserealty.sensego-mingyuan-2019.11.20?pretty\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查询每个节点的磁盘使用情况: \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -XGET \u003cspan class=\"string\"\u003e\u0026#39;localhost:9200/_cat/allocation?v\u0026amp;pretty\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看unassigned shard: \u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGET /_cat/shards?h=index,shard,prirep,state,unassigned.reason\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 查看某个文档\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGET /_cat/indices/realtysense.auth-2020.04.08?v\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGET /realtysense.auth-2020.04.08/RealtySense/AXFZK6wkxgPqZbocqveB\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 插入数据\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecurl -XPOST \u003cspan class=\"string\"\u003e\u0026#39;http://localhost:9200/realtysense.sensego-mingyuan-2020.04.15/RealtySense/\u0026#39;\u003c/span\u003e -d \u003cspan class=\"string\"\u003e\u0026#39;{\u0026#34;call_bk_url\u0026#34;: \u0026#34;3356\u0026#34;}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"未完待续\"\u003e\u003ca href=\"#未完待续\" class=\"headerlink\" title=\"未完待续\"\u003e\u003c/a\u003e未完待续\u003c/h3\u003e\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/2019/10/06/ES-FGC-Fix/\"\u003ehttps://izsk.me/2019/10/06/ES-FGC-Fix/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/\"\u003ehttps://docs.fluentd.org/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/fluent/fluent-plugin-kafka\"\u003ehttps://github.com/fluent/fluent-plugin-kafka\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://grokdebug.herokuapp.com/\"\u003ehttps://grokdebug.herokuapp.com/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/input/tail#tag\"\u003ehttps://docs.fluentd.org/input/tail#tag\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://docs.fluentd.org/configuration/config-file\"\u003ehttps://docs.fluentd.org/configuration/config-file\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.matviichuk.com/2016/07/08/nested-json-in-logstash\"\u003ehttps://www.matviichuk.com/2016/07/08/nested-json-in-logstash\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.elastic.co/guide/en/logstash/current/plugins-inputs-kafka.html#plugins-inputs-kafka-type\"\u003ehttps://www.elastic.co/guide/en/logstash/current/plugins-inputs-kafka.html#plugins-inputs-kafka-type\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.elastic.co/guide/cn/elasticsearch/guide/current/dynamic-mapping.html\"\u003ehttps://www.elastic.co/guide/cn/elasticsearch/guide/current/dynamic-mapping.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://stackoverflow.com/questions/51849598/elasticsearch-wild-card-query-not-working\"\u003ehttps://stackoverflow.com/questions/51849598/elasticsearch-wild-card-query-not-working\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2020-05-27T17:30:53+08:00",
  "Author": "Z.S.K."
}