{
  "Source": "izsk.me",
  "Title": "Kubernetes学习(k8s基于InfiniBand实现HPC高性能容器网络组网方案实践三)",
  "Link": "https://izsk.me/2021/07/05/Kubernetes-Infinitband-SRIOV-network-3-erros/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e这次把sriov+infinitband部署期间遇到的问题做一个总结，给有需要的同学做个参考.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"容器内IB网络之间不通\"\u003e\u003ca href=\"#容器内IB网络之间不通\" class=\"headerlink\" title=\"容器内IB网络之间不通\"\u003e\u003c/a\u003e容器内IB网络之间不通\u003c/h3\u003e\u003cp\u003e现象: 在容器内使用\u003ccode\u003eibdev2netdev -v\u003c/code\u003e查看\u003ccode\u003eib\u003c/code\u003e网络显示状态是\u003ccode\u003eDown\u003c/code\u003e,同时容器之间\u003ccode\u003eping ib\u003c/code\u003e对应的网卡不通\u003c/p\u003e\n\u003cp\u003e原因: 经过排查后发现，是由于\u003ccode\u003eopensmd\u003c/code\u003e服务不正常所致, 正常,多个\u003ccode\u003eopensmd\u003c/code\u003e服务一定会有一个实例是处于\u003ccode\u003emaster\u003c/code\u003e状态，但查看后发现两个实例都处于\u003ccode\u003estandby\u003c/code\u003e状态,导致\u003ccode\u003eIB\u003c/code\u003e子网有问题\u003c/p\u003e\n\u003cp\u003e关于\u003ccode\u003eopensmd\u003c/code\u003e，有个很重要的配置是\u003ccode\u003eroot guid\u003c/code\u003e文件(通过opensm.conf配置路径),可以通过\u003ccode\u003eibstat|grep \u0026#39;System image GUID\u0026#39;\u003c/code\u003e命令将所有IB节点的GUID号记录到\u003ccode\u003eroot guid\u003c/code\u003e文件中，一行一个即可，然后重新启动后恢复正常，一定要让一个实例处于\u003ccode\u003emaster\u003c/code\u003e状态\u003c/p\u003e\n\u003ch3 id=\"CNI-invalid-verion\"\u003e\u003ca href=\"#CNI-invalid-verion\" class=\"headerlink\" title=\"CNI: invalid verion\"\u003e\u003c/a\u003eCNI: invalid verion\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210616185012.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 作者线上环境的k8s版本相对较旧，新版本的kubernetes需要添加cniVersion字段\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e\u0026#34;cniVersion\u0026#34;\u003c/span\u003e: \u003cspan class=\"string\"\u003e\u0026#34;0.3.1\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"Priority-node-critical-not-permitted\"\u003e\u003ca href=\"#Priority-node-critical-not-permitted\" class=\"headerlink\" title=\"Priority-node-critical not permitted\"\u003e\u003c/a\u003ePriority-node-critical not permitted\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210622115355.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 同上也是因为k8s集群为1.17版本之前，对于设置了priorityclasses: system-node-critical， v1.17版本之前只能部署在kube-system，其它ns是不允许的，在v1.17之后可选，如果必须部署在其它ns，则需要重新打sriov-network-operator及config-daemon镜像.\u003c/p\u003e\n\u003ch3 id=\"no-match-for-kind-“MutatingwebhookConfigration”\"\u003e\u003ca href=\"#no-match-for-kind-“MutatingwebhookConfigration”\" class=\"headerlink\" title=\"no match for kind “MutatingwebhookConfigration”\"\u003e\u003c/a\u003eno match for kind “MutatingwebhookConfigration”\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210623144028.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 查看operator的Dockerfile发现包含了bindata目录，而bindata目录下的webhook中使用的版本为v1,v1.16之前webhook已不再支持v1，需要切换到v1beta1, 如果不想重新打镜像的话，可以使用configmap挂载替换镜像里的对应文件.\u003c/p\u003e\n\u003ch3 id=\"runtime-error-index-out-of-range\"\u003e\u003ca href=\"#runtime-error-index-out-of-range\" class=\"headerlink\" title=\"runtime error: index out of range\"\u003e\u003c/a\u003eruntime error: index out of range\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210624114102.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: operator维护了一个ib硬件类型列表，在deploy/configmap.yaml文件中，如果使用的硬件不在该supported-nic-ids设备类型中, 可按readme中的格式进行手工添加即可，但官方有提示，不在列表中的硬件也许也work，但不保证.\u003c/p\u003e\n\u003ch3 id=\"invalid-CIDR-address\"\u003e\u003ca href=\"#invalid-CIDR-address\" class=\"headerlink\" title=\"invalid CIDR address\"\u003e\u003c/a\u003einvalid CIDR address\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210629154253.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 自定义网络中的subnet ip网段格式写错，多写了一位\u003c/p\u003e\n\u003ch3 id=\"Got-invalid-base-LID-65535-from-network\"\u003e\u003ca href=\"#Got-invalid-base-LID-65535-from-network\" class=\"headerlink\" title=\"Got invalid base LID 65535 from network\"\u003e\u003c/a\u003eGot invalid base LID 65535 from network\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210705231941.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e网卡一直处于初始化状态，同时查看opensm的错误，默认位于/var/log/opensm.log,会发现以下错误\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210705134012.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 网卡的Base LID不能是65535, 可通过重新绑定解决\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e 0000:83:00.6 \u0026gt; /sys/bus/pci/drivers/mlx5_core/unbind\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e 11:22:33:44:77:66:77:60 \u0026gt; /sys/class/infiniband/mlx5_0/device/sriov/5/node\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e 11:22:33:44:77:66:77:60 \u0026gt; /sys/class/infiniband/mlx5_0/device/sriov/5/port\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e 0000:83:00.6 \u0026gt; /sys/bus/pci/drivers/mlx5_core/bind\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eecho\u003c/span\u003e Follow \u0026gt; /sys/class/infiniband/mlx5_0/device/sriov/5/policy\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 再次查看后Base LID已经重新分配,网卡正常\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\n\n\u003ch3 id=\"部署了sriov的Node会无缘无故被cordor从而导致无法调度\"\u003e\u003ca href=\"#部署了sriov的Node会无缘无故被cordor从而导致无法调度\" class=\"headerlink\" title=\"部署了sriov的Node会无缘无故被cordor从而导致无法调度\"\u003e\u003c/a\u003e部署了sriov的Node会无缘无故被cordor从而导致无法调度\u003c/h3\u003e\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20210705221717.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e原因: 由于本人开始时指定的\u003ccode\u003e/sys/class/net/ib0/device/sriov_numvfs\u003c/code\u003e为32, 后来又改成了8, 期间没有重启，这样会导致\u003ccode\u003esriov-network-config-daemon\u003c/code\u003e给node打上\u003ccode\u003esriovnetwork.openshift.io/state: Draining\u003c/code\u003e的注释，从而cordor节点，这个从\u003ccode\u003esriov-network-config-daemon\u003c/code\u003e的日志也可以看到，会提示需要重启节点(这里忘截图了)，节点重启后就ok了.\u003c/p\u003e\n\u003cp\u003e感兴趣的可以查看源码，非常清晰\u003c/p\u003e\n\u003cp\u003e下次总结一个整个方案使用到的细节\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2021-07-05T23:10:53+08:00",
  "Author": "Z.S.K."
}