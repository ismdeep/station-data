{
  "Source": "izsk.me",
  "Title": "FELK学习(解决Unassigned shard)",
  "Link": "https://izsk.me/2019/05/10/FELK-fix-unassigned-shard/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n      \n\n      \n        \u003cp\u003e在使用es时，如果集群的参数配置跟node节点数之间的关系没有处理好就有可能出现集群的status为\u003ccode\u003eyellow\u003c/code\u003e,下面就处理一种常见的\u003ccode\u003eunassigned shard\u003c/code\u003e的问题.\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\n\n\u003ch3 id=\"查看集群状态\"\u003e\u003ca href=\"#查看集群状态\" class=\"headerlink\" title=\"查看集群状态\"\u003e\u003c/a\u003e查看集群状态\u003c/h3\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl es-logstore.people.local/_cluster/health?pretty\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504204458.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e可以看到集群的状态为yellow, 从es集群的三大状态(Red, Yellow, Green)来看,yellow状态说明有索引的副本缺失\u003c/p\u003e\n\u003cp\u003e查询索引确实发现有索引状态为\u003ccode\u003eyellow\u003c/code\u003e\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl es-tsdb.people.local/_cat/indices\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504204851.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"unassigned-shard\"\u003e\u003ca href=\"#unassigned-shard\" class=\"headerlink\" title=\"unassigned shard\"\u003e\u003c/a\u003eunassigned shard\u003c/h3\u003e\u003cp\u003e查看shard的状态，是否存在unassigned的分片\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl es-tsdb.people.local/_cat/shards|grep UNASSIGNED\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504204952.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"explain\"\u003e\u003ca href=\"#explain\" class=\"headerlink\" title=\"explain\"\u003e\u003c/a\u003eexplain\u003c/h3\u003e\u003cp\u003e使用\u003ccode\u003eexplain\u003c/code\u003e查看具体原因:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504205021.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e从\u003ccode\u003ereason\u003c/code\u003e中可以看出, 这个索引\u003ccode\u003eunassigned\u003c/code\u003e的原因为无法在同一个节点上保存两分副本.\u003c/p\u003e\n\u003cp\u003e也就是说，在该节点上已经存在了一个副本了.\u003c/p\u003e\n\u003cp\u003e同时另两个节点上无法保存副本的\u003ccode\u003ereason\u003c/code\u003e为:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504205106.png\"/\u003e\u003c/p\u003e\n\u003cp\u003e这个\u003ccode\u003ereason\u003c/code\u003e是说副本数量超时了这个节点能够存在副本的最大值,所以也没法分配。\u003c/p\u003e\n\u003cp\u003e从这里我们可以看出一个关键的参数\u003ccode\u003eindex.routing.allocation.total_shards_per_node=2\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003e这个参数指的是一个节点上最好能保存某个索引的最大值\u003c/p\u003e\n\u003cp\u003e假如: 一个es集群有3个数据节点，某个索引模板设置的分片数为3, 副本数为1, 那么总的分片数=主分片数+ 副分片数，也就是3+3=6个, 那么3个数据节点 则\u003ccode\u003etotal_shards_per_node\u003c/code\u003e的值可以设置为6/3=2,每个节点上保存2个副本，一般情况下这是合理的.\u003c/p\u003e\n\u003cp\u003e但是如果某个时刻,es集群出现脑裂问题的话，比如说有个节点宕机，那么6个分片需要分布在两个节点上, 那么每个节点上需要保存3个副本，这大于\u003ccode\u003etotal_shards_per_node=2\u003c/code\u003e，所以有可能出现以上的错误，所以一般起见, \u003ccode\u003etotal_shards_per_node\u003c/code\u003e一般设置的比最小值大点。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003etotal_shards_per_node\u003c/code\u003e这个值在es的配置文件中指定，同时也支持动态修改.\u003c/p\u003e\n\u003ch3 id=\"解决\"\u003e\u003ca href=\"#解决\" class=\"headerlink\" title=\"解决\"\u003e\u003c/a\u003e解决\u003c/h3\u003e\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003ecurl -XPUT \u003cspan class=\"string\"\u003e\u0026#39;http://es-tsdb.people.local/hawkeye-ts-10s-2019-05-08-18/_settings\u0026#39;\u003c/span\u003e -d \u003cspan class=\"string\"\u003e\u0026#39;{\u0026#34;index.routing.allocation.total_shards_per_node\u0026#34;:3}\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e修改之后，再次查看集群的状态，变回了\u003ccode\u003egreen\u003c/code\u003e状态.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://raw.githubusercontent.com/zhoushuke/BlogPhoto/master/githuboss/20200504205149.png\"/\u003e\u003c/p\u003e\n\u003ch3 id=\"参考文章\"\u003e\u003ca href=\"#参考文章\" class=\"headerlink\" title=\"参考文章:\"\u003e\u003c/a\u003e\u003cstrong\u003e参考文章:\u003c/strong\u003e\u003c/h3\u003e\u003cblockquote\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/elastic/curator\"\u003ehttps://github.com/elastic/curator\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"转载请注明原作者-周淑科-https-izsk-me\"\u003e\u003ca href=\"#转载请注明原作者-周淑科-https-izsk-me\" class=\"headerlink\" title=\"转载请注明原作者: 周淑科(https://izsk.me)\"\u003e\u003c/a\u003e\u003cstrong\u003e转载请注明原作者: 周淑科(\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://izsk.me/\"\u003ehttps://izsk.me\u003c/a\u003e)\u003c/strong\u003e\u003c/h3\u003e\n      \n    \u003c/div\u003e",
  "Date": "2019-05-10T13:30:53+08:00",
  "Author": "Z.S.K."
}