{
  "Source": "liam.page",
  "Title": "crontab 任务误删恢复",
  "Link": "https://liam.page/2017/11/30/recovery-crontab-tasks/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e这是一篇简短的记录。\u003c/p\u003e\n\u003cp\u003e某台服务器某账号的 \u003ccode\u003ecrontab\u003c/code\u003e 任务被清空，原因不明。同时，该服务器上的 \u003ccode\u003ecrontab\u003c/code\u003e 任务备份未开启。故思考如何恢复 \u003ccode\u003ecrontab\u003c/code\u003e 任务。\u003c/p\u003e\n\u003cp\u003e经查，CentOS 系统的 \u003ccode\u003ecrontab\u003c/code\u003e 任务的日志，打印在 \u003ccode\u003e/var/log/cron\u003c/code\u003e 之中。考虑过滤日志：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ecat\u003c/span\u003e /var/log/cron* | grep CMD | awk -F\u003cspan class=\"string\"\u003e\u0026#39;CMD\u0026#39;\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;{print $2}\u0026#39;\u003c/span\u003e | awk -F\u003cspan class=\"string\"\u003e\u0026#39;[(|)]\u0026#39;\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;{print $2}\u0026#39;\u003c/span\u003e | \u003cspan class=\"built_in\"\u003esort\u003c/span\u003e -u\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e由此得到系统记录过的 \u003ccode\u003ecrontab\u003c/code\u003e 执行命令，过滤其他账号的命令后即可追回目标账号的 \u003ccode\u003ecrontab\u003c/code\u003e 任务。\u003c/p\u003e\n\u003cp\u003e此外，考虑备份 \u003ccode\u003ecrontab\u003c/code\u003e；脚本如下：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003cfigcaption\u003e\u003cspan\u003ebackup_crontab.sh\u003c/span\u003e\u003c/figcaption\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#!/usr/bin/env bash\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBACKUP_DIRECTORY=\u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e${HOME}\u003c/span\u003e/crontab_backup\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e [ ! -e \u003cspan class=\"string\"\u003e\u0026#34;\u003cspan class=\"variable\"\u003e${BACKUP_DIRECTORY}\u003c/span\u003e\u0026#34;\u003c/span\u003e ]; \u003cspan class=\"keyword\"\u003ethen\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"built_in\"\u003emkdir\u003c/span\u003e -p \u003cspan class=\"variable\"\u003e${BACKUP_DIRECTORY}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecrontab -l \u0026gt; \u003cspan class=\"variable\"\u003e${BACKUP_DIRECTORY}\u003c/span\u003e/$(\u003cspan class=\"built_in\"\u003edate\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#39;+%Y%m%d\u0026#39;\u003c/span\u003e).txt\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n    \u003c/div\u003e",
  "Date": "2017-11-30T07:49:49Z",
  "Author": "Liam Huang"
}