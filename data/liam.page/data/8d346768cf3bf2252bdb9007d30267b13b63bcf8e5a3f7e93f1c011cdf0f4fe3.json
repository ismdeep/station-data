{
  "Source": "liam.page",
  "Title": "异步加载多说评论框以加快页面访问速度",
  "Link": "https://liam.page/2014/07/22/duoshuo-delay/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e多说评论框可以让静态博客实现评论功能，对于搭在 GitHub Pages 上的博客来说是非常好用的功能。美中不足的是，多说评论框的加载速度有些慢；默认情况下，多说评论框总是随页面一起加载，拖慢了整个页面的加载速度。\u003c/p\u003e\n\u003cp\u003e本希望用自动异步加载的方式，在页面加载完成之后，再加载多说评论框。奈何多说没有提供所需的 API。于是只能退而求其次，采用手动的方法。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003e多说在其\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://dev.duoshuo.com/docs/50b344447f32d30066000147\"\u003e官博\u003c/a\u003e提出了一种异步加载的方式。经测试，这个方法可用——只需要点击按钮，多说评论框就会弹出来。但是，官博提供的方法只能弹出，不能缩回，有些恼人。于是自己写了几行代码，解决了这个问题。\u003c/p\u003e\n\u003ch2 id=\"详细步骤\"\u003e\u003ca href=\"#详细步骤\" class=\"headerlink\" title=\"详细步骤\"\u003e\u003c/a\u003e详细步骤\u003c/h2\u003e\u003cp\u003e首先，我们需要加载多说的 \u003ccode\u003eembed.js\u003c/code\u003e 基础代码，并设置 \u003ccode\u003eduoshuoQuery\u003c/code\u003e。多说官博希望我们把这段代码放在网页的 head 中，我不推荐这样做。因为我们使用异步加载的原因，就是希望提高速度，而如果将多说的代码放在 head 中，又拖慢了速度。所以我们将代码放在多说评论框加载之前就可以了。\u003c/p\u003e\n\u003cfigure class=\"highlight html\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\u003cspan class=\"keyword\"\u003evar\u003c/span\u003e duoshuoQuery = {\u003cspan class=\"attr\"\u003eshort_name\u003c/span\u003e:\u003cspan class=\"string\"\u003e\u0026#34;你的多说二级域名\u0026#34;\u003c/span\u003e};\u003c/span\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003escript\u003c/span\u003e \u003cspan class=\"attr\"\u003esrc\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;http://static.duoshuo.com/embed.js\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e多说二级域名是指你注册多说时，填写的 \u003ccode\u003eabc.duoshuo.com\u003c/code\u003e 中的 \u003ccode\u003eabc\u003c/code\u003e 部分。\u003c/p\u003e\n\u003cp\u003e紧接其后之后，我们要写入 JavaScript 函数，实现多说评论框的缩放功能。\u003c/p\u003e\n\u003cfigure class=\"highlight html\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003escript\u003c/span\u003e \u003cspan class=\"attr\"\u003etype\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;text/javascript\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cspan class=\"language-javascript\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e\u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"title function_\"\u003etoggleDuoshuoComments\u003c/span\u003e(\u003cspan class=\"params\"\u003econtainer, id, url\u003c/span\u003e){\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e(\u003cspan class=\"title function_\"\u003ejQuery\u003c/span\u003e(container).\u003cspan class=\"title function_\"\u003ehas\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;div\u0026#34;\u003c/span\u003e).\u003cspan class=\"property\"\u003elength\u003c/span\u003e\u0026gt;\u003cspan class=\"number\"\u003e0\u003c/span\u003e){\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e    \u003cspan class=\"title function_\"\u003ejQuery\u003c/span\u003e(container).\u003cspan class=\"title function_\"\u003eempty\u003c/span\u003e();\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  }\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e el = \u003cspan class=\"variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;div\u0026#39;\u003c/span\u003e);\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  el.\u003cspan class=\"title function_\"\u003esetAttribute\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;data-thread-key\u0026#39;\u003c/span\u003e, id);\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  el.\u003cspan class=\"title function_\"\u003esetAttribute\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;data-url\u0026#39;\u003c/span\u003e, url);\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  \u003cspan class=\"variable constant_\"\u003eDUOSHUO\u003c/span\u003e.\u003cspan class=\"title class_\"\u003eEmbedThread\u003c/span\u003e(el);\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e  \u003cspan class=\"title function_\"\u003ejQuery\u003c/span\u003e(container).\u003cspan class=\"title function_\"\u003eappend\u003c/span\u003e(el);\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e}\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"language-javascript\"\u003e\u003c/span\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003escript\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在需要插入按钮的地方，我们建立一个 click 事件。\u003c/p\u003e\n\u003cfigure class=\"highlight html\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003ea\u003c/span\u003e \u003cspan class=\"attr\"\u003ehref\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;javascript:void(0);\u0026#34;\u003c/span\u003e \u003cspan class=\"attr\"\u003eonclick\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;toggleDuoshuoComments(\u0026#39;#comment-box\u0026#39;, \u0026lt;%= item.title %\u0026gt;, \u0026lt;%- config.url %\u0026gt;\u0026lt;%- config.root %\u0026gt;\u0026lt;%- item.path %\u0026gt;);\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e查看评论\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003ea\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e其中 \u003ccode\u003e\u0026lt;%= item.title %\u0026gt;\u003c/code\u003e 和 \u003ccode\u003e\u0026lt;%- config.url %\u0026gt;\u0026lt;%- config.root %\u0026gt;\u0026lt;%- item.path %\u0026gt;\u003c/code\u003e 是 hexo 的语法。\u003c/p\u003e\n\u003cp\u003e最后，在需要弹出评论框的地方，插入一个 \u003ccode\u003ediv\u003c/code\u003e 标签。\u003c/p\u003e\n\u003cfigure class=\"highlight html\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003ediv\u003c/span\u003e \u003cspan class=\"attr\"\u003eid\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;comment-box\u0026#34;\u003c/span\u003e \u0026gt;\u003c/span\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003ediv\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这样就大功告成啦！\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2014-07-22T09:52:50Z",
  "Author": "Liam Huang"
}