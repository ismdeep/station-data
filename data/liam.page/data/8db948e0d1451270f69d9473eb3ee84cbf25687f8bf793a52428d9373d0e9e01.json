{
  "Source": "liam.page",
  "Title": "GDB 入门教程：调试 ncurses 相关 bug 的完整范例",
  "Link": "https://liam.page/2017/05/27/tutorial-to-GDB-taking-ncurses-as-an-example/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cblockquote\u003e\n\u003cp\u003e这是一篇由 \u003ca href=\"/\"\u003eLiam Huang\u003c/a\u003e 翻译的译文，原文是 \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.brendangregg.com/blog/index.html\"\u003eBrendan Gregg\u003c/a\u003e 所作的 \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.brendangregg.com/blog/2016-08-09/gdb-example-ncurses.html\"\u003e\u003cem\u003egdb Debugging Full Example (Tutorial): ncurses\u003c/em\u003e\u003c/a\u003e。转载请保留本段文字，尊重作者和译者的权益。\u003cbr/\u003eThe author of this work is \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.brendangregg.com/blog/index.html\"\u003eBrendan Gregg\u003c/a\u003e and this work was firstly posted on \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.brendangregg.com/blog/2016-08-09/gdb-example-ncurses.html\"\u003e\u003cem\u003egdb Debugging Full Example (Tutorial): ncurses\u003c/em\u003e\u003c/a\u003e. This is the translation of the original work, by \u003ca href=\"/\"\u003eLiam Huang\u003c/a\u003e. Please keep this information at the very top of your reprint, for the rights of the author and the translator.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e当我尝试在网上寻找「GDB 范例」时，我发现大多数文章只是贴出了命令，而没有讲解相关输出。GDB 是 GNU 调试器（GNU Debugger），亦是 Linux 系统上的标准调试器。在听 Greg Law 在 CppCon 2015 上关于 GDB 的演讲时（\u003ca target=\"_blank\" rel=\"noopener\" href=\"http://undo.io/resources/presentations/cppcon-2015-greg-law-give-me-15-minutes-ill-change/\"\u003eGive me 15 minutes and I\u0026#39;ll change your view of GDB\u003c/a\u003e），我发现 Law 给出了相关输出，从而意识到了上述不足。\u003c/p\u003e\n\u003cp\u003eLaw 的演讲，也让我意识到应该分享一个使用 GDB 解决问题的完整范例：包括命令输出、各个步骤，以及一些死胡同。也就是说，这篇文章将分享使用 GDB 调试查错的一般步骤，而不是其他特别的东西。这篇文章介绍了 GDB 的基本使用方法，因此可以作为教程使用。不过，还有很多东西没有介绍，请谨记在心。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003cp\u003e以下命令，均是以 \u003ccode\u003eroot\u003c/code\u003e 权限执行的。这是因为我调试的程序目前需要以 \u003ccode\u003eroot\u003c/code\u003e 权限执行。在实际使用中，并不是所有所需的命令都需要 \u003ccode\u003eroot\u003c/code\u003e 权限。此外，本文罗列了解决问题的每一个步骤，你可以只浏览你感兴趣的部分。\u003c/p\u003e\n\u003ch2 id=\"一-·-问题来了\"\u003e\u003ca href=\"#一-·-问题来了\" class=\"headerlink\" title=\"一 · 问题来了\"\u003e\u003c/a\u003e一 · 问题来了\u003c/h2\u003e\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/iovisor/bcc\"\u003ebcc\u003c/a\u003e 工具集是 BPF 工具箱的一部分。有人提起了一个 PR (Pull Request)，修改了其中的 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/iovisor/bcc/blob/master/tools/cachetop.py\"\u003ecachetop\u003c/a\u003e 以使用 top-like display 显示 page cache 的统计。当我对这个 PR 进行测试时，程序提示段错误（segfault）\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ./cachetop.py\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSegmentation fault\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e需要注意的是，Linux 提示程序遇到「段错误 \u003ccode\u003eSegmentation fault\u003c/code\u003e」，而不是「段错误（核心已转储）\u003ccode\u003eSegmentation fault (Core Dumped)\u003c/code\u003e」。而此处，我希望能通过核心转储文件，对错误进行调试。（核心转储文件是进程内存空间的拷贝，因此可以用于调试；这个术语源自早年的磁性核心记忆体）\u003c/p\u003e\n\u003cp\u003e分析核心转储文件，是调试查错的手段之一。不过，也有其他的调试办法。比如，在程序执行时，使用 GDB 检查问题；又或者使用外部工具，收集段错误发生时的数据和堆栈信息。不过，此处我们从核心转储文件的分析开始。\u003c/p\u003e\n\u003ch2 id=\"二-·-获得核心转储文件\"\u003e\u003ca href=\"#二-·-获得核心转储文件\" class=\"headerlink\" title=\"二 · 获得核心转储文件\"\u003e\u003c/a\u003e二 · 获得核心转储文件\u003c/h2\u003e\u003cp\u003e首先，我需要检查一下关于核心转储的设置。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ulimit -c\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# cat /proc/sys/kernel/core_pattern\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecore\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003eulimit -c\u003c/code\u003e 是 Linux 的系统设置之一，用于限制生成核心转储文件的最大体积。此处，提示不允许转储进程内存。\u003c/p\u003e\n\u003cp\u003e另一方面，\u003ccode\u003e/proc/sys/kernel/core_pattern\u003c/code\u003e 的内容是 \u003ccode\u003ecore\u003c/code\u003e。这意味着，发生核心转储时，Linux 会将进程内存空间转储到当前目录下名为 \u003ccode\u003ecore\u003c/code\u003e 的文件当中。对于解决当前问题，这样的设置没什么问题。不过，我会希望将其存在某个固定的目录中。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ulimit -c unlimited\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# mkdir /var/cores\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# echo \u0026#34;/var/cores/core.%e.%p\u0026#34; \u0026gt; /proc/sys/kernel/core_pattern\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e你也可以进一步调整 \u003ccode\u003ecore_pattern\u003c/code\u003e。比如说，\u003ccode\u003e%h\u003c/code\u003e 表示机器名称，\u003ccode\u003e%t\u003c/code\u003e 表示转储发生的时间。这些 Linux 内核参数的文档在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.kernel.org/doc/Documentation/sysctl/kernel.txt\"\u003e这里\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e如果想要永久更改 \u003ccode\u003ecore_pattern\u003c/code\u003e 的设置，你可以修改 \u003ccode\u003e/etc/sysctl.conf\u003c/code\u003e 文件中的 \u003ccode\u003ekernel.core_pattern\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e如此，再试试看。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ./cachetop.py\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSegmentation fault (core dumped)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ls -lh /var/cores\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etotal 19M\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e-rw------- 1 root root 20M Aug  7 22:15 core.python.30520\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# file /var/cores/core.python.30520\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e/var/cores/core.python.30520: ELF 64-bit LSB core file x86-64, version 1 (SYSV), SVR4-style, from \u003cspan class=\"string\"\u003e\u0026#39;python ./cachetop.py\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThat\u003cspan class=\"string\"\u003e\u0026#39;s better: we have our core dump.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这样一来，我们就有核心转储文件了。\u003c/p\u003e\n\u003ch2 id=\"三-·-启动-GDB\"\u003e\u003ca href=\"#三-·-启动-GDB\" class=\"headerlink\" title=\"三 · 启动 GDB\"\u003e\u003c/a\u003e三 · 启动 GDB\u003c/h2\u003e\u003cp\u003e现在，我可以启动 GDB，调试目标程序和核心转储文件了。（这里使用了 \u003ccode\u003e`which python`\u003c/code\u003e 的方式获取系统中 \u003ccode\u003epython\u003c/code\u003e 的绝对路径）\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python` /var/cores/core.python.30520\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCopyright (C) 2016 Free Software Foundation, Inc.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLicense GPLv3+: GNU GPL version 3 or later\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis is free software: you are free to change and redistribute it.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThere is NO WARRANTY, to the extent permitted by law.  Type \u003cspan class=\"string\"\u003e\u0026#34;show copying\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eand \u003cspan class=\"string\"\u003e\u0026#34;show warranty\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis GDB was configured as \u003cspan class=\"string\"\u003e\u0026#34;x86_64-linux-gnu\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;show configuration\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e configuration details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor bug reporting instructions, please see:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind the GDB manual and other documentation resources online at:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e, \u003cspan class=\"built_in\"\u003etype\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;apropos word\u0026#34;\u003c/span\u003e to search \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e commands related to \u003cspan class=\"string\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e...\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading symbols from /usr/bin/python...(no debugging symbols found)...\u003cspan class=\"keyword\"\u003edone\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: core file may not match specified executable file.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[New LWP 30520]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCore was generated by `python ./cachetop.py\u003cspan class=\"string\"\u003e\u0026#39;.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eProgram terminated with signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#0  0x00007f0a37aac40d in doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e最后两行包含有趣的信息：它告诉我们，段错误发生在 \u003ccode\u003elibncursesw\u003c/code\u003e 库的 \u003ccode\u003edoupdate()\u003c/code\u003e 函数中。这类问题，可以考虑在网上检索，看看是否是已知问题。当然，我遇到的这个问题，没有其他人报告过。\u003c/p\u003e\n\u003cp\u003e对我来说，我大概能猜到 \u003ccode\u003elibncursesw\u003c/code\u003e 是做什么的。不过，如果对你来说这很陌生的话，首先你应该知道 \u003ccode\u003e/lib\u003c/code\u003e 开头并以 \u003ccode\u003e*.so\u003c/code\u003e 结尾说明它是一个共享对象（动态库）。接下来，你可以尝试通过 \u003ccode\u003eman\u003c/code\u003e 命令、网页、软件包说明等方式，弄清楚它是做什么的。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# dpkg -l | grep libncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     shared libraries \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e terminal handling (wide character support)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e我这里是在 Ubuntu 上调试，不过，在其他 Linux 发行上调试也基本没差。\u003c/p\u003e\n\u003ch2 id=\"四-·-逆向追溯\"\u003e\u003ca href=\"#四-·-逆向追溯\" class=\"headerlink\" title=\"四 · 逆向追溯\"\u003e\u003c/a\u003e四 · 逆向追溯\u003c/h2\u003e\u003cp\u003e逆向追溯调用栈，能让我们知道程序是如何一步步调用直到出现问题的。对于一般的问题，逆向追溯调用栈，就足够定位出问题了。因此，我在 GDB 中都会首先尝试使用这一命令：\u003ccode\u003ebt\u003c/code\u003e（\u003ccode\u003ebacktrace\u003c/code\u003e 的缩写）。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) bt\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  0x00007f0a37aac40d in doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#1  0x00007f0a37aa07e6 in wrefresh () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#2  0x00007f0a37a99616 in ?? () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#3  0x00007f0a37a9a325 in wgetch () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#4  0x00007f0a37cc6ec3 in ?? () from /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#5  0x00000000004c4d5a in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#6  0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#7  0x00000000004def08 in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#8  0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#9  0x00000000004c73ec in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#10 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#11 0x00000000004caf42 in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#12 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#13 0x00000000004c2ba9 in PyEval_EvalCode ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#14 0x00000000004f20ef in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#15 0x00000000004eca72 in PyRun_FileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#16 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#17 0x000000000049e18a in Py_Main ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#18 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 \u0026lt;main\u0026gt;, argc=2, argv=0x7ffd33d94838, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#19 0x000000000049da19 in _start ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，自底向上的方向即是调用者 \u003ccode\u003e-\u0026gt;\u003c/code\u003e 被调用的方向。其中 \u003ccode\u003e??\u003c/code\u003e 表示符号转义失败。遍历调用栈生成栈回溯记录的过程也有可能失败。这种情况下，你可能会看到一个地址值很小的栈帧，当然，这个地址通常是错误的。如果这些问题很严重，那么就要考虑修复这些问题：安装相应软件包的调试信息包（为 GDB 提供更多符号，且允许 GDB 做基于 DWARF 的遍历），或是在编译程序时禁止编译器优化栈帧指针并包含调试信息（\u003ccode\u003e-fno-omit-frame-pointer -g\u003c/code\u003e）。这里的 \u003ccode\u003e??\u003c/code\u003e 在安装 \u003ccode\u003epython-dbg\u003c/code\u003e 软件包之后，大都都能解决。\u003c/p\u003e\n\u003cp\u003e仅从调用栈来看，信息似乎不太够：\u003ccode\u003e#5\u003c/code\u003e 至 \u003ccode\u003e#17\u003c/code\u003e 是在 Python 内部，而后经由 \u003ccode\u003e_curses\u003c/code\u003e 库调用进入 \u003ccode\u003elibncursesw\u003c/code\u003e。在 \u003ccode\u003elibncursesw\u003c/code\u003e 中，\u003ccode\u003ewgetch()-\u0026gt;wrefresh()-\u0026gt;doupdate()\u003c/code\u003e 调用顺序看起来进行了一次窗口刷新。但是，为什么这会引发核心转储呢？\u003c/p\u003e\n\u003ch2 id=\"五-·-反汇编\"\u003e\u003ca href=\"#五-·-反汇编\" class=\"headerlink\" title=\"五 · 反汇编\"\u003e\u003c/a\u003e五 · 反汇编\u003c/h2\u003e\u003cp\u003e接下来，我要反汇编导致段错误的函数 \u003ccode\u003edoupdate()\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) disas doupdate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDump of assembler code \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e doupdate:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e0 \u0026lt;+0\u0026gt;:   push   %r15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e2 \u0026lt;+2\u0026gt;:   push   %r14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e4 \u0026lt;+4\u0026gt;:   push   %r13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e6 \u0026lt;+6\u0026gt;:   push   %r12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e8 \u0026lt;+8\u0026gt;:   push   %rbp\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e9 \u0026lt;+9\u0026gt;:   push   %rbx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2ea \u0026lt;+10\u0026gt;:  sub    \u003cspan class=\"variable\"\u003e$0xc8\u003c/span\u003e,%rsp\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e---Type \u0026lt;\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e\u0026gt; to \u003cspan class=\"built_in\"\u003econtinue\u003c/span\u003e, or q \u0026lt;\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e\u0026gt; to quit---\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3f7 \u0026lt;+279\u0026gt;: cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x21(%rcx)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3fb \u0026lt;+283\u0026gt;: je     0x7f0a37aacc3b \u0026lt;doupdate+2395\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac401 \u0026lt;+289\u0026gt;: mov    0x20cb68(%rip),%rax        \u003cspan class=\"comment\"\u003e# 0x7f0a37cb8f70\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac408 \u0026lt;+296\u0026gt;: mov    (%rax),%rsi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac40b \u0026lt;+299\u0026gt;: xor    %eax,%eax\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e=\u0026gt; 0x00007f0a37aac40d \u0026lt;+301\u0026gt;: mov    0x10(%rsi),%rdi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac411 \u0026lt;+305\u0026gt;: cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x1c(%rdi)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac415 \u0026lt;+309\u0026gt;: jne    0x7f0a37aac6f7 \u0026lt;doupdate+1047\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac41b \u0026lt;+315\u0026gt;: movswl 0x4(%rcx),%ecx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac41f \u0026lt;+319\u0026gt;: movswl 0x74(%rdx),%edi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac423 \u0026lt;+323\u0026gt;: mov    %rax,0x40(%rsp)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里的输出做了适当的截断。（我也可以直接输入 \u003ccode\u003edisas\u003c/code\u003e，以查看当前函数的汇编代码）\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e=\u0026gt;\u003c/code\u003e 箭头标注的位置，即是产生段错误的指令地址。该指令中（\u003ccode\u003emov    0x10(%rsi),%rdi\u003c/code\u003e），\u003ccode\u003e%rsi\u003c/code\u003e 寄存器保存了一个内存地址，之前的 \u003ccode\u003e0x10\u003c/code\u003e 表示在这个内存地址的基础上做 \u003ccode\u003e0x10\u003c/code\u003e 的偏移；\u003ccode\u003e%rdi\u003c/code\u003e 则是另一个寄存器。该指令的作用，是将上述偏移过的内存地址中保存的内容，拷贝到 \u003ccode\u003e%rdi\u003c/code\u003e 寄存器当中。接下来，我们要看看寄存器的状态。\u003c/p\u003e\n\u003ch2 id=\"六-·-查看寄存器状态\"\u003e\u003ca href=\"#六-·-查看寄存器状态\" class=\"headerlink\" title=\"六 · 查看寄存器状态\"\u003e\u003c/a\u003e六 · 查看寄存器状态\u003c/h2\u003e\u003cp\u003e使用命令 \u003ccode\u003ei r\u003c/code\u003e（\u003ccode\u003einfo registers\u003c/code\u003e 的缩写）可以打印寄存器状态。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) i r\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erax            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbx            0x1993060    26816608\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ercx            0x19902a0    26804896\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdx            0x19ce7d0    27060176\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersi            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdi            0x19ce7d0    27060176\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbp            0x7f0a3848eb10   0x7f0a3848eb10 \u0026lt;SP\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersp            0x7ffd33d93c00   0x7ffd33d93c00\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er8             0x7f0a37cb93e0   139681862489056\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er9             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er10            0x8  8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er11            0x202    514\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er12            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er13            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er14            0x7f0a3848eb10   139681870703376\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er15            0x19ce7d0    27060176\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erip            0x7f0a37aac40d   0x7f0a37aac40d \u0026lt;doupdate+301\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eeflags         0x10246  [ PF ZF IF RF ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecs             0x33 51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ess             0x2b 43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eds             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ees             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003egs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好吧，\u003ccode\u003e%rsi\u003c/code\u003e 这个寄存器中，保存的是一个空指针（\u003ccode\u003e0x0\u003c/code\u003e）。这就怪不得要出问题了。解引用一个未初始化的指针，或是解引用空指针，是段错误的常见原因。\u003c/p\u003e\n\u003ch2 id=\"七-·-内存映射\"\u003e\u003ca href=\"#七-·-内存映射\" class=\"headerlink\" title=\"七 · 内存映射\"\u003e\u003c/a\u003e七 · 内存映射\u003c/h2\u003e\u003cp\u003e你可以再确认一下此时 \u003ccode\u003e0x0\u003c/code\u003e 是否是有效的地址。在 GDB 中使用 \u003ccode\u003ei proc m\u003c/code\u003e（\u003ccode\u003einfo proc mappings\u003c/code\u003e 的缩写）可以查看内存映射状态。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) i proc m\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMapped address spaces:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      Start Addr           End Addr       Size     Offset objfile\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        0x400000           0x6e7000   0x2e7000        0x0 /usr/bin/python2.7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        0x8e6000           0x8e8000     0x2000   0x2e6000 /usr/bin/python2.7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        0x8e8000           0x95f000    0x77000   0x2e8000 /usr/bin/python2.7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37a8b000     0x7f0a37ab8000    0x2d000        0x0 /lib/x86_64-linux-gnu/libncursesw.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37ab8000     0x7f0a37cb8000   0x200000    0x2d000 /lib/x86_64-linux-gnu/libncursesw.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37cb8000     0x7f0a37cb9000     0x1000    0x2d000 /lib/x86_64-linux-gnu/libncursesw.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37cb9000     0x7f0a37cba000     0x1000    0x2e000 /lib/x86_64-linux-gnu/libncursesw.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37cba000     0x7f0a37ccd000    0x13000        0x0 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37ccd000     0x7f0a37ecc000   0x1ff000    0x13000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37ecc000     0x7f0a37ecd000     0x1000    0x12000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a37ecd000     0x7f0a37ecf000     0x2000    0x13000 /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a38050000     0x7f0a38066000    0x16000        0x0 /lib/x86_64-linux-gnu/libgcc_s.so.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a38066000     0x7f0a38265000   0x1ff000    0x16000 /lib/x86_64-linux-gnu/libgcc_s.so.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a38265000     0x7f0a38266000     0x1000    0x15000 /lib/x86_64-linux-gnu/libgcc_s.so.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a38266000     0x7f0a3828b000    0x25000        0x0 /lib/x86_64-linux-gnu/libtinfo.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  0x7f0a3828b000     0x7f0a3848a000   0x1ff000    0x25000 /lib/x86_64-linux-gnu/libtinfo.so.5.9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如此可以看到，虚存空间有效地址的最低位是 \u003ccode\u003e0x400000\u003c/code\u003e。因此，显而易见 \u003ccode\u003e0x0\u003c/code\u003e 此时是一个非法的地址，所以使用它会导致段错误。\u003c/p\u003e\n\u003cp\u003e至此为止，继续深入进行调试的方法有多重。我将从指令的角度继续深入。\u003c/p\u003e\n\u003ch2 id=\"八-·-断点\"\u003e\u003ca href=\"#八-·-断点\" class=\"headerlink\" title=\"八 · 断点\"\u003e\u003c/a\u003e八 · 断点\u003c/h2\u003e\u003cp\u003e回到刚才的反汇编的结果。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac401 \u0026lt;+289\u0026gt;:   mov    0x20cb68(%rip),%rax        \u003cspan class=\"comment\"\u003e# 0x7f0a37cb8f70\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac408 \u0026lt;+296\u0026gt;:   mov    (%rax),%rsi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac40b \u0026lt;+299\u0026gt;:   xor    %eax,%eax\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e=\u0026gt; 0x00007f0a37aac40d \u0026lt;+301\u0026gt;:   mov    0x10(%rsi),%rdi\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e从汇编指令来看，代码似乎首先从栈上将某个信息拷贝到 \u003ccode\u003e%rax\u003c/code\u003e 寄存器当中。而后解引用 \u003ccode\u003e%rax\u003c/code\u003e 寄存器里的内容，并拷贝到 \u003ccode\u003e%rsi\u003c/code\u003e 寄存器。而后通过 \u003ccode\u003exor\u003c/code\u003e 将 \u003ccode\u003e%eax\u003c/code\u003e 寄存器中的内容置零。最后执行到产生段错误的代码。在这里，\u003ccode\u003e%eax\u003c/code\u003e 有可能提供更多的信息。（译注：原作者写的是 \u003ccode\u003e%rax\u003c/code\u003e，这应该是手误）但是在段错误之前，它已经被置零了，因此我们看不到更多的信息。\u003c/p\u003e\n\u003cp\u003e我可以将断点设置在 \u003ccode\u003edoupdate+298\u003c/code\u003e 处，而后顺着指令单步调试，看看各个寄存器的值是如何变化的。为此，首先我得启动 GDB，以便在其中实时执行程序。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCopyright (C) 2016 Free Software Foundation, Inc.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLicense GPLv3+: GNU GPL version 3 or later\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis is free software: you are free to change and redistribute it.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThere is NO WARRANTY, to the extent permitted by law.  Type \u003cspan class=\"string\"\u003e\u0026#34;show copying\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eand \u003cspan class=\"string\"\u003e\u0026#34;show warranty\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis GDB was configured as \u003cspan class=\"string\"\u003e\u0026#34;x86\\_64-linux-gnu\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;show configuration\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e configuration details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor bug reporting instructions, please see:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind the GDB manual and other documentation resources online at:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e, \u003cspan class=\"built_in\"\u003etype\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;apropos word\u0026#34;\u003c/span\u003e to search \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e commands related to \u003cspan class=\"string\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e...\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading symbols from /usr/bin/python...(no debugging symbols found)...\u003cspan class=\"keyword\"\u003edone\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e而后，使用 \u003ccode\u003eb\u003c/code\u003e 命令（\u003ccode\u003ebreak\u003c/code\u003e 的缩写）设置断点。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) b *doupdate + 289\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNo symbol table is loaded.  Use the \u003cspan class=\"string\"\u003e\u0026#34;file\u0026#34;\u003c/span\u003e \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e啊，出错了……这是我有意呈现的错误。通常，我们会将断点首先设置在 \u003ccode\u003emain\u003c/code\u003e 处，因为彼时符号应该都加载完毕了。而后，在程序遇到断点并暂停时，我们可以设置其他断点。此处，我需要关注 \u003ccode\u003edoupdate\u003c/code\u003e 函数，因此，我将断点首先设置在这个函数被调用的地方。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) b doupdate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFunction \u003cspan class=\"string\"\u003e\u0026#34;doupdate\u0026#34;\u003c/span\u003e not defined.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake breakpoint pending on future shared library load? (y or [n]) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1 (doupdate) pending.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) r cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eStarting program: /usr/bin/python cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, 0x00007ffff34ad2e0 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) b *doupdate + 289\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 2 at 0x7ffff34ad401\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 2, 0x00007ffff34ad401 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如此，我们就来到了目标断点位置。\u003c/p\u003e\n\u003cp\u003e这里，\u003ccode\u003er\u003c/code\u003e (\u003ccode\u003erun\u003c/code\u003e) 命令将参数传给被 GDB 跟踪的程序（这里是 \u003ccode\u003epython\u003c/code\u003e），以便执行目标 Python 脚本。因此，这里相当于执行了 \u003ccode\u003epython cachetop.py\u003c/code\u003e。\u003c/p\u003e\n\u003ch2 id=\"⑨-·-单步调试\"\u003e\u003ca href=\"#⑨-·-单步调试\" class=\"headerlink\" title=\"⑨ · 单步调试\"\u003e\u003c/a\u003e⑨ · 单步调试\u003c/h2\u003e\u003cp\u003e至此，我使用 \u003ccode\u003esi\u003c/code\u003e (\u003ccode\u003estepi\u003c/code\u003e) 命令，让程序单步地向前执行一条指令，而后检查寄存器状态。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) si\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0x00007ffff34ad408 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) i r\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erax            0x7ffff3e8f948   140737285519688\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbx            0xaea060 11444320\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ercx            0xae72a0 11432608\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdx            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersi            0x7ffff7ea8e10   140737352732176\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdi            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbp            0x7ffff3e8fb10   0x7ffff3e8fb10 \u0026lt;SP\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersp            0x7fffffffd390   0x7fffffffd390\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er8             0x7ffff36ba3e0   140737277305824\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er9             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er10            0x8  8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er11            0x202    514\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er12            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er13            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er14            0x7ffff3e8fb10   140737285520144\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er15            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erip            0x7ffff34ad408   0x7ffff34ad408 \u0026lt;doupdate+296\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eeflags         0x202    [ IF ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecs             0x33 51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ess             0x2b 43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eds             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ees             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003egs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) p/a 0x7ffff3e8f948\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable\"\u003e$1\u003c/span\u003e = 0x7ffff3e8f948 \u0026lt;cur_term\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e新的线索出现了。看起来，我们对空指针解引用的操作，发生在一个名为 \u003ccode\u003ecur_term\u003c/code\u003e 的符号当中。（\u003ccode\u003ep/a\u003c/code\u003e 是 \u003ccode\u003eprint/a\u003c/code\u003e 的缩写，其中 \u003ccode\u003e/a\u003c/code\u003e 表示随后传入的是一个内存地址）考虑到这是在调试 ncurses，那么，是不是我们的 \u003ccode\u003eTERM\u003c/code\u003e 环境设置有问题呢？\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# echo $TERM\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003exterm-256color\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e我尝试将其设为 \u003ccode\u003evt100\u003c/code\u003e，但是执行程序依旧得到了相同的段错误。\u003c/p\u003e\n\u003cp\u003e注意，此处我检查的是 \u003ccode\u003edoupdate\u003c/code\u003e 函数第一次被调用的情形，但实际上它可能被多次调用，而且问题可能出在后续的调用中。为此，我们可以让程序持续执行（\u003ccode\u003ec\u003c/code\u003e 命令），直到撞见我们期待的那次调用。然而，调用次数少的话，可能还好。若是调用多次，这就不好办了。（第 15 节将讨论这个问题）\u003c/p\u003e\n\u003ch2 id=\"十-·-单步回退\"\u003e\u003ca href=\"#十-·-单步回退\" class=\"headerlink\" title=\"十 · 单步回退\"\u003e\u003c/a\u003e十 · 单步回退\u003c/h2\u003e\u003cp\u003e单步回退是 GDB 的重要特性之一，Law 在它的演讲中也有提到。我们看一个例子。\u003c/p\u003e\n\u003cp\u003e我会重启整个 GDB 会话，从头开始演示。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCopyright (C) 2016 Free Software Foundation, Inc.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLicense GPLv3+: GNU GPL version 3 or later\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis is free software: you are free to change and redistribute it.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThere is NO WARRANTY, to the extent permitted by law.  Type \u003cspan class=\"string\"\u003e\u0026#34;show copying\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eand \u003cspan class=\"string\"\u003e\u0026#34;show warranty\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis GDB was configured as \u003cspan class=\"string\"\u003e\u0026#34;x86\\_64-linux-gnu\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;show configuration\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e configuration details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor bug reporting instructions, please see:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026lt;http://www.gnu.org/software/gdb/bugs/\u0026gt;.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind the GDB manual and other documentation resources online at:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026lt;http://www.gnu.org/software/gdb/documentation/\u0026gt;.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFor \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e, \u003cspan class=\"built_in\"\u003etype\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;apropos word\u0026#34;\u003c/span\u003e to search \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e commands related to \u003cspan class=\"string\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e...\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading symbols from /usr/bin/python...(no debugging symbols found)...\u003cspan class=\"keyword\"\u003edone\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e而后，我将断点设置在 \u003ccode\u003edoupdate\u003c/code\u003e 函数上；当遇到之后，我会打开记录功能，直到进程崩溃。这种记录功能，对系统影响是很大的。所以，最好不要从 \u003ccode\u003emain\u003c/code\u003e 函数就开始记录。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) b doupdate\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFunction \u003cspan class=\"string\"\u003e\u0026#34;doupdate\u0026#34;\u003c/span\u003e not defined.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake breakpoint pending on future shared library load? (y or [n]) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1 (doupdate) pending.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) r cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eStarting program: /usr/bin/python cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, 0x00007ffff34ad2e0 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) record\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eProgram received signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0x00007ffff34ad40d \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e至此，我就可以在代码行或者指令的意义上单步回退了。单步回退的原理，是从记录中，回放寄存器的状态。此处，我回退两个指令，而后打印寄存器状态。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) reverse-stepi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0x00007ffff34ad40d \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) reverse-stepi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0x00007ffff34ad40b \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e doupdate () from /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) i r\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erax            0x7ffff3e8f948   140737285519688\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbx            0xaea060 11444320\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ercx            0xae72a0 11432608\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdx            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersi            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdi            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbp            0x7ffff3e8fb10   0x7ffff3e8fb10 \u0026lt;SP\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersp            0x7fffffffd390   0x7fffffffd390\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er8             0x7ffff36ba3e0   140737277305824\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er9             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er10            0x8  8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er11            0x302    770\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er12            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er13            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er14            0x7ffff3e8fb10   140737285520144\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er15            0xa403d0 10748880\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erip            0x7ffff34ad40b   0x7ffff34ad40b \u0026lt;doupdate+299\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eeflags         0x202    [ IF ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecs             0x33 51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ess             0x2b 43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eds             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ees             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003egs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) p/a 0x7ffff3e8f948\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable\"\u003e$1\u003c/span\u003e = 0x7ffff3e8f948 \u0026lt;cur_term\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这次确定无疑，我们又一次定位到了 \u003ccode\u003ecur_term\u003c/code\u003e 这条线索。此时，我很想读读源码，但是首先我会试着看到更多的调试信息。\u003c/p\u003e\n\u003ch2 id=\"十一-·-调试信息\"\u003e\u003ca href=\"#十一-·-调试信息\" class=\"headerlink\" title=\"十一 · 调试信息\"\u003e\u003c/a\u003e十一 · 调试信息\u003c/h2\u003e\u003cp\u003e这里，我们需要（在 Ubuntu 上）安装 \u003ccode\u003elibncursesw\u003c/code\u003e 的调试信息包。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# apt-cache search libncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003elibncursesw5 - shared libraries \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e terminal handling (wide character support)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003elibncursesw5-dbg - debugging/profiling libraries \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e ncursesw\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003elibncursesw5-dev - developer\u003cspan class=\"string\"\u003e\u0026#39;s libraries for ncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e# dpkg -l | grep libncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64        shared libraries for terminal handling (wide character support)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e# apt-get install -y libncursesw5-dbg\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eReading package lists... Done\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eBuilding dependency tree\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eReading state information... Done\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e[...]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eAfter this operation, 2,488 kB of additional disk space will be used.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eGet:1 http://us-west-1.ec2.archive.ubuntu.com/ubuntu xenial/main amd64 libncursesw5-dbg amd64 6.0+20160213-1ubuntu1 [729 kB]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eFetched 729 kB in 0s (865 kB/s)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eSelecting previously unselected package libncursesw5-dbg.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e(Reading database ... 200094 files and directories currently installed.)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003ePreparing to unpack .../libncursesw5-dbg_6.0+20160213-1ubuntu1_amd64.deb ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eUnpacking libncursesw5-dbg (6.0+20160213-1ubuntu1) ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eSetting up libncursesw5-dbg (6.0+20160213-1ubuntu1) ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e# dpkg -l | grep libncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eii  libncursesw5:amd64                  6.0+20160213-1ubuntu1                    amd64        shared libraries for terminal handling (wide character support)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eii  libncursesw5-dbg                    6.0+20160213-1ubuntu1                    amd64        debugging/profiling libraries for ncursesw\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e赞~！此处的调试信息包与动态库的版本是一致的。现在的段错误看起来是怎样的呢？\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python` /var/cores/core.python.30520\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCore was generated by `python ./cachetop.py\u003cspan class=\"string\"\u003e\u0026#39;.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eProgram terminated with signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e1129        if (back_color_erase)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e(gdb) bt\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#1  ClrUpdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1147\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#2  doupdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1010\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#3  0x00007f0a37aa07e6 in wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_refresh.c:65\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#4  0x00007f0a37a99499 in recur_wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:384\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#5  0x00007f0a37a99616 in _nc_wgetch (win=win@entry=0x1993060, result=result@entry=0x7ffd33d93e24, use_meta=1)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:491\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#6  0x00007f0a37a9a325 in wgetch (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:672\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#7  0x00007f0a37cc6ec3 in ?? () from /usr/lib/python2.7/lib-dynload/_curses.x86_64-linux-gnu.so\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#8  0x00000000004c4d5a in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#9  0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#10 0x00000000004def08 in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#11 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#12 0x00000000004c73ec in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#13 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#14 0x00000000004caf42 in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#15 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#16 0x00000000004c2ba9 in PyEval_EvalCode ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#17 0x00000000004f20ef in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#18 0x00000000004eca72 in PyRun_FileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#19 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#20 0x000000000049e18a in Py_Main ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#21 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 \u0026lt;main\u0026gt;, argc=2, argv=0x7ffd33d94838, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#22 0x000000000049da19 in _start ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e调用栈看起来稍微有些不一样了。发生段错误的地方，实际是在 \u003ccode\u003eClrBlank()\u003c/code\u003e 函数当中。它首先被内联到 \u003ccode\u003eClrUpdate()\u003c/code\u003e 当中，最后内联到 \u003ccode\u003edoupdate()\u003c/code\u003e 当中。\u003c/p\u003e\n\u003cp\u003e至此，我真的要读读代码了。\u003c/p\u003e\n\u003ch2 id=\"十二-·-源代码\"\u003e\u003ca href=\"#十二-·-源代码\" class=\"headerlink\" title=\"十二 · 源代码\"\u003e\u003c/a\u003e十二 · 源代码\u003c/h2\u003e\u003cp\u003e有了调试信息包，GDB 可以将源代码和汇编码打印在一起。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) disas/s\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eDump of assembler code \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e doupdate:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e759 {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e0 \u0026lt;+0\u0026gt;:   push   %r15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e2 \u0026lt;+2\u0026gt;:   push   %r14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e4 \u0026lt;+4\u0026gt;:   push   %r13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac2e6 \u0026lt;+6\u0026gt;:   push   %r12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3dd \u0026lt;+253\u0026gt;: jne    0x7f0a37aac6ca \u0026lt;doupdate+1002\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1009        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (CurScreen(SP_PARM)-\u0026gt;_clear || NewScreen(SP_PARM)-\u0026gt;_clear) {   /* force refresh ? */\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3e3 \u0026lt;+259\u0026gt;: mov    0x80(%rdx),%rax\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3ea \u0026lt;+266\u0026gt;: mov    0x88(%rdx),%rcx\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3f1 \u0026lt;+273\u0026gt;: cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x21(%rax)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3f5 \u0026lt;+277\u0026gt;: jne    0x7f0a37aac401 \u0026lt;doupdate+289\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3f7 \u0026lt;+279\u0026gt;: cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x21(%rcx)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac3fb \u0026lt;+283\u0026gt;: je     0x7f0a37aacc3b \u0026lt;doupdate+2395\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac401 \u0026lt;+289\u0026gt;: mov    0x20cb68(%rip),%rax        \u003cspan class=\"comment\"\u003e# 0x7f0a37cb8f70\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac408 \u0026lt;+296\u0026gt;: mov    (%rax),%rsi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1128        NCURSES_CH_T blank = blankchar;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac40b \u0026lt;+299\u0026gt;: xor    %eax,%eax\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e=\u0026gt; 0x00007f0a37aac40d \u0026lt;+301\u0026gt;: mov    0x10(%rsi),%rdi\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac411 \u0026lt;+305\u0026gt;: cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x1c(%rdi)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   0x00007f0a37aac415 \u0026lt;+309\u0026gt;: jne    0x7f0a37aac6f7 \u0026lt;doupdate+1047\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好，依旧有 \u003ccode\u003e=\u0026gt;\u003c/code\u003e 作为出问题指令的标记，以及指令对应的代码打印在其上。那么，程序产生段错误，是因为 \u003ccode\u003eif(back_color_erase)\u003c/code\u003e 这一行代码吗？看起来似乎不太可能。段错误产生的原因是对指向非法地址的指针进行解引用，例如 \u003ccode\u003ea-\u0026gt;b\u003c/code\u003e 或者 \u003ccode\u003e*a\u003c/code\u003e。但在此处，\u003ccode\u003eback_color_erase\u003c/code\u003e 仅只是普通地访问变量，没有解引用的动作，是不会引起段错误的。\u003c/p\u003e\n\u003cp\u003e为此，我反复检查了调试信息包的版本是否匹配，而后重新在 GDB 里执行程序，但无有收获——段错误发生在同一位置。\u003c/p\u003e\n\u003cp\u003e那么，是不是 \u003ccode\u003eback_color_erase\u003c/code\u003e 本身有什么特别之处呢？现在我们在 \u003ccode\u003eClrBlank\u003c/code\u003e 函数中，我试着列出它的源代码。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) list ClrBlank\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1124\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1125    static NCURSES_INLINE NCURSES_CH_T\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1126    ClrBlank(NCURSES_SP_DCLx WINDOW *win)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1127    {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1128        NCURSES_CH_T blank = blankchar;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1130        AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) \u0026amp; BCE_ATTRS));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1131        \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e blank;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1132    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1133\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e呃……\u003ccode\u003eback_color_erase\u003c/code\u003e 在函数里是未定义的，看起来是一个全局变量？\u003c/p\u003e\n\u003ch2 id=\"十三-·-TUI\"\u003e\u003ca href=\"#十三-·-TUI\" class=\"headerlink\" title=\"十三 · TUI\"\u003e\u003c/a\u003e十三 · TUI\u003c/h2\u003e\u003cp\u003eTUI 是 text user interface（文本用户界面）的缩写。这一界面我甚少使用，我也是听过 Law 的讲座之后受到的启发。\u003c/p\u003e\n\u003cp\u003e为此，你需要在 GDB 启动的时候，传入 \u003ccode\u003e--tui\u003c/code\u003e 参数。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb --tui `which python` /var/cores/core.python.30520\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   ┌───────────────────────────────────────────────────────────────────────────┐\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │             [ No Source Available ]                                       │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │                                                                           │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   └───────────────────────────────────────────────────────────────────────────┘\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNone No process In:                                                L??   PC: ??\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCopyright (C) 2016 Free Software Foundation, Inc.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eLicense GPLv3+: GNU GPL version 3 or later\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis is free software: you are free to change and redistribute it.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThere is NO WARRANTY, to the extent permitted by law.  Type \u003cspan class=\"string\"\u003e\u0026#34;show copying\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eand \u003cspan class=\"string\"\u003e\u0026#34;show warranty\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e details.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThis GDB was configured as \u003cspan class=\"string\"\u003e\u0026#34;x86_64-linux-gnu\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e---Type  to \u003cspan class=\"built_in\"\u003econtinue\u003c/span\u003e, or q  to quit---\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eGDB 抱怨说没能找到 Python 的源代码。诚然，我可以去解决这个问题，然而，现在进程崩溃的位置是在 \u003ccode\u003elibncursesw\u003c/code\u003e，费劲去解决这个问题就没必要了。因此，按下回车，使其继续加载，并读入 \u003ccode\u003elibncursesw\u003c/code\u003e 的调试信息。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e   ┌──/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c──────┐\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1124                                                                       │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1125    static NCURSES_INLINE NCURSES_CH_T                                 │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1126    ClrBlank(NCURSES_SP_DCLx WINDOW *win)                              │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1127    {                                                                  │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1128        NCURSES_CH_T blank = blankchar;                                │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u0026gt;│1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)                                          │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1130            AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) \u0026amp; BCE_ATTRS)│\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1131        \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e blank;                                                  │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1132    }                                                                  │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1133                                                                       │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1134    /*                                                                 │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1135    **      ClrUpdate()                                                │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1136    **                                                                 │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   └───────────────────────────────────────────────────────────────────────────┘\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003emulti-thre Thread 0x7f0a3c5e87 In: doupdate            L1129 PC: 0x7f0a37aac40d\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target ar\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003echitecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e---Type \u0026lt;\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e\u0026gt; to \u003cspan class=\"built_in\"\u003econtinue\u003c/span\u003e, or q \u0026lt;\u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e\u0026gt; to quit---\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCore was generated by `python ./cachetop.py\u003cspan class=\"string\"\u003e\u0026#39;.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eProgram terminated with signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#0  ClrBlank (win=0x1993060)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e(gdb)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e棒呆！\u003c/p\u003e\n\u003cp\u003e箭头 \u003ccode\u003e\u0026gt;\u003c/code\u003e 指向的代码就是程序崩溃的位置。使用 \u003ccode\u003elayout split\u003c/code\u003e 命令，可以让汇编指令和源代码分开显示。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e   ┌──/build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c──────┐\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u0026gt;│1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)                                          │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1130            AddAttr(blank, (AttrOf(BCE_BKGD(SP_PARM, win)) \u0026amp; BCE_ATTRS)│\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1131        \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e blank;                                                  │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1132    }                                                                  │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1133                                                                       │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1134    /*                                                                 │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │1135    **      ClrUpdate()                                                │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   └───────────────────────────────────────────────────────────────────────────┘\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u0026gt;│0x7f0a37aac40d \u0026lt;doupdate+301\u0026gt;   mov    0x10(%rsi),%rdi                     │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac411 \u0026lt;doupdate+305\u0026gt;   cmpb   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x1c(%rdi)                     │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac415 \u0026lt;doupdate+309\u0026gt;   jne    0x7f0a37aac6f7 \u0026lt;doupdate+1047\u0026gt;      │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac41b \u0026lt;doupdate+315\u0026gt;   movswl 0x4(%rcx),%ecx                      │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac41f \u0026lt;doupdate+319\u0026gt;   movswl 0x74(%rdx),%edi                     │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac423 \u0026lt;doupdate+323\u0026gt;   mov    %rax,0x40(%rsp)                     │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac428 \u0026lt;doupdate+328\u0026gt;   movl   \u003cspan class=\"variable\"\u003e$0x20\u003c/span\u003e,0x48(%rsp)                    │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   │0x7f0a37aac430 \u0026lt;doupdate+336\u0026gt;   movl   \u003cspan class=\"variable\"\u003e$0x0\u003c/span\u003e,0x4c(%rsp)                     │\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   └───────────────────────────────────────────────────────────────────────────┘\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003emulti-thre Thread 0x7f0a3c5e87 In: doupdate            L1129 PC: 0x7f0a37aac40d\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003echitecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCore was generated by `python ./cachetop.py\u003cspan class=\"string\"\u003e\u0026#39;.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eProgram terminated with signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e---Type \u0026lt;return\u0026gt; to continue, or q \u0026lt;return\u0026gt; to quit---\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e#0  ClrBlank (win=0x1993060)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003e(gdb) layout split\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eLaw 在单步回退中展示了如何使用 TUI。你可以想象一下，在代码执行的过程中，同时呈现汇编码和源代码是怎样的光景。\u003c/p\u003e\n\u003ch2 id=\"十四-·-外部工具：cscope\"\u003e\u003ca href=\"#十四-·-外部工具：cscope\" class=\"headerlink\" title=\"十四 · 外部工具：cscope\"\u003e\u003c/a\u003e十四 · 外部工具：\u003ccode\u003ecscope\u003c/code\u003e\u003c/h2\u003e\u003cp\u003e我依然需要搞清楚 \u003ccode\u003eback_color_erase\u003c/code\u003e 到底发生了什么。当然，我可以在 GDB 中使用 \u003ccode\u003esearch\u003c/code\u003e 命令，查找 \u003ccode\u003eback_color_erase\u003c/code\u003e 是在哪里定义的。不过，我更偏好使用名为 \u003ccode\u003ecscope\u003c/code\u003e 的外部工具。这是一个贝尔实验室在上世纪 80 年代发明的基于文本的代码浏览器。如果你有喜欢的现代 IDE 工具，那么就用你喜欢的就好。\u003c/p\u003e\n\u003cp\u003e首先，设置 \u003ccode\u003ecscope\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# apt-get install -y cscope\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# wget http://archive.ubuntu.com/ubuntu/pool/main/n/ncurses/ncurses_6.0+20160213.orig.tar.gz\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# tar xvf ncurses_6.0+20160213.orig.tar.gz\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# cd ncurses-6.0-20160213\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# cscope -bqR\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# cscope -dq\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此处 \u003ccode\u003ecscope -bqR\u003c/code\u003e 创建了查找数据库，而 \u003ccode\u003ecscope -dq\u003c/code\u003e 则启动之。\u003c/p\u003e\n\u003cp\u003e搜索 \u003ccode\u003eback_color_erase\u003c/code\u003e 的定义：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eCscope version 15.8b                                   Press the ? key \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this C symbol:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this global definition: back_color_erase\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind \u003cspan class=\"built_in\"\u003efunctions\u003c/span\u003e called by this \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind \u003cspan class=\"built_in\"\u003efunctions\u003c/span\u003e calling this \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this text string:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eChange this text string:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this egrep pattern:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this file:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind files \u003cspan class=\"comment\"\u003e#including this file:\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind assignments to this symbol:\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e敲回车。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e non_dest_scroll_region         CUR Booleans[26]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e can_change                     CUR Booleans[27]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e back_color_erase               CUR Booleans[28]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e hue_lightness_saturation       CUR Booleans[29]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e col_addr_glitch                CUR Booleans[30]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e cr_cancels_micro_mode          CUR Booleans[31]\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好吧……这是一个用 \u003ccode\u003e#define\u003c/code\u003e 定义的宏变量。（就不能大写吗？摔！）\u003c/p\u003e\n\u003cp\u003e那么，\u003ccode\u003eCUR\u003c/code\u003e 又是什么呢？我们继续搜索。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e CUR cur_term-\u0026gt;type.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好嘛，至少这个 \u003ccode\u003e#define\u003c/code\u003e 定义的宏是大写的。\u003c/p\u003e\n\u003cp\u003e碰见 \u003ccode\u003ecur_term\u003c/code\u003e 了——之前我们在单步调试汇编指令和检查寄存器状态的时候有看到过它。那么它是啥咧？\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e 0 \u0026amp;\u0026amp; !0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eextern\u003c/span\u003e \u003cspan class=\"title\"\u003eNCURSES_EXPORT_VAR\u003c/span\u003e\u003cspan class=\"params\"\u003e(TERMINAL *)\u003c/span\u003e cur_term\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eelif\u003c/span\u003e 0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eNCURSES_WRAPPED_VAR\u003c/span\u003e(TERMINAL *, cur_term);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e cur_term   NCURSES_PUBLIC_VAR(cur_term())\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eextern\u003c/span\u003e \u003cspan class=\"title\"\u003eNCURSES_EXPORT_VAR\u003c/span\u003e\u003cspan class=\"params\"\u003e(TERMINAL *)\u003c/span\u003e cur_term\u003c/span\u003e;     \u003cspan class=\"comment\"\u003e// \u0026lt;- here\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eendif\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003ecscope\u003c/code\u003e 在 \u003ccode\u003e/usr/include/term.h\u003c/code\u003e 中找到了它。我在我认为真正起作用的定义处，用注释做了标记。为什么会有 \u003ccode\u003eif 0 \u0026amp;\u0026amp; !0 ... elif 0\u003c/code\u003e 这种那奇怪的写法，我也不知道……（但总之要阅读更多的代码）有时，程序员会使用 \u003ccode\u003e#if 0\u003c/code\u003e 使调试用代码在生产环境中不生效。但这部分代码，看上去是自动生成的。\u003c/p\u003e\n\u003cp\u003e继续搜索 \u003ccode\u003eNCURSES_EXPORT_VAR\u003c/code\u003e，会有新的发现。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#  \u003cspan class=\"keyword\"\u003edefine\u003c/span\u003e NCURSES_EXPORT_VAR(type) NCURSES_IMPEXP type\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e以及 \u003ccode\u003eNCURSES_IMPEXP\u003c/code\u003e……\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003etypedef\u003c/span\u003e \u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title class_\"\u003eterm\u003c/span\u003e {       \u003cspan class=\"comment\"\u003e/* describe an actual terminal */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    TERMTYPE    type;       \u003cspan class=\"comment\"\u003e/* terminal type description */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003eshort\u003c/span\u003e   Filedes;    \u003cspan class=\"comment\"\u003e/* file description being written to */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    TTY     Ottyb,      \u003cspan class=\"comment\"\u003e/* original state of the terminal */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        Nttyb;      \u003cspan class=\"comment\"\u003e/* current state of the terminal */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003eint\u003c/span\u003e     _baudrate;  \u003cspan class=\"comment\"\u003e/* used to compute padding */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003echar\u003c/span\u003e *      _termname;      \u003cspan class=\"comment\"\u003e/* used for termname() */\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e} TERMINAL;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e哈！这回 \u003ccode\u003eTERMINAL\u003c/code\u003e 是大写的了。在这坨宏当中，这算是容易追踪的了。\u003c/p\u003e\n\u003cp\u003e好了，现在到底是谁设置了 \u003ccode\u003ecur_term\u003c/code\u003e 呢？想想看，我们遇到的问题，是因为 \u003ccode\u003ecur_term\u003c/code\u003e 被设置为 \u003ccode\u003e0x0\u003c/code\u003e，这可能是没有初始化导致的，也有可能是显式设置导致的。顺着代码检查，可能会有新的线索。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003eFind this C symbol: cur_term\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind this global definition:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind \u003cspan class=\"built_in\"\u003efunctions\u003c/span\u003e called by this \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFind \u003cspan class=\"built_in\"\u003efunctions\u003c/span\u003e calling this \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e按下回车，得到结果。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eNCURSES_EXPORT\u003c/span\u003e(TERMINAL *)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eNCURSES_SP_NAME\u003c/span\u003e(set_curterm) (NCURSES_SP_DCLx TERMINAL * termp)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    TERMINAL *oldterm;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eT\u003c/span\u003e((\u003cspan class=\"built_in\"\u003eT_CALLED\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;set_curterm(%p)\u0026#34;\u003c/span\u003e), (\u003cspan class=\"type\"\u003evoid\u003c/span\u003e *) termp));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    _nc_lock_global(curses);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    oldterm = cur_term;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (SP_PARM)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    SP_PARM-\u0026gt;_term = termp;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e USE_REENTRANT\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    CurTerm = termp;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    cur_term = termp;   \u003cspan class=\"comment\"\u003e// \u0026lt;- here\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003eendif\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e同样，我对实际生效的部分做了标记。尽管函数名字被包在宏变量当中，但是我们至少知道 \u003ccode\u003ecur_term\u003c/code\u003e 是如何设置的了——通过 \u003ccode\u003eset_curterm()\u003c/code\u003e 函数。这个函数是没有被调用吗？\u003c/p\u003e\n\u003ch2 id=\"十五-·-外部工具：perf-tools-ftrace-uprobes\"\u003e\u003ca href=\"#十五-·-外部工具：perf-tools-ftrace-uprobes\" class=\"headerlink\" title=\"十五 · 外部工具：perf-tools/ftrace/uprobes\"\u003e\u003c/a\u003e十五 · 外部工具：\u003ccode\u003eperf-tools/ftrace/uprobes\u003c/code\u003e\u003c/h2\u003e\u003cp\u003e我稍后将介绍如何使用 GDB 解决这个问题，但我想试着用我的 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/brendangregg/perf-tools\"\u003eperf-tools\u003c/a\u003e 工具集当中的 \u003ccode\u003euprobe\u003c/code\u003e 工具来解决问题。它使用了 Linux 提供的 \u003ccode\u003eftrace\u003c/code\u003e 以及 \u003ccode\u003euprobes\u003c/code\u003e 两个工具。使用跟踪器的好处是不需要像 GDB 那样暂停目标进程——当然，在这个例子里这没所谓就是了。此外，使用跟踪器追踪一个事件和追踪成百上千个事件是一样的。\u003c/p\u003e\n\u003cp\u003e为此，我需要追踪 \u003ccode\u003eset_curterm\u003c/code\u003e 的调用，并且打印其首个参数。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# /apps/perf-tools/bin/uprobe \u0026#39;p:/lib/x86_64-linux-gnu/libncursesw.so.5:set_curterm %di\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eERROR: missing symbol \u003cspan class=\"string\"\u003e\u0026#34;set_curterm\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e /lib/x86_64-linux-gnu/libncursesw.so.5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好吧，在 \u003ccode\u003elibncursesw\u003c/code\u003e 里没见着有 \u003ccode\u003eset_curterm\u003c/code\u003e。那么它在哪里呢？我们可以用 GDB 或者 \u003ccode\u003eobjdump\u003c/code\u003e 查找一下。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) info symbol set_curterm\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eset_curterm \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e section .text of /lib/x86_64-linux-gnu/libtinfo.so.5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# objdump -tT /lib/x86_64-linux-gnu/libncursesw.so.5 | grep cur_term\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0000000000000000      DO *UND*  0000000000000000  NCURSES_TINFO_5.0.19991023 cur_term\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# objdump -tT /lib/x86_64-linux-gnu/libtinfo.so.5 | grep cur_term\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0000000000228948 g    DO .bss   0000000000000008  NCURSES_TINFO_5.0.19991023 cur_term\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e显而易见，在此处 GDB 更好使些。如果你足够仔细的话，你会发现，这个函数定义在 \u003ccode\u003elibtinfo\u003c/code\u003e 当中。那么，让我们尝试在 \u003ccode\u003elibtinfo\u003c/code\u003e　中去追踪 \u003ccode\u003eset_curterm\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# /apps/perf-tools/bin/uprobe \u0026#39;p:/lib/x86_64-linux-gnu/libtinfo.so.5:set_curterm %di\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eTracing uprobe set_curterm (p:set_curterm /lib/x86_64-linux-gnu/libtinfo.so.5:0xfa80 %di). Ctrl-C to end.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          python-31617 [007] d... 24236402.719959: set_curterm: (0x7f116fcc2a80) arg1=0x1345d70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          python-31617 [007] d... 24236402.720033: set_curterm: (0x7f116fcc2a80) arg1=0x13a22e0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          python-31617 [007] d... 24236402.723804: set_curterm: (0x7f116fcc2a80) arg1=0x14cdfa0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          python-31617 [007] d... 24236402.723838: set_curterm: (0x7f116fcc2a80) arg1=0x0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e^C\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这会没问题了。显而易见，\u003ccode\u003eset_curterm\u003c/code\u003e 确实是有被调用的，并且被调用了 4 次。在最后一次调用时（之后进程就崩溃了），第一个参数是 \u003ccode\u003e0x0\u003c/code\u003e，看起来似乎就是问题所在了。\u003c/p\u003e\n\u003cp\u003e至于为什么要打印 \u003ccode\u003e%di\u003c/code\u003e 这个寄存器中的值，是因为我们的程序运行在 \u003ccode\u003ex86_64\u003c/code\u003e 平台。使用 \u003ccode\u003eman syscall\u003c/code\u003e 可以看到有用的信息。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# man syscall\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       \u003cspan class=\"built_in\"\u003earch\u003c/span\u003e/ABI      arg1  arg2  arg3  arg4  arg5  arg6  arg7  Notes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       ──────────────────────────────────────────────────────────────────\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       arm/OABI      a1    a2    a3    a4    v1    v2    v3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       arm/EABI      r0    r1    r2    r3    r4    r5    r6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       arm64         x0    x1    x2    x3    x4    x5    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       blackfin      R0    R1    R2    R3    R4    R5    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       i386          ebx   ecx   edx   esi   edi   ebp   -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       ia64          out0  out1  out2  out3  out4  out5  -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       mips/o32      a0    a1    a2    a3    -     -     -     See below\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       mips/n32,64   a0    a1    a2    a3    a4    a5    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       parisc        r26   r25   r24   r23   r22   r21   -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       s390          r2    r3    r4    r5    r6    r7    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       s390x         r2    r3    r4    r5    r6    r7    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       sparc/32      o0    o1    o2    o3    o4    o5    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       sparc/64      o0    o1    o2    o3    o4    o5    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       x86_64        rdi   rsi   rdx   r10   r8    r9    -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e我还想去看看为什么会在调用 \u003ccode\u003eset_curterm\u003c/code\u003e 时传入 \u003ccode\u003e0x0\u003c/code\u003e 作为参数，不过当前 \u003ccode\u003eftrace\u003c/code\u003e 不支持调用栈的查询。\u003c/p\u003e\n\u003ch2 id=\"十六-·-外部工具：bcc-x2F-BPF\"\u003e\u003ca href=\"#十六-·-外部工具：bcc-x2F-BPF\" class=\"headerlink\" title=\"十六 · 外部工具：bcc/BPF\"\u003e\u003c/a\u003e十六 · 外部工具：\u003ccode\u003ebcc\u003c/code\u003e/BPF\u003c/h2\u003e\u003cp\u003e考虑到我们正在调试 \u003ccode\u003ebcc\u003c/code\u003e 工具 \u003ccode\u003ecachetop.py\u003c/code\u003e，那么使用 \u003ccode\u003ebcc\u003c/code\u003e 提供的 \u003ccode\u003etrace.py\u003c/code\u003e 来追踪函数调用是个不错的选择。它和刚才的 \u003ccode\u003euprobe\u003c/code\u003e 工具有类似的功能。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# ./trace.py \u0026#39;p:tinfo:set_curterm \u0026#34;%d\u0026#34;, arg1\u0026#39;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eTIME     PID    COMM         FUNC             -\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e01:00:20 31698  python       set_curterm      38018416\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e01:00:20 31698  python       set_curterm      38396640\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e01:00:20 31698  python       set_curterm      39624608\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e01:00:20 31698  python       set_curterm      0\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e没错！我们在用 \u003ccode\u003ebcc\u003c/code\u003e 来调试 \u003ccode\u003ebcc\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e如果你之前未曾使用过 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/iovisor/bcc\"\u003e\u003ccode\u003ebcc\u003c/code\u003e\u003c/a\u003e，那么我推荐你试试看。它有面向 Python 和 Lua 的接口，提供了在 Linux 4.x 系列中的 BPF 跟踪特性。简单来说，它让很多以前无法或者难以实现的性能工具变得可行。在 \u003ca target=\"_blank\" rel=\"noopener\" href=\"http://www.brendangregg.com/blog/2016-06-14/ubuntu-xenial-bcc-bpf.html\"\u003eUbuntu Xenial\u003c/a\u003e 上有我关于此的介绍。\u003c/p\u003e\n\u003ch2 id=\"十七-·-更多的断点\"\u003e\u003ca href=\"#十七-·-更多的断点\" class=\"headerlink\" title=\"十七 · 更多的断点\"\u003e\u003c/a\u003e十七 · 更多的断点\u003c/h2\u003e\u003cp\u003e我本该用 GDB 给 \u003ccode\u003eset_curterm\u003c/code\u003e 设置断点的，但是绕道去 \u003ccode\u003eftrace\u003c/code\u003e 和 BPF 也时很有趣的事情。\u003c/p\u003e\n\u003cp\u003e回到 GDB。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) b set_curterm\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFunction \u003cspan class=\"string\"\u003e\u0026#34;set_curterm\u0026#34;\u003c/span\u003e not defined.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake breakpoint pending on future shared library load? (y or [n]) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1 (set_curterm) pending.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) r cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eStarting program: /usr/bin/python cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xab5870) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xbecb90) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好了，在断点处，我们看到 \u003ccode\u003eset_curterm\u003c/code\u003e 被传入了参数 \u003ccode\u003etermp=0x0\u003c/code\u003e。幸好能有这些调试信息，否则，我就不得不在各个断点去打印寄存器状态了。\u003c/p\u003e\n\u003cp\u003e现在，查看逆向追溯调用栈，应当可以看到是哪个函数将 \u003ccode\u003e0x0\u003c/code\u003e 传给了 \u003ccode\u003eset_curterm\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) bt\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#1  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#2  0x00007ffff45cabb8 in clang::driver::tools::Clang::ConstructJob(clang::driver::Compilation\u0026amp;, clang::driver::JobAction const\u0026amp;, clang::driver::InputInfo const\u0026amp;, llvm::SmallVector\u0026lt;clang::driver::InputInfo, 4u\u0026gt; const\u0026amp;, llvm::opt::ArgList const\u0026amp;, char const*) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#3  0x00007ffff456ffa5 in clang::driver::Driver::BuildJobsForAction(clang::driver::Compilation\u0026amp;, clang::driver::Action const*, clang::driver::ToolChain const*, char const*, bool, bool, char const*, clang::driver::InputInfo\u0026amp;) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#4  0x00007ffff4570501 in clang::driver::Driver::BuildJobs(clang::driver::Compilation\u0026amp;) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#5  0x00007ffff457224a in clang::driver::Driver::BuildCompilation(llvm::ArrayRef\u0026lt;char const*\u0026gt;) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#6  0x00007ffff4396cda in ebpf::ClangLoader::parse(std::unique_ptr\u0026lt;llvm::Module, std::default_delete\u0026lt;llvm::Module\u0026gt; \u0026gt;*, std::unique_ptr\u0026lt;std::vector\u0026lt;ebpf::TableDesc, std::allocator\u0026lt;ebpf::TableDesc\u0026gt; \u0026gt;, std::default_delete\u0026lt;std::vector\u0026lt;ebpf::TableDesc, std::allocator\u0026lt;ebpf::TableDesc\u0026gt; \u0026gt; \u0026gt; \u0026gt;*, std::__cxx11::basic_string\u0026lt;char, std::char_traits\u0026lt;char\u0026gt;, std::allocator\u0026lt;char\u0026gt; \u0026gt; const\u0026amp;, bool, char const**, int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#7  0x00007ffff4344314 in ebpf::BPFModule::load_cfile(std::__cxx11::basic_string\u0026lt;char, std::char_traits\u0026lt;char\u0026gt;, std::allocator\u0026lt;char\u0026gt; \u0026gt; const\u0026amp;, bool, char const**, int) ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#8  0x00007ffff4349e5e in ebpf::BPFModule::load_string(std::__cxx11::basic_string\u0026lt;char, std::char_traits\u0026lt;char\u0026gt;, std::allocator\u0026lt;char\u0026gt; \u0026gt; const\u0026amp;, char const**, int) ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#9  0x00007ffff43430c8 in bpf_module_create_c_from_string () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#10 0x00007ffff690ae40 in ffi_call_unix64 () from /usr/lib/x86_64-linux-gnu/libffi.so.6\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#11 0x00007ffff690a8ab in ffi_call () from /usr/lib/x86_64-linux-gnu/libffi.so.6\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#12 0x00007ffff6b1a68c in _ctypes_callproc () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#13 0x00007ffff6b1ed82 in ?? () from /usr/lib/python2.7/lib-dynload/_ctypes.x86_64-linux-gnu.so\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#14 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#15 0x00000000004ca5ca in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#16 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#17 0x00000000004def08 in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#18 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#19 0x00000000004f4c3e in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#20 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#21 0x00000000004f49b7 in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#22 0x00000000004b6e2c in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#23 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#24 0x00000000004ca5ca in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#25 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#26 0x00000000004def08 in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#27 0x00000000004b1153 in PyObject_Call ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#28 0x00000000004c73ec in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#29 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#30 0x00000000004caf42 in PyEval_EvalFrameEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#31 0x00000000004c2e05 in PyEval_EvalCodeEx ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#32 0x00000000004c2ba9 in PyEval_EvalCode ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#33 0x00000000004f20ef in ?? ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#34 0x00000000004eca72 in PyRun_FileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#35 0x00000000004eb1f1 in PyRun_SimpleFileExFlags ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#36 0x000000000049e18a in Py_Main ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#37 0x00007ffff7811830 in __libc_start_main (main=0x49daf0 \u0026lt;main\u0026gt;, argc=2, argv=0x7fffffffdfb8, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    stack_end=0x7fffffffdfa8) at ../csu/libc-start.c:291\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#38 0x000000000049da19 in _start ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e唔……这回有更多信息了。\u003ccode\u003eset_curterm\u003c/code\u003e 是被 \u003ccode\u003ellvm::sys::Process::FileDescriptorHasColors()\u003c/code\u003e 调用的，\u003ccode\u003ellvm\u003c/code\u003e 编译器有问题？\u003c/p\u003e\n\u003ch2 id=\"十八-·-外部工具：再次使用-cscope\"\u003e\u003ca href=\"#十八-·-外部工具：再次使用-cscope\" class=\"headerlink\" title=\"十八 · 外部工具：再次使用 cscope\"\u003e\u003c/a\u003e十八 · 外部工具：再次使用 \u003ccode\u003ecscope\u003c/code\u003e\u003c/h2\u003e\u003cp\u003e这回，我们需要使用 \u003ccode\u003ecscope\u003c/code\u003e 看看 \u003ccode\u003ellvm\u003c/code\u003e 的代码。\u003ccode\u003eFileDescriptorHasColors\u003c/code\u003e 函数是酱婶的。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003estatic\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eterminalHasColors\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003eint\u003c/span\u003e fd)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// Now extract the structure allocated by setupterm and free its memory\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// through a really silly dance.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title class_\"\u003eterm\u003c/span\u003e *termp = \u003cspan class=\"built_in\"\u003eset_curterm\u003c/span\u003e((\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e term *)\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  (\u003cspan class=\"type\"\u003evoid\u003c/span\u003e)\u003cspan class=\"built_in\"\u003edel_curterm\u003c/span\u003e(termp); \u003cspan class=\"comment\"\u003e// Drop any errors here.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在早先的版本里，该函数是这样定义的。\u003c/p\u003e\n\u003cfigure class=\"highlight c++\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003estatic\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eterminalHasColors\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e *term = std::\u003cspan class=\"built_in\"\u003egetenv\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;TERM\u0026#34;\u003c/span\u003e)) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// Most modern terminals support ANSI escape sequences for colors.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// We could check terminfo, or have a list of known terms that support\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// colors, but that would be overkill.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// The user can always ask for no colors by setting TERM to dumb, or\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// using a commandline flag.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003estrcmp\u003c/span\u003e(term, \u003cspan class=\"string\"\u003e\u0026#34;dumb\u0026#34;\u003c/span\u003e) != \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/llvm-mirror/llvm/commit/d485e7bd7639cd6b39c6113a30fbc3cdc8c41c4c#diff-a4fb6575a290937bc9142e3d7efc8989\"\u003e给 \u003ccode\u003eset_curterm\u003c/code\u003e 传入 \u003ccode\u003enullptr\u003c/code\u003e\u003c/a\u003e 着实是个坏主意。\u003c/p\u003e\n\u003ch2 id=\"十九-·-复写内存\"\u003e\u003ca href=\"#十九-·-复写内存\" class=\"headerlink\" title=\"十九 · 复写内存\"\u003e\u003c/a\u003e十九 · 复写内存\u003c/h2\u003e\u003cp\u003e为了确定嫌疑，同时试着看看有没有可能的临时解决方案，我会尝试在异常调用 \u003ccode\u003eset_curterm\u003c/code\u003e 时复写修改内存。\u003c/p\u003e\n\u003cp\u003e首先，我们在 GDB 里跟踪程序，并在 \u003ccode\u003eset_curterm\u003c/code\u003e 处设置断点，直到调用它时传入了 \u003ccode\u003e0x0\u003c/code\u003e 作为参数。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) b set_curterm\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFunction \u003cspan class=\"string\"\u003e\u0026#34;set_curterm\u0026#34;\u003c/span\u003e not defined.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake breakpoint pending on future shared library load? (y or [n]) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1 (set_curterm) pending.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) r cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eStarting program: /usr/bin/python cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80      {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xab5870) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80      {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xbecb90) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80      {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80      {\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此时，我要使用 \u003ccode\u003eset\u003c/code\u003e 命令，复写相关的内存：使用之前传入 \u003ccode\u003eset_curterm\u003c/code\u003e 并正确执行的参数 \u003ccode\u003e0xbecb90\u003c/code\u003e 替代 \u003ccode\u003e0x0\u003c/code\u003e——当然，希望这一地址仍旧是合法的。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e警告\u003c/strong\u003e，复写内存是十分危险的！GDB 不会向你确认，「你确定吗」。如果你搞错了，或者输入时手滑了，那么进程就会崩溃。好一点的情况，进程当时就崩溃了。糟糕的情况，可能在如果按时间后才崩溃，而谁也不知道是怎么了。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e此处，我是在一台试验用机器上进行调试。因为没有敏感数据，所以我冒险一试。此处，我将用 \u003ccode\u003ep/x\u003c/code\u003e 以十六进制的形式打印寄存器 \u003ccode\u003e%rdi\u003c/code\u003e 中的内容，并用 \u003ccode\u003eset\u003c/code\u003e 命令将其设置为之前可用的值，并检查寄存器状态。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) p/x \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable\"\u003e$1\u003c/span\u003e = 0x0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) \u003cspan class=\"built_in\"\u003eset\u003c/span\u003e \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e=0xbecb90\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) p/x \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable\"\u003e$2\u003c/span\u003e = 0xbecb90\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) i r\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erax            0x100    256\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbx            0x1  1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ercx            0xe71    3697\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdx            0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersi            0x7ffff5dd45d3   140737318307283\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erdi            0xbecb90 12503952\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbp            0x100    0x100\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ersp            0x7fffffffa5b8   0x7fffffffa5b8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er8             0xbf0050 12517456\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er9             0x1999999999999999   1844674407370955161\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er10            0xbf0040 12517440\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er11            0x7ffff7bb4b78   140737349634936\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er12            0xbecb70 12503920\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er13            0xbeaea0 12496544\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er14            0x7fffffffa9a0   140737488333216\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003er15            0x7fffffffa8a0   140737488332960\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erip            0x7ffff3c76a80   0x7ffff3c76a80 \u0026lt;set_curterm\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eeflags         0x246    [ PF ZF IF ]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecs             0x33 51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ess             0x2b 43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eds             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ees             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003egs             0x0  0\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e（当然，因为有调试信息，所以我本没必要直接操作寄存器 \u003ccode\u003e%rdi\u003c/code\u003e 的值，我可以直接设置函数参数 \u003ccode\u003etermp\u003c/code\u003e 的值）\u003c/p\u003e\n\u003cp\u003e现在 \u003ccode\u003e%rdi\u003c/code\u003e 的值已经更新，其他寄存器看上去也没什么问题。于是我们让程序继续执行。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e赞！当前对 \u003ccode\u003eset_curterm\u003c/code\u003e 的调用通过了，没有引发段错误。不过，下一次调用 \u003ccode\u003eset_curterm\u003c/code\u003e 又传入了 \u003ccode\u003e0x0\u003c/code\u003e，我们故技重施。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) \u003cspan class=\"built_in\"\u003eset\u003c/span\u003e \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e=0xbecb90\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewarning: JITed object file architecture unknown is not compatible with target architecture i386:x86-64.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eProgram received signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0x00007ffff34ad411 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e ClrBlank (win=0xaea060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1129        \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (back_color_erase)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e啊哈！这次修改内存得到了另一个段错误。不过，虽然如此，当前的问题至少是解决了。\u003c/p\u003e\n\u003ch2 id=\"二十-·-条件断点\"\u003e\u003ca href=\"#二十-·-条件断点\" class=\"headerlink\" title=\"二十 · 条件断点\"\u003e\u003c/a\u003e二十 · 条件断点\u003c/h2\u003e\u003cp\u003e在之前的章节中，我不得不连续使用 3 次 \u003ccode\u003econtinue\u003c/code\u003e 以便到达我真正感兴趣的那次函数调用。如果相关函数被调用了上百次，那么我会考虑使用条件断点。以下是一个示例。\u003c/p\u003e\n\u003cp\u003e首先，我会如常启动程序并为 \u003ccode\u003eset_curterm\u003c/code\u003e 设置断点。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python`\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) b set_curterm\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eFunction \u003cspan class=\"string\"\u003e\u0026#34;set_curterm\u0026#34;\u003c/span\u003e not defined.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake breakpoint pending on future shared library load? (y or [n]) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1 (set_curterm) pending.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) r cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eStarting program: /usr/bin/python cachetop.py\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[Thread debugging using libthread_db enabled]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eUsing host libthread_db library \u003cspan class=\"string\"\u003e\u0026#34;/lib/x86_64-linux-gnu/libthread_db.so.1\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=termp@entry=0xa43150) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e现在，我要将断点 1 转换为条件断点，使其只在 \u003ccode\u003e%rdi\u003c/code\u003e 的值为 \u003ccode\u003e0x0\u003c/code\u003e 时生效。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) cond 1 \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e==0x0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) i b\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNum     Type           Disp Enb Address            What\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e1       breakpoint     keep y   0x00007ffff3c76a80 \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e set_curterm at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    stop only \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"variable\"\u003e$rdi\u003c/span\u003e==0x0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    breakpoint already hit 1 time\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e吼啊！通过使用 \u003ccode\u003econd\u003c/code\u003e (\u003ccode\u003econditional\u003c/code\u003e)，我将断点 1 设置为条件断点。因此，当断点 1 下一次生效时，就是 \u003ccode\u003eset_curterm\u003c/code\u003e 接受的第一个参数值为 \u003ccode\u003e0x0\u003c/code\u003e 的时候。此外，我用了 \u003ccode\u003ei b\u003c/code\u003e (\u003ccode\u003einfo breakpoints\u003c/code\u003e) 列出了所有断点的信息。\u003c/p\u003e\n\u003cp\u003e这里需要考虑，为什么我不在设置断点后的第一时间就将其设置为条件断点。这是因为，我发现对于程序尚未执行时设置的被延迟的断点来说，这些条件不会生效——至少当前的 GDB 版本是这样。（也有可能是我搞错了）\u003c/p\u003e\n\u003ch2 id=\"廿一-·-直接返回\"\u003e\u003ca href=\"#廿一-·-直接返回\" class=\"headerlink\" title=\"廿一 · 直接返回\"\u003e\u003c/a\u003e廿一 · 直接返回\u003c/h2\u003e\u003cp\u003e我也曾尝试了另一个和复写内存类似的方案。不过，这次我不打算修改内存中的数据，而是修改指令。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e\u003cstrong\u003e警告\u003c/strong\u003e：先前的警告在此处同样适用。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e我将如先前一样，停在 \u003ccode\u003eset_curterm\u003c/code\u003e 的 \u003ccode\u003e0x0\u003c/code\u003e 调用处，而后适用 GDB 的 \u003ccode\u003eret\u003c/code\u003e (\u003ccode\u003ereturn\u003c/code\u003e) 命令跳过函数的执行，直接返回。此处的考量是，如果函数未执行，则全局变量 \u003ccode\u003ecurterm\u003c/code\u003e 不会被设置为 \u003ccode\u003e0x0\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) ret\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake set_curterm \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e now? (y or n) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eProgram received signal SIGSEGV, Segmentation fault.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                                                    _nc_free_termtype (ptr=ptr@entry=0x100) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/free_ttype.c:52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52      FreeIfNeeded(ptr-\u0026gt;str_table);\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e好嘛，进程又挂了……这是进程崩掉之后的状态。\u003c/p\u003e\n\u003cp\u003e度过更多代码之后，我决定再试试看。我想试着连续执行两次 \u003ccode\u003eret\u003c/code\u003e，以免 \u003ccode\u003eset_curterm\u003c/code\u003e 的调用者被不完整的调用搞坏了。再次强调：这只是一个非常 hacky 的实验，在生产环境中请慎重执行。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eContinuing.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eBreakpoint 1, set_curterm (termp=0x0) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tinfo/lib_cur_term.c:80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) ret\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake set_curterm \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e now? (y or n) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  0x00007ffff5a44e75 in llvm::sys::Process::FileDescriptorHasColors(int) () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) ret\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMake selected stack frame \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e now? (y or n) y\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  0x00007ffff45cabb8 in clang::driver::tools::Clang::ConstructJob(clang::driver::Compilation\u0026amp;, clang::driver::JobAction const\u0026amp;, clang::driver::InputInfo const\u0026amp;, llvm::SmallVector const\u0026amp;, llvm::opt::ArgList const\u0026amp;, char const*) const () from /usr/lib/x86_64-linux-gnu/libbcc.so.0\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) c\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这回，整个屏幕都白了，然后停住……之后显示出了如下结果。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e07:44:22 Buffers MB: 61 / Cached MB: 1246\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ePID      UID      CMD              HITS     MISSES   DIRTIES  READ_HIT%  WRITE_HIT%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    2742 root     systemd-logind          3       66        2       1.4%      95.7%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15836 root     kworker/u30:1           7        0        1      85.7%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    2736 messageb dbus-daemon             8       66        2       8.1%      89.2%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e       1 root     systemd                15        0        0     100.0%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    2812 syslog   rs:main Q:Reg          16       66        8       9.8%      80.5%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e     435 root     systemd-journal        32       66        8      24.5%      67.3%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    2740 root     accounts-daemon       113       66        2      62.0%      36.9%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15847 root     bash                  160        0        1      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15864 root     lesspipe              306        0        2      99.3%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15854 root     bash                  309        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15856 root     bash                  309        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15866 root     bash                  309        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15867 root     bash                  309        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15860 root     bash                  313        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15868 root     bash                  341        0        2      99.4%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15858 root     \u003cspan class=\"built_in\"\u003euname\u003c/span\u003e                 452        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15858 root     bash                  453        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15866 root     \u003cspan class=\"built_in\"\u003edircolors\u003c/span\u003e             464        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15861 root     \u003cspan class=\"built_in\"\u003ebasename\u003c/span\u003e              465        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15864 root     \u003cspan class=\"built_in\"\u003edirname\u003c/span\u003e               468        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e   15856 root     \u003cspan class=\"built_in\"\u003els\u003c/span\u003e                    476        0        2      99.6%       0.0%\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e帅！炸！搞定啦！\u003c/p\u003e\n\u003ch2 id=\"廿二-·-更好的方案\"\u003e\u003ca href=\"#廿二-·-更好的方案\" class=\"headerlink\" title=\"廿二 · 更好的方案\"\u003e\u003c/a\u003e廿二 · 更好的方案\u003c/h2\u003e\u003cp\u003e我将调试过程的结果提交在 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/iovisor/bcc/pull/615\"\u003egithub\u003c/a\u003e 上。这是因为，一方面 BPF 的首席工程师 Alexei Starovoitov 也是 llvm 方面的专家，另一方面这个问题的根源似乎是 llvm 的一个 bug。当我在把指令和数据搞得乱七八糟时，他建议我在编译 \u003ccode\u003ebcc\u003c/code\u003e 时加入 llvm 的参数 \u003ccode\u003e-fno-color-diagnostics\u003c/code\u003e 即可绕过这一问题。搞定！这确实能解决问题。因此我将其加入了 \u003ccode\u003ebcc\u003c/code\u003e 的代码库作为暂时的解决方案，并期待 llvm 解决这个 bug。\u003c/p\u003e\n\u003ch2 id=\"廿三-·-关于-Python-的环境\"\u003e\u003ca href=\"#廿三-·-关于-Python-的环境\" class=\"headerlink\" title=\"廿三 · 关于 Python 的环境\"\u003e\u003c/a\u003e廿三 · 关于 Python 的环境\u003c/h2\u003e\u003cp\u003e至此，我们已经解决了问题。不过，（译注：有强迫症的）你可能还想要让整个调用栈看起来完好。\u003c/p\u003e\n\u003cp\u003e为此，你需要安装 \u003ccode\u003epython-dbg\u003c/code\u003e 软件包。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# apt-get install -y python-dbg\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading package lists... Done\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThe following additional packages will be installed:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  libpython-dbg libpython2.7-dbg python2.7-dbg\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSuggested packages:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  python2.7-gdbm-dbg python2.7-tk-dbg python-gdbm-dbg python-tk-dbg\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eThe following NEW packages will be installed:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  libpython-dbg libpython2.7-dbg python-dbg python2.7-dbg\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e0 upgraded, 4 newly installed, 0 to remove and 20 not upgraded.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eNeed to get 11.9 MB of archives.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eAfter this operation, 36.4 MB of additional disk space will be used.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此时，再打开 GDB 看看调用栈。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# gdb `which python` /var/cores/core.python.30520\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eGNU gdb (Ubuntu 7.11.1-0ubuntu1~16.04) 7.11.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eReading symbols from /usr/bin/python...Reading symbols from /usr/lib/debug/.build-id/4e/a0539215b2a9e32602f81c90240874132c1a54.debug...done.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e[...]\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(gdb) bt\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#0  ClrBlank (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1129\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#1  ClrUpdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1147\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#2  doupdate () at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/tty/tty_update.c:1010\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#3  0x00007f0a37aa07e6 in wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_refresh.c:65\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#4  0x00007f0a37a99499 in recur_wrefresh (win=win@entry=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:384\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#5  0x00007f0a37a99616 in _nc_wgetch (win=win@entry=0x1993060, result=result@entry=0x7ffd33d93e24, use_meta=1)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:491\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#6  0x00007f0a37a9a325 in wgetch (win=0x1993060) at /build/ncurses-pKZ1BN/ncurses-6.0+20160213/ncurses/base/lib_getch.c:672\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#7  0x00007f0a37cc6ec3 in PyCursesWindow_GetCh.lto_priv.109 (self=0x7f0a3c57b198, args=()) at /build/python2.7-HpIZBG/python2.7-2.7.11/Modules/_cursesmodule.c:853\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#8  0x00000000004c4d5a in call_function (oparg=\u0026lt;optimized out\u0026gt;, pp_stack=0x7ffd33d93f30) at ../Python/ceval.c:4350\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#9  PyEval_EvalFrameEx () at ../Python/ceval.c:2987\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#10 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#11 0x00000000004def08 in function_call.lto_priv () at ../Objects/funcobject.c:523\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#12 0x00000000004b1153 in PyObject_Call () at ../Objects/abstract.c:2546\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#13 0x00000000004c73ec in ext_do_call (nk=0, na=\u0026lt;optimized out\u0026gt;, flags=\u0026lt;optimized out\u0026gt;, pp_stack=0x7ffd33d941e8, func=\u0026lt;function at remote 0x7f0a37edcc80\u0026gt;)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    at ../Python/ceval.c:4662\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#14 PyEval_EvalFrameEx () at ../Python/ceval.c:3026\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#15 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#16 0x00000000004caf42 in fast_function (nk=0, na=\u0026lt;optimized out\u0026gt;, n=\u0026lt;optimized out\u0026gt;, pp_stack=0x7ffd33d943f0, func=\u0026lt;function at remote 0x7f0a38039140\u0026gt;)\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    at ../Python/ceval.c:4445\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#17 call_function (oparg=\u0026lt;optimized out\u0026gt;, pp_stack=0x7ffd33d943f0) at ../Python/ceval.c:4370\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#18 PyEval_EvalFrameEx () at ../Python/ceval.c:2987\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#19 0x00000000004c2e05 in PyEval_EvalCodeEx () at ../Python/ceval.c:3582\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#20 0x00000000004c2ba9 in PyEval_EvalCode (co=\u0026lt;optimized out\u0026gt;, globals=\u0026lt;optimized out\u0026gt;, locals=\u0026lt;optimized out\u0026gt;) at ../Python/ceval.c:669\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#21 0x00000000004f20ef in run_mod.lto_priv () at ../Python/pythonrun.c:1376\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#22 0x00000000004eca72 in PyRun_FileExFlags () at ../Python/pythonrun.c:1362\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#23 0x00000000004eb1f1 in PyRun_SimpleFileExFlags () at ../Python/pythonrun.c:948\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#24 0x000000000049e18a in Py_Main () at ../Modules/main.c:640\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#25 0x00007f0a3be10830 in __libc_start_main (main=0x49daf0 \u0026lt;main\u0026gt;, argc=2, argv=0x7ffd33d94838, init=\u0026lt;optimized out\u0026gt;, fini=\u0026lt;optimized out\u0026gt;, rtld_fini=\u0026lt;optimized out\u0026gt;,\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    stack_end=0x7ffd33d94828) at ../csu/libc-start.c:291\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e#26 0x000000000049da19 in _start ()\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此时，所有的 \u003ccode\u003e??\u003c/code\u003e 都不见了，然而对解决我们的问题并没有什么 X 用……\u003c/p\u003e\n\u003cp\u003e此外，Python 调试软件包还加强了 GDB 的功能。我们现在可以看看 Python 的调用栈。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) py-bt\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eTraceback (most recent call first):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;./cachetop.py\u0026#34;\u003c/span\u003e, line 188, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e handle_loop\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    s = stdscr.getch()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;/usr/lib/python2.7/curses/wrapper.py\u0026#34;\u003c/span\u003e, line 43, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e wrapper\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003ereturn\u003c/span\u003e func(stdscr, *args, **kwds)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  File \u003cspan class=\"string\"\u003e\u0026#34;./cachetop.py\u0026#34;\u003c/span\u003e, line 260, \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    curses.wrapper(handle_loop, args)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e以及，我们可以看看 Python 代码是怎样的。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) py-list\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 183        b.attach_kprobe(event=\u003cspan class=\"string\"\u003e\u0026#34;mark_buffer_dirty\u0026#34;\u003c/span\u003e, fn_name=\u003cspan class=\"string\"\u003e\u0026#34;do_count\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 184\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 185        exiting = 0\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 186\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 187        \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e 1:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026gt;188            s = stdscr.getch()\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 189            \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e s == ord(\u003cspan class=\"string\"\u003e\u0026#39;q\u0026#39;\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 190                exiting = 1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 191            \u003cspan class=\"keyword\"\u003eelif\u003c/span\u003e s == ord(\u003cspan class=\"string\"\u003e\u0026#39;r\u0026#39;\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 192                sort_reverse = not sort_reverse\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e 193            \u003cspan class=\"keyword\"\u003eelif\u003c/span\u003e s == ord(\u003cspan class=\"string\"\u003e\u0026#39;\u0026lt;\u0026#39;\u003c/span\u003e):\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这能指出，在我们的 Python 代码中，究竟是那一行触发了段错误。这看起来非常棒！\u003c/p\u003e\n\u003cp\u003e之前我们在回溯调用栈时遇到的问题，其原因在于我们看到了 Python 内部在执行的方法（methods），但却看不到对应方法的符号。如果你在调试别的语言，类似的问题取决于它的编译选项和运行环境，以及执行代码是如何结束的。如果你在网上检索「语言名 GDB」，你可能会找到类似 \u003ccode\u003epython-dbg\u003c/code\u003e 这样的扩展。如果没有的话，坏消息是你必须自己写这样的软件包，但好消息是这样做是可行的。如果你是在调试 Python，那么请在网上检索「add new GDB commands in Pyhon」。\u003c/p\u003e\n\u003ch2 id=\"廿四-·-更多……\"\u003e\u003ca href=\"#廿四-·-更多……\" class=\"headerlink\" title=\"廿四 · 更多……\"\u003e\u003c/a\u003e廿四 · 更多……\u003c/h2\u003e\u003cp\u003e看起来，我似乎是要写一个完整的 GDB 指南，但显然我不是：GDB 还有很多我没讲到的东西。你可以在 GDB 中使用 \u003ccode\u003ehelp\u003c/code\u003e 命令，分门别类查看 GDB 的其他功能。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eList of classes of commands:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ealiases -- Aliases of other commands\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ebreakpoints -- Making program stop at certain points\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edata -- Examining data\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003efiles -- Specifying and examining files\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003einternals -- Maintenance commands\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eobscure -- Obscure features\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erunning -- Running the program\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estack -- Examining the stack\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estatus -- Status inquiries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esupport -- Support facilities\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etracepoints -- Tracing of program execution without stopping the program\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003euser-defined -- User-defined commands\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e followed by a class name \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e a list of commands \u003cspan class=\"keyword\"\u003ein\u003c/span\u003e that class.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;help all\u0026#34;\u003c/span\u003e \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e the list of all commands.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e followed by \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e name \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e full documentation.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;apropos word\u0026#34;\u003c/span\u003e to search \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e commands related to \u003cspan class=\"string\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCommand name abbreviations are allowed \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e unambiguous.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e对于具体某个命令来说，你也可以用 \u003ccode\u003ehelp\u003c/code\u003e 命令查看具体用法。例如说，你可以查看所有和 \u003ccode\u003ebreakpoints\u003c/code\u003e 相关的命令。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e74\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e75\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e76\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e77\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e78\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e79\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e80\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e81\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e82\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e83\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e84\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e85\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e86\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e87\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e88\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e89\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e90\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e91\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e92\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e93\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e94\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e95\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e96\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e97\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e98\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e(gdb) \u003cspan class=\"built_in\"\u003ehelp\u003c/span\u003e breakpoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMaking program stop at certain points.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eList of commands:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eawatch -- Set a watchpoint \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e an expression\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003ebreak\u003c/span\u003e -- Set breakpoint at specified location\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ebreak-range -- Set a breakpoint \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e an address range\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch -- Set catchpoints to catch events\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch assert -- Catch failed Ada assertions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch catch -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch exception -- Catch Ada exceptions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch \u003cspan class=\"built_in\"\u003eexec\u003c/span\u003e -- Catch calls to \u003cspan class=\"built_in\"\u003eexec\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch fork -- Catch calls to fork\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch load -- Catch loads of shared libraries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch rethrow -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch signal -- Catch signals by their names and/or numbers\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch syscall -- Catch system calls by their names and/or numbers\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch throw -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch unload -- Catch unloads of shared libraries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecatch vfork -- Catch calls to vfork\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eclear -- Clear breakpoint at specified location\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ecommands -- Set commands to be executed when a breakpoint is hit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003econdition -- Specify breakpoint number N to \u003cspan class=\"built_in\"\u003ebreak\u003c/span\u003e only \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e COND is \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete -- Delete some breakpoints or auto-display expressions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete bookmark -- Delete a bookmark from the bookmark list\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete breakpoints -- Delete some breakpoints or auto-display expressions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete checkpoint -- Delete a checkpoint (experimental)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete display -- Cancel some expressions to be displayed when program stops\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete mem -- Delete memory region\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete tracepoints -- Delete specified tracepoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edelete tvariable -- Delete one or more trace state variables\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e -- Disable some breakpoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e breakpoints -- Disable some breakpoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e display -- Disable some expressions to be displayed when program stops\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e frame-filter -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e the specified frame-filter\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e mem -- Disable memory region\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e pretty-printer -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e the specified pretty-printer\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e probes -- Disable probes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e tracepoints -- Disable specified tracepoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e type-printer -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e the specified type-printer\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e unwinder -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e the specified unwinder\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e xmethod -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e a specified (group of) xmethod(s)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003edprintf -- Set a dynamic \u003cspan class=\"built_in\"\u003eprintf\u003c/span\u003e at specified location\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e -- Enable some breakpoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e breakpoints -- Enable some breakpoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e breakpoints count -- Enable breakpoints \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e COUNT hits\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e breakpoints delete -- Enable breakpoints and delete when hit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e breakpoints once -- Enable breakpoints \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e one hit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e count -- Enable breakpoints \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e COUNT hits\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e delete -- Enable breakpoints and delete when hit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e display -- Enable some expressions to be displayed when program stops\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e frame-filter -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e the specified frame-filter\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e mem -- Enable memory region\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e once -- Enable breakpoints \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e one hit\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e pretty-printer -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e the specified pretty-printer\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e probes -- Enable probes\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e tracepoints -- Enable specified tracepoints\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e type-printer -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e the specified \u003cspan class=\"built_in\"\u003etype\u003c/span\u003e printer\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e unwinder -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e unwinders\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e xmethod -- GDB \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e to \u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e a specified (group of) xmethod(s)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eftrace -- Set a fast tracepoint at specified location\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ehbreak -- Set a hardware assisted breakpoint\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eignore -- Set ignore-count of breakpoint number N to COUNT\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erbreak -- Set a breakpoint \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e all \u003cspan class=\"built_in\"\u003efunctions\u003c/span\u003e matching REGEXP\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003erwatch -- Set a \u003cspan class=\"built_in\"\u003eread\u003c/span\u003e watchpoint \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e an expression\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave -- Save breakpoint definitions as a script\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave breakpoints -- Save current breakpoint definitions as a script\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave gdb-index -- Save a gdb-index file\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003esave tracepoints -- Save current tracepoint definitions as a script\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip -- Ignore a \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e stepping\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip delete -- Delete skip entries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip \u003cspan class=\"built_in\"\u003edisable\u003c/span\u003e -- Disable skip entries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip \u003cspan class=\"built_in\"\u003eenable\u003c/span\u003e -- Enable skip entries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip file -- Ignore a file \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e stepping\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eskip \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e -- Ignore a \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e stepping\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estrace -- Set a static tracepoint at location or marker\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etbreak -- Set a temporary breakpoint\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch -- Set temporary catchpoints to catch events\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch assert -- Catch failed Ada assertions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch catch -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch exception -- Catch Ada exceptions\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch \u003cspan class=\"built_in\"\u003eexec\u003c/span\u003e -- Catch calls to \u003cspan class=\"built_in\"\u003eexec\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch fork -- Catch calls to fork\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch load -- Catch loads of shared libraries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch rethrow -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch signal -- Catch signals by their names and/or numbers\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch syscall -- Catch system calls by their names and/or numbers\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch throw -- Catch an exception\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch unload -- Catch unloads of shared libraries\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etcatch vfork -- Catch calls to vfork\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ethbreak -- Set a temporary hardware assisted breakpoint\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003etrace -- Set a tracepoint at specified location\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003ewatch -- Set a watchpoint \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e an expression\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;help\u0026#34;\u003c/span\u003e followed by \u003cspan class=\"built_in\"\u003ecommand\u003c/span\u003e name \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e full documentation.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eType \u003cspan class=\"string\"\u003e\u0026#34;apropos word\u0026#34;\u003c/span\u003e to search \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e commands related to \u003cspan class=\"string\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e.\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eCommand name abbreviations are allowed \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e unambiguous.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e显而易见，GDB 还有很多功能，而我仅只是在解决问题的过程中使用了其中很小一部分。\u003c/p\u003e\n\u003ch2 id=\"廿五-·-结语\"\u003e\u003ca href=\"#廿五-·-结语\" class=\"headerlink\" title=\"廿五 · 结语\"\u003e\u003c/a\u003e廿五 · 结语\u003c/h2\u003e\u003cp\u003e好吧，这里我遇到的问题比较恶心：这是一个由 LLVM 的 bug 经由 ncurses 最终导致 Python 程序崩溃的例子。不过，解决问题过程中，我用到的命令和使用他们的流程基本就是调试查错的基本流程：查看调用栈、检查寄存器、设置断点、单步调试、浏览代码。\u003c/p\u003e\n\u003cp\u003e当我在几年前第一次使用 GDB 时，我真的不怎么喜欢它。它看起来又笨拙又难用。然而，GDB 已经改进了很多，同时也有了一些 GDB 调试查错的技巧之后，现在我认为它是一个强大的现代调试器。不同调试器有不同的技能，但是 GDB 必是其中最强大的文本调试器——当然 \u003ccode\u003elldb\u003c/code\u003e 正在迎头赶上。\u003c/p\u003e\n\u003cp\u003e在此，我希望所有查找 GDB 调试范例的人会从我的例子和警示中学到东西。当然，以后有机会我也会分享更多关于 GDB 的经验——尤其是诸如 JAVA 的运行时问题。\u003c/p\u003e\n\u003cp\u003e哦对了，退出 GDB 的方法是 \u003ccode\u003eq\u003c/code\u003e (\u003ccode\u003equit\u003c/code\u003e) 命令。（译者注：你也可以使用 \u003ccode\u003eCtrl + D\u003c/code\u003e 来退出 GDB 调试器。）\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2017-05-27T15:24:40Z",
  "Author": "Liam Huang"
}