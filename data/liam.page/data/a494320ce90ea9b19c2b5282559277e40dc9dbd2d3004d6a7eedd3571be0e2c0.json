{
  "Source": "liam.page",
  "Title": "谈谈代理类",
  "Link": "https://liam.page/2017/11/26/surrogate-in-Cpp/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cblockquote\u003e\n\u003cp\u003e本文以 C++ 为示例语言，但实际其中思想适用范围远大于 C++ 这一编程语言的范畴。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003e我们知道，C++ 标准模板类库提供了一系列的容器。诸如 \u003ccode\u003estd::vector\u0026lt;ElementType\u0026gt;\u003c/code\u003e 的容器需要在声明时指定容器中所储存的元素的类型。例如，我们可以使用 \u003ccode\u003estd::vector\u0026lt;int\u0026gt;\u003c/code\u003e 声明一个包含整型数字的变长数组；而 \u003ccode\u003estd::vector\u0026lt;std::string\u0026gt;\u003c/code\u003e 则可以用来声明一个包含 \u003ccode\u003estd::string\u003c/code\u003e 的变长数组。\u003c/p\u003e\n\u003cp\u003e显而易见，由于容器在声明时就已指定了其包含的元素的类型，容器内只能包含相同类型的元素。这与面向对象编程（Object-Oriented Programming, OOP, 使用继承和运行时动态绑定的编程方式）的思想似乎是矛盾的。因为 OOP 使用继承和动态绑定，允许程序员将相关但有不同的类的共性部分抽象成基类而将这些不同的部分分别作为子类独有的成员；若是容器内只能包含相同类型的元素，我们就无法直接在一个容器中包含同一个基类不同派生类的对象了——而在实际应用中，这种场景是存在的。\u003c/p\u003e\n\u003cp\u003e在\u003ca href=\"/2016/11/26/Introduction-to-CRTP-in-Cpp/\"\u003e前作\u003c/a\u003e中最后的示例（动物园的例子）中，我们通过保存基类指针（而不是对象本身）部分解决了这个问题。然而，在前例中，我们不可避免地还是需要使用 \u003ccode\u003enew\u003c/code\u003e 和 \u003ccode\u003edelete\u003c/code\u003e 来动态分配内存。此篇我们通过构建「代理类」来避免手工动态分配内存。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"问题重述\"\u003e\u003ca href=\"#问题重述\" class=\"headerlink\" title=\"问题重述\"\u003e\u003c/a\u003e问题重述\u003c/h2\u003e\u003cp\u003e我们仍旧以\u003ca href=\"/2016/11/26/Introduction-to-CRTP-in-Cpp/\"\u003e前作\u003c/a\u003e中动物园的例子进行讲述；不失一般性，我们忽略 CRTP 惯用法。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;vector\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eAnimal\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e= \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e ~\u003cspan class=\"built_in\"\u003eAnimal\u003c/span\u003e() {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eCat\u003c/span\u003e: \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e Animal {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;Meow~ I\u0026#39;m a cat.\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003ebool\u003c/span\u003e valid_cat_{\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eDog\u003c/span\u003e: \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e Animal {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;Wang~ I\u0026#39;m a dog.\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003ebool\u003c/span\u003e valid_dog_{\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::vector\u0026lt;Animal*\u0026gt; zoo;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e());\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e());\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e iter = zoo.\u003cspan class=\"built_in\"\u003ebegin\u003c/span\u003e(); iter != zoo.\u003cspan class=\"built_in\"\u003eend\u003c/span\u003e(); ++iter) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        (*iter)-\u0026gt;\u003cspan class=\"built_in\"\u003esay\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e iter = zoo.\u003cspan class=\"built_in\"\u003ebegin\u003c/span\u003e(); iter != zoo.\u003cspan class=\"built_in\"\u003eend\u003c/span\u003e(); ++iter) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"built_in\"\u003edelete\u003c/span\u003e (*iter);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在主函数中，我们通过 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 类的默认构造函数，两次动态分配内存，分别构建了 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 类的对象；而后将相应的指针加入 \u003ccode\u003estd::vector\u003c/code\u003e 的末尾。而后，我们就能通过迭代器，依次访问 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 了。当然，最后也不能忘记清理动态分配的内存。\u003c/p\u003e\n\u003cp\u003e我们的目标是将主函数改成类似下面的效果。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::vector\u0026lt;ElementType\u0026gt; zoo;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Cat cat;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Dog dog;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(cat);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(dog);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e iter = zoo.\u003cspan class=\"built_in\"\u003ebegin\u003c/span\u003e(); iter != zoo.\u003cspan class=\"built_in\"\u003eend\u003c/span\u003e(); ++iter) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        iter-\u0026gt;\u003cspan class=\"built_in\"\u003esay\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch2 id=\"问题分析\"\u003e\u003ca href=\"#问题分析\" class=\"headerlink\" title=\"问题分析\"\u003e\u003c/a\u003e问题分析\u003c/h2\u003e\u003cp\u003e对比在 \u003ccode\u003ezoo\u003c/code\u003e 中保存基类指针的方式，我们的目标代码有几点主要的不同。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e向 \u003ccode\u003ezoo\u003c/code\u003e 中追加元素时，加入的是 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 类的对象本身，而不是它们的指针；\u003c/li\u003e\n\u003cli\u003e向 \u003ccode\u003ezoo\u003c/code\u003e 中追加的元素保存在栈上（而不是堆上），不需要程序员主动分配和释放内存。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e这也就是说，数组 \u003ccode\u003ezoo\u003c/code\u003e 的元素类型必然不是 \u003ccode\u003eCat\u003c/code\u003e 或 \u003ccode\u003eDog\u003c/code\u003e，而应该和他们的基类 \u003ccode\u003eAnimal\u003c/code\u003e 有一定关系；另外一方面，在功能上，我们要保证 \u003ccode\u003eElementType\u003c/code\u003e 的元素支持动态绑定（能够调用合适的 \u003ccode\u003esay\u003c/code\u003e 函数）。\u003c/p\u003e\n\u003cp\u003e另一方面，我们也要注意到，由于 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 不是程序员手动分配和释放内存，而是由系统运行时库来自动管理。这样一来，可能存在变长数组 \u003ccode\u003ezoo\u003c/code\u003e 仍在使用，但 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 已经由于超出生存期而被销毁的现象。因此，在向变长数组 \u003ccode\u003ezoo\u003c/code\u003e 追加元素时，我们需要考虑拷贝或者移动语义。\u003c/p\u003e\n\u003ch2 id=\"代码实现\"\u003e\u003ca href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"\u003e\u003c/a\u003e代码实现\u003c/h2\u003e\u003cp\u003e接下来我们分别解决这些问题。\u003c/p\u003e\n\u003ch3 id=\"拷贝和移动语义\"\u003e\u003ca href=\"#拷贝和移动语义\" class=\"headerlink\" title=\"拷贝和移动语义\"\u003e\u003c/a\u003e拷贝和移动语义\u003c/h3\u003e\u003cp\u003e首先我们来实现拷贝和移动语义。\u003c/p\u003e\n\u003cp\u003e在问题分析一节中，我们提到，数组的元素类型 \u003ccode\u003eElementType\u003c/code\u003e 虽不是基类指针，但必然和基类相关。因此，显而易见，拷贝和移动语义的接口应该定义在基类当中。因此，我们首先需要修改基类。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eAnimal\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e= \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e Animal* \u003cspan class=\"title\"\u003ecopy\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e= \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e Animal* \u003cspan class=\"title\"\u003emove\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e= \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evirtual\u003c/span\u003e ~\u003cspan class=\"built_in\"\u003eAnimal\u003c/span\u003e() {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e而后，我们需要在 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 两个派生类中分别实现 \u003ccode\u003ecopy\u003c/code\u003e 和 \u003ccode\u003emove\u003c/code\u003e 函数。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eCat\u003c/span\u003e: \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e Animal {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;Meow~ I\u0026#39;m a cat.\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e() {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ~\u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e() \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e { valid_cat_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e; }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Cat\u0026amp; source) : valid_cat_{source.valid_cat_} {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e(Cat\u0026amp;\u0026amp; source) : valid_cat_{source.valid_cat_} { source.valid_cat_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e; }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Cat\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Cat\u0026amp; source) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;valid_cat_ = source.valid_cat_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Cat\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(Cat\u0026amp;\u0026amp; source) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;valid_cat_ = source.valid_cat_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        source.valid_cat_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003eAnimal* \u003cspan class=\"title\"\u003ecopy\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003edynamic_cast\u003c/span\u003e\u0026lt;Animal*\u0026gt;(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e(*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003eAnimal* \u003cspan class=\"title\"\u003emove\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003edynamic_cast\u003c/span\u003e\u0026lt;Animal*\u0026gt;(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eCat\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e)));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003ebool\u003c/span\u003e valid_cat_{\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eDog\u003c/span\u003e: \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e Animal {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;Wang~ I\u0026#39;m a dog.\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e() {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ~\u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e() \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e { valid_dog_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e; }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Dog\u0026amp; source) : valid_dog_{source.valid_dog_} {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e(Dog\u0026amp;\u0026amp; source) : valid_dog_{source.valid_dog_} { source.valid_dog_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e; }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Dog\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Dog\u0026amp; source) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;valid_dog_ = source.valid_dog_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Dog\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(Dog\u0026amp;\u0026amp; source) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;valid_dog_ = source.valid_dog_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        source.valid_dog_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003eAnimal* \u003cspan class=\"title\"\u003ecopy\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003edynamic_cast\u003c/span\u003e\u0026lt;Animal*\u0026gt;(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e(*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003eAnimal* \u003cspan class=\"title\"\u003emove\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"keyword\"\u003eoverride\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003edynamic_cast\u003c/span\u003e\u0026lt;Animal*\u0026gt;(\u003cspan class=\"keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"built_in\"\u003eDog\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e)));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003ebool\u003c/span\u003e valid_dog_{\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此处，通过完整实现 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 类的析构函数、拷贝构造函数、拷贝赋值运算符、移动构造函数、移动赋值运算符，我们实现了 \u003ccode\u003ecopy\u003c/code\u003e 和 \u003ccode\u003emove\u003c/code\u003e 两个函数。\u003c/p\u003e\n\u003ch3 id=\"定义基类的代理\"\u003e\u003ca href=\"#定义基类的代理\" class=\"headerlink\" title=\"定义基类的代理\"\u003e\u003c/a\u003e定义基类的代理\u003c/h3\u003e\u003cp\u003e如问题分析一节中的讨论，我们认为 \u003ccode\u003eElementType\u003c/code\u003e 必然和 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 的基类 \u003ccode\u003eAnimal\u003c/code\u003e 相关。同时，经过分析，我们发现 \u003ccode\u003eElementType\u003c/code\u003e 在构建时，可以直接从 \u003ccode\u003eCat\u003c/code\u003e 和 \u003ccode\u003eDog\u003c/code\u003e 的实例上构建；在运行时，支持多态。因此，不难发现，\u003ccode\u003eElementType\u003c/code\u003e 一方面必须包含一个 \u003ccode\u003eAnimal\u003c/code\u003e 的指针或引用；另一方面它必须有从 \u003ccode\u003eAnimal\u003c/code\u003e 的实例中构造的构造函数（定义从 \u003ccode\u003eAnimal\u003c/code\u003e 到 \u003ccode\u003eElementType\u003c/code\u003e 的类型转换）。\u003c/p\u003e\n\u003cp\u003e这样一来，我们能写出 \u003ccode\u003eAnimal\u003c/code\u003e 类的代理。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eAnimalSurrogate\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eAnimalSurrogate\u003c/span\u003e() {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eexplicit\u003c/span\u003e \u003cspan class=\"title\"\u003eAnimalSurrogate\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e AnimalSurrogate\u0026amp; animal_surrogate)\u003c/span\u003e :\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e        animal_{\u003c/span\u003eanimal_surrogate.animal_ ? animal_surrogate.animal_-\u0026gt;\u003cspan class=\"built_in\"\u003ecopy\u003c/span\u003e() : \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e} {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eexplicit\u003c/span\u003e \u003cspan class=\"title\"\u003eAnimalSurrogate\u003c/span\u003e\u003cspan class=\"params\"\u003e(AnimalSurrogate\u0026amp;\u0026amp; animal_surrogate)\u003c/span\u003e :\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e        animal_{\u003c/span\u003eanimal_surrogate.animal_ ? animal_surrogate.animal_-\u0026gt;\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e() : \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e} {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_surrogate.animal_ = \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    AnimalSurrogate\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e AnimalSurrogate\u0026amp; animal_surrogate) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_ = animal_surrogate.animal_ ? animal_surrogate.animal_-\u0026gt;\u003cspan class=\"built_in\"\u003ecopy\u003c/span\u003e() : \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    AnimalSurrogate\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(AnimalSurrogate\u0026amp;\u0026amp; animal_surrogate) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_ = animal_surrogate.animal_ ? animal_surrogate.animal_-\u0026gt;\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e() : \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_surrogate.animal_ = \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ~\u003cspan class=\"built_in\"\u003eAnimalSurrogate\u003c/span\u003e() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e animal_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_ = \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eAnimalSurrogate\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Animal\u0026amp; animal) : animal_{animal.\u003cspan class=\"built_in\"\u003ecopy\u003c/span\u003e()} {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eAnimalSurrogate\u003c/span\u003e(Animal\u0026amp;\u0026amp; animal) : animal_{animal.\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e()} {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    AnimalSurrogate\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Animal\u0026amp; animal) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;animal_ = animal.\u003cspan class=\"built_in\"\u003ecopy\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    AnimalSurrogate\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(Animal\u0026amp;\u0026amp; animal) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;animal_ = animal.\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (*\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003esay\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        animal_-\u0026gt;\u003cspan class=\"built_in\"\u003esay\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Animal* animal_{\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，我们定义了 \u003ccode\u003eAnimal\u003c/code\u003e 类的代理类 \u003ccode\u003eAnimalSurrogate\u003c/code\u003e。在它的一系列构造函数中，我们保证了 \u003ccode\u003eAnimalSurrogate\u003c/code\u003e 类的实例本身能够拷贝、移动。同时我们允许从 \u003ccode\u003eAnimal\u003c/code\u003e 向 \u003ccode\u003eAnimalSurrogate\u003c/code\u003e 的类型转换：从左值引用中拷贝以及从右值引用中移动。特别地，由于 \u003ccode\u003eAnimal\u003c/code\u003e 是抽象类，不存在 \u003ccode\u003eAnimal\u003c/code\u003e 类的对象，因此这两个构造函数不应声明为 \u003ccode\u003eexplicit\u003c/code\u003e。这是因为，如果声明为 \u003ccode\u003eexplicit\u003c/code\u003e，则每次使用都必须使用 \u003ccode\u003edynamic_cast\u003c/code\u003e 进行显式的类型转换。\u003c/p\u003e\n\u003cp\u003e另一方面，由于 \u003ccode\u003eAnimalSurrogate\u003c/code\u003e 类中包含了一个 \u003ccode\u003eAnimal\u003c/code\u003e 类的指针，通过该指针，我们在 \u003ccode\u003eAnimalSurrogate::say()\u003c/code\u003e 函数中，可以实现多态。\u003c/p\u003e\n\u003ch3 id=\"实际执行看看\"\u003e\u003ca href=\"#实际执行看看\" class=\"headerlink\" title=\"实际执行看看\"\u003e\u003c/a\u003e实际执行看看\u003c/h3\u003e\u003cp\u003e这样一来，我们的主函数就应当写作以下两种形式之一：\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::vector\u0026lt;AnimalSurrogate\u0026gt; zoo;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Cat cat;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Dog dog;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// AnimalSurrogate::AnimalSurrogate(const Animal\u0026amp; animal) is called\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(cat);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(dog);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (std::vector\u0026lt;AnimalSurrogate\u0026gt;::const_iterator iter{zoo.\u003cspan class=\"built_in\"\u003ebegin\u003c/span\u003e()}; iter != zoo.\u003cspan class=\"built_in\"\u003eend\u003c/span\u003e(); ++iter) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        iter-\u0026gt;\u003cspan class=\"built_in\"\u003esay\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e \u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::vector\u0026lt;AnimalSurrogate\u0026gt; zoo;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Cat cat;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    Dog dog;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"comment\"\u003e// AnimalSurrogate::AnimalSurrogate(Animal\u0026amp;\u0026amp; animal) is called\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(cat));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    zoo.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(dog));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (std::vector\u0026lt;AnimalSurrogate\u0026gt;::const_iterator iter{zoo.\u003cspan class=\"built_in\"\u003ebegin\u003c/span\u003e()}; iter != zoo.\u003cspan class=\"built_in\"\u003eend\u003c/span\u003e(); ++iter) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        iter-\u0026gt;\u003cspan class=\"built_in\"\u003esay\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此处，第一种情况，我们在向 \u003ccode\u003ezoo\u003c/code\u003e 追加元素时，C++ 会调用 \u003ccode\u003eAnimalSurrogate::AnimalSurrogate(const Animal\u0026amp; animal)\u003c/code\u003e；以便从 \u003ccode\u003eanimal\u003c/code\u003e 中拷贝内容（调用 \u003ccode\u003ecopy()\u003c/code\u003e 函数）。第二种情况，我们在想 \u003ccode\u003ezoo\u003c/code\u003e 追加元素时，C++ 会调用 \u003ccode\u003eAnimalSurrogate::AnimalSurrogate(Animal\u0026amp;\u0026amp; animal)\u003c/code\u003e；以便运用移动语义，从 \u003ccode\u003eanimal\u003c/code\u003e 中「窃取」资源。\u003c/p\u003e\n\u003cp\u003e需要注意的是，在两种情况下，\u003ccode\u003ezoo\u003c/code\u003e 中的元素都与外部的 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 无关。不论 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 如何变化（甚至销毁），都不影响 \u003ccode\u003ezoo\u003c/code\u003e 中的元素。不同的是，在第二种情况下，外部的 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 中的资源被窃取，因此 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 已处于不可用的状态（代码中使用 \u003ccode\u003evalid_cat_\u003c/code\u003e 和 \u003ccode\u003evalid_dog_\u003c/code\u003e 来表示这种现象）——我们不能对移走的 \u003ccode\u003ecat\u003c/code\u003e 和 \u003ccode\u003edog\u003c/code\u003e 中的资源的状态做任何假设。具体可参见\u003ca href=\"/2016/12/11/rvalue-reference-in-Cpp/\"\u003e谈谈 C++ 中的右值引用\u003c/a\u003e。\u003c/p\u003e\n\u003cp\u003e执行结果如下：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e$ ./a.out\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eMeow~ I\u003cspan class=\"string\"\u003e\u0026#39;m a cat.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"string\"\u003eWang~ I\u0026#39;\u003c/span\u003em a dog.\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如此一来，我们就实现了在同一容器中，（间接地）容纳不同类型的实例；同时在保留多态的情况下，避免让程序员手动分配和释放内存。\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003e代理类和 CRTP 是不矛盾的，读者可以试着将二者联系起来，一起使用。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003c!-- 仅以此文先给刘斐然，作为她 28 岁的生日礼物。: ) --\u003e\n\n    \u003c/div\u003e",
  "Date": "2017-11-26T07:47:21Z",
  "Author": "Liam Huang"
}