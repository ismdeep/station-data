{
  "Source": "liam.page",
  "Title": "程序员的自我修养（⑬）：C++ 的内存顺序·下",
  "Link": "https://liam.page/2021/12/14/memory-order-cpp-03/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e在前三篇文章中，我们捡着重要的部分翻译和扩展了 cppreference 网站上关于\u003ca href=\"/2021/06/05/memory-model-cpp/\"\u003e内存模型\u003c/a\u003e和内存顺序（\u003ca href=\"/2021/06/06/memory-order-cpp-01/\"\u003e上\u003c/a\u003e、\u003ca href=\"/2021/12/11/memory-order-cpp-02/\"\u003e中\u003c/a\u003e）的文章。坦率地说，因为涉及内容相对底层，所以通篇相对晦涩。所以它们虽然阐述了相关内容，但不易读。\u003c/p\u003e\n\u003cp\u003e此篇讨论的内容在前三篇文章中都有讨论，但将从一系列例子出发，从实践的角度去讨论内存模型和内存顺序。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"最简单的例子\"\u003e\u003ca href=\"#最简单的例子\" class=\"headerlink\" title=\"最简单的例子\"\u003e\u003c/a\u003e最简单的例子\u003c/h2\u003e\u003cp\u003e让我们从一个最简单的生产者/消费者的例子出发。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;chrono\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;iosteram\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;vector\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::vector\u0026lt;\u003cspan class=\"type\"\u003eint\u003c/span\u003e\u0026gt; data;  \u003cspan class=\"comment\"\u003e// 1.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; ready{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};  \u003cspan class=\"comment\"\u003e// 1.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eproducer\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  data.\u003cspan class=\"built_in\"\u003epush_back\u003c/span\u003e(\u003cspan class=\"number\"\u003e1024\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ready.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003econsumer\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!ready.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e()) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::\u003cspan class=\"built_in\"\u003esleep\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003emilliseconds\u003c/span\u003e(\u003cspan class=\"number\"\u003e1\u003c/span\u003e));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::cout \u0026lt;\u0026lt; data[\u003cspan class=\"number\"\u003e0\u003c/span\u003e] \u0026lt;\u0026lt; std::endl;  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::thread a{producer}, b{consumer};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  a.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); b.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e此处，(1) 初始化了全局共享的数据 \u003ccode\u003edata\u003c/code\u003e 和原子标记 \u003ccode\u003eready\u003c/code\u003e。生产者线程中，(2) 对全局共享的数据进行修改，并在 (3) 处将标记设置为 \u003ccode\u003etrue\u003c/code\u003e。消费者线程中，(4) 循环等待原子标记（当然，它效率极低；作为示例我们暂时忽略这个问题），而后在 (5) 处读取共享数据。\u003c/p\u003e\n\u003cp\u003e我们知道，在多个线程中，并发读写同一个内存位置（此处的 \u003ccode\u003e\u0026amp;data[0]\u003c/code\u003e）可能造成数据竞争，必须有相应的同步机制。此处同步机制由原子标记 \u003ccode\u003eready\u003c/code\u003e 协助建立。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(2) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (3)；\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e当 (4) 读到 \u003ccode\u003eready.load()\u003c/code\u003e 为真\u003c/strong\u003e，则 (3) 与 (4) 建立\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系，因而有 (3) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (4)；\u003c/li\u003e\n\u003cli\u003e(4) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (5)。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e在原子标记 \u003ccode\u003eready\u003c/code\u003e 的协助下，我们建立了对 \u003ccode\u003edata\u003c/code\u003e 的写\u003cins\u003e先于（happens-before）\u003c/ins\u003e读的顺序关系，数据竞争的风险就此解除。\u003c/p\u003e\n\u003cp\u003e整体看下来，这一过程非常符合直觉。而我们知道，原子变量除了保证其上原子操作的原子性之外，各个操作还有内存顺序标记。不同的顺序标记会影响编译器优化和 CPU 执行时的行为；更准确地，影响原子操作附近访问内存的顺序。默认的顺序标记是 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e。之所以将它作为默认标记，是因为它能带来这一符合直觉的结果。\u003c/p\u003e\n\u003cp\u003e接下来，我们顺势讨论\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系和\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系。\u003c/p\u003e\n\u003ch2 id=\"两种关系\"\u003e\u003ca href=\"#两种关系\" class=\"headerlink\" title=\"两种关系\"\u003e\u003c/a\u003e两种关系\u003c/h2\u003e\u003ch3 id=\"同步（synchronizes-with）关系\"\u003e\u003ca href=\"#同步（synchronizes-with）关系\" class=\"headerlink\" title=\"同步（synchronizes-with）关系\"\u003e\u003c/a\u003e\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系\u003c/h3\u003e\u003cp\u003e\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系，追根究底只能由原子操作提供。我们能见到的所有产生同步关系的办法，其底层都包含了某些原子操作。同步关系是这样建立的，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e首先有在线程 A 中对原子变量 \u003ccode\u003ex\u003c/code\u003e 打上恰当标记的写入操作 \u003ccode\u003eW\u003c/code\u003e；\u003c/li\u003e\n\u003cli\u003e而后有在线程 B 中对原子变量 \u003ccode\u003ex\u003c/code\u003e 打上恰当标记的读取操作 \u003ccode\u003eR\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e若 \u003ccode\u003eR\u003c/code\u003e 读到的值，来自以下任意一种情况，则说 \u003ccode\u003eW\u003c/code\u003e 与 \u003ccode\u003eR\u003c/code\u003e \u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eW\u003c/code\u003e 的写入；或者\u003c/li\u003e\n\u003cli\u003e线程 A（\u003ccode\u003eW\u003c/code\u003e 所在线程）中，\u003ccode\u003eW\u003c/code\u003e 之后的某次写入；或者\u003c/li\u003e\n\u003cli\u003e任意线程中的一系列 read-modify-write 操作中的写入值，其中第一次 read-modify-write 操作读到的值来自 \u003ccode\u003eW\u003c/code\u003e 的写入。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这得到一个最基本的认知：（在顺序标记恰当的情况下，）如果线程 B 的读取操作读到的是线程 A 的写入操作的写入值，则写入操作与读取操作同步。\u003c/p\u003e\n\u003cp\u003e如此一来，所有的细节就在「恰当」二字之上了。不过，我们先来讨论\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系。\u003c/p\u003e\n\u003ch2 id=\"先于（happens-before）关系\"\u003e\u003ca href=\"#先于（happens-before）关系\" class=\"headerlink\" title=\"先于（happens-before）关系\"\u003e\u003c/a\u003e\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系\u003c/h2\u003e\u003cp\u003e\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系是讨论内存顺序中最重要的基石。若 A \u003cins\u003e先于（happens-before）\u003c/ins\u003e B，则 B 能看到 A 带来的副作用。\u003c/p\u003e\n\u003cp\u003e在单线程里面，\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系很简单。单线程当中的\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系即是\u003cins\u003e先序（sequenced-before）\u003c/ins\u003e关系。一般来说，不考虑编译器优化重排和 CPU 乱序执行重排时，在代码当中，靠前的语句当中的操作\u003cins\u003e先于（happens-before）\u003c/ins\u003e靠后的语句当中的操作。但实际上，我们需要考虑编译器优化和 CPU 乱序执行对先序关系带来的影响。\u003c/p\u003e\n\u003cp\u003e在线程之间，若线程 A 的写入操作与线程 B 的读取操作\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e，则该写入操作\u003cins\u003e线程间先于（inter-thread happens-before）\u003c/ins\u003e该读取操作，也因此该写入操作\u003cins\u003e先于（happens-before）\u003c/ins\u003e该读取操作。\u003c/p\u003e\n\u003ch2 id=\"三种顺序模型\"\u003e\u003ca href=\"#三种顺序模型\" class=\"headerlink\" title=\"三种顺序模型\"\u003e\u003c/a\u003e三种顺序模型\u003c/h2\u003e\u003cp\u003e按前文，顺序标记共有六种：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_consume\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_acquire\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_release\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_acq_rel\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e六种标记又能组成三种顺序模型：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e顺序一致模型（sequentially consistent ordering）：最强的顺序模型。对编译器优化限制最多，所需额外 CPU 同步指令最多，性能也最差；但最符合直觉。涉及到的顺序标记是 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e。\u003c/li\u003e\n\u003cli\u003e宽松模型（relaxed ordering）：最弱的顺序模型。对编译器优化限制最少（几乎没有），所需额外 CPU 同步指令最少（几乎没有），性能也最好；但无法建立线程间的同步关系。涉及到的顺序标记是 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e。\u003c/li\u003e\n\u003cli\u003e获取-释放模型（acquire-release ordering）：介于二者之间。对编译器优化限制适中，所需额外的 CPU 同步指令也适中（在部分平台上，不许额外同步指令），性能也适中；可以建立线程间的同步关系。涉及到的顺序标记是 \u003ccode\u003estd::memory_order_acq_rel\u003c/code\u003e, \u003ccode\u003estd::memory_order_acquire\u003c/code\u003e, \u003ccode\u003estd::memory_order_release\u003c/code\u003e 和 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cblockquote\u003e\n\u003cp\u003e注意，\u003ccode\u003estd::memory_order_consume\u003c/code\u003e 与 \u003ccode\u003estd::memory_order_acquire\u003c/code\u003e 相似，但比后者更弱。但完整地实现 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e 的语义，需要追踪变量之间的依赖链。目前，还没有已知的编译器实现了它。现有的编译器，都将 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e 提升为 \u003ccode\u003estd::memory_order_acquire\u003c/code\u003e。故而此处也将 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e 归在获取-释放模型当中。此外，考虑 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e 的语义可能发生变化，目前标准也不建议使用 \u003ccode\u003estd::memory_order_consume\u003c/code\u003e。\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003ch3 id=\"顺序一致模型（sequentially-consistent-ordering）\"\u003e\u003ca href=\"#顺序一致模型（sequentially-consistent-ordering）\" class=\"headerlink\" title=\"顺序一致模型（sequentially consistent ordering）\"\u003e\u003c/a\u003e顺序一致模型（sequentially consistent ordering）\u003c/h3\u003e\u003cp\u003e默认的顺序模型是「顺序一致模型」。如果所有原子操作的顺序标记都是 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e，那么多线程程序的行为就好像这些操作以某一特定的顺序在单一的线程中执行一样。特别地，站在所有被打上 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e 标记的操作上来看，所有先于该操作发生的原子操作（\u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e），都具有同样的顺序。\u003c/p\u003e\n\u003cp\u003e这是最符合直觉的模型。多数人第一次接触到多线程，会假定多线程中的各个操作是可能并发执行的，因此将他们理解为按照某个不确定的顺序穿插执行。然后在脑海中想象并构建这一固定的顺序，并按照这一顺序假定各个线程会如何工作。但这种符合直觉的模型并不总是成立。这种多线程之间全局统一的顺序，即是顺序一致性带来的保证。一旦保证不了顺序一致性，则这种基于「穿插执行」假定出来的全局统一顺序也就不成立了。\u003c/p\u003e\n\u003c!-- From the point of view of synchronization, a sequentially consistent store synchronizes-with a sequentially consistent load of the same variable that reads the value stored. This provides one ordering constraint on the operation of two (or more) threads, but sequential consistency is more powerful than that. Any sequentially con- sistent atomic operations done after that load must also appear after the store to other threads in the system using sequentially consistent atomic operations. The example in listing 5.4 demonstrates this ordering constraint in action. This constraint doesn’t carry forward to threads that use atomic operations with relaxed memory orderings; they can still see the operations in a different order, so you must use sequentially con- sistent operations on all your threads in order to get the benefit. --\u003e\n\n\u003cp\u003e站在同步的角度来看，顺序一致 store 操作与读到本次写入值的顺序一致的 load 操作\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e。如前所述，这种同步关系在线程之间提供了一定的顺序限制。但顺序一致模型还保证，在这一顺序一致的 load 操作之后的顺序一致操作，在其他所有使用顺序一致原子操作的线程看来，也是发生在此次顺序一致 store 之后的。注意，如若某一线程中的某个原子操作没有使用 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e 标记，则在该操作看来，顺序一致的诸多操作的顺序可能与其他线程看到的不同。\u003c/p\u003e\n\u003cp\u003e前作当中的\u003ca href=\"/2021/12/11/memory-order-cpp-02/#%E9%A1%BA%E5%BA%8F%E4%B8%80%E8%87%B4%E9%A1%BA%E5%BA%8F%EF%BC%88Sequentially-consistent-ordering%EF%BC%89\"\u003e例子\u003c/a\u003e很好地说明了顺序一致性的效果。\u003c/p\u003e\n\u003c!-- This ease of understanding can come at a price, though. On a weakly ordered machine with many processors, it can impose a noticeable performance penalty, because the overall sequence of operations must be kept consistent between the pro- cessors, possibly requiring extensive (and expensive!) synchronization operations between the processors. That said, some processor architectures (such as the common x86 and x86-64 architectures) offer sequential consistency relatively cheaply, so if you’re concerned about the performance implications of using sequentially consis- tent ordering, check the documentation for your target processor architectures. --\u003e\n\n\u003cp\u003e这种便利是有代价的。在默认的顺序保证相对较弱的平台上（如 ARM），顺序一致模型会引入可观的性能代价。这是因为，全局顺序一致需要在 CPU 逻辑核心之间保持一致性，这使得 CPU 逻辑核心之间需要使用代价高昂的同步操作。相较而言，部分处理器架构（例如 x86 和 x86-64）保证顺序一致性的代价较低。为避免这种同步代价，我们需要拥抱非顺序一致性模型。\u003c/p\u003e\n\u003chr/\u003e\n\u003cp\u003e在处理非顺序一致性模型时，我们就要丢弃脑海中那种简洁漂亮的交替执行的思维模型。\u003cstrong\u003e它不存在了\u003c/strong\u003e。在没有顺序一致性保障的情况下，各个线程看到的原子操作的顺序并不保证统一。也就是说，虽然依旧是并发（所以穿插执行），但是每个线程看到的穿插的顺序可能是不一样的。在非顺序一致模型下写代码时，要时刻关注这一点。\u003c/p\u003e\n\u003cp\u003e不过，也有一致的地方。虽说各个线程观察到的原子操作发生的顺序可能不一致，但是，对于\u003cstrong\u003e每一个特定的原子变量\u003c/strong\u003e，作用在其上的原子操作的修改顺序（modification-order），在各个线程看来是统一的。\u003c/p\u003e\n\u003cp\u003e为了充分理解非顺序一致性模型，我们可以先考虑宽松模型。待对非顺序一致性有足够了解之后，再回到获取-释放模型。\u003c/p\u003e\n\u003ch3 id=\"宽松模型（relaxed-ordering）\"\u003e\u003ca href=\"#宽松模型（relaxed-ordering）\" class=\"headerlink\" title=\"宽松模型（relaxed ordering）\"\u003e\u003c/a\u003e宽松模型（relaxed ordering）\u003c/h3\u003e\u003cp\u003e顺序标记为 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的原子操作不参与构建\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系。在同一线程中，对\u003cstrong\u003e同一\u003c/strong\u003e原子变量的原子操作的顺序遵循源代码中的\u003cins\u003e先序（sequenced-before）\u003c/ins\u003e关系（从而有\u003cins\u003e先于（happens-before）\u003c/ins\u003e关系）。但是，在另外的线程看来，这种顺序无法保证。由于未加任何同步限制，顺序标记为 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的原子操作只是简单地遵循各个原子变量自身的修改顺序（modification-order）而已。\u003c/p\u003e\n\u003cp\u003e首先看一段简单的代码。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;assert.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; x{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e}, y{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003eint\u003c/span\u003e\u0026gt; z{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ewrite_x_then_y\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  x.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  y.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eread_y_then_x\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed));  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (x.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed)) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    z.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ea\u003c/span\u003e\u003cspan class=\"params\"\u003e(write_x_then_y)\u003c/span\u003e, \u003cspan class=\"title\"\u003eb\u003c/span\u003e\u003cspan class=\"params\"\u003e(read_y_then_x)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  a.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  b.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eassert\u003c/span\u003e(\u003cspan class=\"number\"\u003e0\u003c/span\u003e != z.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e());  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e按照经典的「穿插思维模型」（即顺序一致性模型），(3) 处循环等待直到 \u003ccode\u003ey\u003c/code\u003e 为真，那么\u003cstrong\u003e由于 (1) 先于 (2) 发生，(3) 先于 (4) 发生\u003c/strong\u003e，所以 (4) 必然为真，因此 (5) 的断言永不失效。但实际上，由于 (1) -- (4) 的顺序标记都是 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e，此处并无同步保证，也没有单线程中的先序关系保证。这也就是说，上述两个先于关系不一定成立；即便成立，(2) 不必然与 (3) \u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e，因此也就无法传递上述两个先于关系。所以站在 (4) 的角度看，并不保证 (1) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (4) 发生。所以 (4) 可能读到 \u003ccode\u003efalse\u003c/code\u003e 导致断言失败。\u003c/p\u003e\n\u003cp\u003e接下来再看一个更加复杂的例子。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e66\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e67\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e68\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e69\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e70\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e71\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e72\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e73\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003eint\u003c/span\u003e\u0026gt; x{\u003cspan class=\"number\"\u003e0\u003c/span\u003e}, y{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; ready{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"type\"\u003estatic\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003esize_t\u003c/span\u003e upper{\u003cspan class=\"number\"\u003e10UL\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title class_\"\u003eSnapshot\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003eint\u003c/span\u003e x{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003eint\u003c/span\u003e y{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSnapshot t1[upper];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSnapshot t2[upper];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003eSnapshot t3[upper];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eincrease\u003c/span\u003e\u003cspan class=\"params\"\u003e(std::atomic\u0026lt;\u003cspan class=\"type\"\u003eint\u003c/span\u003e\u0026gt;* var, Snapshot* snapshots)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!ready) {  \u003cspan class=\"comment\"\u003e// 1.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::\u003cspan class=\"built_in\"\u003eyield\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"type\"\u003esize_t\u003c/span\u003e i = \u003cspan class=\"number\"\u003e0\u003c/span\u003e; i != upper; ++i) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e\u0026amp; snapshot = snapshots[i];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    snapshot.x = x.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 2.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    snapshot.y = y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 3.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    var-\u0026gt;\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(i + \u003cspan class=\"number\"\u003e1\u003c/span\u003e, std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::\u003cspan class=\"built_in\"\u003eyield\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eobserve\u003c/span\u003e\u003cspan class=\"params\"\u003e(Snapshot* snapshots)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!ready) {  \u003cspan class=\"comment\"\u003e// 1.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::\u003cspan class=\"built_in\"\u003eyield\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"type\"\u003esize_t\u003c/span\u003e i = \u003cspan class=\"number\"\u003e0\u003c/span\u003e; i != upper; ++i) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e\u0026amp; snapshot = snapshots[i];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    snapshot.x = x.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 2.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    snapshot.y = y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 3.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::\u003cspan class=\"built_in\"\u003eyield\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eprint\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e Snapshot* snapshots)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"type\"\u003esize_t\u003c/span\u003e i = \u003cspan class=\"number\"\u003e0\u003c/span\u003e; i != upper; ++i) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e\u0026amp; snapshot = snapshots[i];\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (i \u0026gt; \u003cspan class=\"number\"\u003e0\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#39;,\u0026#39;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::cout \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;(\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; snapshot.x \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;,\u0026#34;\u003c/span\u003e \u0026lt;\u0026lt; snapshot.y \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#34;)\u0026#34;\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::cout \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003eT1\u003c/span\u003e\u003cspan class=\"params\"\u003e(increase, \u0026amp;x, t1)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003eT2\u003c/span\u003e\u003cspan class=\"params\"\u003e(increase, \u0026amp;y, t2)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003eT3\u003c/span\u003e\u003cspan class=\"params\"\u003e(observe, t3)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ready.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 1.c.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  T3.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  T2.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  T1.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eprint\u003c/span\u003e(t1);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eprint\u003c/span\u003e(t2);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eprint\u003c/span\u003e(t3);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e可能的输出如下：\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e$ ./a.out\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(0,2),(1,4),(2,5),(3,6),(4,7),(5,8),(6,9),(7,10),(8,10),(9,10)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(0,0),(0,1),(0,2),(1,3),(2,4),(3,5),(4,6),(5,7),(6,8),(7,9)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e(1,3),(2,4),(2,5),(3,6),(4,7),(5,8),(6,8),(7,9),(8,10),(8,10)\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e我们首先来观察一下代码和结果。\u003c/p\u003e\n\u003cp\u003e代码部分，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eincrease\u003c/code\u003e 等待 \u003ccode\u003eready\u003c/code\u003e 信号之后 (1)，开始执行 \u003ccode\u003eupper\u003c/code\u003e 次循环。每次循环以 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的顺序标记读取 \u003ccode\u003ex\u003c/code\u003e(2) 和 \u003ccode\u003ey\u003c/code\u003e(3) 的值，并记录在快照 \u003ccode\u003esnapshot\u003c/code\u003e 当中，而后以 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的顺序标记更新 \u003ccode\u003evar\u003c/code\u003e 指向的原子变量（要么是 \u003ccode\u003ex\u003c/code\u003e，要么是 \u003ccode\u003ey\u003c/code\u003e）。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eobserve\u003c/code\u003e 等待 \u003ccode\u003eready\u003c/code\u003e 信号之后 (1)，开始执行 \u003ccode\u003eupper\u003c/code\u003e 词循环。每次循环以 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的顺序标记读取 \u003ccode\u003ex\u003c/code\u003e(2) 和 \u003ccode\u003ey\u003c/code\u003e(3) 的值，并记录在快照 \u003ccode\u003esnapshot\u003c/code\u003e 当中。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eprint\u003c/code\u003e 打印历次循环得到的快照 (5)。每个二元组中，第一个数是当次循环读到的 \u003ccode\u003ex\u003c/code\u003e 的值；第二个数是对应的 \u003ccode\u003ey\u003c/code\u003e 的值。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eready\u003c/code\u003e 变量确保三个线程在几乎相同的时间开始，以防（例如说）\u003ccode\u003eT1\u003c/code\u003e 已经执行完毕而 \u003ccode\u003eT3\u003c/code\u003e 还尚未开始执行。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e结果部分，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e第一行、第二行、第三行分别记录了 \u003ccode\u003eT1\u003c/code\u003e, \u003ccode\u003eT2\u003c/code\u003e, \u003ccode\u003eT3\u003c/code\u003e 在历次循环过程中记录下来的 \u003ccode\u003ex\u003c/code\u003e 和 \u003ccode\u003ey\u003c/code\u003e 的值的快照。\u003c/li\u003e\n\u003cli\u003e关于写\u003cul\u003e\n\u003cli\u003e对于 \u003ccode\u003eT1\u003c/code\u003e 来说，只有该线程修改 \u003ccode\u003ex\u003c/code\u003e 的值，每次读到它，都恰好自增 \u003ccode\u003e1\u003c/code\u003e；\u003c/li\u003e\n\u003cli\u003e同样对于 \u003ccode\u003eT2\u003c/code\u003e 来说，\u003ccode\u003ey\u003c/code\u003e 每次自增 \u003ccode\u003e1\u003c/code\u003e。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e关于读\u003cul\u003e\n\u003cli\u003e对于 \u003ccode\u003eT1\u003c/code\u003e 和 \u003ccode\u003eT3\u003c/code\u003e 来说，它们只读 \u003ccode\u003ey\u003c/code\u003e 的值。因为 \u003ccode\u003ey\u003c/code\u003e 的修改序列中，\u003ccode\u003ey\u003c/code\u003e 的值是递增的；因此 \u003ccode\u003eT1\u003c/code\u003e 和 \u003ccode\u003eT3\u003c/code\u003e 每次读到的 \u003ccode\u003ey\u003c/code\u003e 的值都不小于前一次读到的 \u003ccode\u003ey\u003c/code\u003e 的值；但递增的步长不一定均衡。\u003c/li\u003e\n\u003cli\u003e对于 \u003ccode\u003eT2\u003c/code\u003e 和 \u003ccode\u003eT3\u003c/code\u003e 来说，它们只读 \u003ccode\u003ex\u003c/code\u003e 的值。基于同样的理由，它们每次读到的 \u003ccode\u003ex\u003c/code\u003e 的值都是非递减的；但递增的步长不一定均衡。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这里我们只给出了一个可能的结果，实际上，符合上述规律的结果，都是可能出现的。\u003c/p\u003e\n\u003cp\u003e接下来我们正式地描述宽松模型下的规律。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e对于任意给定的原子变量，其\u003cins\u003e修改顺序（modification-order）\u003c/ins\u003e是全局唯一的。\u003c/li\u003e\n\u003cli\u003e对于任意线程，\u003cul\u003e\n\u003cli\u003e若未曾读取过该变量的值，则可能读取到修改顺序上任意可能的值。\u003c/li\u003e\n\u003cli\u003e一旦读取了某个原子变量在修改顺序上的某个值，将来再读取时，要么读取相同的值，要么读取到在修改顺序上更靠后的值，而不可能读到在修改顺序上更靠前的值。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e对于任意线程，一旦写入了某个原子变量，将来再读取时，要么读取到此次写入的值，要么读取到修改顺序上相对此次写入更靠后的值。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e我们可以使用这一规律来回顾本节第一段代码。对于变量 \u003ccode\u003ex\u003c/code\u003e 来说，其修改顺序是：默认值 \u003ccode\u003efalse\u003c/code\u003e，由 \u003ccode\u003ewrite_x_then_y\u003c/code\u003e 写入的值 \u003ccode\u003etrue\u003c/code\u003e。在 \u003ccode\u003eread_y_then_x\u003c/code\u003e 线程当中，由于从未读取过 \u003ccode\u003ex\u003c/code\u003e 的值，因此可能读到 \u003ccode\u003ex\u003c/code\u003e 的修改顺序上的任意值。——可能是 \u003ccode\u003efalse\u003c/code\u003e，亦可能是 \u003ccode\u003etrue\u003c/code\u003e。故而断言可能失败。\u003c/p\u003e\n\u003ch3 id=\"获取-释放模型（acquire-release-ordering）\"\u003e\u003ca href=\"#获取-释放模型（acquire-release-ordering）\" class=\"headerlink\" title=\"获取-释放模型（acquire-release ordering）\"\u003e\u003c/a\u003e获取-释放模型（acquire-release ordering）\u003c/h3\u003e\u003cp\u003e接下来，我们讨论居于宽松模型和顺序一致模型当中的获取-释放模型（acquire-release ordering）。\u003c/p\u003e\n\u003cp\u003e获取-释放模型当中，依然不存在顺序一致模型当中那样的全局唯一操作顺序，但相较宽松模型，增加了部分同步能力。在获取-释放模型当中，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e原子-store 操作是\u003cins\u003e释放操作（release-operation）\u003c/ins\u003e（\u003ccode\u003estd::memory_order_acquire\u003c/code\u003e）；\u003c/li\u003e\n\u003cli\u003e原子-load 操作是\u003cins\u003e获取操作（acquire-operation）\u003c/ins\u003e（\u003ccode\u003estd::memory_order_release\u003c/code\u003e）；\u003c/li\u003e\n\u003cli\u003e原子-read-modify-write 操作（例如 \u003ccode\u003efetch_add\u003c/code\u003e 或是 \u003ccode\u003eexchange\u003c/code\u003e）则要么是释放操作，要么是获取操作，要么同时是释放-获取操作（\u003ccode\u003estd::memory_order_acq_rel\u003c/code\u003e）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e同步总是在线程之间成对出现的。一个线程中的释放操作与另一个线程中读到该次写入的获取操作\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e。这意味着，不同线程可能观察到不同的操作顺序，但这些顺序是有所限制的。\u003c/p\u003e\n\u003cp\u003e同样地，我们来看一个示例。这个例子是从顺序一致性模型的例子上稍加修改而来。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;cassert\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; x = {\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; y = {\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003eint\u003c/span\u003e\u0026gt; z = {\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ewrite_x\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  x.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_release);  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ewrite_y\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  y.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_release);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eread_x_then_y\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!x.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_acquire));  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_acquire)) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ++z;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eread_y_then_x\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_acquire));  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (x.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_acquire)) {  \u003cspan class=\"comment\"\u003e// 6.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ++z;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ea\u003c/span\u003e\u003cspan class=\"params\"\u003e(write_x)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003eb\u003c/span\u003e\u003cspan class=\"params\"\u003e(write_y)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ec\u003c/span\u003e\u003cspan class=\"params\"\u003e(read_x_then_y)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ed\u003c/span\u003e\u003cspan class=\"params\"\u003e(read_y_then_x)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  a.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); b.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); c.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); d.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eassert\u003c/span\u003e(z.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e() != \u003cspan class=\"number\"\u003e0\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// can fire\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e在本例中，断言可能失败。我们来做进一步分析。\u003c/p\u003e\n\u003cp\u003e(1) 处是释放操作；(3) 处通过循环确保读到 (1) 写入的值。因而 (1) 的释放操作与 (3) 的获取操作配对，建立\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e关系，于是 (1) 顺势与 (4) 建立\u003cins\u003e先于（happens-before）\u003c/ins\u003e 关系。同理，(2) 与 (5) 之间也有同步关系，(2) 顺势与 (6) 建立\u003cins\u003e先于（happens-before）\u003c/ins\u003e 关系。\u003c/p\u003e\n\u003cp\u003e然而，我们无法建立 (1) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (6) 的关系。故而 (6) 可能读到变量 \u003ccode\u003ex\u003c/code\u003e 的修改序列上的任意值。例如说，可能读到 \u003ccode\u003efalse\u003c/code\u003e。同理 (4) 也可能读到 \u003ccode\u003efalse\u003c/code\u003e。二者同时发生时，断言失败。\u003c/p\u003e\n\u003cp\u003e因为 store 操作发生在不同的线程，故而我们无法借助一个原子变量的同步关系，构造另一个原子变量的写与读之间的先于关系。这告诉我们两件事情。一是，对于多写多读的场景，我们往往需要顺序一致性模型。二是，若要应用获取-释放模型，store 操作应当发生在同一线程。\u003c/p\u003e\n\u003cp\u003e接下来我们再看一例。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;assert.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e x{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; y{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e z{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ewrite_x_then_y\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  x = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  y.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_release);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eread_y_then_x\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_acquire)) {  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::yield;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (x) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ++z;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ea\u003c/span\u003e\u003cspan class=\"params\"\u003e(write_x_then_y)\u003c/span\u003e, \u003cspan class=\"title\"\u003eb\u003c/span\u003e\u003cspan class=\"params\"\u003e(read_y_then_x)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  a.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); b.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eassert\u003c/span\u003e(z != \u003cspan class=\"number\"\u003e0\u003c/span\u003e):  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e考虑 (1) 和 (2) 在同一线程中，有\u003cins\u003e先序（sequenced-before）\u003c/ins\u003e关系（release 语义保证不乱序）；(3) 处的 spin-wait 保证读到 (2) 的写入，因而 (2) 与 (3) \u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e，再有 (3) 与 (4) 在同一线程中，也有先序关系（acquire 语义保证不乱序）。故而 (1) 必须先于 (4)，从而 (4) 的判断必定成立，而 (5) 的断言永不失败。\u003c/p\u003e\n\u003ch2 id=\"内存屏障\"\u003e\u003ca href=\"#内存屏障\" class=\"headerlink\" title=\"内存屏障\"\u003e\u003c/a\u003e内存屏障\u003c/h2\u003e\u003cp\u003eC++ 标准库也提供了内存屏障 \u003ccode\u003estd::atomic_thread_fence\u003c/code\u003e，它也可以打上顺序标签。\u003c/p\u003e\n\u003cp\u003e理解起来，带上 \u003ccode\u003estd::memory_order_release\u003c/code\u003e 的内存屏障，倾向于向下结合一个 store 操作，将它的内存顺序提升为 \u003ccode\u003estd::memory_order_release\u003c/code\u003e（如果原本是 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的话）。带上 \u003ccode\u003estd::memory_order_acquire\u003c/code\u003e 的内存屏障，倾向于向上结合一个 load 操作，将它的内存顺序提升为 \u003ccode\u003estd::memory_order_acquire\u003c/code\u003e（如果原本是 \u003ccode\u003estd::memory_order_relaxed\u003c/code\u003e 的话）。从而建立获取-释放的同步关系。\u003c/p\u003e\n\u003cp\u003e我们可以将上例稍加修改得到：\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;assert.h\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;atomic\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;thread\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e x{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003estd::atomic\u0026lt;\u003cspan class=\"type\"\u003ebool\u003c/span\u003e\u0026gt; y{\u003cspan class=\"literal\"\u003efalse\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e z{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ewrite_x_then_y\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  x = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::\u003cspan class=\"built_in\"\u003eatomic_thread_fence\u003c/span\u003e(std::memory_order_release);  \u003cspan class=\"comment\"\u003e// 2.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  y.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"literal\"\u003etrue\u003c/span\u003e, std::memory_order_relaxed);  \u003cspan class=\"comment\"\u003e// 2.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eread_y_then_x\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!y.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed)) {  \u003cspan class=\"comment\"\u003e// 3.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::this_thread::yield;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::\u003cspan class=\"built_in\"\u003eatomic_thread_fence\u003c/span\u003e(std::memory_order_acquire);  \u003cspan class=\"comment\"\u003e// 3.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (x) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    ++z;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003estd::thread \u003cspan class=\"title\"\u003ea\u003c/span\u003e\u003cspan class=\"params\"\u003e(write_x_then_y)\u003c/span\u003e, \u003cspan class=\"title\"\u003eb\u003c/span\u003e\u003cspan class=\"params\"\u003e(read_y_then_x)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  a.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e(); b.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eassert\u003c/span\u003e(z != \u003cspan class=\"number\"\u003e0\u003c/span\u003e):  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，(2.a) 的 release-屏障向下与 (2.b) 的宽松-store 操作结合，使得该操作提升为 release-store；(3.b) 的 acquire-屏障向上与 (3.a) 的宽松-load 操作结合，使得该操作提升为 acquire-load。reloease-store 和 acquire-load 构成\u003cins\u003e同步（synchronizes-with）\u003c/ins\u003e，又有 release/acquire 语义保证局部顺序，因此有 (1) \u003cins\u003e先于（happens-before）\u003c/ins\u003e (4)，从而 (5) 的断言不会失败。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2021-12-13T16:14:42Z",
  "Author": "Liam Huang"
}