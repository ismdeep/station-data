{
  "Source": "liam.page",
  "Title": "解决 MathJax 与 Markdown 的冲突",
  "Link": "https://liam.page/2015/09/09/fix-conflict-between-mathjax-and-markdown/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://www.mathjax.org/\"\u003eMathJax\u003c/a\u003e 是一个 JavaScript 引擎，能够将 LaTeX 语法书写的公式在网页上显示出来，而且效果杠杠的。\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://zh.wikipedia.org/zh/Markdown\"\u003eMarkdown\u003c/a\u003e 是一种轻量级的标记语言。用 Markdown 书写的文章，可以用 Markdown 解释器处理成标准的 HTML 文档。因此 Markdown 很适合用来写网络日志。\u003c/p\u003e\n\u003cp\u003e作为数学系毕业的学生，写博客时不可避免地会涉及到一些数学公式。可惜不巧，用 Markdown 写博客的我，在使用 MathJax 的时候遇到了一点麻烦。\u003c/p\u003e\n\u003cp\u003e在 Markdown 中，下划线 \u003ccode\u003e_\u003c/code\u003e 被保留，用作标记符号。比如 \u003ccode\u003e_Slant_\u003c/code\u003e 会生成倾斜的 _Slant_。在 LaTeX 中，下划线 \u003ccode\u003e_\u003c/code\u003e 被用作下标记号。比如 \u003ccode\u003ex_i\u003c/code\u003e 会生成 \u003ccode\u003e$x_i$\u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e由于 Markdown 在 MathJax 之前起作用，有时下标记号会被 Markdown 吃掉，变成 HTML 标记 \u003ccode\u003e\u0026lt;i\u0026gt;\u003c/code\u003e 而失去 LaTeX 的下标效果，造成数学公式显示不正常。比如 \u003ccode\u003eThis is an example: $f_i = f_{i + 1}$\u003c/code\u003e 里的两个下划线会被 Markdown 理解成倾斜的标记，这就不对了。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"分析与思路\"\u003e\u003ca href=\"#分析与思路\" class=\"headerlink\" title=\"分析与思路\"\u003e\u003c/a\u003e分析与思路\u003c/h2\u003e\u003cp\u003e问题的本质在于，下划线 \u003ccode\u003e_\u003c/code\u003e 首先被 Markdown 处理，变成 HTML 标记 \u003ccode\u003e\u0026lt;i\u0026gt;\u003c/code\u003e。之后，MathJax 会认为相关代码是不合法的公式代码，不予处理。比如上述例子，在 MathJax 看来会变成这样：\u003ccode\u003eThis is an example: $f\u0026lt;i\u0026gt;i = f\u0026lt;i\u0026gt;{i + 1}$\u003c/code\u003e——这是什么鬼（MathJax 内心独白）。因此，我们要做的，就是在 Markdown 处理文本的时候，将公式中的下划线保留起来；然后，再让 MathJax 去处理保留下来的下划线。\u003c/p\u003e\n\u003cp\u003e在 Markdown 中，我们可以用 backtip (`) 来做原样抄写（Verbatim）。也就是说，包含在两个 ` 中间的内容，会被 Markdown 原样保留下来。这正符合我们「保护下划线」的需求。于是，上述例子应该写成 \u003ccode\u003eThis is an example: `$f_i = f_{i + 1}$` \u003c/code\u003e。\u003c/p\u003e\n\u003cp\u003e问题看似解决了，不过却又引发了下一个问题。被反引号包括的部分，被 Markdown 当做代码来处理，会加上 HTML 标签 \u003ccode\u003e\u0026lt;code\u0026gt;\u003c/code\u003e。这样一来，MathJax 在处理文档时，就会跳过这一部分——虽然下划线被保留了，但是整个公式都被忽略了。\u003c/p\u003e\n\u003cp\u003e一个妥协的办法，是用 JavaScript 处理所有的 \u003ccode\u003e\u0026lt;code\u0026gt;\u003c/code\u003e 标签：如果发现 \u003ccode\u003e\u0026lt;code\u0026gt;\u003c/code\u003e 标签内包含数学公式（以美元符号 $ 开头结尾），那么就剥离标签，并调用 MathJax 处理。\u003c/p\u003e\n\u003cp\u003e下面我们来实现这一思路。\u003c/p\u003e\n\u003ch2 id=\"JavaScript-代码\"\u003e\u003ca href=\"#JavaScript-代码\" class=\"headerlink\" title=\"JavaScript 代码\"\u003e\u003c/a\u003eJavaScript 代码\u003c/h2\u003e\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u0026lt;script type=\u003cspan class=\"string\"\u003e\u0026#34;text/javascript\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"title function_\"\u003eyuuki_query_all_nodes_as_array\u003c/span\u003e(\u003cspan class=\"params\"\u003eselector\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"title class_\"\u003eArray\u003c/span\u003e.\u003cspan class=\"property\"\u003e\u003cspan class=\"keyword\"\u003eprototype\u003c/span\u003e\u003c/span\u003e.\u003cspan class=\"property\"\u003eslice\u003c/span\u003e.\u003cspan class=\"title function_\"\u003ecall\u003c/span\u003e(\u003cspan class=\"variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"title function_\"\u003equerySelectorAll\u003c/span\u003e(selector), \u003cspan class=\"number\"\u003e0\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"title function_\"\u003ereplace_code_to_span\u003c/span\u003e(\u003cspan class=\"params\"\u003enode\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  is_inline_math = \u003cspan class=\"regexp\"\u003e/^\\$(.*)\\$$/\u003c/span\u003e.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(node.\u003cspan class=\"property\"\u003etextContent\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  is_display_math = \u003cspan class=\"regexp\"\u003e/^\\$\\$(.*)\\$\\$$/m\u003c/span\u003es.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(node.\u003cspan class=\"property\"\u003etextContent\u003c/span\u003e) ||\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"regexp\"\u003e/^\\\\begin\\{.+\\}(.*)\\\\end\\{.+\\}/m\u003c/span\u003es.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(node.\u003cspan class=\"property\"\u003etextContent\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (is_inline_math || is_display_math) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e parent = node.\u003cspan class=\"property\"\u003eparentNode\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003evar\u003c/span\u003e replacement = \u003cspan class=\"variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"title function_\"\u003ecreateElement\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;span\u0026#39;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (is_display_math) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      replacement.\u003cspan class=\"property\"\u003eclass\u003c/span\u003e = \u003cspan class=\"string\"\u003e\u0026#34;yuuki_mathjax_inline\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      replacement.\u003cspan class=\"property\"\u003eclass\u003c/span\u003e = \u003cspan class=\"string\"\u003e\u0026#34;yuuki_mathjax_display\u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    replacement.\u003cspan class=\"property\"\u003etextContent\u003c/span\u003e = node.\u003cspan class=\"property\"\u003etextContent\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    parent.\u003cspan class=\"title function_\"\u003ereplaceChild\u003c/span\u003e(replacement, node);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;DOMContentLoaded\u0026#39;\u003c/span\u003e, \u003cspan class=\"keyword\"\u003efunction\u003c/span\u003e(\u003cspan class=\"params\"\u003e\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"title function_\"\u003eyuuki_query_all_nodes_as_array\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;code\u0026#34;\u003c/span\u003e).\u003cspan class=\"title function_\"\u003emap\u003c/span\u003e(replace_code_to_span);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e});\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e或者更简洁的\u003c/p\u003e\n\u003cfigure class=\"highlight javascript\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u0026lt;script type=\u003cspan class=\"string\"\u003e\u0026#34;text/javascript\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"variable language_\"\u003ewindow\u003c/span\u003e.\u003cspan class=\"title function_\"\u003eaddEventListener\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;DOMContentLoaded\u0026#39;\u003c/span\u003e, \u003cspan class=\"function\"\u003e() =\u0026gt;\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"variable language_\"\u003edocument\u003c/span\u003e.\u003cspan class=\"title function_\"\u003equerySelectorAll\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;code\u0026#39;\u003c/span\u003e).\u003cspan class=\"title function_\"\u003eforEach\u003c/span\u003e(\u003cspan class=\"function\"\u003e\u003cspan class=\"params\"\u003ecode\u003c/span\u003e =\u0026gt;\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003econst\u003c/span\u003e text = code.\u003cspan class=\"property\"\u003einnerHTML\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    is_inline_math = \u003cspan class=\"regexp\"\u003e/^\\$(.*)\\$$/\u003c/span\u003e.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(text);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    is_display_math = \u003cspan class=\"regexp\"\u003e/^\\$\\$(.*)\\$\\$$/m\u003c/span\u003es.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(text) || \u003cspan class=\"regexp\"\u003e/^\\\\begin\\{.+\\}(.*)\\\\end\\{.+\\}/m\u003c/span\u003es.\u003cspan class=\"title function_\"\u003eexec\u003c/span\u003e(text);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (is_inline_math || is_display_math) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      code.\u003cspan class=\"property\"\u003eparentElement\u003c/span\u003e.\u003cspan class=\"property\"\u003eclassList\u003c/span\u003e.\u003cspan class=\"title function_\"\u003eadd\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#39;has-jax\u0026#39;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (is_inline_math) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        code.\u003cspan class=\"property\"\u003eouterHTML\u003c/span\u003e = \u003cspan class=\"string\"\u003e\u0026#34;\u0026lt;span class=yuuki_mathjax_inline\u0026gt;\u0026#34;\u003c/span\u003e + text + \u003cspan class=\"string\"\u003e\u0026#34;\u0026lt;/span\u0026gt;\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        code.\u003cspan class=\"property\"\u003eouterHTML\u003c/span\u003e = \u003cspan class=\"string\"\u003e\u0026#34;\u0026lt;span class=yuuki_mathjax_display\u0026gt;\u0026#34;\u003c/span\u003e + text + \u003cspan class=\"string\"\u003e\u0026#34;\u0026lt;/span\u0026gt;\u0026#34;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  });\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e});\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026lt;/script\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，我们用正则表达式匹配了 \u003ccode\u003e\u0026lt;code\u0026gt;\u003c/code\u003e 标签内的美元符号，然后将 \u003ccode\u003e\u0026lt;code\u0026gt;\u003c/code\u003e 标签替换成 \u003ccode\u003e\u0026lt;span class=hpl_mathjax_inline\u0026gt;\u003c/code\u003e 标签。\u003c/p\u003e\n\u003cp\u003e经过这样一番处理，\u003ccode\u003eThis is an example: `$f_i = f_{i + 1}$` \u003c/code\u003e 就可以被正确处理为「This is an example: \u003ccode\u003e$f_i = f_{i + 1}$\u003c/code\u003e」了。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2015-09-08T16:32:37Z",
  "Author": "Liam Huang"
}