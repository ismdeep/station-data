{
  "Source": "liam.page",
  "Title": "设计一个线程池",
  "Link": "https://liam.page/2022/05/05/design-a-thread-pool/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e此篇我们通过逐步实现线程池，来探讨线程池中的关键技术。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"初步讨论\"\u003e\u003ca href=\"#初步讨论\" class=\"headerlink\" title=\"初步讨论\"\u003e\u003c/a\u003e初步讨论\u003c/h2\u003e\u003ch3 id=\"为什么需要线程池？\"\u003e\u003ca href=\"#为什么需要线程池？\" class=\"headerlink\" title=\"为什么需要线程池？\"\u003e\u003c/a\u003e为什么需要线程池？\u003c/h3\u003e\u003cp\u003e自 C++11 起，在 C++ 中使用线程就变得很简单。最基本地，可以用 \u003ccode\u003estd::thread\u003c/code\u003e 来管理一个线程。若是要异步地执行任务，搭配使用 \u003ccode\u003estd::async\u003c/code\u003e 和 \u003ccode\u003estd::future\u003c/code\u003e 也很方便。在有这些基础设施的基础上，我们为什么还需要线程池？或者说，我们什么时候需要线程池？\u003c/p\u003e\n\u003cp\u003e众所周知，线程作为一种系统资源，其创建和销毁是需要时间的。因此，如果创建和销毁线程的时间和执行任务所需的时间处在同一个数量级，那么频繁地创建和销毁线程带来的性能损耗就会变得十分可观。此时，我们就要考虑使用线程池。\u003c/p\u003e\n\u003ch3 id=\"线程池应有哪些特点？\"\u003e\u003ca href=\"#线程池应有哪些特点？\" class=\"headerlink\" title=\"线程池应有哪些特点？\"\u003e\u003c/a\u003e线程池应有哪些特点？\u003c/h3\u003e\u003cp\u003e线程池的本质就是一组待用的线程。在 C++ 中，它可以表示为一个 \u003ccode\u003estd::thread\u003c/code\u003e 的数组或是向量。在实际工程中，为便于进行可能的扩展，使用 \u003ccode\u003estd::vector\u0026lt;std::thread\u0026gt;\u003c/code\u003e 显然会更加合适。\u003c/p\u003e\n\u003cp\u003e对于线程池中的每个线程，它都可能在某个时刻接收到一个任务。而这个任务具体是什么，在线程创建时并不知道。用 C++ 的语言表达就是说，线程池中的线程：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e应当可以执行任意函数——支持任何参数列表，也支持任何返回值类型；\u003c/li\u003e\n\u003cli\u003e应当可以将任务的执行结果反馈给任务的发布者；\u003c/li\u003e\n\u003cli\u003e应当可以在需要时被唤醒执行任务，而在无需时不占用过多 CPU 资源；\u003c/li\u003e\n\u003cli\u003e应当可以被主控线程控制，在适当的时候暂停任务、停止接收任务、丢弃未完成任务等。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e对于第一条，modern C++ 的做法应该是利用 \u003ccode\u003efunctional\u003c/code\u003e 头文件提供的基础设施（\u003ccode\u003estd::bind\u003c/code\u003e, \u003ccode\u003estd::function\u003c/code\u003e 等）结合模板参数包来实现。对于第二条，old-fashion 的做法是在发布任务时同时注册回调函数；modern C++ 的做法应该是利用 \u003ccode\u003estd::packaged_task\u003c/code\u003e 结合 \u003ccode\u003estd::future\u003c/code\u003e 来实现。对于第三条，若是任务来得不那么频繁，应当考虑使用 \u003ccode\u003estd::condition_variable\u003c/code\u003e 来实现；若是任务十分频繁，则可以考虑使用 \u003ccode\u003estd::this_thread::yield\u003c/code\u003e。对于第四条，则可以设置一个内部变量作为标记，让每个工作线程都定期检查该标记来实现。\u003c/p\u003e\n\u003cp\u003e我们讨论到了任务。显然，我们会需要一个线程安全的队列来管理其他线程发布的任务。\u003c/p\u003e\n\u003ch2 id=\"线程安全队列\"\u003e\u003ca href=\"#线程安全队列\" class=\"headerlink\" title=\"线程安全队列\"\u003e\u003c/a\u003e线程安全队列\u003c/h2\u003e\u003cp\u003e我们不妨直接从代码入手，逐步分析。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003etemplate\u003c/span\u003e \u0026lt;\u003cspan class=\"keyword\"\u003etypename\u003c/span\u003e T\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eblocking_queue\u003c/span\u003e : \u003cspan class=\"keyword\"\u003eprotected\u003c/span\u003e std::queue\u0026lt;T\u0026gt; {  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e wlock = std::unique_lock\u0026lt;std::shared_mutex\u0026gt;;  \u003cspan class=\"comment\"\u003e// 2.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e rlock = std::shared_lock\u0026lt;std::shared_mutex\u0026gt;;  \u003cspan class=\"comment\"\u003e// 2.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eblocking_queue\u003c/span\u003e() = \u003cspan class=\"keyword\"\u003edefault\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ~\u003cspan class=\"built_in\"\u003eblocking_queue\u003c/span\u003e() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003eclear\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eblocking_queue\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e blocking_queue\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 3.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eblocking_queue\u003c/span\u003e(blocking_queue\u0026amp;\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 3.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  blocking_queue\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e blocking_queue\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e; \u003cspan class=\"comment\"\u003e// 3.c\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  blocking_queue\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(blocking_queue\u0026amp;\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 3.d\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eempty\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 4.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003eempty\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003esize_t\u003c/span\u003e \u003cspan class=\"title\"\u003esize\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 4.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003esize\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eclear\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ewhile\u003c/span\u003e (!std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003eempty\u003c/span\u003e()) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003epop\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003epush\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e T\u0026amp; obj)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 5.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003epush\u003c/span\u003e(obj);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003etemplate\u003c/span\u003e \u0026lt;\u003cspan class=\"keyword\"\u003etypename\u003c/span\u003e... Args\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eemplace\u003c/span\u003e\u003cspan class=\"params\"\u003e(Args\u0026amp;\u0026amp;... args)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 5.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003eemplace\u003c/span\u003e(std::forward\u0026lt;Args\u0026gt;(args)...);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003epop\u003c/span\u003e\u003cspan class=\"params\"\u003e(T\u0026amp; holder)\u003c/span\u003e \u003c/span\u003e{  \u003cspan class=\"comment\"\u003e// 6.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003eempty\u003c/span\u003e()) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      holder = std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003efront\u003c/span\u003e());\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      std::queue\u0026lt;T\u0026gt;::\u003cspan class=\"built_in\"\u003epop\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e std::shared_mutex mtx_;  \u003cspan class=\"comment\"\u003e// 7.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eblocking_queue\u003c/code\u003e 继承 \u003ccode\u003estd::queue\u003c/code\u003e，最基本的队列的实现交给标准库。\u003c/li\u003e\n\u003cli\u003e利用 \u003ccode\u003estd::shared_mutex\u003c/code\u003e 结合 \u003ccode\u003estd::unique_lock\u003c/code\u003e 和 \u003ccode\u003estd::shared_lock\u003c/code\u003e 实现读写锁。\u003c/li\u003e\n\u003cli\u003e此处我们禁用了拷贝和移动构造函数及对应的赋值运算符。这纯粹是因为在实现线程池的过程中我们用不到它们。如果需要，是可以按需实现的。\u003c/li\u003e\n\u003cli\u003e在两个 observers 当中，我们使用了只读锁。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epush\u003c/code\u003e 和 \u003ccode\u003eemplace\u003c/code\u003e 是类似的操作，都是在队尾追加元素。他们的区别与联系就和标准库容器的接口一样。注意在 \u003ccode\u003eemplace\u003c/code\u003e 当中，我们用到了完美转发技术。\u003c/li\u003e\n\u003cli\u003e这里的 \u003ccode\u003epop\u003c/code\u003e 其实更合适称作 \u003ccode\u003etry_pop\u003c/code\u003e。因为 \u003ccode\u003epop\u003c/code\u003e 动作在此处并不一定成功，在队列为空时，函数返回 \u003ccode\u003efalse\u003c/code\u003e 而不会对队列做任何修改。\u003c/li\u003e\n\u003cli\u003e这是一把针对整个队列的粗粒度锁。实际上，因为队列的 push 和 pop 一定程度上是分开的，小心地话，可以实现一个细粒度版本的锁，在 push 和 pop 操作都频繁的情况下会有显著的性能提升。关于这一点，我们之后可以单列一篇文章进行讨论。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"线程池\"\u003e\u003ca href=\"#线程池\" class=\"headerlink\" title=\"线程池\"\u003e\u003c/a\u003e线程池\u003c/h2\u003e\u003ch3 id=\"接口定义\"\u003e\u003ca href=\"#接口定义\" class=\"headerlink\" title=\"接口定义\"\u003e\u003c/a\u003e接口定义\u003c/h3\u003e\u003cp\u003e按先前的讨论，我们可以整理出线程池的大致模样：\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003ethreadpool\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003einit\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003eint\u003c/span\u003e num)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eterminate\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// stop and process all delegated tasks\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ecancel\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003c/span\u003e;     \u003cspan class=\"comment\"\u003e// stop and drop all tasks remained in queue\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003einited\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eis_running\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003esize\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003etemplate\u003c/span\u003e \u0026lt;\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eF\u003c/span\u003e, \u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e... Args\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e \u003cspan class=\"title\"\u003easync\u003c/span\u003e\u003cspan class=\"params\"\u003e(F\u0026amp;\u0026amp; f, Args\u0026amp;\u0026amp;... args)\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e -\u0026gt; std::future\u0026lt;\u003cspan class=\"title\"\u003edecltype\u003c/span\u003e\u003cspan class=\"params\"\u003e(f(args...))\u003c/span\u003e\u0026gt;\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::vector\u0026lt;std::thread\u0026gt; workers_;  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e blocking_queue\u0026lt;std::function\u0026lt;\u003cspan class=\"type\"\u003evoid\u003c/span\u003e()\u0026gt;\u0026gt; tasks_;  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col\u003e\n\u003cli\u003e第一组的三个接口是整个线程池的控制接口。\u003ccode\u003einit\u003c/code\u003e 接口启动线程池，其参数 \u003ccode\u003enum\u003c/code\u003e 即是线程池中线程的数量。\u003ccode\u003eterminate\u003c/code\u003e 接口终止线程池，不再接受新的任务，并保证将已接受的任务处理完毕。\u003ccode\u003ecancel\u003c/code\u003e 与 \u003ccode\u003eterminate\u003c/code\u003e 类似，但它将丢弃已接受但未处理完毕的任务。\u003c/li\u003e\n\u003cli\u003e第二组的三个接口均是 observers。\u003c/li\u003e\n\u003cli\u003e第三组中的唯一一个接口是线程池接受外部任务的接口。它和标准库提供的 \u003ccode\u003estd::async\u003c/code\u003e 几乎一致，接受任意函数，并返回一个 \u003ccode\u003estd::future\u003c/code\u003e。\u003c/li\u003e\n\u003cli\u003e这是线程池本体。\u003c/li\u003e\n\u003cli\u003e这是任务队列。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"线程池的控制接口\"\u003e\u003ca href=\"#线程池的控制接口\" class=\"headerlink\" title=\"线程池的控制接口\"\u003e\u003c/a\u003e线程池的控制接口\u003c/h3\u003e\u003cp\u003e接下来我们讨论控制接口的具体实现。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e57\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e58\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e59\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e60\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e61\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e62\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e63\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e64\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e65\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::init\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003eint\u003c/span\u003e num)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::\u003cspan class=\"built_in\"\u003ecall_once\u003c/span\u003e(once_, [\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e, num]() {  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    wlock \u003cspan class=\"built_in\"\u003elock\u003c/span\u003e(mtx_);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    stop_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    cancel_ = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    workers_.\u003cspan class=\"built_in\"\u003ereserve\u003c/span\u003e(num);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"type\"\u003eint\u003c/span\u003e i = \u003cspan class=\"number\"\u003e0\u003c/span\u003e; i \u0026lt; num; ++i) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      workers_.\u003cspan class=\"built_in\"\u003eemplace_back\u003c/span\u003e(std::\u003cspan class=\"built_in\"\u003ebind\u003c/span\u003e(\u0026amp;threadpool::spawn, \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e));  \u003cspan class=\"comment\"\u003e// 3.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    inited_ = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  });\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::spawn\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{  \u003cspan class=\"comment\"\u003e// 3.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (;;) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"type\"\u003ebool\u003c/span\u003e pop = \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::function\u0026lt;\u003cspan class=\"type\"\u003evoid\u003c/span\u003e()\u0026gt; task;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      cond_.\u003cspan class=\"built_in\"\u003ewait\u003c/span\u003e(lock, [\u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e, \u0026amp;pop, \u0026amp;task] {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        pop = tasks_.\u003cspan class=\"built_in\"\u003epop\u003c/span\u003e(task);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e cancel_ || stop_ || pop;  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      });\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (cancel_ || (stop_ \u0026amp;\u0026amp; !pop)) {  \u003cspan class=\"comment\"\u003e// 5.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003etask\u003c/span\u003e();  \u003cspan class=\"comment\"\u003e// 5.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::terminate\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{  \u003cspan class=\"comment\"\u003e// 6.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (_is_running()) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      stop_ = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 7.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  cond_.\u003cspan class=\"built_in\"\u003enotify_all\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e\u0026amp; worker : workers_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    worker.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::cancel\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{  \u003cspan class=\"comment\"\u003e// 6.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003ewlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (_is_running()) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      cancel_ = \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 7.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  tasks_.\u003cspan class=\"built_in\"\u003eclear\u003c/span\u003e();  \u003cspan class=\"comment\"\u003e// 8.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  cond_.\u003cspan class=\"built_in\"\u003enotify_all\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003efor\u003c/span\u003e (\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e\u0026amp; worker : workers_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    worker.\u003cspan class=\"built_in\"\u003ejoin\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e threadpool::_is_running() \u003cspan class=\"type\"\u003econst\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e inited_ \u0026amp;\u0026amp; !stop_ \u0026amp;\u0026amp; !cancel_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003einit\u003c/code\u003e 完成的工作，在逻辑上只能进行一次。但我们无法保证用户代码确实如我们所想地这样执行。因此，我们利用 \u003ccode\u003estd::call_once\u003c/code\u003e 保证相关工作只执行一次。\u003c/li\u003e\n\u003cli\u003e因为涉及到修改 \u003ccode\u003ethreadpool\u003c/code\u003e 的状态，所以此处使用写入锁。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003espawn\u003c/code\u003e 接口是线程函数，也就是线程启动后一直运行的函数。\u003c/li\u003e\n\u003cli\u003e当线程被唤醒时（无论是意外唤醒，还是被 \u003ccode\u003enotify_*\u003c/code\u003e 函数唤醒），若线程池没有被 \u003ccode\u003ecancel\u003c/code\u003e 或是 \u003ccode\u003eterminate\u003c/code\u003e，也没能从任务队列中取出任务，则线程应该继续沉眠，否则就应该醒来继续处理。\u003c/li\u003e\n\u003cli\u003e如果线程池被 \u003ccode\u003ecancel\u003c/code\u003e，则不执行当前任务；如果线程池被停止并且没能从任务队列中取出任务，则也不执行当前任务；否则就执行当前任务。\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eterminate\u003c/code\u003e 和 \u003ccode\u003ecancel\u003c/code\u003e 的实现几乎完全相同；\u003c/li\u003e\n\u003cli\u003e唯独 \u003ccode\u003eterminate\u003c/code\u003e 修改 \u003ccode\u003estop_\u003c/code\u003e 变量而 \u003ccode\u003ecancel\u003c/code\u003e 修改 \u003ccode\u003ecancel_\u003c/code\u003e 变量。\u003c/li\u003e\n\u003cli\u003e此外，\u003ccode\u003ecancel\u003c/code\u003e 接口显式地清空了任务队列。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"线程池的观察器\"\u003e\u003ca href=\"#线程池的观察器\" class=\"headerlink\" title=\"线程池的观察器\"\u003e\u003c/a\u003e线程池的观察器\u003c/h3\u003e\u003cp\u003e观察器比较简单，唯一值得一提的是这里使用了读取锁。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::inited\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e inited_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::is_running\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e _is_running();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003einline\u003c/span\u003e \u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::size\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e workers_.\u003cspan class=\"built_in\"\u003esize\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003ch3 id=\"任务接口\"\u003e\u003ca href=\"#任务接口\" class=\"headerlink\" title=\"任务接口\"\u003e\u003c/a\u003e任务接口\u003c/h3\u003e\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003etemplate\u003c/span\u003e \u0026lt;\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eF\u003c/span\u003e, \u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e... Args\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e \u003cspan class=\"title\"\u003ethreadpool::async\u003c/span\u003e\u003cspan class=\"params\"\u003e(F\u0026amp;\u0026amp; f, Args\u0026amp;\u0026amp;... args)\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e    -\u0026gt; std::future\u0026lt;\u003cspan class=\"title\"\u003edecltype\u003c/span\u003e\u003cspan class=\"params\"\u003e(f(args...))\u003c/span\u003e\u0026gt; \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"type\"\u003ereturn_t\u003c/span\u003e = \u003cspan class=\"keyword\"\u003edecltype\u003c/span\u003e(\u003cspan class=\"built_in\"\u003ef\u003c/span\u003e(args...));  \u003cspan class=\"comment\"\u003e// 1.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"type\"\u003efuture_t\u003c/span\u003e = std::future\u0026lt;\u003cspan class=\"type\"\u003ereturn_t\u003c/span\u003e\u0026gt;;  \u003cspan class=\"comment\"\u003e// 1.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e \u003cspan class=\"type\"\u003etask_t\u003c/span\u003e = std::packaged_task\u0026lt;\u003cspan class=\"built_in\"\u003ereturn_t\u003c/span\u003e()\u0026gt;;  \u003cspan class=\"comment\"\u003e// 1.c\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"function\"\u003erlock \u003cspan class=\"title\"\u003elock\u003c/span\u003e\u003cspan class=\"params\"\u003e(mtx_)\u003c/span\u003e\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (stop_ || cancel_)\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ethrow\u003c/span\u003e std::\u003cspan class=\"built_in\"\u003eruntime_error\u003c/span\u003e(\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"string\"\u003e\u0026#34;Delegating task to a threadpool \u0026#34;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e          \u003cspan class=\"string\"\u003e\u0026#34;that has been terminated or canceled.\u0026#34;\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e bind_func = std::\u003cspan class=\"built_in\"\u003ebind\u003c/span\u003e(std::forward\u0026lt;F\u0026gt;(f), std::forward\u0026lt;Args\u0026gt;(args)...);  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::shared_ptr\u0026lt;\u003cspan class=\"type\"\u003etask_t\u003c/span\u003e\u0026gt; task = std::\u003cspan class=\"built_in\"\u003emake_shared\u003c/span\u003e\u0026lt;\u003cspan class=\"type\"\u003etask_t\u003c/span\u003e\u0026gt;(std::\u003cspan class=\"built_in\"\u003emove\u003c/span\u003e(bind_func));  \u003cspan class=\"comment\"\u003e// 4.a\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003efuture_t\u003c/span\u003e fut = task-\u0026gt;\u003cspan class=\"built_in\"\u003eget_future\u003c/span\u003e();  \u003cspan class=\"comment\"\u003e// 4.b\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  tasks_.\u003cspan class=\"built_in\"\u003eemplace\u003c/span\u003e([task]() -\u0026gt; \u003cspan class=\"type\"\u003evoid\u003c/span\u003e { (*task)(); });  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  cond_.\u003cspan class=\"built_in\"\u003enotify_one\u003c/span\u003e();  \u003cspan class=\"comment\"\u003e// 6.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e fut;  \u003cspan class=\"comment\"\u003e// 4.c\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003col\u003e\n\u003cli\u003e利用 \u003ccode\u003eusing\u003c/code\u003e 定义的三个类型，见文知意。\u003c/li\u003e\n\u003cli\u003e这里不涉及对线程池状态的修改，因此只需要读取锁即可。显然，此处我们禁止对已经 \u003ccode\u003eterminate\u003c/code\u003e 或是 \u003ccode\u003ecancel\u003c/code\u003e 的线程池继续发布任务。\u003c/li\u003e\n\u003cli\u003e由于任务队列只接收 \u003ccode\u003estd::function\u0026lt;void()\u0026gt;\u003c/code\u003e 的可调用对象，此处我们利用 \u003ccode\u003estd::bind\u003c/code\u003e 先匹配参数列表。\u003c/li\u003e\n\u003cli\u003e此处我们利用 \u003ccode\u003estd::packaged_task\u003c/code\u003e 将待执行的任务与一个 \u003ccode\u003estd::future\u003c/code\u003e 关联起来，并将 \u003ccode\u003estd::future\u003c/code\u003e 返回给外界，以便任务发布者可以在将来取得任务执行结果。\u003c/li\u003e\n\u003cli\u003e这里我们利用一个 lambda，既执行了任务，又将返回值抹去（但会被 future 管理），以便匹配 \u003ccode\u003estd::function\u0026lt;void()\u0026gt;\u003c/code\u003e。\u003c/li\u003e\n\u003cli\u003e此处我们通过条件变量唤醒工作线程。\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"完整实现\"\u003e\u003ca href=\"#完整实现\" class=\"headerlink\" title=\"完整实现\"\u003e\u003c/a\u003e完整实现\u003c/h3\u003e\u003cp\u003e完整实现可见 \u003ca target=\"_blank\" rel=\"noopener\" href=\"https://github.com/Liam0205/toy-threadpool\"\u003eLiam0205/toy-threadpool\u003c/a\u003e，其中包括了单元测试和相比 \u003ccode\u003estd::async\u003c/code\u003e 的性能对比。\u003c/p\u003e\n\u003ch2 id=\"跋\"\u003e\u003ca href=\"#跋\" class=\"headerlink\" title=\"跋\"\u003e\u003c/a\u003e跋\u003c/h2\u003e\u003cp\u003e这里我们实现了一个可看使用的线程池。但如 GitHub 的 repo 名字一样，它还只是个玩具。若要在工程中使用，还可以做一系列优化。例如说：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e对线程安全队列进行优化，使用更细粒度的锁（完整实现当中已有），或者换用无锁实现。\u003c/li\u003e\n\u003cli\u003e完善的线程池，除了支持本文提到的几种状态，还可以有暂停、扩张（任务过多时自动扩张）、收缩（空闲线程过多时自动收缩）等能力。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这些内容都可以继续去深挖、优化。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2022-05-05T12:30:35Z",
  "Author": "Liam Huang"
}