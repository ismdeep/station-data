{
  "Source": "liam.page",
  "Title": "在 C++ 中实现一个线程安全的频率限制器",
  "Link": "https://liam.page/2020/05/17/Implementing-a-Thread-safe-Rate-Limiter-in-C/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e很早以前，在学习使用 Python 的 \u003ccode\u003edeque\u003c/code\u003e 容器时，我\u003ca href=\"/2016/09/23/using-deque-to-implement-marquee-and-rate-limiter/\"\u003e实现了一个玩具版的频率限制器\u003c/a\u003e。最近需要压测线上服务的性能，又不愿意总是在 QA 那边排队，于是需要自己写一个压测用的客户端。其中一个核心需求就是要实现 QPS 限制。\u003c/p\u003e\n\u003cp\u003e于是，终究逃不开要在 C++ 中实现一个线程安全的频率限制器。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"设计思路\"\u003e\u003ca href=\"#设计思路\" class=\"headerlink\" title=\"设计思路\"\u003e\u003c/a\u003e设计思路\u003c/h2\u003e\u003cp\u003e所谓频率限制，就是要在一个时间段（inteval）中，限制操作的次数（limit）。这又可以引出两种强弱不同的表述：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e强表述：在任意一个长度等于设定的时间段（interval）的滑动窗口中，频率限制器放行的操作次数（count）都不高于限制次数（limit）。\u003c/li\u003e\n\u003cli\u003e弱表述：在一组长度等于设定的时间段（interval）且紧密相连的固定窗口中，每一个窗口里频率限制器放行的操作次数（count）都不高于限制次数（limit）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e不难发现，强表述通过「滑动窗口」的方式，不仅限制了频率，还要求了操作在时间上的均匀性。前作的频率限制器，实际上对应了这里的强表述。但实际工程中，我们通常只需要实现弱表述的频率限制器就足够使用了。\u003c/p\u003e\n\u003cp\u003e对于弱表述，实现起来主要思路如下：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e当操作计数（count）小于限制（limit）时直接放行；\u003c/li\u003e\n\u003cli\u003e当操作计数（count）不小于限制（limit）时，继续判断当前时间与上一次记录时间戳（timestamp）的差值。\u003cul\u003e\n\u003cli\u003e若差值不小于设定的时间段（interval），则更新记录时间戳、将计数重置为 \u003ccode\u003e1\u003c/code\u003e 并放行；\u003c/li\u003e\n\u003cli\u003e否则拒绝操作。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"单线程实现\"\u003e\u003ca href=\"#单线程实现\" class=\"headerlink\" title=\"单线程实现\"\u003e\u003c/a\u003e单线程实现\u003c/h2\u003e\u003cp\u003e在不考虑线程安全时，不难给出这样的实现。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e35\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e36\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e37\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e38\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e39\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e40\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e41\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e42\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e43\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e44\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e45\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e46\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e47\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e48\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e49\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e50\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e51\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e52\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e53\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e54\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e55\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e56\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003estruct\u003c/span\u003e \u003cspan class=\"title class_\"\u003ems_clock\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e rep        = std::chrono::milliseconds::rep;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e period     = std::chrono::milliseconds::period;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e duration   = std::chrono::duration\u0026lt;rep, period\u0026gt;;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e time_point = std::chrono::time_point\u0026lt;ms_clock, duration\u0026gt;;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003estatic\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e  time_point \u003cspan class=\"title\"\u003enow\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"keyword\"\u003enoexcept\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"built_in\"\u003etime_point\u003c/span\u003e(std::chrono::\u003cspan class=\"built_in\"\u003eduration_cast\u003c/span\u003e\u0026lt;duration\u0026gt;(\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e                  std::chrono::steady_clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e()));\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}  \u003cspan class=\"comment\"\u003e// namespace __details\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eRateLimiter\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e clock    = __details::ms_clock;  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e        limit_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003econst\u003c/span\u003e clock::duration interval_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"type\"\u003econst\u003c/span\u003e clock::rep      interval_count_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e \u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e   count_{std::numeric_limits\u0026lt;\u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e\u0026gt;::\u003cspan class=\"built_in\"\u003emax\u003c/span\u003e()};  \u003cspan class=\"comment\"\u003e// 2.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e clock::rep timestamp_{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};                                 \u003cspan class=\"comment\"\u003e// 2.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"keyword\"\u003econstexpr\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e limit, clock::duration interval)\u003c/span\u003e :\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e    limit_(limit), interval_(interval), interval_count_(interval_.count()) {\u003c/span\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eRateLimiter\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e RateLimiter\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;             \u003cspan class=\"comment\"\u003e// 3.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  RateLimiter\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e RateLimiter\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// 3.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eRateLimiter\u003c/span\u003e(RateLimiter\u0026amp;\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;                  \u003cspan class=\"comment\"\u003e// 3.c.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  RateLimiter\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(RateLimiter\u0026amp;\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;       \u003cspan class=\"comment\"\u003e// 3.d.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eoperator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003edouble\u003c/span\u003e \u003cspan class=\"title\"\u003eqps\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e1000.0\u003c/span\u003e * \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_ / \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter::operator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_++;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e ts  = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e now = clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e().\u003cspan class=\"built_in\"\u003ecount\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (now - ts \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_) {  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_ = now;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_     = \u003cspan class=\"number\"\u003e1\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(1) 表明频率限制器使用单位为毫秒的时钟。在实际使用时，也可以按需改成微妙甚至纳秒。\u003c/li\u003e\n\u003cli\u003e(2) 使用 \u003ccode\u003emutable\u003c/code\u003e 修饰内部状态 \u003ccode\u003ecount_\u003c/code\u003e 和 \u003ccode\u003etimestamp_\u003c/code\u003e。这是因为两个 \u003ccode\u003elimit_\u003c/code\u003e 和 \u003ccode\u003einterval_\u003c/code\u003e 相同的频率限制器，在逻辑上是等价的，但他们的内部状态却不一定相同。因此，为了让 \u003ccode\u003econst\u003c/code\u003e 成员函数能够修改内部状态（而不改变逻辑等价），我们要给内部状态数据成员加上 \u003ccode\u003emutable\u003c/code\u003e 修饰。\u003cul\u003e\n\u003cli\u003e(2.a) 处将 \u003ccode\u003ecount_\u003c/code\u003e 设置为类型可表示的最大值是为了让 (4) 的判断失败，而对 \u003ccode\u003etimestamp_\u003c/code\u003e 进行初始化。\u003c/li\u003e\n\u003cli\u003e(2.b) 处将 \u003ccode\u003etimestamp_\u003c/code\u003e 设置为 \u003ccode\u003e0\u003c/code\u003e 则是基于同样的原因，让 (5) 的判断失败。\u003c/li\u003e\n\u003cli\u003e(2.a) 和 (2.b) 处通过巧妙的初值设计，将初始化状态与后续正常工作状态的逻辑统一了起来，而无须丑陋的判断。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e(3) 禁止了对象的拷贝和移动。这是因为一个频率限制器应绑定一组操作，而不应由两组或更多组操作共享（对于拷贝的情形），或是中途失效（对于移动的情形）。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e如此一来，函数调用运算符就忠实地实现了前述逻辑。\u003c/p\u003e\n\u003ch2 id=\"多线程改造\"\u003e\u003ca href=\"#多线程改造\" class=\"headerlink\" title=\"多线程改造\"\u003e\u003c/a\u003e多线程改造\u003c/h2\u003e\u003ch3 id=\"第一步改造\"\u003e\u003ca href=\"#第一步改造\" class=\"headerlink\" title=\"第一步改造\"\u003e\u003c/a\u003e第一步改造\u003c/h3\u003e\u003cp\u003e当有多线程同时调用 \u003ccode\u003eRateLimiter::operator()\u003c/code\u003e 时，显而易见，在 \u003ccode\u003ecount_\u003c/code\u003e 和 \u003ccode\u003etimestamp_\u003c/code\u003e 上会产生竞争。我们有两种办法解决这个问题：要不然加锁，要不然把 \u003ccode\u003ecount_\u003c/code\u003e 和 \u003ccode\u003etimestamp_\u003c/code\u003e 设为原子变量然后用原子操作解决问题。于是，对函数调用运算符，我们有如下第一步的改造。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eRateLimiter\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// 其余保持不变\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e std::atomic\u0026lt;\u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e\u0026gt;   count_{std::numeric_limits\u0026lt;\u003cspan class=\"type\"\u003euint64_t\u003c/span\u003e\u0026gt;::\u003cspan class=\"built_in\"\u003emax\u003c/span\u003e()};  \u003cspan class=\"comment\"\u003e// 1.a.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003emutable\u003c/span\u003e std::atomic\u0026lt;clock::rep\u0026gt; timestamp_{\u003cspan class=\"number\"\u003e0\u003c/span\u003e};                                 \u003cspan class=\"comment\"\u003e// 1.b.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// 其余保持不变\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter::operator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e ts  = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e();  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e now = clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e().\u003cspan class=\"built_in\"\u003ecount\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (now - ts \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(now);  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e(1) 将 \u003ccode\u003ecount_\u003c/code\u003e 和 \u003ccode\u003etimestamp_\u003c/code\u003e 声明为原子的，从而方便后续进行原子操作。\u003c/li\u003e\n\u003cli\u003e(2) -- (5) 则将原有操作分别改为对应的原子操作。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这样看起来很完美，但其实是有 bug 的。我们重点关注 (4) 这里。(4) 的本意是更新 \u003ccode\u003etimestamp_\u003c/code\u003e，以备下一次 \u003ccode\u003eorig_count \u0026gt;= this-\u0026gt;limit_\u003c/code\u003e 时进行判断。准确设置这一 \u003ccode\u003etimestamp\u003c/code\u003e 是频率限制器正确工作的基石。但是，\u003cstrong\u003e如果有两个（或更多）线程，同时走到了 (4)\u003c/strong\u003e 会发生什么？\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e因为原子操作的存在，两个线程会先后执行 (4)。于是 \u003ccode\u003etimestamp_\u003c/code\u003e 的值究竟是什么，我们完全不可预期。\u003c/li\u003e\n\u003cli\u003e此外，两个线程会先后执行 (5)，即原子地将 \u003ccode\u003ecount_\u003c/code\u003e 置为 \u003ccode\u003e1\u003c/code\u003e。但是你想，频率限制器先后放行了两次操作，但为什么 \u003ccode\u003ecount_\u003c/code\u003e 是 \u003ccode\u003e1\u003c/code\u003e 呢？这是不是就「偷跑」了一次操作？\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e为此，我们要保证只有一个线程会真正设置 \u003ccode\u003etimestamp_\u003c/code\u003e，而拒绝其他同样走到 (4) 位置的线程的操作，以避免其重复设置 \u003ccode\u003etimestamp_\u003c/code\u003e 以及错误地将 \u003ccode\u003ecount_\u003c/code\u003e 再次置为 \u003ccode\u003e1\u003c/code\u003e。\u003c/p\u003e\n\u003ch3 id=\"第二步改进\"\u003e\u003ca href=\"#第二步改进\" class=\"headerlink\" title=\"第二步改进\"\u003e\u003c/a\u003e第二步改进\u003c/h3\u003e\u003cp\u003e于是有以下改进。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter::operator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 3.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_) {  \u003cspan class=\"comment\"\u003e// 4.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e ts  = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e now = clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e().\u003cspan class=\"built_in\"\u003ecount\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (now - ts \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_) {  \u003cspan class=\"comment\"\u003e// 5.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003ecompare_and_exchange_strong\u003c/span\u003e(ts, now)) {  \u003cspan class=\"comment\"\u003e// 1.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);  \u003cspan class=\"comment\"\u003e// 2.\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，(1) 是一个 CAS 原子操作。它会原子地比较 \u003ccode\u003etimestamp_\u003c/code\u003e 和 \u003ccode\u003ets\u003c/code\u003e 的值（Compare）：若他们相等，则将 \u003ccode\u003enow\u003c/code\u003e 的值写入 \u003ccode\u003etimestamp_\u003c/code\u003e（Swap），并返回 \u003ccode\u003etrue\u003c/code\u003e；若他们不相等，则将 \u003ccode\u003etimestamp_\u003c/code\u003e 的值写入 \u003ccode\u003ets\u003c/code\u003e，并返回 \u003ccode\u003efalse\u003c/code\u003e。如果没有其他线程抢先修改 \u003ccode\u003etimestamp_\u003c/code\u003e 的值，那么 CAS 操作应该成功并返回 \u003ccode\u003etrue\u003c/code\u003e，继续执行后面的代码；否则，说明其他线程已经抢先修改了 \u003ccode\u003etimestamp_\u003c/code\u003e，当前线程的操作被记入上一个周期而被频率限制器拒绝。\u003c/p\u003e\n\u003cp\u003e现在要考虑 (2)。如果执行完 (1) 之后立即立刻马上没有任何延迟地执行 (2)，那么当然一切大吉。但如果这时候当前线程被切出去，会发生什么？我们要分情况讨论。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e如果 \u003ccode\u003ets == 0\u003c/code\u003e，也就是「当前线程」是频率限制器第一次修改 \u003ccode\u003etimestamp_\u003c/code\u003e。于是，当前线程可能会在 (3) 处将 \u003ccode\u003ecount_\u003c/code\u003e （溢出地）自增为 \u003ccode\u003e0\u003c/code\u003e，从而可能有其他线程通过 (4)。此时，当前线程在当前分片有可能应当被拒绝操作。为此，我们需要在 (1) 和 (2) 之间做额外的判断。\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (ts == \u003cspan class=\"number\"\u003e0\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\u003c/li\u003e\n\u003cli\u003e如果 \u003ccode\u003ets != 0\u003c/code\u003e，也就是「当前线程」并非频率限制器第一次修改 \u003ccode\u003etimestamp_\u003c/code\u003e。那么其他线程在 (4) 处必然判断失败，但在 (5) 处的判断可能成功，从而可能继续成功执行 (1)，从而接连两次执行 (2)。但这不影响正确性。因为通过 (5) 表明相对当前线程填入的 \u003ccode\u003etimestamp_\u003c/code\u003e，已经由过了一个时间段（interval），而在这个时间段里，只有当前线程的一次操作会被接受。\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"第三次改进\"\u003e\u003ca href=\"#第三次改进\" class=\"headerlink\" title=\"第三次改进\"\u003e\u003c/a\u003e第三次改进\u003c/h3\u003e\u003cp\u003e由此，我们得到：\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter::operator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e ts  = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e now = clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e().\u003cspan class=\"built_in\"\u003ecount\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (now - ts \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003ecompare_and_exchange_strong\u003c/span\u003e(ts, now)) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (ts == \u003cspan class=\"number\"\u003e0\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e至此，我们的代码在逻辑上已经成立了，接下来要做一些性能方面的优化。\u003c/p\u003e\n\u003cp\u003e原子操作默认采用 \u003ccode\u003estd::memory_order_seq_cst\u003c/code\u003e 的内存模型。这是 C++ 中最严格的内存模型，它有两个保证：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e程序指令和源码顺序一致；\u003c/li\u003e\n\u003cli\u003e所有线程的所有操作都有一致的顺序。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e为了实现顺序一致性（sequential consistency），编译器会使用很多对抗编译器优化和 CPU 乱序执行（Out-of-Order Execution）的手段，因而性能较差。对于此处的 \u003ccode\u003ecount_\u003c/code\u003e，我们无需顺序一致性模型，只需要获取释放-模型（Aquire-Release）模型就足够了。对 \u003ccode\u003ecount_\u003c/code\u003e 施加获取-释放模型之后，\u003ccode\u003etimestamp_\u003c/code\u003e 就只需宽松模型即可。\u003c/p\u003e\n\u003ch3 id=\"第四次改进\"\u003e\u003ca href=\"#第四次改进\" class=\"headerlink\" title=\"第四次改进\"\u003e\u003c/a\u003e第四次改进\u003c/h3\u003e\u003cp\u003e于是有第四次改进：\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003ebool\u003c/span\u003e \u003cspan class=\"title\"\u003eRateLimiter::operator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e, std::memory_order_acq_rel);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  } \u003cspan class=\"keyword\"\u003eelse\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e ts  = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003eload\u003c/span\u003e(std::memory_order_relaxed);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e now = clock::\u003cspan class=\"built_in\"\u003enow\u003c/span\u003e().\u003cspan class=\"built_in\"\u003etime_since_epoch\u003c/span\u003e().\u003cspan class=\"built_in\"\u003ecount\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (now - ts \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;interval_count_) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"keyword\"\u003enot\u003c/span\u003e \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;timestamp_.\u003cspan class=\"built_in\"\u003ecompare_and_exchange_strong\u003c/span\u003e(ts, now, std::memory_order_relaxed, std::memory_order_relaxed)) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003efalse\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (ts == \u003cspan class=\"number\"\u003e0\u003c/span\u003e) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003eauto\u003c/span\u003e orig_count = \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count.\u003cspan class=\"built_in\"\u003efetch_add\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e, std::memory_order_acq_rel);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e (orig_count \u0026lt; \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;limit_);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;count_.\u003cspan class=\"built_in\"\u003estore\u003c/span\u003e(\u003cspan class=\"number\"\u003e1UL\u003c/span\u003e, std::memory_order_release);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"literal\"\u003etrue\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e至此，我们就完整实现了一个频率限制器，可以愉快地开始拉 QPS 压测了！\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2020-05-17T08:41:10Z",
  "Author": "Liam Huang"
}