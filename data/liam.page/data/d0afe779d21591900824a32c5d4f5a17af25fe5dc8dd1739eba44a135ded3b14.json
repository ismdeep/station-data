{
  "Source": "liam.page",
  "Title": "使用 std::unique_ptr 管理 FILE 指针",
  "Link": "https://liam.page/2020/04/21/managing-FILE-pointer-by-std-unique-ptr/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e尽管 C++ 提供了 \u003ccode\u003efstream\u003c/code\u003e 文件流来读写文件，但对操作符 \u003ccode\u003e\u0026lt;\u0026lt;\u003c/code\u003e 和 \u003ccode\u003e\u0026gt;\u0026gt;\u003c/code\u003e 的重载令很多 C++ 程序员不爽。因而这些程序员还会使用 C 风格的文件流 \u003ccode\u003eFILE\u003c/code\u003e 来读写文件。\u003c/p\u003e\n\u003cp\u003e不过，C++ 的好处也是显而易见的。\u003ca href=\"/2017/04/09/Foundations-of-Cpp/\"\u003eRAII 的出现让资源的管理\u003c/a\u003e变得简单。文件流对于程序来说，也是一种资源。本文的目的是让 C 风格的文件流 \u003ccode\u003eFILE\u003c/code\u003e 可以更方便地享受 RAII 带来的便利。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"自己造轮子\"\u003e\u003ca href=\"#自己造轮子\" class=\"headerlink\" title=\"自己造轮子\"\u003e\u003c/a\u003e自己造轮子\u003c/h2\u003e\u003cp\u003e\u003ca href=\"/2017/04/09/Foundations-of-Cpp/\"\u003e前作\u003c/a\u003e为了解释 RAII，自己造了一个文件句柄类来实现文件流指针的 RAII 容器。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e34\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eFileHandle\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  FILE* p;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eFileHandle\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e* path, \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e* r) : p{\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e} {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    p = \u003cspan class=\"built_in\"\u003efopen\u003c/span\u003e(path, r);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e == p) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ethrow\u003c/span\u003e file_error{path, r};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eFileHandle\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e std::string\u0026amp; path, \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e* r) : p{\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e} {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    p = \u003cspan class=\"built_in\"\u003efopen\u003c/span\u003e(path.\u003cspan class=\"built_in\"\u003ec_str\u003c/span\u003e(), r);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e == p) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e      \u003cspan class=\"keyword\"\u003ethrow\u003c/span\u003e file_error{path.\u003cspan class=\"built_in\"\u003ec_str\u003c/span\u003e(), r};\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eFileHandle\u003c/span\u003e(FileHandle\u0026amp;\u0026amp; orig) \u003cspan class=\"keyword\"\u003enoexcept\u003c/span\u003e : p{orig.p} {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    orig.p = \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  FileHandle\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(FileHandle\u0026amp;\u0026amp; rhs) \u003cspan class=\"keyword\"\u003enoexcept\u003c/span\u003e {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;p = rhs.p;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    rhs.p = \u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  ~\u003cspan class=\"built_in\"\u003eFileHandle\u003c/span\u003e() {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"built_in\"\u003efclose\u003c/span\u003e(p);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003eFILE \u003cspan class=\"type\"\u003econst\u003c/span\u003e* \u003cspan class=\"title\"\u003ep\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;p;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"comment\"\u003e// ...\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003eprivate\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eFileHandle\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e FileHandle\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  FileHandle\u0026amp; \u003cspan class=\"keyword\"\u003eoperator\u003c/span\u003e=(\u003cspan class=\"type\"\u003econst\u003c/span\u003e FileHandle\u0026amp;) = \u003cspan class=\"keyword\"\u003edelete\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，我们在构造函数里通过调用 \u003ccode\u003efopen\u003c/code\u003e 打开文件，而在析构函数里调用 \u003ccode\u003efclose\u003c/code\u003e 关闭文件释放资源。同时，通过禁用拷贝构造及拷贝赋值，避免文件流指针被多个对象持有（这样能避免一些奇怪的错误）；然后实现了移动构造和移动赋值。\u003c/p\u003e\n\u003cp\u003e若要使用针对 \u003ccode\u003eFILE*\u003c/code\u003e 设计的 C 函数，只需要做类似 \u003ccode\u003efgetc(file_handle())\u003c/code\u003e 这样的操作即可。\u003c/p\u003e\n\u003ch2 id=\"用-std-unique-ptr-实现\"\u003e\u003ca href=\"#用-std-unique-ptr-实现\" class=\"headerlink\" title=\"用 std::unique_ptr 实现\"\u003e\u003c/a\u003e用 \u003ccode\u003estd::unique_ptr\u003c/code\u003e 实现\u003c/h2\u003e\u003cp\u003e熟悉 \u003ccode\u003estd::unique_ptr\u003c/code\u003e 的读者不难发现，这其实就是一个经典的适合独占类型的智能指针发挥作用的场景。不过，\u003ccode\u003estd::unique_ptr\u003c/code\u003e 的默认删除函数是销毁其占有的指针指向的对象，亦即执行 \u003ccode\u003edelete p_\u003c/code\u003e。但是，对于文件流来说，我们需要在智能指针完成使命之后关闭文件。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003etemplate\u003c/span\u003e\u0026lt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eT\u003c/span\u003e,\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eDeleter\u003c/span\u003e = std::default_delete\u0026lt;T\u0026gt;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u0026gt; \u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e unique_ptr;\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e为此，我们需要使用自定义的删除函数。也就是说，我们要给模板参数 \u003ccode\u003eDeleter\u003c/code\u003e 传入一个合适的参数。这个参数应当是以下三者之一：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e接受 \u003ccode\u003estd::unique_ptr\u0026lt;T, Deleter\u0026gt;::pointer\u003c/code\u003e 作为参数的函数对象；\u003c/li\u003e\n\u003cli\u003e接受 \u003ccode\u003estd::unique_ptr\u0026lt;T, Deleter\u0026gt;::pointer\u003c/code\u003e 作为参数的函数对象的左值引用；\u003c/li\u003e\n\u003cli\u003e接受 \u003ccode\u003estd::unique_ptr\u0026lt;T, Deleter\u0026gt;::pointer\u003c/code\u003e 作为参数的函数。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e换言之，我们得给 \u003ccode\u003eDeleter\u003c/code\u003e 传这么个东西进去：\u003ccode\u003estd::function\u0026lt;void(typename std::unique_ptr\u0026lt;T, Deleter\u0026gt;::pointer)\u0026gt;\u003c/code\u003e。于是有代码。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;fstream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;memory\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;functional\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eclose_file\u003c/span\u003e\u003cspan class=\"params\"\u003e(FILE* fp)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003efclose\u003c/span\u003e(fp);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e FileHandler = std::unique_ptr\u0026lt;FILE, std::function\u0026lt;\u003cspan class=\"built_in\"\u003evoid\u003c/span\u003e(FILE*)\u0026gt;\u0026gt;;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::\u003cspan class=\"built_in\"\u003eofstream\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;demo.txt\u0026#34;\u003c/span\u003e) \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#39;x\u0026#39;\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// ensure the file does exist\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003eFileHandler \u003cspan class=\"title\"\u003efp\u003c/span\u003e\u003cspan class=\"params\"\u003e(fopen(\u003cspan class=\"string\"\u003e\u0026#34;demo.txt\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;r\u0026#34;\u003c/span\u003e), close_file)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e != fp) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::cout \u0026lt;\u0026lt; \u003cspan class=\"built_in\"\u003estatic_cast\u003c/span\u003e\u0026lt;\u003cspan class=\"type\"\u003echar\u003c/span\u003e\u0026gt;(\u003cspan class=\"built_in\"\u003efgetc\u003c/span\u003e(fp.\u003cspan class=\"built_in\"\u003eget\u003c/span\u003e())) \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003chr/\u003e\n\u003cp\u003e\u003cstrong\u003eUPDATE: 2020-04-23\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e这样的代码能用，但是有三处不大不小的问题。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ccode\u003eclose_file\u003c/code\u003e 这个函数既然是 RAII 的一部分，那么最好不要暴露给普通用户。因此要么将它包在一个 \u003ccode\u003e__detail\u003c/code\u003e 之类的名字空间里，要么用匿名函数。\u003c/li\u003e\n\u003cli\u003e如果 \u003ccode\u003eclose_file\u003c/code\u003e 不暴露给普通用户，那么在构造 \u003ccode\u003eFileHandler\u003c/code\u003e 的时候，就应当避免传递 \u003ccode\u003eclose_file\u003c/code\u003e。因此我们还需要一层封装。\u003c/li\u003e\n\u003cli\u003e每次使用时，需要 \u003ccode\u003efp.get()\u003c/code\u003e。相比不封装时候的 \u003ccode\u003efp\u003c/code\u003e，稍显麻烦了点。\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e显然，我们需要对 \u003ccode\u003eFileHandler\u003c/code\u003e 做进一步封装——通过继承 \u003ccode\u003estd::unique_ptr\u0026lt;FILE, std::function\u0026lt;void(FILE*)\u0026gt;\u0026gt;\u003c/code\u003e 而非持有 \u003ccode\u003estd::unique_ptr\u0026lt;FILE, std::function\u0026lt;void(FILE*)\u0026gt;\u0026gt;\u003c/code\u003e。\u003c/p\u003e\n\u003cfigure class=\"highlight cpp\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e16\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e17\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e18\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e19\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e20\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e21\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e22\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e23\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e24\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e25\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e26\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e27\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e28\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e29\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e30\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e31\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e32\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e33\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;iostream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;fstream\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;memory\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e#\u003cspan class=\"keyword\"\u003einclude\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026lt;functional\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003enamespace\u003c/span\u003e __detail {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003evoid\u003c/span\u003e \u003cspan class=\"title\"\u003eclose_file\u003c/span\u003e\u003cspan class=\"params\"\u003e(FILE* fp)\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003efclose\u003c/span\u003e(fp);\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eusing\u003c/span\u003e file_wrapper = std::unique_ptr\u0026lt;FILE, std::function\u0026lt;\u003cspan class=\"built_in\"\u003evoid\u003c/span\u003e(FILE*)\u0026gt;\u0026gt;;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}  \u003cspan class=\"comment\"\u003e// namespace __detail\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"title class_\"\u003eFileHandler\u003c/span\u003e : \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e __detail::file_wrapper {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e \u003cspan class=\"keyword\"\u003epublic\u003c/span\u003e:\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"built_in\"\u003eFileHandler\u003c/span\u003e(\u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e* fname, \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"type\"\u003echar\u003c/span\u003e* mode) :\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    __detail::\u003cspan class=\"built_in\"\u003efile_wrapper\u003c/span\u003e(\u003cspan class=\"built_in\"\u003efopen\u003c/span\u003e(fname, mode), __detail::close_file) {}\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003eFILE* \u003cspan class=\"title\"\u003eoperator\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003cspan class=\"type\"\u003econst\u003c/span\u003e \u003cspan class=\"keyword\"\u003enoexcept\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"keyword\"\u003ethis\u003c/span\u003e-\u0026gt;\u003cspan class=\"built_in\"\u003eget\u003c/span\u003e();\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e};  \u003cspan class=\"comment\"\u003e// class FileHandler\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"function\"\u003e\u003cspan class=\"type\"\u003eint\u003c/span\u003e \u003cspan class=\"title\"\u003emain\u003c/span\u003e\u003cspan class=\"params\"\u003e()\u003c/span\u003e \u003c/span\u003e{\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  std::\u003cspan class=\"built_in\"\u003eofstream\u003c/span\u003e(\u003cspan class=\"string\"\u003e\u0026#34;demo.txt\u0026#34;\u003c/span\u003e) \u0026lt;\u0026lt; \u003cspan class=\"string\"\u003e\u0026#39;x\u0026#39;\u003c/span\u003e;  \u003cspan class=\"comment\"\u003e// ensure the file does exist\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"function\"\u003eFileHandler \u003cspan class=\"title\"\u003efp\u003c/span\u003e\u003cspan class=\"params\"\u003e(\u003cspan class=\"string\"\u003e\u0026#34;demo.txt\u0026#34;\u003c/span\u003e, \u003cspan class=\"string\"\u003e\u0026#34;r\u0026#34;\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003eif\u003c/span\u003e (\u003cspan class=\"literal\"\u003enullptr\u003c/span\u003e != fp) {\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    std::cout \u0026lt;\u0026lt; \u003cspan class=\"built_in\"\u003estatic_cast\u003c/span\u003e\u0026lt;\u003cspan class=\"type\"\u003echar\u003c/span\u003e\u0026gt;(\u003cspan class=\"built_in\"\u003efgetc\u003c/span\u003e(\u003cspan class=\"built_in\"\u003efp\u003c/span\u003e())) \u0026lt;\u0026lt; std::endl;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  }\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e  \u003cspan class=\"keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"number\"\u003e0\u003c/span\u003e;\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e}\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e这里，通过实现 \u003ccode\u003eFileHandler::operator()\u003c/code\u003e，我们把 \u003ccode\u003eFileHandler\u003c/code\u003e 的对象变成了可调用的对象。于是，可以使用 \u003ccode\u003efgetc(fp())\u003c/code\u003e 来使用。这样，使用起来就方便多了。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2020-04-21T06:44:54Z",
  "Author": "Liam Huang"
}