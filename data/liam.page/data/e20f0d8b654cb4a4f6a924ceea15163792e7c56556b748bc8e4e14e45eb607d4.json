{
  "Source": "liam.page",
  "Title": "管理 macOS 系统上的启动项",
  "Link": "https://liam.page/2019/01/16/manage-daemons-and-agents-on-macOS/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e最近在 Mac 上安装了一些软件。重启后发现这些软件会随开机启动。我不喜欢这样，所以想禁止这些启动项。\u003c/p\u003e\n\u003cp\u003e在中文网络搜索，大多数内容都是在系统偏好设置中，在账户和群组里管理「登录项」。但是目标软件没有出现在登录项的列表中。为此，我不得不在英文网络上搜索，找到了 Apple 关于开发者的一些文档，最终解决了问题。\u003c/p\u003e\n\u003cp\u003e这篇记录一下如何管理 macOS 系统上的启动项。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"守护进程与用户代理\"\u003e\u003ca href=\"#守护进程与用户代理\" class=\"headerlink\" title=\"守护进程与用户代理\"\u003e\u003c/a\u003e守护进程与用户代理\u003c/h2\u003e\u003cp\u003e启动项的专业称呼是守护进程（Daemon）。守护进程是计算机系统中，运行在后台的程序。在 *nix 系统中，守护进程通常没有父进程（让自己成为孤儿进程，\u003ca href=\"/2016/09/25/review-of-envoy/#%E8%BF%9B%E7%A8%8B%E7%9A%84%E7%BB%88%E6%AD%A2\"\u003e前作\u003c/a\u003e中有相关讨论）。一般来说，守护进程完成监听而后作出响应的任务。举例来说，杀毒软件的守护进程监听到有新下载的文件，就给出响应——启动杀毒软件对新下载的文件进行安全扫描。\u003c/p\u003e\n\u003cp\u003e通常来说，守护进程是系统启动及内核运行后在系统初始化阶段启动的进程。对于 macOS 来说，还有名为用户代理（User Agent）的守护进程类似物。与守护进程相同，用户代理也能实现上述监听而后作出响应的功能。不过，与守护进程不同的是，用户代理是在用户登录系统时启动的，而不是在系统初始化阶段启动的。不过，就本文而言，守护进程与用户代理是一回事，因此除有特殊注明外，一律以守护进程指代，不做区分。\u003c/p\u003e\n\u003ch2 id=\"launchd\"\u003e\u003ca href=\"#launchd\" class=\"headerlink\" title=\"launchd\"\u003e\u003c/a\u003e\u003ccode\u003elaunchd\u003c/code\u003e\u003c/h2\u003e\u003cp\u003e在 macOS 上，Apple 推荐用 \u003ccode\u003elaunchd\u003c/code\u003e 来启动守护进程与用户代理。具体来说，\u003ccode\u003elaunchd\u003c/code\u003e 在系统启动及内和运行后，在系统初始化阶段启动守护进程，而在用户登录是启动用户代理。流程大致如下：\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e读入属性列表文件（property list files）\u003c/li\u003e\n\u003cli\u003e注册守护进程所需的套接字（sockets）和文件描述符（file descriptors）\u003c/li\u003e\n\u003cli\u003e启动要求在任何情况下持续运行的守护进程\u003c/li\u003e\n\u003cli\u003e对于按需启动的守护进程，在 \u003ccode\u003elaunchd\u003c/code\u003e 收到相应请求时，启动对应的守护进程\u003c/li\u003e\n\u003cli\u003e当关机（对于守护进程）或用户登出（对于用户代理）时，\u003ccode\u003elaunchd\u003c/code\u003e 对这些守护进程发出 \u003ccode\u003eSIGTERM\u003c/code\u003e 信号\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e其中，对于守护进程，其属性列表文件在以下目录中：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e/System/Library/LaunchDaemons/\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e/Library/LaunchDaemons/\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e对于用户代理，其属性列表文件在以下目录中：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e/System/Library/LaunchAgents\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e/Library/LaunchAgents\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e~/Library/LaunchAgents\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e这里，由于 \u003ccode\u003elaunchd\u003c/code\u003e 提前为所有守护进程注册好了套接字及文件描述符，因而守护进程可以在任何时候按需启动。如果 \u003ccode\u003elaunchd\u003c/code\u003e 监听到系统中有其他进程向某一守护进程发出请求，但该守护进程尚未启动；则发出请求的进程会被暂停，直到 \u003ccode\u003eluanchd\u003c/code\u003e 启动相应的守护进程并对请求作出响应为止。此外，若在一段时间内守护进程没有收到任何请求，则守护进程可以自行退出。\u003ccode\u003elaunchd\u003c/code\u003e 会记录这种退出，并在将来有请求到来时再启动相应的守护进程。\u003c/p\u003e\n\u003ch2 id=\"属性列表文件（property-list-files）\"\u003e\u003ca href=\"#属性列表文件（property-list-files）\" class=\"headerlink\" title=\"属性列表文件（property list files）\"\u003e\u003c/a\u003e属性列表文件（property list files）\u003c/h2\u003e\u003cp\u003e上一节提到，\u003ccode\u003elaunchd\u003c/code\u003e 会去相应目录读取属性列表文件，然后根据属性列表文件中的参数，注册套接字和文件描述符等资源，以及控制守护进程的运行策略。因此，接下来的关键就是这类属性列表文件。\u003c/p\u003e\n\u003cp\u003e属性列表文件的英文是 Property List files，对应的文件名后缀是 \u003ccode\u003e.plist\u003c/code\u003e。说是属性列表文件，其实本质上就是 XML 文件。以下是一个示例文件。\u003c/p\u003e\n\u003cfigure class=\"highlight xml\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e10\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e11\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e12\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e13\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e14\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e15\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e\u0026lt;?xml version=\u003cspan class=\"string\"\u003e\u0026#34;1.0\u0026#34;\u003c/span\u003e encoding=\u003cspan class=\"string\"\u003e\u0026#34;UTF-8\u0026#34;\u003c/span\u003e?\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"meta\"\u003e\u0026lt;!DOCTYPE \u003cspan class=\"keyword\"\u003eplist\u003c/span\u003e \u003cspan class=\"keyword\"\u003ePUBLIC\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;-//Apple//DTD PLIST 1.0//EN\u0026#34;\u003c/span\u003e \u003cspan class=\"string\"\u003e\u0026#34;http://www.apple.com/DTDs/PropertyList-1.0.dtd\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003eplist\u003c/span\u003e \u003cspan class=\"attr\"\u003eversion\u003c/span\u003e=\u003cspan class=\"string\"\u003e\u0026#34;1.0\u0026#34;\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003edict\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003eLabel\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003ecom.example.hello\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003eProgramArguments\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003earray\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003ehello\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e        \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003eworld\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003estring\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003earray\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003eKeepAlive\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003ekey\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e    \u003cspan class=\"tag\"\u003e\u0026lt;\u003cspan class=\"name\"\u003etrue\u003c/span\u003e/\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003edict\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"tag\"\u003e\u0026lt;/\u003cspan class=\"name\"\u003eplist\u003c/span\u003e\u0026gt;\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003eApple 在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://developer.apple.com/library/archive/documentation/MacOSX/Conceptual/BPSystemStartup/Chapters/CreatingLaunchdJobs.html#//apple_ref/doc/uid/10000172i-SW7-104142-BCICCCFI\"\u003e文档里\u003c/a\u003e给出了守护进程属性列表文件必选和推荐的字段，这里翻译如下。\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e关键字\u003c/th\u003e\n\u003cth\u003e说明\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eLabel\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e必填；包含用于 \u003ccode\u003elaunchd\u003c/code\u003e 识别守护进程的唯一字符串标识符。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eProgramArguments\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e必填；包含用于 \u003ccode\u003elaunchd\u003c/code\u003e 启动守护进程时使用的参数。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003einetdCompatibility\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e表示该守护进程对于每个传入的连接启用相互独立的实例。该关键字会让 \u003ccode\u003elaunchd\u003c/code\u003e 像 \u003ccode\u003einetd\u003c/code\u003e 那样运作；具体来说，\u003ccode\u003elaunchd\u003c/code\u003e 会将与每个传入连接的客户端建立好的套接字传给相互独立的守护进程实例。\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003eKeepAlive\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e该关键字用于指定相应的守护进程是按需启动还是要一直启动着。Apple 推荐实现按需启动的守护进程。\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003cp\u003e此外，Apple 在\u003ca target=\"_blank\" rel=\"noopener\" href=\"https://developer.apple.com/library/archive/technotes/tn2083/_index.html\"\u003e技术笔记\u003c/a\u003e中还提及了其他两个关键字，这两个关键字也可能影响守护进程的运行策略（当然还有其他一些关键字可能影响，但主要还有这两个）：\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eRunAtLoad\u003c/code\u003e：在属性列表文件加载时启动守护进程；\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eSuccessfulExit\u003c/code\u003e：与 \u003ccode\u003eKeepAlive\u003c/code\u003e 联合使用。当 \u003ccode\u003eSuccessfulExit = true\u003c/code\u003e 时表示若进程正常退出（\u003ccode\u003eExit at 0\u003c/code\u003e），则 \u003ccode\u003elaunchd\u003c/code\u003e 应当尝试将其重启；当 \u003ccode\u003eSuccessfulExit = false\u003c/code\u003e 时表示若进程异常退出，则 \u003ccode\u003elaunchd\u003c/code\u003e 应当尝试将其重启。\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e因此我们可以构建一些场景：\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003e预期的行为\u003c/th\u003e\n\u003cth\u003e相应的属性配置\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\u003ctr\u003e\n\u003ctd\u003e完全地按需启动\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eKeepAlive = false; RunAtLoad = false\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e在属性列表文件加载时启动，而后按需启动\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eKeepAlive = false; RunAtLoad = true\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e在守护进程异常退出之前，按需启动\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eKeepAlive = { SuccessfulExit = false }; RunAtLoad = false\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e在守护进程正常退出之前，按需启动\u003c/td\u003e\n\u003ctd\u003e\u003ccode\u003eKeepAlive = { SuccessfulExit = true }; RunAtLoad = false\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\u003c/table\u003e\n\u003ch2 id=\"管理启动项\"\u003e\u003ca href=\"#管理启动项\" class=\"headerlink\" title=\"管理启动项\"\u003e\u003c/a\u003e管理启动项\u003c/h2\u003e\u003cp\u003e有了这些知识，管理 macOS 上的启动项就很容易了。你需要做的就是在上述 5 个目录下，找到相应程序的属性列表文件，而后按你的意图修改即可。当然，有些属性列表文件需要使用 \u003ccode\u003eroot\u003c/code\u003e 权限来修改。有必要的话，你需要在终端（Terminal.app）当中使用 \u003ccode\u003esudo vim /path/to/your.plist\u003c/code\u003e 来修改目标文件。\u003c/p\u003e\n\u003cp\u003e唯有一点需要注意，在做任何修改之前\u003cstrong\u003e做好备份\u003c/strong\u003e。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2019-01-16T02:20:42Z",
  "Author": "Liam Huang"
}