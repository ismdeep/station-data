{
  "Source": "liam.page",
  "Title": "利用 ssh-keyscan 获取集群机器 SSH 公钥指纹",
  "Link": "https://liam.page/2018/01/24/ssh-keyscan/",
  "Content": "\u003cdiv class=\"post-body\" itemprop=\"articleBody\"\u003e\n\n      \n        \u003cp\u003e\u003ca href=\"/2017/09/12/rescue-your-life-with-SSH-config-file/\"\u003e前作\u003c/a\u003e提到为了防止中间人攻击，SSH 会要求 client 用户确认 server 的密钥指纹。这个设计很有用，但是如果在可靠环境里有大量机器组成的集群，而我们需要自动化地进行 SSH 访问和相关部署，交叉地去确认密钥指纹是很大的工作量。\u003c/p\u003e\n\u003cp\u003e前作提到了 \u003ccode\u003essh-keygen\u003c/code\u003e 命令，用以在机器上生成密钥。此处我们需要用到 \u003ccode\u003essh-keyscan\u003c/code\u003e 命令，批量获取集群上机器的密钥指纹。\u003c/p\u003e\n\u003cspan id=\"more\"\u003e\u003c/span\u003e\n\n\u003ch2 id=\"ssh-keyscan\"\u003e\u003ca href=\"#ssh-keyscan\" class=\"headerlink\" title=\"ssh-keyscan\"\u003e\u003c/a\u003e\u003ccode\u003essh-keyscan\u003c/code\u003e\u003c/h2\u003e\u003cp\u003e\u003ccode\u003essh-keyscan\u003c/code\u003e 的语法是\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003essh-keyscan [-46Hv] [-f file] [-p port] [-T \u003cspan class=\"built_in\"\u003etimeout\u003c/span\u003e] [-t \u003cspan class=\"built_in\"\u003etype\u003c/span\u003e] [host | addrlist namelist] ...\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e\u003ccode\u003e-46\u003c/code\u003e 是限定以 IPv4 或者 IPv6 连接机器；\u003ccode\u003e-H\u003c/code\u003e 则会对机器名进行散列，隐藏真实机器名，但仍能用于 SSH 相关连接；\u003ccode\u003e-v\u003c/code\u003e 则打印大量调试信息。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ehost | addrlist namelist\u003c/code\u003e 是需要扫描的机器列表；而 \u003ccode\u003e-f\u003c/code\u003e 指定一个文件，包含若干需要扫描的机器列表。\u003ccode\u003e-f -\u003c/code\u003e 表示从标准输入读取机器列表。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e-p\u003c/code\u003e 指定连接远端 server 时的端口号；\u003ccode\u003e-T\u003c/code\u003e 指定超时时间；\u003ccode\u003e-t\u003c/code\u003e 则选择需要获取哪些类型的公钥指纹。\u003c/p\u003e\n\u003ch2 id=\"获取公钥指纹\"\u003e\u003ca href=\"#获取公钥指纹\" class=\"headerlink\" title=\"获取公钥指纹\"\u003e\u003c/a\u003e获取公钥指纹\u003c/h2\u003e\u003cp\u003e首先应准备好需要获取公钥指纹的 IP 或 HOSTNAME 列表，保存在文件中。例如演示用的文件是这样的。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003cfigcaption\u003e\u003cspan\u003ehostlist.txt\u003c/span\u003e\u003c/figcaption\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e127.0.0.1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e127.0.0.2\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e而后执行命令\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e2\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e3\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e4\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e5\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e6\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e7\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e8\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e9\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e$ ssh-keyscan -f hostlist.txt\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 127.0.0.1 SSH-2.0-OpenSSH_6.6.1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e127.0.0.1 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCWBZ3XrIajPmnd6R+g/wcUuOPOiRBMOYjAl4Dv8SfcZtgHqKTK6Zb1EeG3u/uzRYxqXMctG/2A4iXRDG9mvg9H9bimCWbA3xtR79NImPYg4m7BNuH9C+OXRYYJwoOGpjVMs0rGLXkq3/WVkXvQreBuhVD8NI2pEPnQsT1J5abdVbCHlwFYG6wVCJQqFY6jdntJJlxQv5EJu6w4/+Fd4LvdjysH+ngqArac6HMJUxqSxLQjzMdCRWEQKp3ySwmnRp9rHYVaJnnsXeYPfnMN1iMjdIQJPzc89Mepg4ip1q2bCMbMcx2XFO3I7YjYRdcOameFNafMGY0q5RHzhvgnNnal\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 127.0.0.1 SSH-2.0-OpenSSH_6.6.1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e127.0.0.1 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCPWoEQ7iCCYDrpyb5KeMmCaQ8aOnSfehqmrplZRkbqqnkS9++PdSX/eSLJ0tkFd5902/C+HTCqbDgso4mCKpMo=\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 127.0.0.2 SSH-2.0-OpenSSH_6.6.1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e127.0.0.2 ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCWBZ3XrIajPmnd6R+g/wcUuOPOiRBMOYjAl4Dv8SfcZtgHqKTK6Zb1EeG3u/uzRYxqXMctG/2A4iXRDG9mvg9H9bimCWbA3xtR79NImPYg4m7BNuH9C+OXRYYJwoOGpjVMs0rGLXkq3/WVkXvQreBuhVD8NI2pEPnQsT1J5abdVbCHlwFYG6wVCJQqFY6jdntJJlxQv5EJu6w4/+Fd4LvdjysH+ngqArac6HMJUxqSxLQjzMdCRWEQKp3ySwmnRp9rHYVaJnnsXeYPfnMN1iMjdIQJPzc89Mepg4ip1q2bCMbMcx2XFO3I7YjYRdcOameFNafMGY0q5RHzhvgnNnal\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e\u003cspan class=\"comment\"\u003e# 127.0.0.2 SSH-2.0-OpenSSH_6.6.1\u003c/span\u003e\u003c/span\u003e\u003cbr/\u003e\u003cspan class=\"line\"\u003e127.0.0.2 ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBCPWoEQ7iCCYDrpyb5KeMmCaQ8aOnSfehqmrplZRkbqqnkS9++PdSX/eSLJ0tkFd5902/C+HTCqbDgso4mCKpMo=\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e如此，将标准错误的输出重定向到 \u003ccode\u003e/dev/null\u003c/code\u003e 即可获得机器列表的公钥指纹了。\u003c/p\u003e\n\u003cfigure class=\"highlight bash\"\u003e\u003ctable\u003e\u003ctbody\u003e\u003ctr\u003e\u003ctd class=\"gutter\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e1\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003ctd class=\"code\"\u003e\u003cpre\u003e\u003cspan class=\"line\"\u003e$ ssh-keyscan -f hostlist.txt 1\u0026gt;\u0026gt;~/.ssh/known_hosts 2\u0026gt;/dev/null\u003c/span\u003e\u003cbr/\u003e\u003c/pre\u003e\u003c/td\u003e\u003c/tr\u003e\u003c/tbody\u003e\u003c/table\u003e\u003c/figure\u003e\n\n\u003cp\u003e而后将 \u003ccode\u003e~/.ssh/known_hosts\u003c/code\u003e 用 \u003ccode\u003escp\u003c/code\u003e 拷贝到 \u003ccode\u003ehostlist.txt\u003c/code\u003e 中的所有机器上即可。\u003c/p\u003e\n\n    \u003c/div\u003e",
  "Date": "2018-01-24T04:37:02Z",
  "Author": "Liam Huang"
}