{
  "Source": "morningspace",
  "Title": "KubeMacro快速入门",
  "Link": "https://morningspace.github.io/tech/kubemacro-1/",
  "Content": "\u003cdiv class=\"page__inner-wrap\"\u003e\n      \n\n      \u003csection class=\"page__content e-content\" itemprop=\"text\"\u003e\n        \n          \u003caside class=\"sidebar__right sticky\"\u003e\n            \u003cnav class=\"toc\"\u003e\n              \u003cheader\u003e\u003ch4 class=\"nav__title\"\u003e\u003ci class=\"fas fa-file-alt\"\u003e\u003c/i\u003e 在本页上\u003c/h4\u003e\u003c/header\u003e\n              \u003cul class=\"toc__menu\"\u003e\u003cli\u003e\u003ca href=\"#什么是kubemacro\"\u003e什么是KubeMacro\u003c/a\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"#案例一重启与某个service关联的所有pod\"\u003e案例一：重启与某个Service关联的所有Pod\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#案例二删除一直处于terminating状态的namespace\"\u003e案例二：删除一直处于Terminating状态的Namespace\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#使用kubemacro\"\u003e使用KubeMacro\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#安装kubemacro\"\u003e安装KubeMacro\u003c/a\u003e\u003cul\u003e\u003cli\u003e\u003ca href=\"#安装kube-macro\"\u003e安装kube macro\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#小结\"\u003e小结\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\n\n            \u003c/nav\u003e\n          \u003c/aside\u003e\n        \n        \u003cblockquote\u003e\n  \u003cp\u003eKubeMacro是一个kubectl插件，它用于把一组针对于kubectl命令或Kubernetes API的调用封装成一个命令，以便于在命令行多次执行。KubeMacro是一个位于\u003ca href=\"https://github.com/morningspace/kubemacro\"\u003eGitHub\u003c/a\u003e上的开源项目。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003cimg src=\"/assets/images/studio/kubemacro/kubemacro-1.png\" alt=\"\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e作为KubeMacro系列文章的第一篇，本文将告诉你什么是KubeMacro，如何安装并运行KubeMacro。\u003c/p\u003e\n\n\u003ch2 id=\"什么是kubemacro\"\u003e什么是KubeMacro\u003c/h2\u003e\n\n\u003cp\u003eKubeMacro是一个kubectl插件，它可以用来执行一种叫做\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube macro\u003c/code\u003e（简称\u003ccode class=\"language-plaintext highlighter-rouge\"\u003emacro\u003c/code\u003e）的东西。 这里所谓的kube macro，类似于C/C++里的宏定义，它允许我们把一组针对于kubectl命令或Kubernetes API的调用封装成一个命令，以便于在命令行多次执行。为了更好的理解KubeMacro是如何帮助我们更加有效的对Kubernetes集群进行日常管理的，让我们一起来看两个例子。\u003c/p\u003e\n\n\u003ch3 id=\"案例一重启与某个service关联的所有pod\"\u003e案例一：重启与某个Service关联的所有Pod\u003c/h3\u003e\n\n\u003cp\u003e如果我们想重启所有与某个Kubernetes service相关联的pod，往往需要按照如下步骤一步步执行：\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e查看service资源，检查其\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.spec.selector\u003c/code\u003e字段\u003c/li\u003e\n  \u003cli\u003e利用\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e.spec.selector\u003c/code\u003e中定义的标签，查询得到与之相关联的pod\u003c/li\u003e\n  \u003cli\u003e删除相应的pod，以便Kubernetes能为我们重新启动新的pod\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e每当我们需要重启这些pod的时候，都需要手工执行上述步骤，这一过程是十分繁琐的。\u003c/p\u003e\n\n\u003ch3 id=\"案例二删除一直处于terminating状态的namespace\"\u003e案例二：删除一直处于Terminating状态的Namespace\u003c/h3\u003e\n\n\u003cp\u003e删除一个一直处于Terminating状态的namespace并不像表面上看起来那么简单。我们需要了解：\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e为什么namespace会一直处于Terminating状态\u003c/li\u003e\n  \u003cli\u003e在决定强制删除namespace之前，是否应该遍历所有位于该namespace下的API资源，然后将它们逐一删除\u003c/li\u003e\n  \u003cli\u003e如果我们决定强制删除namespace，怎样才能成功清除该namespace下的finalizer呢\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e以上几个问题专门用一篇文章的篇幅来解释一点也不为过。\u003c/p\u003e\n\n\u003ch2 id=\"使用kubemacro\"\u003e使用KubeMacro\u003c/h2\u003e\n\n\u003cp\u003e正如你所看到的那样，当我们用kubectl对集群进行日常操作时，很多任务都不是执行一两条命令就可以完成的。这其中，某些任务的复杂度甚至可以用一篇文章的篇幅来解释。\u003c/p\u003e\n\n\u003cp\u003eKubeMacro的原理非常简单。它把一个或多个针对kubectl或Kubernetes API的调用连同一些最佳实践封装进一个“可执行单元”里，比如一个shell函数，我们把这样的可执行单元称为\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekube macro\u003c/code\u003e（或简称为\u003ccode class=\"language-plaintext highlighter-rouge\"\u003emacro\u003c/code\u003e）。每个macro都被设计用来解决一个特定的问题，它们通常都会包含针对kubectl或Kubernetes API的一个或多个调用，并且还会结合一部分额外的辅助代码逻辑，以完成针对Kubernetes集群的一项完整操作任务。\u003c/p\u003e\n\n\u003cp\u003e通过使用macro，我们可以将一个“可执行单元”作为一个整体反复多次执行，从而使我们在对Kubernetes集群进行操作的时候，更加高效，更少出错。\u003c/p\u003e\n\n\u003ch2 id=\"安装kubemacro\"\u003e安装KubeMacro\u003c/h2\u003e\n\n\u003cp\u003e由于KubeMacro本质上是由脚本实现的，所以它可以作为一个独立的命令在命令行执行。但同时，它也可以被安装成一个kubectl插件，这样我们就可以像执行普通的\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl \u0026lt;command\u0026gt;\u003c/code\u003e命令那样执行KubeMacro了。\u003c/p\u003e\n\n\u003cp\u003e为了安装KubeMacro，我们可以从GitHub库将其下载到本地，并将文件设置为可执行：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ecurl \u003cspan class=\"nt\"\u003e-L\u003c/span\u003e https://raw.githubusercontent.com/morningspace/kubemacro/master/kubectl-macro.sh \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e kubectl-macro\n\u003cspan class=\"nb\"\u003echmod\u003c/span\u003e +x kubectl-macro\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e把脚本文件放到任何\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePATH\u003c/code\u003e环境变量能够找到的地方，比如：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003emv\u003c/span\u003e ./kubectl-macro /usr/local/bin\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e然后，我们就可以像执行普通的kubectl命令那样调用KubeMacro了：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl macro\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e执行上述命令，将会返回KubeMacro的帮助信息。\u003c/p\u003e\n\n\u003ch3 id=\"安装kube-macro\"\u003e安装kube macro\u003c/h3\u003e\n\n\u003cp\u003eKubeMacro本质上是一个用来执行kube macro的执行器。默认情况下，它并不自带任何macro。在安装完KubeMacro之后，我们还需安装特定的macro，才能完成相应的Kubernetes集群管理任务。为此，我们需要访问\u003ca href=\"https://morningspace.github.io/kubemacro-hub/\"\u003eKubeMacro Hub\u003c/a\u003e，这是一个用来发布和分享kube macro的网站。通过浏览该网站上提供的macro，我们可以根据需要选择相应的macro进行安装。\u003c/p\u003e\n\n\u003cp\u003e如果你刚开始接触KubeMacro，下面是一些推荐安装的macro：\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-apires\u003c/code\u003e: 获取某个namespace下的所有API资源\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-by-owner-ref\u003c/code\u003e: 通过\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eowner reference\u003c/code\u003e，获取某个namespace下的指定资源及其祖先\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-by-svc\u003c/code\u003e: 获取和指定service相关联的所有pod\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-not-ready\u003c/code\u003e: 获取所有没有处于就绪状态的pod\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-restarts\u003c/code\u003e: 获取所有重启次数满足指定条件的pod\u003c/li\u003e\n  \u003cli\u003e\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-status\u003c/code\u003e: 获取所有pod状态满足指定条件的pod\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e此处，让我们以\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-by-svc\u003c/code\u003e为例，来演示一下如何安装macro。\u003c/p\u003e\n\n\u003cp\u003e安装macro的过程非常简单。我们只需要打开KubeMacro Hub并进入该macro的页面，本例中即\u003ca href=\"https://morningspace.github.io/kubemacro-hub/macros/#/docs/get-pod-by-svc\"\u003eget-pod-by-svc\u003c/a\u003e。 然后，切换到\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eCode\u003c/code\u003e标签页，根据该标签页上的说明，点击下载链接，或者把完整的代码复制粘贴到一个名为\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eget-pod-by-svc.sh\u003c/code\u003e的本地文件，将其放入\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e$HOME/.kubemacro\u003c/code\u003e目录下，就万事大吉了。每次KubeMacro执行时会扫描该目录，并把安装在该目录下的所有macro加载到内存。\u003c/p\u003e\n\n\u003cp\u003e安装完macro以后，可以执行如下命令进行验证：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl macro get-pod-by-svc \u003cspan class=\"nt\"\u003e--help\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e你会看到特定于该macro的帮助信息。除了阅读命令行输出的帮助信息外，我们还可以查阅位于KubeMacro Hub网站相应macro页面上的\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eDescription\u003c/code\u003e标签页，那里有更多涉及该macro的背景及使用信息。\u003c/p\u003e\n\n\u003cp\u003e对于get-pod-by-svc而言，正如其帮助信息里所描述的那样，它是用来获取所有和某个Kubernetes service相关联的pod的。比如，下面的命令用于找出与openshift-monitoring namespace下的prometheus-adapter service相关联的所有pod，并只输出pod的名字。\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl macro get-pod-by-svc prometheus-adapter \u003cspan class=\"nt\"\u003e-n\u003c/span\u003e openshift-monitoring \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e name\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"小结\"\u003e小结\u003c/h2\u003e\n\n\u003cp\u003e至此，我们已经掌握了如何安装KubeMacro，以及如何安装并执行macro。建议大家访问\u003ca href=\"https://morningspace.github.io/kubemacro-hub/\"\u003eKubeMacro Hub\u003c/a\u003e网站，找一两个你感兴趣的macro，然后安装并试用一下。\u003c/p\u003e\n\n\u003cp\u003e在下一篇文章里，我将和大家分享更多有关KubeMacro Hub的内容，还有一些很有意思的macro，利用它们可以帮助你更加有效的管理Kubernetes集群。\u003c/p\u003e\n\n\u003cp\u003e如果你想了解更多有关KubeMacro的信息，请阅读它的\u003ca href=\"https://morningspace.github.io/kubemacro/docs/\"\u003e在线文档\u003c/a\u003e。如果你喜欢这个项目，欢迎给它\u003ca href=\"https://github.com/morningspace/kubemacro\"\u003e加星\u003c/a\u003e。同时，也非常欢迎针对该项目的任何形式的贡献，比如bug报告以及代码提交。\u003c/p\u003e\n\n        \n      \u003c/section\u003e\n\n      \u003cfooter class=\"page__meta\"\u003e\n        \n        \n  \n\n\n  \n\n  \u003cp class=\"page__taxonomy\"\u003e\n    \u003cstrong\u003e\u003ci class=\"fas fa-fw fa-tags\" aria-hidden=\"true\"\u003e\u003c/i\u003e 标签: \u003c/strong\u003e\n    \u003cspan itemprop=\"keywords\"\u003e\n    \n      \u003ca href=\"/tags/#kubernetes\" class=\"page__taxonomy-item p-category\" rel=\"tag\"\u003ekubernetes\u003c/a\u003e\n    \n    \u003c/span\u003e\n  \u003c/p\u003e\n\n\n\n\n  \n\n\n  \n\n  \u003cp class=\"page__taxonomy\"\u003e\n    \u003cstrong\u003e\u003ci class=\"fas fa-fw fa-folder-open\" aria-hidden=\"true\"\u003e\u003c/i\u003e 分类: \u003c/strong\u003e\n    \u003cspan itemprop=\"keywords\"\u003e\n    \n      \u003ca href=\"/categories/#tech\" class=\"page__taxonomy-item p-category\" rel=\"tag\"\u003etech\u003c/a\u003e\n    \n    \u003c/span\u003e\n  \u003c/p\u003e\n\n\n        \n\n  \u003cp class=\"page__date\"\u003e\u003cstrong\u003e\u003ci class=\"fas fa-fw fa-calendar-alt\" aria-hidden=\"true\"\u003e\u003c/i\u003e 更新时间:\u003c/strong\u003e \u003ctime class=\"dt-published\" datetime=\"2021-05-29T00:00:00+08:00\"\u003eMay 29, 2021\u003c/time\u003e\u003c/p\u003e\n\n      \u003c/footer\u003e\n\n      \u003csection class=\"page__share\"\u003e\n  \n    \u003ch4 class=\"page__share-title\"\u003e分享\u003c/h4\u003e\n  \n\n  \u003ca href=\"https://twitter.com/intent/tweet?text=KubeMacro%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubemacro-1%2F\" class=\"btn btn--twitter\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 Twitter\"\u003e\u003ci class=\"fab fa-fw fa-twitter\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e Twitter\u003c/span\u003e\u003c/a\u003e\n\n  \u003ca href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubemacro-1%2F\" class=\"btn btn--facebook\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 Facebook\"\u003e\u003ci class=\"fab fa-fw fa-facebook\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e Facebook\u003c/span\u003e\u003c/a\u003e\n\n  \u003ca href=\"https://www.linkedin.com/shareArticle?mini=true\u0026amp;url=https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubemacro-1%2F\" class=\"btn btn--linkedin\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 LinkedIn\"\u003e\u003ci class=\"fab fa-fw fa-linkedin\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e LinkedIn\u003c/span\u003e\u003c/a\u003e\n\u003c/section\u003e\n\n\n      \n  \u003cnav class=\"pagination\"\u003e\n    \n      \u003ca href=\"/tech/k8s-net-ingress/\" class=\"pagination--pager\" title=\"Kubernetes网络篇——Ingress\n\"\u003e向前\u003c/a\u003e\n    \n    \n      \u003ca href=\"/tech/kubemacro-2/\" class=\"pagination--pager\" title=\"KubeMacro Hub：寻找你的Kube Macro\n\"\u003e向后\u003c/a\u003e\n    \n  \u003c/nav\u003e\n\n    \u003c/div\u003e",
  "Date": "2021-05-29T00:00:00+08:00",
  "Author": "MornigSpace"
}