{
  "Source": "morningspace",
  "Title": "KubeAssert快速入门",
  "Link": "https://morningspace.github.io/tech/kubeassert-1/",
  "Content": "\u003cdiv class=\"page__inner-wrap\"\u003e\n      \n\n      \u003csection class=\"page__content e-content\" itemprop=\"text\"\u003e\n        \n          \u003caside class=\"sidebar__right sticky\"\u003e\n            \u003cnav class=\"toc\"\u003e\n              \u003cheader\u003e\u003ch4 class=\"nav__title\"\u003e\u003ci class=\"fas fa-file-alt\"\u003e\u003c/i\u003e 在本页上\u003c/h4\u003e\u003c/header\u003e\n              \u003cul class=\"toc__menu\"\u003e\u003cli\u003e\u003ca href=\"#什么是kubeassert\"\u003e什么是KubeAssert\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#安装kubeassert\"\u003e安装KubeAssert\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#使用kubeassert\"\u003e使用KubeAssert\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"#小结\"\u003e小结\u003c/a\u003e\u003c/li\u003e\u003c/ul\u003e\n\n            \u003c/nav\u003e\n          \u003c/aside\u003e\n        \n        \u003cblockquote\u003e\n  \u003cp\u003eKubeAssert是一个kubectl插件，用于在命令行声明针对Kubernetes资源的断言（assertion）。KubeAssert是一个位于\u003ca href=\"https://github.com/morningspace/kubeassert\"\u003eGitHub\u003c/a\u003e上的开源项目。\u003c/p\u003e\n\u003c/blockquote\u003e\n\n\u003cp\u003e\u003cimg src=\"/assets/images/studio/kubeassert/kubeassert-1.png\" alt=\"\"/\u003e\u003c/p\u003e\n\n\u003cp\u003e作为KubeAssert系列文章的第一篇，本文将告诉你什么是KubeAssert，如何安装并运行KubeAssert。\u003c/p\u003e\n\n\u003ch2 id=\"什么是kubeassert\"\u003e什么是KubeAssert\u003c/h2\u003e\n\n\u003cp\u003eKubeAssert是一个kubectl插件，它提供了一组断言（assertion），可以用于在命令行对Kubernetes资源进行判断。利用KubeAssert，可以帮助我们检查和分析Kubernetes集群的状态，集群中资源的部署情况。例如，我们可以通过KubeAssert来判断：\u003c/p\u003e\n\u003cul\u003e\n  \u003cli\u003e某个资源是否存在于当前集群中；\u003c/li\u003e\n  \u003cli\u003e某个资源的状态是否满足指定条件；\u003c/li\u003e\n  \u003cli\u003e某个资源的实例数是否小于或等于指定数值；\u003c/li\u003e\n\u003c/ul\u003e\n\n\u003cp\u003e使用KubeAssert声明针对Kubernetes资源的断言和我们在代码里用xUnit编写单元测试中的断言非常类似。将这样的一组断言放到一个脚本文件里，可以作为针对Kubernetes集群的自动化测试的一部分，和CI/CD pipeline进行集成。\u003c/p\u003e\n\n\u003ch2 id=\"安装kubeassert\"\u003e安装KubeAssert\u003c/h2\u003e\n\n\u003cp\u003e由于KubeAssert本质上是由脚本实现的，所以它可以作为一个独立的命令在命令行执行。但同时，它也可以被安装成一个kubectl插件，这样我们就可以像执行普通的\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl \u0026lt;command\u0026gt;\u003c/code\u003e命令那样执行KubeAssert了。\u003c/p\u003e\n\n\u003cp\u003eKubeAssert目前已被提交至\u003ca href=\"https://krew.sigs.k8s.io/\"\u003ekrew\u003c/a\u003e。作为Kubernetes社区官方的kubectl插件管理工具，krew提供了\u003ca href=\"https://sigs.k8s.io/krew-index\"\u003ekrew-index\u003c/a\u003e，用于在社区范围内集中发布与分享kubectl插件。因此，安装KubeAssert最简单的方式就是使用\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekrew\u003c/code\u003e：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekrew \u003cspan class=\"nb\"\u003einstall \u003c/span\u003eassert\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e如果没有安装krew，也没关系。我们可以从GitHub库将其下载到本地，并将文件设置为可执行：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ecurl \u003cspan class=\"nt\"\u003e-L\u003c/span\u003e https://raw.githubusercontent.com/morningspace/kubeassert/master/kubectl-assert.sh \u003cspan class=\"nt\"\u003e-o\u003c/span\u003e kubectl-assert\n\u003cspan class=\"nb\"\u003echmod\u003c/span\u003e +x kubectl-assert\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e把脚本文件放到任何\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ePATH\u003c/code\u003e环境变量能够找到的地方，比如：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003e\u003cspan class=\"nb\"\u003emv\u003c/span\u003e ./kubectl-assert /usr/local/bin\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e然后，我们就可以像执行普通的kubectl命令那样调用KubeAssert了：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl assert\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e执行上述命令，将会返回KubeAssert的帮助信息，以及一个KubeAssert当前支持的断言清单。如果在执行\u003ccode class=\"language-plaintext highlighter-rouge\"\u003ekubectl assert\u003c/code\u003e命令时指定了断言的名字以及\u003ccode class=\"language-plaintext highlighter-rouge\"\u003e--help\u003c/code\u003e参数，就会得到更多有关雨如何使用相应断言的详细信息。例如：\u003c/p\u003e\n\u003cdiv class=\"language-shell highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl assert exist \u003cspan class=\"nt\"\u003e--help\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\u003ch2 id=\"使用kubeassert\"\u003e使用KubeAssert\u003c/h2\u003e\n\n\u003cp\u003e以下给出的是目前为止KubeAssert默认提供的所有断言：\u003c/p\u003e\n\n\u003ctable\u003e\n  \u003cthead\u003e\n    \u003ctr\u003e\n      \u003cth style=\"text-align: left\"\u003eAssertion\u003c/th\u003e\n      \u003cth style=\"text-align: left\"\u003eDescription\u003c/th\u003e\n    \u003c/tr\u003e\n  \u003c/thead\u003e\n  \u003ctbody\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eexist\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert resource should exist.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003enot-exist\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert resource should not exist.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eexist-enhanced\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert resource should exist using enhanced field selector.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003enot-exist-enhanced\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert resource should not exist using enhanced field selector.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003enum\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert the number of resource should match specified criteria.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003epod-ready\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert pod should be ready.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003epod-not-terminating\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert pod should not keep terminating.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003epod-restarts\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert pod restarts should match specified criteria.\u003c/td\u003e\n    \u003c/tr\u003e\n    \u003ctr\u003e\n      \u003ctd style=\"text-align: left\"\u003eapiservice-available\u003c/td\u003e\n      \u003ctd style=\"text-align: left\"\u003eAssert API service should be available.\u003c/td\u003e\n    \u003c/tr\u003e\n  \u003c/tbody\u003e\n\u003c/table\u003e\n\n\u003cp\u003e这里给出了一些例子，演示了如何利用这些断言来帮助我们对Kubernetes集群中的资源进行检查。\u003c/p\u003e\n\n\u003cp\u003e检查foo namespace下是否存在任何满足标签\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eapp\u003c/code\u003e取值为\u003ccode class=\"language-plaintext highlighter-rouge\"\u003eecho\u003c/code\u003e的pod：\u003c/p\u003e\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl assert exist pods -l app=echo -n foo\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e检查是否所有namespace下的pod都处于就绪（ready）状态：\u003c/p\u003e\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl assert pod-ready --all-namespaces\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003cp\u003e检查pod的重启次数小于指定数值：\u003c/p\u003e\n\u003cdiv class=\"language-plaintext highlighter-rouge\"\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"highlight\"\u003e\u003ccode\u003ekubectl assert restarts pods -n foo -lt 10\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/div\u003e\n\n\u003ch2 id=\"小结\"\u003e小结\u003c/h2\u003e\n\n\u003cp\u003e如你所见，KubeAssert的使用非常简单。在下一篇文章里，我将和大家分享更多有关KubeAssert使用的技巧。\u003c/p\u003e\n\n\u003cp\u003e如果你想了解更多有关KubeAssert的信息，请阅读它的\u003ca href=\"https://morningspace.github.io/kubeassert/docs/\"\u003e在线文档\u003c/a\u003e。如果你喜欢这个项目，欢迎给它\u003ca href=\"https://github.com/morningspace/kubeassert\"\u003e加星\u003c/a\u003e。同时，也非常欢迎针对该项目的任何形式的贡献，比如bug报告以及代码提交。\u003c/p\u003e\n\n        \n      \u003c/section\u003e\n\n      \u003cfooter class=\"page__meta\"\u003e\n        \n        \n  \n\n\n  \n\n  \u003cp class=\"page__taxonomy\"\u003e\n    \u003cstrong\u003e\u003ci class=\"fas fa-fw fa-tags\" aria-hidden=\"true\"\u003e\u003c/i\u003e 标签: \u003c/strong\u003e\n    \u003cspan itemprop=\"keywords\"\u003e\n    \n      \u003ca href=\"/tags/#kubernetes\" class=\"page__taxonomy-item p-category\" rel=\"tag\"\u003ekubernetes\u003c/a\u003e\n    \n    \u003c/span\u003e\n  \u003c/p\u003e\n\n\n\n\n  \n\n\n  \n\n  \u003cp class=\"page__taxonomy\"\u003e\n    \u003cstrong\u003e\u003ci class=\"fas fa-fw fa-folder-open\" aria-hidden=\"true\"\u003e\u003c/i\u003e 分类: \u003c/strong\u003e\n    \u003cspan itemprop=\"keywords\"\u003e\n    \n      \u003ca href=\"/categories/#tech\" class=\"page__taxonomy-item p-category\" rel=\"tag\"\u003etech\u003c/a\u003e\n    \n    \u003c/span\u003e\n  \u003c/p\u003e\n\n\n        \n\n  \u003cp class=\"page__date\"\u003e\u003cstrong\u003e\u003ci class=\"fas fa-fw fa-calendar-alt\" aria-hidden=\"true\"\u003e\u003c/i\u003e 更新时间:\u003c/strong\u003e \u003ctime class=\"dt-published\" datetime=\"2021-06-19T00:00:00+08:00\"\u003eJune 19, 2021\u003c/time\u003e\u003c/p\u003e\n\n      \u003c/footer\u003e\n\n      \u003csection class=\"page__share\"\u003e\n  \n    \u003ch4 class=\"page__share-title\"\u003e分享\u003c/h4\u003e\n  \n\n  \u003ca href=\"https://twitter.com/intent/tweet?text=KubeAssert%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8%20https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubeassert-1%2F\" class=\"btn btn--twitter\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 Twitter\"\u003e\u003ci class=\"fab fa-fw fa-twitter\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e Twitter\u003c/span\u003e\u003c/a\u003e\n\n  \u003ca href=\"https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubeassert-1%2F\" class=\"btn btn--facebook\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 Facebook\"\u003e\u003ci class=\"fab fa-fw fa-facebook\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e Facebook\u003c/span\u003e\u003c/a\u003e\n\n  \u003ca href=\"https://www.linkedin.com/shareArticle?mini=true\u0026amp;url=https%3A%2F%2Fmorningspace.github.io%2Ftech%2Fkubeassert-1%2F\" class=\"btn btn--linkedin\" onclick=\"window.open(this.href, \u0026#39;window\u0026#39;, \u0026#39;left=20,top=20,width=500,height=500,toolbar=1,resizable=0\u0026#39;); return false;\" title=\"分享 LinkedIn\"\u003e\u003ci class=\"fab fa-fw fa-linkedin\" aria-hidden=\"true\"\u003e\u003c/i\u003e\u003cspan\u003e LinkedIn\u003c/span\u003e\u003c/a\u003e\n\u003c/section\u003e\n\n\n      \n  \u003cnav class=\"pagination\"\u003e\n    \n      \u003ca href=\"/tech/kubemacro-3/\" class=\"pagination--pager\" title=\"编写自己的Kube Macro\n\"\u003e向前\u003c/a\u003e\n    \n    \n      \u003ca href=\"/tech/kubeassert-2/\" class=\"pagination--pager\" title=\"高效使用KubeAssert\n\"\u003e向后\u003c/a\u003e\n    \n  \u003c/nav\u003e\n\n    \u003c/div\u003e",
  "Date": "2021-06-19T00:00:00+08:00",
  "Author": "MornigSpace"
}