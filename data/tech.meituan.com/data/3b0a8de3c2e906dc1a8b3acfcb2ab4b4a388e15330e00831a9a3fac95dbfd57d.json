{
  "Source": "tech.meituan.com",
  "Title": "美团数据库中间件DBProxy开源",
  "Link": "https://tech.meituan.com/2017/01/05/dbproxy-pr.html",
  "Content": "\u003cdiv class=\"post-content\"\u003e\u003cdiv class=\"content\"\u003e\u003cp\u003e随着数据量的不断增大，传统的直连数据库对数据进行访问的方式已经无法满足一般公司的需求。通过数据库中间件，可以对数据库进行水平扩展，由原来单台数据库扩展到多台数据库，数据库中间件通过路由规则将数据的访问请求路由到其中一台数据库上，从而大大降低了数据访问的瓶颈和单台数据库的压力。通过数据库中间件还可以将DBA和研发进行解耦，提升DBA运维效率。\u003c/p\u003e\u003cp\u003e奇虎360公司开源的Atlas是优秀的数据库中间件，美团DBA团队针对公司内部需求，在其上做了很多改进工作，形成了新的高可靠、高可用企业级数据库中间件DBProxy，已在公司内部生产环境广泛使用，较为成熟、稳定。相关工作的详细介绍可以参考之前的博客文章\u003ca href=\"http://tech.meituan.com/dbproxy-introduction.html\"\u003e《美团的DBProxy实践》\u003c/a\u003e。\u003c/p\u003e\u003cp\u003e现在，我们非常高兴地将DBProxy开源，希望与业内有类似需求的团队，一起打造一款优秀的企业级数据库中间件产品。项目的Github地址是\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy\"\u003ehttps://github.com/Meituan-Dianping/DBProxy\u003c/a\u003e。\u003c/p\u003e\u003col\u003e\u003cli\u003e支持多语言MySQL客户端\u003c/li\u003e\u003cli\u003e读写分离\u003c/li\u003e\u003cli\u003e负载均衡\u003c/li\u003e\u003cli\u003eSlave故障感知与摘除（Master需要MHA等其他联动）\u003c/li\u003e\u003cli\u003e后端连接池\u003c/li\u003e\u003cli\u003e自定义SQL拦截与过滤\u003c/li\u003e\u003cli\u003e流量分组与控制\u003c/li\u003e\u003cli\u003e丰富的监控状态\u003c/li\u003e\u003cli\u003e支持分表（分库版本正在内测中）\u003c/li\u003e\u003cli\u003eClient IP限制\u003c/li\u003e\u003c/ol\u003e\u003cul\u003e\u003cli\u003e新增功能点\u003cul\u003e\u003cli\u003e从库流量配置\u003cbr/\u003e指定查询发送到某个从库\u003c/li\u003e\u003cli\u003e参数动态设置(完善show proxy status/variables)\u003cbr/\u003e支持save config，动态增加、删除分表\u003c/li\u003e\u003cli\u003e响应时间percentile统计\u003cbr/\u003e统计最近时间段DBProxy的响应时间\u003c/li\u003e\u003cli\u003ekill session\u003cbr/\u003e支持DBProxy的admin接口kill session操作\u003c/li\u003e\u003cli\u003ebackend平滑上下线\u003cbr/\u003e支持平滑的backend上下线\u003c/li\u003e\u003cli\u003eDBProxy非root用户启动\u003cbr/\u003e使用非root用户启动\u003c/li\u003e\u003cli\u003eadmin账号的安全限制\u003cbr/\u003eadmin账号密码的动态修改及host限制\u003c/li\u003e\u003cli\u003e增加异步刷日志的功能\u003cbr/\u003e增加日志线程、异步刷日志，提高响应时间\u003c/li\u003e\u003cli\u003e支持DBProxy平滑重启功能\u003cbr/\u003e\u003col\u003e\u003cli\u003enormal：等待所有当前事务结束后退出\u003cbr/\u003e① KILL -SIGTERM `pid of mysql-proxy`; ② admin 命令: shutdown [normal]，其中等待过程有超时机制\u003cbr/\u003e\u003c/li\u003e\u003cli\u003eimmediate：不等待当前事务结束直接退出\u003cbr/\u003e① KILL -SIGINT `pid of mysql-proxy`; ② admin 命令: shutdown immediate\u003c/li\u003e\u003cli\u003e配置参数shutdown_timeout: 在normal方式下，等待shutdown_timeout时间后退出，单位是s, 默认值是600\u003c/li\u003e\u003c/ol\u003e\u003c/li\u003e\u003cli\u003e支持SQL过滤的黑名单功能\u003cul\u003e\u003cli\u003e添加到黑名单中需要满足两个条件：SQL执行的时间和频率\u003c/li\u003e\u003cli\u003eSQL执行的时间\u003cbr/\u003e由参数 query-filter-time-threshold 来指定，如果SQL执行时间超过此值，则满足条件\u003c/li\u003e\u003cli\u003eSQL执行频率\u003cbr/\u003e由参数 query-filter-frequent-threshold 来指定，如果SQL执行频率超过此值，则满足条件\n频率就是在时间窗口内执行的次数。时间窗口则是由频率阈值和最小执行次数来计算出来的，当时间窗口小于60s时，扩展到60s\u003cbr/\u003e参数 access-num-per-time-window 用来指定在时间窗口内的最小执行次数，添加此参数是考虑到执行时间长的SQL在计算频率时同时参考其执行的次数，只有执行一定次数时才去计算其频率。当执行时间与执行频率都满足时条件时，会自动将查询作为过滤项放到黑名单中，加入到黑名单中是否生效由参数 auto-filter-flag 来控制，OFF:不生效，ON:立即生效\u003c/li\u003e\u003cli\u003e黑名单的管理\u003cul\u003e\u003cli\u003e提供了查看、修改、添加、删除黑名单的功能\u003c/li\u003e\u003cli\u003e黑名单管理提供了将黑名单保存到文件以及从文件中Load到内存中的功能\u003c/li\u003e\u003cli\u003e在手动添加黑名单时，只需要将用户的SQL语句输入，在内部自动转化成过滤条件，手动添加时是否生效由参数 manual-filter-flag 来控制，OFF:不生效，ON:立即生效\u003c/li\u003e\u003cli\u003e手动添加与自动添加两种情况下的过滤条件是否生效是分别由不同参数控制，这个要区分清楚。另外，也可以使用 admin 的命令来设置是否开启/关闭某个过滤条件\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003e支持对于MySQL后台的thread running限制功能\u003cbr/\u003e该功能通过在DBProxy内限制每个后台MySQL的并发查询，来控制对应MySQL的thread running数\n当发向某个MySQL后台的的并发查询超过某个阈值时，会进行超时等待，直到有可用的连接，其中阈值与超时等待的时间都已经参数化，可以动态配置\u003cul\u003e\u003cli\u003e新增参数\u003cbr/\u003e\u003cul\u003e\u003cli\u003ebackend-max-thread-running用于指定每个MySQL后台的最大thread running数\u003c/li\u003e\u003cli\u003ethread-running-sleep-delay用于指定在thread running数超过backend-max-thread-running时，客户端连接等待的时间\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003eset backend offline不再显示节点状态\u003c/li\u003e\u003cli\u003e支持set transaction isolation level\u003c/li\u003e\u003cli\u003e支持use db\u003c/li\u003e\u003cli\u003e支持set option语句\u003c/li\u003e\u003cli\u003e支持set session级系统变量\u003c/li\u003e\u003cli\u003e支持建立连接时指定连接属性\u003c/li\u003e\u003cli\u003e改进连接池的连接管理，增加超时释放机制。当连接池中的空闲连接闲置超过一定时间后，自动释放连接。由参数 db-connection-idle-timeout 控制\u003c/li\u003e\u003cli\u003e增加客户端连接的keepalive机制，避免网络异常后释放已断开的连接\u003c/li\u003e\u003cli\u003e完善管理日志，增加了管理命令日志、错误语句日志以及详细的错误日志\u003c/li\u003e\u003cli\u003e完善SQL日志信息，包含了详细的连接信息，并包含了DBProxy内部执行的隐式SQL语句。隐式SQL语句主要是连接重用时切换database、字符集的语句\u003c/li\u003e\u003cli\u003e增加SQL日志rotate机制，可设置日志文件最大大小和日志文件最大个数，自动清理早期的SQL日志。分别由参数sql-log-file-size和sql-log-file-num控制\u003c/li\u003e\u003cli\u003e增加后台MySQL版本号设置，主要影响MySQL连接协议中的server版本，客户端驱动可能依赖于server版本处理机制有所不同。由参数mysql-version控制\u003c/li\u003e\u003cli\u003e性能改进，将SQL词法分析从串行方式改进为并发方式；其次，在每次执行SQL前如果database相同时，不再需要执行COM_INIT_DB命令。根据测试结果，在特定环境下sysbench的QPS从7万提升至22万\u003c/li\u003e\u003cli\u003e增加监控统计信息，包括连接状态、QPS、响应时间、网络等统计\u003c/li\u003e\u003cli\u003esql log动态配置\u003c/li\u003e\u003cli\u003e改进autocommit为false时频繁连接主库的问题\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003cli\u003eBugs修复\u003cul\u003e\u003cli\u003eDBProxy建立连向MySQL连接时，新建的socket添加keepalive和非阻塞的属性\u003c/li\u003e\u003cli\u003erpm安装时，创建conf目录并创建默认的配置文件的功能\u003c/li\u003e\u003cli\u003erpm安装时，需要手动修改mysql-proxyd文件中的proxy-dir, 现在直接在rpm安装后就修改好\u003c/li\u003e\u003cli\u003e解决了绑定后端连接断开时，客户端连接未及时断开的问题\u003c/li\u003e\u003cli\u003e屏蔽了KILL语句，避免在后端MySQL可能误KILL的问题\u003c/li\u003e\u003cli\u003e修改了事务内语句执行错误时，DBProxy未保留后台连接导致rollback发送到其它结点的问题\u003c/li\u003e\u003cli\u003e修复分表查询结果合并时列字符集错误的问题，该问题可能会导致结果乱码\u003c/li\u003e\u003cli\u003e解决在分表情况下，返回值有 NULL 的情况下，查询超时的问题\u003cbr/\u003e此问题是DBProxy在多个分表merge结果的过程中未处理 NULL 值，导致结果集返回不对，而JDBC接口会认为此种情况下是未收到结果，会处于一直等待状态，触发超时\u003c/li\u003e\u003cli\u003e解决在分表情况下， IN 子句中分表列只支持 int32，不支持int64 的问题\u003c/li\u003e\u003cli\u003e解决连接断开的内存泄露问题\u003cbr/\u003e在连接的结构体的释放接口中，lock 的成员变量未释放，导致在连接断开，回收连接对象时会泄漏24个字节\u003c/li\u003e\u003cli\u003e取消admin操作中不必要的日志\u003c/li\u003e\u003cli\u003e去掉了在连接 admin 时报”[admin] we only handle text-based queries (COM_QUERY)“的信息，此信息属于无用的信息\u003cbr/\u003e\u003c/li\u003e\u003cli\u003e去掉了在set backend offline/online时的返回值信息，此信息是无用信息\u003c/li\u003e\u003cli\u003e解决用户权限不足、DBProxy用户名密码配置错误等导致使用错误用户的问题\u003c/li\u003e\u003cli\u003e解决SQL_CALC_FOUND_ROWS之后SQL语句发往主库的问题\u003c/li\u003e\u003cli\u003e解决SQL语句中有注释时语句分析不正确的问题\u003c/li\u003e\u003cli\u003e解决客户端发送空串导致DBProxy挂掉的问题\u003c/li\u003e\u003c/ul\u003e\u003c/li\u003e\u003c/ul\u003e\u003cp\u003e新功能和Bug修复描述，详见\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/RELEASE_NOTES.md\"\u003erelease notes\u003c/a\u003e。\u003c/p\u003e\u003cp\u003e和各位同行共同打造一款企业级高可用、高可靠的数据库中间件产品，希望大家能够积极参与。\u003c/p\u003e\u003cp\u003e欢迎大家将需求或发现的Bug在Github上提交\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/issues\"\u003eissue\u003c/a\u003e，帮助DBProxy的壮大；也欢迎大家在DBProxy用户交流群（QQ: 367199679）相互交流，共同学习。\u003c/p\u003e\u003cp\u003e\u003cimg src=\"https://awps-assets.meituan.net/mit-x/blog-images-bundle-2017/48e05603.png\" alt=\"QQ\"/\u003e\u003c/p\u003e\u003cp\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy\"\u003eDBProxy的github地址\u003c/a\u003e\u003c/p\u003e\u003col\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/QUICK_START.md\"\u003eDBProxy快速入门教程\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/USER_GUIDE.md\"\u003eDBProxy用户使用手册\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/PROGRAMMING_GUIDE.md\"\u003eDBProxy开发手册\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/THEORY_PRACTICES.md\"\u003eDBProxy架构和实践\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/RELEASE_NOTES.md\"\u003eDBProxy release notes\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/TEST_GUIDE.md\"\u003eDBProxy 测试手册\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/FAQ.md\"\u003eFAQ\u003c/a\u003e\u003c/li\u003e\u003cli\u003e\u003ca href=\"https://github.com/Meituan-Dianping/DBProxy/blob/master/doc/DEVELOPMENT_NORM.md\"\u003eDBProxy开发规范\u003c/a\u003e\u003c/li\u003e\u003c/ol\u003e\u003c/div\u003e\u003c/div\u003e",
  "Date": "2017-01-05T00:00:00Z",
  "Author": "soulteary@gmail.com"
}